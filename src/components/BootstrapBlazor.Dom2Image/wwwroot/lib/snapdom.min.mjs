var h={image:new Map,background:new Map,resource:new Map,defaultStyle:new Map,baseStyle:new Map,computedStyle:new WeakMap,font:new Set,snapshot:new WeakMap,snapshotKey:new Map,reset:Wt};function Wt(){h.computedStyle=new WeakMap}var _t=["div","span","p","a","img","ul","li","button","input","select","textarea","label","section","article","header","footer","nav","main","aside","h1","h2","h3","h4","h5","h6","svg","path","circle","rect","line","g","table","thead","tbody","tr","td","th"];function yt(){for(let t of _t)wt(t)}function wt(t){if(h.defaultStyle.has(t))return h.defaultStyle.get(t);if(new Set(["script","style","meta","link","noscript","template","defs","symbol","title","metadata","desc"]).has(t)){let a={};return h.defaultStyle.set(t,a),a}let n=document.getElementById("snapdom-sandbox");n||(n=document.createElement("div"),n.id="snapdom-sandbox",n.style.position="absolute",n.style.left="-9999px",n.style.top="-9999px",n.style.width="0",n.style.height="0",n.style.overflow="hidden",document.body.appendChild(n));let i=document.createElement(t);i.style.all="initial",n.appendChild(i);let r=getComputedStyle(i),c={};for(let a of r)c[a]=r.getPropertyValue(a);return n.removeChild(i),h.defaultStyle.set(t,c),c}var jt=new Set(["-webkit-locale"]);function K(t,e,n=!1){let i=[],r=wt(e);for(let[c,a]of Object.entries(t))if(!jt.has(c))if(!n)a&&i.push(`${c}:${a}`);else{let f=r[c];a&&a!==f&&i.push(`${c}:${a}`)}return i.sort().join(";")}function bt(t){let e=new Set;return t.nodeType!==Node.ELEMENT_NODE&&t.nodeType!==Node.DOCUMENT_FRAGMENT_NODE?[]:(t.tagName&&e.add(t.tagName.toLowerCase()),typeof t.querySelectorAll=="function"&&t.querySelectorAll("*").forEach(n=>e.add(n.tagName.toLowerCase())),Array.from(e))}function St(t){let e=new Map;for(let i of t){let r=h.defaultStyle.get(i);if(!r)continue;let c=Object.entries(r).map(([a,f])=>`${a}:${f};`).sort().join("");e.has(c)||e.set(c,[]),e.get(c).push(i)}let n="";for(let[i,r]of e.entries())n+=`${r.join(",")} { ${i} }
`;return n}function xt(t){let e=new Set(t.values()),n=new Map,i=1;for(let r of e)r.trim()&&n.set(r,`c${i++}`);return n}async function O(t,e={}){let n=X(t),i=/^((repeating-)?(linear|radial|conic)-gradient)\(/i.test(t);if(n){let r=G(n);if(h.background.has(r))return e.skipInline?void 0:`url(${h.background.get(r)})`;{let c=await W(r,{useProxy:e.useProxy});return h.background.set(r,c),e.skipInline?void 0:`url("${c}")`}}return t}function q(t,{fast:e=!1}={}){if(e)return t();"requestIdleCallback"in window?requestIdleCallback(t,{timeout:50}):setTimeout(t,1)}function U(t,e=null){if(!(t instanceof Element))return window.getComputedStyle(t,e);let n=h.computedStyle.get(t);if(n||(n=new Map,h.computedStyle.set(t,n)),!n.has(e)){let i=window.getComputedStyle(t,e);n.set(e,i)}return n.get(e)}function Ct(t){let e=t.replace(/^['"]|['"]$/g,"");if(e.startsWith("\\"))try{return String.fromCharCode(parseInt(e.replace("\\",""),16))}catch{return e}return e}function X(t){let e=t.match(/url\((['"]?)(.*?)(\1)\)/);if(!e)return null;let n=e[2].trim();return n.startsWith("#")?null:n}async function V(t,{useProxy:e=""}={}){async function n(i){let r=await fetch(i);if(!r.ok)throw new Error(`[snapdom] Failed to fetch resource: ${i}`);return r}try{return await n(t)}catch(i){if(e&&typeof e=="string"){let r=e.replace(/\/$/,"")+G(t);return n(r)}throw i}}var j=new Map,at=new Map;function W(t,{timeout:e=3e3,useProxy:n="",errorTTL:i=8e3}={}){function r(u){try{return new URL(u,window.location.href).origin===window.location.origin?"use-credentials":"anonymous"}catch{return"anonymous"}}let c=u=>({ok:!0,data:u}),a=u=>({ok:!1,error:u instanceof Error?u:new Error(String(u))});function f(u){try{return fetch(u,{mode:"cors",credentials:r(u)==="use-credentials"?"include":"omit"}).then(g=>g.ok?g.blob().then(b=>new Promise(p=>{let w=new FileReader;w.onloadend=()=>{let S=w.result;typeof S!="string"||!S.startsWith("data:image/")?p(a(new Error("Invalid image data URL"))):p(c(S))},w.onerror=()=>p(a(new Error("FileReader error"))),w.readAsDataURL(b)})):a(new Error("HTTP "+g.status))).catch(g=>a(g))}catch(g){return Promise.resolve(a(g))}}function o(u){return f(u).then(g=>{if(g.ok)return g;if(n&&typeof n=="string"){let b=n.replace(/\/$/,"")+G(u);return f(b).then(p=>p.ok?p:a(new Error("[SnapDOM - fetchImage] Fetch failed and no proxy provided")))}return a(new Error("[SnapDOM - fetchImage] Fetch failed and no proxy provided"))})}let l=Date.now(),s=at.get(t);if(s&&s>l){let u=Promise.reject(new Error("[SnapDOM - fetchImage] Recently failed (cooldown)."));return u.catch(()=>{}),u}if(j.has(t))return j.get(t);let d=r(t);if(h.image.has(t))return Promise.resolve(h.image.get(t));if(t.startsWith("data:image/"))return h.image.set(t,t),Promise.resolve(t);if(/\.svg(\?.*)?$/i.test(t)){let u=(async()=>{let g=await(async()=>{try{let p=await fetch(t,{mode:"cors",credentials:d==="use-credentials"?"include":"omit"});if(!p.ok)return a(new Error("HTTP "+p.status));let w=await p.text();return c(`data:image/svg+xml;charset=utf-8,${encodeURIComponent(w)}`)}catch(p){return a(p)}})();if(g.ok)return h.image.set(t,g.data),g.data;let b=await o(t);return b.ok?(h.image.set(t,b.data),b.data):(at.set(t,l+i),Promise.reject(b.error))})();return j.set(t,u),u.finally(()=>j.delete(t)),u.catch(()=>{}),u}let m=new Promise((u,g)=>{let b=!1,p=new Image,w=y=>k=>{b||(b=!0,clearTimeout(R),p.onload=p.onerror=null,y(k))},S=y=>{h.image.set(t,y),u(y)},x=y=>{at.set(t,Date.now()+i),g(y)},R=setTimeout(w(()=>{o(t).then(y=>{y.ok?S(y.data):x(new Error("Image load timed out"))})}),e);p.crossOrigin=d,p.onload=w(()=>{Promise.resolve(p.decode()).then(()=>{try{let y=document.createElement("canvas");y.width=p.naturalWidth||p.width,y.height=p.naturalHeight||p.height,y.getContext("2d").drawImage(p,0,0,y.width,y.height),S(y.toDataURL("image/png"))}catch{o(t).then(y=>{y.ok?S(y.data):x(y.error)})}}).catch(()=>{o(t).then(y=>{y.ok?S(y.data):x(y.error)})})}),p.onerror=w(()=>{o(t).then(y=>{y.ok?S(y.data):x(y.error)})}),p.src=t});return j.set(t,m),m.finally(()=>j.delete(t)),m.catch(()=>{}),m}function st(t){let e={};for(let n of t)e[n]=t.getPropertyValue(n);return e}function vt(){return/^((?!chrome|android).)*safari/i.test(navigator.userAgent)}function Et(t){if(!t||t==="none")return"";let e=t.replace(/translate[XY]?\([^)]*\)/g,"");return e=e.replace(/matrix\(([^)]+)\)/g,(n,i)=>{let r=i.split(",").map(c=>c.trim());return r.length!==6?`matrix(${i})`:(r[4]="0",r[5]="0",`matrix(${r.join(", ")})`)}),e=e.replace(/matrix3d\(([^)]+)\)/g,(n,i)=>{let r=i.split(",").map(c=>c.trim());return r.length!==16?`matrix3d(${i})`:(r[12]="0",r[13]="0",`matrix3d(${r.join(", ")})`)}),e.trim().replace(/\s{2,}/g," ")}function G(t){if(/%[0-9A-Fa-f]{2}/.test(t))return t;try{return encodeURI(t)}catch{return t}}function H(t){let e=[],n=0,i=0;for(let r=0;r<t.length;r++){let c=t[r];c==="("&&n++,c===")"&&n--,c===","&&n===0&&(e.push(t.slice(i,r).trim()),i=r+1)}return e.push(t.slice(i).trim()),e}var it=new WeakMap,ct=new Map;function Ot(t){let e={},n=t.getPropertyValue("visibility");for(let i=0;i<t.length;i++){let r=t[i],c=t.getPropertyValue(r);(r==="background-image"||r==="content")&&c.includes("url(")&&!c.includes("data:")&&(c="none"),e[r]=c}return n==="hidden"&&(e.opacity="0"),e}function et(t,e,n,i,r){if(t.tagName==="STYLE")return;i.has(t)||i.set(t,U(t));let c=i.get(t);if(!it.has(t)){let s=Ot(c);it.set(t,s)}let a=it.get(t),f=Object.entries(a).sort(([s],[d])=>s.localeCompare(d)).map(([s,d])=>`${s}:${d}`).join(";");if(ct.has(f)){n.set(e,ct.get(f));return}let o=t.tagName?.toLowerCase()||"div",l=K(a,o,r);ct.set(f,l),n.set(e,l)}function qt(t,e){try{let n=t.currentSrc||t.src||"";if(!n)return;e.setAttribute("src",n),e.removeAttribute("srcset"),e.removeAttribute("sizes"),e.loading="eager",e.decoding="sync"}catch{}}function J(t,e,n,i,r,c={},a){if(!t)throw new Error("Invalid node");let f=new Set,o=null;if(t.nodeType===Node.TEXT_NODE||t.nodeType!==Node.ELEMENT_NODE)return t.cloneNode(!0);if(t.getAttribute("data-capture")==="exclude"){let s=document.createElement("div"),d=t.getBoundingClientRect();return s.style.cssText=`display:inline-block;width:${d.width}px;height:${d.height}px;visibility:hidden;`,s}if(c.exclude&&Array.isArray(c.exclude))for(let s of c.exclude)try{if(t.matches?.(s)){let d=document.createElement("div"),m=t.getBoundingClientRect();return d.style.cssText=`display:inline-block;width:${m.width}px;height:${m.height}px;visibility:hidden;`,d}}catch(d){console.warn(`Invalid selector in exclude option: ${s}`,d)}if(typeof c.filter=="function")try{if(!c.filter(t,a||t)){let s=document.createElement("div"),d=t.getBoundingClientRect();return s.style.cssText=`display:inline-block;width:${d.width}px;height:${d.height}px;visibility:hidden;`,s}}catch(s){console.warn("Error in filter function:",s)}if(t.tagName==="IFRAME"){let s=document.createElement("div");return s.style.cssText=`width:${t.offsetWidth}px;height:${t.offsetHeight}px;background-image:repeating-linear-gradient(45deg,#ddd,#ddd 5px,#f9f9f9 5px,#f9f9f9 10px);display:flex;align-items:center;justify-content:center;font-size:12px;color:#555;border:1px solid #aaa;`,s}if(t.getAttribute("data-capture")==="placeholder"){let s=t.cloneNode(!1);i.set(s,t),et(t,s,e,n,r);let d=document.createElement("div");return d.textContent=t.getAttribute("data-placeholder-text")||"",d.style.cssText="color:#666;font-size:12px;text-align:center;line-height:1.4;padding:0.5em;box-sizing:border-box;",s.appendChild(d),s}if(t.tagName==="CANVAS"){let s=t.toDataURL(),d=document.createElement("img");return d.src=s,d.width=t.width,d.height=t.height,i.set(d,t),et(t,d,e,n,r),d}let l;try{l=t.cloneNode(!1),i.set(l,t),t.tagName==="IMG"&&qt(t,l)}catch(s){throw console.error("[Snapdom] Failed to clone node:",t,s),s}if(t instanceof HTMLTextAreaElement){l.textContent=t.value,l.value=t.value;let s=t.getBoundingClientRect();return l.style.width=`${s.width}px`,l.style.height=`${s.height}px`,l}if(t instanceof HTMLInputElement&&(l.value=t.value,l.setAttribute("value",t.value),t.checked!==void 0&&(l.checked=t.checked,t.checked&&l.setAttribute("checked",""),t.indeterminate&&(l.indeterminate=t.indeterminate))),t instanceof HTMLSelectElement&&(o=t.value),et(t,l,e,n,r),t.shadowRoot)if(Array.from(t.shadowRoot.querySelectorAll("slot")).length>0){for(let d of t.shadowRoot.childNodes)if(d.nodeType===Node.ELEMENT_NODE&&d.tagName==="STYLE"){let m=d.textContent||"";m.trim()&&r&&n.set(d,m)}}else{let d=document.createDocumentFragment();for(let m of t.shadowRoot.childNodes){if(m.nodeType===Node.ELEMENT_NODE&&m.tagName==="STYLE"){let g=m.textContent||"";g.trim()&&r&&n.set(m,g);continue}let u=J(m,e,n,i,r,c,a||t);u&&d.appendChild(u)}l.appendChild(d)}if(t.tagName==="SLOT"){let s=t.assignedNodes?.({flatten:!0})||[],d=s.length>0?s:Array.from(t.childNodes),m=document.createDocumentFragment();for(let u of d){let g=J(u,e,n,i,r,c,a||t);g&&m.appendChild(g)}return m}for(let s of t.childNodes){if(f.has(s))continue;let d=J(s,e,n,i,r,c,a||t);d&&l.appendChild(d)}if(o!==null&&l instanceof HTMLSelectElement){l.value=o;for(let s of l.options)s.value===o?s.setAttribute("selected",""):s.removeAttribute("selected")}return l}var Vt=[/font\s*awesome/i,/material\s*icons/i,/ionicons/i,/glyphicons/i,/feather/i,/bootstrap\s*icons/i,/remix\s*icons/i,/heroicons/i,/layui/i,/lucide/i],lt=[];function At(t){let e=Array.isArray(t)?t:[t];for(let n of e)n instanceof RegExp?lt.push(n):typeof n=="string"?lt.push(new RegExp(n,"i")):console.warn("[snapdom] Ignored invalid iconFont value:",n)}function L(t){let e=typeof t=="string"?t:"",n=[...Vt,...lt];for(let i of n)if(i instanceof RegExp&&i.test(e))return!0;return!!(/icon/i.test(e)||/glyph/i.test(e)||/symbols/i.test(e)||/feather/i.test(e)||/fontawesome/i.test(e))}async function $t(t,e,n,i=32,r="#000"){e=e.replace(/^['"]+|['"]+$/g,"");let c=window.devicePixelRatio||1;await document.fonts.ready;let a=document.createElement("span");a.textContent=t,a.style.position="absolute",a.style.visibility="hidden",a.style.fontFamily=`"${e}"`,a.style.fontWeight=n||"normal",a.style.fontSize=`${i}px`,a.style.lineHeight="1",a.style.whiteSpace="nowrap",a.style.padding="0",a.style.margin="0",document.body.appendChild(a);let f=a.getBoundingClientRect(),o=Math.ceil(f.width),l=Math.ceil(f.height);document.body.removeChild(a);let s=document.createElement("canvas");s.width=o*c,s.height=l*c;let d=s.getContext("2d");return d.scale(c,c),d.font=n?`${n} ${i}px "${e}"`:`${i}px "${e}"`,d.textAlign="left",d.textBaseline="top",d.fillStyle=r,d.fillText(t,0,0),{dataUrl:s.toDataURL(),width:o,height:l}}function kt(t){return Array.from(document.styleSheets).some(e=>e.href===t)}function Ht(t){return new Promise(e=>{if(kt(t))return e(null);let n=document.createElement("link");n.rel="stylesheet",n.href=t,n.setAttribute("data-snapdom","injected-import"),n.onload=()=>e(n),n.onerror=()=>e(null),document.head.appendChild(n)})}async function nt({preCached:t=!1,localFonts:e=[],useProxy:n=""}={}){if(h.resource.has("fonts-embed-css")){if(t){let o=document.createElement("style");o.setAttribute("data-snapdom","embedFonts"),o.textContent=h.resource.get("fonts-embed-css"),document.head.appendChild(o)}return h.resource.get("fonts-embed-css")}let i=new Set;try{for(let o of document.fonts)o.status==="loaded"&&i.add(`${o.family}__${o.weight||"normal"}__${o.style||"normal"}`)}catch{}let r=/@import\s+url\(["']?([^"')]+)["']?\)/g,c=[];for(let o of document.querySelectorAll("style")){let l=o.textContent||"",s=Array.from(l.matchAll(r));for(let d of s){let m=d[1];L(m)||kt(m)||c.push(m)}}await Promise.all(c.map(Ht));let a=Array.from(document.querySelectorAll('link[rel="stylesheet"]')).filter(o=>o.href),f="";for(let o of a)try{let s=await(await V(o.href,{useProxy:n})).text();if(L(o.href)||L(s))continue;let d=/@font-face[^{}]*{[^}]*}/g,m=s;for(let u of s.match(d)||[]){let g=u.match(/font-family:\s*([^;]+);/i);if(!g)continue;let b=g[1].replace(/['"]/g,"").trim(),p=u.match(/font-weight:\s*([^;]+);/i),w=u.match(/font-style:\s*([^;]+);/i),S=p?p[1].trim():"normal",x=w?w[1].trim():"normal",R=`${b}__${S}__${x}`,y=/url\((["']?)([^"')]+)\1\)/g,k=/url\(/i.test(u),C=/local\(/i.test(u);if(!k&&C)continue;if(!i.has(R)){m=m.replace(u,"");continue}let A=u,P=Array.from(u.matchAll(y));for(let N of P){let T=X(N[0]);if(!T)continue;let v=T;if(!v.startsWith("http")&&!v.startsWith("data:")&&(v=new URL(v,o.href).href),!L(v)){if(h.resource.has(v)){h.font.add(v),A=A.replace(N[0],`url(${h.resource.get(v)})`);continue}if(!h.font.has(v))try{let B=await(await V(v,{useProxy:n})).blob(),Y=await new Promise($=>{let M=new FileReader;M.onload=()=>$(M.result),M.readAsDataURL(B)});h.resource.set(v,Y),h.font.add(v),A=A.replace(N[0],`url(${Y})`)}catch{console.warn("[snapdom] Failed to fetch font resource:",v)}}}m=m.replace(u,A)}f+=m+`
`}catch{console.warn("[snapdom] Failed to fetch CSS:",o.href)}for(let o of document.styleSheets)try{if(!o.href||a.every(l=>l.href!==o.href)){for(let l of o.cssRules)if(l.type===CSSRule.FONT_FACE_RULE){let s=l.style.getPropertyValue("src"),d=l.style.getPropertyValue("font-family");if(!s||L(d))continue;let m=l.style.getPropertyValue("font-weight")||"normal",u=l.style.getPropertyValue("font-style")||"normal",g=`${d}__${m}__${u}`,b=/url\((["']?)([^"')]+)\1\)/g,p=/local\((["']?)[^)]+?\1\)/g,w=!!s.match(b),S=!!s.match(p);if(!w&&S){f+=`@font-face{font-family:${d};src:${s};font-style:${u};font-weight:${m};}`;continue}if(!i.has(g))continue;let x=s,R=Array.from(s.matchAll(b));for(let y of R){let k=y[2].trim();if(!k)continue;let C=k;if(!C.startsWith("http")&&!C.startsWith("data:")&&(C=new URL(C,o.href||location.href).href),!L(C)){if(h.resource.has(C)){h.font.add(C),x=x.replace(y[0],`url(${h.resource.get(C)})`);continue}if(!h.font.has(C))try{let P=await(await V(C,{useProxy:n})).blob(),N=await new Promise(T=>{let v=new FileReader;v.onload=()=>T(v.result),v.readAsDataURL(P)});h.resource.set(C,N),h.font.add(C),x=x.replace(y[0],`url(${N})`)}catch{console.warn("[snapdom] Failed to fetch font URL:",C)}}}f+=`@font-face{font-family:${d};src:${x};font-style:${u};font-weight:${m};}`}}}catch(l){console.warn("[snapdom] Cannot access stylesheet",o.href,l)}for(let o of document.fonts)if(o.family&&o.status==="loaded"&&o._snapdomSrc){if(L(o.family))continue;let l=o._snapdomSrc;if(!l.startsWith("data:")){if(h.resource.has(o._snapdomSrc))l=h.resource.get(o._snapdomSrc),h.font.add(o._snapdomSrc);else if(!h.font.has(o._snapdomSrc))try{let d=await(await V(o._snapdomSrc,{useProxy:n})).blob();l=await new Promise(m=>{let u=new FileReader;u.onload=()=>m(u.result),u.readAsDataURL(d)}),h.resource.set(o._snapdomSrc,l),h.font.add(o._snapdomSrc)}catch{console.warn("[snapdom] Failed to fetch dynamic font src:",o._snapdomSrc);continue}}f+=`@font-face{font-family:'${o.family}';src:url(${l});font-style:${o.style||"normal"};font-weight:${o.weight||"normal"};}`}for(let o of e){if(!o||typeof o!="object")continue;let{family:l,src:s,weight:d="normal",style:m="normal"}=o;if(!l||!s)continue;let u=s;if(u.startsWith("data:"))h.resource.set(s,u),h.font.add(s);else try{let b=await(await V(s,{useProxy:n})).blob();u=await new Promise(p=>{let w=new FileReader;w.onload=()=>p(w.result),w.readAsDataURL(b)}),h.resource.set(s,u),h.font.add(s)}catch{console.warn("[snapdom] Failed to load local font:",s);continue}f+=`@font-face{font-family:'${l}';src:url(${u});font-style:${m};font-weight:${d};}`}if(f&&(h.resource.set("fonts-embed-css",f),t)){let o=document.createElement("style");o.setAttribute("data-snapdom","embedFonts"),o.textContent=f,document.head.appendChild(o)}return f}async function ft(t,e,n,i,r){if(!(t instanceof Element)||!(e instanceof Element))return;for(let f of["::before","::after","::first-letter"])try{let o=U(t,f);if(!o||typeof o[Symbol.iterator]!="function"||o.content==="none"&&o.backgroundImage==="none"&&o.backgroundColor==="transparent"&&(o.borderStyle==="none"||parseFloat(o.borderWidth)===0)&&(!o.transform||o.transform==="none")&&o.display==="inline")continue;if(f==="::first-letter"){let I=getComputedStyle(t);if(!(o.color!==I.color||o.fontSize!==I.fontSize||o.fontWeight!==I.fontWeight))continue;let D=Array.from(e.childNodes).find(pt=>pt.nodeType===Node.TEXT_NODE&&pt.textContent?.trim().length>0);if(!D)continue;let _=D.textContent,Z=_.match(/^([^\p{L}\p{N}\s]*[\p{L}\p{N}](?:['’])?)/u)?.[0],Ut=_.slice(Z?.length||0);if(!Z||/[\uD800-\uDFFF]/.test(Z))continue;let tt=document.createElement("span");tt.textContent=Z,tt.dataset.snapdomPseudo="::first-letter";let Mt=st(o),Dt=K(Mt,"span",r);n.set(tt,Dt);let gt=document.createTextNode(Ut);e.replaceChild(gt,D),e.insertBefore(tt,gt);continue}let s=o.content,d=/counter\s*\(|counters\s*\(/.test(s)?"- ":Ct(s),m=o.backgroundImage,u=o.backgroundColor,g=o.fontFamily,b=parseInt(o.fontSize)||32,p=parseInt(o.fontWeight)||!1,w=o.color||"#000",S=o.display,x=parseFloat(o.width),R=parseFloat(o.height),y=o.borderStyle,k=parseFloat(o.borderWidth),C=o.transform,A=L(g),P=s!=="none"&&d!=="",N=m&&m!=="none",T=u&&u!=="transparent"&&u!=="rgba(0, 0, 0, 0)",v=S!=="inline"&&(x>0||R>0),z=y&&y!=="none"&&k>0,B=C&&C!=="none";if(!(P||N||T||v||z||B))continue;let $=document.createElement("span");$.dataset.snapdomPseudo=f,$.style.verticalAlign="middle";let M=st(o),rt=K(M,"span",r);if(n.set($,rt),A&&d.length===1){let{dataUrl:I,width:F,height:D}=await $t(d,g,p,b,w),_=document.createElement("img");_.src=I,_.style=`height:${b}px;width:${F/D*b}px;object-fit:contain;`,$.appendChild(_),e.dataset.snapdomHasIcon="true"}else if(d.startsWith("url(")){let I=X(d);if(I?.trim())try{let F=document.createElement("img"),D=await W(G(I),r);F.src=D,F.style=`width:${b}px;height:auto;object-fit:contain;`,$.appendChild(F)}catch(F){console.error(`[snapdom] Error in pseudo ${f} for`,t,F)}}else!A&&P&&($.textContent=d);if(N)try{let I=H(m),F=await Promise.all(I.map(O));$.style.backgroundImage=F.join(", ")}catch(I){console.warn(`[snapdom] Failed to inline background-image for ${f}`,I)}if(T&&($.style.backgroundColor=u),!($.childNodes.length>0||$.textContent?.trim()!==""||N||T||v||z||B))continue;f==="::before"?e.insertBefore($,e.firstChild):e.appendChild($)}catch(o){console.warn(`[snapdom] Failed to capture ${f} for`,t,o)}let c=Array.from(t.children),a=Array.from(e.children).filter(f=>!f.dataset.snapdomPseudo);for(let f=0;f<Math.min(c.length,a.length);f++)await ft(c[f],a[f],n,i,r)}function It(t){if(!t)return;let e=new Set;if(t.querySelectorAll("use").forEach(f=>{let o=f.getAttribute("xlink:href")||f.getAttribute("href");o&&o.startsWith("#")&&e.add(o.slice(1))}),!e.size)return;let n=Array.from(document.querySelectorAll("svg > symbol, svg > defs")),i=n.filter(f=>f.tagName.toLowerCase()==="symbol"),r=n.filter(f=>f.tagName.toLowerCase()==="defs"),c=t.querySelector("svg.inline-defs-container");c||(c=document.createElementNS("http://www.w3.org/2000/svg","svg"),c.setAttribute("aria-hidden","true"),c.setAttribute("style","position: absolute; width: 0; height: 0; overflow: hidden;"),c.classList.add("inline-defs-container"),t.insertBefore(c,t.firstChild));let a=new Set;t.querySelectorAll("symbol[id], defs > *[id]").forEach(f=>{a.add(f.id)}),e.forEach(f=>{if(a.has(f))return;let o=i.find(l=>l.id===f);if(o){c.appendChild(o.cloneNode(!0)),a.add(f);return}for(let l of r){let s=l.querySelector(`#${CSS.escape(f)}`);if(s){let d=c.querySelector("defs");d||(d=document.createElementNS("http://www.w3.org/2000/svg","defs"),c.appendChild(d)),d.appendChild(s.cloneNode(!0)),a.add(f);break}}})}async function Nt(t,e=!1,n=!1,i={}){let r=new Map,c=new WeakMap,a=new Map,f,o="";zt(t);try{It(t)}catch(l){console.warn("inlineExternal defs or symbol failed:",l)}try{f=J(t,r,c,a,e,i,t)}catch(l){throw console.warn("deepClone failed:",l),l}try{await ft(t,f,r,c,e,n,i.useProxy)}catch(l){console.warn("inlinePseudoElements failed:",l)}if(await Gt(f),e){let l=xt(r);o=Array.from(l.entries()).map(([s,d])=>`.${d}{${s}}`).join("");for(let[s,d]of r.entries()){if(s.tagName==="STYLE")continue;if(s.getRootNode&&s.getRootNode()instanceof ShadowRoot){s.setAttribute("style",d.replace(/;/g,"; "));continue}let m=l.get(d);m&&s.classList.add(m);let u=s.style?.backgroundImage,g=s.dataset?.snapdomHasIcon;u&&u!=="none"&&(s.style.backgroundImage=u),g&&(s.style.verticalAlign="middle",s.style.display="inline")}}else for(let[l,s]of r.entries())l.tagName!=="STYLE"&&l.setAttribute("style",s.replace(/;/g,"; "));for(let[l,s]of a.entries()){let d=s.scrollLeft,m=s.scrollTop;if((d||m)&&l instanceof HTMLElement){l.style.overflow="hidden",l.style.scrollbarWidth="none",l.style.msOverflowStyle="none";let g=document.createElement("div");for(g.style.transform=`translate(${-d}px, ${-m}px)`,g.style.willChange="transform",g.style.display="inline-block",g.style.width="100%";l.firstChild;)g.appendChild(l.firstChild);l.appendChild(g)}}if(t===a.get(f)){let l=c.get(t)||window.getComputedStyle(t);c.set(t,l);let s=Et(l.transform);f.style.margin="0",f.style.position="static",f.style.top="auto",f.style.left="auto",f.style.right="auto",f.style.bottom="auto",f.style.zIndex="auto",f.style.float="none",f.style.clear="none",f.style.transform=s||""}for(let[l,s]of a.entries())s.tagName==="PRE"&&(l.style.marginTop="0",l.style.marginBlockStart="0");return{clone:f,classCSS:o,styleCache:c}}function zt(t){let e=getComputedStyle(t),n=e.outlineStyle,i=e.outlineWidth,r=e.borderStyle,c=e.borderWidth,a=n!=="none"&&parseFloat(i)>0,f=r==="none"||parseFloat(c)===0;a&&f&&(t.style.border=`${i} solid transparent`)}var dt=new Map;async function Q(t){if(dt.has(t))return dt.get(t);let e=await fetch(t);if(!e.ok)throw new Error(`[SnapDOM] HTTP ${e.status} on blob fetch (${t})`);let n=await e.blob(),i=await new Promise((r,c)=>{let a=new FileReader;a.onloadend=()=>{let f=a.result;typeof f=="string"&&f.startsWith("data:")?r(f):c(new Error("[SnapDOM] Invalid data URL from blob"))},a.onerror=()=>c(new Error("[SnapDOM] FileReader error")),a.readAsDataURL(n)});return dt.set(t,i),i}var Yt=/\bblob:[^)"'\s]+/g;async function Rt(t){if(!t||t.indexOf("blob:")===-1)return t;let e=Array.from(new Set(t.match(Yt)||[]));if(e.length===0)return t;let n=t;for(let i of e)try{let r=await Q(i);n=n.split(i).join(r)}catch{}return n}function ot(t){return typeof t=="string"&&t.startsWith("blob:")}function Kt(t){return(t||"").split(",").map(e=>e.trim()).filter(Boolean).map(e=>{let n=e.match(/^(\S+)(\s+.+)?$/);return n?{url:n[1],desc:n[2]||""}:null}).filter(Boolean)}function Xt(t){return t.map(e=>e.desc?`${e.url} ${e.desc.trim()}`:e.url).join(", ")}async function Gt(t){if(!t)return;let e=t.querySelectorAll?t.querySelectorAll("img"):[];for(let a of e)try{let o=a.getAttribute("src")||a.currentSrc||"";if(ot(o)){let s=await Q(o);a.setAttribute("src",s)}let l=a.getAttribute("srcset");if(l&&l.includes("blob:")){let s=Kt(l),d=!1;for(let m of s)if(ot(m.url))try{m.url=await Q(m.url),d=!0}catch{}d&&a.setAttribute("srcset",Xt(s))}}catch{}let n=t.querySelectorAll?t.querySelectorAll("image"):[];for(let a of n)try{let f="http://www.w3.org/1999/xlink",o=a.getAttribute("href")||a.getAttributeNS?.(f,"href");if(ot(o)){let l=await Q(o);a.setAttribute("href",l),a.removeAttributeNS?.(f,"href")}}catch{}let i=t.querySelectorAll?t.querySelectorAll("[style*='blob:']"):[];for(let a of i)try{let f=a.getAttribute("style");if(f&&f.includes("blob:")){let o=await Rt(f);a.setAttribute("style",o)}}catch{}let r=t.querySelectorAll?t.querySelectorAll("style"):[];for(let a of r)try{let f=a.textContent||"";f.includes("blob:")&&(a.textContent=await Rt(f))}catch{}let c=["poster"];for(let a of c){let f=t.querySelectorAll?t.querySelectorAll(`[${a}^='blob:']`):[];for(let o of f)try{let l=o.getAttribute(a);ot(l)&&o.setAttribute(a,await Q(l))}catch{}}}async function Tt(t,e={}){let n=Array.from(t.querySelectorAll("img")),i=async r=>{if(!r.getAttribute("src")){let a=r.currentSrc||r.src||"";a&&r.setAttribute("src",a)}r.removeAttribute("srcset"),r.removeAttribute("sizes");let c=r.src;try{let a=await W(c,{useProxy:e.useProxy});r.src=a,r.width||(r.width=r.naturalWidth||100),r.height||(r.height=r.naturalHeight||100)}catch{let a=document.createElement("div");a.style=`width: ${r.width||100}px; height: ${r.height||100}px; background: #ccc; display: inline-block; text-align: center; line-height: ${r.height||100}px; color: #666; font-size: 12px;`,a.innerText="img",r.replaceWith(a)}};for(let r=0;r<n.length;r+=4){let c=n.slice(r,r+4).map(i);await Promise.allSettled(c)}}async function Ft(t,e,n,i={}){let r=[[t,e]],c=["background-image","mask","mask-image","-webkit-mask-image","mask-source","mask-box-image-source","mask-border-source","-webkit-mask-box-image-source","border-image","border-image-source","border-image-slice","border-image-width","border-image-outset","border-image-repeat"];for(;r.length;){let[a,f]=r.shift(),o=n.get(a)||U(a);n.has(a)||n.set(a,o);let l=(()=>{let u=o.getPropertyValue("border-image"),g=o.getPropertyValue("border-image-source");return u&&u!=="none"||g&&g!=="none"})();for(let u of c){if(["border-image-slice","border-image-width","border-image-outset","border-image-repeat"].includes(u)&&!l)continue;let g=o.getPropertyValue(u);if(!g||g==="none")continue;let b=H(g),p=await Promise.all(b.map(w=>O(w,i)));p.some(w=>w&&w!=="none"&&!/^url\(undefined/.test(w))&&f.style.setProperty(u,p.join(", "))}let s=o.getPropertyValue("background-color");s&&s!=="transparent"&&s!=="rgba(0, 0, 0, 0)"&&(f.style.backgroundColor=s);let d=Array.from(a.children),m=Array.from(f.children);for(let u=0;u<Math.min(d.length,m.length);u++)r.push([d[u],m[u]])}}async function Lt(t,e={}){if(!t)throw new Error("Element cannot be null or undefined");h.reset();let{compress:n=!0,embedFonts:i=!1,fast:r=!0,scale:c=1,useProxy:a="",localFonts:f=[]}=e,o,l,s,d="",m="",u,g;if({clone:o,classCSS:l,styleCache:s}=await Nt(t,n,i,e),await new Promise(p=>{q(async()=>{await Tt(o,e),p()},{fast:r})}),await new Promise(p=>{q(async()=>{await Ft(t,o,s,e),p()},{fast:r})}),i&&await new Promise(p=>{q(async()=>{d=await nt({localFonts:f,useProxy:a}),p()},{fast:r})}),n){let p=bt(o).sort(),w=p.join(",");h.baseStyle.has(w)?m=h.baseStyle.get(w):await new Promise(S=>{q(()=>{m=St(p),h.baseStyle.set(w,m),S()},{fast:r})})}await new Promise(p=>{q(()=>{let w=t.getBoundingClientRect(),S=w.width,x=w.height,R=Number.isFinite(e.width),y=Number.isFinite(e.height),k=typeof c=="number"&&c!==1;if(!k){let B=w.width/w.height;R&&y?(S=e.width,x=e.height):R?(S=e.width,x=S/B):y&&(x=e.height,S=x*B)}if(S=Math.ceil(S),x=Math.ceil(x),o.setAttribute("xmlns","http://www.w3.org/1999/xhtml"),o.style.transformOrigin="top left",!k&&(R||y)){let B=w.width,Y=w.height,$=S/B,M=x/Y,rt=o.style.transform||"",ht=`scale(${$}, ${M})`;o.style.transform=`${ht} ${rt}`.trim()}let C="http://www.w3.org/2000/svg",A=document.createElementNS(C,"foreignObject");A.setAttribute("width","100%"),A.setAttribute("height","100%");let P=document.createElement("style");P.textContent=m+d+"svg{overflow:visible;}"+l,A.appendChild(P),A.appendChild(o);let T=new XMLSerializer().serializeToString(A);g=`<svg xmlns="${C}" width="${S}" height="${x}" viewBox="0 0 ${S} ${x}">`+T+"</svg>",u=`data:image/svg+xml;charset=utf-8,${encodeURIComponent(g)}`,p()},{fast:r})});let b=document.getElementById("snapdom-sandbox");return b&&b.style.position==="absolute"&&b.remove(),u}async function Jt(t,{scale:e=1}={}){let n=new Image;return n.src=t,await n.decode(),e!==1&&(n.style.width=`${n.naturalWidth*e}px`,n.style.height=`${n.naturalHeight*e}px`),n}async function Pt(t,{dpr:e=1,scale:n=1}={}){let i=new Image;i.src=t,i.crossOrigin="anonymous",i.loading="eager",i.decoding="sync";let r=vt(),c=!1;if(r&&(document.body.appendChild(i),c=!0),await i.decode(),r&&await new Promise(s=>setTimeout(s,100)),i.width===0||i.height===0)throw c&&i.remove(),new Error("Image failed to load or has no dimensions");let a=i.naturalWidth*n,f=i.naturalHeight*n,o=document.createElement("canvas");o.width=Math.ceil(a*e),o.height=Math.ceil(f*e),o.style.width=`${a}px`,o.style.height=`${f}px`;let l=o.getContext("2d");return l.scale(e,e),l.drawImage(i,0,0,a,f),c&&i.remove(),o}async function Bt(t,{type:e="svg",scale:n=1,backgroundColor:i="#fff",quality:r}={}){let c={jpg:"image/jpeg",jpeg:"image/jpeg",png:"image/png",webp:"image/webp"}[e]||"image/png";if(e==="svg"){let f=decodeURIComponent(t.split(",")[1]);return new Blob([f],{type:"image/svg+xml"})}let a=await mt(t,{dpr:1,scale:n},i);return new Promise(f=>{a.toBlob(o=>f(o),`${c}`,r)})}async function mt(t,{dpr:e=1,scale:n=1},i){let r=await Pt(t,{dpr:e,scale:n});if(!i)return r;let c=document.createElement("canvas");c.width=r.width,c.height=r.height;let a=c.getContext("2d");return a.fillStyle=i,a.fillRect(0,0,c.width,c.height),a.drawImage(r,0,0),c}async function ut(t,{dpr:e=1,scale:n=1,backgroundColor:i,quality:r},c="png"){let a=["jpg","jpeg","webp"].includes(c)?"#fff":void 0,o=await mt(t,{dpr:e,scale:n},i??a),l=new Image;return l.src=o.toDataURL(`image/${c}`,r),await l.decode(),l.style.width=`${o.width/e}px`,l.style.height=`${o.height/e}px`,l}async function Qt(t,{dpr:e=1,scale:n=1,backgroundColor:i,format:r="png",filename:c="snapDOM"}={}){if(r==="svg"){let m=await Bt(t),u=URL.createObjectURL(m),g=document.createElement("a");g.href=u,g.download=`${c}.svg`,g.click(),URL.revokeObjectURL(u);return}let a=["jpg","jpeg","webp"].includes(r)?"#fff":void 0,o=await mt(t,{dpr:e,scale:n},i??a),l={jpg:"image/jpeg",jpeg:"image/jpeg",png:"image/png",webp:"image/webp"}[r]||"image/png",s=o.toDataURL(l),d=document.createElement("a");d.href=s,d.download=`${c}.${r}`,d.click()}async function E(t,e={}){if(e={scale:1,...e},!t)throw new Error("Element cannot be null or undefined");return e.iconFonts&&At(e.iconFonts),await E.capture(t,e)}E.capture=async(t,e={})=>{let n=await Lt(t,e),i=e.dpr??(window.devicePixelRatio||1),r=e.scale||1;return{url:n,options:e,toRaw:()=>n,toImg:(c={})=>Jt(n,{dpr:i,scale:r,...c}),toCanvas:(c={})=>Pt(n,{dpr:i,scale:r,...c}),toBlob:(c={})=>Bt(n,{dpr:i,scale:r,...c}),toPng:(c={})=>ut(n,{dpr:i,scale:r,...c},"png"),toJpg:(c={})=>ut(n,{dpr:i,scale:r,...c},"jpeg"),toWebp:(c={})=>ut(n,{dpr:i,scale:r,...c},"webp"),download:({format:c="png",filename:a="snapDOM",backgroundColor:f,...o}={})=>Qt(n,{dpr:i,scale:r,format:c,filename:a,backgroundColor:f,...o})}};E.toRaw=async(t,e)=>(await E.capture(t,e)).toRaw();E.toImg=async(t,e)=>(await E.capture(t,e)).toImg();E.toCanvas=async(t,e)=>(await E.capture(t,e)).toCanvas();E.toBlob=async(t,e)=>(await E.capture(t,e)).toBlob(e);E.toPng=async(t,e)=>(await E.capture(t,e)).toPng(e);E.toJpg=async(t,e)=>(await E.capture(t,e)).toJpg(e);E.toWebp=async(t,e)=>(await E.capture(t,e)).toWebp(e);E.download=async(t,e={})=>{let{format:n="png",filename:i="capture",backgroundColor:r,...c}=e;return await(await E.capture(t,c)).download({format:n,filename:i,backgroundColor:r})};async function Zt(t=document,e={}){let{embedFonts:n=!0,reset:i=!1,useProxy:r}=e;if(i){h.image.clear(),h.background.clear(),h.resource.clear(),h.defaultStyle.clear(),h.baseStyle.clear(),h.font.clear(),h.computedStyle=new WeakMap;return}try{await document.fonts.ready}catch{}yt();let c=[],a=[];t?.querySelectorAll&&(c=Array.from(t.querySelectorAll("img[src]")),a=Array.from(t.querySelectorAll("*")));let f=[];for(let o of c){let l=o?.src;if(l&&!h.image.has(l)){let s=Promise.resolve().then(()=>W(l,{useProxy:r})).then(d=>{h.image.set(l,d)}).catch(()=>{});f.push(s)}}for(let o of a){let l="";try{l=U(o).backgroundImage}catch{}if(l&&l!=="none"){let s=H(l);for(let d of s)if(d.startsWith("url(")){let m=Promise.resolve().then(()=>O(d,{...e,useProxy:r})).catch(()=>{});f.push(m)}}}if(n)try{await nt({preCached:!0,localFonts:e.localFonts,useProxy:e.useProxy})}catch{}await Promise.allSettled(f)}export{Zt as preCache,E as snapdom};
