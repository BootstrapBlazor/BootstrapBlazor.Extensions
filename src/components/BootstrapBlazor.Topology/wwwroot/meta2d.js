!function(t,e){"object"==typeof exports&&"object"==typeof module?module.exports=e():"function"==typeof define&&define.amd?define([],e):"object"==typeof exports?exports.meta2djs=e():t.meta2djs=e()}(self,()=>(()=>{var t={22:(t,e,i)=>{t.exports=function t(e,i,n){function o(a,r){if(!i[a]){if(!e[a]){if(s)return s(a,!0);var l=new Error("Cannot find module '"+a+"'");throw l.code="MODULE_NOT_FOUND",l}var c=i[a]={exports:{}};e[a][0].call(c.exports,function(t){return o(e[a][1][t]||t)},c,c.exports,t,e,i,n)}return i[a].exports}for(var s=void 0,a=0;a<n.length;a++)o(n[a]);return o}({1:[function(t,e,n){(function(i,n){(function(){"use strict";const o=t("events").EventEmitter,s=t("./store"),a=t("./topic-alias-recv"),r=t("./topic-alias-send"),l=t("mqtt-packet"),c=t("./default-message-id-provider"),h=t("readable-stream").Writable,d=t("inherits"),u=t("reinterval"),f=t("rfdc/default"),p=t("./validations"),v=t("xtend"),g=t("debug")("mqttjs:client"),y=i?i.nextTick:function(t){setTimeout(t,0)},m=n.setImmediate||function(t){y(t)},w={keepalive:60,reschedulePings:!0,protocolId:"MQTT",protocolVersion:4,reconnectPeriod:1e3,connectTimeout:3e4,clean:!0,resubscribe:!0},x={0:"",1:"Unacceptable protocol version",2:"Identifier rejected",3:"Server unavailable",4:"Bad username or password",5:"Not authorized",16:"No matching subscribers",17:"No subscription existed",128:"Unspecified error",129:"Malformed Packet",130:"Protocol Error",131:"Implementation specific error",132:"Unsupported Protocol Version",133:"Client Identifier not valid",134:"Bad User Name or Password",135:"Not authorized",136:"Server unavailable",137:"Server busy",138:"Banned",139:"Server shutting down",140:"Bad authentication method",141:"Keep Alive timeout",142:"Session taken over",143:"Topic Filter invalid",144:"Topic Name invalid",145:"Packet identifier in use",146:"Packet Identifier not found",147:"Receive Maximum exceeded",148:"Topic Alias invalid",149:"Packet too large",150:"Message rate too high",151:"Quota exceeded",152:"Administrative action",153:"Payload format invalid",154:"Retain not supported",155:"QoS not supported",156:"Use another server",157:"Server moved",158:"Shared Subscriptions not supported",159:"Connection rate exceeded",160:"Maximum connect time",161:"Subscription Identifiers not supported",162:"Wildcard Subscriptions not supported"};function b(t,e){let i;e.properties&&(i=e.properties.topicAlias);let n=e.topic.toString();if(0===n.length){if(void 0===i)return new Error("Unregistered Topic Alias");if(void 0===(n=t.topicAliasSend.getTopicByAlias(i)))return new Error("Unregistered Topic Alias");e.topic=n}i&&delete e.properties.topicAlias}function k(t,e,i){g("sendPacket :: packet: %O",e),g("sendPacket :: emitting `packetsend`"),t.emit("packetsend",e),g("sendPacket :: writing to stream");const n=l.writeToStream(e,t.stream,t.options);g("sendPacket :: writeToStream result %s",n),!n&&i&&i!==C?(g("sendPacket :: handle events on `drain` once through callback."),t.stream.once("drain",i)):i&&(g("sendPacket :: invoking cb"),i())}function T(t,e,i,n){g("storeAndSend :: store packet with cmd %s to outgoingStore",e.cmd);let o,s=e;if("publish"===s.cmd&&(s=f(e),o=b(t,s)))return i&&i(o);t.outgoingStore.put(s,function(o){if(o)return i&&i(o);n(),k(t,e,i)})}function C(t){g("nop ::",t)}function A(t,e){let i;const n=this;if(!(this instanceof A))return new A(t,e);for(i in this.options=e||{},w)void 0===this.options[i]?this.options[i]=w[i]:this.options[i]=e[i];g("MqttClient :: options.protocol",e.protocol),g("MqttClient :: options.protocolVersion",e.protocolVersion),g("MqttClient :: options.username",e.username),g("MqttClient :: options.keepalive",e.keepalive),g("MqttClient :: options.reconnectPeriod",e.reconnectPeriod),g("MqttClient :: options.rejectUnauthorized",e.rejectUnauthorized),g("MqttClient :: options.topicAliasMaximum",e.topicAliasMaximum),this.options.clientId="string"==typeof e.clientId?e.clientId:"mqttjs_"+Math.random().toString(16).substr(2,8),g("MqttClient :: clientId",this.options.clientId),this.options.customHandleAcks=5===e.protocolVersion&&e.customHandleAcks?e.customHandleAcks:function(){arguments[3](0)},this.streamBuilder=t,this.messageIdProvider=void 0===this.options.messageIdProvider?new c:this.options.messageIdProvider,this.outgoingStore=e.outgoingStore||new s,this.incomingStore=e.incomingStore||new s,this.queueQoSZero=void 0===e.queueQoSZero||e.queueQoSZero,this._resubscribeTopics={},this.messageIdToTopic={},this.pingTimer=null,this.connected=!1,this.disconnecting=!1,this.queue=[],this.connackTimer=null,this.reconnectTimer=null,this._storeProcessing=!1,this._packetIdsDuringStoreProcessing={},this._storeProcessingQueue=[],this.outgoing={},this._firstConnection=!0,e.topicAliasMaximum>0&&(e.topicAliasMaximum>65535?g("MqttClient :: options.topicAliasMaximum is out of range"):this.topicAliasRecv=new a(e.topicAliasMaximum)),this.on("connect",function(){const t=this.queue;g("connect :: sending queued packets"),function e(){const i=t.shift();g("deliver :: entry %o",i);let o=null;if(!i)return void n._resubscribe();o=i.packet,g("deliver :: call _sendPacket for %o",o);let s=!0;o.messageId&&0!==o.messageId&&(n.messageIdProvider.register(o.messageId)||(s=!1)),s?n._sendPacket(o,function(t){i.cb&&i.cb(t),e()}):(g("messageId: %d has already used. The message is skipped and removed.",o.messageId),e())}()}),this.on("close",function(){g("close :: connected set to `false`"),this.connected=!1,g("close :: clearing connackTimer"),clearTimeout(this.connackTimer),g("close :: clearing ping timer"),null!==n.pingTimer&&(n.pingTimer.clear(),n.pingTimer=null),this.topicAliasRecv&&this.topicAliasRecv.clear(),g("close :: calling _setupReconnect"),this._setupReconnect()}),o.call(this),g("MqttClient :: setting up stream"),this._setupStream()}d(A,o),A.prototype._setupStream=function(){const t=this,e=new h,i=l.parser(this.options);let n=null;const o=[];function s(){if(o.length)y(a);else{const t=n;n=null,t()}}function a(){g("work :: getting next packet in queue");const e=o.shift();if(e)g("work :: packet pulled from queue"),t._handlePacket(e,s);else{g("work :: no packets in queue");const t=n;n=null,g("work :: done flag is %s",!!t),t&&t()}}g("_setupStream :: calling method to clear reconnect"),this._clearReconnect(),g("_setupStream :: using streamBuilder provided to client to create stream"),this.stream=this.streamBuilder(this),i.on("packet",function(t){g("parser :: on packet push to packets array."),o.push(t)}),e._write=function(t,e,o){n=o,g("writable stream :: parsing buffer"),i.parse(t),a()},g("_setupStream :: pipe stream to writable stream"),this.stream.pipe(e),this.stream.on("error",function(e){g("streamErrorHandler :: error",e.message),e.code?(g("streamErrorHandler :: emitting error"),t.emit("error",e)):C(e)}),this.stream.on("close",function(){var e;g("(%s)stream :: on close",t.options.clientId),(e=t.outgoing)&&(g("flushVolatile :: deleting volatile messages from the queue and setting their callbacks as error function"),Object.keys(e).forEach(function(t){e[t].volatile&&"function"==typeof e[t].cb&&(e[t].cb(new Error("Connection closed")),delete e[t])})),g("stream: emit close to MqttClient"),t.emit("close")}),g("_setupStream: sending packet `connect`");const r=Object.create(this.options);if(r.cmd="connect",this.topicAliasRecv&&(r.properties||(r.properties={}),this.topicAliasRecv&&(r.properties.topicAliasMaximum=this.topicAliasRecv.max)),k(this,r),i.on("error",this.emit.bind(this,"error")),this.options.properties){if(!this.options.properties.authenticationMethod&&this.options.properties.authenticationData)return t.end(()=>this.emit("error",new Error("Packet has no Authentication Method"))),this;this.options.properties.authenticationMethod&&this.options.authPacket&&"object"==typeof this.options.authPacket&&k(this,v({cmd:"auth",reasonCode:0},this.options.authPacket))}this.stream.setMaxListeners(1e3),clearTimeout(this.connackTimer),this.connackTimer=setTimeout(function(){g("!!connectTimeout hit!! Calling _cleanUp with force `true`"),t._cleanUp(!0)},this.options.connectTimeout)},A.prototype._handlePacket=function(t,e){const i=this.options;if(5===i.protocolVersion&&i.properties&&i.properties.maximumPacketSize&&i.properties.maximumPacketSize<t.length)return this.emit("error",new Error("exceeding packets size "+t.cmd)),this.end({reasonCode:149,properties:{reasonString:"Maximum packet size was exceeded"}}),this;switch(g("_handlePacket :: emitting packetreceive"),this.emit("packetreceive",t),t.cmd){case"publish":this._handlePublish(t,e);break;case"puback":case"pubrec":case"pubcomp":case"suback":case"unsuback":this._handleAck(t),e();break;case"pubrel":this._handlePubrel(t,e);break;case"connack":this._handleConnack(t),e();break;case"auth":this._handleAuth(t),e();break;case"pingresp":this._handlePingresp(t),e();break;case"disconnect":this._handleDisconnect(t),e()}},A.prototype._checkDisconnecting=function(t){return this.disconnecting&&(t&&t!==C?t(new Error("client disconnecting")):this.emit("error",new Error("client disconnecting"))),this.disconnecting},A.prototype.publish=function(t,e,i,n){g("publish :: message `%s` to topic `%s`",e,t);const o=this.options;if("function"==typeof i&&(n=i,i=null),i=v({qos:0,retain:!1,dup:!1},i),this._checkDisconnecting(n))return this;const s=this,a=function(){let a=0;if((1===i.qos||2===i.qos)&&null===(a=s._nextId()))return g("No messageId left"),!1;const r={cmd:"publish",topic:t,payload:e,qos:i.qos,retain:i.retain,messageId:a,dup:i.dup};switch(5===o.protocolVersion&&(r.properties=i.properties),g("publish :: qos",i.qos),i.qos){case 1:case 2:s.outgoing[r.messageId]={volatile:!1,cb:n||C},g("MqttClient:publish: packet cmd: %s",r.cmd),s._sendPacket(r,void 0,i.cbStorePut);break;default:g("MqttClient:publish: packet cmd: %s",r.cmd),s._sendPacket(r,n,i.cbStorePut)}return!0};return(this._storeProcessing||this._storeProcessingQueue.length>0||!a())&&this._storeProcessingQueue.push({invoke:a,cbStorePut:i.cbStorePut,callback:n}),this},A.prototype.subscribe=function(){const t=this,e=new Array(arguments.length);for(let t=0;t<arguments.length;t++)e[t]=arguments[t];const i=[];let n=e.shift();const o=n.resubscribe;let s=e.pop()||C,a=e.pop();const r=this.options.protocolVersion;delete n.resubscribe,"string"==typeof n&&(n=[n]),"function"!=typeof s&&(a=s,s=C);const l=p.validateTopics(n);if(null!==l)return m(s,new Error("Invalid topic "+l)),this;if(this._checkDisconnecting(s))return g("subscribe: discconecting true"),this;const c={qos:0};if(5===r&&(c.nl=!1,c.rap=!1,c.rh=0),a=v(c,a),Array.isArray(n)?n.forEach(function(e){if(g("subscribe: array topic %s",e),!Object.prototype.hasOwnProperty.call(t._resubscribeTopics,e)||t._resubscribeTopics[e].qos<a.qos||o){const t={topic:e,qos:a.qos};5===r&&(t.nl=a.nl,t.rap=a.rap,t.rh=a.rh,t.properties=a.properties),g("subscribe: pushing topic `%s` and qos `%s` to subs list",t.topic,t.qos),i.push(t)}}):Object.keys(n).forEach(function(e){if(g("subscribe: object topic %s",e),!Object.prototype.hasOwnProperty.call(t._resubscribeTopics,e)||t._resubscribeTopics[e].qos<n[e].qos||o){const t={topic:e,qos:n[e].qos};5===r&&(t.nl=n[e].nl,t.rap=n[e].rap,t.rh=n[e].rh,t.properties=a.properties),g("subscribe: pushing `%s` to subs list",t),i.push(t)}}),!i.length)return s(null,[]),this;const h=function(){const e=t._nextId();if(null===e)return g("No messageId left"),!1;const n={cmd:"subscribe",subscriptions:i,qos:1,retain:!1,dup:!1,messageId:e};if(a.properties&&(n.properties=a.properties),t.options.resubscribe){g("subscribe :: resubscribe true");const e=[];i.forEach(function(i){if(t.options.reconnectPeriod>0){const n={qos:i.qos};5===r&&(n.nl=i.nl||!1,n.rap=i.rap||!1,n.rh=i.rh||0,n.properties=i.properties),t._resubscribeTopics[i.topic]=n,e.push(i.topic)}}),t.messageIdToTopic[n.messageId]=e}return t.outgoing[n.messageId]={volatile:!0,cb:function(t,e){if(!t){const t=e.granted;for(let e=0;e<t.length;e+=1)i[e].qos=t[e]}s(t,i)}},g("subscribe :: call _sendPacket"),t._sendPacket(n),!0};return(this._storeProcessing||this._storeProcessingQueue.length>0||!h())&&this._storeProcessingQueue.push({invoke:h,callback:s}),this},A.prototype.unsubscribe=function(){const t=this,e=new Array(arguments.length);for(let t=0;t<arguments.length;t++)e[t]=arguments[t];let i=e.shift(),n=e.pop()||C,o=e.pop();"string"==typeof i&&(i=[i]),"function"!=typeof n&&(o=n,n=C);const s=p.validateTopics(i);if(null!==s)return m(n,new Error("Invalid topic "+s)),this;if(t._checkDisconnecting(n))return this;const a=function(){const e=t._nextId();if(null===e)return g("No messageId left"),!1;const s={cmd:"unsubscribe",qos:1,messageId:e};return"string"==typeof i?s.unsubscriptions=[i]:Array.isArray(i)&&(s.unsubscriptions=i),t.options.resubscribe&&s.unsubscriptions.forEach(function(e){delete t._resubscribeTopics[e]}),"object"==typeof o&&o.properties&&(s.properties=o.properties),t.outgoing[s.messageId]={volatile:!0,cb:n},g("unsubscribe: call _sendPacket"),t._sendPacket(s),!0};return(this._storeProcessing||this._storeProcessingQueue.length>0||!a())&&this._storeProcessingQueue.push({invoke:a,callback:n}),this},A.prototype.end=function(t,e,i){const n=this;function o(){g("end :: (%s) :: finish :: calling _cleanUp with force %s",n.options.clientId,t),n._cleanUp(t,()=>{g("end :: finish :: calling process.nextTick on closeStores"),y(function(){g("end :: closeStores: closing incoming and outgoing stores"),n.disconnected=!0,n.incomingStore.close(function(t){n.outgoingStore.close(function(e){if(g("end :: closeStores: emitting end"),n.emit("end"),i){const n=t||e;g("end :: closeStores: invoking callback with args"),i(n)}})}),n._deferredReconnect&&n._deferredReconnect()}.bind(n))},e)}return g("end :: (%s)",this.options.clientId),null!=t&&"boolean"==typeof t||(i=e||C,e=t,t=!1,"object"!=typeof e&&(i=e,e=null,"function"!=typeof i&&(i=C))),"object"!=typeof e&&(i=e,e=null),g("end :: cb? %s",!!i),i=i||C,this.disconnecting?(i(),this):(this._clearReconnect(),this.disconnecting=!0,!t&&Object.keys(this.outgoing).length>0?(g("end :: (%s) :: calling finish in 10ms once outgoing is empty",n.options.clientId),this.once("outgoingEmpty",setTimeout.bind(null,o,10))):(g("end :: (%s) :: immediately calling finish",n.options.clientId),o()),this)},A.prototype.removeOutgoingMessage=function(t){const e=this.outgoing[t]?this.outgoing[t].cb:null;return delete this.outgoing[t],this.outgoingStore.del({messageId:t},function(){e(new Error("Message removed"))}),this},A.prototype.reconnect=function(t){g("client reconnect");const e=this,i=function(){t?(e.options.incomingStore=t.incomingStore,e.options.outgoingStore=t.outgoingStore):(e.options.incomingStore=null,e.options.outgoingStore=null),e.incomingStore=e.options.incomingStore||new s,e.outgoingStore=e.options.outgoingStore||new s,e.disconnecting=!1,e.disconnected=!1,e._deferredReconnect=null,e._reconnect()};return this.disconnecting&&!this.disconnected?this._deferredReconnect=i:i(),this},A.prototype._reconnect=function(){g("_reconnect: emitting reconnect to client"),this.emit("reconnect"),this.connected?(this.end(()=>{this._setupStream()}),g("client already connected. disconnecting first.")):(g("_reconnect: calling _setupStream"),this._setupStream())},A.prototype._setupReconnect=function(){const t=this;!t.disconnecting&&!t.reconnectTimer&&t.options.reconnectPeriod>0?(this.reconnecting||(g("_setupReconnect :: emit `offline` state"),this.emit("offline"),g("_setupReconnect :: set `reconnecting` to `true`"),this.reconnecting=!0),g("_setupReconnect :: setting reconnectTimer for %d ms",t.options.reconnectPeriod),t.reconnectTimer=setInterval(function(){g("reconnectTimer :: reconnect triggered!"),t._reconnect()},t.options.reconnectPeriod)):g("_setupReconnect :: doing nothing...")},A.prototype._clearReconnect=function(){g("_clearReconnect : clearing reconnect timer"),this.reconnectTimer&&(clearInterval(this.reconnectTimer),this.reconnectTimer=null)},A.prototype._cleanUp=function(t,e){const i=arguments[2];if(e&&(g("_cleanUp :: done callback provided for on stream close"),this.stream.on("close",e)),g("_cleanUp :: forced? %s",t),t)0===this.options.reconnectPeriod&&this.options.clean&&(n=this.outgoing)&&(g("flush: queue exists? %b",!!n),Object.keys(n).forEach(function(t){"function"==typeof n[t].cb&&(n[t].cb(new Error("Connection closed")),delete n[t])})),g("_cleanUp :: (%s) :: destroying stream",this.options.clientId),this.stream.destroy();else{const t=v({cmd:"disconnect"},i);g("_cleanUp :: (%s) :: call _sendPacket with disconnect packet",this.options.clientId),this._sendPacket(t,m.bind(null,this.stream.end.bind(this.stream)))}var n;this.disconnecting||(g("_cleanUp :: client not disconnecting. Clearing and resetting reconnect."),this._clearReconnect(),this._setupReconnect()),null!==this.pingTimer&&(g("_cleanUp :: clearing pingTimer"),this.pingTimer.clear(),this.pingTimer=null),e&&!this.connected&&(g("_cleanUp :: (%s) :: removing stream `done` callback `close` listener",this.options.clientId),this.stream.removeListener("close",e),e())},A.prototype._sendPacket=function(t,e,i){g("_sendPacket :: (%s) ::  start",this.options.clientId),i=i||C,e=e||C;const n=function(t,e){if(5===t.options.protocolVersion&&"publish"===e.cmd){let i;e.properties&&(i=e.properties.topicAlias);const n=e.topic.toString();if(t.topicAliasSend)if(i){if(0!==n.length&&(g("applyTopicAlias :: register topic: %s - alias: %d",n,i),!t.topicAliasSend.put(n,i)))return g("applyTopicAlias :: error out of range. topic: %s - alias: %d",n,i),new Error("Sending Topic Alias out of range")}else 0!==n.length&&(t.options.autoAssignTopicAlias?(i=t.topicAliasSend.getAliasByTopic(n))?(e.topic="",e.properties={...e.properties,topicAlias:i},g("applyTopicAlias :: auto assign(use) topic: %s - alias: %d",n,i)):(i=t.topicAliasSend.getLruAlias(),t.topicAliasSend.put(n,i),e.properties={...e.properties,topicAlias:i},g("applyTopicAlias :: auto assign topic: %s - alias: %d",n,i)):t.options.autoUseTopicAlias&&(i=t.topicAliasSend.getAliasByTopic(n))&&(e.topic="",e.properties={...e.properties,topicAlias:i},g("applyTopicAlias :: auto use topic: %s - alias: %d",n,i)));else if(i)return g("applyTopicAlias :: error out of range. topic: %s - alias: %d",n,i),new Error("Sending Topic Alias out of range")}}(this,t);if(n)e(n);else{if(!this.connected)return"auth"===t.cmd?(this._shiftPingInterval(),void k(this,t,e)):(g("_sendPacket :: client not connected. Storing packet offline."),void this._storePacket(t,e,i));switch(this._shiftPingInterval(),t.cmd){case"publish":break;case"pubrel":return void T(this,t,e,i);default:return void k(this,t,e)}switch(t.qos){case 2:case 1:T(this,t,e,i);break;default:k(this,t,e)}g("_sendPacket :: (%s) ::  end",this.options.clientId)}},A.prototype._storePacket=function(t,e,i){g("_storePacket :: packet: %o",t),g("_storePacket :: cb? %s",!!e),i=i||C;let n=t;if("publish"===n.cmd){const i=b(this,n=f(t));if(i)return e&&e(i)}0===(n.qos||0)&&this.queueQoSZero||"publish"!==n.cmd?this.queue.push({packet:n,cb:e}):n.qos>0?(e=this.outgoing[n.messageId]?this.outgoing[n.messageId].cb:null,this.outgoingStore.put(n,function(t){if(t)return e&&e(t);i()})):e&&e(new Error("No connection to broker"))},A.prototype._setupPingTimer=function(){g("_setupPingTimer :: keepalive %d (seconds)",this.options.keepalive);const t=this;!this.pingTimer&&this.options.keepalive&&(this.pingResp=!0,this.pingTimer=u(function(){t._checkPing()},1e3*this.options.keepalive))},A.prototype._shiftPingInterval=function(){this.pingTimer&&this.options.keepalive&&this.options.reschedulePings&&this.pingTimer.reschedule(1e3*this.options.keepalive)},A.prototype._checkPing=function(){g("_checkPing :: checking ping..."),this.pingResp?(g("_checkPing :: ping response received. Clearing flag and sending `pingreq`"),this.pingResp=!1,this._sendPacket({cmd:"pingreq"})):(g("_checkPing :: calling _cleanUp with force true"),this._cleanUp(!0))},A.prototype._handlePingresp=function(){this.pingResp=!0},A.prototype._handleConnack=function(t){g("_handleConnack");const e=this.options,i=5===e.protocolVersion?t.reasonCode:t.returnCode;if(clearTimeout(this.connackTimer),delete this.topicAliasSend,t.properties){if(t.properties.topicAliasMaximum){if(t.properties.topicAliasMaximum>65535)return void this.emit("error",new Error("topicAliasMaximum from broker is out of range"));t.properties.topicAliasMaximum>0&&(this.topicAliasSend=new r(t.properties.topicAliasMaximum))}t.properties.serverKeepAlive&&e.keepalive&&(e.keepalive=t.properties.serverKeepAlive,this._shiftPingInterval()),t.properties.maximumPacketSize&&(e.properties||(e.properties={}),e.properties.maximumPacketSize=t.properties.maximumPacketSize)}if(0===i)this.reconnecting=!1,this._onConnect(t);else if(i>0){const t=new Error("Connection refused: "+x[i]);t.code=i,this.emit("error",t)}},A.prototype._handleAuth=function(t){const e=this.options.protocolVersion,i=5===e?t.reasonCode:t.returnCode;if(5!==e){const t=new Error("Protocol error: Auth packets are only supported in MQTT 5. Your version:"+e);return t.code=i,void this.emit("error",t)}const n=this;this.handleAuth(t,function(t,e){if(t)n.emit("error",t);else if(24===i)n.reconnecting=!1,n._sendPacket(e);else{const e=new Error("Connection refused: "+x[i]);t.code=i,n.emit("error",e)}})},A.prototype.handleAuth=function(t,e){e()},A.prototype._handlePublish=function(t,e){g("_handlePublish: packet %o",t),e=void 0!==e?e:C;let i=t.topic.toString();const n=t.payload,o=t.qos,s=t.messageId,a=this,r=this.options,l=[0,16,128,131,135,144,145,151,153];if(5===this.options.protocolVersion){let e;if(t.properties&&(e=t.properties.topicAlias),void 0!==e)if(0===i.length){if(!(e>0&&e<=65535))return g("_handlePublish :: topic alias out of range. alias: %d",e),void this.emit("error",new Error("Received Topic Alias is out of range"));{const t=this.topicAliasRecv.getTopicByAlias(e);if(!t)return g("_handlePublish :: unregistered topic alias. alias: %d",e),void this.emit("error",new Error("Received unregistered Topic Alias"));g("_handlePublish :: topic complemented by alias. topic: %s - alias: %d",i=t,e)}}else{if(!this.topicAliasRecv.put(i,e))return g("_handlePublish :: topic alias out of range. alias: %d",e),void this.emit("error",new Error("Received Topic Alias is out of range"));g("_handlePublish :: registered topic: %s - alias: %d",i,e)}}switch(g("_handlePublish: qos %d",o),o){case 2:r.customHandleAcks(i,n,t,function(i,n){return i instanceof Error||(n=i,i=null),i?a.emit("error",i):-1===l.indexOf(n)?a.emit("error",new Error("Wrong reason code for pubrec")):void(n?a._sendPacket({cmd:"pubrec",messageId:s,reasonCode:n},e):a.incomingStore.put(t,function(){a._sendPacket({cmd:"pubrec",messageId:s},e)}))});break;case 1:r.customHandleAcks(i,n,t,function(o,r){return o instanceof Error||(r=o,o=null),o?a.emit("error",o):-1===l.indexOf(r)?a.emit("error",new Error("Wrong reason code for puback")):(r||a.emit("message",i,n,t),void a.handleMessage(t,function(t){if(t)return e&&e(t);a._sendPacket({cmd:"puback",messageId:s,reasonCode:r},e)}))});break;case 0:this.emit("message",i,n,t),this.handleMessage(t,e);break;default:g("_handlePublish: unknown QoS. Doing nothing.")}},A.prototype.handleMessage=function(t,e){e()},A.prototype._handleAck=function(t){const e=t.messageId,i=t.cmd;let n=null;const o=this.outgoing[e]?this.outgoing[e].cb:null,s=this;let a;if(o){switch(g("_handleAck :: packet type",i),i){case"pubcomp":case"puback":{const i=t.reasonCode;i&&i>0&&16!==i&&((a=new Error("Publish error: "+x[i])).code=i,o(a,t)),delete this.outgoing[e],this.outgoingStore.del(t,o),this.messageIdProvider.deallocate(e),this._invokeStoreProcessingQueue();break}case"pubrec":{n={cmd:"pubrel",qos:2,messageId:e};const i=t.reasonCode;i&&i>0&&16!==i?((a=new Error("Publish error: "+x[i])).code=i,o(a,t)):this._sendPacket(n);break}case"suback":delete this.outgoing[e],this.messageIdProvider.deallocate(e);for(let i=0;i<t.granted.length;i++)if(128&t.granted[i]){const t=this.messageIdToTopic[e];t&&t.forEach(function(t){delete s._resubscribeTopics[t]})}this._invokeStoreProcessingQueue(),o(null,t);break;case"unsuback":delete this.outgoing[e],this.messageIdProvider.deallocate(e),this._invokeStoreProcessingQueue(),o(null);break;default:s.emit("error",new Error("unrecognized packet type"))}this.disconnecting&&0===Object.keys(this.outgoing).length&&this.emit("outgoingEmpty")}else g("_handleAck :: Server sent an ack in error. Ignoring.")},A.prototype._handlePubrel=function(t,e){g("handling pubrel packet"),e=void 0!==e?e:C;const i=this,n={cmd:"pubcomp",messageId:t.messageId};i.incomingStore.get(t,function(t,o){t?i._sendPacket(n,e):(i.emit("message",o.topic,o.payload,o),i.handleMessage(o,function(t){if(t)return e(t);i.incomingStore.del(o,C),i._sendPacket(n,e)}))})},A.prototype._handleDisconnect=function(t){this.emit("disconnect",t)},A.prototype._nextId=function(){return this.messageIdProvider.allocate()},A.prototype.getLastMessageId=function(){return this.messageIdProvider.getLastAllocated()},A.prototype._resubscribe=function(){g("_resubscribe");const t=Object.keys(this._resubscribeTopics);if(!this._firstConnection&&(this.options.clean||5===this.options.protocolVersion&&!this.connackPacket.sessionPresent)&&t.length>0)if(this.options.resubscribe)if(5===this.options.protocolVersion){g("_resubscribe: protocolVersion 5");for(let e=0;e<t.length;e++){const i={};i[t[e]]=this._resubscribeTopics[t[e]],i.resubscribe=!0,this.subscribe(i,{properties:i[t[e]].properties})}}else this._resubscribeTopics.resubscribe=!0,this.subscribe(this._resubscribeTopics);else this._resubscribeTopics={};this._firstConnection=!1},A.prototype._onConnect=function(t){if(this.disconnected)return void this.emit("connect",t);const e=this;this.connackPacket=t,this.messageIdProvider.clear(),this._setupPingTimer(),this.connected=!0,function i(){let n=e.outgoingStore.createStream();function o(){e._storeProcessing=!1,e._packetIdsDuringStoreProcessing={}}function s(){n.destroy(),n=null,e._flushStoreProcessingQueue(),o()}e.once("close",s),n.on("error",function(t){o(),e._flushStoreProcessingQueue(),e.removeListener("close",s),e.emit("error",t)}),n.on("end",function(){let n=!0;for(const t in e._packetIdsDuringStoreProcessing)if(!e._packetIdsDuringStoreProcessing[t]){n=!1;break}n?(o(),e.removeListener("close",s),e._invokeAllStoreProcessingQueue(),e.emit("connect",t)):i()}),function t(){if(!n)return;e._storeProcessing=!0;const i=n.read(1);let o;i?e._packetIdsDuringStoreProcessing[i.messageId]?t():e.disconnecting||e.reconnectTimer?n.destroy&&n.destroy():(o=e.outgoing[i.messageId]?e.outgoing[i.messageId].cb:null,e.outgoing[i.messageId]={volatile:!1,cb:function(e,i){o&&o(e,i),t()}},e._packetIdsDuringStoreProcessing[i.messageId]=!0,e.messageIdProvider.register(i.messageId)?e._sendPacket(i):g("messageId: %d has already used.",i.messageId)):n.once("readable",t)}()}()},A.prototype._invokeStoreProcessingQueue=function(){if(this._storeProcessingQueue.length>0){const t=this._storeProcessingQueue[0];if(t&&t.invoke())return this._storeProcessingQueue.shift(),!0}return!1},A.prototype._invokeAllStoreProcessingQueue=function(){for(;this._invokeStoreProcessingQueue(););},A.prototype._flushStoreProcessingQueue=function(){for(const t of this._storeProcessingQueue)t.cbStorePut&&t.cbStorePut(new Error("Connection closed")),t.callback&&t.callback(new Error("Connection closed"));this._storeProcessingQueue.splice(0)},e.exports=A}).call(this)}).call(this,t("_process"),void 0!==i.g?i.g:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"./default-message-id-provider":7,"./store":8,"./topic-alias-recv":9,"./topic-alias-send":10,"./validations":11,_process:50,debug:18,events:22,inherits:24,"mqtt-packet":40,"readable-stream":69,reinterval:70,"rfdc/default":71,xtend:81}],2:[function(t,e,i){"use strict";const{Buffer:n}=t("buffer"),o=t("readable-stream").Transform,s=t("duplexify");let a,r,l,c=!1;e.exports=function(t,e){if(e.hostname=e.hostname||e.host,!e.hostname)throw new Error("Could not determine host. Specify host manually.");const i="MQIsdp"===e.protocolId&&3===e.protocolVersion?"mqttv3.1":"mqtt";!function(t){t.hostname||(t.hostname="localhost"),t.path||(t.path="/"),t.wsOptions||(t.wsOptions={})}(e);const h=function(t,e){const i="alis"===t.protocol?"wss":"ws";let n=i+"://"+t.hostname+t.path;return t.port&&80!==t.port&&443!==t.port&&(n=i+"://"+t.hostname+":"+t.port+t.path),"function"==typeof t.transformWsUrl&&(n=t.transformWsUrl(n,t,e)),n}(e,t);return(a=e.my).connectSocket({url:h,protocols:i}),r=function(){const t=new o;return t._write=function(t,e,i){a.sendSocketMessage({data:t.buffer,success:function(){i()},fail:function(){i(new Error)}})},t._flush=function(t){a.closeSocket({success:function(){t()}})},t}(),l=s.obj(),c||(c=!0,a.onSocketOpen(function(){l.setReadable(r),l.setWritable(r),l.emit("connect")}),a.onSocketMessage(function(t){if("string"==typeof t.data){const e=n.from(t.data,"base64");r.push(e)}else{const e=new FileReader;e.addEventListener("load",function(){let t=e.result;t=t instanceof ArrayBuffer?n.from(t):n.from(t,"utf8"),r.push(t)}),e.readAsArrayBuffer(t.data)}}),a.onSocketClose(function(){l.end(),l.destroy()}),a.onSocketError(function(t){l.destroy(t)})),l}},{buffer:17,duplexify:20,"readable-stream":69}],3:[function(t,e,i){"use strict";const n=t("net"),o=t("debug")("mqttjs:tcp");e.exports=function(t,e){e.port=e.port||1883,e.hostname=e.hostname||e.host||"localhost";const i=e.port,s=e.hostname;return o("port %d and host %s",i,s),n.createConnection(i,s)}},{debug:18,net:16}],4:[function(t,e,i){"use strict";const n=t("tls"),o=t("net"),s=t("debug")("mqttjs:tls");e.exports=function(t,e){e.port=e.port||8883,e.host=e.hostname||e.host||"localhost",0===o.isIP(e.host)&&(e.servername=e.host),e.rejectUnauthorized=!1!==e.rejectUnauthorized,delete e.path,s("port %d host %s rejectUnauthorized %b",e.port,e.host,e.rejectUnauthorized);const i=n.connect(e);function a(n){e.rejectUnauthorized&&t.emit("error",n),i.end()}return i.on("secureConnect",function(){e.rejectUnauthorized&&!i.authorized?i.emit("error",new Error("TLS not authorized")):i.removeListener("error",a)}),i.on("error",a),i}},{debug:18,net:16,tls:16}],5:[function(t,e,n){(function(n){(function(){"use strict";const{Buffer:o}=t("buffer"),s=t("ws"),a=t("debug")("mqttjs:ws"),r=t("duplexify"),l=t("readable-stream").Transform,c=["rejectUnauthorized","ca","cert","key","pfx","passphrase"],h=void 0!==n&&"browser"===n.title||"function"==typeof i;function d(t,e){let i=t.protocol+"://"+t.hostname+":"+t.port+t.path;return"function"==typeof t.transformWsUrl&&(i=t.transformWsUrl(i,t,e)),i}function u(t){const e=t;return t.hostname||(e.hostname="localhost"),t.port||("wss"===t.protocol?e.port=443:e.port=80),t.path||(e.path="/"),t.wsOptions||(e.wsOptions={}),h||"wss"!==t.protocol||c.forEach(function(i){Object.prototype.hasOwnProperty.call(t,i)&&!Object.prototype.hasOwnProperty.call(t.wsOptions,i)&&(e.wsOptions[i]=t[i])}),e}e.exports=h?function(t,e){let i;a("browserStreamBuilder");const n=function(t){const e=u(t);if(e.hostname||(e.hostname=e.host),!e.hostname){if("undefined"==typeof document)throw new Error("Could not determine host. Specify host manually.");const t=new URL(document.URL);e.hostname=t.hostname,e.port||(e.port=t.port)}return void 0===e.objectMode&&(e.objectMode=!(!0===e.binary||void 0===e.binary)),e}(e).browserBufferSize||524288,s=e.browserBufferTimeout||1e3,c=!e.objectMode,h=function(t,e){const i="MQIsdp"===e.protocolId&&3===e.protocolVersion?"mqttv3.1":"mqtt",n=d(e,t),o=new WebSocket(n,[i]);return o.binaryType="arraybuffer",o}(t,e),f=function(t,e){const i=new l({objectModeMode:t.objectMode});return i._write=e,i._flush=function(t){h.close(),t()},i}(e,function t(e,i,a){h.bufferedAmount>n&&setTimeout(t,s,e,i,a),c&&"string"==typeof e&&(e=o.from(e,"utf8"));try{h.send(e)}catch(t){return a(t)}a()});e.objectMode||(f._writev=w),f.on("close",()=>{h.close()});const p=void 0!==h.addEventListener;function v(){i.setReadable(f),i.setWritable(f),i.emit("connect")}function g(){i.end(),i.destroy()}function y(t){i.destroy(t)}function m(t){let e=t.data;e=e instanceof ArrayBuffer?o.from(e):o.from(e,"utf8"),f.push(e)}function w(t,e){const i=new Array(t.length);for(let e=0;e<t.length;e++)"string"==typeof t[e].chunk?i[e]=o.from(t[e],"utf8"):i[e]=t[e].chunk;this._write(o.concat(i),"binary",e)}return h.readyState===h.OPEN?i=f:(i=i=r(void 0,void 0,e),e.objectMode||(i._writev=w),p?h.addEventListener("open",v):h.onopen=v),i.socket=h,p?(h.addEventListener("close",g),h.addEventListener("error",y),h.addEventListener("message",m)):(h.onclose=g,h.onerror=y,h.onmessage=m),i}:function(t,e){a("streamBuilder");const i=u(e),n=d(i,t),o=function(t,e,i){a("createWebSocket"),a("protocol: "+i.protocolId+" "+i.protocolVersion);const n="MQIsdp"===i.protocolId&&3===i.protocolVersion?"mqttv3.1":"mqtt";return a("creating new Websocket for url: "+e+" and protocol: "+n),new s(e,[n],i.wsOptions)}(0,n,i),r=s.createWebSocketStream(o,i.wsOptions);return r.url=n,o.on("close",()=>{r.destroy()}),r}}).call(this)}).call(this,t("_process"))},{_process:50,buffer:17,debug:18,duplexify:20,"readable-stream":69,ws:80}],6:[function(t,e,i){"use strict";const{Buffer:n}=t("buffer"),o=t("readable-stream").Transform,s=t("duplexify");let a,r,l;e.exports=function(t,e){if(e.hostname=e.hostname||e.host,!e.hostname)throw new Error("Could not determine host. Specify host manually.");const i="MQIsdp"===e.protocolId&&3===e.protocolVersion?"mqttv3.1":"mqtt";!function(t){t.hostname||(t.hostname="localhost"),t.path||(t.path="/"),t.wsOptions||(t.wsOptions={})}(e);const c=function(t,e){const i="wxs"===t.protocol?"wss":"ws";let n=i+"://"+t.hostname+t.path;return t.port&&80!==t.port&&443!==t.port&&(n=i+"://"+t.hostname+":"+t.port+t.path),"function"==typeof t.transformWsUrl&&(n=t.transformWsUrl(n,t,e)),n}(e,t);a=wx.connectSocket({url:c,protocols:[i]}),r=function(){const t=new o;return t._write=function(t,e,i){a.send({data:t.buffer,success:function(){i()},fail:function(t){i(new Error(t))}})},t._flush=function(t){a.close({success:function(){t()}})},t}(),(l=s.obj())._destroy=function(t,e){a.close({success:function(){e&&e(t)}})};const h=l.destroy;return l.destroy=function(){l.destroy=h;const t=this;setTimeout(function(){a.close({fail:function(){t._destroy(new Error)}})},0)}.bind(l),a.onOpen(function(){l.setReadable(r),l.setWritable(r),l.emit("connect")}),a.onMessage(function(t){let e=t.data;e=e instanceof ArrayBuffer?n.from(e):n.from(e,"utf8"),r.push(e)}),a.onClose(function(){l.end(),l.destroy()}),a.onError(function(t){l.destroy(new Error(t.errMsg))}),l}},{buffer:17,duplexify:20,"readable-stream":69}],7:[function(t,e,i){"use strict";function n(){if(!(this instanceof n))return new n;this.nextId=Math.max(1,Math.floor(65535*Math.random()))}n.prototype.allocate=function(){const t=this.nextId++;return 65536===this.nextId&&(this.nextId=1),t},n.prototype.getLastAllocated=function(){return 1===this.nextId?65535:this.nextId-1},n.prototype.register=function(t){return!0},n.prototype.deallocate=function(t){},n.prototype.clear=function(){},e.exports=n},{}],8:[function(t,e,i){"use strict";const n=t("xtend"),o=t("readable-stream").Readable,s={objectMode:!0},a={clean:!0};function r(t){if(!(this instanceof r))return new r(t);this.options=t||{},this.options=n(a,t),this._inflights=new Map}r.prototype.put=function(t,e){return this._inflights.set(t.messageId,t),e&&e(),this},r.prototype.createStream=function(){const t=new o(s),e=[];let i=!1,n=0;return this._inflights.forEach(function(t,i){e.push(t)}),t._read=function(){!i&&n<e.length?this.push(e[n++]):this.push(null)},t.destroy=function(){if(i)return;const t=this;i=!0,setTimeout(function(){t.emit("close")},0)},t},r.prototype.del=function(t,e){return(t=this._inflights.get(t.messageId))?(this._inflights.delete(t.messageId),e(null,t)):e&&e(new Error("missing packet")),this},r.prototype.get=function(t,e){return(t=this._inflights.get(t.messageId))?e(null,t):e&&e(new Error("missing packet")),this},r.prototype.close=function(t){this.options.clean&&(this._inflights=null),t&&t()},e.exports=r},{"readable-stream":69,xtend:81}],9:[function(t,e,i){"use strict";function n(t){if(!(this instanceof n))return new n(t);this.aliasToTopic={},this.max=t}n.prototype.put=function(t,e){return!(0===e||e>this.max||(this.aliasToTopic[e]=t,this.length=Object.keys(this.aliasToTopic).length,0))},n.prototype.getTopicByAlias=function(t){return this.aliasToTopic[t]},n.prototype.clear=function(){this.aliasToTopic={}},e.exports=n},{}],10:[function(t,e,i){"use strict";const n=t("lru-cache"),o=t("number-allocator").NumberAllocator;function s(t){if(!(this instanceof s))return new s(t);t>0&&(this.aliasToTopic=new n({max:t}),this.topicToAlias={},this.numberAllocator=new o(1,t),this.max=t,this.length=0)}s.prototype.put=function(t,e){if(0===e||e>this.max)return!1;const i=this.aliasToTopic.get(e);return i&&delete this.topicToAlias[i],this.aliasToTopic.set(e,t),this.topicToAlias[t]=e,this.numberAllocator.use(e),this.length=this.aliasToTopic.length,!0},s.prototype.getTopicByAlias=function(t){return this.aliasToTopic.get(t)},s.prototype.getAliasByTopic=function(t){const e=this.topicToAlias[t];return void 0!==e&&this.aliasToTopic.get(e),e},s.prototype.clear=function(){this.aliasToTopic.reset(),this.topicToAlias={},this.numberAllocator.clear(),this.length=0},s.prototype.getLruAlias=function(){return this.numberAllocator.firstVacant()||this.aliasToTopic.keys()[this.aliasToTopic.length-1]},e.exports=s},{"lru-cache":37,"number-allocator":46}],11:[function(t,e,i){"use strict";function n(t){const e=t.split("/");for(let t=0;t<e.length;t++)if("+"!==e[t]){if("#"===e[t])return t===e.length-1;if(-1!==e[t].indexOf("+")||-1!==e[t].indexOf("#"))return!1}return!0}e.exports={validateTopics:function(t){if(0===t.length)return"empty_topic_list";for(let e=0;e<t.length;e++)if(!n(t[e]))return t[e];return null}}},{}],12:[function(t,e,n){(function(n){(function(){"use strict";const o=t("../client"),s=t("../store"),a=t("url"),r=t("xtend"),l=t("debug")("mqttjs"),c={};function h(t,e){if(l("connecting to an MQTT broker..."),"object"!=typeof t||e||(e=t,t=null),e=e||{},t){const i=a.parse(t,!0);if(null!=i.port&&(i.port=Number(i.port)),null===(e=r(i,e)).protocol)throw new Error("Missing protocol");e.protocol=e.protocol.replace(/:$/,"")}if(function(t){let e;t.auth&&((e=t.auth.match(/^(.+):(.+)$/))?(t.username=e[1],t.password=e[2]):t.username=t.auth)}(e),e.query&&"string"==typeof e.query.clientId&&(e.clientId=e.query.clientId),e.cert&&e.key){if(!e.protocol)throw new Error("Missing secure protocol key");if(-1===["mqtts","wss","wxs","alis"].indexOf(e.protocol))switch(e.protocol){case"mqtt":e.protocol="mqtts";break;case"ws":e.protocol="wss";break;case"wx":e.protocol="wxs";break;case"ali":e.protocol="alis";break;default:throw new Error('Unknown protocol for secure connection: "'+e.protocol+'"!')}}if(!c[e.protocol]){const t=-1!==["mqtts","wss"].indexOf(e.protocol);e.protocol=["mqtt","mqtts","ws","wss","wx","wxs","ali","alis"].filter(function(e,i){return(!t||i%2!=0)&&"function"==typeof c[e]})[0]}if(!1===e.clean&&!e.clientId)throw new Error("Missing clientId for unclean clients");e.protocol&&(e.defaultProtocol=e.protocol);const i=new o(function(t){return e.servers&&(t._reconnectCount&&t._reconnectCount!==e.servers.length||(t._reconnectCount=0),e.host=e.servers[t._reconnectCount].host,e.port=e.servers[t._reconnectCount].port,e.protocol=e.servers[t._reconnectCount].protocol?e.servers[t._reconnectCount].protocol:e.defaultProtocol,e.hostname=e.host,t._reconnectCount++),l("calling streambuilder for",e.protocol),c[e.protocol](t,e)},e);return i.on("error",function(){}),i}void 0!==n&&"browser"!==n.title||"function"!=typeof i?(c.mqtt=t("./tcp"),c.tcp=t("./tcp"),c.ssl=t("./tls"),c.tls=t("./tls"),c.mqtts=t("./tls")):(c.wx=t("./wx"),c.wxs=t("./wx"),c.ali=t("./ali"),c.alis=t("./ali")),c.ws=t("./ws"),c.wss=t("./ws"),e.exports=h,e.exports.connect=h,e.exports.MqttClient=o,e.exports.Store=s}).call(this)}).call(this,t("_process"))},{"../client":1,"../store":8,"./ali":2,"./tcp":3,"./tls":4,"./ws":5,"./wx":6,_process:50,debug:18,url:76,xtend:81}],13:[function(t,e,i){"use strict";i.byteLength=function(t){var e=l(t),i=e[0],n=e[1];return 3*(i+n)/4-n},i.toByteArray=function(t){var e,i,n=l(t),a=n[0],r=n[1],c=new s(function(t,e,i){return 3*(e+i)/4-i}(0,a,r)),h=0,d=r>0?a-4:a;for(i=0;i<d;i+=4)e=o[t.charCodeAt(i)]<<18|o[t.charCodeAt(i+1)]<<12|o[t.charCodeAt(i+2)]<<6|o[t.charCodeAt(i+3)],c[h++]=e>>16&255,c[h++]=e>>8&255,c[h++]=255&e;return 2===r&&(e=o[t.charCodeAt(i)]<<2|o[t.charCodeAt(i+1)]>>4,c[h++]=255&e),1===r&&(e=o[t.charCodeAt(i)]<<10|o[t.charCodeAt(i+1)]<<4|o[t.charCodeAt(i+2)]>>2,c[h++]=e>>8&255,c[h++]=255&e),c},i.fromByteArray=function(t){for(var e,i=t.length,o=i%3,s=[],a=0,r=i-o;a<r;a+=16383)s.push(c(t,a,a+16383>r?r:a+16383));return 1===o?(e=t[i-1],s.push(n[e>>2]+n[e<<4&63]+"==")):2===o&&(e=(t[i-2]<<8)+t[i-1],s.push(n[e>>10]+n[e>>4&63]+n[e<<2&63]+"=")),s.join("")};for(var n=[],o=[],s="undefined"!=typeof Uint8Array?Uint8Array:Array,a="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",r=0;r<64;++r)n[r]=a[r],o[a.charCodeAt(r)]=r;function l(t){var e=t.length;if(e%4>0)throw new Error("Invalid string. Length must be a multiple of 4");var i=t.indexOf("=");return-1===i&&(i=e),[i,i===e?0:4-i%4]}function c(t,e,i){for(var o,s,a=[],r=e;r<i;r+=3)o=(t[r]<<16&16711680)+(t[r+1]<<8&65280)+(255&t[r+2]),a.push(n[(s=o)>>18&63]+n[s>>12&63]+n[s>>6&63]+n[63&s]);return a.join("")}o["-".charCodeAt(0)]=62,o["_".charCodeAt(0)]=63},{}],14:[function(t,e,i){"use strict";const{Buffer:n}=t("buffer"),o=Symbol.for("BufferList");function s(t){if(!(this instanceof s))return new s(t);s._init.call(this,t)}s._init=function(t){Object.defineProperty(this,o,{value:!0}),this._bufs=[],this.length=0,t&&this.append(t)},s.prototype._new=function(t){return new s(t)},s.prototype._offset=function(t){if(0===t)return[0,0];let e=0;for(let i=0;i<this._bufs.length;i++){const n=e+this._bufs[i].length;if(t<n||i===this._bufs.length-1)return[i,t-e];e=n}},s.prototype._reverseOffset=function(t){const e=t[0];let i=t[1];for(let t=0;t<e;t++)i+=this._bufs[t].length;return i},s.prototype.get=function(t){if(t>this.length||t<0)return;const e=this._offset(t);return this._bufs[e[0]][e[1]]},s.prototype.slice=function(t,e){return"number"==typeof t&&t<0&&(t+=this.length),"number"==typeof e&&e<0&&(e+=this.length),this.copy(null,0,t,e)},s.prototype.copy=function(t,e,i,o){if(("number"!=typeof i||i<0)&&(i=0),("number"!=typeof o||o>this.length)&&(o=this.length),i>=this.length)return t||n.alloc(0);if(o<=0)return t||n.alloc(0);const s=!!t,a=this._offset(i),r=o-i;let l=r,c=s&&e||0,h=a[1];if(0===i&&o===this.length){if(!s)return 1===this._bufs.length?this._bufs[0]:n.concat(this._bufs,this.length);for(let e=0;e<this._bufs.length;e++)this._bufs[e].copy(t,c),c+=this._bufs[e].length;return t}if(l<=this._bufs[a[0]].length-h)return s?this._bufs[a[0]].copy(t,e,h,h+l):this._bufs[a[0]].slice(h,h+l);s||(t=n.allocUnsafe(r));for(let e=a[0];e<this._bufs.length;e++){const i=this._bufs[e].length-h;if(!(l>i)){this._bufs[e].copy(t,c,h,h+l),c+=i;break}this._bufs[e].copy(t,c,h),c+=i,l-=i,h&&(h=0)}return t.length>c?t.slice(0,c):t},s.prototype.shallowSlice=function(t,e){if(t=t||0,e="number"!=typeof e?this.length:e,t<0&&(t+=this.length),e<0&&(e+=this.length),t===e)return this._new();const i=this._offset(t),n=this._offset(e),o=this._bufs.slice(i[0],n[0]+1);return 0===n[1]?o.pop():o[o.length-1]=o[o.length-1].slice(0,n[1]),0!==i[1]&&(o[0]=o[0].slice(i[1])),this._new(o)},s.prototype.toString=function(t,e,i){return this.slice(e,i).toString(t)},s.prototype.consume=function(t){if(t=Math.trunc(t),Number.isNaN(t)||t<=0)return this;for(;this._bufs.length;){if(!(t>=this._bufs[0].length)){this._bufs[0]=this._bufs[0].slice(t),this.length-=t;break}t-=this._bufs[0].length,this.length-=this._bufs[0].length,this._bufs.shift()}return this},s.prototype.duplicate=function(){const t=this._new();for(let e=0;e<this._bufs.length;e++)t.append(this._bufs[e]);return t},s.prototype.append=function(t){if(null==t)return this;if(t.buffer)this._appendBuffer(n.from(t.buffer,t.byteOffset,t.byteLength));else if(Array.isArray(t))for(let e=0;e<t.length;e++)this.append(t[e]);else if(this._isBufferList(t))for(let e=0;e<t._bufs.length;e++)this.append(t._bufs[e]);else"number"==typeof t&&(t=t.toString()),this._appendBuffer(n.from(t));return this},s.prototype._appendBuffer=function(t){this._bufs.push(t),this.length+=t.length},s.prototype.indexOf=function(t,e,i){if(void 0===i&&"string"==typeof e&&(i=e,e=void 0),"function"==typeof t||Array.isArray(t))throw new TypeError('The "value" argument must be one of type string, Buffer, BufferList, or Uint8Array.');if("number"==typeof t?t=n.from([t]):"string"==typeof t?t=n.from(t,i):this._isBufferList(t)?t=t.slice():Array.isArray(t.buffer)?t=n.from(t.buffer,t.byteOffset,t.byteLength):n.isBuffer(t)||(t=n.from(t)),e=Number(e||0),isNaN(e)&&(e=0),e<0&&(e=this.length+e),e<0&&(e=0),0===t.length)return e>this.length?this.length:e;const o=this._offset(e);let s=o[0],a=o[1];for(;s<this._bufs.length;s++){const e=this._bufs[s];for(;a<e.length;)if(e.length-a>=t.length){const i=e.indexOf(t,a);if(-1!==i)return this._reverseOffset([s,i]);a=e.length-t.length+1}else{const e=this._reverseOffset([s,a]);if(this._match(e,t))return e;a++}a=0}return-1},s.prototype._match=function(t,e){if(this.length-t<e.length)return!1;for(let i=0;i<e.length;i++)if(this.get(t+i)!==e[i])return!1;return!0},function(){const t={readDoubleBE:8,readDoubleLE:8,readFloatBE:4,readFloatLE:4,readInt32BE:4,readInt32LE:4,readUInt32BE:4,readUInt32LE:4,readInt16BE:2,readInt16LE:2,readUInt16BE:2,readUInt16LE:2,readInt8:1,readUInt8:1,readIntBE:null,readIntLE:null,readUIntBE:null,readUIntLE:null};for(const e in t)!function(e){s.prototype[e]=null===t[e]?function(t,i){return this.slice(t,t+i)[e](0,i)}:function(i=0){return this.slice(i,i+t[e])[e](0)}}(e)}(),s.prototype._isBufferList=function(t){return t instanceof s||s.isBufferList(t)},s.isBufferList=function(t){return null!=t&&t[o]},e.exports=s},{buffer:17}],15:[function(t,e,i){"use strict";const n=t("readable-stream").Duplex,o=t("inherits"),s=t("./BufferList");function a(t){if(!(this instanceof a))return new a(t);if("function"==typeof t){this._callback=t;const e=function(t){this._callback&&(this._callback(t),this._callback=null)}.bind(this);this.on("pipe",function(t){t.on("error",e)}),this.on("unpipe",function(t){t.removeListener("error",e)}),t=null}s._init.call(this,t),n.call(this)}o(a,n),Object.assign(a.prototype,s.prototype),a.prototype._new=function(t){return new a(t)},a.prototype._write=function(t,e,i){this._appendBuffer(t),"function"==typeof i&&i()},a.prototype._read=function(t){if(!this.length)return this.push(null);t=Math.min(t,this.length),this.push(this.slice(0,t)),this.consume(t)},a.prototype.end=function(t){n.prototype.end.call(this,t),this._callback&&(this._callback(null,this.slice()),this._callback=null)},a.prototype._destroy=function(t,e){this._bufs.length=0,this.length=0,e(t)},a.prototype._isBufferList=function(t){return t instanceof a||t instanceof s||a.isBufferList(t)},a.isBufferList=s.isBufferList,e.exports=a,e.exports.BufferListStream=a,e.exports.BufferList=s},{"./BufferList":14,inherits:24,"readable-stream":69}],16:[function(t,e,i){},{}],17:[function(t,e,i){(function(e){(function(){"use strict";var e=t("base64-js"),n=t("ieee754");i.Buffer=a,i.SlowBuffer=function(t){return+t!=t&&(t=0),a.alloc(+t)},i.INSPECT_MAX_BYTES=50;var o=2147483647;function s(t){if(t>o)throw new RangeError('The value "'+t+'" is invalid for option "size"');var e=new Uint8Array(t);return e.__proto__=a.prototype,e}function a(t,e,i){if("number"==typeof t){if("string"==typeof e)throw new TypeError('The "string" argument must be of type string. Received type number');return c(t)}return r(t,e,i)}function r(t,e,i){if("string"==typeof t)return function(t,e){if("string"==typeof e&&""!==e||(e="utf8"),!a.isEncoding(e))throw new TypeError("Unknown encoding: "+e);var i=0|u(t,e),n=s(i),o=n.write(t,e);return o!==i&&(n=n.slice(0,o)),n}(t,e);if(ArrayBuffer.isView(t))return h(t);if(null==t)throw TypeError("The first argument must be one of type string, Buffer, ArrayBuffer, Array, or Array-like Object. Received type "+typeof t);if(z(t,ArrayBuffer)||t&&z(t.buffer,ArrayBuffer))return function(t,e,i){if(e<0||t.byteLength<e)throw new RangeError('"offset" is outside of buffer bounds');if(t.byteLength<e+(i||0))throw new RangeError('"length" is outside of buffer bounds');var n;return(n=void 0===e&&void 0===i?new Uint8Array(t):void 0===i?new Uint8Array(t,e):new Uint8Array(t,e,i)).__proto__=a.prototype,n}(t,e,i);if("number"==typeof t)throw new TypeError('The "value" argument must not be of type number. Received type number');var n=t.valueOf&&t.valueOf();if(null!=n&&n!==t)return a.from(n,e,i);var o=function(t){if(a.isBuffer(t)){var e=0|d(t.length),i=s(e);return 0===i.length||t.copy(i,0,0,e),i}return void 0!==t.length?"number"!=typeof t.length||j(t.length)?s(0):h(t):"Buffer"===t.type&&Array.isArray(t.data)?h(t.data):void 0}(t);if(o)return o;if("undefined"!=typeof Symbol&&null!=Symbol.toPrimitive&&"function"==typeof t[Symbol.toPrimitive])return a.from(t[Symbol.toPrimitive]("string"),e,i);throw new TypeError("The first argument must be one of type string, Buffer, ArrayBuffer, Array, or Array-like Object. Received type "+typeof t)}function l(t){if("number"!=typeof t)throw new TypeError('"size" argument must be of type number');if(t<0)throw new RangeError('The value "'+t+'" is invalid for option "size"')}function c(t){return l(t),s(t<0?0:0|d(t))}function h(t){for(var e=t.length<0?0:0|d(t.length),i=s(e),n=0;n<e;n+=1)i[n]=255&t[n];return i}function d(t){if(t>=o)throw new RangeError("Attempt to allocate Buffer larger than maximum size: 0x"+o.toString(16)+" bytes");return 0|t}function u(t,e){if(a.isBuffer(t))return t.length;if(ArrayBuffer.isView(t)||z(t,ArrayBuffer))return t.byteLength;if("string"!=typeof t)throw new TypeError('The "string" argument must be one of type string, Buffer, or ArrayBuffer. Received type '+typeof t);var i=t.length,n=arguments.length>2&&!0===arguments[2];if(!n&&0===i)return 0;for(var o=!1;;)switch(e){case"ascii":case"latin1":case"binary":return i;case"utf8":case"utf-8":return B(t).length;case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return 2*i;case"hex":return i>>>1;case"base64":return N(t).length;default:if(o)return n?-1:B(t).length;e=(""+e).toLowerCase(),o=!0}}function f(t,e,i){var n=t[e];t[e]=t[i],t[i]=n}function p(t,e,i,n,o){if(0===t.length)return-1;if("string"==typeof i?(n=i,i=0):i>2147483647?i=2147483647:i<-2147483648&&(i=-2147483648),j(i=+i)&&(i=o?0:t.length-1),i<0&&(i=t.length+i),i>=t.length){if(o)return-1;i=t.length-1}else if(i<0){if(!o)return-1;i=0}if("string"==typeof e&&(e=a.from(e,n)),a.isBuffer(e))return 0===e.length?-1:v(t,e,i,n,o);if("number"==typeof e)return e&=255,"function"==typeof Uint8Array.prototype.indexOf?o?Uint8Array.prototype.indexOf.call(t,e,i):Uint8Array.prototype.lastIndexOf.call(t,e,i):v(t,[e],i,n,o);throw new TypeError("val must be string, number or Buffer")}function v(t,e,i,n,o){var s,a=1,r=t.length,l=e.length;if(void 0!==n&&("ucs2"===(n=String(n).toLowerCase())||"ucs-2"===n||"utf16le"===n||"utf-16le"===n)){if(t.length<2||e.length<2)return-1;a=2,r/=2,l/=2,i/=2}function c(t,e){return 1===a?t[e]:t.readUInt16BE(e*a)}if(o){var h=-1;for(s=i;s<r;s++)if(c(t,s)===c(e,-1===h?0:s-h)){if(-1===h&&(h=s),s-h+1===l)return h*a}else-1!==h&&(s-=s-h),h=-1}else for(i+l>r&&(i=r-l),s=i;s>=0;s--){for(var d=!0,u=0;u<l;u++)if(c(t,s+u)!==c(e,u)){d=!1;break}if(d)return s}return-1}function g(t,e,i,n){i=Number(i)||0;var o=t.length-i;n?(n=Number(n))>o&&(n=o):n=o;var s=e.length;n>s/2&&(n=s/2);for(var a=0;a<n;++a){var r=parseInt(e.substr(2*a,2),16);if(j(r))return a;t[i+a]=r}return a}function y(t,e,i,n){return F(B(e,t.length-i),t,i,n)}function m(t,e,i,n){return F(function(t){for(var e=[],i=0;i<t.length;++i)e.push(255&t.charCodeAt(i));return e}(e),t,i,n)}function w(t,e,i,n){return m(t,e,i,n)}function x(t,e,i,n){return F(N(e),t,i,n)}function b(t,e,i,n){return F(function(t,e){for(var i,n,o,s=[],a=0;a<t.length&&!((e-=2)<0);++a)n=(i=t.charCodeAt(a))>>8,o=i%256,s.push(o),s.push(n);return s}(e,t.length-i),t,i,n)}function k(t,i,n){return 0===i&&n===t.length?e.fromByteArray(t):e.fromByteArray(t.slice(i,n))}function T(t,e,i){i=Math.min(t.length,i);for(var n=[],o=e;o<i;){var s,a,r,l,c=t[o],h=null,d=c>239?4:c>223?3:c>191?2:1;if(o+d<=i)switch(d){case 1:c<128&&(h=c);break;case 2:128==(192&(s=t[o+1]))&&(l=(31&c)<<6|63&s)>127&&(h=l);break;case 3:s=t[o+1],a=t[o+2],128==(192&s)&&128==(192&a)&&(l=(15&c)<<12|(63&s)<<6|63&a)>2047&&(l<55296||l>57343)&&(h=l);break;case 4:s=t[o+1],a=t[o+2],r=t[o+3],128==(192&s)&&128==(192&a)&&128==(192&r)&&(l=(15&c)<<18|(63&s)<<12|(63&a)<<6|63&r)>65535&&l<1114112&&(h=l)}null===h?(h=65533,d=1):h>65535&&(h-=65536,n.push(h>>>10&1023|55296),h=56320|1023&h),n.push(h),o+=d}return function(t){var e=t.length;if(e<=C)return String.fromCharCode.apply(String,t);for(var i="",n=0;n<e;)i+=String.fromCharCode.apply(String,t.slice(n,n+=C));return i}(n)}i.kMaxLength=o,a.TYPED_ARRAY_SUPPORT=function(){try{var t=new Uint8Array(1);return t.__proto__={__proto__:Uint8Array.prototype,foo:function(){return 42}},42===t.foo()}catch(t){return!1}}(),a.TYPED_ARRAY_SUPPORT||"undefined"==typeof console||"function"!=typeof console.error||console.error("This browser lacks typed array (Uint8Array) support which is required by `buffer` v5.x. Use `buffer` v4.x if you require old browser support."),Object.defineProperty(a.prototype,"parent",{enumerable:!0,get:function(){if(a.isBuffer(this))return this.buffer}}),Object.defineProperty(a.prototype,"offset",{enumerable:!0,get:function(){if(a.isBuffer(this))return this.byteOffset}}),"undefined"!=typeof Symbol&&null!=Symbol.species&&a[Symbol.species]===a&&Object.defineProperty(a,Symbol.species,{value:null,configurable:!0,enumerable:!1,writable:!1}),a.poolSize=8192,a.from=function(t,e,i){return r(t,e,i)},a.prototype.__proto__=Uint8Array.prototype,a.__proto__=Uint8Array,a.alloc=function(t,e,i){return function(t,e,i){return l(t),t<=0?s(t):void 0!==e?"string"==typeof i?s(t).fill(e,i):s(t).fill(e):s(t)}(t,e,i)},a.allocUnsafe=function(t){return c(t)},a.allocUnsafeSlow=function(t){return c(t)},a.isBuffer=function(t){return null!=t&&!0===t._isBuffer&&t!==a.prototype},a.compare=function(t,e){if(z(t,Uint8Array)&&(t=a.from(t,t.offset,t.byteLength)),z(e,Uint8Array)&&(e=a.from(e,e.offset,e.byteLength)),!a.isBuffer(t)||!a.isBuffer(e))throw new TypeError('The "buf1", "buf2" arguments must be one of type Buffer or Uint8Array');if(t===e)return 0;for(var i=t.length,n=e.length,o=0,s=Math.min(i,n);o<s;++o)if(t[o]!==e[o]){i=t[o],n=e[o];break}return i<n?-1:n<i?1:0},a.isEncoding=function(t){switch(String(t).toLowerCase()){case"hex":case"utf8":case"utf-8":case"ascii":case"latin1":case"binary":case"base64":case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return!0;default:return!1}},a.concat=function(t,e){if(!Array.isArray(t))throw new TypeError('"list" argument must be an Array of Buffers');if(0===t.length)return a.alloc(0);var i;if(void 0===e)for(e=0,i=0;i<t.length;++i)e+=t[i].length;var n=a.allocUnsafe(e),o=0;for(i=0;i<t.length;++i){var s=t[i];if(z(s,Uint8Array)&&(s=a.from(s)),!a.isBuffer(s))throw new TypeError('"list" argument must be an Array of Buffers');s.copy(n,o),o+=s.length}return n},a.byteLength=u,a.prototype._isBuffer=!0,a.prototype.swap16=function(){var t=this.length;if(t%2!=0)throw new RangeError("Buffer size must be a multiple of 16-bits");for(var e=0;e<t;e+=2)f(this,e,e+1);return this},a.prototype.swap32=function(){var t=this.length;if(t%4!=0)throw new RangeError("Buffer size must be a multiple of 32-bits");for(var e=0;e<t;e+=4)f(this,e,e+3),f(this,e+1,e+2);return this},a.prototype.swap64=function(){var t=this.length;if(t%8!=0)throw new RangeError("Buffer size must be a multiple of 64-bits");for(var e=0;e<t;e+=8)f(this,e,e+7),f(this,e+1,e+6),f(this,e+2,e+5),f(this,e+3,e+4);return this},a.prototype.toString=function(){var t=this.length;return 0===t?"":0===arguments.length?T(this,0,t):function(t,e,i){var n=!1;if((void 0===e||e<0)&&(e=0),e>this.length)return"";if((void 0===i||i>this.length)&&(i=this.length),i<=0)return"";if((i>>>=0)<=(e>>>=0))return"";for(t||(t="utf8");;)switch(t){case"hex":return S(this,e,i);case"utf8":case"utf-8":return T(this,e,i);case"ascii":return A(this,e,i);case"latin1":case"binary":return R(this,e,i);case"base64":return k(this,e,i);case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return P(this,e,i);default:if(n)throw new TypeError("Unknown encoding: "+t);t=(t+"").toLowerCase(),n=!0}}.apply(this,arguments)},a.prototype.toLocaleString=a.prototype.toString,a.prototype.equals=function(t){if(!a.isBuffer(t))throw new TypeError("Argument must be a Buffer");return this===t||0===a.compare(this,t)},a.prototype.inspect=function(){var t="",e=i.INSPECT_MAX_BYTES;return t=this.toString("hex",0,e).replace(/(.{2})/g,"$1 ").trim(),this.length>e&&(t+=" ... "),"<Buffer "+t+">"},a.prototype.compare=function(t,e,i,n,o){if(z(t,Uint8Array)&&(t=a.from(t,t.offset,t.byteLength)),!a.isBuffer(t))throw new TypeError('The "target" argument must be one of type Buffer or Uint8Array. Received type '+typeof t);if(void 0===e&&(e=0),void 0===i&&(i=t?t.length:0),void 0===n&&(n=0),void 0===o&&(o=this.length),e<0||i>t.length||n<0||o>this.length)throw new RangeError("out of range index");if(n>=o&&e>=i)return 0;if(n>=o)return-1;if(e>=i)return 1;if(this===t)return 0;for(var s=(o>>>=0)-(n>>>=0),r=(i>>>=0)-(e>>>=0),l=Math.min(s,r),c=this.slice(n,o),h=t.slice(e,i),d=0;d<l;++d)if(c[d]!==h[d]){s=c[d],r=h[d];break}return s<r?-1:r<s?1:0},a.prototype.includes=function(t,e,i){return-1!==this.indexOf(t,e,i)},a.prototype.indexOf=function(t,e,i){return p(this,t,e,i,!0)},a.prototype.lastIndexOf=function(t,e,i){return p(this,t,e,i,!1)},a.prototype.write=function(t,e,i,n){if(void 0===e)n="utf8",i=this.length,e=0;else if(void 0===i&&"string"==typeof e)n=e,i=this.length,e=0;else{if(!isFinite(e))throw new Error("Buffer.write(string, encoding, offset[, length]) is no longer supported");e>>>=0,isFinite(i)?(i>>>=0,void 0===n&&(n="utf8")):(n=i,i=void 0)}var o=this.length-e;if((void 0===i||i>o)&&(i=o),t.length>0&&(i<0||e<0)||e>this.length)throw new RangeError("Attempt to write outside buffer bounds");n||(n="utf8");for(var s=!1;;)switch(n){case"hex":return g(this,t,e,i);case"utf8":case"utf-8":return y(this,t,e,i);case"ascii":return m(this,t,e,i);case"latin1":case"binary":return w(this,t,e,i);case"base64":return x(this,t,e,i);case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return b(this,t,e,i);default:if(s)throw new TypeError("Unknown encoding: "+n);n=(""+n).toLowerCase(),s=!0}},a.prototype.toJSON=function(){return{type:"Buffer",data:Array.prototype.slice.call(this._arr||this,0)}};var C=4096;function A(t,e,i){var n="";i=Math.min(t.length,i);for(var o=e;o<i;++o)n+=String.fromCharCode(127&t[o]);return n}function R(t,e,i){var n="";i=Math.min(t.length,i);for(var o=e;o<i;++o)n+=String.fromCharCode(t[o]);return n}function S(t,e,i){var n=t.length;(!e||e<0)&&(e=0),(!i||i<0||i>n)&&(i=n);for(var o="",s=e;s<i;++s)o+=O(t[s]);return o}function P(t,e,i){for(var n=t.slice(e,i),o="",s=0;s<n.length;s+=2)o+=String.fromCharCode(n[s]+256*n[s+1]);return o}function I(t,e,i){if(t%1!=0||t<0)throw new RangeError("offset is not uint");if(t+e>i)throw new RangeError("Trying to access beyond buffer length")}function E(t,e,i,n,o,s){if(!a.isBuffer(t))throw new TypeError('"buffer" argument must be a Buffer instance');if(e>o||e<s)throw new RangeError('"value" argument is out of bounds');if(i+n>t.length)throw new RangeError("Index out of range")}function _(t,e,i,n,o,s){if(i+n>t.length)throw new RangeError("Index out of range");if(i<0)throw new RangeError("Index out of range")}function M(t,e,i,o,s){return e=+e,i>>>=0,s||_(t,0,i,4),n.write(t,e,i,o,23,4),i+4}function L(t,e,i,o,s){return e=+e,i>>>=0,s||_(t,0,i,8),n.write(t,e,i,o,52,8),i+8}a.prototype.slice=function(t,e){var i=this.length;(t=~~t)<0?(t+=i)<0&&(t=0):t>i&&(t=i),(e=void 0===e?i:~~e)<0?(e+=i)<0&&(e=0):e>i&&(e=i),e<t&&(e=t);var n=this.subarray(t,e);return n.__proto__=a.prototype,n},a.prototype.readUIntLE=function(t,e,i){t>>>=0,e>>>=0,i||I(t,e,this.length);for(var n=this[t],o=1,s=0;++s<e&&(o*=256);)n+=this[t+s]*o;return n},a.prototype.readUIntBE=function(t,e,i){t>>>=0,e>>>=0,i||I(t,e,this.length);for(var n=this[t+--e],o=1;e>0&&(o*=256);)n+=this[t+--e]*o;return n},a.prototype.readUInt8=function(t,e){return t>>>=0,e||I(t,1,this.length),this[t]},a.prototype.readUInt16LE=function(t,e){return t>>>=0,e||I(t,2,this.length),this[t]|this[t+1]<<8},a.prototype.readUInt16BE=function(t,e){return t>>>=0,e||I(t,2,this.length),this[t]<<8|this[t+1]},a.prototype.readUInt32LE=function(t,e){return t>>>=0,e||I(t,4,this.length),(this[t]|this[t+1]<<8|this[t+2]<<16)+16777216*this[t+3]},a.prototype.readUInt32BE=function(t,e){return t>>>=0,e||I(t,4,this.length),16777216*this[t]+(this[t+1]<<16|this[t+2]<<8|this[t+3])},a.prototype.readIntLE=function(t,e,i){t>>>=0,e>>>=0,i||I(t,e,this.length);for(var n=this[t],o=1,s=0;++s<e&&(o*=256);)n+=this[t+s]*o;return n>=(o*=128)&&(n-=Math.pow(2,8*e)),n},a.prototype.readIntBE=function(t,e,i){t>>>=0,e>>>=0,i||I(t,e,this.length);for(var n=e,o=1,s=this[t+--n];n>0&&(o*=256);)s+=this[t+--n]*o;return s>=(o*=128)&&(s-=Math.pow(2,8*e)),s},a.prototype.readInt8=function(t,e){return t>>>=0,e||I(t,1,this.length),128&this[t]?-1*(255-this[t]+1):this[t]},a.prototype.readInt16LE=function(t,e){t>>>=0,e||I(t,2,this.length);var i=this[t]|this[t+1]<<8;return 32768&i?4294901760|i:i},a.prototype.readInt16BE=function(t,e){t>>>=0,e||I(t,2,this.length);var i=this[t+1]|this[t]<<8;return 32768&i?4294901760|i:i},a.prototype.readInt32LE=function(t,e){return t>>>=0,e||I(t,4,this.length),this[t]|this[t+1]<<8|this[t+2]<<16|this[t+3]<<24},a.prototype.readInt32BE=function(t,e){return t>>>=0,e||I(t,4,this.length),this[t]<<24|this[t+1]<<16|this[t+2]<<8|this[t+3]},a.prototype.readFloatLE=function(t,e){return t>>>=0,e||I(t,4,this.length),n.read(this,t,!0,23,4)},a.prototype.readFloatBE=function(t,e){return t>>>=0,e||I(t,4,this.length),n.read(this,t,!1,23,4)},a.prototype.readDoubleLE=function(t,e){return t>>>=0,e||I(t,8,this.length),n.read(this,t,!0,52,8)},a.prototype.readDoubleBE=function(t,e){return t>>>=0,e||I(t,8,this.length),n.read(this,t,!1,52,8)},a.prototype.writeUIntLE=function(t,e,i,n){t=+t,e>>>=0,i>>>=0,n||E(this,t,e,i,Math.pow(2,8*i)-1,0);var o=1,s=0;for(this[e]=255&t;++s<i&&(o*=256);)this[e+s]=t/o&255;return e+i},a.prototype.writeUIntBE=function(t,e,i,n){t=+t,e>>>=0,i>>>=0,n||E(this,t,e,i,Math.pow(2,8*i)-1,0);var o=i-1,s=1;for(this[e+o]=255&t;--o>=0&&(s*=256);)this[e+o]=t/s&255;return e+i},a.prototype.writeUInt8=function(t,e,i){return t=+t,e>>>=0,i||E(this,t,e,1,255,0),this[e]=255&t,e+1},a.prototype.writeUInt16LE=function(t,e,i){return t=+t,e>>>=0,i||E(this,t,e,2,65535,0),this[e]=255&t,this[e+1]=t>>>8,e+2},a.prototype.writeUInt16BE=function(t,e,i){return t=+t,e>>>=0,i||E(this,t,e,2,65535,0),this[e]=t>>>8,this[e+1]=255&t,e+2},a.prototype.writeUInt32LE=function(t,e,i){return t=+t,e>>>=0,i||E(this,t,e,4,4294967295,0),this[e+3]=t>>>24,this[e+2]=t>>>16,this[e+1]=t>>>8,this[e]=255&t,e+4},a.prototype.writeUInt32BE=function(t,e,i){return t=+t,e>>>=0,i||E(this,t,e,4,4294967295,0),this[e]=t>>>24,this[e+1]=t>>>16,this[e+2]=t>>>8,this[e+3]=255&t,e+4},a.prototype.writeIntLE=function(t,e,i,n){if(t=+t,e>>>=0,!n){var o=Math.pow(2,8*i-1);E(this,t,e,i,o-1,-o)}var s=0,a=1,r=0;for(this[e]=255&t;++s<i&&(a*=256);)t<0&&0===r&&0!==this[e+s-1]&&(r=1),this[e+s]=(t/a|0)-r&255;return e+i},a.prototype.writeIntBE=function(t,e,i,n){if(t=+t,e>>>=0,!n){var o=Math.pow(2,8*i-1);E(this,t,e,i,o-1,-o)}var s=i-1,a=1,r=0;for(this[e+s]=255&t;--s>=0&&(a*=256);)t<0&&0===r&&0!==this[e+s+1]&&(r=1),this[e+s]=(t/a|0)-r&255;return e+i},a.prototype.writeInt8=function(t,e,i){return t=+t,e>>>=0,i||E(this,t,e,1,127,-128),t<0&&(t=255+t+1),this[e]=255&t,e+1},a.prototype.writeInt16LE=function(t,e,i){return t=+t,e>>>=0,i||E(this,t,e,2,32767,-32768),this[e]=255&t,this[e+1]=t>>>8,e+2},a.prototype.writeInt16BE=function(t,e,i){return t=+t,e>>>=0,i||E(this,t,e,2,32767,-32768),this[e]=t>>>8,this[e+1]=255&t,e+2},a.prototype.writeInt32LE=function(t,e,i){return t=+t,e>>>=0,i||E(this,t,e,4,2147483647,-2147483648),this[e]=255&t,this[e+1]=t>>>8,this[e+2]=t>>>16,this[e+3]=t>>>24,e+4},a.prototype.writeInt32BE=function(t,e,i){return t=+t,e>>>=0,i||E(this,t,e,4,2147483647,-2147483648),t<0&&(t=4294967295+t+1),this[e]=t>>>24,this[e+1]=t>>>16,this[e+2]=t>>>8,this[e+3]=255&t,e+4},a.prototype.writeFloatLE=function(t,e,i){return M(this,t,e,!0,i)},a.prototype.writeFloatBE=function(t,e,i){return M(this,t,e,!1,i)},a.prototype.writeDoubleLE=function(t,e,i){return L(this,t,e,!0,i)},a.prototype.writeDoubleBE=function(t,e,i){return L(this,t,e,!1,i)},a.prototype.copy=function(t,e,i,n){if(!a.isBuffer(t))throw new TypeError("argument should be a Buffer");if(i||(i=0),n||0===n||(n=this.length),e>=t.length&&(e=t.length),e||(e=0),n>0&&n<i&&(n=i),n===i)return 0;if(0===t.length||0===this.length)return 0;if(e<0)throw new RangeError("targetStart out of bounds");if(i<0||i>=this.length)throw new RangeError("Index out of range");if(n<0)throw new RangeError("sourceEnd out of bounds");n>this.length&&(n=this.length),t.length-e<n-i&&(n=t.length-e+i);var o=n-i;if(this===t&&"function"==typeof Uint8Array.prototype.copyWithin)this.copyWithin(e,i,n);else if(this===t&&i<e&&e<n)for(var s=o-1;s>=0;--s)t[s+e]=this[s+i];else Uint8Array.prototype.set.call(t,this.subarray(i,n),e);return o},a.prototype.fill=function(t,e,i,n){if("string"==typeof t){if("string"==typeof e?(n=e,e=0,i=this.length):"string"==typeof i&&(n=i,i=this.length),void 0!==n&&"string"!=typeof n)throw new TypeError("encoding must be a string");if("string"==typeof n&&!a.isEncoding(n))throw new TypeError("Unknown encoding: "+n);if(1===t.length){var o=t.charCodeAt(0);("utf8"===n&&o<128||"latin1"===n)&&(t=o)}}else"number"==typeof t&&(t&=255);if(e<0||this.length<e||this.length<i)throw new RangeError("Out of range index");if(i<=e)return this;var s;if(e>>>=0,i=void 0===i?this.length:i>>>0,t||(t=0),"number"==typeof t)for(s=e;s<i;++s)this[s]=t;else{var r=a.isBuffer(t)?t:a.from(t,n),l=r.length;if(0===l)throw new TypeError('The value "'+t+'" is invalid for argument "value"');for(s=0;s<i-e;++s)this[s+e]=r[s%l]}return this};var D=/[^+/0-9A-Za-z-_]/g;function O(t){return t<16?"0"+t.toString(16):t.toString(16)}function B(t,e){var i;e=e||1/0;for(var n=t.length,o=null,s=[],a=0;a<n;++a){if((i=t.charCodeAt(a))>55295&&i<57344){if(!o){if(i>56319){(e-=3)>-1&&s.push(239,191,189);continue}if(a+1===n){(e-=3)>-1&&s.push(239,191,189);continue}o=i;continue}if(i<56320){(e-=3)>-1&&s.push(239,191,189),o=i;continue}i=65536+(o-55296<<10|i-56320)}else o&&(e-=3)>-1&&s.push(239,191,189);if(o=null,i<128){if((e-=1)<0)break;s.push(i)}else if(i<2048){if((e-=2)<0)break;s.push(i>>6|192,63&i|128)}else if(i<65536){if((e-=3)<0)break;s.push(i>>12|224,i>>6&63|128,63&i|128)}else{if(!(i<1114112))throw new Error("Invalid code point");if((e-=4)<0)break;s.push(i>>18|240,i>>12&63|128,i>>6&63|128,63&i|128)}}return s}function N(t){return e.toByteArray(function(t){if((t=(t=t.split("=")[0]).trim().replace(D,"")).length<2)return"";for(;t.length%4!=0;)t+="=";return t}(t))}function F(t,e,i,n){for(var o=0;o<n&&!(o+i>=e.length||o>=t.length);++o)e[o+i]=t[o];return o}function z(t,e){return t instanceof e||null!=t&&null!=t.constructor&&null!=t.constructor.name&&t.constructor.name===e.name}function j(t){return t!=t}}).call(this)}).call(this,t("buffer").Buffer)},{"base64-js":13,buffer:17,ieee754:23}],18:[function(t,e,i){(function(n){(function(){i.formatArgs=function(t){if(t[0]=(this.useColors?"%c":"")+this.namespace+(this.useColors?" %c":" ")+t[0]+(this.useColors?"%c ":" ")+"+"+e.exports.humanize(this.diff),!this.useColors)return;const i="color: "+this.color;t.splice(1,0,i,"color: inherit");let n=0,o=0;t[0].replace(/%[a-zA-Z%]/g,t=>{"%%"!==t&&"%c"===t&&(o=++n)}),t.splice(o,0,i)},i.save=function(t){try{t?i.storage.setItem("debug",t):i.storage.removeItem("debug")}catch(t){}},i.load=function(){let t;try{t=i.storage.getItem("debug")}catch(t){}return!t&&void 0!==n&&"env"in n&&(t=n.env.DEBUG),t},i.useColors=function(){return!("undefined"==typeof window||!window.process||"renderer"!==window.process.type&&!window.process.__nwjs)||("undefined"==typeof navigator||!navigator.userAgent||!navigator.userAgent.toLowerCase().match(/(edge|trident)\/(\d+)/))&&("undefined"!=typeof document&&document.documentElement&&document.documentElement.style&&document.documentElement.style.WebkitAppearance||"undefined"!=typeof window&&window.console&&(window.console.firebug||window.console.exception&&window.console.table)||"undefined"!=typeof navigator&&navigator.userAgent&&navigator.userAgent.toLowerCase().match(/firefox\/(\d+)/)&&parseInt(RegExp.$1,10)>=31||"undefined"!=typeof navigator&&navigator.userAgent&&navigator.userAgent.toLowerCase().match(/applewebkit\/(\d+)/))},i.storage=function(){try{return localStorage}catch(t){}}(),i.destroy=(()=>{let t=!1;return()=>{t||(t=!0,console.warn("Instance method `debug.destroy()` is deprecated and no longer does anything. It will be removed in the next major version of `debug`."))}})(),i.colors=["#0000CC","#0000FF","#0033CC","#0033FF","#0066CC","#0066FF","#0099CC","#0099FF","#00CC00","#00CC33","#00CC66","#00CC99","#00CCCC","#00CCFF","#3300CC","#3300FF","#3333CC","#3333FF","#3366CC","#3366FF","#3399CC","#3399FF","#33CC00","#33CC33","#33CC66","#33CC99","#33CCCC","#33CCFF","#6600CC","#6600FF","#6633CC","#6633FF","#66CC00","#66CC33","#9900CC","#9900FF","#9933CC","#9933FF","#99CC00","#99CC33","#CC0000","#CC0033","#CC0066","#CC0099","#CC00CC","#CC00FF","#CC3300","#CC3333","#CC3366","#CC3399","#CC33CC","#CC33FF","#CC6600","#CC6633","#CC9900","#CC9933","#CCCC00","#CCCC33","#FF0000","#FF0033","#FF0066","#FF0099","#FF00CC","#FF00FF","#FF3300","#FF3333","#FF3366","#FF3399","#FF33CC","#FF33FF","#FF6600","#FF6633","#FF9900","#FF9933","#FFCC00","#FFCC33"],i.log=console.debug||console.log||(()=>{}),e.exports=t("./common")(i);const{formatters:o}=e.exports;o.j=function(t){try{return JSON.stringify(t)}catch(t){return"[UnexpectedJSONParseError]: "+t.message}}}).call(this)}).call(this,t("_process"))},{"./common":19,_process:50}],19:[function(t,e,i){e.exports=function(e){function i(t){let e,o,s,a=null;function r(...t){if(!r.enabled)return;const n=r,o=Number(new Date),s=o-(e||o);n.diff=s,n.prev=e,n.curr=o,e=o,t[0]=i.coerce(t[0]),"string"!=typeof t[0]&&t.unshift("%O");let a=0;t[0]=t[0].replace(/%([a-zA-Z%])/g,(e,o)=>{if("%%"===e)return"%";a++;const s=i.formatters[o];if("function"==typeof s){const i=t[a];e=s.call(n,i),t.splice(a,1),a--}return e}),i.formatArgs.call(n,t),(n.log||i.log).apply(n,t)}return r.namespace=t,r.useColors=i.useColors(),r.color=i.selectColor(t),r.extend=n,r.destroy=i.destroy,Object.defineProperty(r,"enabled",{enumerable:!0,configurable:!1,get:()=>null!==a?a:(o!==i.namespaces&&(o=i.namespaces,s=i.enabled(t)),s),set:t=>{a=t}}),"function"==typeof i.init&&i.init(r),r}function n(t,e){const n=i(this.namespace+(void 0===e?":":e)+t);return n.log=this.log,n}function o(t){return t.toString().substring(2,t.toString().length-2).replace(/\.\*\?$/,"*")}return i.debug=i,i.default=i,i.coerce=function(t){return t instanceof Error?t.stack||t.message:t},i.disable=function(){const t=[...i.names.map(o),...i.skips.map(o).map(t=>"-"+t)].join(",");return i.enable(""),t},i.enable=function(t){let e;i.save(t),i.namespaces=t,i.names=[],i.skips=[];const n=("string"==typeof t?t:"").split(/[\s,]+/),o=n.length;for(e=0;e<o;e++)n[e]&&("-"===(t=n[e].replace(/\*/g,".*?"))[0]?i.skips.push(new RegExp("^"+t.substr(1)+"$")):i.names.push(new RegExp("^"+t+"$")))},i.enabled=function(t){if("*"===t[t.length-1])return!0;let e,n;for(e=0,n=i.skips.length;e<n;e++)if(i.skips[e].test(t))return!1;for(e=0,n=i.names.length;e<n;e++)if(i.names[e].test(t))return!0;return!1},i.humanize=t("ms"),i.destroy=function(){console.warn("Instance method `debug.destroy()` is deprecated and no longer does anything. It will be removed in the next major version of `debug`.")},Object.keys(e).forEach(t=>{i[t]=e[t]}),i.names=[],i.skips=[],i.formatters={},i.selectColor=function(t){let e=0;for(let i=0;i<t.length;i++)e=(e<<5)-e+t.charCodeAt(i),e|=0;return i.colors[Math.abs(e)%i.colors.length]},i.enable(i.load()),i}},{ms:45}],20:[function(t,e,i){(function(i,n){(function(){var o=t("readable-stream"),s=t("end-of-stream"),a=t("inherits"),r=t("stream-shift"),l=n.from&&n.from!==Uint8Array.from?n.from([0]):new n([0]),c=function(t,e){t._corked?t.once("uncork",e):e()},h=function(t,e){return function(i){i?function(t,e){t._autoDestroy&&t.destroy(e)}(t,"premature close"===i.message?null:i):e&&!t._ended&&t.end()}},d=function(){},u=function(t,e,i){if(!(this instanceof u))return new u(t,e,i);o.Duplex.call(this,i),this._writable=null,this._readable=null,this._readable2=null,this._autoDestroy=!i||!1!==i.autoDestroy,this._forwardDestroy=!i||!1!==i.destroy,this._forwardEnd=!i||!1!==i.end,this._corked=1,this._ondrain=null,this._drained=!1,this._forwarding=!1,this._unwrite=null,this._unread=null,this._ended=!1,this.destroyed=!1,t&&this.setWritable(t),e&&this.setReadable(e)};a(u,o.Duplex),u.obj=function(t,e,i){return i||(i={}),i.objectMode=!0,i.highWaterMark=16,new u(t,e,i)},u.prototype.cork=function(){1==++this._corked&&this.emit("cork")},u.prototype.uncork=function(){this._corked&&0==--this._corked&&this.emit("uncork")},u.prototype.setWritable=function(t){if(this._unwrite&&this._unwrite(),this.destroyed)t&&t.destroy&&t.destroy();else if(null!==t&&!1!==t){var e=this,n=s(t,{writable:!0,readable:!1},h(this,this._forwardEnd)),o=function(){var t=e._ondrain;e._ondrain=null,t&&t()};this._unwrite&&i.nextTick(o),this._writable=t,this._writable.on("drain",o),this._unwrite=function(){e._writable.removeListener("drain",o),n()},this.uncork()}else this.end()},u.prototype.setReadable=function(t){if(this._unread&&this._unread(),this.destroyed)t&&t.destroy&&t.destroy();else{if(null===t||!1===t)return this.push(null),void this.resume();var e,i=this,n=s(t,{writable:!1,readable:!0},h(this)),a=function(){i._forward()},r=function(){i.push(null)};this._drained=!0,this._readable=t,this._readable2=t._readableState?t:(e=t,new o.Readable({objectMode:!0,highWaterMark:16}).wrap(e)),this._readable2.on("readable",a),this._readable2.on("end",r),this._unread=function(){i._readable2.removeListener("readable",a),i._readable2.removeListener("end",r),n()},this._forward()}},u.prototype._read=function(){this._drained=!0,this._forward()},u.prototype._forward=function(){if(!this._forwarding&&this._readable2&&this._drained){var t;for(this._forwarding=!0;this._drained&&null!==(t=r(this._readable2));)this.destroyed||(this._drained=this.push(t));this._forwarding=!1}},u.prototype.destroy=function(t,e){if(e||(e=d),this.destroyed)return e(null);this.destroyed=!0;var n=this;i.nextTick(function(){n._destroy(t),e(null)})},u.prototype._destroy=function(t){if(t){var e=this._ondrain;this._ondrain=null,e?e(t):this.emit("error",t)}this._forwardDestroy&&(this._readable&&this._readable.destroy&&this._readable.destroy(),this._writable&&this._writable.destroy&&this._writable.destroy()),this.emit("close")},u.prototype._write=function(t,e,i){if(!this.destroyed)return this._corked?c(this,this._write.bind(this,t,e,i)):t===l?this._finish(i):this._writable?void(!1===this._writable.write(t)?this._ondrain=i:this.destroyed||i()):i()},u.prototype._finish=function(t){var e=this;this.emit("preend"),c(this,function(){var i,n;n=function(){!1===e._writableState.prefinished&&(e._writableState.prefinished=!0),e.emit("prefinish"),c(e,t)},(i=e._forwardEnd&&e._writable)?i._writableState&&i._writableState.finished?n():i._writableState?i.end(n):(i.end(),n()):n()})},u.prototype.end=function(t,e,i){return"function"==typeof t?this.end(null,null,t):"function"==typeof e?this.end(t,null,e):(this._ended=!0,t&&this.write(t),this._writableState.ending||this._writableState.destroyed||this.write(l),o.Writable.prototype.end.call(this,i))},e.exports=u}).call(this)}).call(this,t("_process"),t("buffer").Buffer)},{_process:50,buffer:17,"end-of-stream":21,inherits:24,"readable-stream":69,"stream-shift":74}],21:[function(t,e,i){(function(i){(function(){var n=t("once"),o=function(){},s=function(t,e,a){if("function"==typeof e)return s(t,null,e);e||(e={}),a=n(a||o);var r=t._writableState,l=t._readableState,c=e.readable||!1!==e.readable&&t.readable,h=e.writable||!1!==e.writable&&t.writable,d=!1,u=function(){t.writable||f()},f=function(){h=!1,c||a.call(t)},p=function(){c=!1,h||a.call(t)},v=function(e){a.call(t,e?new Error("exited with error code: "+e):null)},g=function(e){a.call(t,e)},y=function(){i.nextTick(m)},m=function(){if(!d)return(!c||l&&l.ended&&!l.destroyed)&&(!h||r&&r.ended&&!r.destroyed)?void 0:a.call(t,new Error("premature close"))},w=function(){t.req.on("finish",f)};return function(t){return t.setHeader&&"function"==typeof t.abort}(t)?(t.on("complete",f),t.on("abort",y),t.req?w():t.on("request",w)):h&&!r&&(t.on("end",u),t.on("close",u)),function(t){return t.stdio&&Array.isArray(t.stdio)&&3===t.stdio.length}(t)&&t.on("exit",v),t.on("end",p),t.on("finish",f),!1!==e.error&&t.on("error",g),t.on("close",y),function(){d=!0,t.removeListener("complete",f),t.removeListener("abort",y),t.removeListener("request",w),t.req&&t.req.removeListener("finish",f),t.removeListener("end",u),t.removeListener("close",u),t.removeListener("finish",f),t.removeListener("exit",v),t.removeListener("end",p),t.removeListener("error",g),t.removeListener("close",y)}};e.exports=s}).call(this)}).call(this,t("_process"))},{_process:50,once:48}],22:[function(t,e,i){var n=Object.create||function(t){var e=function(){};return e.prototype=t,new e},o=Object.keys||function(t){var e=[];for(var i in t)Object.prototype.hasOwnProperty.call(t,i)&&e.push(i);return i},s=Function.prototype.bind||function(t){var e=this;return function(){return e.apply(t,arguments)}};function a(){this._events&&Object.prototype.hasOwnProperty.call(this,"_events")||(this._events=n(null),this._eventsCount=0),this._maxListeners=this._maxListeners||void 0}e.exports=a,a.EventEmitter=a,a.prototype._events=void 0,a.prototype._maxListeners=void 0;var r,l=10;try{var c={};Object.defineProperty&&Object.defineProperty(c,"x",{value:0}),r=0===c.x}catch(t){r=!1}function h(t){return void 0===t._maxListeners?a.defaultMaxListeners:t._maxListeners}function d(t,e,i,o){var s,a,r;if("function"!=typeof i)throw new TypeError('"listener" argument must be a function');if((a=t._events)?(a.newListener&&(t.emit("newListener",e,i.listener?i.listener:i),a=t._events),r=a[e]):(a=t._events=n(null),t._eventsCount=0),r){if("function"==typeof r?r=a[e]=o?[i,r]:[r,i]:o?r.unshift(i):r.push(i),!r.warned&&(s=h(t))&&s>0&&r.length>s){r.warned=!0;var l=new Error("Possible EventEmitter memory leak detected. "+r.length+' "'+String(e)+'" listeners added. Use emitter.setMaxListeners() to increase limit.');l.name="MaxListenersExceededWarning",l.emitter=t,l.type=e,l.count=r.length,"object"==typeof console&&console.warn&&console.warn("%s: %s",l.name,l.message)}}else r=a[e]=i,++t._eventsCount;return t}function u(){if(!this.fired)switch(this.target.removeListener(this.type,this.wrapFn),this.fired=!0,arguments.length){case 0:return this.listener.call(this.target);case 1:return this.listener.call(this.target,arguments[0]);case 2:return this.listener.call(this.target,arguments[0],arguments[1]);case 3:return this.listener.call(this.target,arguments[0],arguments[1],arguments[2]);default:for(var t=new Array(arguments.length),e=0;e<t.length;++e)t[e]=arguments[e];this.listener.apply(this.target,t)}}function f(t,e,i){var n={fired:!1,wrapFn:void 0,target:t,type:e,listener:i},o=s.call(u,n);return o.listener=i,n.wrapFn=o,o}function p(t,e,i){var n=t._events;if(!n)return[];var o=n[e];return o?"function"==typeof o?i?[o.listener||o]:[o]:i?function(t){for(var e=new Array(t.length),i=0;i<e.length;++i)e[i]=t[i].listener||t[i];return e}(o):g(o,o.length):[]}function v(t){var e=this._events;if(e){var i=e[t];if("function"==typeof i)return 1;if(i)return i.length}return 0}function g(t,e){for(var i=new Array(e),n=0;n<e;++n)i[n]=t[n];return i}r?Object.defineProperty(a,"defaultMaxListeners",{enumerable:!0,get:function(){return l},set:function(t){if("number"!=typeof t||t<0||t!=t)throw new TypeError('"defaultMaxListeners" must be a positive number');l=t}}):a.defaultMaxListeners=l,a.prototype.setMaxListeners=function(t){if("number"!=typeof t||t<0||isNaN(t))throw new TypeError('"n" argument must be a positive number');return this._maxListeners=t,this},a.prototype.getMaxListeners=function(){return h(this)},a.prototype.emit=function(t){var e,i,n,o,s,a,r="error"===t;if(a=this._events)r=r&&null==a.error;else if(!r)return!1;if(r){if(arguments.length>1&&(e=arguments[1]),e instanceof Error)throw e;var l=new Error('Unhandled "error" event. ('+e+")");throw l.context=e,l}if(!(i=a[t]))return!1;var c="function"==typeof i;switch(n=arguments.length){case 1:!function(t,e,i){if(e)t.call(i);else for(var n=t.length,o=g(t,n),s=0;s<n;++s)o[s].call(i)}(i,c,this);break;case 2:!function(t,e,i,n){if(e)t.call(i,n);else for(var o=t.length,s=g(t,o),a=0;a<o;++a)s[a].call(i,n)}(i,c,this,arguments[1]);break;case 3:!function(t,e,i,n,o){if(e)t.call(i,n,o);else for(var s=t.length,a=g(t,s),r=0;r<s;++r)a[r].call(i,n,o)}(i,c,this,arguments[1],arguments[2]);break;case 4:!function(t,e,i,n,o,s){if(e)t.call(i,n,o,s);else for(var a=t.length,r=g(t,a),l=0;l<a;++l)r[l].call(i,n,o,s)}(i,c,this,arguments[1],arguments[2],arguments[3]);break;default:for(o=new Array(n-1),s=1;s<n;s++)o[s-1]=arguments[s];!function(t,e,i,n){if(e)t.apply(i,n);else for(var o=t.length,s=g(t,o),a=0;a<o;++a)s[a].apply(i,n)}(i,c,this,o)}return!0},a.prototype.addListener=function(t,e){return d(this,t,e,!1)},a.prototype.on=a.prototype.addListener,a.prototype.prependListener=function(t,e){return d(this,t,e,!0)},a.prototype.once=function(t,e){if("function"!=typeof e)throw new TypeError('"listener" argument must be a function');return this.on(t,f(this,t,e)),this},a.prototype.prependOnceListener=function(t,e){if("function"!=typeof e)throw new TypeError('"listener" argument must be a function');return this.prependListener(t,f(this,t,e)),this},a.prototype.removeListener=function(t,e){var i,o,s,a,r;if("function"!=typeof e)throw new TypeError('"listener" argument must be a function');if(!(o=this._events))return this;if(!(i=o[t]))return this;if(i===e||i.listener===e)0==--this._eventsCount?this._events=n(null):(delete o[t],o.removeListener&&this.emit("removeListener",t,i.listener||e));else if("function"!=typeof i){for(s=-1,a=i.length-1;a>=0;a--)if(i[a]===e||i[a].listener===e){r=i[a].listener,s=a;break}if(s<0)return this;0===s?i.shift():function(t,e){for(var i=e,n=i+1,o=t.length;n<o;i+=1,n+=1)t[i]=t[n];t.pop()}(i,s),1===i.length&&(o[t]=i[0]),o.removeListener&&this.emit("removeListener",t,r||e)}return this},a.prototype.removeAllListeners=function(t){var e,i,s;if(!(i=this._events))return this;if(!i.removeListener)return 0===arguments.length?(this._events=n(null),this._eventsCount=0):i[t]&&(0==--this._eventsCount?this._events=n(null):delete i[t]),this;if(0===arguments.length){var a,r=o(i);for(s=0;s<r.length;++s)"removeListener"!==(a=r[s])&&this.removeAllListeners(a);return this.removeAllListeners("removeListener"),this._events=n(null),this._eventsCount=0,this}if("function"==typeof(e=i[t]))this.removeListener(t,e);else if(e)for(s=e.length-1;s>=0;s--)this.removeListener(t,e[s]);return this},a.prototype.listeners=function(t){return p(this,t,!0)},a.prototype.rawListeners=function(t){return p(this,t,!1)},a.listenerCount=function(t,e){return"function"==typeof t.listenerCount?t.listenerCount(e):v.call(t,e)},a.prototype.listenerCount=v,a.prototype.eventNames=function(){return this._eventsCount>0?Reflect.ownKeys(this._events):[]}},{}],23:[function(t,e,i){i.read=function(t,e,i,n,o){var s,a,r=8*o-n-1,l=(1<<r)-1,c=l>>1,h=-7,d=i?o-1:0,u=i?-1:1,f=t[e+d];for(d+=u,s=f&(1<<-h)-1,f>>=-h,h+=r;h>0;s=256*s+t[e+d],d+=u,h-=8);for(a=s&(1<<-h)-1,s>>=-h,h+=n;h>0;a=256*a+t[e+d],d+=u,h-=8);if(0===s)s=1-c;else{if(s===l)return a?NaN:1/0*(f?-1:1);a+=Math.pow(2,n),s-=c}return(f?-1:1)*a*Math.pow(2,s-n)},i.write=function(t,e,i,n,o,s){var a,r,l,c=8*s-o-1,h=(1<<c)-1,d=h>>1,u=23===o?Math.pow(2,-24)-Math.pow(2,-77):0,f=n?0:s-1,p=n?1:-1,v=e<0||0===e&&1/e<0?1:0;for(e=Math.abs(e),isNaN(e)||e===1/0?(r=isNaN(e)?1:0,a=h):(a=Math.floor(Math.log(e)/Math.LN2),e*(l=Math.pow(2,-a))<1&&(a--,l*=2),(e+=a+d>=1?u/l:u*Math.pow(2,1-d))*l>=2&&(a++,l/=2),a+d>=h?(r=0,a=h):a+d>=1?(r=(e*l-1)*Math.pow(2,o),a+=d):(r=e*Math.pow(2,d-1)*Math.pow(2,o),a=0));o>=8;t[i+f]=255&r,f+=p,r/=256,o-=8);for(a=a<<o|r,c+=o;c>0;t[i+f]=255&a,f+=p,a/=256,c-=8);t[i+f-p]|=128*v}},{}],24:[function(t,e,i){"function"==typeof Object.create?e.exports=function(t,e){e&&(t.super_=e,t.prototype=Object.create(e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}))}:e.exports=function(t,e){if(e){t.super_=e;var i=function(){};i.prototype=e.prototype,t.prototype=new i,t.prototype.constructor=t}}},{}],25:[function(t,e,i){"use strict";Object.defineProperty(i,"__esModule",{value:!0});var n=function(){function t(t,e){this.color=!0,this.key=void 0,this.value=void 0,this.parent=void 0,this.brother=void 0,this.leftChild=void 0,this.rightChild=void 0,this.key=t,this.value=e}return t.prototype.rotateLeft=function(){var t=this.parent,e=this.brother,i=this.leftChild,n=this.rightChild;if(!n)throw new Error("unknown error");var o=n.leftChild,s=n.rightChild;return t&&(t.leftChild===this?t.leftChild=n:t.rightChild===this&&(t.rightChild=n)),n.parent=t,n.brother=e,n.leftChild=this,n.rightChild=s,e&&(e.brother=n),this.parent=n,this.brother=s,this.leftChild=i,this.rightChild=o,s&&(s.parent=n,s.brother=this),i&&(i.parent=this,i.brother=o),o&&(o.parent=this,o.brother=i),n},t.prototype.rotateRight=function(){var t=this.parent,e=this.brother,i=this.leftChild;if(!i)throw new Error("unknown error");var n=this.rightChild,o=i.leftChild,s=i.rightChild;return t&&(t.leftChild===this?t.leftChild=i:t.rightChild===this&&(t.rightChild=i)),i.parent=t,i.brother=e,i.leftChild=o,i.rightChild=this,e&&(e.brother=i),o&&(o.parent=i,o.brother=this),this.parent=i,this.brother=o,this.leftChild=s,this.rightChild=n,s&&(s.parent=this,s.brother=n),n&&(n.parent=this,n.brother=s),i},t.prototype.remove=function(){if(this.leftChild||this.rightChild)throw new Error("can only remove leaf node");this.parent&&(this===this.parent.leftChild?this.parent.leftChild=void 0:this===this.parent.rightChild&&(this.parent.rightChild=void 0)),this.brother&&(this.brother.brother=void 0),this.key=void 0,this.value=void 0,this.parent=void 0,this.brother=void 0},t.TreeNodeColorType={red:!0,black:!1},t}();Object.freeze(n),i.default=n},{}],26:[function(t,e,i){"use strict";var n=this&&this.__generator||function(t,e){var i,n,o,s,a={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]};return s={next:r(0),throw:r(1),return:r(2)},"function"==typeof Symbol&&(s[Symbol.iterator]=function(){return this}),s;function r(s){return function(r){return function(s){if(i)throw new TypeError("Generator is already executing.");for(;a;)try{if(i=1,n&&(o=2&s[0]?n.return:s[0]?n.throw||((o=n.return)&&o.call(n),0):n.next)&&!(o=o.call(n,s[1])).done)return o;switch(n=0,o&&(s=[2&s[0],o.value]),s[0]){case 0:case 1:o=s;break;case 4:return a.label++,{value:s[1],done:!1};case 5:a.label++,n=s[1],s=[0];continue;case 7:s=a.ops.pop(),a.trys.pop();continue;default:if(!(o=(o=a.trys).length>0&&o[o.length-1])&&(6===s[0]||2===s[0])){a=0;continue}if(3===s[0]&&(!o||s[1]>o[0]&&s[1]<o[3])){a.label=s[1];break}if(6===s[0]&&a.label<o[1]){a.label=o[1],o=s;break}if(o&&a.label<o[2]){a.label=o[2],a.ops.push(s);break}o[2]&&a.ops.pop(),a.trys.pop();continue}s=e.call(t,a)}catch(t){s=[6,t],n=0}finally{i=o=0}if(5&s[0])throw s[1];return{value:s[0]?s[1]:void 0,done:!0}}([s,r])}}};function o(t){var e=this;void 0===t&&(t=[]);var i=[],s=0,a=0,r=0,l=0,c=0,h=0;this.size=function(){return h},this.empty=function(){return 0===h},this.clear=function(){s=r=a=l=c=h=0,u.call(this,o.bucketSize),h=0},this.front=function(){return i[s][a]},this.back=function(){return i[r][l]},this.forEach=function(t){if(!this.empty()){var e=0;if(s!==r){for(c=a;c<o.bucketSize;++c)t(i[s][c],e++);for(c=s+1;c<r;++c)for(var n=0;n<o.bucketSize;++n)t(i[c][n],e++);for(c=0;c<=l;++c)t(i[r][c],e++)}else for(var c=a;c<=l;++c)t(i[s][c],e++)}};var d=function(t){var e=s*o.bucketSize+a,i=e+t,n=r*o.bucketSize+l;if(i<e||i>n)throw new Error("pos should more than 0 and less than queue's size");return{curNodeBucketIndex:Math.floor(i/o.bucketSize),curNodePointerIndex:i%o.bucketSize}};this.getElementByPos=function(t){var e=d(t),n=e.curNodeBucketIndex,o=e.curNodePointerIndex;return i[n][o]},this.eraseElementByPos=function(t){var e=this;if(t<0||t>h)throw new Error("pos should more than 0 and less than queue's size");if(0===t)this.popFront();else if(t===this.size())this.popBack();else{for(var i=[],n=t+1;n<h;++n)i.push(this.getElementByPos(n));this.cut(t),this.popBack(),i.forEach(function(t){return e.pushBack(t)})}},this.eraseElementByValue=function(t){if(!this.empty()){var e=[];this.forEach(function(i){i!==t&&e.push(i)});for(var i=e.length,n=0;n<i;++n)this.setElementByPos(n,e[n]);this.cut(i-1)}};var u=function(t){for(var e=[],n=t*o.sigma,d=Math.max(Math.ceil(n/o.bucketSize),2),u=0;u<d;++u)e.push(new Array(o.bucketSize));var f=Math.ceil(t/o.bucketSize),p=Math.floor(d/2)-Math.floor(f/2),v=p,g=0;if(this.size())for(u=0;u<f;++u){for(var y=0;y<o.bucketSize;++y)if(e[p+u][y]=this.front(),this.popFront(),this.empty()){v=p+u,g=y;break}if(this.empty())break}i=e,s=p,a=0,r=v,l=g,c=d,h=t};this.pushBack=function(t){this.empty()||(r===c-1&&l===o.bucketSize-1&&u.call(this,this.size()),l<o.bucketSize-1?++l:r<c-1&&(++r,l=0)),++h,i[r][l]=t},this.popBack=function(){this.empty()||(1!==this.size()&&(l>0?--l:s<r&&(--r,l=o.bucketSize-1)),h>0&&--h)},this.setElementByPos=function(t,e){var n=d(t),o=n.curNodeBucketIndex,s=n.curNodePointerIndex;i[o][s]=e},this.insert=function(t,e,i){var n=this;if(void 0===i&&(i=1),0===t)for(;i--;)this.pushFront(e);else if(t===this.size())for(;i--;)this.pushBack(e);else{for(var o=[],s=t;s<h;++s)o.push(this.getElementByPos(s));for(this.cut(t-1),s=0;s<i;++s)this.pushBack(e);o.forEach(function(t){return n.pushBack(t)})}},this.find=function(t){if(s===r){for(var e=a;e<=l;++e)if(i[s][e]===t)return!0;return!1}for(e=a;e<o.bucketSize;++e)if(i[s][e]===t)return!0;for(e=s+1;e<r;++e)for(var n=0;n<o.bucketSize;++n)if(i[e][n]===t)return!0;for(e=0;e<=l;++e)if(i[r][e]===t)return!0;return!1},this.reverse=function(){for(var t=0,e=h-1;t<e;){var i=this.getElementByPos(t);this.setElementByPos(t,this.getElementByPos(e)),this.setElementByPos(e,i),++t,--e}},this.unique=function(){if(!this.empty()){var t=[],e=this.front();this.forEach(function(i,n){0!==n&&i===e||(t.push(i),e=i)});for(var i=0;i<h;++i)this.setElementByPos(i,t[i]);this.cut(t.length-1)}},this.sort=function(t){var e=[];this.forEach(function(t){e.push(t)}),e.sort(t);for(var i=0;i<h;++i)this.setElementByPos(i,e[i])},this.pushFront=function(t){this.empty()||(0===s&&0===a&&u.call(this,this.size()),a>0?--a:s>0&&(--s,a=o.bucketSize-1)),++h,i[s][a]=t},this.popFront=function(){this.empty()||(1!==this.size()&&(a<o.bucketSize-1?++a:s<r&&(++s,a=0)),h>0&&--h)},this.shrinkToFit=function(){var t=this,e=[];this.forEach(function(t){e.push(t)});var n=e.length;i=[];for(var s=Math.ceil(n/o.bucketSize),a=0;a<s;++a)i.push(new Array(o.bucketSize));this.clear(),e.forEach(function(e){return t.pushBack(e)})},this.cut=function(t){if(t<0)this.clear();else{var e=d(t),i=e.curNodeBucketIndex,n=e.curNodePointerIndex;r=i,l=n,h=t+1}},this[Symbol.iterator]=function(){return function(){var t,e;return n(this,function(n){switch(n.label){case 0:if(0===h)return[2];if(s!==r)return[3,5];e=a,n.label=1;case 1:return e<=l?[4,i[s][e]]:[3,4];case 2:n.sent(),n.label=3;case 3:return++e,[3,1];case 4:return[2];case 5:e=a,n.label=6;case 6:return e<o.bucketSize?[4,i[s][e]]:[3,9];case 7:n.sent(),n.label=8;case 8:return++e,[3,6];case 9:e=s+1,n.label=10;case 10:if(!(e<r))return[3,15];t=0,n.label=11;case 11:return t<o.bucketSize?[4,i[e][t]]:[3,14];case 12:n.sent(),n.label=13;case 13:return++t,[3,11];case 14:return++e,[3,10];case 15:e=0,n.label=16;case 16:return e<=l?[4,i[r][e]]:[3,19];case 17:n.sent(),n.label=18;case 18:return++e,[3,16];case 19:return[2]}})}()},function(){var n=o.bucketSize;t.size?n=t.size():t.length&&(n=t.length);var a=n*o.sigma;c=Math.ceil(a/o.bucketSize),c=Math.max(c,3);for(var l=0;l<c;++l)i.push(new Array(o.bucketSize));var h=Math.ceil(n/o.bucketSize);s=Math.floor(c/2)-Math.floor(h/2),r=s,t.forEach(function(t){return e.pushBack(t)})}(),Object.freeze(this)}Object.defineProperty(i,"__esModule",{value:!0}),o.sigma=3,o.bucketSize=5e3,Object.freeze(o),i.default=o},{}],27:[function(t,e,i){"use strict";var n=this&&this.__generator||function(t,e){var i,n,o,s,a={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]};return s={next:r(0),throw:r(1),return:r(2)},"function"==typeof Symbol&&(s[Symbol.iterator]=function(){return this}),s;function r(s){return function(r){return function(s){if(i)throw new TypeError("Generator is already executing.");for(;a;)try{if(i=1,n&&(o=2&s[0]?n.return:s[0]?n.throw||((o=n.return)&&o.call(n),0):n.next)&&!(o=o.call(n,s[1])).done)return o;switch(n=0,o&&(s=[2&s[0],o.value]),s[0]){case 0:case 1:o=s;break;case 4:return a.label++,{value:s[1],done:!1};case 5:a.label++,n=s[1],s=[0];continue;case 7:s=a.ops.pop(),a.trys.pop();continue;default:if(!(o=(o=a.trys).length>0&&o[o.length-1])&&(6===s[0]||2===s[0])){a=0;continue}if(3===s[0]&&(!o||s[1]>o[0]&&s[1]<o[3])){a.label=s[1];break}if(6===s[0]&&a.label<o[1]){a.label=o[1],o=s;break}if(o&&a.label<o[2]){a.label=o[2],a.ops.push(s);break}o[2]&&a.ops.pop(),a.trys.pop();continue}s=e.call(t,a)}catch(t){s=[6,t],n=0}finally{i=o=0}if(5&s[0])throw s[1];return{value:s[0]?s[1]:void 0,done:!0}}([s,r])}}},o=this&&this.__values||function(t){var e="function"==typeof Symbol&&Symbol.iterator,i=e&&t[e],n=0;if(i)return i.call(t);if(t&&"number"==typeof t.length)return{next:function(){return t&&n>=t.length&&(t=void 0),{value:t&&t[n++],done:!t}}};throw new TypeError(e?"Object is not iterable.":"Symbol.iterator is not defined.")};Object.defineProperty(i,"__esModule",{value:!0});var s=t("../LinkList/LinkList"),a=t("../Map/Map");function r(t,e,i){var l=this;if(void 0===t&&(t=[]),void 0===e&&(e=r.initSize),i=i||function(t){var e,i,n=0,s="";if("number"==typeof t)n=((n=Math.floor(t))<<5)-n,n&=n;else{s="string"!=typeof t?JSON.stringify(t):t;try{for(var a=o(s),r=a.next();!r.done;r=a.next())n=(n<<5)-n+r.value.charCodeAt(0),n&=n}catch(t){e={error:t}}finally{try{r&&!r.done&&(i=a.return)&&i.call(a)}finally{if(e)throw e.error}}}return n^n>>>16},e&e-1)throw new Error("initBucketNum must be 2 to the power of n");var c=0,h=[],d=Math.max(r.initSize,Math.min(r.maxSize,e));this.size=function(){return c},this.empty=function(){return 0===c},this.clear=function(){c=0,d=e,h=[]},this.forEach=function(t){var e=0;h.forEach(function(i){i.forEach(function(i){t(i,e++)})})},this.setElement=function(t,e){var n,l;if(null==t)throw new Error("to avoid some unnecessary errors, we don't suggest you insert null or undefined here");if(null!=e){var u=i(t)&d-1;if(h[u]){var f=h[u].size();if(h[u]instanceof s.default){try{for(var p=o(h[u]),v=p.next();!v.done;v=p.next()){var g=v.value;if(g.key===t)return void(g.value=e)}}catch(t){n={error:t}}finally{try{v&&!v.done&&(l=p.return)&&l.call(p)}finally{if(n)throw n.error}}h[u].pushBack({key:t,value:e}),h[u].size()>=r.treeifyThreshold&&(h[u]=new a.default(h[u]))}else h[u].setElement(t,e);var y=h[u].size();c+=y-f}else++c,h[u]=new s.default([{key:t,value:e}]);c>d*r.sigma&&function(t){if(!(t>=r.maxSize)){d=2*t;var e=[];h.forEach(function(n,o){if(!n.empty()){if(n instanceof s.default&&1===n.size()){var l=n.front(),c=l.key,u=l.value;e[i(c)&d-1]=new s.default([{key:c,value:u}])}else if(n instanceof a.default){var f=new s.default,p=new s.default;n.forEach(function(e){0==(i(e.key)&t)?f.pushBack(e):p.pushBack(e)}),f.size()>r.untreeifyThreshold?e[o]=new a.default(f):f.size()&&(e[o]=f),p.size()>r.untreeifyThreshold?e[o+t]=new a.default(p):p.size()&&(e[o+t]=p)}else{var v=new s.default,g=new s.default;n.forEach(function(e){0==(i(e.key)&t)?v.pushBack(e):g.pushBack(e)}),v.size()&&(e[o]=v),g.size()&&(e[o+t]=g)}h[o].clear()}}),h=e}}.call(this,d)}else this.eraseElementByKey(t)},this.getElementByKey=function(t){var e,n,s=i(t)&d-1;if(h[s]){if(h[s]instanceof a.default)return h[s].getElementByKey(t);try{for(var r=o(h[s]),l=r.next();!l.done;l=r.next()){var c=l.value;if(c.key===t)return c.value}}catch(t){e={error:t}}finally{try{l&&!l.done&&(n=r.return)&&n.call(r)}finally{if(e)throw e.error}}}},this.eraseElementByKey=function(t){var e,n,l=i(t)&d-1;if(h[l]){var u=h[l].size();if(h[l]instanceof a.default)h[l].eraseElementByKey(t),h[l].size()<=r.untreeifyThreshold&&(h[l]=new s.default(h[l]));else{var f=-1;try{for(var p=o(h[l]),v=p.next();!v.done;v=p.next())if(++f,v.value.key===t){h[l].eraseElementByPos(f);break}}catch(t){e={error:t}}finally{try{v&&!v.done&&(n=p.return)&&n.call(p)}finally{if(e)throw e.error}}}var g=h[l].size();c+=g-u}},this.find=function(t){var e,n,s=i(t)&d-1;if(!h[s])return!1;if(h[s]instanceof a.default)return h[s].find(t);try{for(var r=o(h[s]),l=r.next();!l.done;l=r.next())if(l.value.key===t)return!0}catch(t){e={error:t}}finally{try{l&&!l.done&&(n=r.return)&&n.call(r)}finally{if(e)throw e.error}}return!1},this[Symbol.iterator]=function(){return function(){var t,e,i,s,a,r;return n(this,function(n){switch(n.label){case 0:t=0,n.label=1;case 1:if(!(t<d))return[3,10];for(;t<d&&!h[t];)++t;if(t>=d)return[3,10];n.label=2;case 2:n.trys.push([2,7,8,9]),a=void 0,e=o(h[t]),i=e.next(),n.label=3;case 3:return i.done?[3,6]:[4,i.value];case 4:n.sent(),n.label=5;case 5:return i=e.next(),[3,3];case 6:return[3,9];case 7:return s=n.sent(),a={error:s},[3,9];case 8:try{i&&!i.done&&(r=e.return)&&r.call(e)}finally{if(a)throw a.error}return[7];case 9:return++t,[3,1];case 10:return[2]}})}()},t.forEach(function(t){var e=t.key,i=t.value;return l.setElement(e,i)}),Object.freeze(this)}r.initSize=16,r.maxSize=1<<30,r.sigma=.75,r.treeifyThreshold=8,r.untreeifyThreshold=6,r.minTreeifySize=64,Object.freeze(r),i.default=r},{"../LinkList/LinkList":29,"../Map/Map":30}],28:[function(t,e,i){"use strict";var n=this&&this.__generator||function(t,e){var i,n,o,s,a={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]};return s={next:r(0),throw:r(1),return:r(2)},"function"==typeof Symbol&&(s[Symbol.iterator]=function(){return this}),s;function r(s){return function(r){return function(s){if(i)throw new TypeError("Generator is already executing.");for(;a;)try{if(i=1,n&&(o=2&s[0]?n.return:s[0]?n.throw||((o=n.return)&&o.call(n),0):n.next)&&!(o=o.call(n,s[1])).done)return o;switch(n=0,o&&(s=[2&s[0],o.value]),s[0]){case 0:case 1:o=s;break;case 4:return a.label++,{value:s[1],done:!1};case 5:a.label++,n=s[1],s=[0];continue;case 7:s=a.ops.pop(),a.trys.pop();continue;default:if(!(o=(o=a.trys).length>0&&o[o.length-1])&&(6===s[0]||2===s[0])){a=0;continue}if(3===s[0]&&(!o||s[1]>o[0]&&s[1]<o[3])){a.label=s[1];break}if(6===s[0]&&a.label<o[1]){a.label=o[1],o=s;break}if(o&&a.label<o[2]){a.label=o[2],a.ops.push(s);break}o[2]&&a.ops.pop(),a.trys.pop();continue}s=e.call(t,a)}catch(t){s=[6,t],n=0}finally{i=o=0}if(5&s[0])throw s[1];return{value:s[0]?s[1]:void 0,done:!0}}([s,r])}}},o=this&&this.__values||function(t){var e="function"==typeof Symbol&&Symbol.iterator,i=e&&t[e],n=0;if(i)return i.call(t);if(t&&"number"==typeof t.length)return{next:function(){return t&&n>=t.length&&(t=void 0),{value:t&&t[n++],done:!t}}};throw new TypeError(e?"Object is not iterable.":"Symbol.iterator is not defined.")};Object.defineProperty(i,"__esModule",{value:!0});var s=t("../Set/Set"),a=t("../LinkList/LinkList");function r(t,e,i){var l=this;if(void 0===t&&(t=[]),void 0===e&&(e=r.initSize),i=i||function(t){var e=0,i="";if("number"==typeof t)e=((e=Math.floor(t))<<5)-e,e&=e;else{i="string"!=typeof t?JSON.stringify(t):t;for(var n=0;n<i.length;n++)e=(e<<5)-e+i.charCodeAt(n),e&=e}return e^e>>>16},e&e-1)throw new Error("initBucketNum must be 2 to the power of n");var c=0,h=[],d=Math.max(r.initSize,Math.min(r.maxSize,e));this.size=function(){return c},this.empty=function(){return 0===c},this.clear=function(){c=0,d=e,h=[]},this.forEach=function(t){var e=0;h.forEach(function(i){i.forEach(function(i){t(i,e++)})})},this.insert=function(t){if(null==t)throw new Error("to avoid some unnecessary errors, we don't suggest you insert null or undefined here");var e=i(t)&d-1;if(h[e]){var n=h[e].size();if(h[e]instanceof a.default){if(h[e].find(t))return;h[e].pushBack(t),h[e].size()>=r.treeifyThreshold&&(h[e]=new s.default(h[e]))}else h[e].insert(t);var o=h[e].size();c+=o-n}else h[e]=new a.default([t]),++c;c>d*r.sigma&&function(t){if(!(t>=r.maxSize)){d=2*t;var e=[];h.forEach(function(n,o){if(!n.empty()){if(n instanceof a.default&&1===n.size()){var l=n.front();if(void 0===l)throw new Error("unknown error");e[i(l)&d-1]=new a.default([l])}else if(n instanceof s.default){var c=new a.default,u=new a.default;n.forEach(function(e){0==(i(e)&t)?c.pushBack(e):u.pushBack(e)}),c.size()>r.untreeifyThreshold?e[o]=new s.default(c):c.size()&&(e[o]=c),u.size()>r.untreeifyThreshold?e[o+t]=new s.default(u):u.size()&&(e[o+t]=u)}else{var f=new a.default,p=new a.default;n.forEach(function(e){0==(i(e)&t)?f.pushBack(e):p.pushBack(e)}),f.size()&&(e[o]=f),p.size()&&(e[o+t]=p)}h[o].clear()}}),h=e}}.call(this,d)},this.eraseElementByValue=function(t){var e=i(t)&d-1;if(h[e]){var n=h[e].size();h[e].eraseElementByValue(t),h[e]instanceof s.default&&h[e].size()<=r.untreeifyThreshold&&(h[e]=new a.default(h[e]));var o=h[e].size();c+=o-n}},this.find=function(t){var e=i(t)&d-1;return!!h[e]&&h[e].find(t)},this[Symbol.iterator]=function(){return function(){var t,e,i,s,a,r;return n(this,function(n){switch(n.label){case 0:t=0,n.label=1;case 1:if(!(t<d))return[3,10];for(;t<d&&!h[t];)++t;if(t>=d)return[3,10];n.label=2;case 2:n.trys.push([2,7,8,9]),a=void 0,e=o(h[t]),i=e.next(),n.label=3;case 3:return i.done?[3,6]:[4,i.value];case 4:n.sent(),n.label=5;case 5:return i=e.next(),[3,3];case 6:return[3,9];case 7:return s=n.sent(),a={error:s},[3,9];case 8:try{i&&!i.done&&(r=e.return)&&r.call(e)}finally{if(a)throw a.error}return[7];case 9:return++t,[3,1];case 10:return[2]}})}()},t.forEach(function(t){return l.insert(t)}),Object.freeze(this)}r.initSize=16,r.maxSize=1<<30,r.sigma=.75,r.treeifyThreshold=8,r.untreeifyThreshold=6,r.minTreeifySize=64,Object.freeze(r),i.default=r},{"../LinkList/LinkList":29,"../Set/Set":33}],29:[function(t,e,i){"use strict";var n=this&&this.__generator||function(t,e){var i,n,o,s,a={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]};return s={next:r(0),throw:r(1),return:r(2)},"function"==typeof Symbol&&(s[Symbol.iterator]=function(){return this}),s;function r(s){return function(r){return function(s){if(i)throw new TypeError("Generator is already executing.");for(;a;)try{if(i=1,n&&(o=2&s[0]?n.return:s[0]?n.throw||((o=n.return)&&o.call(n),0):n.next)&&!(o=o.call(n,s[1])).done)return o;switch(n=0,o&&(s=[2&s[0],o.value]),s[0]){case 0:case 1:o=s;break;case 4:return a.label++,{value:s[1],done:!1};case 5:a.label++,n=s[1],s=[0];continue;case 7:s=a.ops.pop(),a.trys.pop();continue;default:if(!(o=(o=a.trys).length>0&&o[o.length-1])&&(6===s[0]||2===s[0])){a=0;continue}if(3===s[0]&&(!o||s[1]>o[0]&&s[1]<o[3])){a.label=s[1];break}if(6===s[0]&&a.label<o[1]){a.label=o[1],o=s;break}if(o&&a.label<o[2]){a.label=o[2],a.ops.push(s);break}o[2]&&a.ops.pop(),a.trys.pop();continue}s=e.call(t,a)}catch(t){s=[6,t],n=0}finally{i=o=0}if(5&s[0])throw s[1];return{value:s[0]?s[1]:void 0,done:!0}}([s,r])}}};Object.defineProperty(i,"__esModule",{value:!0});var o=function(t){this.value=void 0,this.pre=void 0,this.next=void 0,this.value=t};function s(t){var e=this;void 0===t&&(t=[]);var i=0,s=void 0,a=void 0;this.size=function(){return i},this.empty=function(){return 0===i},this.clear=function(){s=a=void 0,i=0},this.front=function(){return null==s?void 0:s.value},this.back=function(){return null==a?void 0:a.value},this.forEach=function(t){for(var e=s,i=0;e;){if(void 0===e.value)throw new Error("unknown error");t(e.value,i++),e=e.next}},this.getElementByPos=function(t){if(t<0||t>=i)throw new Error("pos must more then 0 and less then the list length");for(var e=s;t--&&e;)e=e.next;if(!e||void 0===e.value)throw new Error("unknown error");return e.value},this.eraseElementByPos=function(t){if(t<0||t>=i)throw new Error("erase pos must more then 0 and less then the list length");if(0===t)this.popFront();else if(t===i-1)this.popBack();else{for(var e=s;t--;){if(!(null==e?void 0:e.next))throw new Error("unknown error");e=e.next}if(!e||!e.pre||!e.next)throw new Error("unknown error");var n=e.pre,o=e.next;o.pre=n,n.next=o,i>0&&--i}},this.eraseElementByValue=function(t){for(;s&&s.value===t;)this.popFront();for(;a&&a.value===t;)this.popBack();if(s)for(var e=s;e;){if(e.value===t){var n=e.pre,o=e.next;o&&(o.pre=n),n&&(n.next=o),i>0&&--i}e=e.next}},this.pushBack=function(t){if(null==t)throw new Error("you can't push null or undefined here");++i;var e=new o(t);a?(a.next=e,e.pre=a,a=e):s=a=e},this.popBack=function(){a&&(i>0&&--i,a&&(s===a?s=a=void 0:(a=a.pre)&&(a.next=void 0)))},this.setElementByPos=function(t,e){if(null==e)throw new Error("you can't set null or undefined here");if(t<0||t>=i)throw new Error("pos must more then 0 and less then the list length");for(var n=s;t--;){if(!n)throw new Error("unknown error");n=n.next}n&&(n.value=e)},this.insert=function(t,e,n){if(void 0===n&&(n=1),null==e)throw new Error("you can't insert null or undefined here");if(t<0||t>i)throw new Error("insert pos must more then 0 and less then or equal to the list length");if(n<0)throw new Error("insert size must more than 0");if(0===t)for(;n--;)this.pushFront(e);else if(t===i)for(;n--;)this.pushBack(e);else{for(var a=s,r=1;r<t;++r){if(!(null==a?void 0:a.next))throw new Error("unknown error");a=null==a?void 0:a.next}if(!a)throw new Error("unknown error");var l=a.next;for(i+=n;n--;)a.next=new o(e),a.next.pre=a,a=a.next;a.next=l,l&&(l.pre=a)}},this.find=function(t){for(var e=s;e;){if(e.value===t)return!0;e=e.next}return!1},this.reverse=function(){for(var t=s,e=a,n=0;t&&e&&2*n<i;){var o=t.value;t.value=e.value,e.value=o,t=t.next,e=e.pre,++n}},this.unique=function(){for(var t=s;t;){for(var e=t;e&&e.next&&e.value===e.next.value;)e=e.next,i>0&&--i;t.next=e.next,t.next&&(t.next.pre=t),t=t.next}},this.sort=function(t){var e=[];this.forEach(function(t){e.push(t)}),e.sort(t);var i=s;e.forEach(function(t){i&&(i.value=t,i=i.next)})},this.pushFront=function(t){if(null==t)throw new Error("you can't push null or undefined here");++i;var e=new o(t);s?(e.next=s,s.pre=e,s=e):s=a=e},this.popFront=function(){s&&(i>0&&--i,s&&(s===a?s=a=void 0:(s=s.next)&&(s.pre=void 0)))},this.merge=function(t){var e=this,n=s;t.forEach(function(t){for(;n&&void 0!==n.value&&n.value<=t;)n=n.next;if(void 0===n)e.pushBack(t),n=a;else if(n===s)e.pushFront(t),n=s;else{++i;var r=n.pre;r&&(r.next=new o(t),r.next.pre=r,r.next.next=n,n&&(n.pre=r.next))}})},this[Symbol.iterator]=function(){return function(){var t;return n(this,function(e){switch(e.label){case 0:t=s,e.label=1;case 1:if(void 0===t)return[3,3];if(!t.value)throw new Error("unknown error");return[4,t.value];case 2:return e.sent(),t=t.next,[3,1];case 3:return[2]}})}()},t.forEach(function(t){return e.pushBack(t)}),Object.freeze(this)}Object.freeze(s),i.default=s},{}],30:[function(t,e,i){"use strict";var n=this&&this.__generator||function(t,e){var i,n,o,s,a={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]};return s={next:r(0),throw:r(1),return:r(2)},"function"==typeof Symbol&&(s[Symbol.iterator]=function(){return this}),s;function r(s){return function(r){return function(s){if(i)throw new TypeError("Generator is already executing.");for(;a;)try{if(i=1,n&&(o=2&s[0]?n.return:s[0]?n.throw||((o=n.return)&&o.call(n),0):n.next)&&!(o=o.call(n,s[1])).done)return o;switch(n=0,o&&(s=[2&s[0],o.value]),s[0]){case 0:case 1:o=s;break;case 4:return a.label++,{value:s[1],done:!1};case 5:a.label++,n=s[1],s=[0];continue;case 7:s=a.ops.pop(),a.trys.pop();continue;default:if(!(o=(o=a.trys).length>0&&o[o.length-1])&&(6===s[0]||2===s[0])){a=0;continue}if(3===s[0]&&(!o||s[1]>o[0]&&s[1]<o[3])){a.label=s[1];break}if(6===s[0]&&a.label<o[1]){a.label=o[1],o=s;break}if(o&&a.label<o[2]){a.label=o[2],a.ops.push(s);break}o[2]&&a.ops.pop(),a.trys.pop();continue}s=e.call(t,a)}catch(t){s=[6,t],n=0}finally{i=o=0}if(5&s[0])throw s[1];return{value:s[0]?s[1]:void 0,done:!0}}([s,r])}}},o=this&&this.__values||function(t){var e="function"==typeof Symbol&&Symbol.iterator,i=e&&t[e],n=0;if(i)return i.call(t);if(t&&"number"==typeof t.length)return{next:function(){return t&&n>=t.length&&(t=void 0),{value:t&&t[n++],done:!t}}};throw new TypeError(e?"Object is not iterable.":"Symbol.iterator is not defined.")};Object.defineProperty(i,"__esModule",{value:!0});var s=t("../Base/TreeNode");function a(t,e){var i=this;void 0===t&&(t=[]),e=e||function(t,e){return t<e?-1:t>e?1:0};var a=0,r=new s.default;r.color=s.default.TreeNodeColorType.black,this.size=function(){return a},this.empty=function(){return 0===a},this.clear=function(){a=0,r.key=r.value=void 0,r.leftChild=r.rightChild=r.brother=void 0};var l=function(t){if(!t||void 0===t.key)throw new Error("unknown error");return t.leftChild?l(t.leftChild):t},c=function(t){if(!t||void 0===t.key)throw new Error("unknown error");return t.rightChild?c(t.rightChild):t};this.front=function(){if(!this.empty()){var t=l(r);if(void 0===t.key||void 0===t.value)throw new Error("unknown error");return{key:t.key,value:t.value}}},this.back=function(){if(!this.empty()){var t=c(r);if(void 0===t.key||void 0===t.value)throw new Error("unknown error");return{key:t.key,value:t.value}}},this.forEach=function(t){var e,i,n=0;try{for(var s=o(this),a=s.next();!a.done;a=s.next())t(a.value,n++)}catch(t){e={error:t}}finally{try{a&&!a.done&&(i=s.return)&&i.call(s)}finally{if(e)throw e.error}}},this.getElementByPos=function(t){var e,i;if(t<0||t>=this.size())throw new Error("pos must more than 0 and less than set's size");var n=0;try{for(var s=o(this),a=s.next();!a.done;a=s.next()){var r=a.value;if(n===t)return r;++n}}catch(t){e={error:t}}finally{try{a&&!a.done&&(i=s.return)&&i.call(s)}finally{if(e)throw e.error}}throw new Error("unknown Error")};var h=function(t,i){if(t&&void 0!==t.key&&void 0!==t.value){var n=e(t.key,i);return 0===n?{key:t.key,value:t.value}:n<0?h(t.rightChild,i):h(t.leftChild,i)||{key:t.key,value:t.value}}};this.lowerBound=function(t){return h(r,t)};var d=function(t,i){if(t&&void 0!==t.key&&void 0!==t.value)return e(t.key,i)<=0?d(t.rightChild,i):d(t.leftChild,i)||{key:t.key,value:t.value}};this.upperBound=function(t){return d(r,t)};var u=function(t,i){if(t&&void 0!==t.key&&void 0!==t.value){var n=e(t.key,i);return 0===n?{key:t.key,value:t.value}:n>0?u(t.leftChild,i):u(t.rightChild,i)||{key:t.key,value:t.value}}};this.reverseLowerBound=function(t){return u(r,t)};var f=function(t,i){if(t&&void 0!==t.key&&void 0!==t.value)return e(t.key,i)>=0?f(t.leftChild,i):f(t.rightChild,i)||{key:t.key,value:t.value}};this.reverseUpperBound=function(t){return f(r,t)};var p=function(t){var e=t.parent;if(!e){if(t===r)return;throw new Error("unknown error")}if(t.color!==s.default.TreeNodeColorType.red){var i=t.brother;if(!i)throw new Error("unknown error");if(t===e.leftChild)if(i.color===s.default.TreeNodeColorType.red){i.color=s.default.TreeNodeColorType.black,e.color=s.default.TreeNodeColorType.red;var n=e.rotateLeft();r===e&&(r=n),p(t)}else i.color===s.default.TreeNodeColorType.black&&(i.rightChild&&i.rightChild.color===s.default.TreeNodeColorType.red?(i.color=e.color,e.color=s.default.TreeNodeColorType.black,i.rightChild&&(i.rightChild.color=s.default.TreeNodeColorType.black),n=e.rotateLeft(),r===e&&(r=n),t.color=s.default.TreeNodeColorType.black):i.rightChild&&i.rightChild.color!==s.default.TreeNodeColorType.black||!i.leftChild||i.leftChild.color!==s.default.TreeNodeColorType.red?i.leftChild&&i.leftChild.color!==s.default.TreeNodeColorType.black||i.rightChild&&i.rightChild.color!==s.default.TreeNodeColorType.black||(i.color=s.default.TreeNodeColorType.red,p(e)):(i.color=s.default.TreeNodeColorType.red,i.leftChild&&(i.leftChild.color=s.default.TreeNodeColorType.black),n=i.rotateRight(),r===i&&(r=n),p(t)));else t===e.rightChild&&(i.color===s.default.TreeNodeColorType.red?(i.color=s.default.TreeNodeColorType.black,e.color=s.default.TreeNodeColorType.red,n=e.rotateRight(),r===e&&(r=n),p(t)):i.color===s.default.TreeNodeColorType.black&&(i.leftChild&&i.leftChild.color===s.default.TreeNodeColorType.red?(i.color=e.color,e.color=s.default.TreeNodeColorType.black,i.leftChild&&(i.leftChild.color=s.default.TreeNodeColorType.black),n=e.rotateRight(),r===e&&(r=n),t.color=s.default.TreeNodeColorType.black):i.leftChild&&i.leftChild.color!==s.default.TreeNodeColorType.black||!i.rightChild||i.rightChild.color!==s.default.TreeNodeColorType.red?i.leftChild&&i.leftChild.color!==s.default.TreeNodeColorType.black||i.rightChild&&i.rightChild.color!==s.default.TreeNodeColorType.black||(i.color=s.default.TreeNodeColorType.red,p(e)):(i.color=s.default.TreeNodeColorType.red,i.rightChild&&(i.rightChild.color=s.default.TreeNodeColorType.black),n=i.rotateLeft(),r===i&&(r=n),p(t))))}else t.color=s.default.TreeNodeColorType.black},v=function(t){for(var e=t;e.leftChild||e.rightChild;){if(e.rightChild){e=l(e.rightChild);var i=t.key;t.key=e.key,e.key=i;var n=t.value;t.value=e.value,e.value=n,t=e}e.leftChild&&(e=c(e.leftChild),i=t.key,t.key=e.key,e.key=i,n=t.value,t.value=e.value,e.value=n,t=e)}p(e),e&&e.remove(),--a,r.color=s.default.TreeNodeColorType.black},g=function(t,e){return!(!t||void 0===t.key)&&(!!g(t.leftChild,e)||!!e(t)||g(t.rightChild,e))};this.eraseElementByPos=function(t){if(t<0||t>=a)throw new Error("pos must more than 0 and less than set's size");var e=0;g(r,function(i){return t===e?(v(i),!0):(++e,!1)})},this.eraseElementByKey=function(t){if(!this.empty()){var i=w(r,t);void 0!==i&&void 0!==i.key&&0===e(i.key,t)&&v(i)}};var y=function(t,i){if(!t||void 0===t.key)throw new Error("unknown error");var n=e(i,t.key);return n<0?t.leftChild?y(t.leftChild,i):(t.leftChild=new s.default,t.leftChild.parent=t,t.leftChild.brother=t.rightChild,t.rightChild&&(t.rightChild.brother=t.leftChild),t.leftChild):n>0?t.rightChild?y(t.rightChild,i):(t.rightChild=new s.default,t.rightChild.parent=t,t.rightChild.brother=t.leftChild,t.leftChild&&(t.leftChild.brother=t.rightChild),t.rightChild):t},m=function(t){var e=t.parent;if(!e){if(t===r)return;throw new Error("unknown error")}if(e.color!==s.default.TreeNodeColorType.black&&e.color===s.default.TreeNodeColorType.red){var i=e.brother,n=e.parent;if(!n)throw new Error("unknown error");if(i&&i.color===s.default.TreeNodeColorType.red)i.color=e.color=s.default.TreeNodeColorType.black,n.color=s.default.TreeNodeColorType.red,m(n);else if(!i||i.color===s.default.TreeNodeColorType.black)if(e===n.leftChild)if(t===e.leftChild){e.color=s.default.TreeNodeColorType.black,n.color=s.default.TreeNodeColorType.red;var o=n.rotateRight();n===r&&(r=o)}else t===e.rightChild&&(o=e.rotateLeft(),n===r&&(r=o),m(e));else e===n.rightChild&&(t===e.leftChild?(o=e.rotateRight(),n===r&&(r=o),m(e)):t===e.rightChild&&(e.color=s.default.TreeNodeColorType.black,n.color=s.default.TreeNodeColorType.red,o=n.rotateLeft(),n===r&&(r=o)))}};this.setElement=function(t,i){if(null==t)throw new Error("to avoid some unnecessary errors, we don't suggest you insert null or undefined here");if(null!=i){if(this.empty())return++a,r.key=t,r.value=i,void(r.color=s.default.TreeNodeColorType.black);var n=y(r,t);void 0===n.key||0!==e(n.key,t)?(++a,n.key=t,n.value=i,m(n),r.color=s.default.TreeNodeColorType.black):n.value=i}else this.eraseElementByKey(t)};var w=function(t,i){if(t&&void 0!==t.key){var n=e(i,t.key);return n<0?w(t.leftChild,i):n>0?w(t.rightChild,i):t}};this.find=function(t){return!!w(r,t)},this.getElementByKey=function(t){var e=w(r,t);if(void 0===(null==e?void 0:e.key)||void 0===(null==e?void 0:e.value))throw new Error("unknown error");return e.value},this.union=function(t){var e=this;t.forEach(function(t){var i=t.key,n=t.value;return e.setElement(i,n)})},this.getHeight=function(){if(this.empty())return 0;var t=function(e){return e?Math.max(t(e.leftChild),t(e.rightChild))+1:1};return t(r)};var x=function(t){return n(this,function(e){switch(e.label){case 0:return t&&void 0!==t.key&&void 0!==t.value?[5,o(x(t.leftChild))]:[2];case 1:return e.sent(),[4,{key:t.key,value:t.value}];case 2:return e.sent(),[5,o(x(t.rightChild))];case 3:return e.sent(),[2]}})};this[Symbol.iterator]=function(){return x(r)},t.forEach(function(t){var e=t.key,n=t.value;return i.setElement(e,n)}),Object.freeze(this)}Object.freeze(a),i.default=a},{"../Base/TreeNode":25}],31:[function(t,e,i){"use strict";function n(t,e){void 0===t&&(t=[]),e=e||function(t,e){return t>e?-1:t<e?1:0};var i=[];t.forEach(function(t){return i.push(t)});var n=i.length,o=function(t,e){if(t<0||t>=n)throw new Error("unknown error");if(e<0||e>=n)throw new Error("unknown error");var o=i[t];i[t]=i[e],i[e]=o},s=function(t){if(t<0||t>=n)throw new Error("unknown error");var s=2*t+1,a=2*t+2;s<n&&e(i[t],i[s])>0&&o(t,s),a<n&&e(i[t],i[a])>0&&o(t,a)};!function(){for(var t=Math.floor((n-1)/2);t>=0;--t)for(var s=t,a=2*s+1;a<n;){var r=a+1,l=a;if(r<n&&e(i[a],i[r])>0&&(l=r),e(i[s],i[l])<=0)break;o(s,l),a=2*(s=l)+1}}(),this.size=function(){return n},this.empty=function(){return 0===n},this.clear=function(){n=0,i.length=0},this.push=function(t){if(i.push(t),1!==++n)for(var o=n-1;o>0;){var a=Math.floor((o-1)/2);if(e(i[a],t)<=0)break;s(a),o=a}},this.pop=function(){if(!this.empty())if(1!==this.size()){var t=i[n-1];--n;for(var o=0;o<this.size();){var s=2*o+1,a=2*o+2;if(s>=this.size())break;var r=s;if(a<this.size()&&e(i[s],i[a])>0&&(r=a),e(i[r],t)>=0)break;i[o]=i[r],o=r}i[o]=t}else--n},this.top=function(){return i[0]},Object.freeze(this)}Object.defineProperty(i,"__esModule",{value:!0}),Object.freeze(n),i.default=n},{}],32:[function(t,e,i){"use strict";Object.defineProperty(i,"__esModule",{value:!0});var n=t("../LinkList/LinkList");function o(t){void 0===t&&(t=[]);var e=new n.default(t);this.size=function(){return e.size()},this.empty=function(){return e.empty()},this.clear=function(){e.clear()},this.push=function(t){e.pushBack(t)},this.pop=function(){e.popFront()},this.front=function(){return e.front()},Object.freeze(this)}Object.freeze(o),i.default=o},{"../LinkList/LinkList":29}],33:[function(t,e,i){"use strict";var n=this&&this.__generator||function(t,e){var i,n,o,s,a={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]};return s={next:r(0),throw:r(1),return:r(2)},"function"==typeof Symbol&&(s[Symbol.iterator]=function(){return this}),s;function r(s){return function(r){return function(s){if(i)throw new TypeError("Generator is already executing.");for(;a;)try{if(i=1,n&&(o=2&s[0]?n.return:s[0]?n.throw||((o=n.return)&&o.call(n),0):n.next)&&!(o=o.call(n,s[1])).done)return o;switch(n=0,o&&(s=[2&s[0],o.value]),s[0]){case 0:case 1:o=s;break;case 4:return a.label++,{value:s[1],done:!1};case 5:a.label++,n=s[1],s=[0];continue;case 7:s=a.ops.pop(),a.trys.pop();continue;default:if(!(o=(o=a.trys).length>0&&o[o.length-1])&&(6===s[0]||2===s[0])){a=0;continue}if(3===s[0]&&(!o||s[1]>o[0]&&s[1]<o[3])){a.label=s[1];break}if(6===s[0]&&a.label<o[1]){a.label=o[1],o=s;break}if(o&&a.label<o[2]){a.label=o[2],a.ops.push(s);break}o[2]&&a.ops.pop(),a.trys.pop();continue}s=e.call(t,a)}catch(t){s=[6,t],n=0}finally{i=o=0}if(5&s[0])throw s[1];return{value:s[0]?s[1]:void 0,done:!0}}([s,r])}}},o=this&&this.__values||function(t){var e="function"==typeof Symbol&&Symbol.iterator,i=e&&t[e],n=0;if(i)return i.call(t);if(t&&"number"==typeof t.length)return{next:function(){return t&&n>=t.length&&(t=void 0),{value:t&&t[n++],done:!t}}};throw new TypeError(e?"Object is not iterable.":"Symbol.iterator is not defined.")};Object.defineProperty(i,"__esModule",{value:!0});var s=t("../Base/TreeNode");function a(t,e){var i=this;void 0===t&&(t=[]),e=e||function(t,e){return t<e?-1:t>e?1:0};var a=0,r=new s.default;r.color=s.default.TreeNodeColorType.black,this.size=function(){return a},this.empty=function(){return 0===a},this.clear=function(){a=0,r.key=void 0,r.leftChild=r.rightChild=r.brother=r.parent=void 0,r.color=s.default.TreeNodeColorType.black};var l=function(t){if(!t||void 0===t.key)throw new Error("unknown error");return t.leftChild?l(t.leftChild):t},c=function(t){if(!t||void 0===t.key)throw new Error("unknown error");return t.rightChild?c(t.rightChild):t};this.front=function(){if(!this.empty())return l(r).key},this.back=function(){if(!this.empty())return c(r).key},this.forEach=function(t){var e,i,n=0;try{for(var s=o(this),a=s.next();!a.done;a=s.next())t(a.value,n++)}catch(t){e={error:t}}finally{try{a&&!a.done&&(i=s.return)&&i.call(s)}finally{if(e)throw e.error}}},this.getElementByPos=function(t){var e,i;if(t<0||t>=this.size())throw new Error("pos must more than 0 and less than set's size");var n=0;try{for(var s=o(this),a=s.next();!a.done;a=s.next()){var r=a.value;if(n===t)return r;++n}}catch(t){e={error:t}}finally{try{a&&!a.done&&(i=s.return)&&i.call(s)}finally{if(e)throw e.error}}throw new Error("unknown error")};var h=function(t){var e=t.parent;if(!e){if(t===r)return;throw new Error("unknown error")}if(t.color!==s.default.TreeNodeColorType.red){var i=t.brother;if(!i)throw new Error("unknown error");if(t===e.leftChild)if(i.color===s.default.TreeNodeColorType.red){i.color=s.default.TreeNodeColorType.black,e.color=s.default.TreeNodeColorType.red;var n=e.rotateLeft();r===e&&(r=n),h(t)}else i.color===s.default.TreeNodeColorType.black&&(i.rightChild&&i.rightChild.color===s.default.TreeNodeColorType.red?(i.color=e.color,e.color=s.default.TreeNodeColorType.black,i.rightChild&&(i.rightChild.color=s.default.TreeNodeColorType.black),n=e.rotateLeft(),r===e&&(r=n),t.color=s.default.TreeNodeColorType.black):i.rightChild&&i.rightChild.color!==s.default.TreeNodeColorType.black||!i.leftChild||i.leftChild.color!==s.default.TreeNodeColorType.red?i.leftChild&&i.leftChild.color!==s.default.TreeNodeColorType.black||i.rightChild&&i.rightChild.color!==s.default.TreeNodeColorType.black||(i.color=s.default.TreeNodeColorType.red,h(e)):(i.color=s.default.TreeNodeColorType.red,i.leftChild&&(i.leftChild.color=s.default.TreeNodeColorType.black),n=i.rotateRight(),r===i&&(r=n),h(t)));else t===e.rightChild&&(i.color===s.default.TreeNodeColorType.red?(i.color=s.default.TreeNodeColorType.black,e.color=s.default.TreeNodeColorType.red,n=e.rotateRight(),r===e&&(r=n),h(t)):i.color===s.default.TreeNodeColorType.black&&(i.leftChild&&i.leftChild.color===s.default.TreeNodeColorType.red?(i.color=e.color,e.color=s.default.TreeNodeColorType.black,i.leftChild&&(i.leftChild.color=s.default.TreeNodeColorType.black),n=e.rotateRight(),r===e&&(r=n),t.color=s.default.TreeNodeColorType.black):i.leftChild&&i.leftChild.color!==s.default.TreeNodeColorType.black||!i.rightChild||i.rightChild.color!==s.default.TreeNodeColorType.red?i.leftChild&&i.leftChild.color!==s.default.TreeNodeColorType.black||i.rightChild&&i.rightChild.color!==s.default.TreeNodeColorType.black||(i.color=s.default.TreeNodeColorType.red,h(e)):(i.color=s.default.TreeNodeColorType.red,i.rightChild&&(i.rightChild.color=s.default.TreeNodeColorType.black),n=i.rotateLeft(),r===i&&(r=n),h(t))))}else t.color=s.default.TreeNodeColorType.black},d=function(t){for(var e=t;e.leftChild||e.rightChild;){if(e.rightChild){e=l(e.rightChild);var i=t.key;t.key=e.key,e.key=i,t=e}e.leftChild&&(e=c(e.leftChild),i=t.key,t.key=e.key,e.key=i,t=e)}h(e),e&&e.remove(),--a,r.color=s.default.TreeNodeColorType.black},u=function(t,e){return!(!t||void 0===t.key)&&(!!u(t.leftChild,e)||!!e(t)||u(t.rightChild,e))};this.eraseElementByPos=function(t){if(t<0||t>=a)throw new Error("pos must more than 0 and less than set's size");var e=0;u(r,function(i){return t===e?(d(i),!0):(++e,!1)})},this.eraseElementByValue=function(t){if(!this.empty()){var i=v(r,t);void 0!==i&&void 0!==i.key&&0===e(i.key,t)&&d(i)}};var f=function(t,i){if(!t||void 0===t.key)throw new Error("unknown error");var n=e(i,t.key);return n<0?t.leftChild?f(t.leftChild,i):(t.leftChild=new s.default,t.leftChild.parent=t,t.leftChild.brother=t.rightChild,t.rightChild&&(t.rightChild.brother=t.leftChild),t.leftChild):n>0?t.rightChild?f(t.rightChild,i):(t.rightChild=new s.default,t.rightChild.parent=t,t.rightChild.brother=t.leftChild,t.leftChild&&(t.leftChild.brother=t.rightChild),t.rightChild):t},p=function(t){var e=t.parent;if(!e){if(t===r)return;throw new Error("unknown error")}if(e.color!==s.default.TreeNodeColorType.black&&e.color===s.default.TreeNodeColorType.red){var i=e.brother,n=e.parent;if(!n)throw new Error("unknown error");if(i&&i.color===s.default.TreeNodeColorType.red)i.color=e.color=s.default.TreeNodeColorType.black,n.color=s.default.TreeNodeColorType.red,p(n);else if(!i||i.color===s.default.TreeNodeColorType.black)if(e===n.leftChild)if(t===e.leftChild){e.color=s.default.TreeNodeColorType.black,n.color=s.default.TreeNodeColorType.red;var o=n.rotateRight();n===r&&(r=o)}else t===e.rightChild&&(o=e.rotateLeft(),n===r&&(r=o),p(e));else e===n.rightChild&&(t===e.leftChild?(o=e.rotateRight(),n===r&&(r=o),p(e)):t===e.rightChild&&(e.color=s.default.TreeNodeColorType.black,n.color=s.default.TreeNodeColorType.red,o=n.rotateLeft(),n===r&&(r=o)))}};this.insert=function(t){if(null==t)throw new Error("to avoid some unnecessary errors, we don't suggest you insert null or undefined here");if(this.empty())return++a,r.key=t,void(r.color=s.default.TreeNodeColorType.black);var i=f(r,t);void 0!==i.key&&0===e(i.key,t)||(++a,i.key=t,p(i),r.color=s.default.TreeNodeColorType.black)};var v=function(t,i){if(t&&void 0!==t.key){var n=e(i,t.key);return n<0?v(t.leftChild,i):n>0?v(t.rightChild,i):t}};this.find=function(t){var i=v(r,t);return void 0!==i&&void 0!==i.key&&0===e(i.key,t)};var g=function(t,i){if(t&&void 0!==t.key){var n=e(t.key,i);if(0===n)return t.key;if(n<0)return g(t.rightChild,i);var o=g(t.leftChild,i);return void 0!==o?o:t.key}};this.lowerBound=function(t){return g(r,t)};var y=function(t,i){if(t&&void 0!==t.key){if(e(t.key,i)<=0)return y(t.rightChild,i);var n=y(t.leftChild,i);return void 0!==n?n:t.key}};this.upperBound=function(t){return y(r,t)};var m=function(t,i){if(t&&void 0!==t.key){var n=e(t.key,i);if(0===n)return t.key;if(n>0)return m(t.leftChild,i);var o=m(t.rightChild,i);return void 0!==o?o:t.key}};this.reverseLowerBound=function(t){return m(r,t)};var w=function(t,i){if(t&&void 0!==t.key){if(e(t.key,i)>=0)return w(t.leftChild,i);var n=w(t.rightChild,i);return void 0!==n?n:t.key}};this.reverseUpperBound=function(t){return w(r,t)},this.union=function(t){var e=this;t.forEach(function(t){return e.insert(t)})},this.getHeight=function(){if(this.empty())return 0;var t=function(e){return e?Math.max(t(e.leftChild),t(e.rightChild))+1:1};return t(r)};var x=function(t){return n(this,function(e){switch(e.label){case 0:return t&&void 0!==t.key?[5,o(x(t.leftChild))]:[2];case 1:return e.sent(),[4,t.key];case 2:return e.sent(),[5,o(x(t.rightChild))];case 3:return e.sent(),[2]}})};this[Symbol.iterator]=function(){return x(r)},t.forEach(function(t){return i.insert(t)}),Object.freeze(this)}Object.freeze(a),i.default=a},{"../Base/TreeNode":25}],34:[function(t,e,i){"use strict";function n(t){var e=this;void 0===t&&(t=[]);var i=0,n=[];this.size=function(){return i},this.empty=function(){return 0===i},this.clear=function(){i=0,n.length=0},this.push=function(t){n.push(t),++i},this.pop=function(){n.pop(),i>0&&--i},this.top=function(){return n[i-1]},t.forEach(function(t){return e.push(t)}),Object.freeze(this)}Object.defineProperty(i,"__esModule",{value:!0}),Object.freeze(n),i.default=n},{}],35:[function(t,e,i){"use strict";var n=this&&this.__generator||function(t,e){var i,n,o,s,a={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]};return s={next:r(0),throw:r(1),return:r(2)},"function"==typeof Symbol&&(s[Symbol.iterator]=function(){return this}),s;function r(s){return function(r){return function(s){if(i)throw new TypeError("Generator is already executing.");for(;a;)try{if(i=1,n&&(o=2&s[0]?n.return:s[0]?n.throw||((o=n.return)&&o.call(n),0):n.next)&&!(o=o.call(n,s[1])).done)return o;switch(n=0,o&&(s=[2&s[0],o.value]),s[0]){case 0:case 1:o=s;break;case 4:return a.label++,{value:s[1],done:!1};case 5:a.label++,n=s[1],s=[0];continue;case 7:s=a.ops.pop(),a.trys.pop();continue;default:if(!(o=(o=a.trys).length>0&&o[o.length-1])&&(6===s[0]||2===s[0])){a=0;continue}if(3===s[0]&&(!o||s[1]>o[0]&&s[1]<o[3])){a.label=s[1];break}if(6===s[0]&&a.label<o[1]){a.label=o[1],o=s;break}if(o&&a.label<o[2]){a.label=o[2],a.ops.push(s);break}o[2]&&a.ops.pop(),a.trys.pop();continue}s=e.call(t,a)}catch(t){s=[6,t],n=0}finally{i=o=0}if(5&s[0])throw s[1];return{value:s[0]?s[1]:void 0,done:!0}}([s,r])}}},o=this&&this.__read||function(t,e){var i="function"==typeof Symbol&&t[Symbol.iterator];if(!i)return t;var n,o,s=i.call(t),a=[];try{for(;(void 0===e||e-- >0)&&!(n=s.next()).done;)a.push(n.value)}catch(t){o={error:t}}finally{try{n&&!n.done&&(i=s.return)&&i.call(s)}finally{if(o)throw o.error}}return a},s=this&&this.__spreadArray||function(t,e,i){if(i||2===arguments.length)for(var n,o=0,s=e.length;o<s;o++)!n&&o in e||(n||(n=Array.prototype.slice.call(e,0,o)),n[o]=e[o]);return t.concat(n||Array.prototype.slice.call(e))},a=this&&this.__values||function(t){var e="function"==typeof Symbol&&Symbol.iterator,i=e&&t[e],n=0;if(i)return i.call(t);if(t&&"number"==typeof t.length)return{next:function(){return t&&n>=t.length&&(t=void 0),{value:t&&t[n++],done:!t}}};throw new TypeError(e?"Object is not iterable.":"Symbol.iterator is not defined.")};function r(t){var e=this;void 0===t&&(t=[]);var i=0,r=[];this.size=function(){return i},this.empty=function(){return 0===i},this.clear=function(){i=0,r.length=0},this.front=function(){if(!this.empty())return r[0]},this.back=function(){if(!this.empty())return r[i-1]},this.forEach=function(t){r.forEach(t)},this.getElementByPos=function(t){if(t<0||t>=i)throw new Error("pos must more than 0 and less than vector's size");return r[t]},this.eraseElementByPos=function(t){if(t<0||t>=i)throw new Error("pos must more than 0 and less than vector's size");for(var e=t;e<i-1;++e)r[e]=r[e+1];this.popBack()},this.eraseElementByValue=function(t){var e=[];this.forEach(function(i){i!==t&&e.push(i)}),e.forEach(function(t,e){r[e]=t});for(var n=e.length;i>n;)this.popBack()},this.pushBack=function(t){r.push(t),++i},this.popBack=function(){r.pop(),i>0&&--i},this.setElementByPos=function(t,e){if(t<0||t>=i)throw new Error("pos must more than 0 and less than vector's size");r[t]=e},this.insert=function(t,e,n){if(void 0===n&&(n=1),t<0||t>i)throw new Error("pos must more than 0 and less than or equal to vector's size");r.splice.apply(r,s([t,0],o(new Array(n).fill(e)),!1)),i+=n},this.find=function(t){return r.includes(t)},this.reverse=function(){r.reverse()},this.unique=function(){var t,e=[];this.forEach(function(i,n){0!==n&&i===t||(e.push(i),t=i)}),e.forEach(function(t,e){r[e]=t});for(var n=e.length;i>n;)this.popBack()},this.sort=function(t){r.sort(t)},this[Symbol.iterator]=function(){return function(){return n(this,function(t){switch(t.label){case 0:return[5,a(r)];case 1:return[2,t.sent()]}})}()},t.forEach(function(t){return e.pushBack(t)}),Object.freeze(this)}Object.defineProperty(i,"__esModule",{value:!0}),Object.freeze(r),i.default=r},{}],36:[function(t,e,i){"use strict";Object.defineProperty(i,"__esModule",{value:!0}),i.HashMap=i.HashSet=i.Map=i.Set=i.PriorityQueue=i.Deque=i.LinkList=i.Queue=i.Stack=i.Vector=void 0;var n=t("./Vector/Vector");i.Vector=n.default;var o=t("./Stack/Stack");i.Stack=o.default;var s=t("./Queue/Queue");i.Queue=s.default;var a=t("./LinkList/LinkList");i.LinkList=a.default;var r=t("./Deque/Deque");i.Deque=r.default;var l=t("./PriorityQueue/PriorityQueue");i.PriorityQueue=l.default;var c=t("./Set/Set");i.Set=c.default;var h=t("./Map/Map");i.Map=h.default;var d=t("./HashSet/HashSet");i.HashSet=d.default;var u=t("./HashMap/HashMap");i.HashMap=u.default},{"./Deque/Deque":26,"./HashMap/HashMap":27,"./HashSet/HashSet":28,"./LinkList/LinkList":29,"./Map/Map":30,"./PriorityQueue/PriorityQueue":31,"./Queue/Queue":32,"./Set/Set":33,"./Stack/Stack":34,"./Vector/Vector":35}],37:[function(t,e,i){"use strict";const n=t("yallist"),o=Symbol("max"),s=Symbol("length"),a=Symbol("lengthCalculator"),r=Symbol("allowStale"),l=Symbol("maxAge"),c=Symbol("dispose"),h=Symbol("noDisposeOnSet"),d=Symbol("lruList"),u=Symbol("cache"),f=Symbol("updateAgeOnGet"),p=()=>1,v=(t,e,i)=>{const n=t[u].get(e);if(n){const e=n.value;if(g(t,e)){if(m(t,n),!t[r])return}else i&&(t[f]&&(n.value.now=Date.now()),t[d].unshiftNode(n));return e.value}},g=(t,e)=>{if(!e||!e.maxAge&&!t[l])return!1;const i=Date.now()-e.now;return e.maxAge?i>e.maxAge:t[l]&&i>t[l]},y=t=>{if(t[s]>t[o])for(let e=t[d].tail;t[s]>t[o]&&null!==e;){const i=e.prev;m(t,e),e=i}},m=(t,e)=>{if(e){const i=e.value;t[c]&&t[c](i.key,i.value),t[s]-=i.length,t[u].delete(i.key),t[d].removeNode(e)}};class w{constructor(t,e,i,n,o){this.key=t,this.value=e,this.length=i,this.now=n,this.maxAge=o||0}}const x=(t,e,i,n)=>{let o=i.value;g(t,o)&&(m(t,i),t[r]||(o=void 0)),o&&e.call(n,o.value,o.key,t)};e.exports=class{constructor(t){if("number"==typeof t&&(t={max:t}),t||(t={}),t.max&&("number"!=typeof t.max||t.max<0))throw new TypeError("max must be a non-negative number");this[o]=t.max||1/0;const e=t.length||p;if(this[a]="function"!=typeof e?p:e,this[r]=t.stale||!1,t.maxAge&&"number"!=typeof t.maxAge)throw new TypeError("maxAge must be a number");this[l]=t.maxAge||0,this[c]=t.dispose,this[h]=t.noDisposeOnSet||!1,this[f]=t.updateAgeOnGet||!1,this.reset()}set max(t){if("number"!=typeof t||t<0)throw new TypeError("max must be a non-negative number");this[o]=t||1/0,y(this)}get max(){return this[o]}set allowStale(t){this[r]=!!t}get allowStale(){return this[r]}set maxAge(t){if("number"!=typeof t)throw new TypeError("maxAge must be a non-negative number");this[l]=t,y(this)}get maxAge(){return this[l]}set lengthCalculator(t){"function"!=typeof t&&(t=p),t!==this[a]&&(this[a]=t,this[s]=0,this[d].forEach(t=>{t.length=this[a](t.value,t.key),this[s]+=t.length})),y(this)}get lengthCalculator(){return this[a]}get length(){return this[s]}get itemCount(){return this[d].length}rforEach(t,e){e=e||this;for(let i=this[d].tail;null!==i;){const n=i.prev;x(this,t,i,e),i=n}}forEach(t,e){e=e||this;for(let i=this[d].head;null!==i;){const n=i.next;x(this,t,i,e),i=n}}keys(){return this[d].toArray().map(t=>t.key)}values(){return this[d].toArray().map(t=>t.value)}reset(){this[c]&&this[d]&&this[d].length&&this[d].forEach(t=>this[c](t.key,t.value)),this[u]=new Map,this[d]=new n,this[s]=0}dump(){return this[d].map(t=>!g(this,t)&&{k:t.key,v:t.value,e:t.now+(t.maxAge||0)}).toArray().filter(t=>t)}dumpLru(){return this[d]}set(t,e,i){if((i=i||this[l])&&"number"!=typeof i)throw new TypeError("maxAge must be a number");const n=i?Date.now():0,r=this[a](e,t);if(this[u].has(t)){if(r>this[o])return m(this,this[u].get(t)),!1;const a=this[u].get(t).value;return this[c]&&(this[h]||this[c](t,a.value)),a.now=n,a.maxAge=i,a.value=e,this[s]+=r-a.length,a.length=r,this.get(t),y(this),!0}const f=new w(t,e,r,n,i);return f.length>this[o]?(this[c]&&this[c](t,e),!1):(this[s]+=f.length,this[d].unshift(f),this[u].set(t,this[d].head),y(this),!0)}has(t){if(!this[u].has(t))return!1;const e=this[u].get(t).value;return!g(this,e)}get(t){return v(this,t,!0)}peek(t){return v(this,t,!1)}pop(){const t=this[d].tail;return t?(m(this,t),t.value):null}del(t){m(this,this[u].get(t))}load(t){this.reset();const e=Date.now();for(let i=t.length-1;i>=0;i--){const n=t[i],o=n.e||0;if(0===o)this.set(n.k,n.v);else{const t=o-e;t>0&&this.set(n.k,n.v,t)}}}prune(){this[u].forEach((t,e)=>v(this,e,!1))}}},{yallist:83}],38:[function(t,e,i){(function(t){(function(){const i=e.exports;i.types={0:"reserved",1:"connect",2:"connack",3:"publish",4:"puback",5:"pubrec",6:"pubrel",7:"pubcomp",8:"subscribe",9:"suback",10:"unsubscribe",11:"unsuback",12:"pingreq",13:"pingresp",14:"disconnect",15:"auth"},i.codes={};for(const t in i.types){const e=i.types[t];i.codes[e]=t}i.CMD_SHIFT=4,i.CMD_MASK=240,i.DUP_MASK=8,i.QOS_MASK=3,i.QOS_SHIFT=1,i.RETAIN_MASK=1,i.VARBYTEINT_MASK=127,i.VARBYTEINT_FIN_MASK=128,i.VARBYTEINT_MAX=268435455,i.SESSIONPRESENT_MASK=1,i.SESSIONPRESENT_HEADER=t.from([i.SESSIONPRESENT_MASK]),i.CONNACK_HEADER=t.from([i.codes.connack<<i.CMD_SHIFT]),i.USERNAME_MASK=128,i.PASSWORD_MASK=64,i.WILL_RETAIN_MASK=32,i.WILL_QOS_MASK=24,i.WILL_QOS_SHIFT=3,i.WILL_FLAG_MASK=4,i.CLEAN_SESSION_MASK=2,i.CONNECT_HEADER=t.from([i.codes.connect<<i.CMD_SHIFT]),i.properties={sessionExpiryInterval:17,willDelayInterval:24,receiveMaximum:33,maximumPacketSize:39,topicAliasMaximum:34,requestResponseInformation:25,requestProblemInformation:23,userProperties:38,authenticationMethod:21,authenticationData:22,payloadFormatIndicator:1,messageExpiryInterval:2,contentType:3,responseTopic:8,correlationData:9,maximumQoS:36,retainAvailable:37,assignedClientIdentifier:18,reasonString:31,wildcardSubscriptionAvailable:40,subscriptionIdentifiersAvailable:41,sharedSubscriptionAvailable:42,serverKeepAlive:19,responseInformation:26,serverReference:28,topicAlias:35,subscriptionIdentifier:11},i.propertiesCodes={};for(const t in i.properties){const e=i.properties[t];i.propertiesCodes[e]=t}function n(e){return[0,1,2].map(n=>[0,1].map(o=>[0,1].map(s=>{const a=t.alloc(1);return a.writeUInt8(i.codes[e]<<i.CMD_SHIFT|(o?i.DUP_MASK:0)|n<<i.QOS_SHIFT|s,0,!0),a})))}i.propertiesTypes={sessionExpiryInterval:"int32",willDelayInterval:"int32",receiveMaximum:"int16",maximumPacketSize:"int32",topicAliasMaximum:"int16",requestResponseInformation:"byte",requestProblemInformation:"byte",userProperties:"pair",authenticationMethod:"string",authenticationData:"binary",payloadFormatIndicator:"byte",messageExpiryInterval:"int32",contentType:"string",responseTopic:"string",correlationData:"binary",maximumQoS:"int8",retainAvailable:"byte",assignedClientIdentifier:"string",reasonString:"string",wildcardSubscriptionAvailable:"byte",subscriptionIdentifiersAvailable:"byte",sharedSubscriptionAvailable:"byte",serverKeepAlive:"int16",responseInformation:"string",serverReference:"string",topicAlias:"int16",subscriptionIdentifier:"var"},i.PUBLISH_HEADER=n("publish"),i.SUBSCRIBE_HEADER=n("subscribe"),i.SUBSCRIBE_OPTIONS_QOS_MASK=3,i.SUBSCRIBE_OPTIONS_NL_MASK=1,i.SUBSCRIBE_OPTIONS_NL_SHIFT=2,i.SUBSCRIBE_OPTIONS_RAP_MASK=1,i.SUBSCRIBE_OPTIONS_RAP_SHIFT=3,i.SUBSCRIBE_OPTIONS_RH_MASK=3,i.SUBSCRIBE_OPTIONS_RH_SHIFT=4,i.SUBSCRIBE_OPTIONS_RH=[0,16,32],i.SUBSCRIBE_OPTIONS_NL=4,i.SUBSCRIBE_OPTIONS_RAP=8,i.SUBSCRIBE_OPTIONS_QOS=[0,1,2],i.UNSUBSCRIBE_HEADER=n("unsubscribe"),i.ACKS={unsuback:n("unsuback"),puback:n("puback"),pubcomp:n("pubcomp"),pubrel:n("pubrel"),pubrec:n("pubrec")},i.SUBACK_HEADER=t.from([i.codes.suback<<i.CMD_SHIFT]),i.VERSION3=t.from([3]),i.VERSION4=t.from([4]),i.VERSION5=t.from([5]),i.VERSION131=t.from([131]),i.VERSION132=t.from([132]),i.QOS=[0,1,2].map(e=>t.from([e])),i.EMPTY={pingreq:t.from([i.codes.pingreq<<4,0]),pingresp:t.from([i.codes.pingresp<<4,0]),disconnect:t.from([i.codes.disconnect<<4,0])}}).call(this)}).call(this,t("buffer").Buffer)},{buffer:17}],39:[function(t,e,i){(function(i){(function(){const n=t("./writeToStream"),o=t("events");class s extends o{constructor(){super(),this._array=new Array(20),this._i=0}write(t){return this._array[this._i++]=t,!0}concat(){let t=0;const e=new Array(this._array.length),n=this._array;let o,s=0;for(o=0;o<n.length&&void 0!==n[o];o++)"string"!=typeof n[o]?e[o]=n[o].length:e[o]=i.byteLength(n[o]),t+=e[o];const a=i.allocUnsafe(t);for(o=0;o<n.length&&void 0!==n[o];o++)"string"!=typeof n[o]?(n[o].copy(a,s),s+=e[o]):(a.write(n[o],s),s+=e[o]);return a}}e.exports=function(t,e){const i=new s;return n(t,i,e),i.concat()}}).call(this)}).call(this,t("buffer").Buffer)},{"./writeToStream":44,buffer:17,events:22}],40:[function(t,e,i){i.parser=t("./parser").parser,i.generate=t("./generate"),i.writeToStream=t("./writeToStream")},{"./generate":39,"./parser":43,"./writeToStream":44}],41:[function(t,e,i){(function(t){(function(){const i={},n=t.isBuffer(t.from([1,2]).subarray(0,1));function o(e){const i=t.allocUnsafe(2);return i.writeUInt8(e>>8,0),i.writeUInt8(255&e,1),i}e.exports={cache:i,generateCache:function(){for(let t=0;t<65536;t++)i[t]=o(t)},generateNumber:o,genBufVariableByteInt:function(e){let i=0,o=0;const s=t.allocUnsafe(4);do{i=e%128|0,(e=e/128|0)>0&&(i|=128),s.writeUInt8(i,o++)}while(e>0&&o<4);return e>0&&(o=0),n?s.subarray(0,o):s.slice(0,o)},generate4ByteBuffer:function(e){const i=t.allocUnsafe(4);return i.writeUInt32BE(e,0),i}}}).call(this)}).call(this,t("buffer").Buffer)},{buffer:17}],42:[function(t,e,i){e.exports=class{constructor(){this.cmd=null,this.retain=!1,this.qos=0,this.dup=!1,this.length=-1,this.topic=null,this.payload=null}}},{}],43:[function(t,e,i){const n=t("bl"),o=t("events"),s=t("./packet"),a=t("./constants"),r=t("debug")("mqtt-packet:parser");class l extends o{constructor(){super(),this.parser=this.constructor.parser}static parser(t){return this instanceof l?(this.settings=t||{},this._states=["_parseHeader","_parseLength","_parsePayload","_newPacket"],this._resetState(),this):(new l).parser(t)}_resetState(){r("_resetState: resetting packet, error, _list, and _stateCounter"),this.packet=new s,this.error=null,this._list=n(),this._stateCounter=0}parse(t){for(this.error&&this._resetState(),this._list.append(t),r("parse: current state: %s",this._states[this._stateCounter]);(-1!==this.packet.length||this._list.length>0)&&this[this._states[this._stateCounter]]()&&!this.error;)this._stateCounter++,r("parse: state complete. _stateCounter is now: %d",this._stateCounter),r("parse: packet.length: %d, buffer list length: %d",this.packet.length,this._list.length),this._stateCounter>=this._states.length&&(this._stateCounter=0);return r("parse: exited while loop. packet: %d, buffer list length: %d",this.packet.length,this._list.length),this._list.length}_parseHeader(){const t=this._list.readUInt8(0);return this.packet.cmd=a.types[t>>a.CMD_SHIFT],this.packet.retain=0!=(t&a.RETAIN_MASK),this.packet.qos=t>>a.QOS_SHIFT&a.QOS_MASK,this.packet.dup=0!=(t&a.DUP_MASK),r("_parseHeader: packet: %o",this.packet),this._list.consume(1),!0}_parseLength(){const t=this._parseVarByteNum(!0);return t&&(this.packet.length=t.value,this._list.consume(t.bytes)),r("_parseLength %d",t.value),!!t}_parsePayload(){r("_parsePayload: payload %O",this._list);let t=!1;if(0===this.packet.length||this._list.length>=this.packet.length){switch(this._pos=0,this.packet.cmd){case"connect":this._parseConnect();break;case"connack":this._parseConnack();break;case"publish":this._parsePublish();break;case"puback":case"pubrec":case"pubrel":case"pubcomp":this._parseConfirmation();break;case"subscribe":this._parseSubscribe();break;case"suback":this._parseSuback();break;case"unsubscribe":this._parseUnsubscribe();break;case"unsuback":this._parseUnsuback();break;case"pingreq":case"pingresp":break;case"disconnect":this._parseDisconnect();break;case"auth":this._parseAuth();break;default:this._emitError(new Error("Not supported"))}t=!0}return r("_parsePayload complete result: %s",t),t}_parseConnect(){let t,e,i,n;r("_parseConnect");const o={},s=this.packet,l=this._parseString();if(null===l)return this._emitError(new Error("Cannot parse protocolId"));if("MQTT"!==l&&"MQIsdp"!==l)return this._emitError(new Error("Invalid protocolId"));if(s.protocolId=l,this._pos>=this._list.length)return this._emitError(new Error("Packet too short"));if(s.protocolVersion=this._list.readUInt8(this._pos),s.protocolVersion>=128&&(s.bridgeMode=!0,s.protocolVersion=s.protocolVersion-128),3!==s.protocolVersion&&4!==s.protocolVersion&&5!==s.protocolVersion)return this._emitError(new Error("Invalid protocol version"));if(this._pos++,this._pos>=this._list.length)return this._emitError(new Error("Packet too short"));if(o.username=this._list.readUInt8(this._pos)&a.USERNAME_MASK,o.password=this._list.readUInt8(this._pos)&a.PASSWORD_MASK,o.will=this._list.readUInt8(this._pos)&a.WILL_FLAG_MASK,o.will&&(s.will={},s.will.retain=0!=(this._list.readUInt8(this._pos)&a.WILL_RETAIN_MASK),s.will.qos=(this._list.readUInt8(this._pos)&a.WILL_QOS_MASK)>>a.WILL_QOS_SHIFT),s.clean=0!=(this._list.readUInt8(this._pos)&a.CLEAN_SESSION_MASK),this._pos++,s.keepalive=this._parseNum(),-1===s.keepalive)return this._emitError(new Error("Packet too short"));if(5===s.protocolVersion){const t=this._parseProperties();Object.getOwnPropertyNames(t).length&&(s.properties=t)}const c=this._parseString();if(null===c)return this._emitError(new Error("Packet too short"));if(s.clientId=c,r("_parseConnect: packet.clientId: %s",s.clientId),o.will){if(5===s.protocolVersion){const t=this._parseProperties();Object.getOwnPropertyNames(t).length&&(s.will.properties=t)}if(null===(t=this._parseString()))return this._emitError(new Error("Cannot parse will topic"));if(s.will.topic=t,r("_parseConnect: packet.will.topic: %s",s.will.topic),null===(e=this._parseBuffer()))return this._emitError(new Error("Cannot parse will payload"));s.will.payload=e,r("_parseConnect: packet.will.paylaod: %s",s.will.payload)}if(o.username){if(null===(n=this._parseString()))return this._emitError(new Error("Cannot parse username"));s.username=n,r("_parseConnect: packet.username: %s",s.username)}if(o.password){if(null===(i=this._parseBuffer()))return this._emitError(new Error("Cannot parse password"));s.password=i}return this.settings=s,r("_parseConnect: complete"),s}_parseConnack(){r("_parseConnack");const t=this.packet;if(this._list.length<1)return null;if(t.sessionPresent=!!(this._list.readUInt8(this._pos++)&a.SESSIONPRESENT_MASK),5===this.settings.protocolVersion)this._list.length>=2?t.reasonCode=this._list.readUInt8(this._pos++):t.reasonCode=0;else{if(this._list.length<2)return null;t.returnCode=this._list.readUInt8(this._pos++)}if(-1===t.returnCode||-1===t.reasonCode)return this._emitError(new Error("Cannot parse return code"));if(5===this.settings.protocolVersion){const e=this._parseProperties();Object.getOwnPropertyNames(e).length&&(t.properties=e)}r("_parseConnack: complete")}_parsePublish(){r("_parsePublish");const t=this.packet;if(t.topic=this._parseString(),null===t.topic)return this._emitError(new Error("Cannot parse topic"));if(!(t.qos>0)||this._parseMessageId()){if(5===this.settings.protocolVersion){const e=this._parseProperties();Object.getOwnPropertyNames(e).length&&(t.properties=e)}t.payload=this._list.slice(this._pos,t.length),r("_parsePublish: payload from buffer list: %o",t.payload)}}_parseSubscribe(){r("_parseSubscribe");const t=this.packet;let e,i,n,o,s,l,c;if(1!==t.qos)return this._emitError(new Error("Wrong subscribe header"));if(t.subscriptions=[],this._parseMessageId()){if(5===this.settings.protocolVersion){const e=this._parseProperties();Object.getOwnPropertyNames(e).length&&(t.properties=e)}for(;this._pos<t.length;){if(null===(e=this._parseString()))return this._emitError(new Error("Cannot parse topic"));if(this._pos>=t.length)return this._emitError(new Error("Malformed Subscribe Payload"));n=(i=this._parseByte())&a.SUBSCRIBE_OPTIONS_QOS_MASK,l=0!=(i>>a.SUBSCRIBE_OPTIONS_NL_SHIFT&a.SUBSCRIBE_OPTIONS_NL_MASK),s=0!=(i>>a.SUBSCRIBE_OPTIONS_RAP_SHIFT&a.SUBSCRIBE_OPTIONS_RAP_MASK),o=i>>a.SUBSCRIBE_OPTIONS_RH_SHIFT&a.SUBSCRIBE_OPTIONS_RH_MASK,c={topic:e,qos:n},5===this.settings.protocolVersion?(c.nl=l,c.rap=s,c.rh=o):this.settings.bridgeMode&&(c.rh=0,c.rap=!0,c.nl=!0),r("_parseSubscribe: push subscription `%s` to subscription",c),t.subscriptions.push(c)}}}_parseSuback(){r("_parseSuback");const t=this.packet;if(this.packet.granted=[],this._parseMessageId()){if(5===this.settings.protocolVersion){const e=this._parseProperties();Object.getOwnPropertyNames(e).length&&(t.properties=e)}for(;this._pos<this.packet.length;)this.packet.granted.push(this._list.readUInt8(this._pos++))}}_parseUnsubscribe(){r("_parseUnsubscribe");const t=this.packet;if(t.unsubscriptions=[],this._parseMessageId()){if(5===this.settings.protocolVersion){const e=this._parseProperties();Object.getOwnPropertyNames(e).length&&(t.properties=e)}for(;this._pos<t.length;){const e=this._parseString();if(null===e)return this._emitError(new Error("Cannot parse topic"));r("_parseUnsubscribe: push topic `%s` to unsubscriptions",e),t.unsubscriptions.push(e)}}}_parseUnsuback(){r("_parseUnsuback");const t=this.packet;if(!this._parseMessageId())return this._emitError(new Error("Cannot parse messageId"));if(5===this.settings.protocolVersion){const e=this._parseProperties();for(Object.getOwnPropertyNames(e).length&&(t.properties=e),t.granted=[];this._pos<this.packet.length;)this.packet.granted.push(this._list.readUInt8(this._pos++))}}_parseConfirmation(){r("_parseConfirmation: packet.cmd: `%s`",this.packet.cmd);const t=this.packet;if(this._parseMessageId(),5===this.settings.protocolVersion&&(t.length>2?(t.reasonCode=this._parseByte(),r("_parseConfirmation: packet.reasonCode `%d`",t.reasonCode)):t.reasonCode=0,t.length>3)){const e=this._parseProperties();Object.getOwnPropertyNames(e).length&&(t.properties=e)}return!0}_parseDisconnect(){const t=this.packet;if(r("_parseDisconnect"),5===this.settings.protocolVersion){this._list.length>0?t.reasonCode=this._parseByte():t.reasonCode=0;const e=this._parseProperties();Object.getOwnPropertyNames(e).length&&(t.properties=e)}return r("_parseDisconnect result: true"),!0}_parseAuth(){r("_parseAuth");const t=this.packet;if(5!==this.settings.protocolVersion)return this._emitError(new Error("Not supported auth packet for this version MQTT"));t.reasonCode=this._parseByte();const e=this._parseProperties();return Object.getOwnPropertyNames(e).length&&(t.properties=e),r("_parseAuth: result: true"),!0}_parseMessageId(){const t=this.packet;return t.messageId=this._parseNum(),null===t.messageId?(this._emitError(new Error("Cannot parse messageId")),!1):(r("_parseMessageId: packet.messageId %d",t.messageId),!0)}_parseString(t){const e=this._parseNum(),i=e+this._pos;if(-1===e||i>this._list.length||i>this.packet.length)return null;const n=this._list.toString("utf8",this._pos,i);return this._pos+=e,r("_parseString: result: %s",n),n}_parseStringPair(){return r("_parseStringPair"),{name:this._parseString(),value:this._parseString()}}_parseBuffer(){const t=this._parseNum(),e=t+this._pos;if(-1===t||e>this._list.length||e>this.packet.length)return null;const i=this._list.slice(this._pos,e);return this._pos+=t,r("_parseBuffer: result: %o",i),i}_parseNum(){if(this._list.length-this._pos<2)return-1;const t=this._list.readUInt16BE(this._pos);return this._pos+=2,r("_parseNum: result: %s",t),t}_parse4ByteNum(){if(this._list.length-this._pos<4)return-1;const t=this._list.readUInt32BE(this._pos);return this._pos+=4,r("_parse4ByteNum: result: %s",t),t}_parseVarByteNum(t){r("_parseVarByteNum");let e,i=0,n=1,o=0,s=!1;const l=this._pos?this._pos:0;for(;i<4&&l+i<this._list.length;){if(o+=n*((e=this._list.readUInt8(l+i++))&a.VARBYTEINT_MASK),n*=128,0==(e&a.VARBYTEINT_FIN_MASK)){s=!0;break}if(this._list.length<=i)break}return!s&&4===i&&this._list.length>=i&&this._emitError(new Error("Invalid variable byte integer")),l&&(this._pos+=i),r("_parseVarByteNum: result: %o",s=!!s&&(t?{bytes:i,value:o}:o)),s}_parseByte(){let t;return this._pos<this._list.length&&(t=this._list.readUInt8(this._pos),this._pos++),r("_parseByte: result: %o",t),t}_parseByType(t){switch(r("_parseByType: type: %s",t),t){case"byte":return 0!==this._parseByte();case"int8":return this._parseByte();case"int16":return this._parseNum();case"int32":return this._parse4ByteNum();case"var":return this._parseVarByteNum();case"string":return this._parseString();case"pair":return this._parseStringPair();case"binary":return this._parseBuffer()}}_parseProperties(){r("_parseProperties");const t=this._parseVarByteNum(),e=this._pos+t,i={};for(;this._pos<e;){const t=this._parseByte();if(!t)return this._emitError(new Error("Cannot parse property code type")),!1;const e=a.propertiesCodes[t];if(!e)return this._emitError(new Error("Unknown property")),!1;if("userProperties"!==e)i[e]?(Array.isArray(i[e])||(i[e]=[i[e]]),i[e].push(this._parseByType(a.propertiesTypes[e]))):i[e]=this._parseByType(a.propertiesTypes[e]);else{i[e]||(i[e]=Object.create(null));const t=this._parseByType(a.propertiesTypes[e]);if(i[e][t.name])if(Array.isArray(i[e][t.name]))i[e][t.name].push(t.value);else{const n=i[e][t.name];i[e][t.name]=[n],i[e][t.name].push(t.value)}else i[e][t.name]=t.value}}return i}_newPacket(){return r("_newPacket"),this.packet&&(this._list.consume(this.packet.length),r("_newPacket: parser emit packet: packet.cmd: %s, packet.payload: %s, packet.length: %d",this.packet.cmd,this.packet.payload,this.packet.length),this.emit("packet",this.packet)),r("_newPacket: new packet"),this.packet=new s,this._pos=0,!0}_emitError(t){r("_emitError"),this.error=t,this.emit("error",t)}}e.exports=l},{"./constants":38,"./packet":42,bl:15,debug:18,events:22}],44:[function(t,e,i){(function(i){(function(){const n=t("./constants"),o=i.allocUnsafe(0),s=i.from([0]),a=t("./numbers"),r=t("process-nextick-args").nextTick,l=t("debug")("mqtt-packet:writeToStream"),c=a.cache,h=a.generateNumber,d=a.generateCache,u=a.genBufVariableByteInt,f=a.generate4ByteBuffer;let p=k,v=!0;function g(t,e,a){switch(l("generate called"),e.cork&&(e.cork(),r(y,e)),v&&(v=!1,d()),l("generate: packet.cmd: %s",t.cmd),t.cmd){case"connect":return function(t,e){const o=t||{},s=o.protocolId||"MQTT";let a=o.protocolVersion||4;const r=o.will;let l=o.clean;const c=o.keepalive||0,h=o.clientId||"",d=o.username,u=o.password,f=o.properties;void 0===l&&(l=!0);let v=0;if(!s||"string"!=typeof s&&!i.isBuffer(s))return e.emit("error",new Error("Invalid protocolId")),!1;if(v+=s.length+2,3!==a&&4!==a&&5!==a)return e.emit("error",new Error("Invalid protocol version")),!1;if(v+=1,("string"==typeof h||i.isBuffer(h))&&(h||a>=4)&&(h||l))v+=i.byteLength(h)+2;else{if(a<4)return e.emit("error",new Error("clientId must be supplied before 3.1.1")),!1;if(1*l==0)return e.emit("error",new Error("clientId must be given if cleanSession set to 0")),!1}if("number"!=typeof c||c<0||c>65535||c%1!=0)return e.emit("error",new Error("Invalid keepalive")),!1;if(v+=2,v+=1,5===a){var g=A(e,f);if(!g)return!1;v+=g.length}if(r){if("object"!=typeof r)return e.emit("error",new Error("Invalid will")),!1;if(!r.topic||"string"!=typeof r.topic)return e.emit("error",new Error("Invalid will topic")),!1;if(v+=i.byteLength(r.topic)+2,v+=2,r.payload){if(!(r.payload.length>=0))return e.emit("error",new Error("Invalid will payload")),!1;"string"==typeof r.payload?v+=i.byteLength(r.payload):v+=r.payload.length}var y={};if(5===a){if(!(y=A(e,r.properties)))return!1;v+=y.length}}let m=!1;if(null!=d){if(!E(d))return e.emit("error",new Error("Invalid username")),!1;m=!0,v+=i.byteLength(d)+2}if(null!=u){if(!m)return e.emit("error",new Error("Username is required to use password")),!1;if(!E(u))return e.emit("error",new Error("Invalid password")),!1;v+=I(u)+2}e.write(n.CONNECT_HEADER),w(e,v),C(e,s),o.bridgeMode&&(a+=128),e.write(131===a?n.VERSION131:132===a?n.VERSION132:4===a?n.VERSION4:5===a?n.VERSION5:n.VERSION3);let b=0;return b|=null!=d?n.USERNAME_MASK:0,b|=null!=u?n.PASSWORD_MASK:0,b|=r&&r.retain?n.WILL_RETAIN_MASK:0,b|=r&&r.qos?r.qos<<n.WILL_QOS_SHIFT:0,b|=r?n.WILL_FLAG_MASK:0,b|=l?n.CLEAN_SESSION_MASK:0,e.write(i.from([b])),p(e,c),5===a&&g.write(),C(e,h),r&&(5===a&&y.write(),x(e,r.topic),C(e,r.payload)),null!=d&&C(e,d),null!=u&&C(e,u),!0}(t,e);case"connack":return function(t,e,o){const a=o?o.protocolVersion:4,r=t||{},l=5===a?r.reasonCode:r.returnCode,c=r.properties;let h=2;if("number"!=typeof l)return e.emit("error",new Error("Invalid return code")),!1;let d=null;if(5===a){if(!(d=A(e,c)))return!1;h+=d.length}return e.write(n.CONNACK_HEADER),w(e,h),e.write(r.sessionPresent?n.SESSIONPRESENT_HEADER:s),e.write(i.from([l])),null!=d&&d.write(),!0}(t,e,a);case"publish":return function(t,e,s){l("publish: packet: %o",t);const a=s?s.protocolVersion:4,r=t||{},c=r.qos||0,h=r.retain?n.RETAIN_MASK:0,d=r.topic,u=r.payload||o,f=r.messageId,v=r.properties;let g=0;if("string"==typeof d)g+=i.byteLength(d)+2;else{if(!i.isBuffer(d))return e.emit("error",new Error("Invalid topic")),!1;g+=d.length+2}if(i.isBuffer(u)?g+=u.length:g+=i.byteLength(u),c&&"number"!=typeof f)return e.emit("error",new Error("Invalid messageId")),!1;c&&(g+=2);let y=null;if(5===a){if(!(y=A(e,v)))return!1;g+=y.length}return e.write(n.PUBLISH_HEADER[c][r.dup?1:0][h?1:0]),w(e,g),p(e,I(d)),e.write(d),c>0&&p(e,f),null!=y&&y.write(),l("publish: payload: %o",u),e.write(u)}(t,e,a);case"puback":case"pubrec":case"pubrel":case"pubcomp":return function(t,e,o){const s=o?o.protocolVersion:4,a=t||{},r=a.cmd||"puback",l=a.messageId,c=a.dup&&"pubrel"===r?n.DUP_MASK:0;let h=0;const d=a.reasonCode,u=a.properties;let f=5===s?3:2;if("pubrel"===r&&(h=1),"number"!=typeof l)return e.emit("error",new Error("Invalid messageId")),!1;let v=null;if(5===s&&"object"==typeof u){if(!(v=R(e,u,o,f)))return!1;f+=v.length}return e.write(n.ACKS[r][h][c][0]),w(e,f),p(e,l),5===s&&e.write(i.from([d])),null!==v&&v.write(),!0}(t,e,a);case"subscribe":return function(t,e,o){l("subscribe: packet: ");const s=o?o.protocolVersion:4,a=t||{},r=a.dup?n.DUP_MASK:0,c=a.messageId,h=a.subscriptions,d=a.properties;let u=0;if("number"!=typeof c)return e.emit("error",new Error("Invalid messageId")),!1;u+=2;let f=null;if(5===s){if(!(f=A(e,d)))return!1;u+=f.length}if("object"!=typeof h||!h.length)return e.emit("error",new Error("Invalid subscriptions")),!1;for(let t=0;t<h.length;t+=1){const n=h[t].topic,o=h[t].qos;if("string"!=typeof n)return e.emit("error",new Error("Invalid subscriptions - invalid topic")),!1;if("number"!=typeof o)return e.emit("error",new Error("Invalid subscriptions - invalid qos")),!1;if(5===s){if("boolean"!=typeof(h[t].nl||!1))return e.emit("error",new Error("Invalid subscriptions - invalid No Local")),!1;if("boolean"!=typeof(h[t].rap||!1))return e.emit("error",new Error("Invalid subscriptions - invalid Retain as Published")),!1;const i=h[t].rh||0;if("number"!=typeof i||i>2)return e.emit("error",new Error("Invalid subscriptions - invalid Retain Handling")),!1}u+=i.byteLength(n)+2+1}l("subscribe: writing to stream: %o",n.SUBSCRIBE_HEADER),e.write(n.SUBSCRIBE_HEADER[1][r?1:0][0]),w(e,u),p(e,c),null!==f&&f.write();let v=!0;for(const t of h){const o=t.topic,a=t.qos,r=+t.nl,l=+t.rap,c=t.rh;let h;x(e,o),h=n.SUBSCRIBE_OPTIONS_QOS[a],5===s&&(h|=r?n.SUBSCRIBE_OPTIONS_NL:0,h|=l?n.SUBSCRIBE_OPTIONS_RAP:0,h|=c?n.SUBSCRIBE_OPTIONS_RH[c]:0),v=e.write(i.from([h]))}return v}(t,e,a);case"suback":return function(t,e,o){const s=o?o.protocolVersion:4,a=t||{},r=a.messageId,l=a.granted,c=a.properties;let h=0;if("number"!=typeof r)return e.emit("error",new Error("Invalid messageId")),!1;if(h+=2,"object"!=typeof l||!l.length)return e.emit("error",new Error("Invalid qos vector")),!1;for(let t=0;t<l.length;t+=1){if("number"!=typeof l[t])return e.emit("error",new Error("Invalid qos vector")),!1;h+=1}let d=null;if(5===s){if(!(d=R(e,c,o,h)))return!1;h+=d.length}return e.write(n.SUBACK_HEADER),w(e,h),p(e,r),null!==d&&d.write(),e.write(i.from(l))}(t,e,a);case"unsubscribe":return function(t,e,o){const s=o?o.protocolVersion:4,a=t||{},r=a.messageId,l=a.dup?n.DUP_MASK:0,c=a.unsubscriptions,h=a.properties;let d=0;if("number"!=typeof r)return e.emit("error",new Error("Invalid messageId")),!1;if(d+=2,"object"!=typeof c||!c.length)return e.emit("error",new Error("Invalid unsubscriptions")),!1;for(let t=0;t<c.length;t+=1){if("string"!=typeof c[t])return e.emit("error",new Error("Invalid unsubscriptions")),!1;d+=i.byteLength(c[t])+2}let u=null;if(5===s){if(!(u=A(e,h)))return!1;d+=u.length}e.write(n.UNSUBSCRIBE_HEADER[1][l?1:0][0]),w(e,d),p(e,r),null!==u&&u.write();let f=!0;for(let t=0;t<c.length;t++)f=x(e,c[t]);return f}(t,e,a);case"unsuback":return function(t,e,o){const s=o?o.protocolVersion:4,a=t||{},r=a.messageId,l=a.dup?n.DUP_MASK:0,c=a.granted,h=a.properties,d=a.cmd;let u=2;if("number"!=typeof r)return e.emit("error",new Error("Invalid messageId")),!1;if(5===s){if("object"!=typeof c||!c.length)return e.emit("error",new Error("Invalid qos vector")),!1;for(let t=0;t<c.length;t+=1){if("number"!=typeof c[t])return e.emit("error",new Error("Invalid qos vector")),!1;u+=1}}let f=null;if(5===s){if(!(f=R(e,h,o,u)))return!1;u+=f.length}return e.write(n.ACKS[d][0][l][0]),w(e,u),p(e,r),null!==f&&f.write(),5===s&&e.write(i.from(c)),!0}(t,e,a);case"pingreq":case"pingresp":return function(t,e){return e.write(n.EMPTY[t.cmd])}(t,e);case"disconnect":return function(t,e,o){const s=o?o.protocolVersion:4,a=t||{},r=a.reasonCode,l=a.properties;let c=5===s?1:0,h=null;if(5===s){if(!(h=R(e,l,o,c)))return!1;c+=h.length}return e.write(i.from([n.codes.disconnect<<4])),w(e,c),5===s&&e.write(i.from([r])),null!==h&&h.write(),!0}(t,e,a);case"auth":return function(t,e,o){const s=o?o.protocolVersion:4,a=t||{},r=a.reasonCode,l=a.properties;let c=5===s?1:0;5!==s&&e.emit("error",new Error("Invalid mqtt version for auth packet"));const h=R(e,l,o,c);return!!h&&(c+=h.length,e.write(i.from([n.codes.auth<<4])),w(e,c),e.write(i.from([r])),null!==h&&h.write(),!0)}(t,e,a);default:return e.emit("error",new Error("Unknown command")),!1}}function y(t){t.uncork()}Object.defineProperty(g,"cacheNumbers",{get:()=>p===k,set(t){t?(c&&0!==Object.keys(c).length||(v=!0),p=k):(v=!1,p=T)}});const m={};function w(t,e){if(e>n.VARBYTEINT_MAX)return t.emit("error",new Error(`Invalid variable byte integer: ${e}`)),!1;let i=m[e];return i||(i=u(e),e<16384&&(m[e]=i)),l("writeVarByteInt: writing to stream: %o",i),t.write(i)}function x(t,e){const n=i.byteLength(e);return p(t,n),l("writeString: %s",e),t.write(e,"utf8")}function b(t,e,i){x(t,e),x(t,i)}function k(t,e){return l("writeNumberCached: number: %d",e),l("writeNumberCached: %o",c[e]),t.write(c[e])}function T(t,e){const i=h(e);return l("writeNumberGenerated: %o",i),t.write(i)}function C(t,e){"string"==typeof e?x(t,e):e?(p(t,e.length),t.write(e)):p(t,0)}function A(t,e){if("object"!=typeof e||null!=e.length)return{length:1,write(){P(t,{},0)}};let o=0;function s(e,o){let s=0;switch(n.propertiesTypes[e]){case"byte":if("boolean"!=typeof o)return t.emit("error",new Error(`Invalid ${e}: ${o}`)),!1;s+=2;break;case"int8":if("number"!=typeof o||o<0||o>255)return t.emit("error",new Error(`Invalid ${e}: ${o}`)),!1;s+=2;break;case"binary":if(o&&null===o)return t.emit("error",new Error(`Invalid ${e}: ${o}`)),!1;s+=1+i.byteLength(o)+2;break;case"int16":if("number"!=typeof o||o<0||o>65535)return t.emit("error",new Error(`Invalid ${e}: ${o}`)),!1;s+=3;break;case"int32":if("number"!=typeof o||o<0||o>4294967295)return t.emit("error",new Error(`Invalid ${e}: ${o}`)),!1;s+=5;break;case"var":if("number"!=typeof o||o<0||o>268435455)return t.emit("error",new Error(`Invalid ${e}: ${o}`)),!1;s+=1+i.byteLength(u(o));break;case"string":if("string"!=typeof o)return t.emit("error",new Error(`Invalid ${e}: ${o}`)),!1;s+=3+i.byteLength(o.toString());break;case"pair":if("object"!=typeof o)return t.emit("error",new Error(`Invalid ${e}: ${o}`)),!1;s+=Object.getOwnPropertyNames(o).reduce((t,e)=>{const n=o[e];return Array.isArray(n)?t+=n.reduce((t,n)=>t+(3+i.byteLength(e.toString())+2+i.byteLength(n.toString())),0):t+=3+i.byteLength(e.toString())+2+i.byteLength(o[e].toString()),t},0);break;default:return t.emit("error",new Error(`Invalid property ${e}: ${o}`)),!1}return s}if(e)for(const t in e){let i=0,n=0;const a=e[t];if(Array.isArray(a))for(let e=0;e<a.length;e++){if(!(n=s(t,a[e])))return!1;i+=n}else{if(!(n=s(t,a)))return!1;i=n}if(!i)return!1;o+=i}return{length:i.byteLength(u(o))+o,write(){P(t,e,o)}}}function R(t,e,i,n){const o=["reasonString","userProperties"],s=i&&i.properties&&i.properties.maximumPacketSize?i.properties.maximumPacketSize:0;let a=A(t,e);if(s)for(;n+a.length>s;){const i=o.shift();if(!i||!e[i])return!1;delete e[i],a=A(t,e)}return a}function S(t,e,o){switch(n.propertiesTypes[e]){case"byte":t.write(i.from([n.properties[e]])),t.write(i.from([+o]));break;case"int8":t.write(i.from([n.properties[e]])),t.write(i.from([o]));break;case"binary":t.write(i.from([n.properties[e]])),C(t,o);break;case"int16":t.write(i.from([n.properties[e]])),p(t,o);break;case"int32":t.write(i.from([n.properties[e]])),function(t,e){const i=f(e);l("write4ByteNumber: %o",i),t.write(i)}(t,o);break;case"var":t.write(i.from([n.properties[e]])),w(t,o);break;case"string":t.write(i.from([n.properties[e]])),x(t,o);break;case"pair":Object.getOwnPropertyNames(o).forEach(s=>{const a=o[s];Array.isArray(a)?a.forEach(o=>{t.write(i.from([n.properties[e]])),b(t,s.toString(),o.toString())}):(t.write(i.from([n.properties[e]])),b(t,s.toString(),a.toString()))});break;default:return t.emit("error",new Error(`Invalid property ${e} value: ${o}`)),!1}}function P(t,e,i){w(t,i);for(const i in e)if(Object.prototype.hasOwnProperty.call(e,i)&&null!==e[i]){const n=e[i];if(Array.isArray(n))for(let e=0;e<n.length;e++)S(t,i,n[e]);else S(t,i,n)}}function I(t){return t?t instanceof i?t.length:i.byteLength(t):0}function E(t){return"string"==typeof t||t instanceof i}e.exports=g}).call(this)}).call(this,t("buffer").Buffer)},{"./constants":38,"./numbers":41,buffer:17,debug:18,"process-nextick-args":49}],45:[function(t,e,i){var n=1e3,o=60*n,s=60*o,a=24*s,r=7*a;function l(t,e,i,n){var o=e>=1.5*i;return Math.round(t/i)+" "+n+(o?"s":"")}e.exports=function(t,e){e=e||{};var i=typeof t;if("string"===i&&t.length>0)return function(t){if(!((t=String(t)).length>100)){var e=/^(-?(?:\d+)?\.?\d+) *(milliseconds?|msecs?|ms|seconds?|secs?|s|minutes?|mins?|m|hours?|hrs?|h|days?|d|weeks?|w|years?|yrs?|y)?$/i.exec(t);if(e){var i=parseFloat(e[1]);switch((e[2]||"ms").toLowerCase()){case"years":case"year":case"yrs":case"yr":case"y":return 315576e5*i;case"weeks":case"week":case"w":return i*r;case"days":case"day":case"d":return i*a;case"hours":case"hour":case"hrs":case"hr":case"h":return i*s;case"minutes":case"minute":case"mins":case"min":case"m":return i*o;case"seconds":case"second":case"secs":case"sec":case"s":return i*n;case"milliseconds":case"millisecond":case"msecs":case"msec":case"ms":return i;default:return}}}}(t);if("number"===i&&isFinite(t))return e.long?function(t){var e=Math.abs(t);return e>=a?l(t,e,a,"day"):e>=s?l(t,e,s,"hour"):e>=o?l(t,e,o,"minute"):e>=n?l(t,e,n,"second"):t+" ms"}(t):function(t){var e=Math.abs(t);return e>=a?Math.round(t/a)+"d":e>=s?Math.round(t/s)+"h":e>=o?Math.round(t/o)+"m":e>=n?Math.round(t/n)+"s":t+"ms"}(t);throw new Error("val is not a non-empty string or a valid number. val="+JSON.stringify(t))}},{}],46:[function(t,e,i){const n=t("./lib/number-allocator.js");e.exports.NumberAllocator=n},{"./lib/number-allocator.js":47}],47:[function(t,e,i){"use strict";const n=t("js-sdsl").Set,o=t("debug")("number-allocator:trace"),s=t("debug")("number-allocator:error");function a(t,e){this.low=t,this.high=e}function r(t,e){if(!(this instanceof r))return new r(t,e);this.min=t,this.max=e,this.ss=new n([],(t,e)=>t.compare(e)),o("Create"),this.clear()}a.prototype.equals=function(t){return this.low===t.low&&this.high===t.high},a.prototype.compare=function(t){return this.low<t.low&&this.high<t.low?-1:t.low<this.low&&t.high<this.low?1:0},r.prototype.firstVacant=function(){return 0===this.ss.size()?null:this.ss.front().low},r.prototype.alloc=function(){if(0===this.ss.size())return o("alloc():empty"),null;const t=this.ss.front(),e=t.low;return e+1<=t.high?++t.low:this.ss.eraseElementByPos(0),o("alloc():"+e),e},r.prototype.use=function(t){const e=new a(t,t),i=this.ss.lowerBound(e);if(i){if(i.equals(e))return this.ss.eraseElementByValue(i),o("use():"+t),!0;if(i.low>t)return!1;if(i.low===t)return++i.low,o("use():"+t),!0;if(i.high===t)return--i.high,o("use():"+t),!0;const n=i.low;return i.low=t+1,this.ss.insert(new a(n,t-1)),o("use():"+t),!0}return o("use():failed"),!1},r.prototype.free=function(t){if(t<this.min||t>this.max)return void s("free():"+t+" is out of range");const e=new a(t,t),i=this.ss.lowerBound(e);if(i){if(i.low<=t&&t<=i.high)return void s("free():"+t+" has already been vacant");if(i===this.ss.front())t+1===i.low?--i.low:this.ss.insert(e);else{const n=this.ss.reverseLowerBound(e);n.high+1===t?t+1===i.low?(this.ss.eraseElementByValue(n),i.low=n.low):n.high=t:t+1===i.low?i.low=t:this.ss.insert(e)}}else{if(i===this.ss.front())return void this.ss.insert(e);const n=this.ss.reverseLowerBound(e);n.high+1===t?n.high=t:this.ss.insert(e)}o("free():"+t)},r.prototype.clear=function(){o("clear()"),this.ss.clear(),this.ss.insert(new a(this.min,this.max))},r.prototype.intervalCount=function(){return this.ss.size()},r.prototype.dump=function(){console.log("length:"+this.ss.size());for(const t of this.ss)console.log(t)},e.exports=r},{debug:18,"js-sdsl":36}],48:[function(t,e,i){var n=t("wrappy");function o(t){var e=function(){return e.called?e.value:(e.called=!0,e.value=t.apply(this,arguments))};return e.called=!1,e}function s(t){var e=function(){if(e.called)throw new Error(e.onceError);return e.called=!0,e.value=t.apply(this,arguments)},i=t.name||"Function wrapped with `once`";return e.onceError=i+" shouldn't be called more than once",e.called=!1,e}e.exports=n(o),e.exports.strict=n(s),o.proto=o(function(){Object.defineProperty(Function.prototype,"once",{value:function(){return o(this)},configurable:!0}),Object.defineProperty(Function.prototype,"onceStrict",{value:function(){return s(this)},configurable:!0})})},{wrappy:79}],49:[function(t,e,i){(function(t){(function(){"use strict";void 0===t||!t.version||0===t.version.indexOf("v0.")||0===t.version.indexOf("v1.")&&0!==t.version.indexOf("v1.8.")?e.exports={nextTick:function(e,i,n,o){if("function"!=typeof e)throw new TypeError('"callback" argument must be a function');var s,a,r=arguments.length;switch(r){case 0:case 1:return t.nextTick(e);case 2:return t.nextTick(function(){e.call(null,i)});case 3:return t.nextTick(function(){e.call(null,i,n)});case 4:return t.nextTick(function(){e.call(null,i,n,o)});default:for(s=new Array(r-1),a=0;a<s.length;)s[a++]=arguments[a];return t.nextTick(function(){e.apply(null,s)})}}}:e.exports=t}).call(this)}).call(this,t("_process"))},{_process:50}],50:[function(t,e,i){var n,o,s=e.exports={};function a(){throw new Error("setTimeout has not been defined")}function r(){throw new Error("clearTimeout has not been defined")}function l(t){if(n===setTimeout)return setTimeout(t,0);if((n===a||!n)&&setTimeout)return n=setTimeout,setTimeout(t,0);try{return n(t,0)}catch(e){try{return n.call(null,t,0)}catch(e){return n.call(this,t,0)}}}!function(){try{n="function"==typeof setTimeout?setTimeout:a}catch(t){n=a}try{o="function"==typeof clearTimeout?clearTimeout:r}catch(t){o=r}}();var c,h=[],d=!1,u=-1;function f(){d&&c&&(d=!1,c.length?h=c.concat(h):u=-1,h.length&&p())}function p(){if(!d){var t=l(f);d=!0;for(var e=h.length;e;){for(c=h,h=[];++u<e;)c&&c[u].run();u=-1,e=h.length}c=null,d=!1,function(t){if(o===clearTimeout)return clearTimeout(t);if((o===r||!o)&&clearTimeout)return o=clearTimeout,clearTimeout(t);try{o(t)}catch(e){try{return o.call(null,t)}catch(e){return o.call(this,t)}}}(t)}}function v(t,e){this.fun=t,this.array=e}function g(){}s.nextTick=function(t){var e=new Array(arguments.length-1);if(arguments.length>1)for(var i=1;i<arguments.length;i++)e[i-1]=arguments[i];h.push(new v(t,e)),1!==h.length||d||l(p)},v.prototype.run=function(){this.fun.apply(null,this.array)},s.title="browser",s.browser=!0,s.env={},s.argv=[],s.version="",s.versions={},s.on=g,s.addListener=g,s.once=g,s.off=g,s.removeListener=g,s.removeAllListeners=g,s.emit=g,s.prependListener=g,s.prependOnceListener=g,s.listeners=function(t){return[]},s.binding=function(t){throw new Error("process.binding is not supported")},s.cwd=function(){return"/"},s.chdir=function(t){throw new Error("process.chdir is not supported")},s.umask=function(){return 0}},{}],51:[function(t,e,n){(function(t){(function(){!function(i){var o="object"==typeof n&&n&&!n.nodeType&&n,s="object"==typeof e&&e&&!e.nodeType&&e,a="object"==typeof t&&t;a.global!==a&&a.window!==a&&a.self!==a||(i=a);var r,l,c=2147483647,h=36,d=/^xn--/,u=/[^\x20-\x7E]/,f=/[\x2E\u3002\uFF0E\uFF61]/g,p={overflow:"Overflow: input needs wider integers to process","not-basic":"Illegal input >= 0x80 (not a basic code point)","invalid-input":"Invalid input"},v=Math.floor,g=String.fromCharCode;function y(t){throw new RangeError(p[t])}function m(t,e){for(var i=t.length,n=[];i--;)n[i]=e(t[i]);return n}function w(t,e){var i=t.split("@"),n="";return i.length>1&&(n=i[0]+"@",t=i[1]),n+m((t=t.replace(f,".")).split("."),e).join(".")}function x(t){for(var e,i,n=[],o=0,s=t.length;o<s;)(e=t.charCodeAt(o++))>=55296&&e<=56319&&o<s?56320==(64512&(i=t.charCodeAt(o++)))?n.push(((1023&e)<<10)+(1023&i)+65536):(n.push(e),o--):n.push(e);return n}function b(t){return m(t,function(t){var e="";return t>65535&&(e+=g((t-=65536)>>>10&1023|55296),t=56320|1023&t),e+g(t)}).join("")}function k(t,e){return t+22+75*(t<26)-((0!=e)<<5)}function T(t,e,i){var n=0;for(t=i?v(t/700):t>>1,t+=v(t/e);t>455;n+=h)t=v(t/35);return v(n+36*t/(t+38))}function C(t){var e,i,n,o,s,a,r,l,d,u,f,p=[],g=t.length,m=0,w=128,x=72;for((i=t.lastIndexOf("-"))<0&&(i=0),n=0;n<i;++n)t.charCodeAt(n)>=128&&y("not-basic"),p.push(t.charCodeAt(n));for(o=i>0?i+1:0;o<g;){for(s=m,a=1,r=h;o>=g&&y("invalid-input"),((l=(f=t.charCodeAt(o++))-48<10?f-22:f-65<26?f-65:f-97<26?f-97:h)>=h||l>v((c-m)/a))&&y("overflow"),m+=l*a,!(l<(d=r<=x?1:r>=x+26?26:r-x));r+=h)a>v(c/(u=h-d))&&y("overflow"),a*=u;x=T(m-s,e=p.length+1,0==s),v(m/e)>c-w&&y("overflow"),w+=v(m/e),m%=e,p.splice(m++,0,w)}return b(p)}function A(t){var e,i,n,o,s,a,r,l,d,u,f,p,m,w,b,C=[];for(p=(t=x(t)).length,e=128,i=0,s=72,a=0;a<p;++a)(f=t[a])<128&&C.push(g(f));for(n=o=C.length,o&&C.push("-");n<p;){for(r=c,a=0;a<p;++a)(f=t[a])>=e&&f<r&&(r=f);for(r-e>v((c-i)/(m=n+1))&&y("overflow"),i+=(r-e)*m,e=r,a=0;a<p;++a)if((f=t[a])<e&&++i>c&&y("overflow"),f==e){for(l=i,d=h;!(l<(u=d<=s?1:d>=s+26?26:d-s));d+=h)b=l-u,w=h-u,C.push(g(k(u+b%w,0))),l=v(b/w);C.push(g(k(l,0))),s=T(i,m,n==o),i=0,++n}++i,++e}return C.join("")}if(r={version:"1.4.1",ucs2:{decode:x,encode:b},decode:C,encode:A,toASCII:function(t){return w(t,function(t){return u.test(t)?"xn--"+A(t):t})},toUnicode:function(t){return w(t,function(t){return d.test(t)?C(t.slice(4).toLowerCase()):t})}},o&&s)if(e.exports==o)s.exports=r;else for(l in r)r.hasOwnProperty(l)&&(o[l]=r[l]);else i.punycode=r}(this)}).call(this)}).call(this,void 0!==i.g?i.g:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{}],52:[function(t,e,i){"use strict";function n(t,e){return Object.prototype.hasOwnProperty.call(t,e)}e.exports=function(t,e,i,s){e=e||"&",i=i||"=";var a={};if("string"!=typeof t||0===t.length)return a;var r=/\+/g;t=t.split(e);var l=1e3;s&&"number"==typeof s.maxKeys&&(l=s.maxKeys);var c=t.length;l>0&&c>l&&(c=l);for(var h=0;h<c;++h){var d,u,f,p,v=t[h].replace(r,"%20"),g=v.indexOf(i);g>=0?(d=v.substr(0,g),u=v.substr(g+1)):(d=v,u=""),f=decodeURIComponent(d),p=decodeURIComponent(u),n(a,f)?o(a[f])?a[f].push(p):a[f]=[a[f],p]:a[f]=p}return a};var o=Array.isArray||function(t){return"[object Array]"===Object.prototype.toString.call(t)}},{}],53:[function(t,e,i){"use strict";var n=function(t){switch(typeof t){case"string":return t;case"boolean":return t?"true":"false";case"number":return isFinite(t)?t:"";default:return""}};e.exports=function(t,e,i,r){return e=e||"&",i=i||"=",null===t&&(t=void 0),"object"==typeof t?s(a(t),function(a){var r=encodeURIComponent(n(a))+i;return o(t[a])?s(t[a],function(t){return r+encodeURIComponent(n(t))}).join(e):r+encodeURIComponent(n(t[a]))}).join(e):r?encodeURIComponent(n(r))+i+encodeURIComponent(n(t)):""};var o=Array.isArray||function(t){return"[object Array]"===Object.prototype.toString.call(t)};function s(t,e){if(t.map)return t.map(e);for(var i=[],n=0;n<t.length;n++)i.push(e(t[n],n));return i}var a=Object.keys||function(t){var e=[];for(var i in t)Object.prototype.hasOwnProperty.call(t,i)&&e.push(i);return e}},{}],54:[function(t,e,i){"use strict";i.decode=i.parse=t("./decode"),i.encode=i.stringify=t("./encode")},{"./decode":52,"./encode":53}],55:[function(t,e,i){"use strict";var n={};function o(t,e,i){i||(i=Error);var o=function(t){var i,n;function o(i,n,o){return t.call(this,function(t,i,n){return"string"==typeof e?e:e(t,i,n)}(i,n,o))||this}return n=t,(i=o).prototype=Object.create(n.prototype),i.prototype.constructor=i,i.__proto__=n,o}(i);o.prototype.name=i.name,o.prototype.code=t,n[t]=o}function s(t,e){if(Array.isArray(t)){var i=t.length;return t=t.map(function(t){return String(t)}),i>2?"one of ".concat(e," ").concat(t.slice(0,i-1).join(", "),", or ")+t[i-1]:2===i?"one of ".concat(e," ").concat(t[0]," or ").concat(t[1]):"of ".concat(e," ").concat(t[0])}return"of ".concat(e," ").concat(String(t))}o("ERR_INVALID_OPT_VALUE",function(t,e){return'The value "'+e+'" is invalid for option "'+t+'"'},TypeError),o("ERR_INVALID_ARG_TYPE",function(t,e,i){var n,o,a;if("string"==typeof e&&(o="not ",e.substr(0,4)===o)?(n="must not be",e=e.replace(/^not /,"")):n="must be",function(t,e,i){return(void 0===i||i>t.length)&&(i=t.length),t.substring(i-9,i)===e}(t," argument"))a="The ".concat(t," ").concat(n," ").concat(s(e,"type"));else{var r=function(t,e,i){return"number"!=typeof i&&(i=0),!(i+1>t.length)&&-1!==t.indexOf(".",i)}(t)?"property":"argument";a='The "'.concat(t,'" ').concat(r," ").concat(n," ").concat(s(e,"type"))}return a+". Received type ".concat(typeof i)},TypeError),o("ERR_STREAM_PUSH_AFTER_EOF","stream.push() after EOF"),o("ERR_METHOD_NOT_IMPLEMENTED",function(t){return"The "+t+" method is not implemented"}),o("ERR_STREAM_PREMATURE_CLOSE","Premature close"),o("ERR_STREAM_DESTROYED",function(t){return"Cannot call "+t+" after a stream was destroyed"}),o("ERR_MULTIPLE_CALLBACK","Callback called multiple times"),o("ERR_STREAM_CANNOT_PIPE","Cannot pipe, not readable"),o("ERR_STREAM_WRITE_AFTER_END","write after end"),o("ERR_STREAM_NULL_VALUES","May not write null values to stream",TypeError),o("ERR_UNKNOWN_ENCODING",function(t){return"Unknown encoding: "+t},TypeError),o("ERR_STREAM_UNSHIFT_AFTER_END_EVENT","stream.unshift() after end event"),e.exports.codes=n},{}],56:[function(t,e,i){(function(i){(function(){"use strict";var n=Object.keys||function(t){var e=[];for(var i in t)e.push(i);return e};e.exports=c;var o=t("./_stream_readable"),s=t("./_stream_writable");t("inherits")(c,o);for(var a=n(s.prototype),r=0;r<a.length;r++){var l=a[r];c.prototype[l]||(c.prototype[l]=s.prototype[l])}function c(t){if(!(this instanceof c))return new c(t);o.call(this,t),s.call(this,t),this.allowHalfOpen=!0,t&&(!1===t.readable&&(this.readable=!1),!1===t.writable&&(this.writable=!1),!1===t.allowHalfOpen&&(this.allowHalfOpen=!1,this.once("end",h)))}function h(){this._writableState.ended||i.nextTick(d,this)}function d(t){t.end()}Object.defineProperty(c.prototype,"writableHighWaterMark",{enumerable:!1,get:function(){return this._writableState.highWaterMark}}),Object.defineProperty(c.prototype,"writableBuffer",{enumerable:!1,get:function(){return this._writableState&&this._writableState.getBuffer()}}),Object.defineProperty(c.prototype,"writableLength",{enumerable:!1,get:function(){return this._writableState.length}}),Object.defineProperty(c.prototype,"destroyed",{enumerable:!1,get:function(){return void 0!==this._readableState&&void 0!==this._writableState&&this._readableState.destroyed&&this._writableState.destroyed},set:function(t){void 0!==this._readableState&&void 0!==this._writableState&&(this._readableState.destroyed=t,this._writableState.destroyed=t)}})}).call(this)}).call(this,t("_process"))},{"./_stream_readable":58,"./_stream_writable":60,_process:50,inherits:24}],57:[function(t,e,i){"use strict";e.exports=o;var n=t("./_stream_transform");function o(t){if(!(this instanceof o))return new o(t);n.call(this,t)}t("inherits")(o,n),o.prototype._transform=function(t,e,i){i(null,t)}},{"./_stream_transform":59,inherits:24}],58:[function(t,e,n){(function(i,n){(function(){"use strict";var o;e.exports=A,A.ReadableState=C,t("events").EventEmitter;var s,a=function(t,e){return t.listeners(e).length},r=t("./internal/streams/stream"),l=t("buffer").Buffer,c=n.Uint8Array||function(){},h=t("util");s=h&&h.debuglog?h.debuglog("stream"):function(){};var d,u,f,p=t("./internal/streams/buffer_list"),v=t("./internal/streams/destroy"),g=t("./internal/streams/state").getHighWaterMark,y=t("../errors").codes,m=y.ERR_INVALID_ARG_TYPE,w=y.ERR_STREAM_PUSH_AFTER_EOF,x=y.ERR_METHOD_NOT_IMPLEMENTED,b=y.ERR_STREAM_UNSHIFT_AFTER_END_EVENT;t("inherits")(A,r);var k=v.errorOrDestroy,T=["error","close","destroy","pause","resume"];function C(e,i,n){o=o||t("./_stream_duplex"),e=e||{},"boolean"!=typeof n&&(n=i instanceof o),this.objectMode=!!e.objectMode,n&&(this.objectMode=this.objectMode||!!e.readableObjectMode),this.highWaterMark=g(this,e,"readableHighWaterMark",n),this.buffer=new p,this.length=0,this.pipes=null,this.pipesCount=0,this.flowing=null,this.ended=!1,this.endEmitted=!1,this.reading=!1,this.sync=!0,this.needReadable=!1,this.emittedReadable=!1,this.readableListening=!1,this.resumeScheduled=!1,this.paused=!0,this.emitClose=!1!==e.emitClose,this.autoDestroy=!!e.autoDestroy,this.destroyed=!1,this.defaultEncoding=e.defaultEncoding||"utf8",this.awaitDrain=0,this.readingMore=!1,this.decoder=null,this.encoding=null,e.encoding&&(d||(d=t("string_decoder/").StringDecoder),this.decoder=new d(e.encoding),this.encoding=e.encoding)}function A(e){if(o=o||t("./_stream_duplex"),!(this instanceof A))return new A(e);var i=this instanceof o;this._readableState=new C(e,this,i),this.readable=!0,e&&("function"==typeof e.read&&(this._read=e.read),"function"==typeof e.destroy&&(this._destroy=e.destroy)),r.call(this)}function R(t,e,i,n,o){s("readableAddChunk",e);var a,r=t._readableState;if(null===e)r.reading=!1,function(t,e){if(s("onEofChunk"),!e.ended){if(e.decoder){var i=e.decoder.end();i&&i.length&&(e.buffer.push(i),e.length+=e.objectMode?1:i.length)}e.ended=!0,e.sync?E(t):(e.needReadable=!1,e.emittedReadable||(e.emittedReadable=!0,_(t)))}}(t,r);else if(o||(a=function(t,e){var i,n;return n=e,l.isBuffer(n)||n instanceof c||"string"==typeof e||void 0===e||t.objectMode||(i=new m("chunk",["string","Buffer","Uint8Array"],e)),i}(r,e)),a)k(t,a);else if(r.objectMode||e&&e.length>0)if("string"==typeof e||r.objectMode||Object.getPrototypeOf(e)===l.prototype||(e=function(t){return l.from(t)}(e)),n)r.endEmitted?k(t,new b):S(t,r,e,!0);else if(r.ended)k(t,new w);else{if(r.destroyed)return!1;r.reading=!1,r.decoder&&!i?(e=r.decoder.write(e),r.objectMode||0!==e.length?S(t,r,e,!1):M(t,r)):S(t,r,e,!1)}else n||(r.reading=!1,M(t,r));return!r.ended&&(r.length<r.highWaterMark||0===r.length)}function S(t,e,i,n){e.flowing&&0===e.length&&!e.sync?(e.awaitDrain=0,t.emit("data",i)):(e.length+=e.objectMode?1:i.length,n?e.buffer.unshift(i):e.buffer.push(i),e.needReadable&&E(t)),M(t,e)}Object.defineProperty(A.prototype,"destroyed",{enumerable:!1,get:function(){return void 0!==this._readableState&&this._readableState.destroyed},set:function(t){this._readableState&&(this._readableState.destroyed=t)}}),A.prototype.destroy=v.destroy,A.prototype._undestroy=v.undestroy,A.prototype._destroy=function(t,e){e(t)},A.prototype.push=function(t,e){var i,n=this._readableState;return n.objectMode?i=!0:"string"==typeof t&&((e=e||n.defaultEncoding)!==n.encoding&&(t=l.from(t,e),e=""),i=!0),R(this,t,e,!1,i)},A.prototype.unshift=function(t){return R(this,t,null,!0,!1)},A.prototype.isPaused=function(){return!1===this._readableState.flowing},A.prototype.setEncoding=function(e){d||(d=t("string_decoder/").StringDecoder);var i=new d(e);this._readableState.decoder=i,this._readableState.encoding=this._readableState.decoder.encoding;for(var n=this._readableState.buffer.head,o="";null!==n;)o+=i.write(n.data),n=n.next;return this._readableState.buffer.clear(),""!==o&&this._readableState.buffer.push(o),this._readableState.length=o.length,this};var P=1073741824;function I(t,e){return t<=0||0===e.length&&e.ended?0:e.objectMode?1:t!=t?e.flowing&&e.length?e.buffer.head.data.length:e.length:(t>e.highWaterMark&&(e.highWaterMark=function(t){return t>=P?t=P:(t--,t|=t>>>1,t|=t>>>2,t|=t>>>4,t|=t>>>8,t|=t>>>16,t++),t}(t)),t<=e.length?t:e.ended?e.length:(e.needReadable=!0,0))}function E(t){var e=t._readableState;s("emitReadable",e.needReadable,e.emittedReadable),e.needReadable=!1,e.emittedReadable||(s("emitReadable",e.flowing),e.emittedReadable=!0,i.nextTick(_,t))}function _(t){var e=t._readableState;s("emitReadable_",e.destroyed,e.length,e.ended),e.destroyed||!e.length&&!e.ended||(t.emit("readable"),e.emittedReadable=!1),e.needReadable=!e.flowing&&!e.ended&&e.length<=e.highWaterMark,N(t)}function M(t,e){e.readingMore||(e.readingMore=!0,i.nextTick(L,t,e))}function L(t,e){for(;!e.reading&&!e.ended&&(e.length<e.highWaterMark||e.flowing&&0===e.length);){var i=e.length;if(s("maybeReadMore read 0"),t.read(0),i===e.length)break}e.readingMore=!1}function D(t){var e=t._readableState;e.readableListening=t.listenerCount("readable")>0,e.resumeScheduled&&!e.paused?e.flowing=!0:t.listenerCount("data")>0&&t.resume()}function O(t){s("readable nexttick read 0"),t.read(0)}function B(t,e){s("resume",e.reading),e.reading||t.read(0),e.resumeScheduled=!1,t.emit("resume"),N(t),e.flowing&&!e.reading&&t.read(0)}function N(t){var e=t._readableState;for(s("flow",e.flowing);e.flowing&&null!==t.read(););}function F(t,e){return 0===e.length?null:(e.objectMode?i=e.buffer.shift():!t||t>=e.length?(i=e.decoder?e.buffer.join(""):1===e.buffer.length?e.buffer.first():e.buffer.concat(e.length),e.buffer.clear()):i=e.buffer.consume(t,e.decoder),i);var i}function z(t){var e=t._readableState;s("endReadable",e.endEmitted),e.endEmitted||(e.ended=!0,i.nextTick(j,e,t))}function j(t,e){if(s("endReadableNT",t.endEmitted,t.length),!t.endEmitted&&0===t.length&&(t.endEmitted=!0,e.readable=!1,e.emit("end"),t.autoDestroy)){var i=e._writableState;(!i||i.autoDestroy&&i.finished)&&e.destroy()}}function H(t,e){for(var i=0,n=t.length;i<n;i++)if(t[i]===e)return i;return-1}A.prototype.read=function(t){s("read",t),t=parseInt(t,10);var e=this._readableState,i=t;if(0!==t&&(e.emittedReadable=!1),0===t&&e.needReadable&&((0!==e.highWaterMark?e.length>=e.highWaterMark:e.length>0)||e.ended))return s("read: emitReadable",e.length,e.ended),0===e.length&&e.ended?z(this):E(this),null;if(0===(t=I(t,e))&&e.ended)return 0===e.length&&z(this),null;var n,o=e.needReadable;return s("need readable",o),(0===e.length||e.length-t<e.highWaterMark)&&s("length less than watermark",o=!0),e.ended||e.reading?s("reading or ended",o=!1):o&&(s("do read"),e.reading=!0,e.sync=!0,0===e.length&&(e.needReadable=!0),this._read(e.highWaterMark),e.sync=!1,e.reading||(t=I(i,e))),null===(n=t>0?F(t,e):null)?(e.needReadable=e.length<=e.highWaterMark,t=0):(e.length-=t,e.awaitDrain=0),0===e.length&&(e.ended||(e.needReadable=!0),i!==t&&e.ended&&z(this)),null!==n&&this.emit("data",n),n},A.prototype._read=function(t){k(this,new x("_read()"))},A.prototype.pipe=function(t,e){var n=this,o=this._readableState;switch(o.pipesCount){case 0:o.pipes=t;break;case 1:o.pipes=[o.pipes,t];break;default:o.pipes.push(t)}o.pipesCount+=1,s("pipe count=%d opts=%j",o.pipesCount,e);var r=e&&!1===e.end||t===i.stdout||t===i.stderr?v:l;function l(){s("onend"),t.end()}o.endEmitted?i.nextTick(r):n.once("end",r),t.on("unpipe",function e(i,a){s("onunpipe"),i===n&&a&&!1===a.hasUnpiped&&(a.hasUnpiped=!0,s("cleanup"),t.removeListener("close",f),t.removeListener("finish",p),t.removeListener("drain",c),t.removeListener("error",u),t.removeListener("unpipe",e),n.removeListener("end",l),n.removeListener("end",v),n.removeListener("data",d),h=!0,!o.awaitDrain||t._writableState&&!t._writableState.needDrain||c())});var c=function(t){return function(){var e=t._readableState;s("pipeOnDrain",e.awaitDrain),e.awaitDrain&&e.awaitDrain--,0===e.awaitDrain&&a(t,"data")&&(e.flowing=!0,N(t))}}(n);t.on("drain",c);var h=!1;function d(e){s("ondata");var i=t.write(e);s("dest.write",i),!1===i&&((1===o.pipesCount&&o.pipes===t||o.pipesCount>1&&-1!==H(o.pipes,t))&&!h&&(s("false write response, pause",o.awaitDrain),o.awaitDrain++),n.pause())}function u(e){s("onerror",e),v(),t.removeListener("error",u),0===a(t,"error")&&k(t,e)}function f(){t.removeListener("finish",p),v()}function p(){s("onfinish"),t.removeListener("close",f),v()}function v(){s("unpipe"),n.unpipe(t)}return n.on("data",d),function(t,e,i){if("function"==typeof t.prependListener)return t.prependListener(e,i);t._events&&t._events[e]?Array.isArray(t._events[e])?t._events[e].unshift(i):t._events[e]=[i,t._events[e]]:t.on(e,i)}(t,"error",u),t.once("close",f),t.once("finish",p),t.emit("pipe",n),o.flowing||(s("pipe resume"),n.resume()),t},A.prototype.unpipe=function(t){var e=this._readableState,i={hasUnpiped:!1};if(0===e.pipesCount)return this;if(1===e.pipesCount)return t&&t!==e.pipes||(t||(t=e.pipes),e.pipes=null,e.pipesCount=0,e.flowing=!1,t&&t.emit("unpipe",this,i)),this;if(!t){var n=e.pipes,o=e.pipesCount;e.pipes=null,e.pipesCount=0,e.flowing=!1;for(var s=0;s<o;s++)n[s].emit("unpipe",this,{hasUnpiped:!1});return this}var a=H(e.pipes,t);return-1===a||(e.pipes.splice(a,1),e.pipesCount-=1,1===e.pipesCount&&(e.pipes=e.pipes[0]),t.emit("unpipe",this,i)),this},A.prototype.on=function(t,e){var n=r.prototype.on.call(this,t,e),o=this._readableState;return"data"===t?(o.readableListening=this.listenerCount("readable")>0,!1!==o.flowing&&this.resume()):"readable"===t&&(o.endEmitted||o.readableListening||(o.readableListening=o.needReadable=!0,o.flowing=!1,o.emittedReadable=!1,s("on readable",o.length,o.reading),o.length?E(this):o.reading||i.nextTick(O,this))),n},A.prototype.addListener=A.prototype.on,A.prototype.removeListener=function(t,e){var n=r.prototype.removeListener.call(this,t,e);return"readable"===t&&i.nextTick(D,this),n},A.prototype.removeAllListeners=function(t){var e=r.prototype.removeAllListeners.apply(this,arguments);return"readable"!==t&&void 0!==t||i.nextTick(D,this),e},A.prototype.resume=function(){var t=this._readableState;return t.flowing||(s("resume"),t.flowing=!t.readableListening,function(t,e){e.resumeScheduled||(e.resumeScheduled=!0,i.nextTick(B,t,e))}(this,t)),t.paused=!1,this},A.prototype.pause=function(){return s("call pause flowing=%j",this._readableState.flowing),!1!==this._readableState.flowing&&(s("pause"),this._readableState.flowing=!1,this.emit("pause")),this._readableState.paused=!0,this},A.prototype.wrap=function(t){var e=this,i=this._readableState,n=!1;for(var o in t.on("end",function(){if(s("wrapped end"),i.decoder&&!i.ended){var t=i.decoder.end();t&&t.length&&e.push(t)}e.push(null)}),t.on("data",function(o){s("wrapped data"),i.decoder&&(o=i.decoder.write(o)),(!i.objectMode||null!=o)&&(i.objectMode||o&&o.length)&&(e.push(o)||(n=!0,t.pause()))}),t)void 0===this[o]&&"function"==typeof t[o]&&(this[o]=function(e){return function(){return t[e].apply(t,arguments)}}(o));for(var a=0;a<T.length;a++)t.on(T[a],this.emit.bind(this,T[a]));return this._read=function(e){s("wrapped _read",e),n&&(n=!1,t.resume())},this},"function"==typeof Symbol&&(A.prototype[Symbol.asyncIterator]=function(){return void 0===u&&(u=t("./internal/streams/async_iterator")),u(this)}),Object.defineProperty(A.prototype,"readableHighWaterMark",{enumerable:!1,get:function(){return this._readableState.highWaterMark}}),Object.defineProperty(A.prototype,"readableBuffer",{enumerable:!1,get:function(){return this._readableState&&this._readableState.buffer}}),Object.defineProperty(A.prototype,"readableFlowing",{enumerable:!1,get:function(){return this._readableState.flowing},set:function(t){this._readableState&&(this._readableState.flowing=t)}}),A._fromList=F,Object.defineProperty(A.prototype,"readableLength",{enumerable:!1,get:function(){return this._readableState.length}}),"function"==typeof Symbol&&(A.from=function(e,i){return void 0===f&&(f=t("./internal/streams/from")),f(A,e,i)})}).call(this)}).call(this,t("_process"),void 0!==i.g?i.g:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"../errors":55,"./_stream_duplex":56,"./internal/streams/async_iterator":61,"./internal/streams/buffer_list":62,"./internal/streams/destroy":63,"./internal/streams/from":65,"./internal/streams/state":67,"./internal/streams/stream":68,_process:50,buffer:17,events:22,inherits:24,"string_decoder/":75,util:16}],59:[function(t,e,i){"use strict";e.exports=c;var n=t("../errors").codes,o=n.ERR_METHOD_NOT_IMPLEMENTED,s=n.ERR_MULTIPLE_CALLBACK,a=n.ERR_TRANSFORM_ALREADY_TRANSFORMING,r=n.ERR_TRANSFORM_WITH_LENGTH_0,l=t("./_stream_duplex");function c(t){if(!(this instanceof c))return new c(t);l.call(this,t),this._transformState={afterTransform:function(t,e){var i=this._transformState;i.transforming=!1;var n=i.writecb;if(null===n)return this.emit("error",new s);i.writechunk=null,i.writecb=null,null!=e&&this.push(e),n(t);var o=this._readableState;o.reading=!1,(o.needReadable||o.length<o.highWaterMark)&&this._read(o.highWaterMark)}.bind(this),needTransform:!1,transforming:!1,writecb:null,writechunk:null,writeencoding:null},this._readableState.needReadable=!0,this._readableState.sync=!1,t&&("function"==typeof t.transform&&(this._transform=t.transform),"function"==typeof t.flush&&(this._flush=t.flush)),this.on("prefinish",h)}function h(){var t=this;"function"!=typeof this._flush||this._readableState.destroyed?d(this,null,null):this._flush(function(e,i){d(t,e,i)})}function d(t,e,i){if(e)return t.emit("error",e);if(null!=i&&t.push(i),t._writableState.length)throw new r;if(t._transformState.transforming)throw new a;return t.push(null)}t("inherits")(c,l),c.prototype.push=function(t,e){return this._transformState.needTransform=!1,l.prototype.push.call(this,t,e)},c.prototype._transform=function(t,e,i){i(new o("_transform()"))},c.prototype._write=function(t,e,i){var n=this._transformState;if(n.writecb=i,n.writechunk=t,n.writeencoding=e,!n.transforming){var o=this._readableState;(n.needTransform||o.needReadable||o.length<o.highWaterMark)&&this._read(o.highWaterMark)}},c.prototype._read=function(t){var e=this._transformState;null===e.writechunk||e.transforming?e.needTransform=!0:(e.transforming=!0,this._transform(e.writechunk,e.writeencoding,e.afterTransform))},c.prototype._destroy=function(t,e){l.prototype._destroy.call(this,t,function(t){e(t)})}},{"../errors":55,"./_stream_duplex":56,inherits:24}],60:[function(t,e,n){(function(i,n){(function(){"use strict";function o(t){var e=this;this.next=null,this.entry=null,this.finish=function(){!function(t,e){var i=t.entry;for(t.entry=null;i;){var n=i.callback;e.pendingcb--,n(undefined),i=i.next}e.corkedRequestsFree.next=t}(e,t)}}var s;e.exports=A,A.WritableState=C;var a,r={deprecate:t("util-deprecate")},l=t("./internal/streams/stream"),c=t("buffer").Buffer,h=n.Uint8Array||function(){},d=t("./internal/streams/destroy"),u=t("./internal/streams/state").getHighWaterMark,f=t("../errors").codes,p=f.ERR_INVALID_ARG_TYPE,v=f.ERR_METHOD_NOT_IMPLEMENTED,g=f.ERR_MULTIPLE_CALLBACK,y=f.ERR_STREAM_CANNOT_PIPE,m=f.ERR_STREAM_DESTROYED,w=f.ERR_STREAM_NULL_VALUES,x=f.ERR_STREAM_WRITE_AFTER_END,b=f.ERR_UNKNOWN_ENCODING,k=d.errorOrDestroy;function T(){}function C(e,n,a){s=s||t("./_stream_duplex"),e=e||{},"boolean"!=typeof a&&(a=n instanceof s),this.objectMode=!!e.objectMode,a&&(this.objectMode=this.objectMode||!!e.writableObjectMode),this.highWaterMark=u(this,e,"writableHighWaterMark",a),this.finalCalled=!1,this.needDrain=!1,this.ending=!1,this.ended=!1,this.finished=!1,this.destroyed=!1;var r=!1===e.decodeStrings;this.decodeStrings=!r,this.defaultEncoding=e.defaultEncoding||"utf8",this.length=0,this.writing=!1,this.corked=0,this.sync=!0,this.bufferProcessing=!1,this.onwrite=function(t){!function(t,e){var n=t._writableState,o=n.sync,s=n.writecb;if("function"!=typeof s)throw new g;if(function(t){t.writing=!1,t.writecb=null,t.length-=t.writelen,t.writelen=0}(n),e)!function(t,e,n,o,s){--e.pendingcb,n?(i.nextTick(s,o),i.nextTick(_,t,e),t._writableState.errorEmitted=!0,k(t,o)):(s(o),t._writableState.errorEmitted=!0,k(t,o),_(t,e))}(t,n,o,e,s);else{var a=I(n)||t.destroyed;a||n.corked||n.bufferProcessing||!n.bufferedRequest||P(t,n),o?i.nextTick(S,t,n,a,s):S(t,n,a,s)}}(n,t)},this.writecb=null,this.writelen=0,this.bufferedRequest=null,this.lastBufferedRequest=null,this.pendingcb=0,this.prefinished=!1,this.errorEmitted=!1,this.emitClose=!1!==e.emitClose,this.autoDestroy=!!e.autoDestroy,this.bufferedRequestCount=0,this.corkedRequestsFree=new o(this)}function A(e){var i=this instanceof(s=s||t("./_stream_duplex"));if(!i&&!a.call(A,this))return new A(e);this._writableState=new C(e,this,i),this.writable=!0,e&&("function"==typeof e.write&&(this._write=e.write),"function"==typeof e.writev&&(this._writev=e.writev),"function"==typeof e.destroy&&(this._destroy=e.destroy),"function"==typeof e.final&&(this._final=e.final)),l.call(this)}function R(t,e,i,n,o,s,a){e.writelen=n,e.writecb=a,e.writing=!0,e.sync=!0,e.destroyed?e.onwrite(new m("write")):i?t._writev(o,e.onwrite):t._write(o,s,e.onwrite),e.sync=!1}function S(t,e,i,n){i||function(t,e){0===e.length&&e.needDrain&&(e.needDrain=!1,t.emit("drain"))}(t,e),e.pendingcb--,n(),_(t,e)}function P(t,e){e.bufferProcessing=!0;var i=e.bufferedRequest;if(t._writev&&i&&i.next){var n=e.bufferedRequestCount,s=new Array(n),a=e.corkedRequestsFree;a.entry=i;for(var r=0,l=!0;i;)s[r]=i,i.isBuf||(l=!1),i=i.next,r+=1;s.allBuffers=l,R(t,e,!0,e.length,s,"",a.finish),e.pendingcb++,e.lastBufferedRequest=null,a.next?(e.corkedRequestsFree=a.next,a.next=null):e.corkedRequestsFree=new o(e),e.bufferedRequestCount=0}else{for(;i;){var c=i.chunk,h=i.encoding,d=i.callback;if(R(t,e,!1,e.objectMode?1:c.length,c,h,d),i=i.next,e.bufferedRequestCount--,e.writing)break}null===i&&(e.lastBufferedRequest=null)}e.bufferedRequest=i,e.bufferProcessing=!1}function I(t){return t.ending&&0===t.length&&null===t.bufferedRequest&&!t.finished&&!t.writing}function E(t,e){t._final(function(i){e.pendingcb--,i&&k(t,i),e.prefinished=!0,t.emit("prefinish"),_(t,e)})}function _(t,e){var n=I(e);if(n&&(function(t,e){e.prefinished||e.finalCalled||("function"!=typeof t._final||e.destroyed?(e.prefinished=!0,t.emit("prefinish")):(e.pendingcb++,e.finalCalled=!0,i.nextTick(E,t,e)))}(t,e),0===e.pendingcb&&(e.finished=!0,t.emit("finish"),e.autoDestroy))){var o=t._readableState;(!o||o.autoDestroy&&o.endEmitted)&&t.destroy()}return n}t("inherits")(A,l),C.prototype.getBuffer=function(){for(var t=this.bufferedRequest,e=[];t;)e.push(t),t=t.next;return e},function(){try{Object.defineProperty(C.prototype,"buffer",{get:r.deprecate(function(){return this.getBuffer()},"_writableState.buffer is deprecated. Use _writableState.getBuffer instead.","DEP0003")})}catch(t){}}(),"function"==typeof Symbol&&Symbol.hasInstance&&"function"==typeof Function.prototype[Symbol.hasInstance]?(a=Function.prototype[Symbol.hasInstance],Object.defineProperty(A,Symbol.hasInstance,{value:function(t){return!!a.call(this,t)||this===A&&t&&t._writableState instanceof C}})):a=function(t){return t instanceof this},A.prototype.pipe=function(){k(this,new y)},A.prototype.write=function(t,e,n){var o,s=this._writableState,a=!1,r=!s.objectMode&&(o=t,c.isBuffer(o)||o instanceof h);return r&&!c.isBuffer(t)&&(t=function(t){return c.from(t)}(t)),"function"==typeof e&&(n=e,e=null),r?e="buffer":e||(e=s.defaultEncoding),"function"!=typeof n&&(n=T),s.ending?function(t,e){var n=new x;k(t,n),i.nextTick(e,n)}(this,n):(r||function(t,e,n,o){var s;return null===n?s=new w:"string"==typeof n||e.objectMode||(s=new p("chunk",["string","Buffer"],n)),!s||(k(t,s),i.nextTick(o,s),!1)}(this,s,t,n))&&(s.pendingcb++,a=function(t,e,i,n,o,s){if(!i){var a=function(t,e,i){return t.objectMode||!1===t.decodeStrings||"string"!=typeof e||(e=c.from(e,i)),e}(e,n,o);n!==a&&(i=!0,o="buffer",n=a)}var r=e.objectMode?1:n.length;e.length+=r;var l=e.length<e.highWaterMark;if(l||(e.needDrain=!0),e.writing||e.corked){var h=e.lastBufferedRequest;e.lastBufferedRequest={chunk:n,encoding:o,isBuf:i,callback:s,next:null},h?h.next=e.lastBufferedRequest:e.bufferedRequest=e.lastBufferedRequest,e.bufferedRequestCount+=1}else R(t,e,!1,r,n,o,s);return l}(this,s,r,t,e,n)),a},A.prototype.cork=function(){this._writableState.corked++},A.prototype.uncork=function(){var t=this._writableState;t.corked&&(t.corked--,t.writing||t.corked||t.bufferProcessing||!t.bufferedRequest||P(this,t))},A.prototype.setDefaultEncoding=function(t){if("string"==typeof t&&(t=t.toLowerCase()),!(["hex","utf8","utf-8","ascii","binary","base64","ucs2","ucs-2","utf16le","utf-16le","raw"].indexOf((t+"").toLowerCase())>-1))throw new b(t);return this._writableState.defaultEncoding=t,this},Object.defineProperty(A.prototype,"writableBuffer",{enumerable:!1,get:function(){return this._writableState&&this._writableState.getBuffer()}}),Object.defineProperty(A.prototype,"writableHighWaterMark",{enumerable:!1,get:function(){return this._writableState.highWaterMark}}),A.prototype._write=function(t,e,i){i(new v("_write()"))},A.prototype._writev=null,A.prototype.end=function(t,e,n){var o=this._writableState;return"function"==typeof t?(n=t,t=null,e=null):"function"==typeof e&&(n=e,e=null),null!=t&&this.write(t,e),o.corked&&(o.corked=1,this.uncork()),o.ending||function(t,e,n){e.ending=!0,_(t,e),n&&(e.finished?i.nextTick(n):t.once("finish",n)),e.ended=!0,t.writable=!1}(this,o,n),this},Object.defineProperty(A.prototype,"writableLength",{enumerable:!1,get:function(){return this._writableState.length}}),Object.defineProperty(A.prototype,"destroyed",{enumerable:!1,get:function(){return void 0!==this._writableState&&this._writableState.destroyed},set:function(t){this._writableState&&(this._writableState.destroyed=t)}}),A.prototype.destroy=d.destroy,A.prototype._undestroy=d.undestroy,A.prototype._destroy=function(t,e){e(t)}}).call(this)}).call(this,t("_process"),void 0!==i.g?i.g:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"../errors":55,"./_stream_duplex":56,"./internal/streams/destroy":63,"./internal/streams/state":67,"./internal/streams/stream":68,_process:50,buffer:17,inherits:24,"util-deprecate":78}],61:[function(t,e,i){(function(i){(function(){"use strict";var n;function o(t,e,i){return e in t?Object.defineProperty(t,e,{value:i,enumerable:!0,configurable:!0,writable:!0}):t[e]=i,t}var s=t("./end-of-stream"),a=Symbol("lastResolve"),r=Symbol("lastReject"),l=Symbol("error"),c=Symbol("ended"),h=Symbol("lastPromise"),d=Symbol("handlePromise"),u=Symbol("stream");function f(t,e){return{value:t,done:e}}function p(t){var e=t[a];if(null!==e){var i=t[u].read();null!==i&&(t[h]=null,t[a]=null,t[r]=null,e(f(i,!1)))}}var v=Object.getPrototypeOf(function(){}),g=Object.setPrototypeOf((o(n={get stream(){return this[u]},next:function(){var t=this,e=this[l];if(null!==e)return Promise.reject(e);if(this[c])return Promise.resolve(f(void 0,!0));if(this[u].destroyed)return new Promise(function(e,n){i.nextTick(function(){t[l]?n(t[l]):e(f(void 0,!0))})});var n,o=this[h];if(o)n=new Promise(function(t,e){return function(i,n){t.then(function(){e[c]?i(f(void 0,!0)):e[d](i,n)},n)}}(o,this));else{var s=this[u].read();if(null!==s)return Promise.resolve(f(s,!1));n=new Promise(this[d])}return this[h]=n,n}},Symbol.asyncIterator,function(){return this}),o(n,"return",function(){var t=this;return new Promise(function(e,i){t[u].destroy(null,function(t){t?i(t):e(f(void 0,!0))})})}),n),v);e.exports=function(t){var e,n=Object.create(g,(o(e={},u,{value:t,writable:!0}),o(e,a,{value:null,writable:!0}),o(e,r,{value:null,writable:!0}),o(e,l,{value:null,writable:!0}),o(e,c,{value:t._readableState.endEmitted,writable:!0}),o(e,d,{value:function(t,e){var i=n[u].read();i?(n[h]=null,n[a]=null,n[r]=null,t(f(i,!1))):(n[a]=t,n[r]=e)},writable:!0}),e));return n[h]=null,s(t,function(t){if(t&&"ERR_STREAM_PREMATURE_CLOSE"!==t.code){var e=n[r];return null!==e&&(n[h]=null,n[a]=null,n[r]=null,e(t)),void(n[l]=t)}var i=n[a];null!==i&&(n[h]=null,n[a]=null,n[r]=null,i(f(void 0,!0))),n[c]=!0}),t.on("readable",function(t){i.nextTick(p,t)}.bind(null,n)),n}}).call(this)}).call(this,t("_process"))},{"./end-of-stream":64,_process:50}],62:[function(t,e,i){"use strict";function n(t,e){var i=Object.keys(t);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(t);e&&(n=n.filter(function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable})),i.push.apply(i,n)}return i}function o(t,e,i){return e in t?Object.defineProperty(t,e,{value:i,enumerable:!0,configurable:!0,writable:!0}):t[e]=i,t}function s(t,e){for(var i=0;i<e.length;i++){var n=e[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(t,n.key,n)}}var a=t("buffer").Buffer,r=t("util").inspect,l=r&&r.custom||"inspect";e.exports=function(){function t(){!function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,t),this.head=null,this.tail=null,this.length=0}var e,i;return e=t,(i=[{key:"push",value:function(t){var e={data:t,next:null};this.length>0?this.tail.next=e:this.head=e,this.tail=e,++this.length}},{key:"unshift",value:function(t){var e={data:t,next:this.head};0===this.length&&(this.tail=e),this.head=e,++this.length}},{key:"shift",value:function(){if(0!==this.length){var t=this.head.data;return 1===this.length?this.head=this.tail=null:this.head=this.head.next,--this.length,t}}},{key:"clear",value:function(){this.head=this.tail=null,this.length=0}},{key:"join",value:function(t){if(0===this.length)return"";for(var e=this.head,i=""+e.data;e=e.next;)i+=t+e.data;return i}},{key:"concat",value:function(t){if(0===this.length)return a.alloc(0);for(var e,i,n,o=a.allocUnsafe(t>>>0),s=this.head,r=0;s;)e=s.data,i=o,n=r,a.prototype.copy.call(e,i,n),r+=s.data.length,s=s.next;return o}},{key:"consume",value:function(t,e){var i;return t<this.head.data.length?(i=this.head.data.slice(0,t),this.head.data=this.head.data.slice(t)):i=t===this.head.data.length?this.shift():e?this._getString(t):this._getBuffer(t),i}},{key:"first",value:function(){return this.head.data}},{key:"_getString",value:function(t){var e=this.head,i=1,n=e.data;for(t-=n.length;e=e.next;){var o=e.data,s=t>o.length?o.length:t;if(s===o.length?n+=o:n+=o.slice(0,t),0===(t-=s)){s===o.length?(++i,e.next?this.head=e.next:this.head=this.tail=null):(this.head=e,e.data=o.slice(s));break}++i}return this.length-=i,n}},{key:"_getBuffer",value:function(t){var e=a.allocUnsafe(t),i=this.head,n=1;for(i.data.copy(e),t-=i.data.length;i=i.next;){var o=i.data,s=t>o.length?o.length:t;if(o.copy(e,e.length-t,0,s),0===(t-=s)){s===o.length?(++n,i.next?this.head=i.next:this.head=this.tail=null):(this.head=i,i.data=o.slice(s));break}++n}return this.length-=n,e}},{key:l,value:function(t,e){return r(this,function(t){for(var e=1;e<arguments.length;e++){var i=null!=arguments[e]?arguments[e]:{};e%2?n(Object(i),!0).forEach(function(e){o(t,e,i[e])}):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(i)):n(Object(i)).forEach(function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(i,e))})}return t}({},e,{depth:0,customInspect:!1}))}}])&&s(e.prototype,i),t}()},{buffer:17,util:16}],63:[function(t,e,i){(function(t){(function(){"use strict";function i(t,e){o(t,e),n(t)}function n(t){t._writableState&&!t._writableState.emitClose||t._readableState&&!t._readableState.emitClose||t.emit("close")}function o(t,e){t.emit("error",e)}e.exports={destroy:function(e,s){var a=this,r=this._readableState&&this._readableState.destroyed,l=this._writableState&&this._writableState.destroyed;return r||l?(s?s(e):e&&(this._writableState?this._writableState.errorEmitted||(this._writableState.errorEmitted=!0,t.nextTick(o,this,e)):t.nextTick(o,this,e)),this):(this._readableState&&(this._readableState.destroyed=!0),this._writableState&&(this._writableState.destroyed=!0),this._destroy(e||null,function(e){!s&&e?a._writableState?a._writableState.errorEmitted?t.nextTick(n,a):(a._writableState.errorEmitted=!0,t.nextTick(i,a,e)):t.nextTick(i,a,e):s?(t.nextTick(n,a),s(e)):t.nextTick(n,a)}),this)},undestroy:function(){this._readableState&&(this._readableState.destroyed=!1,this._readableState.reading=!1,this._readableState.ended=!1,this._readableState.endEmitted=!1),this._writableState&&(this._writableState.destroyed=!1,this._writableState.ended=!1,this._writableState.ending=!1,this._writableState.finalCalled=!1,this._writableState.prefinished=!1,this._writableState.finished=!1,this._writableState.errorEmitted=!1)},errorOrDestroy:function(t,e){var i=t._readableState,n=t._writableState;i&&i.autoDestroy||n&&n.autoDestroy?t.destroy(e):t.emit("error",e)}}}).call(this)}).call(this,t("_process"))},{_process:50}],64:[function(t,e,i){"use strict";var n=t("../../../errors").codes.ERR_STREAM_PREMATURE_CLOSE;function o(){}e.exports=function t(e,i,s){if("function"==typeof i)return t(e,null,i);i||(i={}),s=function(t){var e=!1;return function(){if(!e){e=!0;for(var i=arguments.length,n=new Array(i),o=0;o<i;o++)n[o]=arguments[o];t.apply(this,n)}}}(s||o);var a=i.readable||!1!==i.readable&&e.readable,r=i.writable||!1!==i.writable&&e.writable,l=function(){e.writable||h()},c=e._writableState&&e._writableState.finished,h=function(){r=!1,c=!0,a||s.call(e)},d=e._readableState&&e._readableState.endEmitted,u=function(){a=!1,d=!0,r||s.call(e)},f=function(t){s.call(e,t)},p=function(){var t;return a&&!d?(e._readableState&&e._readableState.ended||(t=new n),s.call(e,t)):r&&!c?(e._writableState&&e._writableState.ended||(t=new n),s.call(e,t)):void 0},v=function(){e.req.on("finish",h)};return function(t){return t.setHeader&&"function"==typeof t.abort}(e)?(e.on("complete",h),e.on("abort",p),e.req?v():e.on("request",v)):r&&!e._writableState&&(e.on("end",l),e.on("close",l)),e.on("end",u),e.on("finish",h),!1!==i.error&&e.on("error",f),e.on("close",p),function(){e.removeListener("complete",h),e.removeListener("abort",p),e.removeListener("request",v),e.req&&e.req.removeListener("finish",h),e.removeListener("end",l),e.removeListener("close",l),e.removeListener("finish",h),e.removeListener("end",u),e.removeListener("error",f),e.removeListener("close",p)}}},{"../../../errors":55}],65:[function(t,e,i){e.exports=function(){throw new Error("Readable.from is not available in the browser")}},{}],66:[function(t,e,i){"use strict";var n,o=t("../../../errors").codes,s=o.ERR_MISSING_ARGS,a=o.ERR_STREAM_DESTROYED;function r(t){if(t)throw t}function l(t){t()}function c(t,e){return t.pipe(e)}e.exports=function(){for(var e=arguments.length,i=new Array(e),o=0;o<e;o++)i[o]=arguments[o];var h,d=function(t){return t.length?"function"!=typeof t[t.length-1]?r:t.pop():r}(i);if(Array.isArray(i[0])&&(i=i[0]),i.length<2)throw new s("streams");var u=i.map(function(e,o){var s=o<i.length-1;return function(e,i,o,s){s=function(t){var e=!1;return function(){e||(e=!0,t.apply(void 0,arguments))}}(s);var r=!1;e.on("close",function(){r=!0}),void 0===n&&(n=t("./end-of-stream")),n(e,{readable:i,writable:o},function(t){if(t)return s(t);r=!0,s()});var l=!1;return function(t){if(!r&&!l)return l=!0,function(t){return t.setHeader&&"function"==typeof t.abort}(e)?e.abort():"function"==typeof e.destroy?e.destroy():void s(t||new a("pipe"))}}(e,s,o>0,function(t){h||(h=t),t&&u.forEach(l),s||(u.forEach(l),d(h))})});return i.reduce(c)}},{"../../../errors":55,"./end-of-stream":64}],67:[function(t,e,i){"use strict";var n=t("../../../errors").codes.ERR_INVALID_OPT_VALUE;e.exports={getHighWaterMark:function(t,e,i,o){var s=function(t,e,i){return null!=t.highWaterMark?t.highWaterMark:e?t[i]:null}(e,o,i);if(null!=s){if(!isFinite(s)||Math.floor(s)!==s||s<0)throw new n(o?i:"highWaterMark",s);return Math.floor(s)}return t.objectMode?16:16384}}},{"../../../errors":55}],68:[function(t,e,i){e.exports=t("events").EventEmitter},{events:22}],69:[function(t,e,i){(i=e.exports=t("./lib/_stream_readable.js")).Stream=i,i.Readable=i,i.Writable=t("./lib/_stream_writable.js"),i.Duplex=t("./lib/_stream_duplex.js"),i.Transform=t("./lib/_stream_transform.js"),i.PassThrough=t("./lib/_stream_passthrough.js"),i.finished=t("./lib/internal/streams/end-of-stream.js"),i.pipeline=t("./lib/internal/streams/pipeline.js")},{"./lib/_stream_duplex.js":56,"./lib/_stream_passthrough.js":57,"./lib/_stream_readable.js":58,"./lib/_stream_transform.js":59,"./lib/_stream_writable.js":60,"./lib/internal/streams/end-of-stream.js":64,"./lib/internal/streams/pipeline.js":66}],70:[function(t,e,i){"use strict";e.exports=function(){if("function"!=typeof arguments[0])throw new Error("callback needed");if("number"!=typeof arguments[1])throw new Error("interval needed");var t;if(arguments.length>0){t=new Array(arguments.length-2);for(var e=0;e<t.length;e++)t[e]=arguments[e+2]}return new function(t,e,i){var n=this;this._callback=t,this._args=i,this._interval=setInterval(t,e,this._args),this.reschedule=function(t){t||(t=n._interval),n._interval&&clearInterval(n._interval),n._interval=setInterval(n._callback,t,n._args)},this.clear=function(){n._interval&&(clearInterval(n._interval),n._interval=void 0)},this.destroy=function(){n._interval&&clearInterval(n._interval),n._callback=void 0,n._interval=void 0,n._args=void 0}}(arguments[0],arguments[1],t)}},{}],71:[function(t,e,i){"use strict";e.exports=t("./index.js")()},{"./index.js":72}],72:[function(t,e,i){(function(t){(function(){"use strict";function i(e){return e instanceof t?t.from(e):new e.constructor(e.buffer.slice(),e.byteOffset,e.length)}e.exports=function(t){return(t=t||{}).circles?function(t){var e=[],n=[];return t.proto?function t(s){if("object"!=typeof s||null===s)return s;if(s instanceof Date)return new Date(s);if(Array.isArray(s))return o(s,t);if(s instanceof Map)return new Map(o(Array.from(s),t));if(s instanceof Set)return new Set(o(Array.from(s),t));var a={};for(var r in e.push(s),n.push(a),s){var l=s[r];if("object"!=typeof l||null===l)a[r]=l;else if(l instanceof Date)a[r]=new Date(l);else if(l instanceof Map)a[r]=new Map(o(Array.from(l),t));else if(l instanceof Set)a[r]=new Set(o(Array.from(l),t));else if(ArrayBuffer.isView(l))a[r]=i(l);else{var c=e.indexOf(l);a[r]=-1!==c?n[c]:t(l)}}return e.pop(),n.pop(),a}:function t(s){if("object"!=typeof s||null===s)return s;if(s instanceof Date)return new Date(s);if(Array.isArray(s))return o(s,t);if(s instanceof Map)return new Map(o(Array.from(s),t));if(s instanceof Set)return new Set(o(Array.from(s),t));var a={};for(var r in e.push(s),n.push(a),s)if(!1!==Object.hasOwnProperty.call(s,r)){var l=s[r];if("object"!=typeof l||null===l)a[r]=l;else if(l instanceof Date)a[r]=new Date(l);else if(l instanceof Map)a[r]=new Map(o(Array.from(l),t));else if(l instanceof Set)a[r]=new Set(o(Array.from(l),t));else if(ArrayBuffer.isView(l))a[r]=i(l);else{var c=e.indexOf(l);a[r]=-1!==c?n[c]:t(l)}}return e.pop(),n.pop(),a};function o(t,o){for(var s=Object.keys(t),a=new Array(s.length),r=0;r<s.length;r++){var l=s[r],c=t[l];if("object"!=typeof c||null===c)a[l]=c;else if(c instanceof Date)a[l]=new Date(c);else if(ArrayBuffer.isView(c))a[l]=i(c);else{var h=e.indexOf(c);a[l]=-1!==h?n[h]:o(c)}}return a}}(t):t.proto?function t(n){if("object"!=typeof n||null===n)return n;if(n instanceof Date)return new Date(n);if(Array.isArray(n))return e(n,t);if(n instanceof Map)return new Map(e(Array.from(n),t));if(n instanceof Set)return new Set(e(Array.from(n),t));var o={};for(var s in n){var a=n[s];"object"!=typeof a||null===a?o[s]=a:a instanceof Date?o[s]=new Date(a):a instanceof Map?o[s]=new Map(e(Array.from(a),t)):a instanceof Set?o[s]=new Set(e(Array.from(a),t)):ArrayBuffer.isView(a)?o[s]=i(a):o[s]=t(a)}return o}:function t(n){if("object"!=typeof n||null===n)return n;if(n instanceof Date)return new Date(n);if(Array.isArray(n))return e(n,t);if(n instanceof Map)return new Map(e(Array.from(n),t));if(n instanceof Set)return new Set(e(Array.from(n),t));var o={};for(var s in n)if(!1!==Object.hasOwnProperty.call(n,s)){var a=n[s];"object"!=typeof a||null===a?o[s]=a:a instanceof Date?o[s]=new Date(a):a instanceof Map?o[s]=new Map(e(Array.from(a),t)):a instanceof Set?o[s]=new Set(e(Array.from(a),t)):ArrayBuffer.isView(a)?o[s]=i(a):o[s]=t(a)}return o};function e(t,e){for(var n=Object.keys(t),o=new Array(n.length),s=0;s<n.length;s++){var a=n[s],r=t[a];"object"!=typeof r||null===r?o[a]=r:r instanceof Date?o[a]=new Date(r):ArrayBuffer.isView(r)?o[a]=i(r):o[a]=e(r)}return o}}}).call(this)}).call(this,t("buffer").Buffer)},{buffer:17}],73:[function(t,e,i){var n=t("buffer"),o=n.Buffer;function s(t,e){for(var i in t)e[i]=t[i]}function a(t,e,i){return o(t,e,i)}o.from&&o.alloc&&o.allocUnsafe&&o.allocUnsafeSlow?e.exports=n:(s(n,i),i.Buffer=a),a.prototype=Object.create(o.prototype),s(o,a),a.from=function(t,e,i){if("number"==typeof t)throw new TypeError("Argument must not be a number");return o(t,e,i)},a.alloc=function(t,e,i){if("number"!=typeof t)throw new TypeError("Argument must be a number");var n=o(t);return void 0!==e?"string"==typeof i?n.fill(e,i):n.fill(e):n.fill(0),n},a.allocUnsafe=function(t){if("number"!=typeof t)throw new TypeError("Argument must be a number");return o(t)},a.allocUnsafeSlow=function(t){if("number"!=typeof t)throw new TypeError("Argument must be a number");return n.SlowBuffer(t)}},{buffer:17}],74:[function(t,e,i){e.exports=function(t){var e,i=t._readableState;return i?i.objectMode||"number"==typeof t._duplexState?t.read():t.read((e=i).buffer.length?e.buffer.head?e.buffer.head.data.length:e.buffer[0].length:e.length):null}},{}],75:[function(t,e,i){"use strict";var n=t("safe-buffer").Buffer,o=n.isEncoding||function(t){switch((t=""+t)&&t.toLowerCase()){case"hex":case"utf8":case"utf-8":case"ascii":case"binary":case"base64":case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":case"raw":return!0;default:return!1}};function s(t){var e;switch(this.encoding=function(t){var e=function(t){if(!t)return"utf8";for(var e;;)switch(t){case"utf8":case"utf-8":return"utf8";case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return"utf16le";case"latin1":case"binary":return"latin1";case"base64":case"ascii":case"hex":return t;default:if(e)return;t=(""+t).toLowerCase(),e=!0}}(t);if("string"!=typeof e&&(n.isEncoding===o||!o(t)))throw new Error("Unknown encoding: "+t);return e||t}(t),this.encoding){case"utf16le":this.text=l,this.end=c,e=4;break;case"utf8":this.fillLast=r,e=4;break;case"base64":this.text=h,this.end=d,e=3;break;default:return this.write=u,void(this.end=f)}this.lastNeed=0,this.lastTotal=0,this.lastChar=n.allocUnsafe(e)}function a(t){return t<=127?0:t>>5==6?2:t>>4==14?3:t>>3==30?4:t>>6==2?-1:-2}function r(t){var e=this.lastTotal-this.lastNeed,i=function(t,e){if(128!=(192&e[0]))return t.lastNeed=0,"";if(t.lastNeed>1&&e.length>1){if(128!=(192&e[1]))return t.lastNeed=1,"";if(t.lastNeed>2&&e.length>2&&128!=(192&e[2]))return t.lastNeed=2,""}}(this,t);return void 0!==i?i:this.lastNeed<=t.length?(t.copy(this.lastChar,e,0,this.lastNeed),this.lastChar.toString(this.encoding,0,this.lastTotal)):(t.copy(this.lastChar,e,0,t.length),void(this.lastNeed-=t.length))}function l(t,e){if((t.length-e)%2==0){var i=t.toString("utf16le",e);if(i){var n=i.charCodeAt(i.length-1);if(n>=55296&&n<=56319)return this.lastNeed=2,this.lastTotal=4,this.lastChar[0]=t[t.length-2],this.lastChar[1]=t[t.length-1],i.slice(0,-1)}return i}return this.lastNeed=1,this.lastTotal=2,this.lastChar[0]=t[t.length-1],t.toString("utf16le",e,t.length-1)}function c(t){var e=t&&t.length?this.write(t):"";if(this.lastNeed){var i=this.lastTotal-this.lastNeed;return e+this.lastChar.toString("utf16le",0,i)}return e}function h(t,e){var i=(t.length-e)%3;return 0===i?t.toString("base64",e):(this.lastNeed=3-i,this.lastTotal=3,1===i?this.lastChar[0]=t[t.length-1]:(this.lastChar[0]=t[t.length-2],this.lastChar[1]=t[t.length-1]),t.toString("base64",e,t.length-i))}function d(t){var e=t&&t.length?this.write(t):"";return this.lastNeed?e+this.lastChar.toString("base64",0,3-this.lastNeed):e}function u(t){return t.toString(this.encoding)}function f(t){return t&&t.length?this.write(t):""}i.StringDecoder=s,s.prototype.write=function(t){if(0===t.length)return"";var e,i;if(this.lastNeed){if(void 0===(e=this.fillLast(t)))return"";i=this.lastNeed,this.lastNeed=0}else i=0;return i<t.length?e?e+this.text(t,i):this.text(t,i):e||""},s.prototype.end=function(t){var e=t&&t.length?this.write(t):"";return this.lastNeed?e+"":e},s.prototype.text=function(t,e){var i=function(t,e,i){var n=e.length-1;if(n<i)return 0;var o=a(e[n]);return o>=0?(o>0&&(t.lastNeed=o-1),o):--n<i||-2===o?0:(o=a(e[n]))>=0?(o>0&&(t.lastNeed=o-2),o):--n<i||-2===o?0:(o=a(e[n]))>=0?(o>0&&(2===o?o=0:t.lastNeed=o-3),o):0}(this,t,e);if(!this.lastNeed)return t.toString("utf8",e);this.lastTotal=i;var n=t.length-(i-this.lastNeed);return t.copy(this.lastChar,0,n),t.toString("utf8",e,n)},s.prototype.fillLast=function(t){if(this.lastNeed<=t.length)return t.copy(this.lastChar,this.lastTotal-this.lastNeed,0,this.lastNeed),this.lastChar.toString(this.encoding,0,this.lastTotal);t.copy(this.lastChar,this.lastTotal-this.lastNeed,0,t.length),this.lastNeed-=t.length}},{"safe-buffer":73}],76:[function(t,e,i){"use strict";var n=t("punycode"),o=t("./util");function s(){this.protocol=null,this.slashes=null,this.auth=null,this.host=null,this.port=null,this.hostname=null,this.hash=null,this.search=null,this.query=null,this.pathname=null,this.path=null,this.href=null}i.parse=w,i.resolve=function(t,e){return w(t,!1,!0).resolve(e)},i.resolveObject=function(t,e){return t?w(t,!1,!0).resolveObject(e):e},i.format=function(t){return o.isString(t)&&(t=w(t)),t instanceof s?t.format():s.prototype.format.call(t)},i.Url=s;var a=/^([a-z0-9.+-]+:)/i,r=/:[0-9]*$/,l=/^(\/\/?(?!\/)[^\?\s]*)(\?[^\s]*)?$/,c=["{","}","|","\\","^","`"].concat(["<",">",'"',"`"," ","\r","\n","\t"]),h=["'"].concat(c),d=["%","/","?",";","#"].concat(h),u=["/","?","#"],f=/^[+a-z0-9A-Z_-]{0,63}$/,p=/^([+a-z0-9A-Z_-]{0,63})(.*)$/,v={javascript:!0,"javascript:":!0},g={javascript:!0,"javascript:":!0},y={http:!0,https:!0,ftp:!0,gopher:!0,file:!0,"http:":!0,"https:":!0,"ftp:":!0,"gopher:":!0,"file:":!0},m=t("querystring");function w(t,e,i){if(t&&o.isObject(t)&&t instanceof s)return t;var n=new s;return n.parse(t,e,i),n}s.prototype.parse=function(t,e,i){if(!o.isString(t))throw new TypeError("Parameter 'url' must be a string, not "+typeof t);var s=t.indexOf("?"),r=-1!==s&&s<t.indexOf("#")?"?":"#",c=t.split(r);c[0]=c[0].replace(/\\/g,"/");var w=t=c.join(r);if(w=w.trim(),!i&&1===t.split("#").length){var x=l.exec(w);if(x)return this.path=w,this.href=w,this.pathname=x[1],x[2]?(this.search=x[2],this.query=e?m.parse(this.search.substr(1)):this.search.substr(1)):e&&(this.search="",this.query={}),this}var b=a.exec(w);if(b){var k=(b=b[0]).toLowerCase();this.protocol=k,w=w.substr(b.length)}if(i||b||w.match(/^\/\/[^@\/]+@[^@\/]+/)){var T="//"===w.substr(0,2);!T||b&&g[b]||(w=w.substr(2),this.slashes=!0)}if(!g[b]&&(T||b&&!y[b])){for(var C,A,R=-1,S=0;S<u.length;S++)-1!==(P=w.indexOf(u[S]))&&(-1===R||P<R)&&(R=P);for(-1!==(A=-1===R?w.lastIndexOf("@"):w.lastIndexOf("@",R))&&(C=w.slice(0,A),w=w.slice(A+1),this.auth=decodeURIComponent(C)),R=-1,S=0;S<d.length;S++){var P;-1!==(P=w.indexOf(d[S]))&&(-1===R||P<R)&&(R=P)}-1===R&&(R=w.length),this.host=w.slice(0,R),w=w.slice(R),this.parseHost(),this.hostname=this.hostname||"";var I="["===this.hostname[0]&&"]"===this.hostname[this.hostname.length-1];if(!I)for(var E=this.hostname.split(/\./),_=(S=0,E.length);S<_;S++){var M=E[S];if(M&&!M.match(f)){for(var L="",D=0,O=M.length;D<O;D++)M.charCodeAt(D)>127?L+="x":L+=M[D];if(!L.match(f)){var B=E.slice(0,S),N=E.slice(S+1),F=M.match(p);F&&(B.push(F[1]),N.unshift(F[2])),N.length&&(w="/"+N.join(".")+w),this.hostname=B.join(".");break}}}this.hostname.length>255?this.hostname="":this.hostname=this.hostname.toLowerCase(),I||(this.hostname=n.toASCII(this.hostname));var z=this.port?":"+this.port:"",j=this.hostname||"";this.host=j+z,this.href+=this.host,I&&(this.hostname=this.hostname.substr(1,this.hostname.length-2),"/"!==w[0]&&(w="/"+w))}if(!v[k])for(S=0,_=h.length;S<_;S++){var H=h[S];if(-1!==w.indexOf(H)){var W=encodeURIComponent(H);W===H&&(W=escape(H)),w=w.split(H).join(W)}}var V=w.indexOf("#");-1!==V&&(this.hash=w.substr(V),w=w.slice(0,V));var U=w.indexOf("?");if(-1!==U?(this.search=w.substr(U),this.query=w.substr(U+1),e&&(this.query=m.parse(this.query)),w=w.slice(0,U)):e&&(this.search="",this.query={}),w&&(this.pathname=w),y[k]&&this.hostname&&!this.pathname&&(this.pathname="/"),this.pathname||this.search){z=this.pathname||"";var q=this.search||"";this.path=z+q}return this.href=this.format(),this},s.prototype.format=function(){var t=this.auth||"";t&&(t=(t=encodeURIComponent(t)).replace(/%3A/i,":"),t+="@");var e=this.protocol||"",i=this.pathname||"",n=this.hash||"",s=!1,a="";this.host?s=t+this.host:this.hostname&&(s=t+(-1===this.hostname.indexOf(":")?this.hostname:"["+this.hostname+"]"),this.port&&(s+=":"+this.port)),this.query&&o.isObject(this.query)&&Object.keys(this.query).length&&(a=m.stringify(this.query));var r=this.search||a&&"?"+a||"";return e&&":"!==e.substr(-1)&&(e+=":"),this.slashes||(!e||y[e])&&!1!==s?(s="//"+(s||""),i&&"/"!==i.charAt(0)&&(i="/"+i)):s||(s=""),n&&"#"!==n.charAt(0)&&(n="#"+n),r&&"?"!==r.charAt(0)&&(r="?"+r),e+s+(i=i.replace(/[?#]/g,function(t){return encodeURIComponent(t)}))+(r=r.replace("#","%23"))+n},s.prototype.resolve=function(t){return this.resolveObject(w(t,!1,!0)).format()},s.prototype.resolveObject=function(t){if(o.isString(t)){var e=new s;e.parse(t,!1,!0),t=e}for(var i=new s,n=Object.keys(this),a=0;a<n.length;a++){var r=n[a];i[r]=this[r]}if(i.hash=t.hash,""===t.href)return i.href=i.format(),i;if(t.slashes&&!t.protocol){for(var l=Object.keys(t),c=0;c<l.length;c++){var h=l[c];"protocol"!==h&&(i[h]=t[h])}return y[i.protocol]&&i.hostname&&!i.pathname&&(i.path=i.pathname="/"),i.href=i.format(),i}if(t.protocol&&t.protocol!==i.protocol){if(!y[t.protocol]){for(var d=Object.keys(t),u=0;u<d.length;u++){var f=d[u];i[f]=t[f]}return i.href=i.format(),i}if(i.protocol=t.protocol,t.host||g[t.protocol])i.pathname=t.pathname;else{for(var p=(t.pathname||"").split("/");p.length&&!(t.host=p.shift()););t.host||(t.host=""),t.hostname||(t.hostname=""),""!==p[0]&&p.unshift(""),p.length<2&&p.unshift(""),i.pathname=p.join("/")}if(i.search=t.search,i.query=t.query,i.host=t.host||"",i.auth=t.auth,i.hostname=t.hostname||t.host,i.port=t.port,i.pathname||i.search){var v=i.pathname||"",m=i.search||"";i.path=v+m}return i.slashes=i.slashes||t.slashes,i.href=i.format(),i}var w=i.pathname&&"/"===i.pathname.charAt(0),x=t.host||t.pathname&&"/"===t.pathname.charAt(0),b=x||w||i.host&&t.pathname,k=b,T=i.pathname&&i.pathname.split("/")||[],C=(p=t.pathname&&t.pathname.split("/")||[],i.protocol&&!y[i.protocol]);if(C&&(i.hostname="",i.port=null,i.host&&(""===T[0]?T[0]=i.host:T.unshift(i.host)),i.host="",t.protocol&&(t.hostname=null,t.port=null,t.host&&(""===p[0]?p[0]=t.host:p.unshift(t.host)),t.host=null),b=b&&(""===p[0]||""===T[0])),x)i.host=t.host||""===t.host?t.host:i.host,i.hostname=t.hostname||""===t.hostname?t.hostname:i.hostname,i.search=t.search,i.query=t.query,T=p;else if(p.length)T||(T=[]),T.pop(),T=T.concat(p),i.search=t.search,i.query=t.query;else if(!o.isNullOrUndefined(t.search))return C&&(i.hostname=i.host=T.shift(),(I=!!(i.host&&i.host.indexOf("@")>0)&&i.host.split("@"))&&(i.auth=I.shift(),i.host=i.hostname=I.shift())),i.search=t.search,i.query=t.query,o.isNull(i.pathname)&&o.isNull(i.search)||(i.path=(i.pathname?i.pathname:"")+(i.search?i.search:"")),i.href=i.format(),i;if(!T.length)return i.pathname=null,i.search?i.path="/"+i.search:i.path=null,i.href=i.format(),i;for(var A=T.slice(-1)[0],R=(i.host||t.host||T.length>1)&&("."===A||".."===A)||""===A,S=0,P=T.length;P>=0;P--)"."===(A=T[P])?T.splice(P,1):".."===A?(T.splice(P,1),S++):S&&(T.splice(P,1),S--);if(!b&&!k)for(;S--;S)T.unshift("..");!b||""===T[0]||T[0]&&"/"===T[0].charAt(0)||T.unshift(""),R&&"/"!==T.join("/").substr(-1)&&T.push("");var I,E=""===T[0]||T[0]&&"/"===T[0].charAt(0);return C&&(i.hostname=i.host=E?"":T.length?T.shift():"",(I=!!(i.host&&i.host.indexOf("@")>0)&&i.host.split("@"))&&(i.auth=I.shift(),i.host=i.hostname=I.shift())),(b=b||i.host&&T.length)&&!E&&T.unshift(""),T.length?i.pathname=T.join("/"):(i.pathname=null,i.path=null),o.isNull(i.pathname)&&o.isNull(i.search)||(i.path=(i.pathname?i.pathname:"")+(i.search?i.search:"")),i.auth=t.auth||i.auth,i.slashes=i.slashes||t.slashes,i.href=i.format(),i},s.prototype.parseHost=function(){var t=this.host,e=r.exec(t);e&&(":"!==(e=e[0])&&(this.port=e.substr(1)),t=t.substr(0,t.length-e.length)),t&&(this.hostname=t)}},{"./util":77,punycode:51,querystring:54}],77:[function(t,e,i){"use strict";e.exports={isString:function(t){return"string"==typeof t},isObject:function(t){return"object"==typeof t&&null!==t},isNull:function(t){return null===t},isNullOrUndefined:function(t){return null==t}}},{}],78:[function(t,e,n){(function(t){(function(){function i(e){try{if(!t.localStorage)return!1}catch(t){return!1}var i=t.localStorage[e];return null!=i&&"true"===String(i).toLowerCase()}e.exports=function(t,e){if(i("noDeprecation"))return t;var n=!1;return function(){if(!n){if(i("throwDeprecation"))throw new Error(e);i("traceDeprecation")?console.trace(e):console.warn(e),n=!0}return t.apply(this,arguments)}}}).call(this)}).call(this,void 0!==i.g?i.g:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{}],79:[function(t,e,i){e.exports=function t(e,i){if(e&&i)return t(e)(i);if("function"!=typeof e)throw new TypeError("need wrapper function");return Object.keys(e).forEach(function(t){n[t]=e[t]}),n;function n(){for(var t=new Array(arguments.length),i=0;i<t.length;i++)t[i]=arguments[i];var n=e.apply(this,t),o=t[t.length-1];return"function"==typeof n&&n!==o&&Object.keys(o).forEach(function(t){n[t]=o[t]}),n}}},{}],80:[function(t,e,i){"use strict";e.exports=function(){throw new Error("ws does not work in the browser. Browser clients must use the native WebSocket object")}},{}],81:[function(t,e,i){e.exports=function(){for(var t={},e=0;e<arguments.length;e++){var i=arguments[e];for(var o in i)n.call(i,o)&&(t[o]=i[o])}return t};var n=Object.prototype.hasOwnProperty},{}],82:[function(t,e,i){"use strict";e.exports=function(t){t.prototype[Symbol.iterator]=function*(){for(let t=this.head;t;t=t.next)yield t.value}}},{}],83:[function(t,e,i){"use strict";function n(t){var e=this;if(e instanceof n||(e=new n),e.tail=null,e.head=null,e.length=0,t&&"function"==typeof t.forEach)t.forEach(function(t){e.push(t)});else if(arguments.length>0)for(var i=0,o=arguments.length;i<o;i++)e.push(arguments[i]);return e}function o(t,e,i){var n=e===t.head?new r(i,null,e,t):new r(i,e,e.next,t);return null===n.next&&(t.tail=n),null===n.prev&&(t.head=n),t.length++,n}function s(t,e){t.tail=new r(e,t.tail,null,t),t.head||(t.head=t.tail),t.length++}function a(t,e){t.head=new r(e,null,t.head,t),t.tail||(t.tail=t.head),t.length++}function r(t,e,i,n){if(!(this instanceof r))return new r(t,e,i,n);this.list=n,this.value=t,e?(e.next=this,this.prev=e):this.prev=null,i?(i.prev=this,this.next=i):this.next=null}e.exports=n,n.Node=r,n.create=n,n.prototype.removeNode=function(t){if(t.list!==this)throw new Error("removing node which does not belong to this list");var e=t.next,i=t.prev;return e&&(e.prev=i),i&&(i.next=e),t===this.head&&(this.head=e),t===this.tail&&(this.tail=i),t.list.length--,t.next=null,t.prev=null,t.list=null,e},n.prototype.unshiftNode=function(t){if(t!==this.head){t.list&&t.list.removeNode(t);var e=this.head;t.list=this,t.next=e,e&&(e.prev=t),this.head=t,this.tail||(this.tail=t),this.length++}},n.prototype.pushNode=function(t){if(t!==this.tail){t.list&&t.list.removeNode(t);var e=this.tail;t.list=this,t.prev=e,e&&(e.next=t),this.tail=t,this.head||(this.head=t),this.length++}},n.prototype.push=function(){for(var t=0,e=arguments.length;t<e;t++)s(this,arguments[t]);return this.length},n.prototype.unshift=function(){for(var t=0,e=arguments.length;t<e;t++)a(this,arguments[t]);return this.length},n.prototype.pop=function(){if(this.tail){var t=this.tail.value;return this.tail=this.tail.prev,this.tail?this.tail.next=null:this.head=null,this.length--,t}},n.prototype.shift=function(){if(this.head){var t=this.head.value;return this.head=this.head.next,this.head?this.head.prev=null:this.tail=null,this.length--,t}},n.prototype.forEach=function(t,e){e=e||this;for(var i=this.head,n=0;null!==i;n++)t.call(e,i.value,n,this),i=i.next},n.prototype.forEachReverse=function(t,e){e=e||this;for(var i=this.tail,n=this.length-1;null!==i;n--)t.call(e,i.value,n,this),i=i.prev},n.prototype.get=function(t){for(var e=0,i=this.head;null!==i&&e<t;e++)i=i.next;if(e===t&&null!==i)return i.value},n.prototype.getReverse=function(t){for(var e=0,i=this.tail;null!==i&&e<t;e++)i=i.prev;if(e===t&&null!==i)return i.value},n.prototype.map=function(t,e){e=e||this;for(var i=new n,o=this.head;null!==o;)i.push(t.call(e,o.value,this)),o=o.next;return i},n.prototype.mapReverse=function(t,e){e=e||this;for(var i=new n,o=this.tail;null!==o;)i.push(t.call(e,o.value,this)),o=o.prev;return i},n.prototype.reduce=function(t,e){var i,n=this.head;if(arguments.length>1)i=e;else{if(!this.head)throw new TypeError("Reduce of empty list with no initial value");n=this.head.next,i=this.head.value}for(var o=0;null!==n;o++)i=t(i,n.value,o),n=n.next;return i},n.prototype.reduceReverse=function(t,e){var i,n=this.tail;if(arguments.length>1)i=e;else{if(!this.tail)throw new TypeError("Reduce of empty list with no initial value");n=this.tail.prev,i=this.tail.value}for(var o=this.length-1;null!==n;o--)i=t(i,n.value,o),n=n.prev;return i},n.prototype.toArray=function(){for(var t=new Array(this.length),e=0,i=this.head;null!==i;e++)t[e]=i.value,i=i.next;return t},n.prototype.toArrayReverse=function(){for(var t=new Array(this.length),e=0,i=this.tail;null!==i;e++)t[e]=i.value,i=i.prev;return t},n.prototype.slice=function(t,e){(e=e||this.length)<0&&(e+=this.length),(t=t||0)<0&&(t+=this.length);var i=new n;if(e<t||e<0)return i;t<0&&(t=0),e>this.length&&(e=this.length);for(var o=0,s=this.head;null!==s&&o<t;o++)s=s.next;for(;null!==s&&o<e;o++,s=s.next)i.push(s.value);return i},n.prototype.sliceReverse=function(t,e){(e=e||this.length)<0&&(e+=this.length),(t=t||0)<0&&(t+=this.length);var i=new n;if(e<t||e<0)return i;t<0&&(t=0),e>this.length&&(e=this.length);for(var o=this.length,s=this.tail;null!==s&&o>e;o--)s=s.prev;for(;null!==s&&o>t;o--,s=s.prev)i.push(s.value);return i},n.prototype.splice=function(t,e,...i){t>this.length&&(t=this.length-1),t<0&&(t=this.length+t);for(var n=0,s=this.head;null!==s&&n<t;n++)s=s.next;var a=[];for(n=0;s&&n<e;n++)a.push(s.value),s=this.removeNode(s);for(null===s&&(s=this.tail),s!==this.head&&s!==this.tail&&(s=s.prev),n=0;n<i.length;n++)s=o(this,s,i[n]);return a},n.prototype.reverse=function(){for(var t=this.head,e=this.tail,i=t;null!==i;i=i.prev){var n=i.prev;i.prev=i.next,i.next=n}return this.head=e,this.tail=t,this};try{t("./iterator.js")(n)}catch(t){}},{"./iterator.js":82}]},{},[12])(12)}},e={};function i(n){var o=e[n];if(void 0!==o)return o.exports;var s=e[n]={exports:{}};return t[n](s,s.exports,i),s.exports}i.d=(t,e)=>{for(var n in e)i.o(e,n)&&!i.o(t,n)&&Object.defineProperty(t,n,{enumerable:!0,get:e[n]})},i.g=function(){if("object"==typeof globalThis)return globalThis;try{return this||new Function("return this")()}catch(t){if("object"==typeof window)return window}}(),i.o=(t,e)=>Object.prototype.hasOwnProperty.call(t,e),i.r=t=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})};var n={};return(()=>{"use strict";function t(t,i){const n=i||new Path2D;if("combine"===t.name&&!t.draw)return n instanceof Path2D?n:void 0;t.setTheme||(t.setTheme=e);let o=t.calculative.borderRadius||0,s=o;const{x:a,y:r,width:l,height:c,ex:h,ey:d}=t.calculative.worldRect;o<1&&(o*=l,s*=c);let u=o<s?o:s;return l<2*u&&(u=l/2),c<2*u&&(u=c/2),n.moveTo(a+u,r),n.arcTo(h,r,h,d,u),n.arcTo(h,d,a,d,u),n.arcTo(a,d,a,r,u),n.arcTo(a,r,h,r,u),n.closePath(),n instanceof Path2D?n:void 0}function e(t,e){if(t.affectByTheme){for(const i in e)if(Object.prototype.hasOwnProperty.call(e,i)){const n=e[i];t.hasOwnProperty(i)&&(t[i]=n),t.calculative.hasOwnProperty(i)&&(t.calculative[i]=n)}t.hoverTextColor=e.textPrimaryColor,t.iconColor=e.buttonBg,t.calculative.iconColor=e.buttonBg,t.hoverBackground=e.formBg,t.activeBackground=e.activeBg,t.color=e.borderColor,t.calculative.color=e.borderColor,t.textColor=e["textColor-9"],t.calculative.textColor=e["textColor-9"]}}i.r(n),i.d(n,{AnchorMode:()=>r,CanvasLayer:()=>c,Direction:()=>A,EditType:()=>Z,EventAction:()=>ss,Gradient:()=>l,HotkeyType:()=>T,HoverType:()=>k,KeydownType:()=>Y,LineAnimateType:()=>v,LockState:()=>a,Meta2d:()=>fs,MouseRight:()=>C,PenType:()=>s,PointType:()=>M,PrevNextType:()=>E,TokenType:()=>Ot,TwoWay:()=>_,abs:()=>wt,activityDiagram:()=>Ps,activityDiagramByCtx:()=>Is,addLineAnchor:()=>Be,calcAnchorDock:()=>mi,calcCenter:()=>_i,calcChildrenInitRect:()=>Ee,calcIconRect:()=>Me,calcInView:()=>li,calcMoveDock:()=>wi,calcPadding:()=>Se,calcPenRect:()=>Pe,calcPivot:()=>Li,calcRelativePoint:()=>$i,calcRelativeRect:()=>qi,calcResizeDock:()=>bi,calcRightBottom:()=>Mi,calcRotate:()=>B,calcTextAdaptionWidth:()=>lt,calcTextAutoWidth:()=>ht,calcTextDrawRect:()=>ot,calcTextLines:()=>st,calcTextRect:()=>nt,calcWorldAnchors:()=>Ie,calcWorldPointOfPen:()=>_e,calcWorldRects:()=>Re,chartsPens:()=>Xr,classPens:()=>xs,clearLifeCycle:()=>b,clearStore:()=>it,connectLine:()=>We,createStore:()=>tt,ctxDrawLinePath:()=>xe,ctxDrawPath:()=>we,ctxFlip:()=>fe,ctxRotate:()=>pe,cubicBezierY:()=>kt,deepClone:()=>dt,deepSetValue:()=>ut,defaultCursors:()=>R,defaultDrawLineFns:()=>P,defaultFormat:()=>x,defaultOptions:()=>X,defaultTheme:()=>J,deleteTempAnchor:()=>He,disconnectLine:()=>Ve,distance:()=>N,drawDropdown:()=>de,drawFilter:()=>pi,drawIcon:()=>he,drawImage:()=>ae,expandRect:()=>ji,facePen:()=>Fe,facePoint:()=>F,fileToBase64:()=>It,findOutliersByZScore:()=>Ai,flowAnchors:()=>Ks,flowPens:()=>$s,formPens:()=>dr,formatAttrs:()=>w,formatPadding:()=>St,formatTime:()=>Ht,ftaAnchors:()=>Lr,ftaPens:()=>_r,ftaPensbyCtx:()=>Mr,getAllChildren:()=>Ut,getAllFollowers:()=>qt,getAnchor:()=>Ue,getCookie:()=>Dt,getDistance:()=>H,getFont:()=>ue,getFrameValue:()=>ai,getFromAnchor:()=>qe,getGlobalColor:()=>Te,getGradientAnimatePath:()=>ee,getMeta2dData:()=>Ft,getParent:()=>Vt,getPensDisableResize:()=>si,getPensDisableRotate:()=>ni,getPensLock:()=>ii,getPointsByPen:()=>xi,getRect:()=>Oi,getRectOfPoints:()=>Ni,getRootDomain:()=>Lt,getTextColor:()=>re,getToAnchor:()=>$e,getToken:()=>Nt,getWords:()=>at,getter:()=>zt,globalStore:()=>V,hitPoint:()=>D,inheritanceProps:()=>I,initPrevFrame:()=>Ye,isAncestor:()=>Wt,isDomShapes:()=>y,isEqual:()=>Ci,isInteraction:()=>m,isShowChild:()=>ri,le5leTheme:()=>Q,lineAnimateTargetType:()=>g,loadCss:()=>_t,nearestAnchor:()=>ze,needCalcIconRectProps:()=>f,needCalcTextRectProps:()=>h,needImgCanvasPatchFlagsProps:()=>p,needPatchFlagsPenRectProps:()=>u,needSetPenProps:()=>d,pSBC:()=>yt,pSBCr:()=>gt,pointInPolygon:()=>Ki,pointInRect:()=>Ii,pointInSimpleRect:()=>Ei,pointInVertices:()=>Di,pushPenAnchor:()=>Oe,queryURLParams:()=>Mt,randomId:()=>Ri,rectInFourAngRect:()=>zi,rectInRect:()=>Fi,rectToPoints:()=>Bi,register:()=>U,registerAnchors:()=>$,registerCanvasDraw:()=>q,registerEcharts:()=>xa,registerHighcharts:()=>ba,registerLightningChart:()=>ka,registerLineAnimateDraws:()=>K,removePenAnchor:()=>Ne,renderAnchor:()=>Ae,renderLineAnchors:()=>Ce,renderPen:()=>ve,renderPenRaw:()=>me,resizeRect:()=>Vi,rgba:()=>mt,rotatePen:()=>oi,rotatePoint:()=>L,rotatedCursors:()=>S,s12:()=>At,s16:()=>Rt,s4:()=>Tt,s8:()=>Ct,samePoint:()=>j,scaleChildrenInitRect:()=>De,scalePen:()=>Le,scalePoint:()=>O,scaleRect:()=>Ui,sequencePens:()=>Ts,sequencePensbyCtx:()=>Cs,setChildValue:()=>vi,setChildrenActive:()=>Qe,setCtxLineAnimate:()=>be,setElemImg:()=>ei,setElemPosition:()=>ti,setGlobalAlpha:()=>ci,setHover:()=>Ze,setLifeCycleFunc:()=>Si,setLineAnimate:()=>Je,setLineCap:()=>ge,setLineJoin:()=>ye,setNodeAnimate:()=>Ke,setNodeAnimateProcess:()=>Xe,setter:()=>jt,themeKeys:()=>G,translateLine:()=>je,translatePoint:()=>z,translateRect:()=>Hi,uploadFile:()=>Et,useStore:()=>et,validationPlugin:()=>Pi,valueInArray:()=>bt,valueInRange:()=>xt,wrapLines:()=>rt});const o=t;var s,a,r,l,c;!function(t){t[t.Node=0]="Node",t[t.Line=1]="Line"}(s||(s={})),function(t){t[t.None=0]="None",t[t.DisableEdit=1]="DisableEdit",t[t.DisableMove=2]="DisableMove",t[t.DisableScale=3]="DisableScale",t[t.DisableMoveScale=4]="DisableMoveScale",t[t.Disable=10]="Disable"}(a||(a={})),function(t){t[t.Default=0]="Default",t[t.In=1]="In",t[t.Out=2]="Out"}(r||(r={})),function(t){t[t.None=0]="None",t[t.Linear=1]="Linear",t[t.Radial=2]="Radial"}(l||(l={})),function(t){t[t.CanvasTemplate=1]="CanvasTemplate",t[t.CanvasImageBottom=2]="CanvasImageBottom",t[t.CanvasMain=3]="CanvasMain",t[t.CanvasImage=4]="CanvasImage"}(c||(c={}));const h=["text","textWidth","textHeight","textLeft","textTop","fontFamily","fontSize","lineHeight","fontStyle","fontWeight","textAlign","textBaseline","whiteSpace","ellipsis","keepDecimal","letterSpacing"],d=["x","y","width","height","flipX","flipY"],u=["paddingTop","paddingRight","paddingBottom","paddingLeft","flipX","flipY","visible","showChild"],f=["iconLeft","iconTop","iconRotate"],p=["globalAlpha","flipY","flipX","x","y","width","height","iconWidth","iconHeight","imageRatio","iconLeft","iconTop","iconAlign","rotate","visible"];var v,g;!function(t){t[t.Normal=0]="Normal",t[t.Beads=1]="Beads",t[t.Dot=2]="Dot",t[t.Arrow=3]="Arrow",t[t.WaterDrop=4]="WaterDrop",t[t.Custom=5]="Custom"}(v||(v={})),function(t){t[t.Image=0]="Image",t[t.Icon=1]="Icon",t[t.Pen=2]="Pen",t[t.Element=3]="Element"}(g||(g={}));const y=["gif","iframe","video","echarts","highcharts","lightningCharts","vue"],m=["radio","checkbox","button","inputDom","slider","echarts"],w=new Set(["borderRadius","paddingLeft","paddingRight","paddingTop","paddingBottom","progress","progressColor","verticalProgress","reverseProgress","flipX","flipY","input","lineDash","lineCap","lineJoin","strokeType","lineGradientFromColor","lineGradientToColor","lineGradientAngle","color","hoverColor","activeColor","lineWidth","bkType","gradientFromColor","gradientToColor","gradientAngle","gradientRadius","hoverBackground","activeBackground","globalAlpha","anchorColor","anchorRadius","shadow","shadowColor","shadowBlur","shadowOffsetX","shadowOffsetY","textHasShadow","fontFamily","fontSize","textColor","hoverTextColor","activeTextColor","textBackground","fontStyle","fontWeight","textAlign","textBaseline","lineHeight","whiteSpace","textWidth","textHeight","textLeft","textTop","ellipsis","hiddenText","keepDecimal","borderWidth","borderColor","animateLineWidth","lineAnimateType","frames","animateColor","animateType","animateReverse","background","gradientColors","lineGradientColors","animateLineWidth","gradientSmooth","lineSmooth","animations","toArrow","fromArrow","lineName","textType","textGradientColors"]),x={textType:0,bkType:0,strokeType:0};function b(t){t.onAdd=void 0,t.onValue=void 0,t.onBeforeValue=void 0,t.onDestroy=void 0,t.onMove=void 0,t.onResize=void 0,t.onRotate=void 0,t.onClick=void 0,t.onMouseEnter=void 0,t.onMouseLeave=void 0,t.onMouseDown=void 0,t.onMouseMove=void 0,t.onMouseUp=void 0,t.onShowInput=void 0,t.onInput=void 0,t.onChangeId=void 0,t.onBinds=void 0,t.onStartVideo=void 0,t.onPauseVideo=void 0,t.onStopVideo=void 0,t.onRenderPenRaw=void 0,t.onKeyDown=void 0,t.onContextmenu=void 0,t.onScale=void 0,t.onWheel=void 0,t.onConnectLine=void 0}var k,T,C,A;!function(t){t[t.None=0]="None",t[t.LineAnchor=1]="LineAnchor",t[t.NodeAnchor=2]="NodeAnchor",t[t.Line=3]="Line",t[t.Node=4]="Node",t[t.Resize=5]="Resize",t[t.Rotate=6]="Rotate",t[t.LineAnchorPrev=7]="LineAnchorPrev",t[t.LineAnchorNext=8]="LineAnchorNext"}(k||(k={})),function(t){t[t.None=0]="None",t[t.Translate=1]="Translate",t[t.Select=2]="Select",t[t.Resize=3]="Resize",t[t.AddAnchor=4]="AddAnchor"}(T||(T={})),function(t){t[t.None=0]="None",t[t.Down=1]="Down",t[t.Translate=2]="Translate"}(C||(C={})),function(t){t[t.None=-1]="None",t[t.Up=0]="Up",t[t.Right=1]="Right",t[t.Bottom=2]="Bottom",t[t.Left=3]="Left"}(A||(A={}));const R=["nw-resize","ne-resize","se-resize","sw-resize"],S=["n-resize","e-resize","s-resize","w-resize"],P=["curve","polyline","line"],I=["dash","lineWidth","lineCap","lineJoin","strokeType","color","lineGradientFromColor","lineGradientToColor","lineGradientAngle","globalAlpha","bkType","background","gradientFromColor","gradientToColor","gradientAngle","gradientRadius","fontFamily","fontSize","textColor","hoverTextColor","activeTextColor","textBackground","fontStyle","fontWeight","textAlign","textBaseline","lineHeight","whiteSpace","textLeft","textTop","flipX","flipY","lineDash","visible","iconColor"];var E,_,M;function L(t,e,i){if(!e||e%360==0)return;const n=e*Math.PI/180,o=(t.x-i.x)*Math.cos(n)-(t.y-i.y)*Math.sin(n)+i.x,s=(t.x-i.x)*Math.sin(n)+(t.y-i.y)*Math.cos(n)+i.y;t.x=o,t.y=s,t.prev&&L(t.prev,e,i),t.next&&L(t.next,e,i)}function D(t,e,i=5,n){if(e.type===M.Line){let o=n.rotate;n.flipX&&(o*=-1),n.flipY&&(o*=-1);let s=e.rotate+o;return n.flipX&&(s*=-1),n.flipY&&(s*=-1),Ii(t,{x:e.x-e.length*n.calculative.canvas.store.data.scale/2,y:e.y-i,width:e.length*n.calculative.canvas.store.data.scale,height:2*i,rotate:s})}return t.x>e.x-i&&t.x<e.x+i&&t.y>e.y-i&&t.y<e.y+i}function O(t,e,i){t.x=i.x-(i.x-t.x)*e,t.y=i.y-(i.y-t.y)*e}function B(t,e){if(t.x===e.x)return t.y<=e.y?0:180;if(t.y===e.y)return t.x<e.x?270:90;const i=t.x-e.x,n=t.y-e.y;let o=Math.atan(Math.abs(i/n))/(2*Math.PI)*360;return i>0&&n>0?o=180-o:i<0&&n>0?o+=180:i<0&&n<0&&(o=360-o),o}function N(t,e){const i=t.x-e.x,n=t.y-e.y;return Math.sqrt(i*i+n*n)}function F(t,e){let i=A.None;if(!e)return i;const n=t.x-e.x,o=t.y-e.y;return i=Math.abs(n)>Math.abs(o)?n>0?A.Right:A.Left:o>0?A.Bottom:A.Up,i}function z(t,e,i){t&&(t.x+=e,t.y+=i,t.next&&(t.next.x+=e,t.next.y+=i),t.prev&&(t.prev.x+=e,t.prev.y+=i))}function j(t,e){return t.anchorId===e.anchorId&&t.connectTo===e.connectTo}function H(t,e,i){let n=Math.sqrt((t.x-e.x)*(t.x-e.x)+(t.y-e.y)*(t.y-e.y))/i.data.scale;0===e.rotate?t.x<e.x?i.pens[e.penId].flipX||(n*=-1):i.pens[e.penId].flipX&&(n*=-1):t.y<e.y?i.pens[e.penId].flipY||(n*=-1):i.pens[e.penId].flipY&&(n*=-1),t.distance=n}!function(t){t[t.Mirror=0]="Mirror",t[t.Bilateral=1]="Bilateral",t[t.Free=2]="Free"}(E||(E={})),function(t){t[t.Default=0]="Default",t[t.In=1]="In",t[t.Out=2]="Out",t[t.DisableConnected=3]="DisableConnected",t[t.DisableConnectTo=4]="DisableConnectTo",t[t.Disable=10]="Disable"}(_||(_={})),function(t){t[t.Default=0]="Default",t[t.Line=1]="Line"}(M||(M={}));const W="1.0.84",V={version:W,path2dDraws:{},canvasDraws:{},anchors:{},lineAnimateDraws:{},htmlElements:{}};function U(t){Object.assign(V.path2dDraws,t)}function q(t){Object.assign(V.canvasDraws,t)}function $(t){Object.assign(V.anchors,t)}function K(t){Object.assign(V.lineAnimateDraws,t)}var Y;!function(t){t[t.None=-1]="None",t[t.Document=0]="Document",t[t.Canvas=1]="Canvas"}(Y||(Y={}));const X={fontFamily:'"Hiragino Sans GB", "Microsoft YaHei", "Helvetica Neue", Helvetica, Arial',fontSize:12,lineHeight:1.5,textAlign:"center",textBaseline:"middle",color:"#222222",activeColor:"#278df8",hoverColor:"rgba(39,141,248,0.50)",anchorColor:"#278DF8",hoverAnchorColor:"#FF4101",anchorRadius:4,anchorBackground:"#fff",dockColor:"rgba(39,141,248,0.50)",dockPenColor:"#1890FF",dragColor:"#1890ff",rotateCursor:"rotate.cur",rightCursor:"right.cur",downCursor:"down.cur",hoverCursor:"pointer",minScale:.1,maxScale:10,keydown:Y.Document,gridSize:20,gridColor:"#e2e2e2",ruleColor:"#888888",drawingLineName:"curve",interval:30,animateInterval:30,autoPolyline:!0,autoAnchor:!0,autoAlignGrid:!1,animateColor:"#30EEDC",ruleLineColor:"#FF4101",shadowOffsetX:0,shadowOffsetY:0,shadowBlur:64,shadowColor:"#00000014",globalAlpha:1,defaultAnchors:[{x:.5,y:0},{x:1,y:.5},{x:.5,y:1},{x:0,y:.5}],measureTextWidth:!0,moveConnectedLine:!0,mouseRightActive:!0,disableClipboard:!1,drawingLineLength:0,disableTouchPadScale:!1,cdn:"",polylineSpace:10,domShapes:[],containerShapes:["tablePlus"],textFlip:!0,textRotate:!0,unavailableKeys:[],diagramOptions:{},svgPathStroke:!0,reconnetTimes:10},G=["color","hoverColor","activeColor","disabledColor","background","activeBackground","hoverBackground","disabledBackground","anchorColor","hoverAnchorColor","anchorBackground","animateColor","textColor","ruleColor","ruleLineColor","gridColor","lineColor","penBackground","dockPenColor"],J={dark:{color:"#bdc7db",background:"#1e2430",parentBackground:"#080b0f",ruleColor:"#222E47",ruleOptions:{background:"#121924",textColor:"#6E7B91"}},light:{color:"#222222",background:"#FFFFFF",parentBackground:"#F0F1F2",ruleColor:"#C8D0E1",ruleOptions:{background:"#F7F8FA",textColor:"#C8D0E1"}}},Q={cssRuleSelector:":root",style_prefix:"le5le_",vendor_css_prefix:"--le-",dark:["textColor-9: rgba(255,255,255,0.90)","textColor-6: rgba(255,255,255,0.60)","textColor-1: rgba(255,255,255,1)","textColor-4: rgba(255,255,255,0.40)","textPrimaryColor: #7f838c","textSecondColor: rgba(255,255,255,0.90)","textDisabledColor: rgba(255,255,255,0.40)","textActiveColor: #0052d9","buttonBg: #4583ff","buttonDisabledBg: #0057CC","buttonDisabledColor: #FFFFFF26","buttonGradient: linear-gradient(360deg,#4583ff, #33ccff)","containerBg: rgba(21,24,28,0.95)","tabBg: #303746","tabActiveBg: #4583ff","tabDisabledBg: #282e3b","tabDisabledColor: rgba(255,255,255,0.26)","tabActiveColor: rgba(255,255,255,0.90)","formBg: #2a2f36","datePickerCellActiveRangeBg: #2c4475","componentDisabledBg: #282e3b","dataPickerCellActiveBg: #001b52","activeBg: #25375b","popContentBg: #252b37","disabledBg: #7f838c","disabledBg-2: #282E3B","tableStripeColor: rgba(150,192,255,0.10)","tableMenuBg: #303746","tableMenuDividerBg: rgb(76 81 94)","tableMenuHandleBg: #454f64","tableMenuColor: #bdc7db","tableMenuBorderColor: transparent","tableColRowBg: #303746","tableColRowActiveBg: #4A5263","tableColRowColor: rgba(255,255,255,0.6)","paginationColor: rgba(255,255,255,0.6)","paginationActiveColor: #4583ff","paginationActiveBg: rgba(69,131,255,0.20)","sliderBg: #303746","sliderBtnBg: #000000","notificationBorderColor: transparent","notificationBg: #282e3b","borderColor: #424b61","borderOutsideColor: #4583ff","formBorderColor: #424b61","borderInsideColor: rgba(255,255,255,0.40)","shadow: 0px 1px 10px 0px rgba(0,0,0,0.05), 0px 4px 5px 0px rgba(0,0,0,0.08), 0px 2px 4px -1px rgba(0,0,0,0.12)","radius: 4px"],light:["textColor-9: rgba(0,0,0,0.90)","textColor-6: rgba(0,0,0,0.60)","textColor-1: rgba(0,0,0,1)","textColor-4: rgba(0,0,0,0.40)","textPrimaryColor: #7f838c","textSecondColor: #171B27","textDisabledColor: rgba(0, 0, 0, 0.6)","textActiveColor: #0052d9","buttonBg: #4583ff","buttonDisabledBg: #b5c7ff","buttonDisabledColor: #FFFFFF","buttonGradient: linear-gradient(360deg,#4583ff, #33ccff)","containerBg: #ffffff","tabBg: #f1f2f5","tabActiveBg: #4583ff","tabDisabledBg: #e2e6ea","tabDisabledColor: rgba(0,0,0,0.26)","tabActiveColor: #ffffff","formBg: #EFF1F4","datePickerCellActiveRangeBg: #f2f3ff","componentDisabledBg: #eee","dataPickerCellActiveBg: #edefff","activeBg: #f2f3ff","popContentBg: #ffffff","disabledBg: #7f838c","disabledBg-2: #E2E6EA","tableStripeColor: #f1f2f5","tableMenuBg: #ffffff","tableMenuDividerBg: #e2e6ea","tableMenuHandleBg: #ebedf1","tableMenuColor: rgba(0,0,0,0.60)","tableMenuBorderColor: #e2e6ea","tableColRowBg: #ebedf1","tableColRowActiveBg: #bcc4d0","tableColRowColor: rgba(0,0,0,0.4)","paginationColor: rgba(0,0,0,0.6)","paginationActiveColor: #ffffff","paginationActiveBg: #4583ff","sliderBg: #e2e6ea","sliderBtnBg: #ffffff","notificationBorderColor: transparent","notificationBg: #ffffff","borderColor: #d6dbe3","borderOutsideColor: #d6dbe3","formBorderColor: #d4d6d9","borderInsideColor: #e7e7e7","shadow: 0px 2px 4px 0px rgba(107,113,121,0.25)","radius: 4px"],camelCaseToHyphenated:t=>t.replace(/[A-Z]/g,t=>"-"+t.toLowerCase()),_addVendorCssPrefix(t){return t.map(t=>{const[e,i]=t.split(":");return`${this.vendor_css_prefix}${this.camelCaseToHyphenated(e.trim())}:${i.trim()}`})},createThemeSheet(t,e){const i=document.createElement("style");i.type="text/css",i.id=this.style_prefix+e,document.head.appendChild(i);const n=t||"dark",o=this.getTheme(n),s=`${this.cssRuleSelector} { ${o.join(";")} }`;i.innerHTML=s},destroyThemeSheet(t){const e=this.findStyleSheet(this.style_prefix+t);e&&document.head.removeChild(e.ownerNode)},addTheme(t,e){Object.assign(this,{[t]:e})},getTheme(t){return this._addVendorCssPrefix(this[t]||this.light)},getThemeObj(t="dark"){const e=this[t].reduce((t,e)=>{const[i,n]=e.split(":");return t[i]=n,t},{});return e},findStyleSheet(t){const e=document.styleSheets;for(let i=0;i<e.length;i++){const n=e[i];if(n.ownerNode&&n.ownerNode.id===t)return n}return null},updateCssRule(t,e){const i=this.getTheme(e),n=this.findStyleSheet(this.style_prefix+t);if(!n)return;let o=!1;for(let t=0;t<n.cssRules.length;t++)if(n.cssRules[t].selectorText===this.cssRuleSelector){o=!0;break}if(o)for(let t=0;t<n.cssRules.length;t++){const e=n.cssRules[t];if(e.selectorText===this.cssRuleSelector)if(n.insertRule){n.deleteRule(t);const e=`${this.cssRuleSelector} { ${i.join(";")} }`;n.insertRule(e,t)}else n.addRule&&(e.style.cssText=i.join(";"))}else if(n.insertRule){const t=`${this.cssRuleSelector} { ${i.join(";")} }`;n.insertRule(t,n.cssRules.length)}else if(n.addRule){const t=n.cssRules.find(t=>t.selectorText===this.cssRuleSelector);if(t){const e=i.join(";");t.style.cssText+=`; ${e}`}else n.addRule(this.cssRuleSelector,i.join(";"))}}};var Z;!function(t){t[t.Add=0]="Add",t[t.Update=1]="Update",t[t.Delete=2]="Delete",t[t.Replace=3]="Replace"}(Z||(Z={}));const tt=()=>{return{data:{x:0,y:0,scale:1,pens:[],origin:{x:0,y:0},center:{x:0,y:0},paths:{}},histories:[],pens:{},path2dMap:new WeakMap,animateMap:new WeakMap,active:[],animates:new Set,options:{...X},theme:{...J},emitter:{all:t=t||new Map,on:function(e,i){var n=t.get(e);n&&n.push(i)||t.set(e,[i])},off:function(e,i){var n=t.get(e);n&&n.splice(n.indexOf(i)>>>0,1)},emit:function(e,i){(t.get(e)||[]).slice().map(function(t){t(i)}),(t.get("*")||[]).slice().map(function(t){t(e,i)})}},bindDatas:{},bind:{},pensNetwork:{},cacheDatas:[],messageEvents:{},templatePens:{},globalTriggers:{}};var t},et=(t="default")=>(V[t]||(V[t]=tt(),V[t].id=t),V[t]),it=(t,e)=>{const i=t.data.template===e;if(i)for(const e of t.data.pens)e.canvasLayer===c.CanvasTemplate&&(t.templatePens[e.id]=e);t.lastScale=t.data.scale,t.data={x:0,y:0,scale:1,pens:[],origin:{x:0,y:0},center:{x:0,y:0},paths:{},template:i?e:null,lineAnimateDraws:{}},t.sameTemplate=i,t.pens={},t.histories=[],t.historyIndex=null,t.path2dMap=new WeakMap,t.animateMap=new WeakMap,t.bindDatas={},t.bind={},t.pensNetwork={},t.active=[],t.hover=void 0,t.lastHover=void 0,t.animates.clear()};function nt(t){const{paddingTop:e,paddingBottom:i,paddingLeft:n,paddingRight:o,worldRect:s,canvas:a}=t.calculative;let{textLeft:r,textTop:l,textWidth:c,textHeight:h}=t.calculative,d=n,u=e;const f=s.width-n-o,p=s.height-e-i;c&&c<1&&(c*=s.width),h&&h<1&&(h*=s.height),c<t.calculative.fontSize&&(c=t.calculative.fontSize),d+=(r||0)+s.x,u+=(l||0)+s.y;const v=t.textAlign||a.store.options.textAlign,g=t.textBaseline||a.store.options.textBaseline;switch(v){case"center":d+=(f-(c||f))/2;break;case"right":d+=f-(c||f)}switch(g){case"middle":u+=(p-(h||p))/2;break;case"bottom":u+=p-(h||p)}const y={x:d,y:u,width:c||f,height:h||p};Mi(y),t.calculative.worldTextRect=y,st(t),t.calculative.textDrawRect=void 0}function ot(t,e){const i=e.calculative.fontSize*e.calculative.lineHeight,n=e.calculative.textLines.length*i,o=lt(t,e),s=e.calculative.worldTextRect;let a=s.x+(s.width-o)/2,r=s.y+(s.height-n)/2;const l=e.calculative.canvas.store.options;switch(e.textAlign||l.textAlign){case"left":a=s.x;break;case"right":a=s.x+s.width-o}switch(e.textBaseline||l.textBaseline){case"top":r=s.y;break;case"bottom":r=s.ey-n}e.calculative.textDrawRect={x:a,y:r,width:o,height:n},Mi(e.calculative.textDrawRect)}function st(t,e=t.calculative.text){if(null==e)return void(t.calculative.textLines=[]);e=e.toString();const i=t.calculative.keepDecimal;if(null!=i&&null!=e&&""!==e&&""!==e.trim()){const t=Number(e);isNaN(t)||(e=t.toFixed(i))}let n=[];const o=t.calculative.fontSize*t.calculative.lineHeight,s=t.calculative.worldTextRect.height,a=Math.floor(s/o),r=a>1?a:1;switch(t.whiteSpace){case"nowrap":if(!1!==t.ellipsis){const i=rt(e.split(""),t);i[0]&&(n.push(i[0]),i.length>1&&ct(n))}else n.push(e);break;case"pre-line":n=e.split(/[\n]/g),!1!==t.ellipsis&&n.length>r&&(n=n.slice(0,r),ct(n));break;default:const i=e.split(/[\n]/g);let o=0;t:for(const e of i){let i=rt("break-all"===t.whiteSpace?e.split(""):at(e),t);if(0===i.length&&(i=[""]),0!=t.ellipsis)for(const t of i){if(o++,o>r){ct(n);break t}n.push(t)}else n.push(...i)}}return t.calculative.textLines=n,n}function at(t=""){const e=[];let i="";for(let n=0;n<t.length;++n){const o=t.charCodeAt(n);o<33||o>126?(i&&(e.push(i),i=""),e.push(t[n])):i+=t[n]}return i&&e.push(i),e}function rt(t,e){const i=e.calculative.canvas,n=i.offscreen.getContext("2d"),{fontStyle:o,fontWeight:s,fontSize:a,fontFamily:r,lineHeight:l}=e.calculative;n.save();const c=[];let h=t[0]||"";for(let d=1;d<t.length;++d){const u=t[d]||"",f=h+u;let p=0;if(i.store.options.measureTextWidth)n.font=ue({fontStyle:o,fontWeight:s,fontFamily:r||i.store.options.fontFamily,fontSize:a,lineHeight:l}),p=n.measureText(f).width;else{const t=f.match(/[^\x00-\xff]/g)||"",e=t.length*a,i=f.match(/\s/g)||"";p=e+i.length*a*.3+(f.length-t.length-i.length)*a*.6}p<=e.calculative.worldTextRect.width+.1?h+=u:(h.length&&c.push(h),h=u)}return h.length&&c.push(h),n.restore(),c}function lt(t,e){let i=0;return e.calculative.textLineWidths=[],e.calculative.textLines.forEach(n=>{const o=t.measureText(n).width+n.length*e.calculative.letterSpacing;e.calculative.textLineWidths.push(o),i<o&&(i=o)}),i}function ct(t){t[t.length-1]=t[t.length-1].slice(0,-3)+"..."}function ht(t){let e=t.text.split("\n");const i=t.calculative.canvas,n=i.offscreen.getContext("2d"),{fontStyle:o,fontWeight:s,fontSize:a,fontFamily:r,lineHeight:l}=t.calculative;let c=0,h=0;n.save();for(let d=0;d<e.length;d++){if(i.store.options.measureTextWidth)n.font=ue({fontStyle:o,fontWeight:s,fontFamily:r||i.store.options.fontFamily,fontSize:a,lineHeight:l}),h=n.measureText(e[d]).width+e[d].length*t.calculative.letterSpacing;else{const i=e[d].match(/[^\x00-\xff]/g)||"",n=i.length*a,o=e[d].match(/\s/g)||"";h=n+o.length*a*.3+(e[d].length-i.length-o.length)*a*.6+e[d].length*t.calculative.letterSpacing}h>c&&(c=h)}n.restore();let d=e.length*a*l;"left"===t.textAlign||("right"===t.textAlign?t.x=t.x-(c-t.width):t.x=t.x-(c-t.width)/2),"top"===t.textBaseline||("bottom"===t.textBaseline?t.y=t.y-(d-t.height):t.y=t.y-(d-t.height)/2),t.height=d+5,t.width=c+5,t.calculative.canvas.updatePenRect(t),t.calculative.canvas.calcActiveRect()}function dt(t,e=!1){if(Array.isArray(t)){const i=[];return t.forEach(t=>{i.push(dt(t,e))}),i}if("object"==typeof t){if(null===t)return null;if(t.constructor===RegExp)return t;const i={};for(const n in t)["canvas","lastFrame","socketFn"].includes(n)||t[n]instanceof HTMLImageElement||t[n]instanceof HTMLMediaElement||("calculative"!==n||e)&&(i[n]="singleton"!==n?dt(t[n],e):e?{}:t[n]);return i}return t}function ut(t,e,i){if(Array.isArray(t)){const n=[];return t.forEach(t=>{n.push(ut(t,e,i))}),n}if("object"==typeof t){if(null===t)return null;for(const n in t)if(e.includes(n))if(Array.isArray(t[n]))t[n].forEach((e,o)=>{Number.isNaN(Number(e))||(t[n][o]=Number(e*i))});else{if(Number.isNaN(Number(t[n])))continue;t[n]=Number(t[n])*i}else t[n]=ut(t[n],e,i);return t}return t}const ft={};function pt(t,e,i){if(!ft[e.fromArrow])return;const n=qe(e),{x:o,y:s}=n,a={x:o,y:s};if(a.step=(e.fromArrowSize||10)*i.data.scale,n.next)a.rotate=B(n.next,n)+90;else{const t=e.calculative.worldAnchors[1];if(!t)return;t.prev?a.rotate=B(t.prev,n)+90:a.rotate=B(t,n)+90}t.save(),t.beginPath(),t.setLineDash([]);const r=e.fromArrowColor||e.calculative.color;r&&(t.strokeStyle=r),ft[e.fromArrow](t,e,i,a),t.restore()}function vt(t,e,i){if(!ft[e.toArrow]||e.calculative.worldAnchors.length<2)return;t.save();const n=$e(e),{x:o,y:s}=n,a={x:o,y:s};if(a.step=(e.toArrowSize||10)*i.data.scale,n.prev)a.rotate=B(n.prev,n)+90;else{const t=e.calculative.worldAnchors[e.calculative.worldAnchors.length-2];t.next?a.rotate=B(t.next,n)+90:a.rotate=B(t,n)+90}t.beginPath(),t.setLineDash([]);const r=e.toArrowColor||e.calculative.color;r&&(t.strokeStyle=r),ft[e.toArrow](t,e,i,a),t.restore()}function gt(t){const e=parseInt,i=Math.round;let n=t.length,o={};if(n>9){const[i,s,a,r]=t=t.split(",");if(n=t.length,n<3||n>4)return null;o.r=e("a"==i[3]?i.slice(5):i.slice(4)),o.g=e(s),o.b=e(a),o.a=r?parseFloat(r):-1}else{if(8==n||6==n||n<4)return null;n<6&&(t="#"+t[1]+t[1]+t[2]+t[2]+t[3]+t[3]+(n>4?t[4]+t[4]:"")),t=e(t.slice(1),16),9==n||5==n?(o.r=t>>24&255,o.g=t>>16&255,o.b=t>>8&255,o.a=i((255&t)/.255)/1e3):(o.r=t>>16,o.g=t>>8&255,o.b=255&t,o.a=-1)}return o}function yt(t,e,i,n){let o,s,a,r,l,c,h,d=Math.round,u="string"==typeof i;return"number"!=typeof t||t<-1||t>1||"string"!=typeof e||"r"!=e[0]&&"#"!=e[0]||i&&!u?null:(h=e.length>9,h=u?i.length>9||"c"==i&&!h:h,l=gt(e),r=t<0,c=i&&"c"!=i?gt(i):r?{r:0,g:0,b:0,a:-1}:{r:255,g:255,b:255,a:-1},r=1-(t=r?-1*t:t),l&&c?(n?(o=d(r*l.r+t*c.r),s=d(r*l.g+t*c.g),a=d(r*l.b+t*c.b)):(o=d((r*l.r**2+t*c.r**2)**.5),s=d((r*l.g**2+t*c.g**2)**.5),a=d((r*l.b**2+t*c.b**2)**.5)),u=l.a,c=c.a,l=u>=0||c>=0,u=l?u<0?c:c<0?u:u*r+c*t:0,h?"rgb"+(l?"a(":"(")+o+","+s+","+a+(l?","+d(1e3*u)/1e3:"")+")":"#"+(4294967296+16777216*o+65536*s+256*a+(l?d(255*u):0)).toString(16).slice(1,l?void 0:-2)):null)}function mt(t,e){const i=gt(t)||{r:0,g:0,b:0};return i.a<0?`rgba(${i.r},${i.g},${i.b},${e})`:`rgba(${i.r},${i.g},${i.b},${e+i.a})`}function wt(t,e){return+e?+e:e&&"%"===e[e.length-1]?t*+(e=e.substr(0,e.length-1))/100:0}function xt(t,e){if(isNaN(t))return void console.warn("realValue not number");if("string"!=typeof e)return void console.warn("collection must be string");const[i,n]=[e[0],e[e.length-1]];if(!["[","("].includes(i))return void console.warn('collection must start with "[" or "("');if(!["]",")"].includes(n))return void console.warn('collection must end with "]" or ")"');const o=e.substring(1,e.length-1).split(",");if(2!==o.length)return void console.warn("collection must have 2 numbers");const[s,a]=[+o[0],+o[1]];if(!(s>=a))return(t>s||"["===i&&t===s)&&(t<a||"]"===n&&t===a);console.warn("startNum must less than endNum")}function bt(t,e){if("string"!=typeof e)return void console.warn("collection must be string");const[i,n]=[e[0],e[e.length-1]];if("["!==i||"]"!==n)return void console.warn('collection must start with "[" and end with "]"');const o=e.substring(1,e.length-1).split(",");for(const e of o)if(e.includes("..")){const[i,n]=e.split(".."),[o,s]=[+i,+n];if(o>=s)return void console.warn("startNum must less than endNum");if(t>=o&&t<=s)return!0}else if(t==e)return!0;return!1}function kt(t,e,i){const n=1-t;return 3*n*n*t*e+3*n*t*t*i+t*t*t}function Tt(){return(65536*(1+Math.random())|0).toString(16).substring(1)}function Ct(){return(4294967296*(1+Math.random())|0).toString(16).substring(1)}function At(){return Tt()+Ct()}function Rt(){return Ct()+Ct()}ft.triangleSolid=(t,e,i,n)=>{t.save(),t.translate(n.x,n.y),t.rotate(n.rotate*Math.PI/180),t.translate(-n.x,-n.y);const o=n.x-n.step;t.moveTo(o,n.y-n.step/4),t.lineTo(n.x,n.y),t.lineTo(o,n.y+n.step/4),t.closePath(),t.stroke(),t.fillStyle=t.strokeStyle,t.fill(),t.restore()},ft.reTriangleSolid=(t,e,i,n)=>{t.save(),t.translate(n.x,n.y),t.rotate(n.rotate*Math.PI/180),t.translate(-n.x,-n.y);const o=n.x-n.step/2;t.moveTo(n.x,n.y-n.step/2),t.lineTo(o,n.y),t.lineTo(n.x,n.y+n.step/2),t.closePath(),t.stroke(),t.fillStyle=t.strokeStyle,t.fill(),t.restore()},ft.triangle=(t,e,i,n)=>{t.save(),t.lineWidth<2&&(t.lineWidth=2),t.translate(n.x,n.y),t.rotate(n.rotate*Math.PI/180),t.translate(-n.x,-n.y);const o=n.x-n.step;t.moveTo(o,n.y-n.step/4),t.lineTo(n.x,n.y),t.lineTo(o,n.y+n.step/4),t.closePath(),t.stroke(),t.fillStyle=i.data.background||"#ffffff",t.fill(),t.restore()},ft.circleSolid=(t,e,i,n)=>{t.save(),t.translate(n.x,n.y),t.rotate(n.rotate*Math.PI/180),t.translate(-n.x,-n.y);const o=n.step/2;t.arc(n.x-o,n.y,o,0,2*Math.PI),t.stroke(),t.fillStyle=t.strokeStyle,t.fill(),t.restore()},ft.circle=(t,e,i,n)=>{t.save(),t.translate(n.x,n.y),t.rotate(n.rotate*Math.PI/180),t.translate(-n.x,-n.y);const o=n.step/2;t.arc(n.x-o,n.y,o,0,2*Math.PI),t.stroke(),t.fillStyle=i.data.background||"#ffffff",t.fill(),t.restore()},ft.diamondSolid=(t,e,i,n)=>{t.save(),t.translate(n.x,n.y),t.rotate(n.rotate*Math.PI/180),t.translate(-n.x,-n.y);const o=n.x-n.step,s=n.step/2;t.moveTo(o,n.y),t.lineTo(o+s,n.y-s/2),t.lineTo(n.x,n.y),t.lineTo(o+s,n.y+s/2),t.closePath(),t.stroke(),t.fillStyle=t.strokeStyle,t.fill(),t.restore()},ft.diamond=(t,e,i,n)=>{t.save(),t.translate(n.x,n.y),t.rotate(n.rotate*Math.PI/180),t.translate(-n.x,-n.y);const o=n.x-n.step,s=n.step/2;t.moveTo(o,n.y),t.lineTo(o+s,n.y-s/2),t.lineTo(n.x,n.y),t.lineTo(o+s,n.y+s/2),t.closePath(),t.stroke(),t.fillStyle=i.data.background||"#ffffff",t.fill(),t.restore()},ft.line=(t,e,i,n)=>{t.save(),t.translate(n.x,n.y),t.rotate(n.rotate*Math.PI/180),t.translate(-n.x,-n.y);const o=n.x-n.step;t.moveTo(o,n.y-n.step/3),t.lineTo(n.x,n.y),t.lineTo(o,n.y+n.step/3),t.stroke(),t.restore()},ft.lineUp=(t,e,i,n)=>{t.save(),t.translate(n.x,n.y),t.rotate(n.rotate*Math.PI/180),t.translate(-n.x,-n.y);const o=n.x-n.step;t.moveTo(o,n.y-n.step/3),t.lineTo(n.x,n.y),t.stroke(),t.restore()},ft.lineDown=(t,e,i,n)=>{t.save(),t.translate(n.x,n.y),t.rotate(n.rotate*Math.PI/180),t.translate(-n.x,-n.y);const o=n.x-n.step;t.moveTo(o,n.y+n.step/3),t.lineTo(n.x,n.y),t.stroke(),t.restore()},globalThis.pSBC=yt;const St=t=>{let e=0,i=0,n=0,o=0;return"number"==typeof t?e=i=n=o=t:"string"==typeof t?e=i=n=o=parseInt(t,10):Array.isArray(t)&&(e=t[0],n=Pt(t[1])?t[0]:t[1],o=Pt(t[2])?t[0]:t[2],i=Pt(t[3])?n:t[3]),[e,n,o,i]};function Pt(t){return null==t}async function It(t){return new Promise((e,i)=>{const n=new FileReader;n.onload=t=>{e(t.target.result)},n.onerror=t=>{i(t)},n.readAsDataURL(t)})}async function Et(t,e,i,n){const o=new FormData;if(o.append("file",t),i)for(const t in i)i.hasOwnProperty(t)&&o.append(t,i[t]);const s=await fetch(e,{method:"POST",headers:n,body:o});return(await s.json()).url}function _t(t,e,i){var n=document.createElement("link");n.href=t,n.rel="stylesheet",e&&(n.onload=e),i&&(n.onerror=i),document.head.appendChild(n)}function Mt(t){let e=t||window.location.search.split("?")[1];const i=new URLSearchParams(e);return Object.fromEntries(i.entries())}const Lt=()=>{let t="";const e=location.hostname.split(".");return t=e.length<3||4===e.length&&+e[0]>0&&+e[1]>0&&+e[2]>0&&+e[3]>0?location.hostname:location.hostname.endsWith(".com.cn")||location.hostname.endsWith(".org.cn")?e.slice(-3).join("."):e.slice(-2).join("."),t};function Dt(t){let e;const i=new RegExp("(^| )"+t+"=([^;]*)(;|$)");return(e=document.cookie.match(i))?decodeURIComponent(e[2]):""}var Ot;!function(t){t[t.None=0]="None",t[t.LocalStorage=1]="LocalStorage",t[t.Cookie=2]="Cookie"}(Ot||(Ot={}));const Bt=-1!==location.host.indexOf("le5le.com");function Nt(){const t=globalThis.le5leTokenName??"token";switch(globalThis.le5leTokenType){case Ot.LocalStorage:return localStorage.getItem(t);case Ot.Cookie:return Dt(t);default:return Bt?Dt(t):localStorage.getItem(t)}}async function Ft(t,e){if(globalThis.getMeta2dData)return await globalThis.getMeta2dData(e);const i=t.options.navigatorNetWork;let n=`/api/data/${location.href.includes("2d.")||location.href.includes("/2d")?"2d":"v"}/get`,o=Mt()?.id||n.includes("${id}");if(!o){let t=Mt()?.data;if(t){n=`./projects/${e}`;const t=new URL(window.location);t.searchParams.set("data",e),history.pushState({},"",t)}}i?.url&&(n=i.url.includes("${id}")?i.url.replace("${id}",e):i.url+("GET"===i?.method?`?id=${e}`:""));let s=i?.method||"POST";o||(s="GET");const a=await fetch(n,{headers:{Authorization:`Bearer ${Nt()}`},method:s,body:"GET"===s?void 0:JSON.stringify({id:e})});if(a.ok){let t=await a.text();return t.constructor===Object||t.constructor===Array?t=JSON.parse(JSON.stringify(t)):"string"==typeof t&&(t=JSON.parse(t)),t.data&&(t=t.data),t}t.emitter.emit("error",{type:"http",error:a})}function zt(t,e){if(null==e)return t;const i=e.split(".");for(;i.length&&(t=t[i.shift()]););return t}function jt(t,e,i){null!=e&&e.split(".").reduce((t,n,o)=>t[n]=e.split(".").length===++o?i:t[n]||{},t)}function Ht(t,e){let i=new Date;e&&(i=new Date(e));const n=i.getFullYear(),o=i.getMonth()+1,s=i.getDate(),a=i.getDay(),r=i.getHours(),l=i.getMinutes(),c=i.getSeconds();return new Function("year","month","day","week","hours","minutes","seconds",t?`return ${t}`:"return `${year}:${month}:${day} ${hours}:${minutes}:${seconds} ${week}`")(n,o,s,["","","","","","",""][a],r,l,c)}function Wt(t,e){if(!t||!e)return!1;let i=Vt(t);for(;i;){if(i.id===e.id)return!0;i=Vt(i)}return!1}function Vt(t,e){if(!t||!t.parentId||!t.calculative)return;const i=t.calculative.canvas.store.pens[t.parentId];return e&&Vt(i,e)||i}function Ut(t,e){if(!t||!t.children)return[];const i=[];return t.children.forEach(t=>{const n=e.pens[t];n&&(i.push(n),i.push(...Ut(n,e)))}),i}function qt(t,e){if(!t||!t.followers)return[];const i=[];return t.followers.forEach(t=>{const n=e.pens[t];n&&!n.parentId&&(i.push(n),i.push(...qt(n,e)))}),i}function $t(t,e,i){const n=Math.atan(i/e)/Math.PI*180;let o=(t-90)%360,s=0;return o>n&&o<180-n||o>180+n&&o<360-n||o<0?(o>270?o=360-o:o>180?o-=180:o>90&&(o=180-o),s=Math.abs(i/Math.sin(o/180*Math.PI)/2)):(o>270?o=360-o:o>180?o-=180:o>90&&(o=180-o),s=Math.abs(e/Math.cos(o/180*Math.PI)/2)),s}function Kt(t){if("string"==typeof t&&t.startsWith("linear-gradient")){let e=t.slice(16,-2).split("deg,");if(e.length>1){let t=e[1].split("%,");const i=[];return t.forEach(t=>{if(/rgba?/.test(t)){let e=t.split(") ");i.push({color:Yt(e[0]+")"),i:parseFloat(e[1])/100})}else{let e=t.split(" ");e.length>2?i.push({color:e[1],i:parseFloat(e[2])/100}):i.push({color:e[0],i:parseFloat(e[1])/100})}}),{angle:parseFloat(e[0]),colors:i}}return{angle:parseFloat(e[0]),colors:[]}}return{angle:0,colors:[]}}function Yt(t){if(/rgba?/.test(t)){let e=t.split(",");if(e.length<3)return"";t="#";for(let i,n=0;i=e[n++];)if(n<4)i=parseInt(i.replace(/[^\d]/gi,""),10).toString(16),t+=1==i.length?"0"+i:i;else{i=i.replace(")","");let e=parseInt(255*i+"").toString(16);e=2===e.length?e:"0"+e,t+=e}t=t.toUpperCase()}return t}function Xt(t,e,i,n){let o=function(t,e,i,n,o){let s=0;s=Math.PI/2-Math.atan2(n-e,i-t);const a=(t+i)/2,r=(e+n)/2;return[a+o*Math.sin(90*Math.PI/180-s),r+o*-Math.cos(90*Math.PI/180-s),a+o*Math.sin(270*Math.PI/180-s),r+o*-Math.cos(270*Math.PI/180-s)]}(e[0].x,e[0].y,e[1].x,e[1].y,n),s=t.createLinearGradient(o[0],o[1],o[2],o[3]);return i.forEach(t=>{s.addColorStop(t.i,t.color)}),s}function Gt(t,e,i){let n=[];e.calculative.gradientColorStop?n=e.calculative.gradientColorStop:(n=Kt(e.calculative.lineGradientColors).colors,e.calculative.gradientColorStop=n),t.strokeStyle=Xt(t,i,n,e.calculative.lineWidth/2),t.beginPath(),t.moveTo(i[0].x,i[0].y),t.lineTo(i[1].x,i[1].y),t.stroke()}function Jt(t,e){const i=e.calculative.worldAnchors;let n=e.calculative.lineWidth*(e.calculative.gradientSmooth||e.calculative.lineSmooth||0);for(let o=0;o<i.length-1;o++)if("curve"!==e.lineName&&"mind"!==e.lineName||!i[o].curvePoints){let s=i[o],a=i[o+1];if(o>0&&o<i.length-1){let s=i[o-1].curvePoints;Zt(t,e,n,s?s[s.length-1]:i[o-1],i[o],i[o+1])}o>0&&o<i.length-1&&(s=Qt(n,i[o],i[o+1])),o<i.length-2&&(a=Qt(n,i[o+1],i[o]));let r=!1;if(0===o&&e.fromLineCap&&"butt"!==e.fromLineCap&&(t.save(),r=!0,t.lineCap=e.fromLineCap),0!==o&&o===i.length-2&&e.toLineCap&&"butt"!==e.toLineCap&&(t.save(),r=!0,t.lineCap=e.toLineCap),Gt(t,e,[s,a]),r&&t.restore(),2===i.length&&0===o){t.save(),r=!0,t.lineCap=e.toLineCap;let i=.1,n=.1;s.x-a.x===0?n=0:i=(s.y-a.y)/(s.x-a.x)*.1,Gt(t,e,[{x:a.x-n,y:a.y-i},a]),t.restore()}}else{if(o>0){let s=i[o-1].curvePoints;Zt(t,e,n,s?s[s.length-1]:i[o-1],i[o],i[o].curvePoints[0]),Gt(t,e,[Qt(n,i[o],i[o].curvePoints[0]),i[o].curvePoints[1]])}else Gt(t,e,[i[o],i[o].curvePoints[0]]),Gt(t,e,[i[o].curvePoints[0],i[o].curvePoints[1]]);let s=i[o].curvePoints.length-1;for(let n=1;n<s;n++)Gt(t,e,[i[o].curvePoints[n],i[o].curvePoints[n+1]]);let a=Qt(n,i[o+1],i[o].curvePoints[s]);Gt(t,e,[i[o].curvePoints[s],a])}}function Qt(t,e,i){let n=Math.sqrt((i.x-e.x)*(i.x-e.x)+(i.y-e.y)*(i.y-e.y));return 0===n?{x:e.x,y:e.y}:t<n?{x:e.x+(i.x-e.x)*t/n,y:e.y+(i.y-e.y)*t/n}:{x:e.x+(i.x-e.x)/n/2,y:e.y+(i.y-e.y)/n/2}}function Zt(t,e,i,n,o,s){let a=Qt(i,o,n),r=Qt(i,o,s),l={x:o.x,y:o.y},c=function(t=100,e,i,n,o){let s=null;const a=[];n||o?n&&!o?s=ne:n&&o&&(s=oe):s=ie;for(let r=0;r<t;r++)a.push(s(r/t,e,i,n,o));return o?a.push(o):n&&a.push(n),a}(e.calculative.canvas.store.data.smoothNum||20,a,l,r);for(let i=0;i<c.length-1;i++)Gt(t,e,[{x:c[i].x,y:c[i].y},{x:c[i+1].x,y:c[i+1].y}])}function te(t,e,i,n){let o=Qt(e,i,n),s={x:i.x,y:i.y};t.quadraticCurveTo(s.x,s.y,o.x,o.y)}function ee(t){const e=t.calculative.worldAnchors;let i=t.calculative.lineWidth*(t.calculative.gradientSmooth||t.calculative.lineSmooth||0);const n=new Path2D;for(let t=0;t<e.length-1;t++){let o=e[t],s=e[t+1];0==t&&n.moveTo(e[t].x,e[t].y),t>0&&t<e.length-1&&(e[t-1].curvePoints,te(n,i,e[t],e[t+1])),t>0&&t<e.length-1&&(o=Qt(i,e[t],e[t+1])),t<e.length-2&&(s=Qt(i,e[t+1],e[t])),n.lineTo(s.x,s.y)}return n}function ie(t,e,i){const{x:n,y:o}=e,{x:s,y:a}=i;return{x:n+(s-n)*t,y:o+(a-o)*t}}function ne(t,e,i,n){const{x:o,y:s}=e,{x:a,y:r}=i,{x:l,y:c}=n;return{x:(1-t)*(1-t)*o+2*t*(1-t)*a+t*t*l,y:(1-t)*(1-t)*s+2*t*(1-t)*r+t*t*c}}function oe(t,e,i,n,o){const{x:s,y:a}=e,{x:r,y:l}=o,{x:c,y:h}=i,{x:d,y:u}=n;return{x:s*(1-t)*(1-t)*(1-t)+3*c*t*(1-t)*(1-t)+3*d*t*t*(1-t)+r*t*t*t,y:a*(1-t)*(1-t)*(1-t)+3*h*t*(1-t)*(1-t)+3*u*t*t*(1-t)+l*t*t*t}}function se(t,e,i,n,o){if(!i||!n)return;const{x:s,y:a,center:r,ex:l,ey:c}=e,h={x:s,y:r.y},d={x:l,y:r.y};o%90==0&&o%180?(h.x=r.x,d.x=r.x,o%270?(h.y=a,d.y=c):(h.y=c,d.y=a)):o&&(L(h,o,e.center),L(d,o,e.center));const u=t.createLinearGradient(h.x,h.y,d.x,d.y);return u.addColorStop(0,i),u.addColorStop(1,n),u}function ae(t,e){const{x:i,y:n,width:o,height:s}=function(t){const{worldIconRect:e,iconWidth:i,iconHeight:n,imgNaturalWidth:o,imgNaturalHeight:s}=t.calculative;let{x:a,y:r,width:l,height:c}=e;if(i&&(l=i),n&&(c=n),o&&s&&t.imageRatio){const t=e.width/o,a=e.height/s,r=Math.min(t,a),h=o/s;i?c=i/h:n?l=n*h:(l=r*o,c=r*s)}switch(a+=(e.width-l)/2,r+=(e.height-c)/2,t.iconAlign){case"top":r=e.y;break;case"bottom":r=e.ey-c;break;case"left":a=e.x;break;case"right":a=e.ex-l;break;case"left-top":a=e.x,r=e.y;break;case"right-top":a=e.ex-l,r=e.y;break;case"left-bottom":a=e.x,r=e.ey-c;break;case"right-bottom":a=e.ex-l,r=e.ey-c}return{x:a,y:r,width:l,height:c}}(e),{worldIconRect:a,iconRotate:r,img:l}=e.calculative;if(t.filter=e.filter,r){const{x:e,y:i}=a.center;t.translate(e,i),t.rotate(r*Math.PI/180),t.translate(-e,-i)}if(e.imageRadius){t.save();let a=e.calculative.imageRadius||0,r=a;const{x:c,y:h,width:d,height:u,ex:f,ey:p}=e.calculative.worldRect;a<1&&(a*=d,r*=u);let v=a<r?a:r;d<2*v&&(v=d/2),u<2*v&&(v=u/2),t.beginPath(),t.moveTo(c+v,h),t.arcTo(f,h,f,p,v),t.arcTo(f,p,c,p,v),t.arcTo(c,p,c,h,v),t.arcTo(c,h,f,h,v),t.clip(),t.drawImage(l,i,n,o,s),t.restore()}else{let a=n,r=0;if(e.thumbImg){let t=l.naturalWidth,e=l.naturalHeight;r=(s/o*t-e)/2,s-2*r<0&&(r=(s-e/t*o)/2),a=n+r}t.drawImage(l,i,a,o,s-2*r)}}function re(t,e){const{textColor:i,color:n}=t.calculative,{styles:o}=e;return i||n||o.textColor||o.color}function le(t,e){const{fontStyle:i,fontWeight:n,fontSize:o,fontFamily:s,lineHeight:a,text:r,hiddenText:c,canvas:h,textHasShadow:d,textBackground:u,textType:f}=e.calculative;if(e.input&&!e.text&&e.calculative.canvas.inputDiv.dataset.penId!==e.id){t.save(),t.font=ue({fontStyle:i,fontWeight:n,fontFamily:s,fontSize:o,lineHeight:a}),t.fillStyle=e.placeholderColor||"#c0c0c0";const r=e.calculative.worldTextRect;t.fillText(e.placeholder||"",r.x,r.y+r.height/2),t.restore()}if(null==r||c)return;const p=h.store;let v,g;t.save(),d||(t.shadowBlur=0,t.shadowOffsetX=0,t.shadowOffsetY=0),e.calculative.disabled?v=e.disabledTextColor||e.disabledColor||yt(.4,re(e,p)):e.calculative.hover?v=e.hoverTextColor||e.hoverColor||p.styles.hoverColor:e.calculative.active&&(v=e.activeTextColor||e.activeColor||p.styles.activeColor),f===l.Linear?g=function(t,e){!e.calculative.textDrawRect&&ot(t,e),_i(e.calculative.textDrawRect);const{x:i,y:n,ex:o,width:s,height:a,center:r}=e.calculative.textDrawRect;let l=[{x:o,y:n+a/2},{x:i,y:n+a/2}];const{angle:c,colors:h}=Kt(e.calculative.textGradientColors);let d=$t(c,s,a);return l.forEach(t=>{L(t,c,r)}),Xt(t,l,h,d)}(t,e):f===l.Radial&&(g=function(t,e){const{worldRect:i,textGradientColors:n}=e.calculative;if(!n)return;const{width:o,height:s,center:a}=i,{x:r,y:l}=a;let c=o;c<s&&(c=s),c*=.5;const{colors:h}=Kt(n),d=t.createRadialGradient(r,l,0,r,l,c);return h.forEach(t=>{d.addColorStop(t.i,t.color)}),d}(t,e)),t.fillStyle=v||g||re(e,p),t.font=ue({fontStyle:i,fontWeight:n,fontFamily:s||p.options.fontFamily,fontSize:o,lineHeight:a}),!e.calculative.textDrawRect&&ot(t,e);const{x:y,y:m,width:w,height:x}=e.calculative.textDrawRect;u&&(t.save(),t.fillStyle=u,t.fillRect(y,m,w,x),t.restore());const b=.55,k=e.textAlign||p.options.textAlign,T=o*a;e.calculative.textLines.forEach((i,n)=>{const s=e.calculative.textLineWidths[n];let a=0;"center"===k?a=(w-s)/2:"right"===k&&(a=w-s),e.letterSpacing?function(t,e,i,n,o=0){if(0===o)return void t.fillText(e,i,n);let s=0;for(let a=0;a<e.length;a++)t.fillText(e[a],i+s,n),s+=t.measureText(e[a]).width+o}(t,i,y+a,m+(n+b)*T,e.calculative.letterSpacing):t.fillText(i,y+a,m+(n+b)*T);const{textDecorationColor:r,textDecorationDash:l,textDecoration:c}=e;c&&function(t,e,i){const{textDecorationColor:n,textDecorationDash:o,fontSize:s}=i;let{x:a,y:r,width:l}=e;switch(t.textBaseline){case"top":r+=s;break;case"middle":r+=s/2}t.save(),t.beginPath(),t.strokeStyle=n||t.fillStyle,t.lineWidth=1,t.moveTo(a,r),t.setLineDash(o||[]),t.lineTo(a+l,r),t.stroke(),t.restore()}(t,{x:y+a,y:m+(n+b)*T,width:s},{textDecorationColor:r,textDecorationDash:l,fontSize:o});const{textStrickoutColor:h,textStrickoutDash:d,textStrickout:u}=e;u&&function(t,e,i){const{textStrickoutColor:n,textStrickoutDash:o,fontSize:s}=i;let{x:a,y:r,width:l}=e;switch(t.textBaseline){case"top":r+=s/2;break;case"bottom":r-=s/2}t.save(),t.beginPath(),t.strokeStyle=n||t.fillStyle,t.lineWidth=1,t.moveTo(a,r),t.setLineDash(o||[]),t.lineTo(a+l,r),t.stroke(),t.restore()}(t,{x:y+a,y:m+(n+b)*T,width:s},{textStrickoutColor:h,textStrickoutDash:d,fontSize:o})}),t.restore()}function ce(t,e,i){if(null==i)return;const{fontStyle:n,fontWeight:o,fontSize:s,fontFamily:a,lineHeight:r,canvas:l}=e.calculative,c=l.store;let h;t.save(),e.calculative.hover?h=e.hoverTextColor||e.hoverColor||c.styles.hoverColor:e.calculative.active&&(h=e.activeTextColor||e.activeColor||c.styles.activeColor),t.fillStyle=h||re(e,c),t.font=ue({fontStyle:n,fontWeight:o,fontFamily:a||c.options.fontFamily,fontSize:s,lineHeight:r});const d=t.measureText(i).width;let u,f;for(const n of e.calculative.worldAnchors){if(!f){f=n;continue}const e=N(f,n),o=Math.floor(e/d);u="";for(let t=0;t<o;t++)u+=i;const s=B(f,n)-270;if(t.save(),s%360!=0){const{x:e,y:i}=f;t.translate(e,i);let n=s*Math.PI/180;t.rotate(n),t.translate(-e,-i)}t.fillText(u,f.x,f.y+r/2),t.restore(),f=n}t.restore()}function he(t,e){const i=e.calculative.canvas.store;t.save(),t.shadowColor="",t.shadowBlur=0,t.shadowOffsetX=0,t.shadowOffsetY=0,t.textAlign="center",t.textBaseline="middle";const n=e.calculative.worldIconRect;let o=n.x+n.width/2,s=n.y+n.height/2;switch(e.iconAlign){case"top":s=n.y,t.textBaseline="top";break;case"bottom":s=n.ey,t.textBaseline="bottom";break;case"left":o=n.x,t.textAlign="left";break;case"right":o=n.ex,t.textAlign="right";break;case"left-top":o=n.x,s=n.y,t.textAlign="left",t.textBaseline="top";break;case"right-top":o=n.ex,s=n.y,t.textAlign="right",t.textBaseline="top";break;case"left-bottom":o=n.x,s=n.ey,t.textAlign="left",t.textBaseline="bottom";break;case"right-bottom":o=n.ex,s=n.ey,t.textAlign="right",t.textBaseline="bottom"}const a=e.calculative.iconWeight;let r;const l=e.calculative.iconFamily;r=e.calculative.iconSize>0?e.calculative.iconSize:n.width>n.height?n.height:n.width,t.font=ue({fontSize:r,fontWeight:a,fontFamily:l}),t.fillStyle=e.calculative.iconColor||re(e,i),e.calculative.iconRotate&&(t.translate(n.center.x,n.center.y),t.rotate(e.calculative.iconRotate*Math.PI/180),t.translate(-n.center.x,-n.center.y)),t.beginPath(),t.fillText(e.calculative.icon,o,s),t.restore()}function de(t,e){if(!e.input)return;const i=e.calculative.canvas.store.data.scale,n=e.calculative.canvas.inputDiv.dataset.penId,{x:o,y:s,width:a,height:r}=e.calculative.worldRect;t.save(),t.beginPath(),e.id===n?(t.moveTo(o+a-20*i,s+r/2+2*i),t.lineTo(o+a-14*i,s+r/2-4*i),t.lineTo(o+a-8*i,s+r/2+2*i)):(t.moveTo(o+a-20*i,s+r/2-4*i),t.lineTo(o+a-14*i,s+r/2+2*i),t.lineTo(o+a-8*i,s+r/2-4*i)),t.stroke(),t.restore()}function ue({fontStyle:t="normal",textDecoration:e="normal",fontWeight:i="normal",fontSize:n=12,fontFamily:o="Arial",lineHeight:s=1}={}){return`${t} ${e} ${i} ${n}px/${s} ${o}`}function fe(t,e){const{x:i,ex:n,y:o,ey:s}=e.calculative.worldRect||{};e.calculative.flipX&&(t.translate(i+n,0),t.scale(-1,1)),e.calculative.flipY&&(t.translate(0,o+s),t.scale(1,-1))}function pe(t,e,i=!1){if(e.parentId&&e.rotateByRoot){let n=Vt(e,!0);if(n){const{x:e,y:o}=n.calculative.worldRect.pivot||n.calculative.worldRect.center;t.translate(e,o);let s=n.calculative.rotate*Math.PI/180;i||(n.calculative.flipX&&(s*=-1),n.calculative.flipY&&(s*=-1)),t.rotate(s),t.translate(-e,-o)}}else{const{x:n,y:o}=e.calculative.worldRect.pivot||e.calculative.worldRect.center;t.translate(n,o);let s=e.calculative.rotate*Math.PI/180;i||(e.calculative.flipX&&(s*=-1),e.calculative.flipY&&(s*=-1)),t.rotate(s),t.translate(-n,-o)}}function ve(t,e,i){t.save(),t.translate(.5,.5),t.beginPath(),pi(t,e);const n=e.calculative.canvas.store,o=e.textFlip||n.options.textFlip,a=e.textRotate||n.options.textRotate;let r;o&&a||t.save(),fe(t,e),(e.rotateByRoot||e.calculative.rotate&&"line"!==e.name)&&pe(t,e),(e.calculative.lineWidth>1||i)&&(t.lineWidth=e.calculative.lineWidth),function(t,e,i){if(e.fillWorldTextRect){t.save(),t.fillStyle="#c3deb7";const{x:e,y:n,width:o,height:s}=i.calculative.worldTextRect;t.fillRect(e,n,o,s),t.restore()}}(t,n,e);let c,h=!1;e.calculative.disabled?(c=e.disabledColor||n.styles.disabledColor||yt(.4,e.calculative.color||n.styles.color),r=e.disabledBackground||n.styles.disabledBackground||yt(.4,e.calculative.background||n.styles.penBackground)):e.mouseDownValid&&e.calculative.mouseDown?(c=e.mouseDownColor||yt(-.4,e.calculative.color||n.styles.color),r=e.mouseDownBackground||yt(-.4,e.calculative.background||n.styles.penBackground)):e.switch&&e.calculative.checked?e.calculative.bkType||(r=e.onBackground):e.calculative.hover?(c=e.hoverColor||n.styles.hoverColor,r=e.hoverBackground||n.styles.hoverBackground):e.calculative.active?(c=e.activeColor||n.styles.activeColor,r=e.activeBackground||n.styles.activeBackground):e.calculative.isDock&&(e.type===s.Line?c=n.styles.dockPenColor:r=mt(n.styles.dockPenColor,.2));const d=e.calculative.strokeImg;if(e.calculative.strokeImage&&d)t.strokeStyle=c||t.createPattern(d,"repeat");else{let i;e.calculative.strokeType?e.calculative.lineGradientColors?"line"===e.name?h=!0:e.calculative.lineGradient?i=e.calculative.lineGradient:(i=function(t,e){const{x:i,y:n,ex:o,width:s,height:a,center:r}=e.calculative.worldRect;let l=[{x:o,y:n+a/2},{x:i,y:n+a/2}];const{angle:c,colors:h}=Kt(e.calculative.lineGradientColors);let d=$t(c,s,a);return l.forEach(t=>{L(t,c,r)}),Xt(t,l,h,d)}(t,e),e.calculative.lineGradient=i):i=function(t,e){const{worldRect:i,lineGradientFromColor:n,lineGradientToColor:o,lineGradientAngle:s}=e.calculative;return se(t,i,n,o,s)}(t,e):i=e.calculative.color||(e.type?n.data.lineColor:"")||n.styles.color,t.strokeStyle=c||i}const u=e.calculative.backgroundImg;if(e.calculative.backgroundImage&&u)t.fillStyle=r||t.createPattern(u,"repeat"),r=!0;else{let i;e.calculative.bkType===l.Linear?e.calculative.gradientColors?e.calculative.gradient?i=e.calculative.gradient:(i=function(t,e){const{x:i,y:n,ex:o,width:s,height:a,center:r}=e.calculative.worldRect;let l=[{x:o,y:n+a/2},{x:i,y:n+a/2}],c=e.calculative.gradientColors;e.calculative.checked&&(c=e.calculative.onGradientColors);const{angle:h,colors:d}=Kt(c);let u=$t(h,s,a);return l.forEach(t=>{L(t,h,r)}),Xt(t,l,d,u)}(t,e),e.calculative.gradient=i):i=function(t,e){const{worldRect:i,gradientFromColor:n,gradientToColor:o,gradientAngle:s}=e.calculative;return se(t,i,n,o,s)}(t,e):e.calculative.bkType===l.Radial?e.calculative.gradientColors?e.calculative.radialGradient?i=e.calculative.radialGradient:(i=function(t,e){const{worldRect:i,gradientColors:n,gradientRadius:o}=e.calculative;if(!n)return;let s=e.calculative.gradientColors;e.calculative.checked&&(s=e.calculative.onGradientColors);const{width:a,height:r,center:l}=i,{x:c,y:h}=l;let d=a;d<r&&(d=r),d*=.5;const{colors:u}=Kt(s),f=t.createRadialGradient(c,h,d*(o||0),c,h,d);return u.forEach(t=>{f.addColorStop(t.i,t.color)}),f}(t,e),e.calculative.radialGradient=i):i=function(t,e){const{worldRect:i,gradientFromColor:n,gradientToColor:o,gradientRadius:s}=e.calculative;if(!n||!o)return;const{width:a,height:r,center:l}=i,{x:c,y:h}=l;let d=a;d<r&&(d=r),d*=.5;const u=t.createRadialGradient(c,h,d*(s||0),c,h,d);return u.addColorStop(0,n),u.addColorStop(1,o),u}(t,e):i=e.calculative.background||n.styles.penBackground,t.fillStyle=r||i,r=!!i}if(ge(t,e),ye(t,e),ci(t,e),e.calculative.lineDash&&t.setLineDash(e.calculative.lineDash.map(t=>t*e.calculative.canvas.store.data.scale)),e.calculative.lineDashOffset&&(t.lineDashOffset=e.calculative.lineDashOffset),e.calculative.shadowColor&&(t.shadowColor=e.calculative.shadowColor,t.shadowOffsetX=e.calculative.shadowOffsetX,t.shadowOffsetY=e.calculative.shadowOffsetY,t.shadowBlur=e.calculative.shadowBlur),h?(Jt(t,e),xe(!0,t,e,n)):(we(!0,t,e,n,r),hi(t,e)),e.image&&e.calculative.img||!e.calculative.icon||he(t,e),e.dropdownList&&de(t,e),o&&a||t.restore(),o&&!a&&fe(t,e),!o&&a&&(e.rotateByRoot||e.calculative.rotate&&"line"!==e.name)&&pe(t,e,!0),le(t,e),e.type===s.Line&&e.fillTexts)for(const i of e.fillTexts)ce(t,e,i);t.restore()}function ge(t,e){const i=e.lineCap||(e.type?"round":"square");i?t.lineCap=i:e.type&&(t.lineCap="round")}function ye(t,e){const i=e.lineJoin;i?t.lineJoin=i:e.type&&(t.lineJoin="round")}function me(t,e,i,n){t.save(),i&&t.translate(-i.x,-i.y),t.setAttrs?.(e);let o=!1;const a=e.calculative.canvas.store,r=e.textFlip||a.options.textFlip,l=e.textRotate||a.options.textRotate;let c;if(t.beginPath(),r&&l||t.save(),e.calculative.flipX&&(t.translate(e.calculative.worldRect.x+e.calculative.worldRect.ex,0),t.scale(-1,1)),e.calculative.flipY&&(t.translate(0,e.calculative.worldRect.y+e.calculative.worldRect.ey),t.scale(1,-1)),(e.rotateByRoot||e.calculative.rotate&&"line"!==e.name)&&pe(t,e),(e.calculative.lineWidth>1||n)&&(t.lineWidth=e.calculative.lineWidth),e.calculative.hover)t.strokeStyle=e.hoverColor||a.styles.hoverColor,t.fillStyle=e.hoverBackground||a.styles.hoverBackground,c=e.hoverBackground||a.styles.hoverBackground;else if(e.calculative.active)t.strokeStyle=e.activeColor||a.styles.activeColor,t.fillStyle=e.activeBackground||a.styles.activeBackground,c=e.activeBackground||a.styles.activeBackground;else{if(e.strokeImage)e.calculative.strokeImg&&(t.strokeStyle=t.createPattern(e.calculative.strokeImg,"repeat"),c=!0);else{let i;e.calculative.strokeType&&e.calculative.lineGradientColors&&"line"===e.name?o=!0:i=e.calculative.color||a.styles.color,t.strokeStyle=i}e.backgroundImage?e.calculative.backgroundImg&&(t.fillStyle=t.createPattern(e.calculative.backgroundImg,"repeat"),c=!0):(t.fillStyle=e.background,c=!!e.background)}if(ge(t,e),ye(t,e),ci(t,e),e.calculative.lineDash&&t.setLineDash(e.calculative.lineDash),e.calculative.lineDashOffset&&(t.lineDashOffset=e.calculative.lineDashOffset),e.calculative.shadowColor&&(t.shadowColor=e.calculative.shadowColor,t.shadowOffsetX=e.calculative.shadowOffsetX,t.shadowOffsetY=e.calculative.shadowOffsetY,t.shadowBlur=e.calculative.shadowBlur),o?(Jt(t,e),xe(!0,t,e,a)):(we(!1,t,e,a,c),hi(t,e)),e.calculative.img?(t.save(),t.shadowColor="",t.shadowBlur=0,t.shadowOffsetX=0,t.shadowOffsetY=0,ae(t,e),t.restore()):e.calculative.icon&&he(t,e),e.dropdownList&&de(t,e),r&&l||t.restore(),r&&!l&&(e.calculative.flipX&&(t.translate(e.calculative.worldRect.x+e.calculative.worldRect.ex,0),t.scale(-1,1)),e.calculative.flipY&&(t.translate(0,e.calculative.worldRect.y+e.calculative.worldRect.ey),t.scale(1,-1))),!r&&l&&(e.rotateByRoot||e.calculative.rotate&&"line"!==e.name)&&pe(t,e,!0),le(t,e),e.type===s.Line&&e.fillTexts)for(const i of e.fillTexts)ce(t,e,i);t.restore()}function we(t=!0,e,i,n,o){if("drawCommand"===i.name)return;const a=t?n.path2dMap.get(i):V.path2dDraws[i.name];let r=null,l=null;if(i.type===s.Line&&(i.fromLineCap&&"butt"!==i.fromLineCap&&(e.lineCap="butt",r=new Path2D,r.moveTo(i.calculative.worldAnchors[0].x,i.calculative.worldAnchors[0].y),r.lineTo(i.calculative.worldAnchors[0].x,i.calculative.worldAnchors[0].y)),i.toLineCap&&"butt"!==i.toLineCap&&(e.lineCap="butt",l=new Path2D,l.moveTo(i.calculative.worldAnchors[i.calculative.worldAnchors.length-1].x,i.calculative.worldAnchors[i.calculative.worldAnchors.length-1].y),l.lineTo(i.calculative.worldAnchors[i.calculative.worldAnchors.length-1].x,i.calculative.worldAnchors[i.calculative.worldAnchors.length-1].y))),a){if(i.type===s.Line&&i.borderWidth){e.save(),e.beginPath();const t=i.calculative.lineWidth+i.calculative.borderWidth;e.lineWidth=t,e.strokeStyle=i.borderColor,r&&(e.save(),e.lineCap=i.fromLineCap,e.stroke(r),e.restore()),a instanceof Path2D?(o&&e.fill(a),t&&e.stroke(a)):(a(i,e),o&&e.fill(),t&&e.stroke()),l&&(e.save(),e.lineCap=i.toLineCap,e.stroke(l),e.restore()),e.restore()}a instanceof Path2D?i.type?i.close&&o&&e.fill(a):o&&e.fill(a):(e.save(),a(i,e),o&&e.fill(),e.restore());const t=i.calculative.progress;if(null!=t){e.save();const{ex:o,x:s,y:r,width:l,height:c,ey:h}=i.calculative.worldRect;let d=null;if(d=i.calculative.verticalProgress?i.reverseProgress?e.createLinearGradient(s,r,s,r+c*t):e.createLinearGradient(s,h,s,r+c*(1-t)):i.reverseProgress?e.createLinearGradient(o,r,s+l*(1-t),r):e.createLinearGradient(s,r,s+l*t,r),i.calculative.progressGradientColors){const{colors:t}=Kt(i.calculative.progressGradientColors);t.forEach(t=>{d.addColorStop(t.i,t.color)})}else{const t=i.calculative.progressColor||i.calculative.color||n.options.activeColor||n.data.color;d.addColorStop(0,t),d.addColorStop(1,t)}d.addColorStop(1,"transparent"),e.fillStyle=d,a instanceof Path2D?e.fill(a):(a(i,e),e.fill()),e.restore()}if(i.calculative.lineWidth&&(a instanceof Path2D?(n.options.svgPathStroke||"svgPath"!==i.name)&&(r&&(e.save(),e.lineCap=i.fromLineCap,e.stroke(r),e.restore()),e.stroke(a),l&&(e.save(),e.lineCap=i.toLineCap,e.stroke(l),e.restore())):(a(i,e),e.stroke())),i.type){if(i.calculative.animatePos){if(e.save(),be(e,i,n),i.lineAnimateType===v.Arrow||i.lineAnimateType===v.WaterDrop){let t=Mn(i,e);t instanceof Path2D?(e.stroke(t),e.fill(t)):(e.stroke(),e.fill())}else a instanceof Path2D?(r&&!i.lineAnimateType&&(e.save(),e.lineCap=i.fromLineCap,e.stroke(r),e.restore()),e.lineCap=i.lineCap,e.stroke(a)):(a(i,e),e.stroke());e.restore()}i.fromArrow&&pt(e,i,n),i.toArrow&&vt(e,i,n),!i.calculative.active||i.calculative.pencil||n.options.disableAnchor||n.data.locked||Ce(e,i)}}}function xe(t=!0,e,i,n){const o=t?n.path2dMap.get(i):V.path2dDraws[i.name];if(o&&i.type){if(i.calculative.animatePos){if(e.save(),be(e,i,n),e.beginPath(),o instanceof Path2D)if("polyline"===i.lineName||"line"===i.lineName)if(i.lineAnimateType===v.Arrow||i.lineAnimateType===v.WaterDrop){const t=Mn(i);e.stroke(t),e.fill(t)}else i.calculative.gradientSmooth||i.calculative.lineSmooth?(i.calculative.gradientAnimatePath||(i.calculative.gradientAnimatePath=ee(i)),i.calculative.gradientAnimatePath instanceof Path2D&&e.stroke(i.calculative.gradientAnimatePath)):e.stroke(o);else e.stroke(o);else o(i,e),e.stroke();e.restore()}i.fromArrow&&pt(e,i,n),i.toArrow&&vt(e,i,n),!i.calculative.active||i.calculative.pencil||n.options.disableAnchor||n.data.locked||Ce(e,i)}}function be(t,e,i){t.strokeStyle=e.animateColor||i.styles.animateColor,e.animateShadow&&(t.shadowBlur=e.animateShadowBlur||e.animateLineWidth||6,t.shadowColor=e.animateShadowColor||e.animateColor||i.styles.animateColor),e.calculative.animateLineWidth&&(t.lineWidth=e.calculative.animateLineWidth*i.data.scale);let n=0;switch(e.lineAnimateType){case v.Beads:e.animateReverse?t.lineDashOffset=e.calculative.animatePos:t.lineDashOffset=e.length-e.calculative.animatePos,n=e.calculative.lineWidth||5,n<5&&(n=5);const o=e.animateLineDash&&e.animateLineDash.map(t=>t*n/5);t.setLineDash(o||[n,2*n]);break;case v.Dot:e.animateReverse?t.lineDashOffset=e.calculative.animatePos:t.lineDashOffset=e.length-e.calculative.animatePos,n=e.calculative.animateDotSize||2*e.calculative.lineWidth||6,n<6&&(n=6),n>40&&(n=40),t.lineWidth=(e.calculative.animateLineWidth||n)*i.data.scale,t.setLineDash([.1,e.length]);break;case v.Arrow:case v.WaterDrop:t.fillStyle=e.animateColor||i.styles.animateColor,t.lineWidth=1;break;case v.Custom:switch(e.lineAnimateTargetType){case g.Image:if(e.lineAnimateImages??=[],e.lineAnimateImages.length>0){const i=e.lineAnimateImages.map((t,i)=>{const n=V.htmlElements[t];if(n)return n;e.calculative.canvas.__loadImage(t)});ke(t,e,"image",i)}break;case g.Icon:const i=e.lineAnimateIcon;ke(t,e,"icon",i);break;case g.Pen:e.lineAnimatePens&&ke(t,e,"pen",e.lineAnimatePens);break;case g.Element:const n=e.lineAnimateElement;ke(t,e,"element",n)}break;default:e.animateReverse?(t.lineDashOffset=Number.EPSILON,t.setLineDash([0,e.length-e.calculative.animatePos+1,e.calculative.animatePos])):t.setLineDash([e.calculative.animatePos,e.length+.01-e.calculative.animatePos])}}function ke(t,e,i,n){let o=null;switch(i){case"image":r=n,o=function(t,e,i,n){const o=e.calculative.canvas.store.data.scale,s=e.lineAnimateElementWidth||10,a=e.lineAnimateElementHeight||10,l=r[n%r.length];l&&(t.beginPath(),t.translate(i.x+s/2*o,i.y+a/2*o),t.rotate(i.rotate*Math.PI/180),t.scale(o,o),t.translate(-s/2*o,-a/2*o),t.drawImage(l,0,0,s,a))};break;case"icon":a=n,o=function(t,e,i,n){const o=e.calculative.canvas.store.data.scale,s=e.lineAnimateElementWidth||10,r=e.lineAnimateElementHeight||10;t.beginPath(),t.translate(i.x+s/2*o,i.y+r/2*o),t.rotate(i.rotate*Math.PI/180),t.scale(o,o),t.translate(-s/2*o,-r/2*o);const l=e.calculative.iconWeight;let c;const h=e.calculative.iconFamily;c=e.calculative.iconSize||Math.max(e.lineAnimateElementWidth||0,e.lineAnimateElementHeight||0)||10,t.font=ue({fontSize:c,fontWeight:l,fontFamily:h}),t.fillStyle=e.calculative.iconColor||re(e,e.calculative.canvas.parent.store),e.calculative.iconRotate&&t.rotate(e.calculative.iconRotate*Math.PI/180),t.beginPath(),t.fillText(a,0,0)};break;case"pen":let t=e.calculative.canvas.find(n);e.lineAnimateElementCount=t.length,s=t,o=function(t,e,i,n){const o=s[n%s.length];if(!o)return;const a=e.calculative.canvas.store.data.scale,r=e.calculative.canvas.store.data.origin,l=e.calculative.canvas.parent,c=o.width,h=o.height,d=i.x-c/2,u=i.y-h/2,f={x:(d-r.x)/a,y:(u-r.y)/a,width:c/a,height:h/a,rotate:i.rotate};l.setValue({id:o.id,...f})};break;case"element":if(o=V.lineAnimateDraws[n],!o)return}var s,a,r;!function(t,e,i){const n=Array.isArray(e.lineAnimateDash)?e.lineAnimateDash:e.lineAnimateDash?.split(",").map(t=>Number(t))||[10,20],o=e.calculative.canvas.store.data.scale;(function(t,e,i=0,n,o=0){const s=[];if(!e||0===e.length)return s.push({start:0,end:t,isDash:!0}),s;const a=e.reduce((t,e)=>t+e,0);let r=(-i+o)%a;r<0&&(r+=a);let l=0,c=0;for(n||(n=1/0);c<t&&l<n;)for(let i=0;i<e.length;i++){let a=c+e[i]-r;if(a>t&&(a=t),i%2==0&&a>c){const e=(c+o)%t,i=(a+o)%t;s.push({start:e,end:i,isDash:!0}),l+=1}if(c=a,r=0,c>=t||l>=n)break}return s})(bn(e)/o,n,e.lineAnimateDashOffset,e.lineAnimateElementCount).forEach((n,o)=>{const s=function(t,e=0){let i,n=null;if(t.calculative.worldAnchors.forEach(t=>{n&&(i=An(i,n,n.next,t.prev,t)),n=t}),t.close){let e=t.calculative.worldAnchors[0];i=An(i,n,n.next,e.prev,e)}let o=0;o=t.animateReverse?t.length-t.calculative.animatePos-e*t.calculative.canvas.store.data.scale:t.calculative.animatePos-e*t.calculative.canvas.store.data.scale;const s=function(t,e){const i=t.getTotalLength();if(e<0||e>i)return null;const n=t.getPointAtLength(e),o=t.getPointAtLength(e-.01),s=Math.atan2(n.y-o.y,n.x-o.x);return{x:n.x,y:n.y,rotate:s/Math.PI*180,progress:e/i}}(i,o);return s}(e,n.start);if(s)try{t.save(),i(t,e,s,o),t.restore()}catch(e){t.restore(),console.warn(e)}})}(t,e,o)}function Te(t){const{data:e,options:i}=t;return e.color||i.color}function Ce(t,e){const i=e.calculative.canvas.store;t.save(),t.lineWidth=1,t.fillStyle=e.activeColor||i.styles.activeColor,e.calculative.worldAnchors.forEach(i=>{!i.hidden&&!i.isTemp&&Ae(t,i,e)}),t.restore()}function Ae(t,e,i){if(!e)return;const n=i.calculative.canvas.store.activeAnchor===i.calculative.activeAnchor&&i.calculative.activeAnchor===e;let o=3;i.calculative.lineWidth>3&&(o=i.calculative.lineWidth),i.anchorRadius&&(o=i.anchorRadius),e.radius&&(o=e.radius),n?(e.prev&&(t.save(),t.strokeStyle="#4dffff",t.beginPath(),t.moveTo(e.prev.x,e.prev.y),t.lineTo(e.x,e.y),t.stroke(),t.restore(),t.save(),t.fillStyle="#ffffff",t.beginPath(),t.arc(e.prev.x,e.prev.y,o,0,2*Math.PI),t.fill(),t.stroke(),t.restore()),e.next&&(t.save(),t.strokeStyle="#4dffff",t.beginPath(),t.moveTo(e.x,e.y),t.lineTo(e.next.x,e.next.y),t.stroke(),t.restore(),t.save(),t.fillStyle="#ffffff",t.beginPath(),t.arc(e.next.x,e.next.y,o,0,2*Math.PI),t.fill(),t.stroke(),t.restore(),t.beginPath(),t.arc(e.x,e.y,o,0,2*Math.PI),t.fill(),t.stroke()),t.beginPath(),t.arc(e.x,e.y,o,0,2*Math.PI),t.fill(),t.stroke()):(t.save(),t.fillStyle="#ffffff",t.beginPath(),t.arc(e.x,e.y,o,0,2*Math.PI),t.fill(),t.stroke(),t.restore())}function Re(t){const e=t.calculative.canvas.store;let i={x:t.x,y:t.y};if(!t.parentId||t.parentId&&!e.pens[t.parentId])t.parentId=void 0,i.width=t.width,i.height=t.height,i.rotate=t.rotate,Mi(i),_i(i),t.pivot&&Li(i,t.pivot);else{const n=e.pens[t.parentId];let o=n.calculative.worldRect;o||(o=Re(n)),i.x=o.x+o.width*t.x,i.y=o.y+o.height*t.y,i.width=o.width*t.width,i.height=o.height*t.height,n.flipX&&(i.x=o.width-(i.x-o.x+i.width)+o.x),n.flipY&&(i.y=o.height-(i.y-o.y+i.height)+o.y),Mi(i),i.rotate=o.rotate+t.rotate,_i(i),t.pivot&&Li(i,t.pivot)}return t.calculative.worldRect=i,Se(t,i),i}function Se(t,e){!t.paddingTop&&(t.calculative.paddingTop=0),!t.paddingBottom&&(t.calculative.paddingBottom=0),!t.paddingLeft&&(t.calculative.paddingLeft=0),!t.paddingRight&&(t.calculative.paddingRight=0),Math.abs(t.calculative.paddingTop)<1&&(t.calculative.paddingTop*=e.height),Math.abs(t.calculative.paddingBottom)<1&&(t.calculative.paddingBottom*=e.height),Math.abs(t.calculative.paddingLeft)<1&&(t.calculative.paddingLeft*=e.width),Math.abs(t.calculative.paddingRight)<1&&(t.calculative.paddingRight*=e.width)}function Pe(t){const e=dt(t.calculative.worldRect);if(delete e.pivot,!t.parentId)return void Object.assign(t,e);const i=t.calculative.canvas.store.pens[t.parentId].calculative.worldRect;Object.assign(t,qi(e,i))}function Ie(t){const e=t.calculative.canvas.store;let i=[];if(t.anchors){let e=dt(t.anchors);t.flipX&&e.forEach(t=>{t.x=.5-(t.x-.5)}),t.flipY&&e.forEach(t=>{t.y=.5-(t.y-.5)}),e.forEach(e=>{i.push(_e(t,e))})}if(!i.length&&!t.type&&!t.calculative.canvas.parent.isCombine(t)){const{x:n,y:o,width:s,height:a}=t.calculative.worldRect;i=e.options.defaultAnchors.map((e,i)=>({id:`${i}`,penId:t.id,x:n+s*e.x,y:o+a*e.y}))}t.calculative.rotate&&"line"!==t.name&&i.forEach(e=>{L(e,t.calculative.rotate,t.calculative.worldRect.pivot||t.calculative.worldRect.center)}),t.type&&!t.anchors||(t.calculative.worldAnchors=i),t.calculative.activeAnchor&&i.length&&(t.calculative.activeAnchor=i.find(e=>{e.id,t.calculative.activeAnchor.id})),t.calculative.gradientAnimatePath=void 0}function Ee(t){if(t.children?.length){let e=t.calculative.worldRect;t.children.forEach(i=>{const n=t.calculative.canvas.store.pens[i];n.calculative.initRect&&n.calculative.initRelativeRect&&(n.calculative.initRect.x=e.x+e.width*n.calculative.initRelativeRect.x,n.calculative.initRect.y=e.y+e.height*n.calculative.initRelativeRect.y,n.calculative.initRect.ex=n.calculative.initRect.x+e.width*n.calculative.initRelativeRect.width,n.calculative.initRect.ey=n.calculative.initRect.y+e.height+n.calculative.initRelativeRect.height,_i(n.calculative.initRect)),Ee(n)})}}function _e(t,e){const i={...e},{x:n,y:o,width:s,height:a}=t.calculative.worldRect;return i.x=n+s*e.x,i.y=o+a*e.y,e.prev&&(i.prev={penId:t.id,connectTo:e.prev.connectTo,x:n+s*e.prev.x,y:o+a*e.prev.y}),e.next&&(i.next={penId:t.id,connectTo:e.next.connectTo,x:n+s*e.next.x,y:o+a*e.next.y}),i}function Me(t,e){const{paddingTop:i,paddingBottom:n,paddingLeft:o,paddingRight:s}=e.calculative;let a=o,r=i,l=e.calculative.worldRect.width-o-s,c=e.calculative.worldRect.height-i-n,h=e.calculative.iconLeft,d=e.calculative.iconTop;h&&Math.abs(h)<1&&(h=e.calculative.worldRect.width*h),d&&Math.abs(d)<1&&(d=e.calculative.worldRect.height*d),a+=h||0,r+=d||0,l-=h||0,c-=d||0;let u=e.calculative.iconRotate||0;if(e.parentId){const i=t[e.parentId].calculative;i&&(u+=i.rotate,u%=360)}a=e.calculative.worldRect.x+a,r=e.calculative.worldRect.y+r,e.calculative.worldIconRect={x:a,y:r,width:l,height:c,rotate:u},Mi(e.calculative.worldIconRect),_i(e.calculative.worldIconRect)}function Le(t,e,i){Ui(t.calculative.worldRect,e,i,t.pivot),t.calculative.initRect&&Ui(t.calculative.initRect,e,i,t.pivot),De(t,e,i),t.calculative.x&&O(t.calculative,e,i),t.type&&Ie(t)}function De(t,e,i){t&&t.children?.length&&t.children.forEach(n=>{const o=t.calculative.canvas.store.pens[n];o&&(o.calculative.initRect&&Ui(o.calculative.initRect,e,i),De(o,e,i))})}function Oe(t,e){t.anchors||(t.anchors=[]),t.calculative.worldAnchors||(t.calculative.worldAnchors=[]);const i={id:e.id,penId:t.id,x:e.x,y:e.y};if(t.calculative.worldAnchors.push(i),t.calculative.worldRect){t.rotate%360&&L(e,-t.rotate,t.calculative.worldRect.center);const i={id:e.id,penId:t.id,x:(e.x-t.calculative.worldRect.x)/t.calculative.worldRect.width,y:(e.y-t.calculative.worldRect.y)/t.calculative.worldRect.height};t.anchors.push(i)}return i}function Be(t,e,i){t.anchors||(t.anchors=[]),t.calculative.worldAnchors||(t.calculative.worldAnchors=[]);const n=function(t,e,i){let n=t.calculative.worldAnchors[i],o=t.calculative.worldAnchors[i+1];!o&&t.close&&(o=t.calculative.worldAnchors[0]);const s=e.step;let a;if(n.next&&o.prev){const e=n,i=n.next,r=o.prev,l=o,c=cn(e,i,s),h=cn(i,r,s),d=cn(r,l,s),u=cn(c,h,s),f=cn(h,d,s);a=cn(u,f,s),u.penId=t.id,a.prev=u,f.penId=t.id,a.next=f,n.next.x=c.x,n.next.y=c.y,o.prev.x=d.x,o.prev.y=d.y}else if(n.next||o.prev){const i=n,r=n.next||o.prev,l=o,c=cn(i,r,s),h=cn(r,l,s);a=e,c.penId=t.id,h.penId=t.id,a.prev=c,a.next=h,n.next=void 0,o.prev=void 0}else a=e;return a.penId=t.id,a.id=Ct(),a.prevNextType=E.Bilateral,a}(t,e,i);return t.calculative.worldAnchors.splice(i+1,0,n),t.anchors.splice(i+1,0,$i(n,t.calculative.worldRect)),t.calculative.activeAnchor=n,n}function Ne(t,e){if(!t||!t.calculative.worldAnchors)return;let i=t.calculative.worldAnchors.findIndex(t=>t.id===e.id);i>-1&&t.calculative.worldAnchors.splice(i,1),i=t.anchors.findIndex(t=>t.id===e.id),i>-1&&t.anchors.splice(i,1)}function Fe(t,e){if(!e||!e.calculative||!e.calculative.worldRect.center)return A.None;if(t.anchorId){let i=e.anchors.filter(e=>e.id===t.anchorId);if(i.length&&i[0].direction>-1)return i[0].direction}return F(t,e.calculative.worldRect.center)}function ze(t,e){let i,n=1/0;return t.calculative.worldAnchors.forEach(t=>{const o=N(e,t);n>o&&(n=o,i=t)}),i}function je(t,e,i){t.x+=e,t.y+=i,t.anchors&&t.anchors.forEach(t=>{z(t,e,i)}),t.calculative.worldAnchors&&t.calculative.worldAnchors.forEach(t=>{z(t,e,i)})}function He(t){if(t&&t.calculative&&t.calculative.worldAnchors.length){let e=$e(t);if(t.anchors&&t.anchors.length)e===t.calculative.activeAnchor?t.calculative.worldAnchors=[t.calculative.worldAnchors[0]]:t.calculative.worldAnchors[0]===t.calculative.activeAnchor&&(t.calculative.worldAnchors=[t.calculative.worldAnchors[t.calculative.worldAnchors.length-1]]);else for(;t.calculative.worldAnchors.length&&e!==t.calculative.activeAnchor;)t.calculative.worldAnchors.pop(),e=$e(t)}}function We(t,e,i,n){if(!(t&&e&&i&&n&&e.twoWay!==_.DisableConnected&&e.twoWay!==_.Disable&&n.twoWay!==_.DisableConnectTo&&n.twoWay!==_.Disable))return;if(e.twoWay===_.In){if(1===i.calculative.worldAnchors.length)return;const t=$e(i);if(n.id!==t.id)return}if(e.twoWay===_.Out){const t=qe(i);if(n.id!==t.id)return}if(n.connectTo===t.id&&n.anchorId===e.id)return;if(n.connectTo){const e=t.calculative.canvas.store.pens[n.connectTo];Ve(e,Ue(e,n.anchorId),i,n)}t.connectedLines||(t.connectedLines=[]),t.connectedLines.findIndex(t=>t.lineId===i.id&&t.lineAnchor===n.id&&t.anchor===e.id)<0&&t.connectedLines.push({lineId:i.id,lineAnchor:n.id,anchor:e.id}),n.connectTo=t.id,n.anchorId=e.id,t.type&&We(i,n,t,e),t.calculative.canvas.store.emitter.emit("connectLine",{line:i,lineAnchor:n,pen:t,anchor:e});let o=i.calculative.worldAnchors?.length>=2?i.calculative.worldAnchors?.[0].connectTo:void 0,s=i.calculative.worldAnchors?.length>=2?i.calculative.canvas.store.pens[i.calculative.worldAnchors?.[0].connectTo]?.anchors.find(t=>t.id===i.calculative.worldAnchors?.[0].anchorId):void 0;return t.onConnectLine?.(t,{line:i,lineAnchor:n,pen:t,anchor:e,fromPen:o,fromAnchor:s}),!0}function Ve(t,e,i,n){if(t&&e&&i&&n&&t.connectedLines&&t.connectedLines.length)return i.lastConnected||(i.lastConnected={}),i.lastConnected[t.id]||(i.lastConnected[t.id]=dt(t.connectedLines)),t.connectedLines.forEach((t,o,s)=>{t.lineId!==i.id&&t.lineId!==i.id||t.lineAnchor!==n.id||t.anchor!==e.id||s.splice(o,1)}),n.connectTo=void 0,n.anchorId=void 0,t.type&&e.connectTo===i.id&&e.anchorId===n.id&&Ve(i,n,t,e),t.calculative.canvas.store.emitter.emit("disconnectLine",{line:i,lineAnchor:n,pen:t,anchor:e}),!0}function Ue(t,e){if(t&&e)return t.calculative.worldAnchors?.find(t=>t.id===e)}function qe(t){if(t&&t.calculative.worldAnchors)return t.calculative.worldAnchors[0]}function $e(t){if(t&&t.calculative.worldAnchors)return t.calculative.worldAnchors[t.calculative.worldAnchors.length-1]}function Ke(t,e){if(0===t.calculative.start||!t.frames||!t.frames.length)return t.calculative.start=void 0,0;if(!t.calculative.duration){t.calculative.duration=0;for(const e of t.frames){t.calculative.duration+=e.duration;for(const i in e)"duration"===i||t[i]||"scale"===i&&(t[i]=1)}}if(t.animateCycle||(t.animateCycle=1/0),t.calculative.start){let i=0;const n=Math.ceil((e-t.calculative.start)/t.calculative.duration);if(n>t.animateCycle)return t.currentAnimation=void 0,t.calculative.start=void 0,Xe(t,1),0;const o=(e-t.calculative.start)%t.calculative.duration||t.calculative.duration;let s=0;for(const e of t.frames){if(s+=e.duration,!(o>s))break;++i}if(!t.frames[i])return!0;let a=!1;i!==t.calculative.frameIndex&&(a=!0,t.calculative.frameIndex=i,t.calculative.frameDuration=t.frames[i].duration,i>0&&(t.calculative.frameStart+=t.frames[i-1].duration),t.calculative.frameEnd=t.calculative.frameStart+t.calculative.frameDuration);let r=!1;if(n>t.calculative.cycleIndex&&(t.calculative.cycleIndex=n,t.calculative.frameStart=t.calculative.start+t.calculative.duration*(n-1),r=!0),a||r)if(t.calculative.x=t.calculative.initRect.x,t.calculative.y=t.calculative.initRect.y,t.children?.length&&!t.parentId?t.calculative.canvas.rotatePen(t,(t.calculative.initRect.rotate||0)-(t.calculative.rotate||0),t.calculative.initRect):t.calculative.rotate=t.calculative.initRect.rotate||0,i>0){t.prevFrame={};const e=t.frames[i-1];for(const i in e)t.prevFrame[i]=e[i];Object.assign(t.prevFrame,{rotate:e.rotate||0,x:e.x||0,y:e.y||0,scale:e.scale||1})}else Ye(t)}else{if(t.calculative.start=e,t.calculative.frameIndex=0,t.calculative.frameStart=t.calculative.start,t.calculative.frameDuration=t.frames[0].duration,t.calculative.frameEnd=t.calculative.frameStart+t.calculative.frameDuration,t.calculative.cycleIndex=1,t.calculative.x=t.calculative.worldRect.x,t.calculative.y=t.calculative.worldRect.y,t.calculative.initRect=dt(t.calculative.worldRect),t.parentId&&(t.calculative.initRelativeRect={x:t.x,y:t.y,width:t.width,height:t.height}),t.children?.length){const e=t.calculative.canvas.store;t.calculative.childrenVisible={},t.children.forEach(i=>{t.calculative.childrenVisible[i]=e.pens[i].visible})}t.calculative.initRect.rotate=t.calculative.rotate||0,Ye(t)}const i=(e-t.calculative.frameStart)/t.calculative.frameDuration%1;return i>0&&Xe(t,i),!0}function Ye(t){t.prevFrame={};for(const e in t)"object"==typeof t[e]&&"lineDash"!==e||(t.prevFrame[e]=t[e]);t.prevFrame.rotate=0,t.prevFrame.x=0,t.prevFrame.y=0,t.prevFrame.scale=1}function Xe(t,e){if(e<0)return;e>1&&(e=1);const i=t.frames[t.calculative.frameIndex],n=t.calculative.canvas.store.data.scale;for(const o in i)if("duration"!==o){if("scale"===o){t.calculative.worldRect=dt(t.calculative.initRect),Ui(t.calculative.worldRect,t.prevFrame.scale,t.calculative.worldRect.center);const n=t.prevFrame.scale+(i[o]-t.prevFrame.scale)*e;Ui(t.calculative.worldRect,n/t.prevFrame.scale,t.calculative.worldRect.center),t.calculative.patchFlags=!0}else if("x"===o){const s=ai(t,o,t.calculative.frameIndex)*n;t.calculative.worldRect.x=t.calculative.initRect.x+s,t.calculative.worldRect.ex=t.calculative.initRect.ex+s,t.calculative.worldRect.center.x=t.calculative.initRect.center.x+s,t.calculative.worldRect.pivot?.x&&(t.calculative.worldRect.pivot.x=t.calculative.initRect.pivot?.x+s),Hi(t.calculative.worldRect,i[o]*e*n,0),t.calculative.patchFlags=!0}else if("y"===o){const s=ai(t,o,t.calculative.frameIndex)*n;t.calculative.worldRect.y=t.calculative.initRect.y+s,t.calculative.worldRect.ey=t.calculative.initRect.ey+s,t.calculative.worldRect.center.y=t.calculative.initRect.center.y+s,t.calculative.worldRect.pivot?.x&&(t.calculative.worldRect.pivot.y=t.calculative.initRect.pivot?.y+s),Hi(t.calculative.worldRect,0,i[o]*e*n),t.calculative.patchFlags=!0}else if("width"===o){const s=ai(t,o,t.calculative.frameIndex)*n;t.calculative.worldRect.width=t.calculative.initRect.width+s,t.calculative.worldRect.ex=t.calculative.initRect.ex+s,t.calculative.worldRect.center.x=t.calculative.initRect.center.x+s;let a=i[o]*e*n;t.calculative.worldRect.width+=a,t.calculative.worldRect.ex+=a,t.calculative.worldRect.center.x+=a,t.calculative.patchFlags=!0}else if("height"===o){const s=ai(t,o,t.calculative.frameIndex)*n;t.calculative.worldRect.height=t.calculative.initRect.height+s,t.calculative.worldRect.ey=t.calculative.initRect.ey+s,t.calculative.worldRect.center.y=t.calculative.initRect.center.y+s;let a=i[o]*e*n;t.calculative.worldRect.height+=a,t.calculative.worldRect.ey+=a,t.calculative.worldRect.center.y+=a,t.calculative.patchFlags=!0}else if("rotate"===o){t.prevFrame[o]>=360&&(t.prevFrame[o]%=360);const n=ai(t,o,t.calculative.frameIndex),s=(t.calculative.initRect.rotate+n+i[o]*e)%360-(t.calculative.rotate||0);t.children?.length?t.calculative.canvas.rotatePen(t,s,t.calculative.initRect):t.calculative.rotate=(t.calculative.initRect.rotate+n+i[o]*e)%360,t.calculative.patchFlags=!0}else if("image"===o)t.image=i.image,t.calculative.image=void 0,t.calculative.canvas.loadImage(t),t.canvasLayer===c.CanvasImageBottom?t.calculative.canvas.canvasImageBottom.init():t.canvasLayer===c.CanvasImage&&t.calculative.canvas.canvasImage.init();else if(Ge(i[o],o,t)){null==t.prevFrame[o]&&(t.prevFrame[o]="globalAlpha"===o?1:0);const n=t.prevFrame[o]+(i[o]-t.prevFrame[o])*e;t.calculative[o]=Math.round(100*n)/100}else{if("visible"===o)if(t.calculative.image);else if(t.children?.length){const e=Ut(t,t.calculative.canvas.store);t.calculative.canvas.initImageCanvas(e)}t.calculative[o]=i[o];const e={};e[o]=i[o],vi(t,e)}"text"===o&&st(t)}}function Ge(t,e,i){return"number"==typeof t&&!1!==i.linear&&!["strokeType","bkType","showChild"].includes(e)}function Je(t,e){if(0===t.calculative.start)return t.calculative.start=void 0,t.calculative.cycleStart=void 0,0;t.animateCycle||(t.animateCycle=1/0),t.animateSpan||(t.animateSpan=1);const i=(e-t.calculative.cycleStart)/1e3;if(t.curveAnimate){let e=[];e=t.animateTimingFunction?Array.isArray(t.animateTimingFunction)?t.animateTimingFunction:t.animateTimingFunction.split(","):[.25,.25,.75,.75];const n=kt(i/(t.duration||5),e[1],e[3]);t.calculative.animatePos=n*t.length}else t.calculative.animatePos+=t.animateSpan*(t.calculative.canvas.store.data.scale||1);if(t.calculative.cycleStart||(t.calculative.cycleStart=e),t.calculative.start){if(t.calculative.animatePos>t.length||t.curveAnimate&&i>t.duration){if(++t.calculative.cycleIndex,t.calculative.cycleIndex>t.animateCycle)return t.currentAnimation=void 0,t.calculative.start=void 0,t.calculative.cycleStart=void 0,0;t.calculative.cycleStart=void 0,t.calculative.animatePos=t.animateSpan}}else t.calculative.start=Date.now(),t.calculative.animatePos=t.animateSpan*(t.calculative.canvas.store.data.scale||1),t.calculative.cycleIndex=1;return!0}function Qe(t,e=!0){if(!t.children||!1===t.childActive)return;const i=t.calculative.canvas.store;t.children.forEach(t=>{const n=i.pens[t];n&&(n.calculative.active=e,Qe(n,e))})}function Ze(t,e=!0){if(!t)return;const i=t.calculative.canvas.store;t.calculative.hover=e,!1!==t.childHover&&t.children&&t.children.forEach(t=>{null==i.pens[t]?.hoverColor&&null==i.pens[t]?.hoverBackground&&Ze(i.pens[t],e)})}function ti(t,e){if(!e)return;const i=t.calculative.canvas.store,n=t.calculative.worldRect;if(e.style.opacity=t.globalAlpha+"",e.style.position="absolute",e.style.outline="none",e.style.left=n.x+i.data.x+"px",e.style.top=n.y+i.data.y+"px",e.style.width=n.width+"px",e.style.height=n.height+"px","iframe"===t.name?e.style.opacity=t.calculative.inView?"1":"0":e.style.display=0!=t.calculative.inView?t.calculative.cssDisplay||"inline":"none",!t.calculative.rotate&&(t.calculative.rotate=0),e.style.transform=`rotate(${t.calculative.rotate}deg)`,t.calculative.rotate||(t.calculative.flipX&&(e.style.transform="rotateY(180deg)"),t.calculative.flipY&&(e.style.transform="rotateX(180deg)"),t.calculative.flipX&&t.calculative.flipY&&(e.style.transform="rotateZ(180deg)")),e.style.zIndex=void 0!==t.calculative.zIndex?t.calculative.zIndex+"":"5",t.calculative.zIndex>t.calculative.canvas.maxZindex&&(t.calculative.canvas.maxZindex=t.calculative.zIndex),t.locked===a.DisableEdit||t.locked===a.DisableMove||i.data.locked?(e.style.userSelect="initial",e.style.pointerEvents="initial","gif"===t.name&&(e.style.userSelect="none",e.style.pointerEvents="none")):(e.style.userSelect="none",e.style.pointerEvents="none"),t.className&&(e.className=t.className),t.styles)for(let i in t.styles)e.style[i]=t.styles[i]}function ei(t,e){e&&globalThis.html2canvas&&globalThis.html2canvas(e).then(function(e){const i=new Image;i.src=e.toDataURL("image/png",.1),i.src.length>10&&(t.calculative.img=i)})}function ii(t){return t.every(t=>t.locked)}function ni(t){return t.every(t=>t.disableRotate)}function oi(t,e,i){t.rotateByRoot||("line"===t.name?(t.calculative.worldAnchors.forEach(t=>{L(t,e,i.center)}),function(t){if(!t.calculative.worldAnchors?.length)return;if(!isFinite(t.x)||!isFinite(t.x))return;if(null==t.x||null==t.y)return;const e=pn(t);t.parentId||Object.assign(t,e);const{fontSize:i,lineHeight:n}=t.calculative.canvas.store.options;t.fontSize?t.fontSize<0&&(t.fontSize=0,t.calculative.fontSize=0):(t.fontSize=i>=0?i:12,t.calculative.fontSize=t.fontSize*t.calculative.canvas.store.data.scale),t.lineHeight||(t.lineHeight=n,t.calculative.lineHeight=t.lineHeight),_i(e),t.calculative.worldRect=e,Se(t,e),nt(t),t.calculative.worldAnchors&&(t.anchors=t.calculative.worldAnchors.map(e=>$i(e,t.calculative.worldRect)))}(t),Pe(t)):(t.calculative.rotate?t.calculative.rotate+=e:t.calculative.rotate=e,L(t.calculative.worldRect.center,e,i.center),t.parentId&&(t.calculative.worldRect.x=t.calculative.worldRect.center.x-t.calculative.worldRect.width/2,t.calculative.worldRect.y=t.calculative.worldRect.center.y-t.calculative.worldRect.height/2,t.x=(t.calculative.worldRect.x-i.x)/i.width,t.y=(t.calculative.worldRect.y-i.y)/i.height)),t.children?.forEach(n=>{oi(t.calculative.canvas.store.pens[n],e,i)}))}function si(t){return t.every(t=>t.disableSize||t.pivot)}function ai(t,e,i){if(!t.frames||!e)return 0;let n=0;for(let o=0;o<i;o++)t.frames[o]&&(n+=t.frames[o][e]||0);return n}function ri(t,e){let i=t;for(;i&&i.parentId;){const t=i;i=e.pens[i.parentId];const n=i?.calculative?.showChild;if(null!=n&&i.children[n]!==t.id)return!1}return!0}function li(t,e=!1){const{store:i,canvasRect:n}=t.calculative.canvas;if(e&&t.children?.forEach(t=>{const e=i.pens[t];e&&li(e,!0)}),t.calculative.inView=!0,ri(t,i)?0!=t.visible&&0!=t.calculative.visible||(t.calculative.inView=!1,t.canvasLayer!==c.CanvasImageBottom&&t.canvasLayer!==c.CanvasImage||!t.frames?.length||(t.calculative.inView=t.frames.some(t=>t.hasOwnProperty("visible")))):t.calculative.inView=!1,t.calculative.inView){const{x:e,y:o,width:s,height:a,rotate:r}=t.calculative.worldRect,l={x:e+i.data.x,y:o+i.data.y,width:s,height:a,rotate:r};Mi(l),Fi(l,n)||(t.calculative.inView=!1)}t.calculative.singleton?.div&&ti(t,t.calculative.singleton.div)}function ci(t,e){const i=e.calculative.globalAlpha;"number"==typeof i&&i<1&&!isNaN(i)&&(t.globalAlpha=i)}function hi(t,e){const i=function(t,e){const i=e.drawCommand;if(i&&"line"!==e.name)return(t,e)=>{i.forEach(i=>{try{i.steps=i.steps.flat(1/0),i.steps.reduce((i,n)=>{const o=function(t,e,i,n){const o={visio:fi,dxf:di,canvas:ui};return o[e.parseType]?.(t,e,i,n)||t}(n,e,i.x,i.y);try{if(o.c){if(o.c.startsWith("_")){const n=o.c.split("_")[1];return"number"==typeof o.v.value&&(o.v.value*=e.calculative.canvas.store.data.scale),(o.p||t)[n]=o.v.value,{x:i.x,y:i.y}}let n=[];for(const t in o.v)n.push(o.v[t]);return(o.p||t)[o.c](...n),{x:o.startX||o.v.x,y:o.startY||o.v.y}}return{x:i.x,y:i.y}}catch(t){}},{})}catch(t){}}),t.stroke()}}(0,e)||V.canvasDraws[e.name];i&&(t.save(),i(t,e),t.restore())}function di(t,e,i,n){const{x:o,y:s,width:a,height:r}=e.calculative.worldRect,{originWidth:l,originHeight:c}=e.dxfOrigin;switch(t.c){case"beginPath":return{c:"beginPath",v:{}};case"closePath":return{c:"closePath",v:{}};case"moveTo":return{c:"moveTo",v:{x:t.v.x*(a/l)+o,y:t.v.y*(r/c)+s}};case"lineTo":return{c:"lineTo",v:{x:t.v.x*(a/l)+o,y:t.v.y*(r/c)+s}};case"arc":case"ellipse":return{c:"ellipse",v:{x:t.v.x*(a/l)+o,y:t.v.y*(r/c)+s,rx:t.v.xr*(a/l),ry:t.v.yr*(r/c),rotation:t.v.rotation||0,startAngle:t.v.startAngle,endAngle:t.v.endAngle,a:t.v.aclockwise??!0}};case"_font":return{c:"_font",v:{value:t.v.fontSize*e.calculative.canvas.store.data.scale+"px "+(t.v.fontFamily||e.calculative.canvas.store.options.fontFamily)}};case"_fillStyle":return{c:"_fillStyle",v:{value:t.v.value||e.color}};default:const i={c:t.c,v:{...t.v}};return void 0!==i.v.x&&(i.v.x=t.v.x*(a/l)+o),void 0!==i.v.y&&(i.v.y=t.v.y*(r/c)+s),i}}function ui(t,e,i,n){const{x:o,y:s,width:a,height:r}=e.calculative.worldRect,{originWidth:l,originHeight:c}=e.origin;switch(t.c){case"beginPath":return{c:"beginPath",v:{}};case"closePath":return{c:"closePath",v:{}};case"moveTo":return{c:"moveTo",v:{x:t.v.x*(a/l)+o,y:t.v.y*(r/c)+s}};case"lineTo":return{c:"lineTo",v:{x:t.v.x*(a/l)+o,y:t.v.y*(r/c)+s}};case"arc":case"ellipse":return{c:"ellipse",v:{x:t.v.x*(a/l)+o,y:t.v.y*(r/c)+s,rx:t.v.xr*(a/l),ry:t.v.yr*(r/c),rotation:t.v.rotation||0,startAngle:t.v.startAngle,endAngle:t.v.endAngle,a:t.v.aclockwise??!0}};case"_font":return{c:"_font",v:{value:t.v.fontSize*e.calculative.canvas.store.data.scale+"px "+(t.v.fontFamily||e.calculative.canvas.store.options.fontFamily)}};default:const i={c:t.c,v:{...t.v}};return void 0!==i.v.x&&(i.v.x=t.v.x*(a/l)+o),void 0!==i.v.y&&(i.v.y=t.v.y*(r/c)+s),i}}function fi(t,e,i,n){const{x:o,y:s,width:a,height:r}=e.calculative.worldRect,{width:l,height:c}=e.origin;switch(t.c){case"MoveTo":return{c:"moveTo",v:{x:100*+t.v.X*(a/l)+o,y:100*+t.v.Y*(r/c)+s}};case"RelMoveTo":return{c:"moveTo",v:{x:+t.v.X*l*(a/l)+o,y:+t.v.Y*c*(r/c)+s}};case"LineTo":return{c:"lineTo",v:{x:100*+t.v.X*(a/l)+o,y:100*+t.v.Y*(r/c)+s}};case"RelLineTo":return{c:"lineTo",v:{x:+t.v.X*l*(a/l)+o,y:+t.v.Y*c*(r/c)+s}};case"Ellipse":let e=t.v.X,h=t.v.Y,d=Math.abs(t.v.A-t.v.C),u=Math.abs(t.v.B-t.v.D);return{c:"ellipse",v:{x:100*e*(a/l)+o,y:100*h*(r/c)+s,radiuX:100*d*(a/l),radiuY:100*u*(r/c),rotation:0,startAngle:0,endAngle:2*Math.PI,anticlockwise:!0}};case"EllipticalArcTo":const f=100*t.v.X*(a/l)+o,p=100*t.v.Y*(r/c)+s,v=100*t.v.A*(a/l)+o,g=100*t.v.B*(r/c)+s,y=(t.v.C,(f-i)*(g-n)-(p-n)*(v-i)>0),m=gi(i,n,f,p,v,g,t.v.D*(a/r)*(c/l));return!t.orign&&(t.orign={}),!t.orign.startA&&(t.orign.startA=yi(m.x0,m.y0,i,n)),!t.orign.endA&&(t.orign.endA=yi(m.x0,m.y0,f,p)),{c:"ellipse",v:{centerX:m.x0,centerY:m.y0,radiuX:m.a,radiuY:m.b,rotation:0,startAngle:t.orign.startA,endAngle:t.orign.endA,anticlockwise:y},startX:f,startY:p};case"RelEllipticalArcTo":const w=t.v.X*l*(a/l)+o,x=t.v.Y*c*(r/c)+s,b=t.v.A*l*(a/l)+o,k=t.v.B*c*(r/c)+s,T=(t.v.C,(w-i)*(k-n)-(x-n)*(b-i)>0),C=gi(i,n,w,x,b,k,t.v.D*(a/r)*(c/l));return!t.orign&&(t.orign={}),!t.orign.startA&&(t.orign.startA=yi(C.x0,C.y0,i,n)),!t.orign.endA&&(t.orign.endA=yi(C.x0,C.y0,w,x)),{c:"ellipse",v:{centerX:C.x0,centerY:C.y0,radiuX:C.a,radiuY:C.b,rotation:0,startAngle:t.orign.startA,endAngle:t.orign.endA,anticlockwise:T},startX:w,startY:x};case"ArcTo":let A=100*t.v.X*a/l+o,R=100*t.v.Y*r/c+s,S=100*t.v.A*(a/r)*(c/l),P=(i+A)/2,I=(n+R)/2,E=Math.sqrt((A-i)**2+(R-n)**2),_=E**2/(8*S)+S/2,M=P+-(R-n)/E*_,L=I+(A-i)/E*_;return{c:"arc",v:{x:M,y:L,radius:_,startAngle:Math.atan2(n-L,i-M),endAngle:Math.atan2(R-L,A-M),aclockwise:!0}};default:const D=dt(t);return Object.entries(D.v).forEach(([t,e])=>{t.endsWith?.("_x")?"number"==typeof e&&(D.v[t]=e*(a/l)+o):t.endsWith?.("_y")?"number"==typeof e&&(D.v[t]=e*(r/c)+s):"number"==typeof e&&(D.v[t]=e)}),D}}function pi(t,e){t.filter=e.filter}function vi(t,e){for(const i in e)I.includes(i)&&("fontSize"==i&&e[i]<0&&(e[i]=0),t[i]=e[i],["fontSize","lineWidth"].includes(i)?(t.calculative[i]=e[i]*t.calculative.canvas.store.data.scale,nt(t)):t.calculative[i]=e[i]),t.image&&"gif"!==t.name&&p.includes(i)&&(t.calculative.canvas.store.patchFlagsTop=!0,t.calculative.canvas.store.patchFlagsBackground=!0,t.calculative.imageDrawed=!1);if(t.calculative.canvas.parent.isCombine(t)){const i=t.children;i?.forEach(i=>{let n=dt(e);t.calculative.childrenVisible&&!1===t.calculative.childrenVisible[i]&&delete n.visible;const o=t.calculative.canvas.store.pens[i];o&&vi(o,n)})}}function gi(t,e,i,n,o,s,a){let r=((t-i)*(t+i)*(n-s)-(i-o)*(i+o)*(e-n)+a*a*(e-n)*(n-s)*(e-s))/(2*((t-i)*(n-s)-(i-o)*(e-n))),l=((t-i)*(i-o)*(t-o)+a*a*((i-o)*(e-n)*(e+n)-(t-i)*(n-s)*(n+s)))/(2*a*a*((i-o)*(e-n)-(t-i)*(n-s))),c=Math.sqrt(Math.pow(t-r,2)+Math.pow(a*(e-l),2));return{x0:r,y0:l,a:c,b:c/a}}function yi(t,e,i,n){let o=i-t,s=n-e,a=Math.atan2(s,o);return a<0&&(a+=2*Math.PI),a}function mi(t,e,i){let n,o,s=1/0,a=1/0;for(const r of t.data.pens)!1!==r.calculative.inView&&xi(r).forEach(t=>{if(t===e||t===i)return;let l=(r.calculative.worldRect.center.x-e.x)*(r.calculative.worldRect.center.x-e.x)+(r.calculative.worldRect.center.y-e.y)*(r.calculative.worldRect.center.y-e.y);const c=Math.abs(t.x-e.x);c>0&&c<8&&l<s&&(n={x:Math.round(t.x)+.5,y:Math.round(t.y)+.5,prev:{x:Math.round(e.x)+.5,y:Math.round(e.y)+.5},step:t.x-e.x},s=l);const h=Math.abs(t.y-e.y);h>0&&h<8&&l<a&&(o={x:Math.round(t.x)+.5,y:Math.round(t.y)+.5,prev:{x:Math.round(e.x)+.5,y:Math.round(e.y)+.5},step:t.y-e.y},a=l)});return{xDock:n,yDock:o}}function wi(t,e,i,n){let o=[];return 1===i.length?(o=dt(xi(i[0])),o.forEach(t=>{t.x+=n.x,t.y+=n.y})):(_i(e),o=[e.center,...Bi(e)]),ki(t,o,e,!0)}function xi(t){if(!t.type){const e=Bi(t.calculative.worldRect);return _i(t.calculative.worldRect),[...t.calculative.worldAnchors,...e,t.calculative.worldRect.center]}if(t.type===s.Line)return t.calculative.worldAnchors}function bi(t,e,i,n){return ki(t,Bi(e),e)}function ki(t,e,i,n=!1){let o,s,a=1/0,r=1/0;const l=ji(i,10);return t.data.pens.forEach(c=>{const{inView:h,worldRect:d,active:u}=c.calculative;if(!1===h||!n&&u||zi(l,d)||c.type&&t.active.some(e=>Ti(t,e,c)))return;const f=xi(c);if(f)for(const t of f)for(const n of e){const e=t.x-n.x,l=t.y-n.y,h=Math.abs(e),d=Math.abs(l);i.center||(i.center={x:i.x+i.width/2,y:i.y+i.height/2}),h<10&&h<a&&(o={x:Math.round(t.x)+.5,y:Math.round(t.y)+.5,step:e,prev:{x:Math.round(n.x)+.5,y:Math.round(n.y)+.5},penId:c.id,anchorId:n.id,dockAnchorId:t.id},a=h),d<10&&d<r&&(s={x:Math.round(t.x)+.5,y:Math.round(t.y)+.5,step:l,prev:{x:Math.round(n.x)+.5,y:Math.round(n.y)+.5},penId:c.id,anchorId:n.id,dockAnchorId:t.id},r=d)}}),{xDock:o,yDock:s}}function Ti(t,e,i){if(!i.type)return!1;if(Array.isArray(e?.connectedLines))for(const t of e?.connectedLines)if(t.lineId===i.id)return!0;if(Array.isArray(e?.children))for(const n of e.children)if(Ti(t,t.pens[n],i))return!0;return!1}function Ci(t,e){return t.toFixed(12)==e}function Ai(t,e=4){let i=t.map(t=>t.calculative.worldRect);const n=i.map(t=>t.x),o=i.map(t=>t.y),s=n.reduce((t,e)=>t+e,0)/n.length,a=o.reduce((t,e)=>t+e,0)/o.length,r=Math.sqrt(n.map(t=>Math.pow(t-s,2)).reduce((t,e)=>t+e,0)/n.length),l=Math.sqrt(o.map(t=>Math.pow(t-a,2)).reduce((t,e)=>t+e,0)/o.length);return t.filter(t=>{let i=t.calculative.worldRect;const n=(i.x-s)/r,o=(i.y-a)/l;return Math.sqrt(n*n+o*o)>e})}function Ri(t){if(t.id=Ct(),Array.isArray(t.anchors))for(const e of t.anchors)t.type&&(e.id=Ct()),e.penId=t.id,e.prev&&(t.type&&(e.prev.id=Ct()),e.prev.penId=t.id),e.next&&(t.type&&(e.next.id=Ct()),e.next.penId=t.id)}let Si=function(){let t=null,e=new Map;return(i,n,o,s=!1)=>{if(e.has(i)&&e.get(i)?t=e.get(i):e.set(i,t=new Map),"function"!=typeof o)return()=>{console.warn("[rewritePenLifeCycle] warn: not a function ")};let a=new Set,r=new Map;t.has(n)&&t.get(n)?a=t.get(n):(r.set(n,i[n]),t.set(n,a)),s?a.delete(o):a.add(o);let l=r.get(n);i[n]=(...t)=>{l?.(...t),a.forEach(e=>{e(...t)})}}}();function Pi(t){return!(!t.name&&!t.install&&(console.error("installPenPlugin Error: Validation Failed"),1))}function Ii(t,e){if(!e)return;if(null==e.ex&&Mi(e),!e.rotate||e.rotate%360==0)return t.x>e.x&&t.x<e.ex&&t.y>e.y&&t.y<e.ey;e.center||_i(e);const i=[{x:e.x,y:e.y},{x:e.ex,y:e.y},{x:e.ex,y:e.ey},{x:e.x,y:e.ey}];return i.forEach(t=>{L(t,e.rotate,e.pivot||e.center)}),Di(t,i)}function Ei(t,e,i=0){const{x:n,y:o,ex:s,ey:a}=e;return t.x>=n-i&&t.x<=s+i&&t.y>=o-i&&t.y<=a+i}function _i(t){t.center||(t.center={}),t.center.x=t.x+t.width/2,t.center.y=t.y+t.height/2}function Mi(t){t.ex=t.x+t.width,t.ey=t.y+t.height}function Li(t,e){t.pivot||(t.pivot={}),t.pivot.x=t.x+t.width*e.x,t.pivot.y=t.y+t.height*e.y}function Di(t,e){if(e.length<3)return!1;let i=!1,n=e[e.length-1];for(const o of e)n.y>t.y!=o.y>t.y&&o.x+(t.y-o.y)*(n.x-o.x)/(n.y-o.y)>t.x&&(i=!i),n=o;return i}function Oi(t){const e=[];t.forEach(t=>{if(t.isRuleLine)return;const i=t.calculative.worldRect;if(i){const t=Bi(i);e.push(...t)}});const i=Ni(e);return _i(i),i}function Bi(t){const e=[{x:t.x,y:t.y},{x:t.ex,y:t.y},{x:t.ex,y:t.ey},{x:t.x,y:t.ey}];return t.rotate&&(t.center||_i(t),e.forEach(e=>{L(e,t.rotate,t.pivot||t.center)})),e}function Ni(t){let e=1/0,i=1/0,n=-1/0,o=-1/0;return t?.forEach(t=>{isFinite(t.x)&&isFinite(t.y)&&(e=Math.min(e,t.x),i=Math.min(i,t.y),n=Math.max(n,t.x),o=Math.max(o,t.y))}),{x:e,y:i,ex:n,ey:o,width:n-e,height:o-i}}function Fi(t,e,i){return t.rotate&&(t=Ni(Bi(t))),i?t.x>e.x&&t.ex<e.ex&&t.y>e.y&&t.ey<e.ey:!(t.x>e.ex||t.ex<e.x||t.ey<e.y||t.y>e.ey)}function zi(t,e){return(e.x>t.ex||e.ex<t.x)&&(e.y>t.ey||e.ey<t.y)}function ji(t,e){const i=St(e),n={x:t.x-i[3],y:t.y-i[0],width:t.width+i[1]+i[3],height:t.height+i[0]+i[2]};return Mi(n),n}function Hi(t,e,i){t.x+=e,t.y+=i,t.ex+=e,t.ey+=i,t.center&&(t.center.x+=e,t.center.y+=i),t.pivot&&(t.pivot.x+=e,t.pivot.y+=i)}function Wi(t,e){if(Ci(t.k,0))return{x:e.point.x,y:t.point.y};if(Ci(e.k,0))return{x:t.point.x,y:e.point.y};const i=t.point.y-t.k*t.point.x,n=(e.point.y-e.k*e.point.x-i)/(t.k-e.k);return{x:n,y:t.k*n+i}}function Vi(t,e,i,n){let o=t.rotate?t.rotate%360:0;if(o){const s=Bi(t),a=(s[0].y-s[1].y)/(s[0].x-s[1].x),r=(s[1].y-s[2].y)/(s[1].x-s[2].x);if(n<4){if(s[n].x+=e,t.ratio)if(0===n||2===n){let i=e*Math.tan((90-(360-o)-Math.atan(t.width/t.height)/Math.PI*180)/180*Math.PI);s[n].y+=i}else{let i=e*Math.tan((90-(360-o)+Math.atan(t.width/t.height)/Math.PI*180)/180*Math.PI);s[n].y+=i}else s[n].y+=i;const l=s[(n+2)%4];s[(n+1)%4]=Wi({k:n%2?r:a,point:s[n]},{k:n%2?a:r,point:l}),s[(n+4-1)%4]=Wi({k:n%2?a:r,point:s[n]},{k:n%2?r:a,point:l})}else{const t=[4,6].includes(n)?r:a;Ci(t,0)?(s[n%4].x+=e,s[(n+1)%4].x+=e):(s[n%4].y+=i,s[n%4].x+=i/t,s[(n+1)%4].y+=i,s[(n+1)%4].x+=i/t)}if((s[0].x-s[1].x)**2+(s[0].y-s[1].y)**2<25||(s[1].x-s[2].x)**2+(s[1].y-s[2].y)**2<25)return;const l=function(t,e){const i=function(t,e){const i=(t.to.y-t.from.y)/(t.to.x-t.from.x),n=(e.to.y-e.from.y)/(e.to.x-e.from.x);return Wi({k:i,point:t.from},{k:n,point:e.from})}({from:t[0],to:t[2]},{from:t[1],to:t[3]});for(const n of t)L(n,-e,i);return Ni(t)}(s,t.rotate);return _i(l),void Object.assign(t,l)}switch(n){case 0:if(t.width-e<5||t.height-i<5)break;t.x+=e,t.y+=i,t.width-=e,t.height-=i;break;case 1:if(t.width+e<5||t.height-i<5)break;t.ex+=e,t.y+=i,t.width+=e,t.height-=i;break;case 2:if(t.width+e<5||t.height+i<5)break;t.ex+=e,t.ey+=i,t.width+=e,t.height+=i;break;case 3:if(t.width-e<5||t.height+i<5)break;t.x+=e,t.ey+=i,t.width-=e,t.height+=i;break;case 4:if(t.height-i<5)break;t.y+=i,t.height-=i;break;case 5:if(t.width+e<5)break;t.ex+=e,t.width+=e;break;case 6:if(t.height+i<5)break;t.ey+=i,t.height+=i;break;case 7:if(t.width-e<5)break;t.x+=e,t.width-=e}}function Ui(t,e,i,n){t&&(t.width*=e,t.height*=e,O(t,e,i),Mi(t),_i(t),n&&Li(t,n))}function qi(t,e){const i={x:(t.x-e.x)/e.width,y:(t.y-e.y)/e.height,width:t.width/e.width,height:t.height/e.height};return Mi(i),i}function $i(t,e){const{x:i,y:n,width:o,height:s}=e,{penId:a,connectTo:r}=t,l=Object.assign({},t,{x:o?(t.x-i)/o:0,y:s?(t.y-n)/s:0});return t.prev&&(l.prev={penId:a,connectTo:r,x:o?(t.prev.x-i)/o:0,y:s?(t.prev.y-n)/s:0}),t.next&&(l.next={penId:a,connectTo:r,x:o?(t.next.x-i)/o:0,y:s?(t.next.y-n)/s:0}),l}function Ki(t,e){let i=!1;for(let n=0,o=e.length-1;n<e.length;o=n++){let s=e[n].x,a=e[n].y,r=e[o].x,l=e[o].y;a>t.y!=l>t.y&&t.x<(r-s)*(t.y-a)/(l-a)+s&&(i=!i)}return i}const Yi=/^[\t\n\f\r ]*([MLHVZCSQTAmlhvzcsqta])[\t\n\f\r ]*/,Xi=/^[01]/,Gi=/^[+-]?(([0-9]*\.[0-9]+)|([0-9]+\.)|([0-9]+))([eE][+-]?[0-9]+)?/,Ji=/^(([\t\n\f\r ]+,?[\t\n\f\r ]*)|(,[\t\n\f\r ]*))/,Qi={M:[Gi,Gi],L:[Gi,Gi],H:[Gi],V:[Gi],Z:[],C:[Gi,Gi,Gi,Gi,Gi,Gi],S:[Gi,Gi,Gi,Gi],Q:[Gi,Gi,Gi,Gi],T:[Gi,Gi],A:[Gi,Gi,Gi,Xi,Xi,Gi,Gi]};function Zi(t){let e=1/0,i=1/0,n=-1/0,o=-1/0;return function(t){let e,i=0,n=0;t.commands.forEach(t=>{switch(t.key){case"Z":case"z":t.worldPoints=[i,n];break;case"H":t.worldPoints=[t.values[0],e.worldPoints[e.worldPoints.length-1]];break;case"h":t.worldPoints=[t.values[0]+e.worldPoints[e.worldPoints.length-2],e.worldPoints[e.worldPoints.length-1]];break;case"V":t.worldPoints=[e.worldPoints[e.worldPoints.length-2],t.values[0]];break;case"v":case"A":t.worldPoints=[e.worldPoints[e.worldPoints.length-2],t.values[0]+e.worldPoints[e.worldPoints.length-1]];break;default:!function(t,e){const i=[];let n=t.relative&&e?{x:e.worldPoints[e.worldPoints.length-2],y:e.worldPoints[e.worldPoints.length-1]}:{x:0,y:0};for(let e=0;e<t.values.length-1;e+=2)i.push(n.x+t.values[e]),i.push(n.y+t.values[e+1]);t.worldPoints=i}(t,e)}"M"!==t.key&&"m"!==t.key&&"Z"!==t.key&&"z"!==t.key||(i=t.worldPoints[t.worldPoints.length-2],n=t.worldPoints[t.worldPoints.length-1]),e=t})}(t),t.commands.forEach(t=>{t.worldPoints.forEach((t,s)=>{s%2==0?(t<e&&(e=t),t>n&&(n=t)):(t<i&&(i=t),t>o&&(o=t))})}),{x:e,y:i,ex:n,ey:o,width:n-e+1,height:o-i+1}}function tn(t,e,i){const n=Qi[t.toUpperCase()],o=[];for(;i<=e.length;){const s={key:t,values:[]};for(const t of n){const n=e.slice(i).match(t);if(null===n){if(0===s.values.length)return{cursor:i,commands:o};throw new Error("malformed path (first error at "+i+")")}{s.values.push(+n[0]),i+=n[0].length;const t=e.slice(i).match(Ji);null!==t&&(i+=t[0].length)}}if(s.relative=s.key.toUpperCase()!==s.key,o.push(s),0===n.length)return{cursor:i,commands:o};"m"===t&&(t="l"),"M"===t&&(t="L")}throw new Error("malformed path (first error at "+i+")")}function en(t,e){const i=t.calculative.canvas.store.data.paths[t.pathId];if(!i)return new Path2D;const n=function(t){let e=0;const i=[];for(;e<t.length;){const n=t.slice(e).match(Yi);if(null===n)throw new Error("malformed path (first error at "+e+")");{const o=n[1];e+=n[0].length;const s=tn(o,t,e);e=s.cursor,i.push(...s.commands)}}return{commands:i}}(i);t.calculative.svgRect=Zi(n),_i(t.calculative.svgRect),t.calculative.svgRect.width===t.calculative.worldRect.width&&t.calculative.svgRect.height===t.calculative.worldRect.height||function(t,e,i){null==i&&(i=e),t.commands.forEach(t=>{switch(t.key){case"A":case"a":const n=t.values[0],o=t.values[1],s=Math.PI*t.values[2]/180,a=Math.cos(s),r=Math.sin(s),l=o*o*i*i*a*a+n*n*i*i*r*r,c=2*e*i*a*r*(o*o-n*n),h=n*n*e*e*a*a+o*o*e*e*r*r,d=-n*n*o*o*e*e*i*i,u=c*c-4*l*h,f=Math.sqrt((l-h)*(l-h)+c*c);t.values[2]=0!==c?180*Math.atan((h-l-f)/c)/Math.PI:l<h?0:90,t.values[0]=-Math.sqrt(2*u*d*(l+h+f))/u,t.values[1]=-Math.sqrt(2*u*d*(l+h-f))/u,t.values[5]*=e,t.values[6]*=i,t.values[4]=e*i>=0?t.values[4]:1-t.values[4];break;case"V":case"v":t.values[0]*=i;break;default:t.values.forEach((n,o)=>{t.values[o]=n*(o%2==0?e:i)})}})}(n,t.calculative.worldRect.width/t.calculative.svgRect.width,t.calculative.worldRect.height/t.calculative.svgRect.height);const o=Zi(n);_i(o),function(t,e,i){null==i&&(i=e),t.commands.forEach((t,n)=>{if(!t.relative||!n)switch(t.key){case"A":case"a":t.values[5]+=e,t.values[6]+=i;break;case"V":case"v":t.values[0]+=i;break;default:t.values.forEach((n,o)=>{t.values[o]=n+(o%2==0?e:i)})}})}(n,t.calculative.worldRect.x-o.x,t.calculative.worldRect.y-o.y);const s=function(t){let e="";return t.commands.forEach(t=>{e+=t.key+" ",t.values.forEach(t=>{e+=t+" "})}),e}(n);if(!e)return new Path2D(s);e.svgPath?.(s)}function nn(t,e){const{x:i,y:n,width:o,ex:s,ey:a}=e.calculative.worldRect;let r=.25*o;const l=e.z;l>1?r=l*e.calculative.canvas.store.data.scale:l>0&&(r=o*l);const c={x:i,y:n+r},h={x:s-r,y:n+r},d={x:s-r,y:a};on(t,[c,h,d,{x:i,y:a}],e.backgroundFront||e.background,e.color),on(t,[c,{x:i+r,y:n},{x:s,y:n},h],e.backgroundUp||e.background,e.color),on(t,[h,{x:s,y:n},{x:s,y:a-r},d],e.backgroundRight||e.background,e.color)}function on(t,e,i="",n=""){t.save(),i&&(t.fillStyle=i),n&&(t.strokeStyle=n),t.beginPath();for(let i=0;i<e.length;++i)i?t.lineTo(e[i].x,e[i].y):t.moveTo(e[i].x,e[i].y);t.closePath(),i&&t.fill(),t.stroke(),t.restore()}function sn(t,e,i){if(e.calculative.worldAnchors||(e.calculative.worldAnchors=[]),i)e.calculative.activeAnchor&&(e.calculative.activeAnchor.next={penId:e.id,x:i.x,y:i.y},N(e.calculative.activeAnchor.next,e.calculative.activeAnchor)<5?e.calculative.activeAnchor.next=void 0:(e.calculative.activeAnchor.prev={...e.calculative.activeAnchor.next},L(e.calculative.activeAnchor.prev,180,e.calculative.activeAnchor)));else{const i=e.calculative.worldAnchors[0];i.next||(an(i,Fe(i,t.pens[i.connectTo]),50),i.prev=void 0);const n=e.calculative.worldAnchors[e.calculative.worldAnchors.length-1];n&&n!==i&&!n.prev&&(an(n,Fe(n,t.pens[n.connectTo]),-50),n.next=void 0)}}function an(t,e,i){switch(e){case A.Up:t.prev={penId:t.penId,x:t.x,y:t.y+i},t.next={penId:t.penId,x:t.x,y:t.y-i};break;case A.Right:t.prev={penId:t.penId,x:t.x-i,y:t.y},t.next={penId:t.penId,x:t.x+i,y:t.y};break;case A.Bottom:t.prev={penId:t.penId,x:t.x,y:t.y-i},t.next={penId:t.penId,x:t.x,y:t.y+i};break;case A.Left:t.prev={penId:t.penId,x:t.x+i,y:t.y},t.next={penId:t.penId,x:t.x-i,y:t.y}}}function rn(t,e,i,n){const o=1-t;return{x:o*o*e.x+2*o*t*i.x+t*t*n.x,y:o*o*e.y+2*o*t*i.y+t*t*n.y,step:t}}function ln(t,e,i,n,o){const{x:s,y:a}=e,{x:r,y:l}=o,{x:c,y:h}=i,{x:d,y:u}=n,f=1-t;return{x:s*f*f*f+3*c*t*f*f+3*d*t*t*f+r*t*t*t,y:a*f*f*f+3*h*t*f*f+3*u*t*t*f+l*t*t*t,step:t}}function cn(t,e,i){return{x:t.x+i*(e.x-t.x),y:t.y+i*(e.y-t.y)}}function hn(t,e,i){if(e.calculative.worldAnchors||(e.calculative.worldAnchors=[]),e.calculative.worldAnchors.length<2)return;let n=e.calculative.activeAnchor,o=i||$e(e);if(!n||!o)return;let s=Fe(n,t.pens[n.connectTo]);switch(s===A.None&&(s=o.x>n.x?A.Right:A.Left),n.next={id:Ct(),penId:e.id,x:n.x,y:n.y,prevNextType:2},o.prev={id:Ct(),penId:e.id,x:o.x,y:o.y,prevNextType:2},s){case A.Up:n.next.y-=20,o.prev.y=n.y;break;case A.Bottom:n.next.y+=20,o.prev.y=n.y;break;case A.Left:n.next.x-=20,o.prev.x=n.x;break;default:n.next.x+=20,o.prev.x=n.x}}function dn(t,e){const i=e||new Path2D;if(("line"===t.lineName||"polyline"===t.lineName)&&t.calculative.lineSmooth){let e=ee(t);if(i instanceof Path2D&&i.addPath(e),i instanceof Path2D)return i}const n=t.calculative.worldAnchors;if(n.length>1){let e;n.forEach(t=>{e?fn(i,e,t):t.start=!0,e=t}),t.close&&("curve"===t.lineName?fn(i,e,n[0]):i.closePath())}if(i instanceof Path2D)return i}function un(t,e,i){if(e.calculative.worldAnchors||(e.calculative.worldAnchors=[]),e.calculative.worldAnchors.length<2||e.anchors?.length>1)return;const n=qe(e),o=$e(e);n&&o&&o.id&&n!==o&&(n.next=void 0,He(e),o.prev=void 0,e.calculative.worldAnchors.push(o))}function fn(t,e,i){i&&!i.isTemp&&(e.start&&t.moveTo(e.x,e.y),e.next?i.prev?t.bezierCurveTo(e.next.x,e.next.y,i.prev.x,i.prev.y,i.x,i.y):t.quadraticCurveTo(e.next.x,e.next.y,i.x,i.y):i.prev?t.quadraticCurveTo(i.prev.x,i.prev.y,i.x,i.y):t.lineTo(i.x,i.y))}function pn(t){return bn(t),Ni(vn(t))}function vn(t){const e=[];let i;return t.calculative.worldAnchors.forEach(n=>{e.push(n),i&&e.push(...yn(i,n,t)),i=n}),t.close&&t.calculative.worldAnchors.length>1&&e.push(...yn(i,t.calculative.worldAnchors[0],t)),e}function gn(t){return t?.lineWidth?t.lineWidth/2+4:4}function yn(t,e,i){const n=[];if(!e)return n;let o=.02;if(t.lineLength&&!i.parentId&&(o=gn(i)/t.lineLength),t.next)if(e.prev)for(let i=o;i<1;i+=o)n.push(ln(i,t,t.next,e.prev,e));else for(let i=o;i<1;i+=o)n.push(rn(i,t,t.next,e));else if(e.prev)for(let i=o;i<1;i+=o)n.push(rn(i,t,e.prev,e));else n.push({x:e.x,y:e.y});return n.length>1&&(t.curvePoints=n),n}function mn(t,e){const i=gn(e);let n,o,s=0;for(const a of e.calculative.worldAnchors){if(n){if(o=wn(t,n,a,i),o)return{i:s,point:o};++s}n=a}if(e.close&&e.calculative.worldAnchors.length>1&&(o=wn(t,n,e.calculative.worldAnchors[0],i)))return{i:s,point:o}}function wn(t,e,i,n=4){if(!e.next&&!i.prev){const{x:o,y:s}=e,{x:a,y:r}=i,l=Math.min(o,a),c=Math.max(o,a),h=Math.min(s,r),d=Math.max(s,r);if(!(t.x>=l-n&&t.x<=c+n&&t.y>=h-n&&t.y<=d+n))return;return function(t,e,i,n=4){if(e.x===i.x){if(Math.abs(t.x-e.x)<=n)return{x:e.x,y:t.y}}else{const o=(e.y-i.y)/(e.x-i.x),s=e.y-o*e.x;if(Math.abs((o*t.x+s-t.y)/Math.sqrt(o*o+1))<=n){const e=(t.x+o*t.y-o*s)/(o*o+1);return{x:e,y:o*e+s}}}}(t,e,i,n)}if(e.curvePoints)for(const i of e.curvePoints)if(D(t,i,n))return i}function xn(t,e,i,n){if(!e&&!i)return Math.sqrt(Math.pow(Math.abs(t.x-n.x),2)+Math.pow(Math.abs(t.y-n.y),2))||0;const o=document.createElementNS("http://www.w3.org/2000/svg","path");return e&&i?o.setAttribute("d",`M${t.x} ${t.y} C${e.x} ${e.y} ${i.x} ${i.y} ${n.x} ${n.y}`):e?o.setAttribute("d",`M${t.x} ${t.y} Q${e.x} ${e.y} ${n.x} ${n.y}`):o.setAttribute("d",`M${t.x} ${t.y} Q${i.x} ${i.y} ${n.x} ${n.y}`),o.getTotalLength()||0}function bn(t){if(t.calculative.worldAnchors.length<2)return 0;let e,i=0;if(t.calculative.worldAnchors.forEach(t=>{e&&(e.lineLength=xn(e,e.next,t.prev,t),i+=e.lineLength),e=t}),t.close){const n=qe(t);e.lineLength=xn(e,e.next,n.prev,n),i+=e.lineLength}return t.calculative.animatePos&&(t.calculative.animatePos=i/t.length*t.calculative.animatePos),t.length=i,i}function kn(t,e){const i=t.calculative.worldAnchors;for(let t=0;t<i.length-1;t++){const n=i[t],o=i[t+1];if(n.next||o.prev){if(Cn(n,o,e))return!0}else if(Tn(n,o,e))return!0}return!1}function Tn(t,e,i){if(Ei(t,i)||Ei(e,i))return!0;const n=t.x,o=t.y,s=e.x,a=e.y;let r=i.x,l=i.y,c=i.ex,h=i.ey;const d=o-a,u=s-n,f=n*a-s*o;if(d*r+u*l+f>=0&&d*c+u*h+f<=0||d*r+u*l+f<=0&&d*c+u*h+f>=0||d*r+u*h+f>=0&&d*c+u*l+f<=0||d*r+u*h+f<=0&&d*c+u*l+f>=0){if(r>c){const t=r;r=c,c=t}if(l<h){const t=l;l=h,h=t}return!(n<r&&s<r||n>c&&s>c||o>l&&a>l||o<h&&a<h)}return!1}function Cn(t,e,i){const n=.02;if(!t.next&&!e.prev)return Tn(t,e,i);if(t.next&&e.prev){for(let o=n;o<1;o+=n)if(Ei(ln(o,t,t.next,e.prev,e),i))return!0}else if(t.next||e.prev)for(let o=n;o<1;o+=n)if(Ei(rn(o,t,t.next||e.prev,e),i))return!0;return!1}function An(t,e,i,n,o){let s="";return t||(s+=`M${e.x} ${e.y} `,(t=document.createElementNS("http://www.w3.org/2000/svg","path")).setAttribute("d",s)),s=t.getAttribute("d")||"",s+=i&&n?`C${i.x} ${i.y} ${n.x} ${n.y} ${o.x} ${o.y}`:i?`Q${i.x} ${i.y} ${o.x} ${o.y}`:`Q${n?.x||e.x} ${n?.y||e.y} ${o.x} ${o.y}`,t.setAttribute("d",s),t}let Rn=10;function Sn(t,e,i){if(e.calculative.worldAnchors||(e.calculative.worldAnchors=[]),Rn=t.options.polylineSpace||10,e.calculative.worldAnchors.length<2)return;let n,o=qe(e),s=$e(e);if(!o||!s)return;if(e.anchors?.length&&o===e.calculative.activeAnchor?(n=!0,o=s,s=qe(e)):e.anchors&&e.anchors.length||o===e.calculative.activeAnchor||(o=e.calculative.activeAnchor),!o||!s)return;o.next=void 0,s.prev=void 0;const a=s.connectTo;He(e);const r=[],l=t.pens[o.connectTo],c=t.pens[s.connectTo],h=Fe(o,l),d=Fe(s,c);let u=Pn(o,h,Rn);u&&(o=u,r.push(u)),u=Pn(s,d,Rn);const f=s;let p;if(u&&(s=u,f.connectTo&&(u.y>f.y&&o.y<f.y||u.y<f.y&&o.y>f.y))){p=u;let t=Rn;o.x<u.x&&(t=-t),Math.abs(o.x-u.x)<t&&(t=-t),s={x:u.x+t,y:u.y,id:Ct()}}switch(h){case A.Up:r.push(...function(t,e,i){if(t.x===e.x||t.y===e.y)return[];const n=[];let o,s;switch(i){case A.Up:t.y<e.y?(o=e.x,s=t.y):(o=t.x,s=e.y),n.push({x:o,y:s});break;case A.Bottom:if(o=e.x,s=t.y,e.y>t.y)o=t.x+(e.x-t.x)/2,n.push({x:o,y:t.y},{x:o,y:e.y});else{const i=(t.y+e.y)/2;n.push({x:t.x,y:i},{x:e.x,y:i})}break;case A.Right:o=e.x,s=t.y,e.x<t.x&&e.y<t.y&&(o=t.x,s=e.y),n.push({x:o,y:s});break;case A.Left:o=e.x,s=t.y,e.x>t.x&&e.y<t.y&&(o=t.x,s=e.y),n.push({x:o,y:s});break;default:if(e.y>t.y-Rn)o=t.x+(e.x-t.x)/2,n.push({x:o,y:t.y},{x:o,y:e.y});else{const i=(t.y+e.y+Rn)/2;n.push({x:t.x,y:i},{x:e.x,y:i})}}return n}(o,s,d));break;case A.Right:r.push(...function(t,e,i){if(t.x===e.x||t.y===e.y)return[];const n=[];let o,s;switch(i){case A.Up:o=t.x,s=e.y,e.x>t.x&&e.y>t.y&&(o=e.x,s=t.y),n.push({x:o,y:s});break;case A.Bottom:o=t.x,s=e.y,e.x>t.x&&e.y<t.y&&(o=e.x,s=t.y),n.push({x:o,y:s});break;case A.Left:if(o=e.x,s=t.y,e.x<t.x)s=t.y+(e.y-t.y)/2,n.push({x:t.x,y:s},{x:e.x,y:s});else{const i=(t.x+e.x)/2;n.push({x:i,y:s},{x:i,y:e.y})}break;case A.Right:e.x<t.x?n.push({x:t.x,y:e.y}):n.push({x:e.x,y:t.y});break;default:if(o=e.x,s=e.y,e.x<t.x+Rn)n.push({x:t.x,y:s});else{const i=(t.x+e.x-Rn)/2;n.push({x:i,y:t.y},{x:i,y:s})}}return n}(o,s,d));break;case A.Bottom:r.push(...function(t,e,i){if(t.x===e.x||t.y===e.y)return[];const n=[];let o,s;switch(i){case A.Up:if(o=t.x,s=e.y,e.y<t.y)o=t.x+(e.x-t.x)/2,n.push({x:o,y:t.y},{x:o,y:e.y});else{const i=(t.y+e.y)/2;n.push({x:o,y:i},{x:e.x,y:i})}break;case A.Right:o=e.x,s=t.y,e.x<t.x&&e.y>t.y&&(o=t.x,s=e.y),n.push({x:o,y:s});break;case A.Bottom:t.y>e.y?(o=e.x,s=t.y):(o=t.x,s=e.y),n.push({x:o,y:s});break;case A.Left:o=e.x,s=t.y,e.x>t.x&&e.y>t.y&&(o=t.x,s=e.y),n.push({x:o,y:s});break;default:if(o=t.x,e.y<t.y+Rn)o=t.x+(e.x-t.x)/2,n.push({x:o,y:t.y},{x:o,y:e.y});else{const i=(t.y+e.y-Rn)/2;n.push({x:o,y:i},{x:e.x,y:i})}}return n}(o,s,d));break;case A.Left:r.push(...function(t,e,i){if(t.x===e.x||t.y===e.y)return[];const n=[];let o,s;switch(i){case A.Up:o=t.x,s=e.y,e.x<t.x&&e.y>t.y&&(o=e.x,s=t.y),n.push({x:o,y:s});break;case A.Bottom:o=t.x,s=e.y,e.x<t.x&&e.y<t.y&&(o=e.x,s=t.y),n.push({x:o,y:s});break;case A.Right:if(o=t.x,s=e.y,e.x>t.x)o=e.x,s=t.y+(e.y-t.y)/2,n.push({x:t.x,y:s},{x:e.x,y:s});else{const i=(t.x+e.x)/2;n.push({x:i,y:t.y},{x:i,y:e.y})}break;case A.Left:e.x>t.x?n.push({x:t.x,y:e.y}):n.push({x:e.x,y:t.y});break;default:if(o=t.x,s=e.y,e.x<t.x-Rn){const i=(t.x+e.x+Rn)/2;n.push({x:i,y:t.y},{x:i,y:s})}else n.push({x:t.x,y:s})}return n}(o,s,d));break;default:r.push(...function(t,e,i){const n=[];null==t.calculative.drawlineH&&(t.calculative.drawlineH=Math.abs(i.x-e.x)>Math.abs(i.y-e.y));let o=t.calculative.worldAnchors.findIndex(t=>t.id==e.id);if(o>1){let s=t.calculative.worldAnchors[o-1];if(s.x===e.x&&s.y!==e.y)return n.push({x:i.x,y:e.y}),n;if(s.y===e.y&&s.x!==e.x)return n.push({x:e.x,y:i.y}),n}return t.calculative.worldAnchors.length&&(i.isTemp=void 0,t.calculative.drawlineH?(n.push({x:i.x,y:e.y}),Math.abs(i.y-e.y)<Rn&&(i.isTemp=!0)):(n.push({x:e.x,y:i.y}),Math.abs(i.x-e.x)<Rn&&(i.isTemp=!0))),n}(e,o,s))}if(r.forEach(t=>{t.id=Ct(),t.penId=e.id,e.calculative.worldAnchors.push(t)}),e.calculative.worldAnchors.push(s),p&&e.calculative.worldAnchors.push(p),u&&e.calculative.worldAnchors.push(f),n&&e.calculative.worldAnchors.reverse(),a){const t=e.calculative.worldAnchors.length-2;e.calculative.worldAnchors[t].isTemp=!1,e.calculative.worldAnchors[1].isTemp=!1}}function Pn(t,e,i){const n={x:t.x,y:t.y,id:Ct()};switch(e){case A.Up:n.y-=i;break;case A.Right:n.x+=i;break;case A.Bottom:n.y+=i;break;case A.Left:n.x-=i;break;default:return}return n}function In(t,e,i=!0){let n=t.calculative.worldAnchors;i||(n=[],t.calculative.worldAnchors.forEach(t=>{n.unshift(t)}));for(let t=0;t<n.length&&n[t].id!==e.id;t++){if(n[t].y!==e.y)return!1;if(n[t].x===n[t+1]?.x&&n[t].y!==n[t+1]?.y)return!1}return!0}function En(t,e,i=!0){let n=t.calculative.worldAnchors;i||(n=[],t.calculative.worldAnchors.forEach(t=>{n.unshift(t)}));for(let t=0;t<n.length&&n[t].id!==e.id;t++){if(n[t].x!==e.x)return!1;if(n[t].y===n[t+1]?.y&&n[t].x!==n[t+1]?.x)return!1}return!0}function _n(t,e,i,n){const o=[];let s,a,r,l,c,h,d,u,f,p,v,g,y,m;f=t[i],p=t[n],r=f.x,l=f.y,d=p.x-r,u=p.y-l,m=d*d+u*u,s=e;for(let e=i+1;e<n;e++)v=t[e],0!==d||0!==u?(g=((v.x-r)*d+(v.y-l)*u)/m,g>1?(c=v.x-p.x,h=v.y-p.y):g>0?(c=v.x-(r+d*g),h=v.y-(l+u*g)):(c=v.x-r,h=v.y-l)):(c=v.x-r,h=v.y-l),y=c*c+h*h,y>s&&(a=e,s=y);return s>e&&(a-i>1&&o.push(..._n(t,e,i,a)),o.push({id:t[a].id,penId:t[a].penId,x:t[a].x,y:t[a].y}),n-a>1&&o.push(..._n(t,e,a,n))),o}function Mn(t,e){const i=e||new Path2D,n=t.calculative.worldAnchors;let o=t.calculative.canvas.store.data.scale,s=(t.calculative.animateLineWidth||6)*o,a=(2*t.animateLineWidth||12)*o;t.lineAnimateType===v.WaterDrop&&(a=(4*t.animateLineWidth||24)*o);let r=(t.animateInterval||100)*o,l=t.calculative.lineWidth*(t.calculative.lineSmooth||0),c=(t.calculative.animateLineWidth/2||3)*o;if(t.animateReverse&&(a=-a,s=-s),n.length>1){let e,o=0;for(let h=0;h<n.length;h++){let d=n[h];if(e){let n=Ln(e,d),h={x:e.x+(t.calculative.animatePos-o)%r*Math.cos(n*Math.PI/180),y:e.y-(t.calculative.animatePos-o)%r*Math.sin(n*Math.PI/180)};t.animateReverse&&(h={x:e.x+(t.length-(t.calculative.animatePos+o))%r*Math.cos(n*Math.PI/180),y:e.y-(t.length-(t.calculative.animatePos+o))%r*Math.sin(n*Math.PI/180)});let u=Math.sqrt((h.x-e.x)**2+(h.y-e.y)**2),f=Math.sqrt((d.x-e.x)**2+(d.y-e.y)**2);for(;u<f;)(t.animateReverse&&u-a<f||!t.animateReverse&&u>a)&&u>l+a&&f-u>l&&(t.lineAnimateType===v.Arrow?On(i,h,s,n,c,a):t.lineAnimateType===v.WaterDrop&&Bn(i,h,t.animateReverse,n,c,a)),h.x+=r*Math.cos(n*Math.PI/180),h.y-=r*Math.sin(n*Math.PI/180),u=Math.sqrt((h.x-e.x)**2+(h.y-e.y)**2)}e=d}}if(i instanceof Path2D)return i}function Ln(t,e){let i=e.x-t.x,n=e.y-t.y,o=180*Math.atan(n/i)/Math.PI;return o=e.x>=t.x?-o:180-o,o}function Dn(t,e,i){let n=(180-i)*Math.PI/180;return{x:(t.x-e.x)*Math.cos(n)-(t.y-e.y)*Math.sin(n)+e.x,y:(t.x-e.x)*Math.sin(n)+(t.y-e.y)*Math.cos(n)+e.y}}function On(t,e,i,n,o,s){let a=Dn({x:e.x+i,y:e.y+.57*i},{x:e.x,y:e.y},n),r=Dn({x:e.x+i,y:e.y-.57*i},{x:e.x,y:e.y},n),l=Dn({x:e.x+i,y:e.y+o/2},{x:e.x,y:e.y},n),c=Dn({x:e.x+s,y:e.y+o/2},{x:e.x,y:e.y},n),h=Dn({x:e.x+i,y:e.y-o/2},{x:e.x,y:e.y},n),d=Dn({x:e.x+s,y:e.y-o/2},{x:e.x,y:e.y},n);t.moveTo(a.x,a.y),t.lineTo(e.x,e.y),t.lineTo(r.x,r.y),t.lineTo(h.x,h.y),t.lineTo(d.x,d.y),t.lineTo(c.x,c.y),t.lineTo(l.x,l.y),t.lineTo(a.x,a.y)}function Bn(t,e,i,n,o,s){let a=o/2;i&&(a=-o/2);let r=Dn({x:e.x,y:e.y+a},{x:e.x,y:e.y},n),l=Dn({x:e.x+s,y:e.y},{x:e.x,y:e.y},n),c=Math.PI/2;i&&(c=-Math.PI/2),t.moveTo(e.x,e.y),t.arc(e.x,e.y,o/2,-c-n/180*Math.PI,c-n/180*Math.PI,!1),t.lineTo(l.x,l.y),t.lineTo(r.x,r.y)}function Nn(t){t.onDestroy||(t.onDestroy=Fn,t.onMove=zn,t.onResize=zn,t.onRotate=zn,t.onValue=zn,t.onMouseMove=Hn,t.onBeforeValue=jn,t.onRenderPenRaw=qn),t.calculative.singleton||(t.calculative.singleton={});const e=t.calculative.worldRect;if(!t.calculative.singleton.div){const i=document.createElement("div");i.style.position="absolute",i.style.outline="none",i.style.left="-9999px",i.style.top="-9999px",i.style.width=e.width+"px",i.style.height=e.height+"px",document.body.appendChild(i),t.calculative.canvas.externalElements?.parentElement.appendChild(i),ti(t,i),t.calculative.singleton.div=i;const n=document.createElement("iframe");n.style.width="100%",n.style.height="100%",n.scrolling=t.scrolling||"no",n.frameBorder="0",n.style.border="none",n.src=t.iframe,t.calculative.iframe=t.iframe,i.appendChild(n),Vn(t),n.onload=()=>{n.setAttribute("document.domain","")}}return t.calculative.patchFlags&&ti(t,t.calculative.singleton.div),t.onRenderPenRaw(t),new Path2D}function Fn(t){Un(t),t.calculative.singleton&&t.calculative.singleton.div&&(t.calculative.singleton.div.remove(),delete t.calculative.singleton.div)}function zn(t){t.calculative.singleton.div&&ti(t,t.calculative.singleton.div)}function jn(t,e){if(e.iframe&&t.calculative.singleton.div&&(t.calculative.singleton.div.children[0].src=e.iframe,t.calculative.iframe=e.iframe),e.operationalRect||void 0!==e["operationalRect.x"]||void 0!==e["operationalRect.y"]||void 0!==e["operationalRect.width"]||void 0!==e["operationalRect.height"]){t.operationalRect||(t.operationalRect={});let i=dt(e);i.operationalRect||(i.operationalRect={}),void 0!==i["operationalRect.x"]&&(i.operationalRect.x=i["operationalRect.x"]),void 0!==i["operationalRect.y"]&&(i.operationalRect.y=i["operationalRect.y"]),void 0!==i["operationalRect.width"]&&(i.operationalRect.width=i["operationalRect.width"]),void 0!==i["operationalRect.height"]&&(i.operationalRect.height=i["operationalRect.height"]),Object.assign(t.operationalRect,i.operationalRect),t.calculative.singleton.div&&(1===t.calculative.singleton.div.children.length?Vn(t):(t.calculative.singleton.div.children[1].style.height=100*t.operationalRect.y+"%",t.calculative.singleton.div.children[1].style.left=100*t.operationalRect.x+"%",t.calculative.singleton.div.children[1].style.width=100*t.operationalRect.width+"%",t.calculative.singleton.div.children[2].style.width=100*(1-t.operationalRect.x-t.operationalRect.width)+"%",t.calculative.singleton.div.children[3].style.height=100*(1-t.operationalRect.y-t.operationalRect.height)+"%",t.calculative.singleton.div.children[3].style.left=100*t.operationalRect.x+"%",t.calculative.singleton.div.children[3].style.width=100*t.operationalRect.width+"%",t.calculative.singleton.div.children[4].style.width=100*t.operationalRect.x+"%"))}if(void 0!==e.blur)for(let i=1;i<5;i++)t.calculative.singleton.div.children[i].style["backdrop-filter"]=`blur(${e.blur||2}px)`;if(void 0!==e.blurBackground)for(let i=1;i<5;i++)t.calculative.singleton.div.children[i].style.backgroundColor=e.blurBackground;return e}function Hn(t,e){if((t.calculative.canvas.store.data.locked||t.locked)&&Wn(t.operationalRect)&&t.calculative.zIndex<5&&e.x>t.x+t.width*t.operationalRect.x&&e.x<t.x+t.width*(t.operationalRect.x+t.operationalRect.width)&&e.y>t.y+t.height*t.operationalRect.y&&e.y<t.y+t.height*(t.operationalRect.y+t.operationalRect.height)&&t.calculative.singleton.div){let e=t.calculative.singleton.div.parentNode.children;for(let t=0;t<6;t++)e[t].style.pointerEvents="none"}}function Wn(t){return!(!t||!t.width||!t.height||(void 0===t.x&&(t.x=(1-t.width)/2),void 0===t.y&&(t.y=(1-t.height)/2),0))}function Vn(t){if(!Wn(t.operationalRect))return;const e=t.calculative.singleton.div;if(!e)return;const i=document.createElement("div");i.style.position="absolute",i.style.left=100*t.operationalRect.x+"%",i.style.top="0px",i.style.width=100*t.operationalRect.width+"%",i.style.height=100*t.operationalRect.y+"%",i.style["backdrop-filter"]=`blur(${t.blur||2}px)`,i.style.backgroundColor=t.blurBackground,e.appendChild(i);const n=document.createElement("div");n.style.position="absolute",n.style.right="0px",n.style.top="0px",n.style.width=100*(1-t.operationalRect.x-t.operationalRect.width)+"%",n.style.height="100%",n.style["backdrop-filter"]=`blur(${t.blur||2}px)`,n.style.backgroundColor=t.blurBackground,e.appendChild(n);const o=document.createElement("div");o.style.position="absolute",o.style.left=100*t.operationalRect.x+"%",o.style.bottom="0px",o.style.width=100*t.operationalRect.width+"%",o.style.height=100*(1-t.operationalRect.y-t.operationalRect.height)+"%",o.style["backdrop-filter"]=`blur(${t.blur||2}px)`,o.style.backgroundColor=t.blurBackground,e.appendChild(o);const s=document.createElement("div");s.style.position="absolute",s.style.left="0px",s.style.top="0px",s.style.width=100*t.operationalRect.x+"%",s.style.height="100%",s.style["backdrop-filter"]=`blur(${t.blur||2}px)`,s.style.backgroundColor=t.blurBackground,e.appendChild(s);let a=()=>{Un(t)};i.onmouseenter=a,o.onmouseenter=a,n.onmouseenter=a,s.onmouseenter=a,e.onmouseleave=a}function Un(t){if((t.calculative.canvas.store.data.locked||t.locked)&&t.calculative.zIndex<5){let e=t.calculative.singleton.div.parentNode.children;for(let t=1;t<6;t++)e[t].style.pointerEvents="initial"}}function qn(t){if(t.thumbImg&&!t.calculative.img){const e=new Image;e.crossOrigin="undefined"===t.crossOrigin?void 0:t.crossOrigin||"anonymous",t.calculative.canvas.store.options.cdn&&!(t.thumbImg.startsWith("http")||t.thumbImg.startsWith("//")||t.thumbImg.startsWith("data:image"))?e.src=t.calculative.canvas.store.options.cdn+t.thumbImg:e.src=t.thumbImg,e.onerror=i=>{e.remove(),t.calculative.img=void 0},t.calculative.img=e}}const $n={},Kn=['<svg viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg"><path d="M473.088 125.44L256 256H52.224C23.552 256 0 279.552 0 308.224V716.8c0 28.16 23.04 51.2 51.2 51.2h204.8l217.088 130.56c16.896 10.24 38.912-2.048 38.912-22.016V147.456c0-19.968-21.504-32.256-38.912-22.016zM699.904 320.512c-20.992-18.944-53.248-17.408-72.192 3.584-18.944 20.992-17.408 53.248 3.584 72.192 0.512 0.512 58.368 54.784 58.368 121.344 0 37.888-19.456 74.752-58.368 110.08-20.992 18.944-22.528 51.2-3.584 72.192 10.24 11.264 24.064 16.896 37.888 16.896 12.288 0 24.576-4.608 34.304-13.312 61.44-55.296 92.16-117.76 92.16-185.856 0-112.64-88.576-193.536-92.16-197.12z" fill="" p-id="2434"></path><path d="M853.504 166.4c-20.992-18.944-53.248-16.896-72.192 4.096-18.944 20.992-16.896 53.248 4.096 72.192 1.536 1.024 135.68 122.88 135.68 280.576 0 90.624-45.568 177.152-135.68 257.536-20.992 18.944-23.04 51.2-4.096 72.192 10.24 11.264 24.064 16.896 38.4 16.896 12.288 0 24.576-4.096 34.304-12.8 112.64-100.864 169.984-212.992 169.984-333.824-1.024-202.752-163.84-350.208-170.496-356.864z"></path></svg>','<svg viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" ><path d="M256 768H51.2c-28.16 0-51.2-23.04-51.2-51.2V308.224C0 279.552 23.552 256 52.224 256H256v512zM512 147.456v728.576c0 19.968-21.504 32.256-38.912 22.016L256 768V256l217.088-130.56c17.408-10.24 38.912 2.048 38.912 22.016zM623.104 656.896c-19.968-19.968-19.968-52.224 0-72.192l217.088-217.088c19.968-19.968 52.224-19.968 72.192 0 19.968 19.968 19.968 52.224 0 72.192l-217.088 217.088c-19.456 19.968-52.224 19.968-72.192 0z" fill="" p-id="2582"></path><path d="M623.104 367.104c19.968-19.968 52.224-19.968 72.192 0l217.088 217.088c19.968 19.968 19.968 52.224 0 72.192-19.968 19.968-52.224 19.968-72.192 0l-217.088-217.088c-19.968-19.456-19.968-52.224 0-72.192z"></path></svg>'];function Yn(t){if(t.onDestroy||(t.onDestroy=Xn,t.onMove=Gn,t.onResize=Gn,t.onRotate=Gn,t.onClick=Jn,t.onValue=to,t.onChangeId=Zn),$n[t.id])t.video&&t.calculative.media&&t.video!==t.calculative.video?(console.warn("video , "),t.calculative.media.src=t.video,t.autoPlay&&(t.calculative.media.muted=!0,t.calculative.media.autoplay=!0),t.calculative.media.loop=t.playLoop,t.calculative.video=t.video):t.audio&&t.calculative.media&&t.audio!==t.calculative.audio&&(t.calculative.media.src=t.audio,t.autoPlay&&(t.calculative.media.muted=!0,t.calculative.media.autoplay=!0),t.calculative.media.loop=t.playLoop,t.calculative.audio=t.audio);else{const e=document.createElement("div"),i=document.createElement("div");i.style.position="absolute",i.style.outline="none",i.style.left="0",i.style.bottom="0",i.style.width="0",i.style.height="2px",i.style.background="#52c41a",i.style.zIndex="1",t.hideProgress&&(i.style.display="none");const n=document.createElement("div");let o;n.innerHTML=Kn[1],n.style.position="absolute",n.style.right="0",n.style.bottom="0",n.style.width="20px",n.style.height="20px",n.style.fill="hsla(0, 0%, 100%, .8)",n.style.zIndex="1",n.style.display="none",e.appendChild(i),e.appendChild(n),n.onclick=e=>{e.stopPropagation(),t.calculative.media.muted?(n.innerHTML=Kn[0],t.calculative.media.muted=!1):(n.innerHTML=Kn[1],t.calculative.media.muted=!0)},t.calculative.singleton||(t.calculative.singleton={}),t.calculative.singleton.muted=n,e.onmouseenter=e=>{t.hideMuted||(n.style.display="block")},e.onmouseleave=t=>{n.style.display="none"},e.onclick=e=>{e.stopPropagation(),Jn(t)},t.audio?(o=document.createElement("audio"),o.controls=t.controls,o.src=t.audio):(o=document.createElement("video"),o.src=t.video),o.loop=t.playLoop,o.ontimeupdate=()=>{Qn(i,o,t.calculative.worldRect.width)},o.onended=()=>{t.calculative.onended&&t.calculative.onended(t)},t.calculative.media=o,o.style.position="absolute",o.style.outline="none",o.style.left="0",o.style.top="0",o.style.width="100%",o.style.height="100%",o.style.objectFit=t.objectFit||"contain",e.appendChild(o),$n[t.id]=e,t.calculative.canvas.externalElements?.parentElement.appendChild(e),ti(t,e),t.autoPlay&&(o.autoplay=!0,o.muted=!0)}return t.calculative.patchFlags&&ti(t,$n[t.id]),new Path2D}function Xn(t){$n[t.id].onclick=null,$n[t.id].remove(),$n[t.id]=void 0}function Gn(t){ti(t,$n[t.id]),Qn($n[t.id].children[0],$n[t.id].children[1],t.calculative.worldRect.width)}function Jn(t){t.calculative.media&&(t.calculative.media.muted=!1,t.calculative.singleton.muted.innerHTML=Kn[0],t.calculative.media.paused?t.calculative.media.play():t.calculative.media.pause())}function Qn(t,e,i){t.style.width=e.currentTime/e.duration*i+"px"}function Zn(t,e,i){$n[e]&&($n[i]=$n[e],delete $n[e])}function to(t){const e=$n[t.id];if(!e)return;ti(t,e),t.calculative.media||(t.calculative.media=e.querySelector("video"));const i=t.calculative.media.getAttribute("src");t.video?i!==t.video&&(t.calculative.media.src=t.video):t.audio&&i!==t.audio&&(t.calculative.media.src=t.audio),t.autoPlay&&(t.calculative.media.muted=!0,t.calculative.media.autoplay=!0),t.calculative.media.loop=t.playLoop}function eo(){try{const t=new OffscreenCanvas(0,0),e=t.getContext("2d");return e&&e.arc?t:document.createElement("canvas")}catch(t){return document.createElement("canvas")}}class io{parentElement;store;box;text;arrowUp;arrowDown;x;y;currentPen;constructor(t,e){let i;this.parentElement=t,this.store=e,this.box=document.createElement("div"),this.text=document.createElement("div"),this.arrowUp=document.createElement("div"),this.arrowDown=document.createElement("div"),this.box.className="meta2d-tooltip",this.text.className="text",this.arrowUp.className="arrow",this.arrowDown.className="arrow down",this.box.appendChild(this.text),this.box.appendChild(this.arrowUp),this.box.appendChild(this.arrowDown),t.appendChild(this.box),this.box.onmouseleave=()=>{this.hide(),this.store.lastHover=void 0};for(let t=0;t<document.styleSheets.length;t++)"le5le.com/tooltip"===document.styleSheets[t].title&&(i=document.styleSheets[t]);if(!i){let t=document.createElement("style");t.type="text/css",t.title="le5le.com/tooltip",document.head.appendChild(t),t=document.createElement("style"),t.type="text/css",document.head.appendChild(t),i=t.sheet,i.insertRule(".meta2d-tooltip{position:absolute;padding:8px 0;z-index:10;left: -9999px;top: -9999px;}"),i.insertRule(".meta2d-tooltip .text{max-width:320px;min-height:30px;max-height:400px;outline:none;padding:8px 16px;border-radius:4px;background:#777777;color:#ffffff;line-height:1.8;overflow-y:auto;}"),i.insertRule(".meta2d-tooltip .arrow{position:absolute;border:10px solid transparent;background:transparent;top:-5px;left:50%;transform:translateX(-50%)}"),i.insertRule(".meta2d-tooltip .arrow.down{top:initial;bottom: -1px;}")}}static getTitle(t){if(t.titleFnJs&&!t.titleFn)try{t.titleFn=new Function("pen",t.titleFnJs)}catch(t){console.log("titleFnJs",t)}return t.titleFn?t.titleFn(t):String(t.title)}setText(t){const e=this.box.getBoundingClientRect();let i=globalThis.marked;const n=io.getTitle(t);if(i){this.text.innerHTML=i(n);const t=this.text.getElementsByTagName("A");for(let e=0;e<t.length;++e)t[e].setAttribute("target","_blank")}else this.text.innerHTML=n;return e}updateText(t){if(this.currentPen?.id!==t.id)return;if(io.titleEmpty(t))return;const e=this.setText(t),i=this.box.getBoundingClientRect();this.changePositionByText(e,i)}changePositionByText(t,e){this.x-=(e.width-t.width)/2,this.y-=e.height-t.height,this.box.style.left=this.x+"px",this.box.style.top=this.y+"px"}static titleEmpty(t){return!t.title&&!t.titleFn&&!t.titleFnJs}show(t,e){if(this.currentPen=t,io.titleEmpty(t)){let i=Vt(t,!0);return void(i&&this.show(i,e))}this.setText(t);const i=this.box.getBoundingClientRect(),n=t.calculative.worldRect;let o=t.calculative.canvas.store.data.x+e.x-i.width/2,s=t.calculative.canvas.store.data.y+e.y-i.height;t.type||(o=t.calculative.canvas.store.data.x+n.x-(i.width-n.width)/2,s=t.calculative.canvas.store.data.y+n.ey-i.height-n.height),s>0?(this.arrowUp.style.borderBottomColor="transparent",this.arrowDown.style.borderTopColor="#777777"):(s+=i.height+n.height+5,this.arrowUp.style.borderBottomColor="#777777",this.arrowDown.style.borderTopColor="transparent"),this.x=o,this.y=s,this.box.style.left=this.x+"px",this.box.style.top=this.y+"px"}hide(){this.currentPen=null,this.x=-9999,this.box.style.left="-9999px"}translate(t,e){this.x<-1e3||(this.x+=t,this.y+=e,this.box.style.left=this.x+"px",this.box.style.top=this.y+"px")}destroy(){this.box.onmouseleave=null}}class no{parent;h;v;isDownH;isDownV;x;y;hSize;vSize;scrollX;scrollY;lastScrollX;lastScrollY;rect;isShow;pageMode;constructor(t){let e;this.parent=t,this.h=document.createElement("div"),this.v=document.createElement("div"),this.parent.externalElements.appendChild(this.h),this.parent.externalElements.appendChild(this.v),this.h.className="meta2d-scroll h",this.h.onmousedown=this.onMouseDownH,this.v.className="meta2d-scroll v",this.v.onmousedown=this.onMouseDownV,document.addEventListener("mousemove",this.onMouseMove),document.addEventListener("mouseup",this.onMouseUp);for(let t=0;t<document.styleSheets.length;t++)"le5le/scroll"===document.styleSheets[t].title&&(e=document.styleSheets[t]);if(!e){let t=document.createElement("style");t.type="text/css",t.title="le5le.com/scroll",document.head.appendChild(t),t=document.createElement("style"),t.type="text/css",document.head.appendChild(t),e=t.sheet,e.insertRule(".meta2d-scroll{position:absolute;width:8px;height:200px;background:#dddddd;border-radius:10px;z-index:20;cursor:default;}"),e.insertRule(".meta2d-scroll:hover{background:#cccccc;cursor:pointer}"),e.insertRule(".meta2d-scroll.v{right:0;top:calc(50% - 100px);}"),e.insertRule(".meta2d-scroll.h{bottom:2px;left:calc(50% - 100px);width:200px;height:8px;}")}this.init()}init(){this.isShow=!0,this.resize(),this.initPos()}onMouseDownH=t=>{t.preventDefault(),t.stopPropagation(),this.isDownH=t.x,this.x=this.parent.store.data.x||0,this.lastScrollX=this.scrollX};onMouseDownV=t=>{t.preventDefault(),t.stopPropagation(),this.isDownV=t.y,this.y=this.parent.store.data.y||0,this.lastScrollY=this.scrollY};onMouseMove=t=>{if(this.isDownH){const e=t.x-this.isDownH;this.scrollX=this.lastScrollX+e,this.h.style.left=`${this.scrollX}px`,this.parent.store.data.x=this.x-e*this.rect.width/this.parent.parentElement.clientWidth}if(this.isDownV){const e=t.y-this.isDownV;if(this.pageMode&&this.canMouseMove(e))return;this.scrollY=this.lastScrollY+e,this.v.style.top=`${this.scrollY}px`,this.parent.store.data.y=this.y-e*this.rect.height/this.parent.parentElement.clientHeight}(this.isDownH||this.isDownV)&&(this.parent.onMovePens(),this.parent.canvasTemplate.init(),this.parent.canvasImage.init(),this.parent.canvasImageBottom.init(),this.parent.render())};onMouseUp=t=>{(this.isDownH||this.isDownV)&&(this.isDownH=void 0,this.isDownV=void 0,this.scrollX<20?(this.scrollX=20,this.h.style.left=`${this.scrollX}px`):this.scrollX>this.parent.parentElement.clientWidth-this.hSize-20&&(this.scrollX=this.parent.parentElement.clientWidth-this.hSize-20,this.h.style.left=`${this.scrollX}px`),this.scrollY<20?(this.scrollY=20,this.v.style.top=`${this.scrollY}px`):this.scrollY>this.parent.parentElement.clientHeight-this.vSize-20&&(this.scrollY=this.parent.parentElement.clientHeight-this.vSize-20,this.v.style.top=`${this.scrollY}px`),this.resize())};canMouseMove(t){const e=this.parent.parent.getRect();return t<0&&e.y+this.parent.store.data.y>=0||t>0&&e.ey-this.parent.height+this.parent.store.data.y<=0}changeMode(){this.pageMode=!0,this.h.style.display="none",this.parent.parent.getRect().height<this.parent.height&&(this.v.style.display="none")}initPos(){this.scrollX=(this.parent.parentElement.clientWidth-this.hSize)/2,this.scrollY=(this.parent.parentElement.clientHeight-this.vSize)/2,this.h.style.left=`${this.scrollX}px`,this.v.style.top=`${this.scrollY}px`}resize(){this.rect=Oi(this.parent.store.data.pens),this.rect.width<1400&&(this.rect.width=1400),this.rect.height<900&&(this.rect.height=900),this.parent.store.data.x>0?this.rect.width+=this.parent.store.data.x+(this.rect.x>0?0:this.rect.x):this.rect.width-=this.parent.store.data.x+(this.rect.x>0?0:this.rect.x),this.parent.store.data.y>0?this.rect.height+=this.parent.store.data.y+(this.rect.y>0?0:this.rect.y):this.rect.height-=this.parent.store.data.y+(this.rect.y>0?0:this.rect.y),this.rect.width<1400&&(this.rect.width=1400),this.rect.height<900&&(this.rect.height=900),this.hSize=1e3*this.parent.parentElement.clientWidth/this.rect.width/3,this.vSize=1e3*this.parent.parentElement.clientHeight/this.rect.height/3,this.h.style.width=this.hSize+"px",this.v.style.height=this.vSize+"px"}show(){this.isShow=!0,this.h.style.display="block",this.v.style.display="block",document.addEventListener("mousemove",this.onMouseMove),document.addEventListener("mouseup",this.onMouseUp)}hide(){this.isShow=!1,this.h.style.display="none",this.v.style.display="none",this.destroy()}translate(t,e){t&&(this.scrollX-=t*this.parent.parentElement.clientWidth/this.rect.width,this.h.style.left=`${this.scrollX}px`),e&&(this.scrollY-=e*this.parent.parentElement.clientHeight/this.rect.height,this.v.style.top=`${this.scrollY}px`)}wheel(t){let e=10;t&&(e=-10),this.pageMode&&this.canMouseMove(e)||(this.scrollY+=e,this.v.style.top=`${this.scrollY}px`,this.parent.store.data.y-=e*this.rect.height/this.parent.parentElement.clientHeight,this.parent.onMovePens(),this.parent.canvasTemplate.init(),this.parent.canvasImage.init(),this.parent.canvasImageBottom.init(),this.parent.render())}destroy(){document.removeEventListener("mousemove",this.onMouseMove),document.removeEventListener("mouseup",this.onMouseUp)}}class oo{parentElement;store;isBottom;canvas=document.createElement("canvas");otherOffsreen=eo();offscreen=eo();animateOffsScreen=eo();fitOffscreen=eo();fitFlag=!1;currentFit;activeFit;constructor(t,e,i){this.parentElement=t,this.store=e,this.isBottom=i,t.appendChild(this.canvas),this.canvas.style.backgroundRepeat="no-repeat",this.canvas.style.backgroundSize="100% 100%",this.canvas.style.position="absolute",this.canvas.style.top="0",this.canvas.style.left="0"}resize(t,e){this.canvas.style.width=t+"px",this.canvas.style.height=e+"px",t=t*this.store.dpiRatio|0,e=e*this.store.dpiRatio|0,this.canvas.width=t,this.canvas.height=e,this.otherOffsreen.width=t,this.otherOffsreen.height=e,this.offscreen.width=t,this.offscreen.height=e,this.animateOffsScreen.width=t,this.animateOffsScreen.height=e,this.fitOffscreen.width=t,this.fitOffscreen.height=e,this.otherOffsreen.getContext("2d").scale(this.store.dpiRatio,this.store.dpiRatio),this.otherOffsreen.getContext("2d").textBaseline="middle",this.offscreen.getContext("2d").scale(this.store.dpiRatio,this.store.dpiRatio),this.offscreen.getContext("2d").textBaseline="middle",this.animateOffsScreen.getContext("2d").scale(this.store.dpiRatio,this.store.dpiRatio),this.animateOffsScreen.getContext("2d").textBaseline="middle",this.fitOffscreen.getContext("2d").scale(this.store.dpiRatio,this.store.dpiRatio),this.fitOffscreen.getContext("2d").textBaseline="middle",this.init()}init(){this.offscreen.getContext("2d").clearRect(0,0,this.canvas.width,this.canvas.height),this.animateOffsScreen.getContext("2d").clearRect(0,0,this.canvas.width,this.canvas.height),this.fitOffscreen.getContext("2d").clearRect(0,0,this.canvas.width,this.canvas.height);for(const t of this.store.data.pens)this.hasImage(t)&&(t.calculative.imageDrawed=!1);this.isBottom?this.store.patchFlagsBackground=!0:this.store.patchFlagsTop=!0}clear(){this.otherOffsreen.getContext("2d").clearRect(0,0,this.otherOffsreen.width,this.otherOffsreen.height),this.offscreen.getContext("2d").clearRect(0,0,this.canvas.width,this.canvas.height),this.animateOffsScreen.getContext("2d").clearRect(0,0,this.canvas.width,this.canvas.height),this.fitOffscreen.getContext("2d").clearRect(0,0,this.canvas.width,this.canvas.height),this.canvas.getContext("2d").clearRect(0,0,this.canvas.width,this.canvas.height)}hasImage(t){return t.calculative.hasImage=t.calculative&&t.calculative.inView&&(this.isBottom&&t.canvasLayer===c.CanvasImageBottom||!this.isBottom&&t.canvasLayer===c.CanvasImage)&&t.image&&t.calculative.img&&"gif"!==t.name,t.calculative.hasImage}render(){let t=!1,e=!1;for(const i of this.store.data.pens)this.hasImage(i)&&(this.store.animates.has(i)?e=!0:i.calculative.imageDrawed||(t=!0),i.parentId&&this.store.animates.has(Vt(i,!0))&&(e=!0));const i=this.store.patchFlagsBackground,n=this.store.patchFlagsTop;if(n&&!this.isBottom){const t=this.otherOffsreen.getContext("2d");t.clearRect(0,0,this.canvas.width,this.canvas.height),this.renderRule(t)}if(this.store.patchFlagsLast&&this.offscreen.getContext("2d").clearRect(0,0,this.canvas.width,this.canvas.height),t){const t=this.offscreen.getContext("2d");t.save(),t.clearRect(0,0,this.canvas.width,this.canvas.height),t.translate(this.store.data.x,this.store.data.y);for(const e of this.store.data.pens)!e.calculative.hasImage||this.store.animates.has(e)||this.store.animates.has(Vt(e,!0))||e.canvasLayer!==c.CanvasTemplate&&(e.calculative.imageDrawed=!0,t.save(),fe(t,e),(e.rotateByRoot||e.calculative.rotate)&&pe(t,e),ci(t,e),ae(t,e),t.restore());t.restore()}if(e){const t=this.animateOffsScreen.getContext("2d");t.save(),t.clearRect(0,0,this.canvas.width,this.canvas.height),t.translate(this.store.data.x,this.store.data.y);for(const e of this.store.animates)e.calculative.hasImage&&e.canvasLayer!==c.CanvasTemplate&&!1!==e.visible&&!1!==e.calculative.visible&&(e.calculative.imageDrawed=!0,t.save(),fe(t,e),(e.rotateByRoot||e.calculative.rotate)&&pe(t,e),ci(t,e),ae(t,e),t.restore());for(const e of this.store.data.pens)e.calculative.hasImage&&e.parentId&&e.canvasLayer!==c.CanvasTemplate&&!1!==e.visible&&!1!==e.calculative.visible&&this.store.animates.has(Vt(e,!0))&&(e.calculative.imageDrawed=!0,t.save(),fe(t,e),(e.rotateByRoot||e.calculative.rotate)&&pe(t,e),ci(t,e),ae(t,e),t.restore());t.restore()}if(!this.isBottom&&!this.store.data.locked&&this.fitFlag){const t=(this.store.data.width||this.store.options.width)*this.store.data.scale,e=(this.store.data.height||this.store.options.height)*this.store.data.scale,i=this.store.data.origin.x+this.store.data.x||this.store.options.x||0,n=this.store.data.origin.y+this.store.data.y||this.store.options.y||0,o=this.fitOffscreen.getContext("2d");o.save(),o.clearRect(0,0,this.canvas.width,this.canvas.height),o.fillStyle="#ffffff66",o.strokeStyle=this.store.styles.activeColor,this.store.data.fits?.forEach((s,a)=>{o.fillRect(i+t*s.x,n+e*s.y,t*s.width,e*s.height),s.active&&o.strokeRect(i+t*s.x,n+e*s.y,t*s.width,e*s.height)}),o.restore()}if(t||e||i&&this.isBottom||n&&!this.isBottom){const t=this.canvas.getContext("2d");t.clearRect(0,0,this.canvas.width,this.canvas.height),this.isBottom&&(this.store.patchFlagsBackground=!1),t.drawImage(this.offscreen,0,0,this.canvas.width,this.canvas.height),t.drawImage(this.animateOffsScreen,0,0,this.canvas.width,this.canvas.height),this.isBottom||(t.drawImage(this.otherOffsreen,0,0,this.canvas.width,this.canvas.height),this.store.patchFlagsTop=!1,!this.store.data.locked&&this.fitFlag&&t.drawImage(this.fitOffscreen,0,0,this.canvas.width,this.canvas.height))}}renderRule(t){const{data:e,options:i}=this.store,{rule:n,ruleColor:o,scale:s,origin:a}=e;if(!(n??i.rule))return;const r=10*s;t.save();const l=o||i.ruleColor||"#ccc";t.strokeStyle=mt(l,.7);const c=a.x+e.x,h=a.y+e.y,{width:d,height:u}=this.canvas;let f=i.ruleOptions?.height||20;i.ruleOptions?.background&&(t.beginPath(),t.fillStyle=i.ruleOptions?.background,t.rect(0,0,d,f),t.fill(),t.rect(0,0,f,u),t.fill()),i.ruleOptions?.underline&&(t.beginPath(),t.fillStyle=mt(l,.7),t.moveTo(0,f),t.lineTo(d,f),t.stroke(),t.moveTo(f,0),t.lineTo(f,u),t.stroke());let p=f/4;"bottom"===i.ruleOptions?.baseline&&(p=3*f/4),t.beginPath(),t.lineWidth=f/2,t.lineDashOffset=-c%r,t.setLineDash([1,r-1]),t.moveTo(0,p),t.lineTo(d,p),t.stroke(),t.beginPath(),t.lineDashOffset=-h%r,t.moveTo(p,0),t.lineTo(p,u),t.stroke(),t.strokeStyle=l,t.beginPath(),t.lineWidth=f,t.lineDashOffset=-c%(10*r),t.setLineDash([1,10*r-1]),t.moveTo(0,f/2),t.lineTo(d,f/2),t.stroke(),t.beginPath(),t.lineDashOffset=-h%(10*r),t.moveTo(f/2,0),t.lineTo(f/2,u),t.stroke(),t.beginPath(),t.fillStyle=i.ruleOptions?.textColor||t.strokeStyle;let v=0-100*Math.floor(c/r/10),g=i.ruleOptions?.textTop||16,y=i.ruleOptions?.textLeft||4;c<0&&(v-=100);for(let e=c%(10*r);e<d;e+=10*r,v+=100)r<3&&v%500||t.fillText(v.toString(),e+y,g);v=0-100*Math.floor(h/r/10),h<0&&(v-=100);for(let e=h%(10*r);e<u;e+=10*r,v+=100)r<3&&v%500||(t.save(),t.beginPath(),t.translate(g,e-y),t.rotate(270*Math.PI/180),t.fillText(v.toString(),0,0),t.restore());t.restore()}}class so{parentCanvas;parentElement;store;canvas=document.createElement("canvas");magnifierScreen=eo();offscreen=eo();domOffscreen=eo();magnifierSize=300;magnifier;constructor(t,e,i){this.parentCanvas=t,this.parentElement=e,this.store=i,e.appendChild(this.canvas),this.canvas.style.backgroundRepeat="no-repeat",this.canvas.style.backgroundSize="100% 100%",this.canvas.style.position="absolute",this.canvas.style.top="0",this.canvas.style.left="0",this.canvas.style.pointerEvents="none"}resize(t,e){this.canvas.style.width=t+"px",this.canvas.style.height=e+"px",t=t*this.store.dpiRatio|0,e=e*this.store.dpiRatio|0,this.canvas.width=t,this.canvas.height=e,this.offscreen.width=t,this.offscreen.height=e,this.offscreen.getContext("2d").scale(this.store.dpiRatio,this.store.dpiRatio),this.offscreen.getContext("2d").textBaseline="middle",this.domOffscreen.width=t,this.domOffscreen.height=e,this.domOffscreen.getContext("2d").scale(this.store.dpiRatio,this.store.dpiRatio),this.domOffscreen.getContext("2d").textBaseline="middle",this.magnifierScreen.width=this.magnifierSize+5,this.magnifierScreen.height=this.magnifierSize+5}renderMagnifier(){if(!this.magnifier)return;const t=this.magnifierSize/2,e=this.magnifierSize+5,i=this.magnifierScreen.getContext("2d");i.clearRect(0,0,e,e),i.lineWidth=5,i.save(),i.translate(2.5,2.5),i.save(),i.arc(t,t,t,0,2*Math.PI,!1),i.clip(),i.translate(-t,-t),i.scale(2,2);const n=(this.parentCanvas.mousePos.x+this.store.data.x)*this.store.dpiRatio,o=(this.parentCanvas.mousePos.y+this.store.data.y)*this.store.dpiRatio;[this.parentCanvas.canvasTemplate.bgOffscreen,this.parentCanvas.canvasTemplate.offscreen,this.parentCanvas.canvasImageBottom.offscreen,this.parentCanvas.canvasImageBottom.animateOffsScreen,this.parentCanvas.offscreen,this.parentCanvas.canvasImage.offscreen,this.parentCanvas.canvasImage.animateOffsScreen,this.domOffscreen].forEach(e=>{i.drawImage(e,n-t,o-t,this.magnifierSize,this.magnifierSize,0,0,this.magnifierSize,this.magnifierSize)}),i.restore(),i.beginPath();const s=i.createRadialGradient(t,t,t-5,t,t,t);s.addColorStop(0,"rgba(0,0,0,0.2)"),s.addColorStop(.8,"rgb(200,200,200)"),s.addColorStop(.9,"rgb(200,200,200)"),s.addColorStop(1,"rgba(200,200,200,0.9)"),i.strokeStyle=s,i.arc(t,t,t,0,2*Math.PI,!1),i.stroke(),i.restore(),this.offscreen.getContext("2d").drawImage(this.magnifierScreen,0,0,this.magnifierSize+5,this.magnifierSize+5,(n-t-2.5)/this.store.dpiRatio,(o-t-2.5)/this.store.dpiRatio,(this.magnifierSize+5)/this.store.dpiRatio,(this.magnifierSize+5)/this.store.dpiRatio)}updateDomOffscreen(){const t=this.domOffscreen.getContext("2d");t.clearRect(0,0,this.domOffscreen.width,this.domOffscreen.height);for(const e of this.store.data.pens)if((e.externElement||"gif"===e.name)&&e.calculative.img){t.save(),t.translate(this.store.data.x,this.store.data.y);const{x:i,y:n,width:o,height:s}=e.calculative.worldRect;t.drawImage(e.calculative.img,i,n,o,s),t.restore()}}render(){this.offscreen.getContext("2d").clearRect(0,0,this.canvas.width,this.canvas.height),this.renderMagnifier();const t=this.canvas.getContext("2d");t.clearRect(0,0,this.canvas.width,this.canvas.height),t.drawImage(this.offscreen,0,0,this.canvas.width,this.canvas.height)}}function ao(t){if(t.data.locked)throw new Error("canvas is locked")}class ro{parentElement;box;iframe;dialog;close;title;body;x;y;url;meta2dDiv;dialogMeta2d;store;data;constructor(t,e){this.parentElement=t,this.store=e,this.box=document.createElement("div"),this.dialog=document.createElement("div");let i,n=document.createElement("div");this.title=document.createElement("div"),this.close=document.createElement("span"),this.close.innerHTML='\n      <svg fill="none" viewBox="0 0 16 16" width="1em" height="1em">\n      <path\n        fill="currentColor"\n        d="M8 8.92L11.08 12l.92-.92L8.92 8 12 4.92 11.08 4 8 7.08 4.92 4 4 4.92 7.08 8 4 11.08l.92.92L8 8.92z"\n        fill-opacity="0.9"\n      ></path>\n    </svg>',this.body=document.createElement("div"),this.iframe=document.createElement("iframe"),this.iframe.setAttribute("frameborder","0"),this.meta2dDiv=document.createElement("div"),this.box.className="meta2d-dialog_mask",this.dialog.className="meta2d-dialog",this.body.className="meta2d-dialog_body",n.className="meta2d-dialog_header",this.title.className="meta2d-dialog-content",this.close.className="meta2d-dialog-close",this.meta2dDiv.className="meta2d-dialog-meta2d",n.appendChild(this.title),n.appendChild(this.close),this.body.appendChild(this.iframe),this.body.appendChild(this.meta2dDiv),this.dialog.appendChild(n),this.dialog.appendChild(this.body),this.box.appendChild(this.dialog),t.appendChild(this.box),this.dialog.onclick=t=>{t.stopPropagation()},this.box.onclick=()=>{this.hide()},this.close.onclick=()=>{this.hide()};for(let t=0;t<document.styleSheets.length;t++)"le5le.com/dialog"===document.styleSheets[t].title&&(i=document.styleSheets[t]);if(!i){let t=document.createElement("style");t.type="text/css",t.title="le5le.com/dialog",document.head.appendChild(t),t=document.createElement("style"),t.type="text/css",document.head.appendChild(t),i=t.sheet,i.insertRule(".meta2d-dialog_mask {\n        display: none;\n        position: absolute;\n        top: 0%;\n        left: 0%;\n        width: 100%;\n        height: 100%;\n        background-color: #0000006f;\n        z-index: 9999;"),i.insertRule(".meta2d-dialog_mask .meta2d-dialog {\n            position: absolute;\n            top: 15vh;\n            left: 10%;\n            width: 80%;\n            height:420px;\n            padding: 16px 20px;\n            border-radius: 9px;\n            z-index: 19999;\n            overflow: auto;\n        }"),i.insertRule(".meta2d-dialog_header {\n            display: flex;\n            position: relative;\n            z-index: 999;\n        }"),i.insertRule(".meta2d-dialog-content {\n            width: calc(100% - 20px);\n            font-weight: 600;\n            font-size: 14px;\n            color: #bdc7db;\n            padding-bottom:8px;\n        }"),i.insertRule(".meta2d-dialog-close {\n            width: 20px;\n            height: 20px;\n            line-height: 20px;\n            text-align: center;\n            color: #617b91;\n            position: absolute;\n            right:20px;\n            top:2px;\n        }"),i.insertRule(".meta2d-dialog-close svg{\n            width: 18px;\n            height: 18px;\n        }"),i.insertRule(".meta2d-dialog-close :hover{\n            cursor: pointer;\n        }"),i.insertRule(".meta2d-dialog_body{\n          width: 100%;\n          height: 100%;\n        } "),i.insertRule(".meta2d-dialog_body iframe{\n            width: 100%;\n            height: 100%;\n        }"),i.insertRule(".meta2d-dialog_body .meta2d-dialog-meta2d{\n          width: 100%;\n          height: 100%;\n          display: none;\n      }")}}async show(t,e,i,n){if(!e)return;this.data=n;const o=this.isUrl(e);let s=!1;if(o?(this.meta2dDiv.style.display="none",this.iframe.style.display="block"):(this.iframe.style.display="none",this.meta2dDiv.style.display="block"),o&&e!==this.url&&(this.iframe.setAttribute("src",e),this.url=e,s=!0),t&&(this.title.innerText=t),t?(this.dialog.style.padding="16px 20px",this.title.style.display="block",this.body.style.height="calc(100% - 30px)",this.close.style.top="2px",this.close.style.right="2px",this.body.style.background="#1e2430"):(this.dialog.style.padding="0px",this.title.style.display="none",this.body.style.height="100%",this.body.style.overflow="hidden",this.close.style.top="18px",this.close.style.right="20px",this.body.style.background="transparent"),i&&(this.dialog.style.width=i.width?i.width+"px":"80%",this.dialog.style.height=i.height?i.height+"px":"420px",this.dialog.style.top=i.y?i.y+"px":i.height?`calc( 50% - ${i.height/2}px )`:"15vh",this.dialog.style.left=i.x?i.x+"px":`calc( 50% - ${i.width?i.width/2+"px":"40%"} )`),this.iframe.onload=()=>{this.dialogMeta2d&&!o||(this.box.style.display="block")},s||this.dialogMeta2d&&!o||(this.box.style.display="block"),!o){this.meta2dDiv.style.display="block",this.dialogMeta2d||(globalThis.mainMeta2d=globalThis.meta2d,this.dialogMeta2d=new fs(this.meta2dDiv),globalThis.meta2d=globalThis.mainMeta2d);const t=await Ft(this.store,e);t&&(this.box.style.display="block",this.dialogMeta2d.clear(!0),this.dialogMeta2d.open(t,!1),this.dialogMeta2d.lock(1),this.dialogMeta2d.resize(),this.dialogMeta2d.fitView(!0,0),this.dialogMeta2d.render(!0))}}hide(){this.box.style.display="none"}isUrl(t){return!!(t.startsWith("http")||t.includes("?")||t.includes("/"))}destroy(){this.dialog.onclick=void 0,this.box.onclick=void 0,this.close.onclick=void 0,this.dialogMeta2d?.destroy(!0)}}class lo{parentElement;box;currentAnchor;constructor(t){let e;this.parentElement=t,this.box=document.createElement("div"),this.box.className="meta2d-title",t.appendChild(this.box);for(let t=0;t<document.styleSheets.length;t++)"le5le.com/title"===document.styleSheets[t].title&&(e=document.styleSheets[t]);if(!e){let t=document.createElement("style");t.type="text/css",t.title="le5le.com/title",document.head.appendChild(t),t=document.createElement("style"),t.type="text/css",document.head.appendChild(t),e=t.sheet,e.insertRule(".meta2d-title{position:absolute;padding:0;z-index:10;left: -9999px;top: -9999px;background:#fff;color:#000; cursor: crosshair;border: 1px solid black;}")}}static getTitle(t){}setText(t){this.box.innerText=t.title}updateText(t){this.currentAnchor?.id===t.id&&(lo.titleEmpty(t)||(this.setText(t),this.changePositionByAnchor(t)))}changePositionByAnchor(t){this.box.style.left=t.x+10+"px",this.box.style.top=t.y+10+"px"}static titleEmpty(t){return!t.title}show(t,e){if(lo.titleEmpty(t))return;this.currentAnchor=t,this.setText(t);let i={x:e.calculative.canvas.store.data.x+t.x,y:e.calculative.canvas.store.data.y+t.y};this.changePositionByAnchor(i)}hide(){this.box.style.left="-9999px",this.box.innerText="",this.currentAnchor=null}destroy(){this.box.onmouseleave=null}}class co{parentElement;store;canvas=document.createElement("canvas");offscreen=eo();bgOffscreen=eo();patchFlags;bgPatchFlags;fit;constructor(t,e){this.parentElement=t,this.store=e,t.appendChild(this.canvas),this.canvas.style.backgroundRepeat="no-repeat",this.canvas.style.backgroundSize="100% 100%",this.canvas.style.position="absolute",this.canvas.style.top="0",this.canvas.style.left="0"}resize(t,e){this.canvas.style.width=t+"px",this.canvas.style.height=e+"px",t=t*this.store.dpiRatio|0,e=e*this.store.dpiRatio|0,this.canvas.width=t,this.canvas.height=e,this.bgOffscreen.width=t,this.bgOffscreen.height=e,this.offscreen.width=t,this.offscreen.height=e,this.bgOffscreen.getContext("2d").scale(this.store.dpiRatio,this.store.dpiRatio),this.bgOffscreen.getContext("2d").textBaseline="middle",this.offscreen.getContext("2d").scale(this.store.dpiRatio,this.store.dpiRatio),this.offscreen.getContext("2d").textBaseline="middle",this.init()}init(){this.bgOffscreen.getContext("2d").clearRect(0,0,this.canvas.width,this.canvas.height),this.offscreen.getContext("2d").clearRect(0,0,this.canvas.width,this.canvas.height),this.patchFlags=!0,this.bgPatchFlags=!0}hidden(){this.canvas.style.display="none"}show(){this.canvas.style.display="block"}clear(){this.bgOffscreen.getContext("2d").clearRect(0,0,this.canvas.width,this.canvas.height),this.offscreen.getContext("2d").clearRect(0,0,this.canvas.width,this.canvas.height),this.canvas.getContext("2d").clearRect(0,0,this.canvas.width,this.canvas.height),this.bgPatchFlags=!0,this.patchFlags=!0}render(){if(this.bgPatchFlags){const t=this.bgOffscreen.getContext("2d");t.clearRect(0,0,this.canvas.width,this.canvas.height);const e=this.store.data.width||this.store.options.width,i=this.store.data.height||this.store.options.height,n=this.store.data.x||this.store.options.x||0,o=this.store.data.y||this.store.options.y||0,s=this.store.data.background||this.store.styles.background;s&&(t.save(),t.fillStyle=s,t.globalAlpha=this.store.data.globalAlpha??this.store.options.globalAlpha,e&&i&&!this.fit?(t.shadowOffsetX=this.store.options.shadowOffsetX,t.shadowOffsetY=this.store.options.shadowOffsetY,t.shadowBlur=this.store.options.shadowBlur,t.shadowColor=this.store.options.shadowColor,t.fillRect(this.store.data.origin.x+n,this.store.data.origin.y+o,e*this.store.data.scale,i*this.store.data.scale)):t.fillRect(0,0,this.canvas.width,this.canvas.height),t.restore()),e&&i&&this.store.bkImg&&(t.save(),this.fit?t.drawImage(this.store.bkImg,0,0,this.canvas.offsetWidth,this.canvas.offsetHeight):t.drawImage(this.store.bkImg,this.store.data.origin.x+n,this.store.data.origin.y+o,e*this.store.data.scale,i*this.store.data.scale),t.restore()),this.renderGrid(t)}if(this.patchFlags){const t=this.offscreen.getContext("2d");t.save(),t.clearRect(0,0,this.canvas.width,this.canvas.height),t.translate(this.store.data.x,this.store.data.y);for(const e of this.store.data.pens)isFinite(e.x)&&e.canvasLayer===c.CanvasTemplate&&e.calculative.inView&&(ve(t,e),e.image&&"gif"!==e.name&&e.calculative.img&&(t.save(),fe(t,e),(e.rotateByRoot||e.calculative.rotate)&&pe(t,e),ci(t,e),ae(t,e),t.restore()));t.restore()}if(this.patchFlags||this.bgPatchFlags){const t=this.canvas.getContext("2d");t.clearRect(0,0,this.canvas.width,this.canvas.height),t.drawImage(this.bgOffscreen,0,0,this.canvas.width,this.canvas.height),t.drawImage(this.offscreen,0,0,this.canvas.width,this.canvas.height),this.patchFlags=!1,this.bgPatchFlags=!1}}renderGrid(t){const{data:e,options:i}=this.store,{grid:n,gridRotate:o,gridColor:s,gridSize:a,scale:r,origin:l}=e;if(!(n??i.grid))return;t.save();const c=(e.width||i.width)*r,h=(e.height||i.height)*r,d=(e.x||i.x||0)+l.x,u=(e.y||i.y||0)+l.y;t.lineWidth=1,t.strokeStyle=s||i.gridColor,t.beginPath();let f=(a||i.gridSize)*r;if(f=f<0?0:f,c&&h)if(o){const e=o*Math.PI/180,i=e+Math.PI/2,n={x:Math.sin(e),y:-Math.cos(e)},s={x:Math.sin(i),y:-Math.cos(i)};uo(t,d,u,c,h,f,n),uo(t,d,u,c,h,f,s)}else{const e=c+d,i=h+u;for(let i=d;i<=e;i+=f)t.moveTo(i,u),t.lineTo(i,h+u);for(let e=u;e<=i;e+=f)t.moveTo(d,e),t.lineTo(c+d,e)}else{const e=this.store.dpiRatio,i=this.canvas.width/e,n=this.canvas.height/e,s=d/f,a=u/f,r=10*f,l=d-Math.ceil(s)*f,c=u-Math.ceil(a)*f,h=i+l+r,p=n+c+r;if(o){const e=o*Math.PI/180,s=e+Math.PI/2,a={x:Math.sin(e),y:-Math.cos(e)},r={x:Math.sin(s),y:-Math.cos(s)};ho(t,i,n,f,a),ho(t,i,n,f,r)}else{for(let e=l;e<=h;e+=f)t.moveTo(e,c),t.lineTo(e,n+c+r);for(let e=c;e<=p;e+=f)t.moveTo(l,e),t.lineTo(i+l+r,e)}}t.stroke(),t.restore()}}function ho(t,e,i,n,o,s){const a=[{x:0,y:0},{x:e,y:0},{x:e,y:i},{x:0,y:i}];let r=1/0,l=-1/0;a.forEach(t=>{const e=t.x*o.x+t.y*o.y;r=Math.min(r,e),l=Math.max(l,e)});const c=Math.ceil((l-r)/n);t.beginPath();for(let e=0;e<=c;e++){const i=r+e*n;let s=[];for(let t=0;t<a.length;t++){const e=a[t],n=a[(t+1)%a.length],r=o.x*(n.y-e.y)-o.y*(n.x-e.x);if(Math.abs(r)>1e-6){const t=(i-e.x*o.x-e.y*o.y)/(o.x*(n.x-e.x)+o.y*(n.y-e.y));if(t>=0&&t<=1){const i=e.x+t*(n.x-e.x),o=e.y+t*(n.y-e.y);s.push({x:i,y:o})}}}s.length>=2&&(t.moveTo(s[0].x,s[0].y),t.lineTo(s[1].x,s[1].y))}t.stroke()}function uo(t,e,i,n,o,s,a,r){const l=[{x:e,y:i},{x:e+n,y:i},{x:e+n,y:i+o},{x:e,y:i+o}];let c=1/0,h=-1/0;l.forEach(t=>{const e=t.x*a.x+t.y*a.y;c=Math.min(c,e),h=Math.max(h,e)});const d=h-c,u=Math.ceil(d/s),f=c;t.beginPath();for(let e=0;e<=u;e++){const i=f+e*s,n=[];for(let t=0;t<l.length;t++){const e=l[t],o=l[(t+1)%4],s=o.x-e.x,r=o.y-e.y,c=a.x*r-a.y*s;if(Math.abs(c)>1e-6){const t=(i-e.x*a.x-e.y*a.y)/(a.x*s+a.y*r);t>=0&&t<=1&&n.push({x:e.x+t*s,y:e.y+t*r})}}n.length>=2&&(t.moveTo(n[0].x,n[0].y),t.lineTo(n[1].x,n[1].y))}t.stroke()}const fo='<svg fill="none" viewBox="0 0 24 24"><path fill="#0052d9" d="M12 23a11 11 0 100-22 11 11 0 000 22zM11 8.5v-2h2v2h-2zm2 1.5v7.5h-2V10h2z"></path></svg>';class po{parentElement;store;box;text;arrowUp;arrowDown;icon;confirm;cancel;x;y;constructor(t,e){let i;this.parentElement=t,this.store=e,this.box=document.createElement("div"),this.text=document.createElement("div"),this.arrowUp=document.createElement("div"),this.arrowDown=document.createElement("div"),this.icon=document.createElement("div"),this.confirm=document.createElement("button"),this.cancel=document.createElement("button"),this.box.className="meta2d-popconfirm",this.text.className="text",this.arrowUp.className="arrow",this.arrowDown.className="arrow down",this.icon.className="icon",this.confirm.className="confirm",this.cancel.className="cancel",this.confirm.innerHTML="",this.cancel.innerHTML="",this.icon.innerHTML=fo,this.box.appendChild(this.text),this.box.appendChild(this.arrowUp),this.box.appendChild(this.arrowDown),this.box.appendChild(this.confirm),this.box.appendChild(this.cancel),this.box.appendChild(this.icon),t.appendChild(this.box);for(let t=0;t<document.styleSheets.length;t++)"le5le.com/popconfirm"===document.styleSheets[t].title&&(i=document.styleSheets[t]);if(!i){let t=document.createElement("style");t.type="text/css",t.title="le5le.com/popconfirm",document.head.appendChild(t),t=document.createElement("style"),t.type="text/css",document.head.appendChild(t),i=t.sheet,i.insertRule(".meta2d-popconfirm{position:absolute;z-index:999;left: -9999px;top: -9999px;padding:16px;max-width:400px;background:#fff;border-radius:6px;box-shadow:0 3px 14px 2px rgba(0, 0, 0, .05),0 8px 10px 1px rgba(0, 0, 0, 6%),0 5px 5px -3px rgba(0, 0, 0, 10%);}"),i.insertRule(".meta2d-popconfirm .text{outline:none;padding:0px 0px 40px 28px;border-radius:4px;color:rgba(0, 0, 0, 0.9);overflow-y:auto;line-height:22px;font-size:13px;}"),i.insertRule(".meta2d-popconfirm .arrow{position:absolute;border:10px solid transparent;background:transparent;top:-18px;left:50%;transform:translateX(-50%)}"),i.insertRule(".meta2d-popconfirm .arrow.down{top:initial;bottom: -18px;}"),i.insertRule(".meta2d-popconfirm .icon{position:absolute;width:22px;height:22px;left:16px;top:16px;}"),i.insertRule(".meta2d-popconfirm .confirm{position:absolute;right:16px;bottom:16px;width:40px;height:24px;text-align:center;background:#4582e6;color:#fff;border-radius:3px;border-color:transparent}"),i.insertRule(".meta2d-popconfirm .confirm:hover{background:#003cab;}"),i.insertRule(".meta2d-popconfirm .cancel{position:absolute;right:64px;bottom:16px;width:40px;height:24px;text-align:center;background:#dcdcdc;color:rgba(0, 0, 0, 0.9);border-radius:3px;border-color:transparent}"),i.insertRule(".meta2d-popconfirm .cancel:hover{background:#a6a6a6;}")}}show(t,e){if(!t)return;const i=this.box.getBoundingClientRect(),n=t.calculative.worldRect;let o=t.calculative.canvas.store.data.x+e.x-i.width/2,s=t.calculative.canvas.store.data.y+e.y-i.height-20;t.type||(o=t.calculative.canvas.store.data.x+n.x-(i.width-n.width)/2,s=t.calculative.canvas.store.data.y+n.ey-i.height-n.height),s>0?(this.arrowUp.style.borderBottomColor="transparent",this.arrowDown.style.borderTopColor="#fff",s-=10):(s+=i.height+n.height+5,s+=10,this.arrowUp.style.borderBottomColor="#fff",this.arrowDown.style.borderTopColor="transparent"),this.x=o,this.y=s,this.box.style.left=this.x+"px",this.box.style.top=this.y+"px"}hide(){this.x=-9999,this.box.style.left="-9999px"}showModal(t,e,i){return new Promise(n=>{this.text.innerHTML=i||"",this.show(t,e),this.confirm.onclick=()=>{n(!0),this.hide()},this.cancel.onclick=()=>{n(!1),this.hide()}})}destroy(){this.box=null}}const vo="-moving";class go{parent;parentElement;store;canvas=document.createElement("canvas");offscreen=eo();width;height;externalElements=document.createElement("div");clientRect;canvasRect;activeRect;initActiveRect;dragRect;lastRotate=0;sizeCPs;activeInitPos;hoverType=k.None;resizeIndex=0;mouseDown;hotkeyType;mouseRight;addCaches;touchCenter;initTouchDis;initScale;touchScaling;touchMoving;startTouches;lastOffsetX=0;lastOffsetY=0;drawingLineName;drawLineFns=[...P];drawingLine;pencil;pencilLine;movingPens;patchFlagsLines=new Set;dock;prevAnchor;nextAnchor;lastMouseTime=0;hoverTimer=0;fitTimer=0;willInactivePen;patchFlags=!1;lastRender=0;touchStart=0;touchStartTimer;timer;lastAnimateRender=0;animateRendering=!1;renderTimer;initPens;pointSize=8;pasteOffset=!0;opening=!1;maxZindex=5;canMoveLine=!1;randomIdObj;keyOptions;beforeAddPen;beforeAddPens;beforeAddAnchor;beforeRemovePens;beforeRemoveAnchor;customResizeDock;customMoveDock;inputParent=document.createElement("div");inputDiv=document.createElement("div");dropdown=document.createElement("ul");tooltip;popconfirm;title;mousePos={x:0,y:0};scroll;movingAnchor;canvasTemplate;canvasImage;canvasImageBottom;magnifierCanvas;dialog;autoPolylineFlag=!1;stopPropagation=t=>{t.stopPropagation()};constructor(t,e,i){this.parent=t,this.parentElement=e,this.store=i,this.canvasTemplate=new co(e,i),this.canvasTemplate.canvas.style.zIndex="1",this.canvasImageBottom=new oo(e,i,!0),this.canvasImageBottom.canvas.style.zIndex="2",e.appendChild(this.canvas),this.canvas.style.position="absolute",this.canvas.style.backgroundRepeat="no-repeat",this.canvas.style.backgroundSize="100% 100%",this.canvas.style.zIndex="3",this.canvasImage=new oo(e,i),this.canvasImage.canvas.style.zIndex="4",this.magnifierCanvas=new so(this,e,i),this.magnifierCanvas.canvas.style.zIndex="5",this.externalElements.style.position="absolute",this.externalElements.style.left="0",this.externalElements.style.top="0",this.externalElements.style.outline="none",this.externalElements.style.background="transparent",this.externalElements.style.zIndex="5",e.style.position="relative",e.appendChild(this.externalElements),this.createInput(),this.tooltip=new io(e,i),this.tooltip.box.onmouseleave=t=>{this.patchFlags=!0,this.store.lastHover&&(this.store.lastHover.calculative.hover=!1),Ze(this.store.data.pens.find(t=>!0===t.calculative.hover),!1)},this.popconfirm=new po(e,i),this.dialog=new ro(e,i),this.title=new lo(e),this.store.options.scroll&&(this.scroll=new no(this)),this.store.dpiRatio=globalThis.devicePixelRatio||1,this.store.dpiRatio<1?this.store.dpiRatio=1:this.store.dpiRatio>1&&this.store.dpiRatio<1.5&&(this.store.dpiRatio=1.5),this.clientRect=this.externalElements.getBoundingClientRect(),this.listen(),window?.addEventListener("resize",this.onResize),window?.addEventListener("scroll",this.onScroll),window?.addEventListener("message",this.onMessage)}curve=sn;polyline=Sn;mind=hn;line=un;listen(){switch(this.externalElements.addEventListener("gesturestart",this.onGesturestart),this.externalElements.ondragover=t=>t.preventDefault(),this.externalElements.ondrop=this.ondrop,this.externalElements.oncontextmenu=t=>t.preventDefault(),this.store.options.interval=50,this.externalElements.ontouchstart=this.ontouchstart,this.externalElements.ontouchmove=this.ontouchmove,this.externalElements.ontouchend=this.ontouchend,this.externalElements.onmousedown=t=>{this.onMouseDown({x:t.offsetX,y:t.offsetY,clientX:t.clientX,clientY:t.clientY,pageX:t.pageX,pageY:t.pageY,ctrlKey:t.ctrlKey||t.metaKey,shiftKey:t.shiftKey,altKey:t.altKey,buttons:t.buttons})},this.externalElements.onmousemove=t=>{t.target===this.externalElements&&this.onMouseMove({x:t.offsetX,y:t.offsetY,clientX:t.clientX,clientY:t.clientY,pageX:t.pageX,pageY:t.pageY,ctrlKey:t.ctrlKey||t.metaKey,shiftKey:t.shiftKey,altKey:t.altKey,buttons:t.buttons})},this.externalElements.onmouseup=t=>{this.onMouseUp({x:t.offsetX,y:t.offsetY,clientX:t.clientX,clientY:t.clientY,pageX:t.pageX,pageY:t.pageY,ctrlKey:t.ctrlKey||t.metaKey,shiftKey:t.shiftKey,altKey:t.altKey,buttons:t.buttons,button:t.button})},this.externalElements.onmouseleave=t=>{this.store.data.pens.forEach(t=>{t.calculative.hover&&(t.calculative.hover=!1)}),this.store.hover&&(this.store.hover.calculative.hover=!1,this.store.hover=void 0),this.render(),t.toElement!==this.tooltip.box&&t.toElement!==this.tooltip.arrowUp&&t.toElement!==this.tooltip.arrowDown&&(this.tooltip.hide(),this.store.lastHover=void 0)},this.externalElements.ondblclick=this.ondblclick,this.externalElements.tabIndex=0,this.externalElements.onblur=()=>{this.mouseDown=void 0},this.externalElements.onwheel=this.onwheel,document.addEventListener("copy",this.onCopy),document.addEventListener("cut",this.onCut),document.addEventListener("paste",this.onPaste),this.store.options.keydown){case Y.Document:document.addEventListener("keydown",this.onkeydown),document.addEventListener("keyup",this.onkeyup);break;case Y.Canvas:this.externalElements.addEventListener("keydown",this.onkeydown),this.externalElements.addEventListener("keyup",this.onkeyup)}}onCopy=t=>{this.store.options.disableClipboard||t.target!==this.externalElements&&t.target!==document.body&&t.target.offsetParent!==this.externalElements||this.copy()};onCut=t=>{this.store.options.disableClipboard||t.target!==this.externalElements&&t.target!==document.body&&t.target.offsetParent!==this.externalElements||this.cut()};onPaste=async t=>{if(this.store.data.locked||this.store.options.disableClipboard)return;if(t.target!==this.externalElements&&t.target!==document.body&&t.target.offsetParent!==this.externalElements)return;let e;if(navigator.clipboard&&t.clipboardData){const i=t.clipboardData.items;if(i)for(let t=0;t<i.length;t++)if(-1!==i[t].type.indexOf("image")&&i[t].getAsFile()){e=!0;break}}if(e){const e=t.clipboardData.items;if(e)for(let t=0;t<e.length;t++)if(-1!==e[t].type.indexOf("image")&&e[t].getAsFile()){const{x:i,y:n}=this.mousePos,o=e[t].getAsFile();let s="gif"===e[t].type.slice(6)?"gif":"image";if(null!==o){const t="gif"===s,e=await this.fileToPen(o,t);e.height=e.height/e.width*100,e.width=100,e.x=i-25,e.y=n-e.height/e.width*50,e.externElement=t,this.addPens([e]),this.active([e]),this.copy([e])}}}else this.paste()};onMessage=t=>{if("string"!=typeof t.data||!t.data||t.data.startsWith("setImmediate")||t.data.startsWith("webpackHotUpdate"))return;let e=JSON.parse(t.data);"object"==typeof e?("onload"===e.name&&this.dialog.iframe.contentWindow.postMessage(JSON.stringify({name:"dialog",data:this.dialog.data}),"*"),this.parent.doMessageEvent(e.name,JSON.stringify(e.data))):this.parent.doMessageEvent(e)};onwheel=t=>{if("true"===this.inputDiv.contentEditable)return;if(this.drawingLine)return;if(this.pencil)return;if(this.store.hover&&this.store.hover.onWheel)return void this.store.hover.onWheel(this.store.hover,t);if(this.store.data.disableScale||this.store.options.disableScale)return;if(t.preventDefault(),t.stopPropagation(),this.mouseDown&&(this.hoverType===k.Node||this.hoverType===k.Line))return;if(this.store.data.locked===a.Disable)return;if(this.store.data.locked===a.DisableScale)return;if(this.store.data.locked===a.DisableMoveScale)return;if(!t.ctrlKey&&Math.abs(t.wheelDelta)<100&&-1===t.deltaY.toString().indexOf(".")){if(this.store.options.scroll&&!t.metaKey&&this.scroll)return void this.scroll.wheel(t.deltaY<0);const e=this.store.data.scale||1;return void this.translate(-t.deltaX/e,-t.deltaY/e)}if(Math.abs(t.wheelDelta)>100&&this.store.options.scroll&&this.scroll&&!this.store.options.scrollButScale&&!t.ctrlKey&&!t.metaKey)return void this.scroll.wheel(t.deltaY<0);if(this.store.options.disableTouchPadScale)return;let e=.015;if(this.store.options.scaleOff)e=this.store.options.scaleOff,t.deltaY>0&&(e=-this.store.options.scaleOff);else if(/mac os /i.test(navigator.userAgent))t.ctrlKey?t.deltaY>0&&(e*=-1):e*=t.wheelDeltaY/240;else{let i=.2;-1!==t.deltaY.toString().indexOf(".")&&(i=.01),e=t.deltaY>0?-i:i}let{offsetX:i,offsetY:n}=t;this.scale(this.store.data.scale+e,{x:i,y:n}),this.externalElements.focus()};onkeydown=t=>{if(this.store.data.locked>=a.DisableEdit&&"INPUT"!==t.target.tagName&&"TEXTAREA"!==t.target.tagName&&!t.target.dataset.meta2dIgnore&&this.store.active.forEach(e=>{e.onKeyDown?.(e,t.key)}),this.store.data.locked>=a.DisableEdit||"INPUT"===t.target.tagName||"TEXTAREA"===t.target.tagName||t.target.dataset.meta2dIgnore)return;if(this.store.options.unavailableKeys.includes(t.key))return;this.keyOptions||(this.keyOptions={}),this.keyOptions.altKey=t.altKey,this.keyOptions.shiftKey=t.shiftKey,this.keyOptions.ctrlKey=t.ctrlKey,this.keyOptions.metaKey=t.metaKey,this.keyOptions.F=!1,"F"!==t.key&&"f"!==t.key||(this.keyOptions.F=!0);let e=10,i=10,n=null;if(this.store.options.strictScope){const t=this.store.data.width||this.store.options.width,e=this.store.data.height||this.store.options.height;t&&e&&(n={x:this.store.data.origin.x,y:this.store.data.origin.y,width:t*this.store.data.scale,height:e*this.store.data.scale})}switch(t.key){case" ":this.hotkeyType=T.Translate;break;case"Control":this.drawingLine?this.drawingLine.calculative.drawlineH=!this.drawingLine.calculative.drawlineH:this.hotkeyType||(this.patchFlags=!0,this.hotkeyType=T.Select);break;case"Meta":break;case"Shift":1===this.store.active.length&&this.store.active[0].type&&this.store.activeAnchor?this.toggleAnchorHand():this.hotkeyType||(this.patchFlags=!0,this.store.options.resizeMode||(this.hotkeyType=T.Resize));break;case"Alt":if(!t.ctrlKey&&!t.shiftKey&&this.drawingLine){const t=$e(this.drawingLine);t!==this.drawingLine.calculative.activeAnchor?(He(this.drawingLine),this.drawingLine.calculative.worldAnchors.push(t)):this.drawingLine.calculative.worldAnchors.push({x:t.x,y:t.y});const e=this.drawLineFns.indexOf(this.drawingLineName);this.drawingLineName=this.drawLineFns[(e+1)%this.drawLineFns.length],this.drawingLine.lineName=this.drawingLineName,this.drawline(),this.patchFlags=!0}t.preventDefault();break;case"a":case"A":t.ctrlKey||t.metaKey?(this.active(this.store.data.pens.filter(t=>!t.parentId&&t.locked!==a.Disable)),t.preventDefault()):this.toggleAnchorMode();break;case"Delete":case"Backspace":if(this.canvasImage.fitFlag&&this.canvasImage.activeFit){this.deleteFit();break}!this.store.data.locked&&this.delete();break;case"ArrowLeft":if(this.movingAnchor){this.translateAnchor(-1,0);break}if(e=-1,t.shiftKey&&(e=-5),(t.ctrlKey||t.metaKey)&&(e=-10),e*=this.store.data.scale,this.store.activeAnchor&&this.store.active&&1===this.store.active.length&&this.store.active[0].type){this.moveLineAnchor({x:this.store.activeAnchor.x+e,y:this.store.activeAnchor.y},{});break}n&&this.activeRect.x+e<n.x&&(e=n.x-this.activeRect.x),this.translatePens(this.store.active,e,0);break;case"ArrowUp":if(this.movingAnchor){this.translateAnchor(0,-1);break}if(i=-1,t.shiftKey&&(i=-5),(t.ctrlKey||t.metaKey)&&(i=-10),i*=this.store.data.scale,n&&this.activeRect.y+i<n.y&&(i=n.y-this.activeRect.y),this.store.activeAnchor&&this.store.active&&1===this.store.active.length&&this.store.active[0].type){this.moveLineAnchor({x:this.store.activeAnchor.x,y:this.store.activeAnchor.y+i},{});break}this.translatePens(this.store.active,0,i);break;case"ArrowRight":if(this.movingAnchor){this.translateAnchor(1,0);break}if(e=1,t.shiftKey&&(e=5),(t.ctrlKey||t.metaKey)&&(e=10),e*=this.store.data.scale,this.store.activeAnchor&&this.store.active&&1===this.store.active.length&&this.store.active[0].type){this.moveLineAnchor({x:this.store.activeAnchor.x+e,y:this.store.activeAnchor.y},{});break}n&&this.activeRect.x+this.activeRect.width+e>n.x+n.width&&(e=n.x+n.width-(this.activeRect.x+this.activeRect.width)),this.translatePens(this.store.active,e,0);break;case"ArrowDown":if(this.movingAnchor){this.translateAnchor(0,1);break}if(i=1,t.shiftKey&&(i=5),(t.ctrlKey||t.metaKey)&&(i=10),i*=this.store.data.scale,n&&this.activeRect.y+this.activeRect.height+i>n.y+n.height&&(i=n.y+n.height-(this.activeRect.y+this.activeRect.height)),this.store.activeAnchor&&this.store.active&&1===this.store.active.length&&this.store.active[0].type){this.moveLineAnchor({x:this.store.activeAnchor.x,y:this.store.activeAnchor.y+i},{});break}this.translatePens(this.store.active,0,i);break;case"d":case"D":this.store.active[0]?.locked||this.removeAnchorHand();break;case"h":case"H":this.store.active[0]?.locked||this.addAnchorHand();break;case"m":case"M":this.toggleMagnifier();break;case"g":case"G":if(t.ctrlKey||t.metaKey){t.shiftKey?this.parent.uncombine():this.store.active.length>1&&this.parent.combine(this.store.active),t.preventDefault();break}this.hoverType===k.NodeAnchor&&(this.movingAnchor=this.store.hoverAnchor,this.externalElements.style.cursor="move");break;case"s":case"S":this.store.data.locked||this.hoverType!==k.LineAnchor||this.store.hover!==this.store.active[0]||this.splitLine(this.store.active[0],this.store.hoverAnchor),(t.ctrlKey||t.metaKey)&&this.store.emitter.emit("save",{event:t});break;case"c":case"C":(t.ctrlKey||t.metaKey)&&this.store.options.disableClipboard&&this.copy();break;case"x":case"X":(t.ctrlKey||t.metaKey)&&this.store.options.disableClipboard&&this.cut();break;case"":case"v":case"V":t.ctrlKey||t.metaKey||(this.pencil&&this.stopPencil(),this.drawingLineName?(this.finishDrawline(),this.drawingLineName=""):this.drawingLineName=this.store.options.drawingLineName),!this.store.data.locked&&(t.ctrlKey||t.metaKey)&&(this.store.options.disableClipboard||!this.store.options.disableClipboard&&t.altKey)&&this.paste();break;case"b":case"B":this.drawingLineName&&(this.finishDrawline(),this.drawingLineName=""),this.pencil?this.stopPencil():this.drawingPencil();break;case"y":case"Y":(t.ctrlKey||t.metaKey)&&this.redo();break;case"z":case"Z":t.ctrlKey||t.metaKey?this.undo():t.shiftKey&&this.redo();break;case"Enter":this.drawingLineName&&(this.finishDrawline(!0),this.store.active[0].anchors[0].connectTo?this.drawingLineName="":this.drawingLineName=this.store.options.drawingLineName),this.store.active&&(this.store.active.forEach(t=>{t.type?(t.close=!t.close,t.close&&vn(t),this.store.path2dMap.set(t,V.path2dDraws.line(t)),bn(t)):t.calculative.focus=!0}),this.render());break;case"Escape":this.drawingLineName&&this.finishDrawline(),this.drawingLineName=void 0,this.stopPencil(),this.store.active&&this.store.active.forEach(t=>{t.type||(t.calculative.focus=!1)}),this.movingPens&&(this.getAllByPens(this.movingPens).forEach(t=>{this.store.pens[t.id]=void 0}),this.movingPens=void 0,this.mouseDown=void 0,this.clearDock(),this.store.active?.forEach(t=>{this.updateLines(t)}),this.calcActiveRect(),this.patchFlags=!0),this.hotkeyType=T.None,this.movingAnchor=void 0,this.magnifierCanvas.magnifier&&(this.magnifierCanvas.magnifier=!1,this.patchFlags=!0);break;case"E":case"e":this.store.options.disableAnchor=!this.store.options.disableAnchor,this.store.emitter.emit("disableAnchor",this.store.options.disableAnchor);break;case"=":(t.ctrlKey||t.metaKey)&&(this.scale(this.store.data.scale+.1),t.preventDefault(),t.stopPropagation());break;case"-":(t.ctrlKey||t.metaKey)&&(this.scale(this.store.data.scale-.1),t.preventDefault(),t.stopPropagation());break;case"l":case"L":this.canMoveLine=!0;break;case"[":this.parent.down();break;case"]":this.parent.up();break;case"{":this.parent.bottom();break;case"}":this.parent.top();break;case"F":case"f":this.store.data.locked||!t.ctrlKey&&!t.metaKey||this.store.options.disableClipboard||this.paste(),this.setFollowers()}this.render(!1)};splitLine(t,e){const i=t.calculative.worldAnchors,n=i.findIndex(t=>t===e);if([-1,0,i.length-1].includes(n))return;const o=dt(t,!0),s=dt(t,!0),a=Ct();s.id=a,s.calculative.canvas=this,s.calculative.active=!1,s.calculative.hover=!1;const r=dt(i.slice(0,n+1)),l=dt(i.slice(n)).map(t=>(t.penId=a,t));t.calculative.worldAnchors=r,s.calculative.worldAnchors=l,this.initLineRect(t),this.initLineRect(s),this.store.data.pens.push(s),this.store.pens[a]=s,this.pushHistory({type:Z.Add,pens:[dt(s,!0)],step:2}),this.pushHistory({type:Z.Update,initPens:[o],pens:[dt(t,!0)],step:2})}translateAnchor(t,e){this.movingAnchor.x+=t,this.movingAnchor.y+=e;const i=this.movingAnchor.penId;if(i){const t=this.store.pens[i],e=t.calculative.worldRect;this.movingAnchor.x<e.x?this.movingAnchor.x=e.x:this.movingAnchor.x>e.ex&&(this.movingAnchor.x=e.ex),this.movingAnchor.y<e.y?this.movingAnchor.y=e.y:this.movingAnchor.y>e.ey&&(this.movingAnchor.y=e.ey);const n=$i(this.movingAnchor,e),o=t.anchors.findIndex(t=>t.id===this.movingAnchor.id);t.anchors[o]=n,this.patchFlags=!0}}onkeyup=t=>{switch(t.key){case"l":case"L":this.canMoveLine=!1}this.hotkeyType&&this.render(),this.hotkeyType<T.AddAnchor&&(this.hotkeyType=T.None)};async fileToPen(t,e){let i="";return i=this.store.options.uploadFn?await this.store.options.uploadFn(t):this.store.options.uploadUrl?await Et(t,this.store.options.uploadUrl,this.store.options.uploadParams,this.store.options.uploadHeaders):await It(t),new Promise((t,n)=>{const o=new Image;o.onload=()=>{V.htmlElements[i]=o,t({width:o.width,height:o.height,name:e?"gif":"image",image:i})},o.onerror=t=>{n(t)},o.crossOrigin="anonymous",o.src=i})}ondrop=async t=>{if(this.store.data.locked)return void console.warn("canvas is locked, can not drop");t.preventDefault(),t.stopPropagation();const e=t.dataTransfer.getData("Meta2d")||t.dataTransfer.getData("Text");let i=null;try{e&&(i=JSON.parse(e))}catch(t){}if(!i){const{files:e}=t.dataTransfer;if(!e.length||!e[0].type.match("image.*")||this.addCaches&&this.addCaches.length){if(!this.addCaches||!this.addCaches.length)return void this.store.emitter.emit("drop",void 0);i=this.addCaches,this.addCaches=[]}else{const t="image/gif"===e[0].type;i=await this.fileToPen(e[0],t)}}if(i=Array.isArray(i)?i:[i],i[0]&&!1!==i[0].draggable){const e={x:t.offsetX,y:t.offsetY};this.calibrateMouse(e),this.dropPens(i,e),this.addCaches=[],this.getContainerHover(e),this.mousePos.x=e.x,this.mousePos.y=e.y,this.store.emitter.emit("mouseup",{x:e.x,y:e.y,pen:this.store.hoverContainer})}this.store.emitter.emit("drop",i||e)};async dropPens(t,e){this.randomIdObj={};for(const e of t)!e.parentId&&this.randomCombineId(e,t);if(0!==Object.keys(this.randomIdObj).length){const e=Object.keys(this.randomIdObj).join("|"),i=new RegExp(`(${e})`,"g");for(const e of t){if(e.type?(e.anchors[0].connectTo=this.randomIdObj[e.anchors[0].connectTo],e.anchors[e.anchors.length-1].connectTo=this.randomIdObj[e.anchors[e.anchors.length-1].connectTo]):e.connectedLines?.forEach(t=>{t.lineAnchor=this.randomIdObj[t.lineAnchor],t.lineId=this.randomIdObj[t.lineId]}),e.animations?.length){const t=JSON.stringify(e.animations).replace(i,t=>this.randomIdObj[t]);e.animations=JSON.parse(t)}if(e.triggers?.length){const t=JSON.stringify(e.triggers).replace(i,t=>this.randomIdObj[t]);e.triggers=JSON.parse(t)}if(e.events?.length){const t=JSON.stringify(e.events).replace(i,t=>this.randomIdObj[t]);e.events=JSON.parse(t)}}}for(const e of t)e.id||(e.id=Ct()),!e.calculative&&(e.calculative={canvas:this}),this.store.pens[e.id]=e;let i=0,n=0,o=0;for(const s of t)s.parentId||(s.width*=this.store.data.scale,s.height*=this.store.data.scale,s.x=e.x-s.width/2+o,s.y=e.y-s.height/2+n,s.tags&&s.tags.includes("meta3d")&&(s.x=this.store.data.origin.x,s.y=this.store.data.origin.y),s.dataset&&(o=i%2==0?s.width-40*this.store.data.scale:0,i++,i%2==0&&(n+=s.height+10*this.store.data.scale)));const s=this.store.data.width||this.store.options.width,a=this.store.data.height||this.store.options.height;if(s&&a){let e={x:this.store.data.origin.x,y:this.store.data.origin.y,width:s*this.store.data.scale,height:a*this.store.data.scale},i=!0;for(const n of t)if(!n.parentId){let t=[{x:n.x,y:n.y},{x:n.x+n.width,y:n.y},{x:n.x,y:n.y+n.height},{x:n.x+n.width,y:n.y+n.height},{x:n.x+n.width/2,y:n.y+n.height/2}];if(n.x===e.x&&n.y===e.y&&n.width===e.width&&n.height===e.height||t.some(t=>Ii(t,e))){i=!1,this.store.options.strictScope&&(n.x<e.x&&(n.x=e.x),n.y<e.y&&(n.y=e.y),n.x+n.width>e.x+e.width&&(n.x=e.x+e.width-n.width),n.y+n.height>e.y+e.height&&(n.y=e.y+e.height-n.height));break}}if(i)return void console.info("")}await this.addPens(t,!0),this.active(t.filter(t=>!t.parentId)),this.render(),this.externalElements.focus()}randomCombineId(t,e,i){let n=null;t.type?n=t.anchors[0].connectTo||t.anchors[t.anchors.length-1].connectTo?[t.id,t.anchors[0].id,t.anchors[t.anchors.length-1].id]:[t.id]:e.length>1&&(n=[t.id]),Ri(t),e.length>1&&(1===n.length?this.randomIdObj[n[0]]=t.id:(this.randomIdObj[n[0]]=t.id,this.randomIdObj[n[1]]=t.anchors[0].id,this.randomIdObj[n[2]]=t.anchors[t.anchors.length-1].id)),t.parentId=i;const o=[];if(Array.isArray(t.children))for(const i of t.children){const n=e.find(t=>t.id===i);n&&o.push(this.randomCombineId(n,e,t.id).id)}return t.children=o,t}async addPens(t,e,i){if(this.beforeAddPens&&1!=await this.beforeAddPens(t))return[];const n=[];for(const e of t)this.beforeAddPen&&1!=this.beforeAddPen(e)||(i&&!e.parentId&&(e.x=e.x*this.store.data.scale+this.store.data.origin.x,e.y=e.y*this.store.data.scale+this.store.data.origin.y,e.width=e.width*this.store.data.scale,e.height=e.height*this.store.data.scale),this.makePen(e),n.push(e));return this.render(),this.store.emitter.emit("add",n),e&&this.pushHistory({type:Z.Add,pens:dt(n,!0)}),n}ontouchstart=t=>{this.store.data.locked!==a.Disable&&(this.touchStartTimer&&clearTimeout(this.touchStartTimer),this.touchStartTimer=setTimeout(()=>{this.touchStart=performance.now();const e=t.touches[0].pageX-this.clientRect.x,i=t.touches[0].pageY-this.clientRect.y,n={x:e,y:i};if(this.calibrateMouse(n),this.getHover(n),this.onMouseDown({x:e,y:i,clientX:t.touches[0].clientX,clientY:t.touches[0].clientY,pageX:t.touches[0].pageX,pageY:t.touches[0].pageY,ctrlKey:t.ctrlKey||t.metaKey,shiftKey:t.shiftKey,altKey:t.altKey,buttons:1}),2===t.touches.length)return this.initTouchDis=Math.hypot(t.touches[0].pageX-t.touches[1].pageX,t.touches[0].pageY-t.touches[1].pageY),this.initScale=this.store.data.scale,this.startTouches=t.touches,void(this.touchCenter={x:t.touches[0].pageX+(t.touches[1].pageX-t.touches[0].pageX)/2-this.clientRect.x,y:t.touches[0].pageY+(t.touches[1].pageY-t.touches[0].pageY)/2-this.clientRect.y});3===t.touches.length&&(this.store.emitter.emit("contextmenu",{e:{x:e,y:i,clientX:t.touches[0].clientX,clientY:t.touches[0].clientY,pageX:t.touches[0].pageX,pageY:t.touches[0].pageY},clientRect:this.clientRect}),t.preventDefault(),t.stopPropagation()),this.touchStartTimer=void 0},50))};ontouchmove=t=>{if(this.store.data.locked===a.Disable)return;t.stopPropagation(),t.preventDefault();const e=performance.now();if(e-this.touchStart<50)return;this.touchStart=e;const i=t.touches,n=i.length,o=t.touches[0].pageX-this.clientRect.x,s=t.touches[0].pageY-this.clientRect.y;if(1===n)this.onMouseMove({x:o,y:s,clientX:t.changedTouches[0].clientX,clientY:t.changedTouches[0].clientY,pageX:t.changedTouches[0].pageX,pageY:t.changedTouches[0].pageY,ctrlKey:t.ctrlKey||t.metaKey,shiftKey:t.shiftKey,altKey:t.altKey,buttons:1});else if(2===n&&2===this.startTouches?.length){if(!this.touchMoving&&!this.touchScaling){const t=this.startTouches[0].pageX-i[0].pageX,e=this.startTouches[1].pageX-i[1].pageX,n=this.startTouches[0].pageY-i[0].pageY,o=this.startTouches[1].pageY-i[1].pageY;(t>=0&&e<0||t<=0&&e>0)&&(n>=0&&o<0||n<=0&&o>0)?this.touchScaling=!0:this.touchMoving=!0}if(this.touchScaling){if(this.store.data.disableScale||this.store.options.disableScale)return;const t=Math.hypot(i[0].pageX-i[1].pageX,i[0].pageY-i[1].pageY)/this.initTouchDis;this.scale(this.initScale*t,dt(this.touchCenter))}if(this.touchMoving){if(this.store.data.locked>=a.DisableMove&&this.store.data.locked!==a.DisableScale||this.store.data.disableScale||this.store.options.disableScale)return;if(this.lastOffsetX){const{scale:t}=this.store.data;this.translate((o-this.lastOffsetX)/t,(s-this.lastOffsetY)/t)}this.lastOffsetX=o,this.lastOffsetY=s}}};ontouchend=t=>{if(this.store.data.locked===a.Disable)return;this.touchCenter=void 0,this.touchScaling=void 0,this.touchMoving=void 0,this.startTouches=void 0,this.lastOffsetX=0,this.lastOffsetY=0;const e=t.changedTouches[0].pageX-this.clientRect.x,i=t.changedTouches[0].pageY-this.clientRect.y;this.onMouseUp({x:e,y:i,clientX:t.changedTouches[0].clientX,clientY:t.changedTouches[0].clientY,pageX:t.changedTouches[0].pageX,pageY:t.changedTouches[0].pageY,ctrlKey:t.ctrlKey||t.metaKey,shiftKey:t.shiftKey,altKey:t.altKey,buttons:1}),setTimeout(()=>{this.render()},20)};onGesturestart=t=>{t.preventDefault()};getInitPencilLine(t){const{data:e,options:i}=this.store,n=e.scale,o=e.lineWidth||1;return{id:t.penId,name:"line",x:t.x,y:t.y,type:s.Line,calculative:{canvas:this,pencil:!0,active:!0,worldAnchors:[t],lineWidth:o*n},fromArrow:e.fromArrow||i.fromArrow,toArrow:e.toArrow||i.toArrow,lineWidth:o}}createDrawingLine(t){this.inactive();const{data:e,options:i}=this.store,n=e.scale,o=e.lineWidth||1;return t.penId=Ct(),{id:t.penId,name:"line",lineName:this.drawingLineName,x:t.x,y:t.y,type:s.Line,calculative:{canvas:this,active:!0,worldAnchors:[t],lineWidth:o*n,...i.linePresetStyle},fromArrow:e.fromArrow||i.fromArrow,toArrow:e.toArrow||i.toArrow,lineWidth:o,...i.linePresetStyle}}onMouseDown=t=>{if(2!==t.buttons||this.drawingLine||(this.mouseRight=C.Down),this.hideInput(),this.popconfirm.hide(),this.store.data.locked===a.Disable||1!==t.buttons&&2!==t.buttons)this.hoverType=k.None;else if(!this.magnifierCanvas.magnifier)if(this.calibrateMouse(t),this.mousePos.x=t.x,this.mousePos.y=t.y,this.mouseDown=t,this.lastMouseTime=performance.now(),this.canvasImage.fitFlag)this.canvasImage.currentFit||this.calcuActiveFit();else if(this.hotkeyType!==T.AddAnchor){if(!this.store.options.autoAnchor&&!this.drawingLine&&t.shiftKey&&t.ctrlKey&&t.altKey){this.setAnchor(this.store.pointAt),this.drawingLineName=this.store.options.drawingLineName;const t=this.store.activeAnchor;if(!t)return;const e={id:Ct(),x:t.x,y:t.y};this.drawingLine=this.createDrawingLine(e);let i=qe(this.drawingLine);return this.drawingLine.calculative.activeAnchor=i,We(this.store.hover,t,this.drawingLine,e),void this.drawline()}if(this.hotkeyType!==T.Translate&&(this.mouseRight!==C.Down||this.store.options.mouseRightActive)){if(this.drawingLine){if(this.store.hoverAnchor){const t=$e(this.drawingLine);return this.store.hoverAnchor.type===M.Line?H(t,this.store.hoverAnchor,this.store):(t.x=this.store.hoverAnchor.x,t.y=this.store.hoverAnchor.y),We(this.store.hover,this.store.hoverAnchor,this.drawingLine,t),this.drawline(),void this.finishDrawline(!0)}if(!this.store.options.autoAnchor&&t.shiftKey&&t.altKey&&t.ctrlKey){this.setAnchor(this.store.pointAt);const t=$e(this.drawingLine),e=this.store.activeAnchor;if(!e)return;return t.x=e.x,t.y=e.y,We(this.store.hover,e,this.drawingLine,t),this.drawline(),void this.finishDrawline(!0)}if(2===t.buttons||"mind"===this.drawingLineName&&this.drawingLine?.calculative.worldAnchors.length>1||this.store.options.drawingLineLength&&this.drawingLine?.calculative.worldAnchors.length>this.store.options.drawingLineLength)return this.finishDrawline(!0),void(this.store.active[0]?.anchors[0].connectTo||0==this.store.active.length?this.drawingLineName="":this.drawingLineName=this.store.options.drawingLineName);if(this.store.options.autoAnchor&&this.hoverType===k.Node){const e=$e(this.drawingLine),i=ze(this.store.hover,t);return e.x=i.x,e.y=i.y,this.drawingLine.autoTo=!0,We(this.store.hover,i,this.drawingLine,e),this.drawline(),void this.finishDrawline(!0)}const e=$e(this.drawingLine);e.isTemp?(this.drawingLine.calculative.activeAnchor=this.drawingLine.calculative.worldAnchors[this.drawingLine.calculative.worldAnchors.length-2],e.isTemp=void 0):(this.drawingLine.calculative.activeAnchor=e,this.drawingLine.calculative.worldAnchors.push({x:e.x,y:e.y,penId:e.penId})),this.drawingLine.calculative.drawlineH=void 0,"polyline"!==this.drawingLineName&&this.drawline()}if(this.drawingLineName){if(this.hoverType===k.Node)if(this.store.options.autoAnchor){this.inactive(!0);const e=ze(this.store.hover,t);this.store.hoverAnchor=e;const i={id:Ct(),x:e.x,y:e.y};this.drawingLine=this.createDrawingLine(i),this.drawingLine.autoFrom=!0,We(this.store.hover,e,this.drawingLine,i)}else this.inactive(),this.hoverType=k.None;else if(this.hoverType===k.NodeAnchor){this.drawingLineName=this.store.options.drawingLineName;const t={id:Ct(),x:this.store.hoverAnchor.x,y:this.store.hoverAnchor.y};this.drawingLine=this.createDrawingLine(t),this.drawingLine.calculative.activeAnchor=t,We(this.store.hover,this.store.hoverAnchor,this.drawingLine,t)}else if(!this.drawingLine&&"curve"!==this.drawingLineName){this.inactive(!0);const e={id:Ct(),x:t.x,y:t.y};this.drawingLine=this.createDrawingLine(e),this.drawingLine.calculative.activeAnchor=e}}else if(this.pencil){this.inactive(!0);const e=Ct(),i={x:t.x,y:t.y,id:Ct(),penId:e};this.pencilLine=this.getInitPencilLine(i)}else{switch(this.hoverType){case k.None:(this.store.data.rule||this.store.options.rule)&&!this.store.options.disableRuleLine&&this.addRuleLine(t),this.store.options.resizeMode&&(this.hotkeyType=T.None),this.inactive();break;case k.Node:case k.Line:if(this.store.hover){if(this.store.active?.length&&1===this.store.active.length&&this.store.hover.id===this.store.active[0].id){this.calcActiveRect();break}const e=Vt(this.store.hover,!0);let i=e||this.store.hover;e&&(e.container||this.store.options.containerShapes?.includes(e.name))&&(i=this.store.hover),t.ctrlKey&&!t.shiftKey?(i.calculative.active?this.willInactivePen=i:this.store.active.length>0&&(i.calculative.active=!0,Qe(i),this.store.active.push(i),this.store.emitter.emit("active",this.store.active)),this.patchFlags=!0):t.ctrlKey&&t.shiftKey&&this.store.hover.parentId?this.active([this.store.hover]):this.activeRect&&Ii({x:t.x,y:t.y},this.activeRect)&&1!=this.store.active.length||i.calculative.active||(this.active([i]),this.store.options.resizeMode&&(this.hotkeyType=T.Resize)),this.calcActiveRect()}break;case k.LineAnchor:this.store.activeAnchor=this.store.hoverAnchor,this.store.hover.calculative.activeAnchor=this.store.hoverAnchor,this.active([this.store.hover]);break;case k.LineAnchorPrev:case k.LineAnchorNext:this.store.activeAnchor&&(this.prevAnchor={...this.store.activeAnchor.prev},this.nextAnchor={...this.store.activeAnchor.next});break;case k.Resize:this.activeInitPos=[],this.store.active.forEach(t=>{this.activeInitPos.push({x:(t.calculative.worldRect.x-this.activeRect.x)/this.activeRect.width,y:(t.calculative.worldRect.y-this.activeRect.y)/this.activeRect.height})})}this.store.hover&&(this.store.hover.calculative.mouseDown=!0),this.store.emitter.emit("mousedown",{x:t.x,y:t.y,pen:this.store.hover})}this.render()}}else this.setAnchor(this.store.pointAt)};onMouseMove=t=>{if(this.store.data.locked===a.Disable)return void(this.hoverType=k.None);if(this.mouseDown&&!this.mouseDown.restore&&1!==t.buttons&&2!==t.buttons)return void this.onMouseUp(t);if(this.lastMouseTime){if(performance.now()-this.lastMouseTime<50)return void(this.lastMouseTime=0);this.lastMouseTime=0}if(this.calibrateMouse(t),this.mousePos.x=t.x,this.mousePos.y=t.y,this.magnifierCanvas.magnifier)return void this.render();if(this.canvasImage.fitFlag&&this.canvasImage.activeFit){const e=performance.now();return void(e-this.fitTimer>100&&(this.mouseDown?this.updateFit(t):this.inFitBorder(this.mousePos),this.fitTimer=e))}if(this.mouseDown&&!this.store.options.disableTranslate&&!this.store.data.disableTranslate){if(this.mouseRight===C.Down&&(this.mouseRight=C.Translate),this.store.data.locked===a.DisableEdit||this.store.data.locked===a.DisableScale||this.hotkeyType===T.Translate||this.mouseRight===C.Translate){const{scale:e}=this.store.data;let i=(t.x-this.mouseDown.x)/e,n=(t.y-this.mouseDown.y)/e;return t.shiftKey&&!t.ctrlKey&&(n=0),t.ctrlKey&&(i=0),void this.translate(i,n)}if(this.store.data.locked)return;if(this.drawingLine||this.pencil){if(this.pencil){const{x:e,y:i}=t,n={x:e,y:i};n.id=Ct(),n.penId=this.pencilLine.id,this.pencilLine.calculative.worldAnchors.push(n),this.store.path2dMap.set(this.pencilLine,V.path2dDraws[this.pencilLine.name](this.pencilLine)),this.patchFlags=!0}}else{if(this.drawingLineName||this.movingAnchor){if(this.drawingLineName&&this.hoverType===k.None){const e={id:Ct(),x:t.x,y:t.y};return this.drawingLine=this.createDrawingLine(e),this.drawingLine.calculative.activeAnchor=e,void this.drawline()}}else if(this.hoverType===k.NodeAnchor){if(!this.store.hoverAnchor)return;this.drawingLineName=this.store.options.drawingLineName;const t={id:Ct(),x:this.store.hoverAnchor.x,y:this.store.hoverAnchor.y};return this.drawingLine=this.createDrawingLine(t),this.drawingLine.calculative.activeAnchor=t,We(this.store.hover,this.store.hoverAnchor,this.drawingLine,t),void this.drawline()}if(1===t.buttons&&(t.ctrlKey||!this.hoverType&&!this.hotkeyType)&&(!t.ctrlKey||!this.store.activeAnchor&&!this.store.active?.length))return this.dragRect={x:Math.min(this.mouseDown.x,t.x),y:Math.min(this.mouseDown.y,t.y),ex:Math.max(this.mouseDown.x,t.x),ey:Math.max(this.mouseDown.y,t.y),width:Math.abs(t.x-this.mouseDown.x),height:Math.abs(t.y-this.mouseDown.y)},void this.render();if(this.movingAnchor){const e=t.x-this.movingAnchor.x,i=t.y-this.movingAnchor.y;return this.translateAnchor(e,i),void this.render()}if(!this.store.active[0]?.locked){const e={x:t.x,y:t.y};if(this.hoverType===k.LineAnchor)return!this.dockInAnchor(t)&&"line"!==this.store.active[0]?.lineName||this.store.options.disableDock||this.store.options.disableLineDock||(this.clearDock(),this.dock=mi(this.store,e,this.store.activeAnchor),this.dock?.xDock&&(e.x+=this.dock.xDock.step),this.dock?.yDock&&(e.y+=this.dock.yDock.step)),void this.moveLineAnchor(e,t);if(this.hoverType===k.LineAnchorPrev)return void this.moveLineAnchorPrev(t);if(this.hoverType===k.LineAnchorNext)return void this.moveLineAnchorNext(t)}if(this.hoverType===k.Rotate)return void this.rotatePens({x:t.x,y:t.y});if(this.hoverType===k.Resize)return void this.resizePens(t);if(this.hoverType===k.Node||this.hoverType===k.Line){const e=t.x-this.mouseDown.x,i=t.y-this.mouseDown.y,n=20;if(t.ctrlKey&&!t.shiftKey&&(Math.abs(e)>=n||Math.abs(i)>=n)&&(this.willInactivePen=void 0),1===this.store.active.length){const t=this.store.active[0];if((void 0===t.locked||t.locked<a.DisableMove)&&t?.onMouseMove?.(t,this.mousePos),t.calculative.focus)return}return this.movePens(t),void this.getContainerHover(t)}}}if(this.drawingLine){const{x:e,y:i}=t,n={x:e,y:i};if(n.id=Ct(),n.penId=this.drawingLine.id,this.store.options.disableDock||this.store.options.disableLineDock||(this.clearDock(),this.dock=mi(this.store,n),this.dock?.xDock&&(n.x+=this.dock.xDock.step),this.dock?.yDock&&(n.y+=this.dock.yDock.step)),this.mouseDown&&"curve"===this.drawingLineName&&!this.drawingLine.calculative.worldAnchors[0].connectTo)this.drawline(n);else{let e;if(this.drawingLine.calculative.worldAnchors.length>1&&(e=$e(this.drawingLine)),e?(e.prev=void 0,e.next=void 0,e.id||(e.id=Ct()),e.x=n.x,e.y=n.y,e.connectTo=void 0):(e={...n},this.drawingLine.calculative.worldAnchors.push(e)),this.hoverType!==k.NodeAnchor&&this.hoverType!==k.LineAnchor||(this.store.hoverAnchor.type!==M.Line&&(e.x=this.store.hoverAnchor.x,e.y=this.store.hoverAnchor.y),e.connectTo=this.store.hoverAnchor.penId,"polyline"===this.drawingLineName&&(e.isTemp=!1)),"line"===this.drawingLineName)if(t.ctrlKey&&!t.shiftKey)e.x=this.drawingLine.calculative.worldAnchors[this.drawingLine.calculative.worldAnchors.length-2].x;else if(t.shiftKey&&!t.ctrlKey)e.y=this.drawingLine.calculative.worldAnchors[this.drawingLine.calculative.worldAnchors.length-2].y;else if(t.shiftKey&&t.ctrlKey){let t=this.drawingLine.calculative.worldAnchors[this.drawingLine.calculative.worldAnchors.length-2];this.getSpecialAngle(e,t)}this.drawline()}}globalThis.debug&&console.time("hover");const e=performance.now();e-this.hoverTimer>50&&(this.hoverTimer=e,this.getHover(t)),globalThis.debug&&console.timeEnd("hover"),this.hotkeyType===T.AddAnchor&&(this.patchFlags=!0),this.render(!1)};onMouseUp=t=>{if(this.store.data.locked!==a.Disable){if(this.mouseDown){if(this.mouseRight===C.Down&&(this.store.hover&&this.store.hover.onContextmenu?this.store.hover.onContextmenu(this.store.hover,t):this.store.emitter.emit("contextmenu",{e:t,clientRect:this.clientRect,pen:this.store.hover})),this.mouseRight=C.None,this.calibrateMouse(t),this.mousePos.x=t.x,this.mousePos.y=t.y,this.pencil&&this.finishPencil(),this.drawingLine){if(this.store.hoverAnchor){const t=$e(this.drawingLine);return this.store.hoverAnchor.type===M.Line?H(t,this.store.hoverAnchor,this.store):(t.x=this.store.hoverAnchor.x,t.y=this.store.hoverAnchor.y),We(this.store.hover,this.store.hoverAnchor,this.drawingLine,t),this.drawline(),void this.finishDrawline(!0)}if(this.store.options.autoAnchor&&this.hoverType===k.Node){const e=$e(this.drawingLine),i=ze(this.store.hover,t);return e.x=i.x,e.y=i.y,this.drawingLine.autoTo=!0,We(this.store.hover,i,this.drawingLine,e),this.drawline(),void this.finishDrawline(!0)}}if(this.hoverType===k.LineAnchor&&this.store.hover&&this.store.active[0]&&"line"===this.store.active[0].name&&this.store.active[0]!==this.store.hover){const e=this.store.active[0],i=qe(e),n=$e(e);if(this.store.hoverAnchor){const o=this.store.hover,a=qe(o)===this.store.hoverAnchor,r=$e(o)===this.store.hoverAnchor,l=i===this.store.activeAnchor,c=n===this.store.activeAnchor;if((t.ctrlKey||t.altKey)&&o.type===s.Line&&(a||r)&&(l||c)){const t=o.calculative.worldAnchors.map(t=>({...t,penId:e.id}));a?t.shift():r&&t.pop(),(a&&l||r&&c)&&t.reverse(),l?(e.calculative.worldAnchors[0].connectTo=void 0,e.calculative.worldAnchors.unshift(...t)):c&&(e.calculative.worldAnchors[e.calculative.worldAnchors.length-1].connectTo=void 0,e.calculative.worldAnchors.push(...t)),this.delete([o]),this.render()}else this.store.activeAnchor&&(this.store.hoverAnchor.type===M.Line?H(this.store.activeAnchor,this.store.hoverAnchor,this.store):(this.store.activeAnchor.x=this.store.hoverAnchor.x,this.store.activeAnchor.y=this.store.hoverAnchor.y),We(this.store.hover,this.store.hoverAnchor,e,this.store.activeAnchor));this[e.lineName]&&"polyline"!==e.lineName&&this[e.lineName](this.store,e),this.store.path2dMap.set(e,V.path2dDraws.line(e)),this.initLineRect(e)}else i===this.store.activeAnchor&&e.autoFrom?this.calcAutoAnchor(e,i,this.store.hover):n===this.store.activeAnchor&&e.autoTo&&this.calcAutoAnchor(e,n,this.store.hover)}if(this.addCaches&&this.addCaches.length){if(!this.store.data.locked){if(this.dragRect&&1===this.addCaches.length){const e=this.addCaches[0];e.width=this.dragRect.width/this.store.data.scale,e.height=this.dragRect.height/this.store.data.scale,t.x=(this.dragRect.x+this.dragRect.ex)/2,t.y=(this.dragRect.y+this.dragRect.ey)/2}this.dropPens(this.addCaches,t)}this.addCaches=void 0}if(this.hoverType===k.Rotate&&(this.getSizeCPs(),this.store.active.forEach(t=>{t.rotate=t.calculative.rotate})),this.patchFlagsLines.forEach(t=>{t.type&&this.initLineRect(t)}),this.patchFlagsLines.clear(),this.dragRect)if(this.canvasImage.fitFlag)this.makeFit();else{const e=this.store.data.pens.filter(e=>!(!1===e.visible||e.locked>=a.DisableMove||e.parentId||e.isRuleLine)&&(Fi(e.calculative.worldRect,this.dragRect,t.ctrlKey||this.store.options.dragAllIn)?!(e.type===s.Line&&!this.store.options.dragAllIn)||kn(e,this.dragRect):void 0));this.active(e)}if(2!==t.button&&(N(this.mouseDown,t)<2&&(this.store.hover&&this.store.hover.input&&(this.store.hover.onShowInput?this.store.hover.onShowInput(this.store.hover,t):(this.store.hover.parentId&&this.active([this.store.hover]),this.showInput(this.store.hover))),this.store.emitter.emit("click",{x:t.x,y:t.y,pen:this.store.hover})),this.store.hover&&(this.store.hover.calculative.mouseDown=!1),this.store.hover!=this.store.hoverContainer&&this.store.emitter.emit("mouseup",{x:t.x,y:t.y,pen:this.store.hover}),this.store.emitter.emit("mouseup",{x:t.x,y:t.y,pen:this.store.hoverContainer})),this.willInactivePen){this.willInactivePen.calculative.active=void 0,Qe(this.willInactivePen,!1);const t=this.store.active.findIndex(t=>t===this.willInactivePen);t>=0&&this.store.active.splice(t,1),this.calcActiveRect(),this.willInactivePen=void 0,this.store.emitter.emit("inactive",[this.willInactivePen]),this.render()}this.movingPens&&(t.altKey&&!t.shiftKey?this.copyMovedPens():this.movedActivePens(t.ctrlKey&&t.shiftKey),this.getAllByPens(this.movingPens).forEach(t=>{this.store.pens[t.id]=void 0}),this.movingPens=void 0),this.store.active&&this.store.active[0]&&(this.store.active[0].calculative.h=void 0),this.mouseDown=void 0,this.lastOffsetX=0,this.lastOffsetY=0,this.clearDock(),this.dragRect=void 0,this.initActiveRect=void 0,this.render()}}else this.hoverType=k.None};addRuleLine(t){const{x:e,y:i,scale:n,origin:o}=this.store.data,a=t.x+e,r=t.y+i;let l=t.x,c=t.y,h=0,d=0,u=0,f=0;if(a<=r&&a<20)l=-e,h=this.width,u=1,t.ctrlKey||(c=Math.round((c-o.y)/(10*n))*(10*n)+o.y);else{if(!(r<a&&r<20))return;c=-i,d=this.height,f=1,t.ctrlKey||(l=Math.round((l-o.x)/(10*n))*(10*n)+o.x)}this.addPen({isRuleLine:!0,type:s.Line,name:"line",lineName:"line",x:l,y:c,width:h,height:d,color:this.store.options.ruleLineColor,anchors:[{x:0,y:0},{x:u,y:f}]})}clearRuleLines(){this.delete(this.ruleLines)}get ruleLines(){return this.store.data.pens.filter(t=>t.isRuleLine)}alignPenToGrid(t){if(this.store.options.autoAlignGrid&&this.store.data.grid&&!t.type){const e=this.store.data.gridSize||this.store.options.gridSize,{origin:i,scale:n}=this.store.data,{x:o,y:s}=t,a={x:o,y:s},r=this.getPenRect(t),l=parseInt((r.x/e).toFixed())*e,c=parseInt((r.y/e).toFixed())*e;a.x=i.x+l*n,a.y=i.y+c*n,Object.assign(t,a),t.onMove?.(t),this.updatePenRect(t),this.calcActiveRect(),this.getSizeCPs()}}movedActivePens(t){let e=this.getAllFollowersByPens(this.store.active,!1);const i=dt(e,!0),n=this.store.data.gridSize||this.store.options.gridSize,{origin:o,scale:s}=this.store.data,a=this.store.options.autoAlignGrid&&(this.store.data.grid||this.store.options.grid);if(e.forEach(t=>{const e=this.movingPens.findIndex(e=>e.id===t.id+vo);if(e<0)return;const{x:i,y:r}=this.movingPens[e],l={x:i,y:r};if(a&&!this.movingPens[e].type){const t=this.getPenRect(this.movingPens[e]),i=parseInt((t.x/n).toFixed()),a=parseInt((t.y/n).toFixed()),r=i*n,c=a*n;l.x=o.x+r*s,l.y=o.y+c*s}Object.assign(t,l),t.onMove?.(t),this.updatePenRect(t),this.updateLines(t),this.store.emitter.emit("updateLines",t),this.patchFlagsLines.forEach(t=>{t.type&&this.initLineRect(t)}),this.patchFlagsLines.clear(),t.calculative.x=t.x,t.calculative.y=t.y,t.calculative.initRect&&(t.calculative.initRect.x=t.calculative.x,t.calculative.initRect.y=t.calculative.y,t.calculative.initRect.ex=t.calculative.x+t.calculative.width,t.calculative.initRect.ey=t.calculative.y+t.calculative.height),Ee(t),t.parentId&&this.parent.updateRectbyChild(t.calculative.worldRect,t,this.store.pens[t.parentId])}),this.initImageCanvas(this.store.active),this.initTemplateCanvas(this.store.active),!this.dock)return;const{xDock:r,yDock:l}=this.dock;let c;r&&(c=this.store.pens[r.penId]),!c&&l&&(c=this.store.pens[l.penId]);const h=dt(this.store.active,!0);if(t&&1===this.store.active.length&&1===c?.type&&(r?.anchorId||l?.anchorId)){const t=qe(c),e=$e(c);if(r?.anchorId){const n=this.store.pens[this.store.active[0].id+vo].calculative.worldAnchors.find(t=>t.id===r.anchorId);n.x===t.x&&n.y===t.y?(i.push(dt(c,!0)),We(this.store.active[0],n,c,t),h.push(dt(c,!0))):n.x===e.x&&n.y===e.y&&(i.push(dt(c,!0)),We(this.store.active[0],n,c,e),h.push(dt(c,!0)))}else if(l?.anchorId){const n=this.store.pens[this.store.active[0].id+vo].calculative.worldAnchors.find(t=>t.id===l.anchorId);n.x===t.x&&n.y===t.y?(i.push(dt(c,!0)),We(this.store.active[0],n,c,t),h.push(dt(c,!0))):n.x===e.x&&n.y===e.y&&(i.push(dt(c,!0)),We(this.store.active[0],n,c,e),h.push(dt(c,!0)))}}a&&(this.calcActiveRect(),this.getSizeCPs()),this.pushHistory({type:Z.Update,pens:h,initPens:i}),this.store.emitter.emit("translatePens",h)}copyMovedPens(){this.copy(this.store.active.map((t,e)=>{const{x:i,y:n}=this.movingPens[e];return this.updateLines(t),{...t,x:i,y:n}})),this.pasteOffset=!1,this.paste()}initImageCanvas(t){t.some(t=>this.hasImage(t,!1))&&this.canvasImage.init(),t.some(t=>this.hasImage(t,!0))&&this.canvasImageBottom.init()}initTemplateCanvas(t){t.some(t=>t.canvasLayer===c.CanvasTemplate)&&this.canvasTemplate.init()}hasImage(t,e){return t.image&&"gif"!==t.name?e?t.canvasLayer===c.CanvasImageBottom:t.canvasLayer===c.CanvasImage:t.children?.some(t=>{const i=this.store.pens[t];return i&&this.hasImage(i,e)})}clearDock=()=>{const t=this.dock?.xDock?.penId,e=this.dock?.yDock?.penId,i=this.store.pens[t];i&&(i.calculative.isDock=!1);const n=this.store.pens[e];n&&(n.calculative.isDock=!1),this.dock=void 0};inactive(t){if(!this.store.active.length)return;this.initTemplateCanvas(this.store.active),this.store.active.forEach(t=>{t.calculative.active=void 0,t.calculative.activeAnchor=void 0,t.calculative.hover=!1,Qe(t,!1)});const e=[...this.store.active];this.store.active=[],this.activeRect=void 0,this.sizeCPs=void 0,this.store.activeAnchor=void 0,this.patchFlags=!0,!t&&this.store.emitter.emit("inactive",e)}active(t,e=!0){if(this.store.active&&this.store.active.length){e&&this.store.emitter.emit("inactive",this.store.active);for(const t of this.store.active)t.calculative.active=void 0,t.calculative.hover=!1,Qe(t,!1)}this.store.active=[],t.forEach(t=>{t.calculative.active=!0,Qe(t)}),this.store.active.push(...t),this.activeRect=void 0,this.calcActiveRect(),this.initTemplateCanvas(t),this.patchFlags=!0,e&&this.store.emitter.emit("active",this.store.active)}getSizeCPs(){this.sizeCPs=Bi(this.activeRect);const{x:t,y:e,width:i,height:n,rotate:o,center:s}=this.activeRect;[{x:.5,y:0},{x:1,y:.5},{x:.5,y:1},{x:0,y:.5}].forEach(a=>{const r={x:a.x*i+t,y:a.y*n+e};L(r,o,s),this.sizeCPs.push(r)})}getSpecialAngle(t,e){let i=0;t.x-e.x!==0?(i=180*Math.atan((e.y-t.y)/(t.x-e.x))/Math.PI,t.x<e.x&&(i>0?i-=180:i+=180)):e.y>t.y?i=90:e.y<t.y&&(i=-90),i=15*Math.round(i/15);let n=Math.sqrt((e.x-t.x)*(e.x-t.x)+(e.y-t.y)*(e.y-t.y));t.x=e.x+Math.cos(i/180*Math.PI)*n,t.y=e.y-Math.sin(i/180*Math.PI)*n}onResize=()=>{this.timer&&clearTimeout(this.timer),this.timer=setTimeout(()=>{this.resize(),this.timer=void 0},100)};onScroll=()=>{this.timer&&clearTimeout(this.timer),this.timer=setTimeout(()=>{this.clientRect=this.canvas.getBoundingClientRect(),this.timer=void 0},100)};calibrateMouse=t=>(t.x-=this.store.data.x,t.y-=this.store.data.y,t);clearHover(){this.hoverType=k.None,this.store.hover=null,this.store.hoverAnchor=null}getContainerHover=t=>{if(this.dragRect)return;this.store.hoverContainer=void 0;const e=this.store.data.pens.filter(t=>t.container||this.store.options.containerShapes?.includes(t.name));if(e.length)for(let i=e.length-1;i>=0;--i){const n=e[i];if(0!=n.visible&&0!=n.calculative.inView&&n.locked!==a.Disable)if(Ii(t,n.calculative.worldRect))this.store.hoverContainer=n,n?.onMouseMove?.(n,t),this.store.lastHoverContainer!==this.store.hoverContainer&&(this.patchFlags=!0,this.store.lastHoverContainer&&(this.store.lastHoverContainer.calculative.containerHover=!1,this.store.emitter.emit("leave",this.store.lastHoverContainer)),this.store.hoverContainer&&(this.store.hoverContainer.calculative.containerHover=!0,this.store.emitter.emit("enter",this.store.hoverContainer)),this.store.lastHoverContainer=this.store.hoverContainer);else if(n===this.store.hoverContainer&&(this.store.hoverContainer=void 0,this.store.lastHoverContainer!==this.store.hoverContainer)){this.patchFlags=!0;const t=this.store.lastHoverContainer.calculative.canvas.store.pens[this.store.lastHoverContainer.id+vo];this.store.lastHoverContainer&&!t&&(this.store.lastHoverContainer.calculative.containerHover=!1,this.store.emitter.emit("leave",this.store.lastHoverContainer)),this.store.lastHoverContainer=this.store.hoverContainer}}};getHover=t=>{if(this.dragRect)return;if(this.canvasImage.fitFlag)return;let e=k.None;this.store.hover=void 0,this.store.hoverAnchor=void 0,this.title.hide(),this.store.pointAt=void 0,this.store.pointAtIndex=void 0;const i=1===this.store.active.length&&this.store.active[0].type;if(!this.drawingLineName&&this.hotkeyType!==T.AddAnchor&&this.activeRect&&!i&&!this.store.data.locked){const i=ii(this.store.active),n=ni(this.store.active)||this.store.options.disableRotate,o=si(this.store.active)||this.store.options.disableSize;if(!i&&!n){const i={x:this.activeRect.center.x,y:this.activeRect.y-30};this.activeRect.rotate&&L(i,this.activeRect.rotate,this.activeRect.pivot||this.activeRect.center),!this.hotkeyType&&D(t,i,this.pointSize)&&(e=k.Rotate,this.externalElements.style.cursor=`url("${this.store.options.rotateCursor}"), auto`)}if(!i&&!o)for(let i=0;i<8;i++){const n=i<4;if((this.hotkeyType===T.Resize||n&&!this.hotkeyType)&&D(t,this.sizeCPs[i],this.pointSize)){let t=n?R:S,o=0;Math.abs(this.activeRect.rotate%90-45)<25?(t=n?S:R,o=Math.round((this.activeRect.rotate-45)/90)+(n?0:1)):o=Math.round(this.activeRect.rotate/90),e=k.Resize,this.resizeIndex=i,this.externalElements.style.cursor=t[(i+o)%4];break}}}e===k.None&&(e=this.inPens(t,this.store.data.pens)),e||i||!Ii(t,this.activeRect)||(e=k.Node,this.externalElements.style.cursor="move"),this.hoverType=e,e===k.None&&(this.drawingLineName||this.pencil?this.externalElements.style.cursor="crosshair":this.mouseDown||(this.externalElements.style.cursor="default"),this.store.hover=void 0),this.store.lastHover!==this.store.hover&&(this.patchFlags=!0,this.store.lastHover&&(this.store.lastHover.calculative.hover=!1,Ze(Vt(this.store.lastHover,!0)||this.store.lastHover,!1),this.store.emitter.emit("leave",this.store.lastHover),this.tooltip.hide()),this.store.hover&&(this.store.hover.calculative.hover=!0,Ze(Vt(this.store.hover,!0)||this.store.hover),this.store.emitter.emit("enter",this.store.hover),this.tooltip.show(this.store.hover,t)),this.store.lastHover=this.store.hover),this.store.hover?.onMouseMove?.(this.store.hover,this.mousePos)};inPens=(t,e)=>{let i=k.None;t:for(let n=e.length-1;n>=0;--n){const o=e[n];if(0==o.visible||0==o.calculative.inView||o.locked===a.Disable)continue;const r=gn(o);if(o.calculative.active||Ei(t,o.calculative.worldRect,r)||Ii(t,o.calculative.worldRect)){if(!this.store.data.locked&&this.hotkeyType!==T.Resize&&o.calculative.worldAnchors)for(const e of o.calculative.worldAnchors)if(i=this.inAnchor(t,o,e),i){let i=dt(e);Object.assign(i,t),this.title.show(i,o);break t}if(o.type){if(o.isRuleLine){let e=this.store.options.ruleOptions?.height||20;if(t.x+this.store.data.x>e&&t.y+this.store.data.y>e)break}const e=mn(t,o);if(e){this.store.data.locked||o.locked?this.externalElements.style.cursor=this.store.options.hoverCursor:this.hotkeyType===T.AddAnchor?this.externalElements.style.cursor="pointer":this.externalElements.style.cursor="move",o.calculative.disabled&&(this.externalElements.style.cursor="not-allowed"),this.store.hover=o,this.store.pointAt=e.point,this.store.pointAtIndex=e.i,this.initTemplateCanvas([this.store.hover]),i=k.Line;break}}else{if(o.children){const e=[];if(o.children.forEach(t=>{this.store.pens[t]&&e.push(this.store.pens[t])}),i=this.inPens(t,e),i)break}let e=!1;if(e="line"===o.name?Ei(t,o.calculative.worldRect,o.lineWidth):Ii(t,o.calculative.worldRect),e){if(o.type===s.Node&&"line"===o.name&&!Ki(t,o.calculative.worldAnchors))continue;if(this.store.data.locked||o.locked?this.externalElements.style.cursor=this.store.options.hoverCursor:this.hotkeyType===T.AddAnchor?this.externalElements.style.cursor="pointer":this.externalElements.style.cursor="move",o.calculative.disabled&&(this.externalElements.style.cursor="not-allowed"),this.store.hover=o,this.initTemplateCanvas([this.store.hover]),i=k.Node,this.store.pointAt=t,!t.ctrlKey){let{x:e,y:i,ex:n,ey:o,rotate:s,center:a}=this.store.hover.calculative.worldRect;if(s){const r=[{x:e,y:i},{x:n,y:i},{x:n,y:o},{x:e,y:o}];r.forEach(t=>{L(t,s,a)});let l=r[r.length-1];for(const e of r){if(l.y>t.y!=e.y>t.y){const i=e.x+(t.y-e.y)*(l.x-e.x)/(l.y-e.y);Math.abs(i-this.store.pointAt.x)<10&&(this.store.pointAt.x=i)}l=e}}else this.store.pointAt.x-10<e?this.store.pointAt.x=e:this.store.pointAt.x+10>n&&(this.store.pointAt.x=n),this.store.pointAt.y-10<i?this.store.pointAt.y=i:this.store.pointAt.y+10>o&&(this.store.pointAt.y=o)}break}}}}return i};dockInAnchor=t=>{this.store.hover=void 0;for(let e=this.store.data.pens.length-1;e>=0;--e){const i=this.store.data.pens[e];if(0==i.visible||i.locked===a.Disable||i===this.store.active[0])continue;let n=gn(i);if(n+=2*this.store.options.anchorRadius,Ei(t,i.calculative.worldRect,n)&&(this.store.hover=i,this.hotkeyType!==T.Resize&&i.calculative.worldAnchors))for(const e of i.calculative.worldAnchors){if(e.twoWay===_.In){const t=$e(this.store.active[0]);if(this.store.activeAnchor.id!==t.id)continue}if(e.twoWay===_.Out){const t=qe(this.store.active[0]);if(this.store.activeAnchor.id!==t.id)continue}if(e.twoWay!==_.DisableConnected&&e.twoWay!==_.Disable&&this.store.activeAnchor?.twoWay!==_.DisableConnectTo&&this.store.activeAnchor?.twoWay!==_.Disable&&(this.title.hide(),this.inAnchor(t,i,e))){let n=dt(e);return Object.assign(n,t),this.title.show(n,i),!0}}}};inAnchor(t,e,i){if(this.store.hoverAnchor=void 0,this.movingAnchor=void 0,!i||i.locked>a.DisableEdit)return k.None;if((!e.type||!e.calculative.active)&&this.store.options.disableAnchor||e.disableAnchor)return k.None;if((this.mouseDown||this.drawingLine)&&"line"===e.name&&i.connectTo){const t=this.findOne(i.connectTo);if(t?.calculative&&!t?.calculative.active){e=t;const n=t.calculative.worldAnchors.find(t=>t.id===i.anchorId);n&&(i=n)}}if(i.twoWay===_.Disable&&"line"!==e.name)return k.None;if("line"===e.name&&i.connectTo){let t=this.findOne(i.connectTo)?.anchors.find(t=>t.id===i.anchorId);if(t&&t.twoWay)return k.None}if(this.drawingLine){if(i.twoWay===_.Out)return k.None}else if(this.mouseDown&&this.hoverType===k.LineAnchor);else if(i.twoWay===_.In)return k.None;if(D(t,i,this.pointSize,i.penId?this.store.pens[i.penId]:void 0))return i!==this.store.hoverAnchor&&(this.patchFlags=!0),this.store.hoverAnchor=i,this.store.hover=e,e.type?i.connectTo&&!e.calculative.active&&(this.store.hover=this.store.pens[i.connectTo],this.store.hover)?(this.store.hoverAnchor=this.store.hover.calculative.worldAnchors.find(t=>t.id===i.anchorId),this.store.hoverAnchor?(this.externalElements.style.cursor="crosshair",k.NodeAnchor):k.None):(this.hotkeyType===T.AddAnchor?this.externalElements.style.cursor="vertical-text":this.externalElements.style.cursor="pointer",k.LineAnchor):(this.hotkeyType===T.AddAnchor?this.externalElements.style.cursor="vertical-text":this.externalElements.style.cursor="crosshair",k.NodeAnchor);if(!this.mouseDown&&e.type){if(e.calculative.active&&i.prev&&D(t,i.prev,this.pointSize))return this.store.hoverAnchor=i,this.store.hover=e,this.externalElements.style.cursor="pointer",k.LineAnchorPrev;if(e.calculative.active&&i.next&&D(t,i.next,this.pointSize))return this.store.hoverAnchor=i,this.store.hover=e,this.externalElements.style.cursor="pointer",k.LineAnchorNext}return k.None}resize(t,e){t=t||this.parentElement.clientWidth,e=e||this.parentElement.clientHeight,this.width=t,this.height=e,this.canvasRect={x:0,y:0,width:t,height:e},Mi(this.canvasRect),this.canvas.style.width=t+"px",this.canvas.style.height=e+"px",this.externalElements.style.width=t+"px",this.externalElements.style.height=e+"px",this.canvasTemplate.resize(t,e),this.canvasImage.resize(t,e),this.canvasImageBottom.resize(t,e),this.magnifierCanvas.resize(t,e),t=t*this.store.dpiRatio|0,e=e*this.store.dpiRatio|0,this.canvas.width=t,this.canvas.height=e,this.offscreen.width=t,this.offscreen.height=e,this.clientRect=this.externalElements.getBoundingClientRect(),this.canvas.getContext("2d").scale(this.store.dpiRatio,this.store.dpiRatio),this.offscreen.getContext("2d").scale(this.store.dpiRatio,this.store.dpiRatio),this.offscreen.getContext("2d").textBaseline="middle";for(const t of this.store.data.pens)t.isRuleLine&&(t.width?t.height||(t.width=this.width):t.height=this.height,this.updatePenRect(t)),li(t);this.render()}clearCanvas(){this.activeRect=void 0,this.sizeCPs=void 0,this.canvas.getContext("2d").clearRect(0,0,this.canvas.width,this.canvas.height),this.offscreen.getContext("2d").clearRect(0,0,this.offscreen.width,this.offscreen.height),this.store.data.template||this.canvasTemplate.clear(),this.canvasImage.clear(),this.canvasImageBottom.clear()}async addPen(t,e,i,n){if(!(this.beforeAddPens&&1!=await this.beforeAddPens([t])||this.beforeAddPen&&1!=this.beforeAddPen(t)))return n&&(t.x=t.x*this.store.data.scale+this.store.data.origin.x,t.y=t.y*this.store.data.scale+this.store.data.origin.y,t.width=t.width*this.store.data.scale,t.height=t.height*this.store.data.scale),this.makePen(t),this.active([t]),this.render(),i&&this.store.emitter.emit("add",[t]),e&&this.pushHistory({type:Z.Add,pens:[t]}),t}pushHistory(t){if(this.store.data.locked)return;const{origin:e,scale:i}=this.store.data;t.origin=dt(e),t.scale=i,t.type!==Z.Update&&t.pens&&t.pens.forEach(t=>{t.calculative&&(t.calculative.layer=this.store.data.pens.findIndex(e=>e.id===t.id))}),this.store.historyIndex<this.store.histories.length-1&&this.store.histories.splice(this.store.historyIndex+1,this.store.histories.length-this.store.historyIndex-1),t.pens?.forEach(e=>{let i;if(t.initPens)for(const n of t.initPens)n.id===e.id&&(i=n);if(i)for(const t in e)null==i[t]&&(i[t]=void 0)}),this.store.histories.push(t),this.store.historyIndex=this.store.histories.length-1,this.store.emitter.emit("update",{previous:t.initPens,current:t.pens})}undo(){if(this.store.data.locked||null==this.store.historyIndex||this.store.historyIndex<0)return;const t=this.store.histories[this.store.historyIndex--];this.doEditAction(t,!0);let e=t.step;for(;e>1;){const t=this.store.histories[this.store.historyIndex--];this.doEditAction(t,!0),e--}t.type!=Z.Add&&t.type!=Z.Delete&&t.type!=Z.Update||this.activeHistory()}redo(){if(this.store.data.locked||null==this.store.historyIndex||this.store.historyIndex>this.store.histories.length-2)return;const t=this.store.histories[++this.store.historyIndex];this.doEditAction(t,!1);let e=t.step;for(;e>1;){const t=this.store.histories[++this.store.historyIndex];this.doEditAction(t,!1),e--}t.type!=Z.Add&&t.type!=Z.Delete&&t.type!=Z.Update||this.activeHistory()}activeHistory(){let t=this.store.histories[this.store.historyIndex+1];const e=[];if(t&&t.type===Z.Update)return t.pens.forEach(t=>{e.push(this.store.pens[t.id])}),void this.active(e);let i=this.store.histories[this.store.historyIndex];!i||i.type!==Z.Add&&i.type!==Z.Delete||(i.pens.forEach(t=>{e.push(this.store.pens[t.id])}),this.active(e))}doEditAction(t,e){switch(this.inactive(),this.store.hoverAnchor=void 0,this.store.hover=void 0,t.type){case Z.Add:t.pens.forEach(t=>{const e=dt(t,!0),i=this.store.data.pens.findIndex(t=>t.id===e.id);i>-1&&(e.onDestroy?.(this.store.pens[e.id]),this.store.data.pens.splice(i,1),this.store.pens[e.id]=void 0,e.calculative||(e.calculative={}),e.calculative.canvas=this,this.store.animates.delete(e),this.store.animateMap.delete(e))}),t.type=Z.Delete;break;case Z.Update:const i=e?t.initPens:t.pens,n=e?t.pens:t.initPens;i.forEach(e=>{const i=dt(e,!0),o=this.store.data.pens.findIndex(t=>t.id===i.id);if(o>-1){if(i.calculative=this.store.data.pens[o].calculative,this.store.data.pens[o].type&&this.store.data.pens[o].lastConnected)for(let t in this.store.data.pens[o].lastConnected)if(this.store.pens[t]){let e=dt(this.store.data.pens[o].lastConnected[t]);this.store.pens[t].connectedLines=e,i.anchors.forEach(i=>{e.forEach(e=>{i.id===e.lineAnchor&&(i.connectTo=t)})})}this.store.data.pens[o]=i,this.store.pens[i.id]=i;for(const t in i)"object"==typeof i[t]&&"lineDash"!==t||(i.calculative[t]=i[t]);i.calculative.image=void 0;const e=this.getPenRect(i,t.origin,t.scale);if(this.setPenRect(i,e,!1),this.updateLines(i,!0),i.calculative.canvas.parent.isCombine(i)){let t=n.find(t=>t.id===i.id);I.forEach(e=>{i[e]!==t[e]&&this.parent.setValue({id:i.id,[e]:i[e]},{render:!0,doEvent:!1})})}}});break;case Z.Delete:t.pens.reverse().forEach(t=>{const e=dt(t,!0);if(e.calculative||(e.calculative={}),this.store.data.pens.splice(-1!==e.calculative?.layer?e.calculative?.layer:this.store.data.pens.length,0,e),this.store.pens[e.id]=e,e.type&&e.lastConnected)for(let t in e.lastConnected)this.store.pens[t]&&(this.store.pens[t].connectedLines=e.lastConnected[t]);e.calculative.canvas=this}),t.pens.reverse().forEach(e=>{const i=this.store.pens[e.id],n=this.getPenRect(i,t.origin,t.scale);this.setPenRect(i,n,!1),i.calculative.image=void 0,i.calculative.backgroundImage=void 0,i.calculative.strokeImage=void 0,this.loadImage(i)}),t.type=Z.Add;break;case Z.Replace:{const i=e?t.initPens:t.pens;(e?t.pens:t.initPens).forEach(t=>{const e=dt(t,!0);if(this.store.data.pens.findIndex(t=>t.id===e.id)>-1){e.onDestroy?.(this.store.data.pens.find(t=>t.id===e.id));const t=this.store.data.pens.findIndex(t=>t.id===e.id);this.store.data.pens.splice(t,1),this.store.pens[e.id]=void 0,e.calculative||(e.calculative={}),e.calculative.canvas=this,this.store.animates.delete(e),this.store.animateMap.delete(e)}}),i.reverse().forEach(t=>{const e=dt(t,!0);if(e.calculative||(e.calculative={}),this.store.data.pens.splice(-1!==e.calculative?.layer?e.calculative?.layer:this.store.data.pens.length,0,e),this.store.pens[e.id]=e,e.type&&e.lastConnected)for(let t in e.lastConnected)this.store.pens[t]&&(this.store.pens[t].connectedLines=e.lastConnected[t]);e.calculative.canvas=this}),i.reverse().forEach(e=>{const i=this.store.data.pens.find(t=>t.id===e.id),n=this.getPenRect(i,t.origin,t.scale);this.setPenRect(i,n,!1),i.calculative.image=void 0,i.calculative.backgroundImage=void 0,i.calculative.strokeImage=void 0,this.loadImage(i)}),t.type=Z.Replace;break}}if(t.type===Z.Update){let e=[...t.pens,...t.initPens];this.initImageCanvas(e),this.initTemplateCanvas(e)}else this.initImageCanvas(t.pens),this.initTemplateCanvas(t.pens);this.parent.onSizeUpdate(),this.render(),this.store.emitter.emit(e?"undo":"redo",t)}makePen(t){if(t.id||(t.id=Ct()),Math.abs(this.store.lastScale-this.store.data.scale)<1e-4&&this.store.sameTemplate&&this.store.templatePens[t.id]&&t.canvasLayer===c.CanvasTemplate)return t=this.store.templatePens[t.id],this.store.data.pens.push(t),void this.updatePenRect(t);if(t.copyIndex?(this.store.data.pens.splice(t.copyIndex+1,0,t),delete t.copyIndex):this.store.data.pens.push(t),this.store.pens[t.id]=t,t.path){!t.pathId&&(t.pathId=Ct());const e=this.store.data.paths;!e[t.pathId]&&(e[t.pathId]=t.path),t.path=void 0}null==t.lineWidth&&(t.lineWidth=1);const{fontSize:e,lineHeight:i}=this.store.options;t.fontSize?t.fontSize<0&&(t.fontSize=0):t.fontSize=e>=0?e:12,t.lineHeight||(t.lineHeight=i),t.image&&"gif"!==t.name&&void 0===t.canvasLayer&&(t.isBottom?t.canvasLayer=c.CanvasImageBottom:t.canvasLayer=c.CanvasImage,delete t.isBottom),t.template&&(t.canvasLayer=c.CanvasTemplate),t.calculative={canvas:this,singleton:t.calculative?.singleton},(t.video||t.audio)&&(t.calculative.onended=t=>{this.nextAnimate(t)});for(const e in t)"object"==typeof t[e]&&"lineDash"!==e||(t.calculative[e]=t[e]);if(t.calculative.image=void 0,t.calculative.backgroundImage=void 0,t.calculative.strokeImage=void 0,!t.anchors&&V.anchors[t.name]&&(t.anchors||(t.anchors=[]),V.anchors[t.name](t)),!t.anchors){const e=dt(this.store.options.defaultAnchors);e.forEach((e,i)=>{e.id=`${i}`,e.penId=t.id}),t.anchors=e}this.updatePenRect(t),!t.anchors&&t.calculative.worldAnchors&&(t.anchors=t.calculative.worldAnchors.map(e=>$i(e,t.calculative.worldRect))),!t.rotate&&(t.rotate=0),t.lineAnimateImages??=[],t.lineAnimateImages&&t.lineAnimateImages.forEach(t=>{this.__loadImage(t)}),this.loadImage(t),this.parent.penNetwork(t)}drawline(t){this.drawingLine&&(this[this.drawingLineName]?.(this.store,this.drawingLine,t),this.store.path2dMap.set(this.drawingLine,V.path2dDraws.line(this.drawingLine)),this.patchFlags=!0)}initLineRect(t){if(!t)return;if(!t.calculative.worldAnchors?.length)return void this._del([t]);if(!isFinite(t.x)||!isFinite(t.x))return;if(null==t.x||null==t.y)return;const e=pn(t);t.parentId||Object.assign(t,e);const{fontSize:i,lineHeight:n}=this.store.options;t.fontSize||(t.fontSize=i>=0?i:12,t.calculative.fontSize=t.fontSize*this.store.data.scale),t.lineHeight||(t.lineHeight=n,t.calculative.lineHeight=t.lineHeight),_i(e),t.calculative.worldRect=e,Se(t,e),nt(t),li(t),t.calculative&&(t.calculative.gradientAnimatePath=void 0),this.store.path2dMap.set(t,V.path2dDraws[t.name](t)),t.calculative.worldAnchors&&(t.anchors=t.calculative.worldAnchors.map(e=>$i(e,t.calculative.worldRect)))}drawingPencil(){ao(this.store),this.pencil=!0,this.externalElements.style.cursor="crosshair"}stopPencil(){this.pencil=!1,this.pencilLine=void 0,this.externalElements.style.cursor="default"}async finishDrawline(t){if(!this.drawingLine)return;const e=qe(this.drawingLine);let i=$e(this.drawingLine);if(i.isTemp&&(this.drawingLine.calculative.worldAnchors.pop(),i=$e(this.drawingLine)),!t&&(!i.connectTo&&this.drawingLine.calculative.worldAnchors.pop(),qe(this.drawingLine)===this.drawingLine.calculative.activeAnchor))return this.drawingLine=void 0,void this.render();if(e.connectTo&&i.connectTo){if(this.store.options.disableRepeatLine&&this.store.data.pens.find(t=>{if(t.type){const n=qe(t),o=$e(t);return j(n,e)&&j(o,i)}}))return this.drawingLine=void 0,void this.render()}else if(this.store.options.disableEmptyLine)return e.connectTo&&(this.store.pens[e.connectTo].connectedLines=this.store.pens[e.connectTo].connectedLines.filter(t=>t.lineId!==this.drawingLine.id)),this.drawingLine=void 0,void this.render();const n=pn(this.drawingLine);Object.assign(this.drawingLine,n),this.drawingLine.calculative.worldRect=n,this.drawingLine.calculative.activeAnchor=$e(this.drawingLine),this.store.activeAnchor=this.drawingLine.calculative.activeAnchor,(!this.beforeAddPens||await this.beforeAddPens([this.drawingLine]))&&(!this.beforeAddPen||this.beforeAddPen(this.drawingLine))&&(this.initLineRect(this.drawingLine),this.store.data.pens.push(this.drawingLine),this.store.pens[this.drawingLine.id]=this.drawingLine,this.store.emitter.emit("add",[this.drawingLine]),this.active([this.drawingLine]),this.pushHistory({type:Z.Add,pens:dt([this.drawingLine],!0)})),this.store.path2dMap.set(this.drawingLine,V.path2dDraws[this.drawingLine.name](this.drawingLine)),this.drawingLine=void 0,this.drawingLineName=void 0,this.render()}async finishPencil(){if(this.pencilLine){const t=_n(this.pencilLine.calculative.worldAnchors,10,0,this.pencilLine.calculative.worldAnchors.length-1);let e=qe(this.pencilLine);t.unshift({id:e.id,penId:e.penId,x:e.x,y:e.y}),e=$e(this.pencilLine),t.push({id:e.id,penId:e.penId,x:e.x,y:e.y}),this.pencilLine.calculative.worldAnchors=function(t,e=.8,i=!1){if(t.length<3)return t;let n,o,s,a,r,l,c,h,d,u,f,p,v,g,y,m;const w=(t,e,i,n)=>(a=Math.sqrt(t*t+e*e),a>0?(v=t/a,y=e/a):(v=1,y=0),r=Math.sqrt(i*i+n*n),r>0?(g=i/r,m=n/r):(g=1,m=0),Math.acos(v*g+y*m));f=[],p=t.length,n=t[0],h=t[p-1],f.push({...t[0]});for(let h=0;h<p-1;h++){if(o=t[h],s=t[h+1],u=Math.abs(w(o.x-n.x,o.y-n.y,s.x-o.x,s.y-o.y)),a)if(u<3.14*e)if(i&&(a=Math.min(a,r),r=a),l=(v+g)/2,c=(y+m)/2,d=Math.sqrt(l*l+c*c),0===d)f.push({...o});else{l/=d,c/=d;const t={...o};t.prevNextType=E.Bilateral,t.prev={penId:t.penId,x:o.x-l*a*.25,y:o.y-c*a*.25},t.next={penId:t.penId,x:o.x+l*r*.25,y:o.y+c*r*.25},f.push(t)}else f.push({...o});n=o}return f.push({...t[t.length-1]}),f}(t),this.pencilLine.calculative.worldAnchors.length>1&&(this.pencilLine.calculative.pencil=!1,this.store.path2dMap.set(this.pencilLine,V.path2dDraws[this.pencilLine.name](this.pencilLine)),(!this.beforeAddPens||await this.beforeAddPens([this.pencilLine]))&&(!this.beforeAddPen||this.beforeAddPen(this.pencilLine))&&(this.initLineRect(this.pencilLine),this.store.data.pens.push(this.pencilLine),this.store.pens[this.pencilLine.id]=this.pencilLine,this.store.emitter.emit("add",[this.pencilLine]),this.active([this.pencilLine]),this.pushHistory({type:Z.Add,pens:dt([this.pencilLine],!0)}))),this.pencilLine=void 0,this.render()}}firefoxLoadSvg(t){const e=new Image,i=new XMLHttpRequest;i.open("GET",t.image,!0),i.onload=()=>{const n=(new DOMParser).parseFromString(i.responseText,"text/xml").getElementsByTagName("svg")[0],{width:o,height:s}=t.calculative.worldRect;n.setAttribute("width",`${o}px`),n.setAttribute("height",`${s}px`);const a="data:image/svg+xml;base64,"+btoa(unescape(encodeURIComponent((new XMLSerializer).serializeToString(n))));e.src=a,e.onload=()=>{t.calculative.img=e,t.calculative.imgNaturalWidth=e.naturalWidth||t.iconWidth,t.calculative.imgNaturalHeight=e.naturalHeight||t.iconHeight,V.htmlElements[t.image]=e,this.imageLoaded(),t.canvasLayer===c.CanvasTemplate&&this.templateImageLoaded()}},i.send()}loadImage(t){if(t.image!==t.calculative.image||!t.calculative.img){if(t.calculative.img=void 0,t.image)if(V.htmlElements[t.image]){const e=V.htmlElements[t.image];t.calculative.img=e,t.calculative.imgNaturalWidth=e.naturalWidth||t.iconWidth,t.calculative.imgNaturalHeight=e.naturalHeight||t.iconHeight,this.imageLoaded(),t.canvasLayer===c.CanvasTemplate&&this.templateImageLoaded()}else if(navigator.userAgent.includes("Firefox")&&t.image.endsWith(".svg"))this.firefoxLoadSvg(t);else{const e=new Image;e.crossOrigin="undefined"===t.crossOrigin?void 0:t.crossOrigin||"anonymous",e.src=t.image,this.store.options.cdn&&!(t.image.startsWith("http")||t.image.startsWith("//")||t.image.startsWith("data:image"))&&(e.src=this.store.options.cdn+t.image),e.onload=()=>{t.calculative.img=e,t.calculative.imgNaturalWidth=e.naturalWidth||t.iconWidth,t.calculative.imgNaturalHeight=e.naturalHeight||t.iconHeight,V.htmlElements[t.image]=e,this.imageLoaded(),t.canvasLayer===c.CanvasTemplate&&this.templateImageLoaded()}}t.calculative.image=t.image}if(t.backgroundImage!==t.calculative.backgroundImage){if(t.calculative.backgroundImg=void 0,t.backgroundImage)if(V.htmlElements[t.backgroundImage]){const e=V.htmlElements[t.backgroundImage];t.calculative.backgroundImg=e}else{const e=new Image;e.crossOrigin="anonymous",e.src=t.backgroundImage,this.store.options.cdn&&!(t.backgroundImage.startsWith("http")||t.backgroundImage.startsWith("//")||t.backgroundImage.startsWith("data:image"))&&(e.src=this.store.options.cdn+t.backgroundImage),e.onload=()=>{t.calculative.backgroundImg=e,V.htmlElements[t.backgroundImage]=e,this.imageLoaded(),t.canvasLayer===c.CanvasTemplate&&this.templateImageLoaded()}}t.calculative.backgroundImage=t.backgroundImage}if(t.strokeImage!==t.calculative.strokeImage){if(t.calculative.strokeImg=void 0,t.strokeImage)if(V.htmlElements[t.strokeImage]){const e=V.htmlElements[t.strokeImage];t.calculative.strokeImg=e}else{const e=new Image;e.crossOrigin="anonymous",e.src=t.strokeImage,this.store.options.cdn&&!(t.strokeImage.startsWith("http")||t.strokeImage.startsWith("//")||t.strokeImage.startsWith("data:image"))&&(e.src=this.store.options.cdn+t.strokeImage),e.onload=()=>{t.calculative.strokeImg=e,V.htmlElements[t.strokeImage]=e,this.imageLoaded(),t.canvasLayer===c.CanvasTemplate&&"gif"!==t.name&&this.templateImageLoaded()}}t.calculative.strokeImage=t.strokeImage}}__loadImage(t){return new Promise(e=>{if(V.htmlElements[t])e(V.htmlElements[t]);else{const i=new Image;i.crossOrigin="anonymous",i.src=t,this.store.options.cdn&&!(t.startsWith("http")||t.startsWith("//")||t.startsWith("data:image"))&&(i.src=this.store.options.cdn+t),i.onload=()=>{V.htmlElements[t]=i,e(i)}}})}imageTimer;imageLoaded(){this.imageTimer&&clearTimeout(this.imageTimer),this.imageTimer=setTimeout(()=>{this.canvasImage.init(),this.canvasImageBottom.init(),this.render()},100)}templateImageTimer;templateImageLoaded(){this.templateImageTimer&&clearTimeout(this.templateImageTimer),this.templateImageTimer=setTimeout(()=>{this.canvasTemplate.init(),this.render()},100)}setCalculativeByScale(t){const e=this.store.data.scale;t.calculative.lineWidth=t.lineWidth*e,t.calculative.fontSize=t.fontSize*e,t.calculative.letterSpacing=(t.letterSpacing||0)*e,t.fontSize<1&&t.fontSize>0&&(t.calculative.fontSize=t.fontSize*t.calculative.worldRect.height),t.calculative.iconSize=t.iconSize*e,t.calculative.iconWidth=t.iconWidth*e,t.calculative.iconHeight=t.iconHeight*e,t.calculative.iconLeft=t.iconLeft<1&&t.iconLeft>-1?t.iconLeft:t.iconLeft*e,t.calculative.iconTop=t.iconTop<1&&t.iconTop>-1?t.iconTop:t.iconTop*e,t.calculative.textWidth=t.textWidth<1&&t.textWidth>-1?t.textWidth:t.textWidth*e,t.calculative.textHeight=t.textHeight<1&&t.textHeight>-1?t.textHeight:t.textHeight*e,t.calculative.textLeft=t.textLeft<1&&t.textLeft>-1?t.textLeft*t.calculative.worldRect.width:t.textLeft*e,t.calculative.textTop=t.textTop<1&&t.textTop>-1?t.textTop*t.calculative.worldRect.height:t.textTop*e,t.type===s.Line&&t.borderWidth&&(t.calculative.borderWidth=t.borderWidth*e)}updatePenRect(t,{worldRectIsReady:e,playingAnimate:i}={}){e?Pe(t):Re(t),i||this.setCalculativeByScale(t),Ie(t),Me(this.store.pens,t),nt(t),li(t),V.path2dDraws[t.name]&&this.store.path2dMap.set(t,V.path2dDraws[t.name](t)),t.calculative.patchFlags=!0,this.patchFlags=!0,t.children&&t.children.forEach(t=>{const e=this.store.pens[t];e&&this.updatePenRect(e,{worldRectIsReady:!1})}),t.type&&this.initLineRect(t),(t.gradientColors||t.lineGradientColors)&&(t.calculative.gradientTimer&&clearTimeout(t.calculative.gradientTimer),t.calculative.gradientTimer=setTimeout(()=>{t.calculative.lineGradient&&(t.calculative.lineGradient=null),t.calculative.gradient&&(t.calculative.gradient=null),t.calculative.radialGradient&&(t.calculative.radialGradient=null),this.patchFlags=!0,t.calculative.gradientTimer=void 0},50))}initGlobalStyle(){if(this.store.options.themeOnlyCanvas||this.store.data.themeOnlyCanvas)return;const t={},e={},i={};G.forEach(n=>{if(null!=this.store.options[n]&&""!==this.store.options[n]&&(t[n]=this.store.options[n]),null!=this.store.data[n]&&""!==this.store.data[n]&&(e[n]=this.store.data[n]),this.store.data.theme){const t=this.store.theme[this.store.data.theme]?.[n];null!=t&&""!==t&&(i[n]=t)}}),this.store.styles={};const n=Q.getThemeObj(this.store.data.theme);Object.assign(this.store.styles,t,e,i,n)}render=t=>{if(t&&(this.opening=!1),this.opening)return;let e;if(null==t||!0===t||t===1/0?(e=performance.now(),this.patchFlags=!0):e=t>1?t:performance.now(),!this.patchFlags)return;if(e-this.lastRender<this.store.options.interval)return this.renderTimer&&cancelAnimationFrame(this.renderTimer),void(this.renderTimer=requestAnimationFrame(this.render));this.renderTimer=void 0,this.lastRender=e;const i=this.offscreen.getContext("2d");i.clearRect(0,0,this.offscreen.width,this.offscreen.height),i.save(),i.translate(this.store.data.x,this.store.data.y),globalThis.debugRender&&console.time("renderPens"),this.renderPens(),globalThis.debugRender&&console.timeEnd("renderPens"),this.renderBorder(),this.renderHoverPoint(),i.restore(),this.magnifierCanvas.magnifier&&this.magnifierCanvas.render();const n=this.canvas.getContext("2d");n.clearRect(0,0,this.canvas.width,this.canvas.height),n.drawImage(this.offscreen,0,0,this.width,this.height),this.canvasTemplate.render(),this.canvasImageBottom.render(),this.canvasImage.render(),this.patchFlags=!1};renderPens=()=>{const t=this.offscreen.getContext("2d");t.strokeStyle=this.store.styles.color;for(const e of this.store.data.pens)isFinite(e.x)&&e.canvasLayer!==c.CanvasTemplate&&e.calculative.inView&&(e.canvasLayer===c.CanvasMain&&"gif"!==e.name&&e.image&&e.calculative.img&&(t.save(),fe(t,e),(e.rotateByRoot||e.calculative.rotate)&&pe(t,e),ci(t,e),ae(t,e),t.restore()),ve(t,e));this.drawingLine&&ve(t,this.drawingLine),this.pencilLine&&ve(t,this.pencilLine),this.movingPens&&this.movingPens.forEach(e=>{this.renderPenContainChild(t,e)})};renderPenContainChild=(t,e)=>{e.calculative.inView&&ve(t,e),e.children?.forEach(e=>{const i=this.store.pens[e];i&&this.renderPenContainChild(t,i)})};renderBorder=()=>{if(!this.store.data.locked&&this.activeRect&&(1!==this.store.active.length||!this.store.active[0].type)&&!this.movingPens){const t=this.offscreen.getContext("2d");t.save(),t.translate(.5,.5);const e=this.activeRect.pivot||this.activeRect.center;if(this.activeRect.rotate&&(t.translate(e.x,e.y),t.rotate(this.activeRect.rotate*Math.PI/180),t.translate(-e.x,-e.y)),t.strokeStyle=this.store.styles.activeColor,t.globalAlpha=void 0===this.store.options.activeGlobalAlpha?.3:this.store.options.activeGlobalAlpha,t.beginPath(),t.lineWidth=this.store.options.activeLineWidth||1,t.setLineDash(this.store.options.activeLineDash||[]),t.strokeRect(this.activeRect.x,this.activeRect.y,this.activeRect.width,this.activeRect.height),t.setLineDash([]),t.lineWidth=1,t.globalAlpha=1,ii(this.store.active)||ni(this.store.active)||this.store.options.disableRotate)return void t.restore();t.beginPath(),t.moveTo(this.activeRect.center.x,this.activeRect.y),t.lineTo(this.activeRect.center.x,this.activeRect.y-30),t.stroke(),t.beginPath(),t.strokeStyle=this.store.styles.activeColor,t.fillStyle="#ffffff",t.arc(this.activeRect.center.x,this.activeRect.y-30,5,0,2*Math.PI),t.fill(),t.stroke(),t.restore()}};renderHoverPoint=()=>{if(this.store.data.locked)return;const t=this.offscreen.getContext("2d");if(t.save(),t.translate(.5,.5),!this.store.options.disableAnchor&&this.store.hover&&!this.store.hover.disableAnchor&&(this.hotkeyType!==T.Resize||1!==this.store.active.length||this.store.active[0]!==this.store.hover)){const e=[...this.store.hover.calculative.worldAnchors];this.store.pointAt&&this.hotkeyType===T.AddAnchor&&e.push(this.store.pointAt),e&&(t.strokeStyle=this.store.hover.anchorColor||this.store.styles.anchorColor,t.fillStyle=this.store.hover.anchorBackground||this.store.options.anchorBackground,e.forEach(e=>{if(e.hidden&&e.locked>a.DisableEdit)return;if(e===this.store.hoverAnchor){t.save();const e=this.store.hover.hoverAnchorColor||this.store.options.hoverAnchorColor;t.strokeStyle=e,t.fillStyle=e}t.beginPath();let i=e.radius||this.store.hover.anchorRadius||this.store.options.anchorRadius;if(!this.store.hover.type||e.radius||this.store.hover.anchorRadius||(i=3,this.store.hover.calculative.lineWidth>3&&(i=this.store.hover.calculative.lineWidth)),e.type===M.Line){let n=this.store.pens[e.penId].rotate||0;this.store.pens[e.penId].calculative.flipX&&(n*=-1),this.store.pens[e.penId].calculative.flipY&&(n*=-1);let o=e.rotate+n;this.store.pens[e.penId].calculative.flipX&&(o*=-1),this.store.pens[e.penId].calculative.flipY&&(o*=-1),t.save(),t.translate(e.x,e.y),t.rotate(o*Math.PI/180),t.translate(-e.x,-e.y),t.rect(e.x-e.length*this.store.data.scale/2,e.y-i,e.length*this.store.data.scale,2*i),t.restore()}else t.arc(e.x,e.y,i,0,2*Math.PI);if(this.store.hover.type&&this.store.hoverAnchor===e?(t.save(),t.strokeStyle=this.store.hover.activeColor||this.store.styles.activeColor,t.fillStyle=t.strokeStyle):(e.color||e.background)&&(t.save(),t.strokeStyle=e.color,t.fillStyle=e.background),t.fill(),t.stroke(),e===this.store.hoverAnchor&&t.restore(),(this.store.hover.type&&this.store.hoverAnchor===e||e.color||e.background)&&t.restore(),!this.store.hover.parentId&&this.store.hover.children&&this.store.hover.children.length>0&&e===this.store.hoverAnchor){t.save(),t.beginPath(),t.lineWidth=3;const n=this.store.hover.hoverAnchorColor||this.store.options.hoverAnchorColor;globalThis.pSBC&&(t.strokeStyle=globalThis.pSBC(.5,n)),t.arc(e.x,e.y,i+1.5,0,2*Math.PI),t.stroke(),t.restore()}}))}this.hotkeyType===T.AddAnchor||this.movingPens||!this.activeRect||1===this.store.active.length&&this.store.active[0].type||ii(this.store.active)||si(this.store.active)||this.store.options.disableSize||(t.strokeStyle=this.store.styles.activeColor,t.fillStyle="#ffffff",this.sizeCPs.forEach((e,i)=>{this.activeRect.rotate&&(t.save(),t.translate(e.x,e.y),t.rotate(this.activeRect.rotate*Math.PI/180),t.translate(-e.x,-e.y)),(i<4||this.hotkeyType===T.Resize)&&(t.beginPath(),t.fillRect(e.x-4.5,e.y-4.5,8,8),t.strokeRect(e.x-5.5,e.y-5.5,10,10)),this.activeRect.rotate&&t.restore()})),!this.store.data.locked&&this.dragRect&&(t.save(),t.fillStyle=mt(this.store.options.dragColor,.2),t.strokeStyle=this.store.options.dragColor,t.beginPath(),t.strokeRect(this.dragRect.x,this.dragRect.y,this.dragRect.width,this.dragRect.height),t.fillRect(this.dragRect.x,this.dragRect.y,this.dragRect.width,this.dragRect.height),t.restore()),this.dock&&(t.strokeStyle=this.store.options.dockColor,this.dock.xDock&&(t.beginPath(),t.moveTo(this.dock.xDock.x,this.dock.xDock.y),t.lineTo(this.dock.xDock.x,this.dock.xDock.prev.y),t.stroke()),this.dock.yDock&&(t.beginPath(),t.moveTo(this.dock.yDock.x,this.dock.yDock.y),t.lineTo(this.dock.yDock.prev.x,this.dock.yDock.y),t.stroke())),t.restore()};transTimeout;translate(t=0,e=0){if(this.store.data.x+=t*this.store.data.scale,this.store.data.y+=e*this.store.data.scale,this.store.data.x=Math.round(this.store.data.x),this.store.data.y=Math.round(this.store.data.y),this.store.options.padding){let t=St(this.store.options.padding);const e=this.store.data.width||this.store.options.width,i=this.store.data.height||this.store.options.height;this.width<(e+t[1]+t[3])*this.store.data.scale&&(this.store.data.x+this.store.data.origin.x>t[3]*this.store.data.scale&&(this.store.data.x=t[3]*this.store.data.scale-this.store.data.origin.x),this.store.data.x+this.store.data.origin.x+e*this.store.data.scale<this.width-t[1]*this.store.data.scale&&(this.store.data.x=this.width-t[1]*this.store.data.scale-(this.store.data.origin.x+e*this.store.data.scale))),this.height<(i+t[0]+t[2])*this.store.data.scale&&(this.store.data.y+this.store.data.origin.y>t[0]*this.store.data.scale&&(this.store.data.y=t[0]*this.store.data.scale-this.store.data.origin.y),this.store.data.y+this.store.data.origin.y+i*this.store.data.scale<this.height-t[2]*this.store.data.scale&&(this.store.data.y=this.height-t[2]*this.store.data.scale-(this.store.data.origin.y+i*this.store.data.scale)))}this.store.data.asyncTranslate?(clearTimeout(this.transTimeout),this.transTimeout=setTimeout(()=>{this.canvasTemplate.init(),this.canvasImage.init(),this.canvasImageBottom.init(),this.render()},300)):(this.canvasTemplate.init(),this.canvasImage.init(),this.canvasImageBottom.init(),this.render()),this.store.emitter.emit("translate",{x:this.store.data.x,y:this.store.data.y}),this.tooltip.translate(t,e),this.scroll&&this.scroll.isShow&&this.scroll.translate(t,e),this.onMovePens()}onMovePens(){const t=this.parent.map;t&&t.isShow&&t.setView();for(const t of this.store.data.pens)li(t),t.onMove?.(t),t.isRuleLine&&(t.width?t.height||(t.x=-this.store.data.x):t.y=-this.store.data.y,this.updatePenRect(t))}scale(t,e={x:0,y:0}){const i=this.store.data.minScale||this.store.options.minScale,n=this.store.data.maxScale||this.store.options.maxScale;if(!(t>=i&&t<=n))return;this.calibrateMouse(e);const o=t/this.store.data.scale;this.store.data.scale=t,this.store.data.center=e,this.store.clipboard?.pos&&O(this.store.clipboard.pos,o,e),O(this.store.data.origin,o,e),this.store.data.pens.forEach(t=>{if(t.onScale&&t.onScale(t),!t.parentId){if(Le(t,o,e),t.isRuleLine){const e=1/o,i=t.calculative.worldRect.center;t.width&&t.height||Le(t,e,i)}this.updatePenRect(t,{worldRectIsReady:!0}),this.execPenResize(t)}}),this.onMovePens(),this.calcActiveRect(),this.canvasTemplate.init(),this.canvasImage.init(),this.canvasImageBottom.init();const s=this.parent.map;s&&s.isShow&&s.setView(),this.render(),this.store.emitter.emit("scale",this.store.data.scale)}templateScale(t,e={x:0,y:0}){const{minScale:i,maxScale:n}=this.store.options;if(!(t>=i&&t<=n))return;const o=t/this.store.data.scale;this.store.data.scale=t,this.store.data.center={x:0,y:0},this.store.data.origin={x:0,y:0},this.store.data.pens.forEach(t=>{if(!t.parentId){if(Le(t,o,e),t.onScale&&t.onScale(t),t.isRuleLine){const e=o>1?1:1/o/o,i=t.calculative.worldRect.center;t.width&&t.height||Le(t,e,i)}this.execPenResize(t)}}),this.calcActiveRect()}rotatePens(t){this.initPens||(this.initPens=dt(this.getAllByPens(this.store.active))),this.activeRect.rotate=B(t,this.activeRect.center),this.activeRect.rotate%90<10&&(this.activeRect.rotate-=this.activeRect.rotate%90),this.activeRect.rotate%90>80&&(this.activeRect.rotate+=90-this.activeRect.rotate%90),1===this.store.active.length&&(this.lastRotate=this.store.active[0].rotate||0);const e=this.activeRect.rotate-this.lastRotate;for(const t of this.store.active){if(t.parentId)return;this.rotatePen(t,e,this.activeRect),t.onRotate&&t.onRotate(t),this.updateLines(t)}this.lastRotate=this.activeRect.rotate,this.getSizeCPs(),this.initImageCanvas(this.store.active),this.initTemplateCanvas(this.store.active),this.render(),this.store.emitter.emit("rotatePens",this.store.active),this.timer&&clearTimeout(this.timer),this.timer=setTimeout(()=>{this.timer=void 0,this.pushHistory({type:Z.Update,pens:dt(this.getAllByPens(this.store.active)),initPens:this.initPens}),this.initPens=void 0},200)}resizePens(t){if(this.initPens||(this.initPens=dt(this.store.active,!0)),!this.initActiveRect)return void(this.initActiveRect=dt(this.activeRect));const e=this.mouseDown.x,i=this.mouseDown.y;let n=t.x-e,o=t.y-i;const s=dt(this.initActiveRect);if(Vi(s,n,o,this.resizeIndex),_i(s),!this.store.options.disableDock){this.clearDock();const t=this.customResizeDock||bi;this.dock=t(this.store,s,this.store.active,this.resizeIndex);const{xDock:e,yDock:i}=this.dock;e&&(n+=e.step,this.store.pens[e.penId].calculative.isDock=!0),i&&(o+=i.step,this.store.pens[i.penId].calculative.isDock=!0)}const a=this.activeRect.width,r=this.activeRect.height;let l=n-this.lastOffsetX,c=o-this.lastOffsetY;if(this.lastOffsetX=n,this.lastOffsetY=o,(t.ctrlKey||1===this.initPens.length&&this.initPens[0].ratio)&&(c=([1,3].includes(this.resizeIndex)?-1:1)*(l*r)/a),this.activeRect.ratio=this.initPens[0].ratio,Vi(this.activeRect,l,c,this.resizeIndex),this.store.options.strictScope){const t=this.store.data.width||this.store.options.width,e=this.store.data.height||this.store.options.height;if(t&&e){let i={x:this.store.data.origin.x,y:this.store.data.origin.y,width:t*this.store.data.scale,height:e*this.store.data.scale};this.activeRect.x<i.x&&(this.activeRect.width=this.activeRect.width-(i.x-this.activeRect.x),this.activeRect.x=i.x),this.activeRect.y<i.y&&(this.activeRect.height=this.activeRect.height-(i.y-this.activeRect.y),this.activeRect.y=i.y),this.activeRect.x+this.activeRect.width>i.x+i.width&&(this.activeRect.width=this.activeRect.width-(this.activeRect.x+this.activeRect.width-(i.x+i.width)),this.activeRect.x=i.x+i.width-this.activeRect.width,this.activeRect.ex=this.activeRect.x+this.activeRect.width),this.activeRect.y+this.activeRect.height>i.y+i.height&&(this.activeRect.height=this.activeRect.height-(this.activeRect.y+this.activeRect.height-(i.y+i.height)),this.activeRect.y=i.y+i.height-this.activeRect.height,this.activeRect.ey=this.activeRect.y+this.activeRect.height)}}_i(this.activeRect);const h=this.activeRect.width/a,d=this.activeRect.height/r;this.store.active.forEach((t,e)=>{t.calculative.worldRect.x=this.activeInitPos[e].x*this.activeRect.width+this.activeRect.x,t.calculative.worldRect.y=this.activeInitPos[e].y*this.activeRect.height+this.activeRect.y,t.calculative.worldRect.width*=h,t.calculative.iconWidth&&(t.calculative.iconWidth*=h),t.calculative.worldRect.height*=d,t.calculative.iconHeight&&(t.calculative.iconHeight*=d),Mi(t.calculative.worldRect),_i(t.calculative.worldRect),this.updatePenRect(t,{worldRectIsReady:!0}),this.execPenResize(t),this.updateLines(t)}),this.getSizeCPs(),this.initImageCanvas(this.store.active),this.initTemplateCanvas(this.store.active),this.render(),this.store.emitter.emit("resizePens",this.store.active),this.timer&&clearTimeout(this.timer),this.timer=setTimeout(()=>{this.timer=void 0,this.pushHistory({type:Z.Update,pens:dt(this.store.active,!0),initPens:this.initPens}),this.initPens=void 0},200)}movePens(t){if(!this.activeRect||this.store.data.locked)return;if(!this.initActiveRect)return void(this.initActiveRect=dt(this.activeRect));if(!this.store.options.moveConnectedLine&&!this.canMoveLine&&1===this.store.active.length&&(this.store.active[0].anchors[0]?.connectTo||this.store.active[0].anchors[this.store.active[0].anchors.length-1]?.connectTo))return;if(this.movingPens||(this.initMovingPens(),this.store.active.forEach(t=>{Ze(t,!1)}),this.store.hover=void 0),!this.mouseDown)return;let e=t.x-this.mouseDown.x,i=t.y-this.mouseDown.y;t.shiftKey&&!t.ctrlKey&&(i=0),t.ctrlKey&&(e=0);const n=dt(this.initActiveRect);Hi(n,e,i);let o=!1;if(this.store.options.strictScope){const t=this.store.data.width||this.store.options.width,e=this.store.data.height||this.store.options.height;if(t&&e){let i={x:this.store.data.origin.x,y:this.store.data.origin.y,width:t*this.store.data.scale,height:e*this.store.data.scale};n.x<i.x&&(n.x=i.x,o=!0),n.y<i.y&&(n.y=i.y,o=!0),n.x+n.width>i.x+i.width&&(n.x=i.x+i.width-n.width,o=!0),n.y+n.height>i.y+i.height&&(n.y=i.y+i.height-n.height,o=!0)}}const s={x:n.x-this.activeRect.x,y:n.y-this.activeRect.y};if(!this.store.options.disableDock&&!o){this.clearDock();const t=this.customMoveDock||wi;this.dock=t(this.store,n,this.movingPens,s);const{xDock:e,yDock:i}=this.dock;let o;e&&(s.x+=e.step,o=this.store.pens[e.penId],o.calculative.isDock=!0),i&&(s.y+=i.step,o=this.store.pens[i.penId],o.calculative.isDock=!0)}this.translatePens(this.movingPens,s.x,s.y,!0)}changeIdsByMoving(t,e){t.id+=vo,t.parentId&&e.find(e=>e.id===t.parentId)&&(t.parentId+=vo),t.children&&(t.children=t.children.map(t=>t+vo)),t.connectedLines&&(t.connectedLines=t.connectedLines.map(t=>(e.find(e=>e.id===t.lineId)&&(t.lineId+=vo),t))),t.type&&t.calculative.worldAnchors&&(t.calculative.worldAnchors=t.calculative.worldAnchors.map(t=>(t.connectTo&&e.find(e=>e.id===t.connectTo)&&(t.connectTo+=vo),t)))}initMovingPens(){if(!this.store.options.moveConnectedLine&&!this.canMoveLine)for(let t=0;t<this.store.active.length;t++){const e=this.store.active[t];(e.anchors[0]?.connectTo||e.anchors[e.anchors.length-1]?.connectTo)&&(this.store.active.splice(t,1),e.calculative.active=void 0,--t)}this.movingPens=dt(this.store.active,!0),this.movingPens=this.getAllFollowersByPens(this.movingPens);const t=this.getAllByPens(this.movingPens),e=dt(t,!0);t.forEach(t=>{this.changeIdsByMoving(t,e),this.store.pens[t.id]=t,t.calculative.canvas=this;const i={globalAlpha:.5};0===t.lineWidth&&(i.lineWidth=1),(t.name.endsWith("Dom")||y.includes(t.name)||this.store.options.domShapes.includes(t.name)||t.image)&&(i.name="rectangle",i.onDestroy=void 0),this.updateValue(t,i),t.calculative.image=void 0})}moveLineAnchor(t,e){if(!this.activeRect||this.store.data.locked)return;if(this.initPens||(this.initPens=dt(this.store.active,!0)),this.store.activeAnchor?.connectTo){const t=this.store.pens[this.store.activeAnchor.connectTo];Ve(t,Ue(t,this.store.activeAnchor.anchorId),this.store.pens[this.store.activeAnchor.penId],this.store.activeAnchor)}let i=this.store.activeAnchor?.id,n=this.store.pens[this.store.activeAnchor.penId]?.connectedLines?.filter(t=>t.anchor===i);n&&n.length>0&&n.forEach(t=>{const e=this.store.pens[t.lineId];Ve(this.store.pens[this.store.activeAnchor.penId],this.store.activeAnchor,e,Ue(e,t.lineAnchor))});const o=this.store.active[0],s=(qe(o),$e(o));if("polyline"!==o.lineName||e.shiftKey){let i=0,n=0;if("line"===o.lineName){let s=o.calculative.worldAnchors.findIndex(t=>t.id===this.store.activeAnchor.id);0===s&&(s=2);let a=o.calculative.worldAnchors[s-1];if(e.ctrlKey&&e.shiftKey){let e=dt(t);this.getSpecialAngle(e,a),i=e.x-this.store.activeAnchor.x,n=e.y-this.store.activeAnchor.y}else if(!e.ctrlKey&&e.shiftKey){let e={x:t.x,y:a.y};i=e.x-this.store.activeAnchor.x,n=e.y-this.store.activeAnchor.y}else if(e.ctrlKey&&!e.shiftKey){let e={x:a.x,y:t.y};i=e.x-this.store.activeAnchor.x,n=e.y-this.store.activeAnchor.y}else i=t.x-this.store.activeAnchor.x,n=t.y-this.store.activeAnchor.y}else!e.ctrlKey&&e.shiftKey?(i=t.x-this.store.activeAnchor.x,n=0):e.ctrlKey&&!e.shiftKey?(i=0,n=t.y-this.store.activeAnchor.y):(i=t.x-this.store.activeAnchor.x,n=t.y-this.store.activeAnchor.y);z(this.store.activeAnchor,i,n),this.store.hover&&this.store.hoverAnchor&&this.store.hoverAnchor.penId!==this.store.activeAnchor.penId&&(this.store.hoverAnchor.type===M.Line?(i=t.x-this.store.activeAnchor.x,n=t.y-this.store.activeAnchor.y,H(this.store.activeAnchor,this.store.hoverAnchor,this.store)):(i=this.store.hoverAnchor.x-this.store.activeAnchor.x,n=this.store.hoverAnchor.y-this.store.activeAnchor.y),z(this.store.activeAnchor,i,n),s.prev=void 0,"polyline"!==o.lineName&&this[o.lineName]?.(this.store,o))}else!function(t,e,i){if(!t.calculative.worldAnchors)return;const n=t.calculative.worldAnchors.findIndex(t=>t.id===e.id),o=qe(t),s=$e(t);let a=t.calculative.worldAnchors[n-1],r=t.calculative.worldAnchors[n+1];if(null==t.calculative.h&&(o.connectTo&&(In(t,e,!0)?t.calculative.h=!0:En(t,e,!0)&&(t.calculative.h=!1)),null==t.calculative.h&&s.connectTo&&(In(t,e,!1)?t.calculative.h=!0:En(t,e,!1)&&(t.calculative.h=!1)),null==t.calculative.h&&(a?t.calculative.h=a.y===e.y:r&&(t.calculative.h=r.y===e.y))),t.calculative.h){if(e.x=i.x,o.connectTo&&In(t,e,!0))return void(r&&r.y!==e.y&&(r.x=e.x));if(s.connectTo&&In(t,e,!1))return void(a&&a.y!==e.y&&(a.x=e.x));const l=t.anchors[n];let c;for(let e=n-1;e>-1;e--)if(a=t.anchors[e],null==c&&(c=a.y===l.y),!0===c){if(a.y!==l.y)break;t.calculative.worldAnchors[e].y=i.y}else{if(a.x!==l.x)break;t.calculative.worldAnchors[e].x=i.x}c=void 0;for(let e=n+1;e<t.calculative.worldAnchors.length&&(r=t.anchors[e],r);e++)if(null==c&&(c=r.y===l.y),!0===c){if(r.y!==l.y)break;t.calculative.worldAnchors[e].y=i.y}else{if(r.x!==l.x)break;t.calculative.worldAnchors[e].x=i.x}e.y=i.y}else{if(e.y=i.y,o.connectTo&&En(t,e,!0))return void(r&&r.x!==e.x&&(r.y=e.y));if(s.connectTo&&En(t,e,!1))return void(a&&a.x!==e.x&&(a.y=e.y));const l=t.anchors[n];let c;for(let e=n-1;e>-1;e--)if(a=t.anchors[e],null==c&&(c=a.x===l.x),!0===c){if(a.x!==l.x)break;t.calculative.worldAnchors[e].x=i.x}else{if(a.y!==l.y)break;t.calculative.worldAnchors[e].y=i.y}c=void 0;for(let e=n+1;e<t.calculative.worldAnchors.length&&(r=t.anchors[e],r);e++)if(null==c&&(c=r.x===l.x),!0===c){if(r.x!==l.x)break;t.calculative.worldAnchors[e].x=i.x}else{if(r.y!==l.y)break;t.calculative.worldAnchors[e].y=i.y}e.x=i.x}}(o,this.store.activeAnchor,t);this.patchFlagsLines.add(o),this.store.path2dMap.set(o,V.path2dDraws[o.name](o)),this.render(),this.store.active[0].calculative&&(this.store.active[0].calculative.gradientAnimatePath=void 0),this.store.emitter.emit("moveLineAnchor",{pen:this.store.active[0],anchor:this.store.activeAnchor}),this.timer&&clearTimeout(this.timer),this.timer=setTimeout(()=>{this.timer=void 0,this.pushHistory({type:Z.Update,pens:dt(this.store.active,!0),initPens:this.initPens}),this.initPens=void 0},500)}moveLineAnchorPrev(t){if(!this.activeRect||this.store.data.locked||!this.store.activeAnchor)return;if(this.initPens||(this.initPens=dt(this.store.active,!0)),this.store.activeAnchor.prev.x=t.x,this.store.activeAnchor.prev.y=t.y,this.store.activeAnchor.next)if(this.store.activeAnchor.prevNextType){if(this.store.activeAnchor.prevNextType===E.Bilateral&&this.prevAnchor){const e=B(t,this.store.activeAnchor),i=B(this.prevAnchor,this.store.activeAnchor);this.store.activeAnchor.next.x=this.nextAnchor.x,this.store.activeAnchor.next.y=this.nextAnchor.y,L(this.store.activeAnchor.next,e-i,this.store.activeAnchor)}}else this.store.activeAnchor.next.x=t.x,this.store.activeAnchor.next.y=t.y,L(this.store.activeAnchor.next,180,this.store.activeAnchor);const e=this.store.active[0];this.patchFlagsLines.add(e),this.store.path2dMap.set(e,V.path2dDraws[e.name](e)),this.render(),this.timer&&clearTimeout(this.timer),this.timer=setTimeout(()=>{this.timer=void 0,this.pushHistory({type:Z.Update,pens:dt(this.store.active,!0),initPens:this.initPens}),this.initPens=void 0},200)}moveLineAnchorNext(t){if(!this.activeRect||this.store.data.locked||!this.store.activeAnchor)return;if(this.initPens||(this.initPens=dt(this.store.active,!0)),this.store.activeAnchor.next.x=t.x,this.store.activeAnchor.next.y=t.y,this.store.activeAnchor.prev)if(this.store.activeAnchor.prevNextType){if(this.store.activeAnchor.prevNextType===E.Bilateral&&this.nextAnchor){const e=B(t,this.store.activeAnchor),i=B(this.nextAnchor,this.store.activeAnchor);this.store.activeAnchor.prev.x=this.prevAnchor.x,this.store.activeAnchor.prev.y=this.prevAnchor.y,L(this.store.activeAnchor.prev,e-i,this.store.activeAnchor)}}else this.store.activeAnchor.prev.x=t.x,this.store.activeAnchor.prev.y=t.y,L(this.store.activeAnchor.prev,180,this.store.activeAnchor);const e=this.store.active[0];this.patchFlagsLines.add(e),this.store.path2dMap.set(e,V.path2dDraws[e.name](e)),this.render(),this.timer&&clearTimeout(this.timer),this.timer=setTimeout(()=>{this.timer=void 0,this.pushHistory({type:Z.Update,pens:dt(this.store.active,!0),initPens:this.initPens}),this.initPens=void 0},200)}async setAnchor(t){const e=[dt(this.store.hover,!0)],i=this.store.hover;if(this.store.hoverAnchor){if(this.beforeRemoveAnchor&&!await this.beforeRemoveAnchor(i,this.store.hoverAnchor))return;i.type===s.Line&&i.calculative.worldAnchors?.length<=2?this.delete([i]):(Ne(i,this.store.hoverAnchor),i.type===s.Line&&this.initLineRect(i)),this.store.hoverAnchor=void 0,this.store.activeAnchor=void 0,this.externalElements.style.cursor="default"}else if(i){if(this.beforeAddAnchor&&!await this.beforeAddAnchor(i,this.store.pointAt))return;if(i.type===s.Line){this.store.activeAnchor=Be(i,this.store.pointAt,this.store.pointAtIndex),this.initLineRect(i);const e={x:t.x,y:t.y};this.getHover(e)}else{const e={id:Ct(),x:t.x,y:t.y};this.store.activeAnchor=Oe(i,e)}}this.hotkeyType=T.None,this.render(),i&&this.pushHistory({type:Z.Update,pens:[dt(i,!0)],initPens:e})}checkDisconnect(t,e){if(t.id.indexOf(vo)>0){const e=t.id;t=this.store.pens[e.replace(vo,"")]}t.anchors.forEach(i=>{if(i.connectTo&&!e.find(t=>t.id===i.connectTo||t.id===i.connectTo+vo)){const e=this.store.pens[i.connectTo];if(!e||e.type)return;Ve(e,Ue(e,i.anchorId),t,i)}})}translatePens(t=this.store.active,e,i,n){if(!t||!t.length)return;if(t.some(t=>{if(t.locked>=a.DisableMove)return!0}))return;const o=!n&&dt(t,!0);this.activeRect&&Hi(this.activeRect,e,i);const r=this.getAllByPens(t);t.forEach(t=>{if(!(t.locked>=a.DisableMove)){if(t.type===s.Line){if(!this.store.options.moveConnectedLine&&!this.canMoveLine)return;if(t.isRuleLine)return;je(t,e,i),this.checkDisconnect(t,r),this.store.path2dMap.set(t,V.path2dDraws[t.name](t)),n||(this.initLineRect(t),t.connectedLines?.forEach(t=>{const e=this.store.pens[t.lineId];this.initLineRect(e)}))}else Hi(t.calculative.worldRect,e,i),this.updatePenRect(t,{worldRectIsReady:!0}),t.calculative.x=t.x,t.calculative.y=t.y,t.calculative.initRect&&(t.calculative.initRect.x=t.calculative.x,t.calculative.initRect.y=t.calculative.y,t.calculative.initRect.ex=t.calculative.x+t.calculative.width,t.calculative.initRect.ey=t.calculative.y+t.calculative.height);this.updateLines(t),t.onMove?.(t)}}),this.activeRect&&this.getSizeCPs(),this.render(),this.tooltip.translate(e,i),n||(this.pushHistory({type:Z.Update,pens:dt(t,!0),initPens:o}),this.initImageCanvas(t),this.initTemplateCanvas(t),this.store.emitter.emit("translatePens",t)),this.store.emitter.emit("translatingPens",t)}templateTranslatePens(t=this.store.active,e,i){if(!t||!t.length)return;const n=this.getAllByPens(t);t.forEach(t=>{if(t.type===s.Line){if(!this.store.options.moveConnectedLine&&!this.canMoveLine)return;je(t,e,i),this.checkDisconnect(t,n),this.store.path2dMap.set(t,V.path2dDraws[t.name](t))}else Hi(t.calculative.worldRect,e,i),this.updatePenRect(t,{worldRectIsReady:!0}),t.calculative.x=t.x,t.calculative.y=t.y,t.calculative.initRect&&(t.calculative.initRect.x=t.calculative.x,t.calculative.initRect.y=t.calculative.y,t.calculative.initRect.ex=t.calculative.x+t.calculative.width,t.calculative.initRect.ey=t.calculative.y+t.calculative.height);t.onMove?.(t)})}calcAutoAnchor(t,e,i,n){const o=qe(t),s=$e(t),a=ze(i,e===o?s:o);a&&(e.x=a.x,e.y=a.y,e.prev=void 0,e.next=void 0,n?n.anchor=a.id:We(i,a,t,e),this[t.lineName]&&this[t.lineName](this.store,t),this.store.path2dMap.set(t,V.path2dDraws.line(t)),this.initLineRect(t))}restoreNodeAnimate(t){if(t.calculative.initRect){if(t.keepAnimateState)for(const e in t)void 0!==t.calculative[e]&&("x"===e||"y"===e||"width"===e||"height"===e||"initRect"===e||"object"==typeof t[e]&&"lineDash"!==e||(t[e]="fontSize"===e||"lineWidth"===e?t.calculative[e]/t.calculative.canvas.store.data.scale:t.calculative[e]));else{const e=t.calculative.initRect.rotate-t.calculative.rotate;for(const e in t)"x"===e||"y"===e||"width"===e||"height"===e||"initRect"===e||"rotate"===e||"object"==typeof t[e]&&"lineDash"!==e||(t.calculative[e]=t[e]);t.children?.length?e&&oi(t,e,t.calculative.worldRect):t.calculative.rotate=t.rotate;const i=dt(this.store.animateMap.get(t));i&&(i.id=t.id,this.parent.setValue(i,{doEvent:!1,render:!0,history:!1})),t.calculative.worldRect=t.calculative.initRect}this.updatePenRect(t,{worldRectIsReady:!0}),this.updateLines(t),t.image&&"gif"!==t.name&&(this.canvasImage.init(),this.canvasImageBottom.init()),t.calculative.text!==t.text&&(t.calculative.text=t.text,st(t)),this.store.active?.length&&this.calcActiveRect(),t.calculative.initRect=void 0}}updateLines(t,e){t.children?.forEach(t=>{const i=this.store.pens[t];i&&this.updateLines(i,e)}),t.connectedLines&&t.connectedLines.forEach((i,n)=>{const o=this.store.pens[i.lineId];if(!o||o.calculative.active)return;const s=Ue(o,i.lineAnchor);if(!s)return;if(!s.connectTo)return void t.connectedLines.splice(n,1);if(o.autoFrom){const e=qe(o);e.id===s.id&&this.calcAutoAnchor(o,e,t,i)}if(o.autoTo){const e=$e(o);e.id===s.id&&this.calcAutoAnchor(o,e,t,i)}const a=Ue(t,i.anchor);if(!a)return;let r=t.rotate;t.flipX&&(r*=-1),t.flipY&&(r*=-1);let l=s.distance*this.store.data.scale*Math.cos((r+a.rotate)/180*Math.PI)||0,c=s.distance*this.store.data.scale*Math.sin((r+a.rotate)/180*Math.PI)||0;if(t.flipX&&(l=-l),t.flipY&&(c=-c),z(s,a.x-s.x+l,a.y-s.y+c),this.store.options.autoPolyline&&!this.autoPolylineFlag&&!1!==o.autoPolyline&&"polyline"===o.lineName){let t=qe(o),e=$e(o),i=!1;t.id===s.id?(t=s,i=!0):e.id===s.id&&(e=s,i=!0),i&&(o.calculative.worldAnchors=[t,e],o.calculative.activeAnchor=t,this.polyline(this.store,o,e),this.initLineRect(o))}this.store.path2dMap.set(o,V.path2dDraws[o.name](o)),this.patchFlagsLines.add(o),o.calculative.gradientSmooth&&(o.calculative.gradientAnimatePath=ee(o)),e&&bn(o)})}calcActiveRect(){const t=this.store.active.filter(t=>(!t.locked||t.locked<a.DisableMove)&&0!=t.visible);t.length&&(1===t.length?(this.activeRect=dt(t[0].calculative.worldRect),this.activeRect.rotate=t[0].calculative.rotate||0,_i(this.activeRect)):(this.activeRect=Oi(t),this.activeRect.rotate=0),this.lastRotate=0,this.getSizeCPs())}rotatePen(t,e,i){t.rotateByRoot||("line"===t.name?(t.calculative.worldAnchors.forEach(t=>{L(t,e,i.center)}),this.initLineRect(t),Pe(t)):(t.calculative.rotate?t.calculative.rotate+=e:t.calculative.rotate=e,L(t.calculative.worldRect.center,e,i.center),t.parentId?(t.calculative.worldRect.x=t.calculative.worldRect.center.x-t.calculative.worldRect.width/2,t.calculative.worldRect.y=t.calculative.worldRect.center.y-t.calculative.worldRect.height/2,t.x=(t.calculative.worldRect.x-i.x)/i.width,t.y=(t.calculative.worldRect.y-i.y)/i.height):(t.x=t.calculative.worldRect.center.x-t.width/2,t.y=t.calculative.worldRect.center.y-t.height/2),t.rotate=t.calculative.rotate,this.updatePenRect(t),t.children&&t.children.forEach(i=>{const n=this.store.pens[i];this.rotatePen(n,e,t.calculative.worldRect)})))}nextAnimate(t){if(!t)return;let e;this.store.emitter.emit("animateEnd",t),t.nextAnimate&&(e=this.store.data.pens.filter(e=>e.id===t.nextAnimate||e.tags&&e.tags.indexOf(t.nextAnimate)>-1)),e&&(e.forEach(t=>{if(t.calculative.pause){const e=Date.now()-t.calculative.pause;t.calculative.pause=void 0,t.calculative.frameStart+=e,t.calculative.frameEnd+=e}else if("video"===t.name)t.calculative.media.currentTime=0,t.calculative.media?.play(),t.onStartVideo?.(t);else if(t.type||t.frames?.length||t.animations&&t.animations.length){if(t.type){if(t.animations?.length){const e=dt(t.animations[0]);delete e.name,e.currentAnimation=0,this.parent.setValue({id:t.id,...e},{doEvent:!1,history:!1})}}else{if(!t.frames&&t.animations&&t.animations.length){let e=t.animations?.findIndex(t=>t.autoPlay),i=-1===e?0:e;const n=dt(t.animations[i]);delete n.name,n.currentAnimation=i,!t.type&&n.frames&&(n.showDuration=this.parent.calcAnimateDuration(n)),this.parent.setValue({id:t.id,...n},{doEvent:!1,history:!1})}this.store.animateMap.set(t,this.getFrameProps(t))}this.store.animates.add(t)}}),this.animate())}getFrameProps(t){let e={};return t.frames&&t.frames.forEach(i=>{for(let n in i)["duration","x","y","width","height","rotate"].includes(n)||e[n]||(e[n]=t[n])}),e}animate(){this.animateRendering||requestAnimationFrame(()=>{const t=Date.now();if(t-this.lastAnimateRender<this.store.options.animateInterval)return void(this.store.animates.size>0&&this.animate());this.lastAnimateRender=t,this.animateRendering=!0;const e=[];let i=!1;for(const n of this.store.animates)if(!n.calculative.pause){if(!n.calculative.active||n.type||this.movingPens||(i=!0),n.type){if(!Je(n,t)){if(n.keepAnimateState){for(const t in n)void 0!==n.calculative[t]&&"length"!==t&&("object"==typeof n[t]&&"lineDash"!==t||(n[t]="lineWidth"===t?n.calculative[t]/n.calculative.canvas.store.data.scale:n.calculative[t]));Pe(n)}else for(const t in n)"object"==typeof n[t]&&"lineDash"!==t||(n.calculative[t]="lineWidth"===t?n[t]*n.calculative.canvas.store.data.scale:n[t]);e.push(n),this.nextAnimate(n)}}else Ke(n,t)?n.calculative.patchFlags&&(_i(n.calculative.worldRect),this.updatePenRect(n,{worldRectIsReady:!0,playingAnimate:!0})):(requestAnimationFrame(()=>{this.restoreNodeAnimate(n)}),e.push(n),this.nextAnimate(n)),this.updateLines(n,!0);this.patchFlags=!0}i&&this.calcActiveRect(),e.forEach(t=>{this.store.animates.delete(t)}),this.render(!1),this.animateRendering=!1,this.animate()})}get clipboardName(){return"meta2d-clipboard"}async copy(t,e=!0){const i=Ct(),{origin:n,scale:o}=this.store.data;this.store.clipboard=void 0,localStorage.removeItem(this.clipboardName),sessionStorage.setItem("page",i);let s=this.getAllByPens(dt(t||this.store.active,!0));s.forEach(t=>{t.copyIndex=this.store.data.pens.findIndex(e=>e.id===t.id),t.pathId&&(t.path=this.store.data.paths[t.pathId])}),s.sort((t,e)=>t.copyIndex-e.copyIndex);const a={meta2d:!0,pens:s,origin:dt(n),scale:o,page:i,initRect:dt(this.activeRect),offset:10,mousePos:dt(this.mousePos)};if(!navigator.clipboard||this.store.options.disableClipboard||navigator.userAgent.includes("Firefox"))localStorage.setItem(this.clipboardName,JSON.stringify(a));else try{await navigator.clipboard.writeText(JSON.stringify(a))}catch{localStorage.setItem(this.clipboardName,JSON.stringify(a))}e&&this.store.emitter.emit("copy",a.pens)}cut(t){this.copy(t,!1),this.delete(t),this.store.emitter.emit("cut",t)}async paste(){let t,e,i,n;if(!navigator.clipboard||this.store.options.disableClipboard||navigator.userAgent.includes("Firefox"))t=localStorage.getItem(this.clipboardName);else try{t=await(navigator.clipboard?.readText())}catch{t=localStorage.getItem(this.clipboardName)}if(!t)return;try{e=JSON.parse(t)}catch(t){return void console.warn("json",t.message)}if(!e||!e.meta2d)return;if(this.beforeAddPens&&1!=await this.beforeAddPens(e.pens))return;this.store.clipboard&&(i=this.store.clipboard.offset+10,n=this.store.clipboard.pos),this.store.clipboard=dt(e);const o=sessionStorage.getItem("page"),s=this.store.data.scale;if(this.store.clipboard.mousePos&&(Math.abs(this.store.clipboard.mousePos.x-this.mousePos.x)>100*s||Math.abs(this.store.clipboard.mousePos.y-this.mousePos.y)>100*s)){let t=-this.store.clipboard.initRect.width/this.store.clipboard.scale/10/s,e=-this.store.clipboard.initRect.height/this.store.clipboard.scale/10/s,i=(s-this.store.clipboard.scale)*this.store.clipboard.initRect.width/2+t,n=(s-this.store.clipboard.scale)*this.store.clipboard.initRect.height/2+e;s<this.store.clipboard.scale&&(i=(s-this.store.clipboard.scale)/(100*(this.store.clipboard.scale-s))*this.store.clipboard.initRect.width/2+t,n=(s-this.store.clipboard.scale)/(100*(this.store.clipboard.scale-s))*this.store.clipboard.initRect.height/2+e),this.store.clipboard.pens.length>1&&(i=(s-1)*this.store.clipboard.initRect.width/this.store.clipboard.scale/2,n=(s-1)*this.store.clipboard.initRect.height/this.store.clipboard.scale/2),this.store.clipboard.pos={x:this.mousePos.x-i,y:this.mousePos.y-n},this.store.clipboard.offset=0}else o!==e.page?(this.store.clipboard.pos={x:this.mousePos.x,y:this.mousePos.y},this.store.clipboard.offset=0):this.pasteOffset?(i&&(this.store.clipboard.offset=i),n&&(this.store.clipboard.pos=n)):(this.store.clipboard.offset=0,this.pasteOffset=!0);this.keyOptions?.F||this.store.clipboard.pens.forEach(t=>{delete t.copyIndex});const a=this.store.clipboard.pens.filter(t=>!t.parentId);for(const t of a)this.pastePen(t,void 0);sessionStorage.setItem("page",e.page),this.active(a),this.pushHistory({type:Z.Add,pens:this.store.clipboard.pens}),this.render(),this.store.emitter.emit("add",this.store.clipboard.pens),this.store.emitter.emit("paste",this.store.clipboard.pens)}getAllByPens(t){const e=[];for(const i of t)e.push(...dt(Ut(i,this.store),!0));return e.concat(t)}getAllFollowersByPens(t,e=!0){const i=t;for(const n of t){let t=qt(n,this.store);e&&(t=dt(t,!0));for(const e of t)i.find(t=>t.id===e.id)||i.push(e)}return i}setFollowers(t=this.store.active){if(t)if(t.length<2)t[0].followers=[];else{let e=t.map(t=>t.id);e.pop();const i=t[t.length-1];i.followers?e.forEach(t=>{i.followers.includes(t)||i.followers.push(t)}):i.followers=e}}pastePen=(t,e)=>{const i=t.id;if(Ri(t),t.parentId=e,t.type===s.Line?this.changeNodeConnectedLine(i,t,this.store.clipboard.pens):this.changeLineAnchors(i,t,this.store.clipboard.pens),!t.parentId){const e=this.getPenRect(t,this.store.clipboard.origin,this.store.clipboard.scale),i=this.getPenRect(this.store.clipboard.initRect,this.store.clipboard.origin,this.store.clipboard.scale),{origin:n,scale:o}=this.store.data;t.x=n.x+e.x*o,t.y=n.y+e.y*o,t.width=e.width*o,t.height=e.height*o,i.x=n.x+i.x*o,i.y=n.y+i.y*o,_i(i),this.store.clipboard.pos&&(t.x-=i.center.x-this.store.clipboard.pos.x,t.y-=i.center.y-this.store.clipboard.pos.y),this.keyOptions&&this.keyOptions.altKey&&(this.keyOptions.ctrlKey||this.keyOptions.metaKey)?(t.x=-this.store.data.x+this.width/2-t.width/2,t.y=-this.store.data.y+this.height/2-t.height/2):this.keyOptions&&this.keyOptions.shiftKey&&(this.keyOptions.ctrlKey||this.keyOptions.metaKey||this.keyOptions.F)||(t.x+=this.store.clipboard.offset*this.store.data.scale,t.y+=this.store.clipboard.offset*this.store.data.scale)}this.makePen(t);const n=[];if(Array.isArray(t.children))for(const e of t.children){const i=this.store.clipboard.pens.find(t=>t.id===e);i&&n.push(this.pastePen(i,t.id).id)}return t.children=n,li(t,!0),t};changeLineAnchors(t,e,i){if(Array.isArray(e.connectedLines))for(let n=0;n<e.connectedLines.length;n++){const{lineId:o}=e.connectedLines[n],s=i.find(t=>t.id===o);if(s){const i=s.anchors[0],n=s.anchors[s.anchors.length-1];i.connectTo===t&&(i.connectTo=e.id),n.connectTo===t&&(n.connectTo=e.id)}else e.connectedLines.splice(n,1),n--}}changeNodeConnectedLine(t,e,i){const n=[e.anchors[0],e.anchors[e.anchors.length-1]];for(const o of n){const n=o.connectTo;if(n){const s=i.find(t=>t.id===n);s?s.connectedLines?.forEach(i=>{i.lineId===t&&(i.lineId=e.id,i.lineAnchor=o.id)}):(o.connectTo=void 0,o.prev&&(o.prev.connectTo=void 0),o.next&&(o.next.connectTo=void 0))}}}async delete(t=this.store.active,e=!1,i=!0){if(!t||!t.length)return;if(this.beforeRemovePens&&1!=await this.beforeRemovePens(t))return;if(e||(t=t.filter(t=>!t.locked)),!t||!t.length)return;const n=[];if(this._del(t,n,e),this.initImageCanvas(n),this.initTemplateCanvas(n),this.inactive(),this.clearHover(),this.render(),i){if(0===n.length)return;this.pushHistory({type:Z.Delete,pens:n})}this.store.emitter.emit("delete",t)}_del(t,e,i){t&&t.forEach(t=>{if(t.type&&(t.lastConnected={}),t.parentId){if(this.getLockedParent(t))return void console.warn("");{const i=Vt(t),n=i.children.indexOf(t.id);i.children.splice(n,1),e&&this.getDelPens(t,e),this.delForce(t)}}else{if(!i&&t.locked)return;e&&this.getDelPens(t,e),this.delForce(t)}})}getDelPens(t,e){if(t){if(this.store.data.pens.findIndex(e=>e.id===t.id)>-1){const i=this.store.pens[t.id];i&&i.calculative&&(i.calculative.active=void 0),e.push(i)}t.children&&t.children.forEach(t=>{this.getDelPens(this.store.pens[t],e)})}}getLockedParent(t){if(!t.parentId)return!1;const e=Vt(t);if(e.locked)return e;this.getLockedParent(e)}delForce(t){if(!t)return;const e=this.store.data.pens.findIndex(e=>e.id===t.id);e>-1&&(this.delConnectedLines(this.store.data.pens[e]),this.store.data.pens.splice(e,1),this.store.pens[t.id]=void 0,delete this.store.pens[t.id],t.pathId&&delete this.store.data.paths[t.pathId]),this.store.animates.delete(t),this.store.animateMap.delete(t),t.children&&t.children.forEach(t=>{this.delForce(this.store.pens[t])}),t.onDestroy?.(t)}delConnectedLines(t){if(t.connectedLines)for(let e=0;e<t.connectedLines.length;e++){const{lineId:i,lineAnchor:n}=t.connectedLines[e],o=this.store.pens[i];if(o){let e=o.anchors.find(t=>t.id===n);e?.connectTo===t.id&&(e.connectTo=void 0,e.anchorId=void 0,e.prev&&(e.prev.connectTo=void 0),e.next&&(e.next.connectTo=void 0)),e=Ue(o,n),e&&(e.connectTo=void 0,e.anchorId=void 0,e.prev&&(e.prev.connectTo=void 0),e.next&&(e.next.connectTo=void 0))}}t.type&&t.calculative.worldAnchors?.forEach((e,i)=>{if(!e.connectTo)return;const n=this.store.pens[e.connectTo];n&&n.calculative.worldAnchors?.forEach(i=>{Ve(n,i,t,e)})})}ondblclick=t=>{if(this.store.hover&&(!this.store.data.locked||this.store.hover.dbInput)&&!this.store.options.disableInput)if(this.store.hover.onShowInput)this.store.hover.onShowInput(this.store.hover,t);else if(this.store.hover&&this.store.hover.parentId)if(1===this.store.active?.length&&this.store.active[0].id===this.store.hover.id)this.showInput(this.store.hover);else{if(this.store.pens[this.store.hover.parentId].children.forEach(t=>{this.store.pens[t].calculative.active=!1,this.store.pens[t].calculative.hover=!1}),this.store.hover.parentId){let e=this.store.hover.id;const i=this.calibrateMouse({x:t.offsetX,y:t.offsetY});let n=1/0;this.store.pens[this.store.hover.parentId]?.children?.forEach(t=>{const o=this.store.pens[t];if(Ii(i,o.calculative.worldRect)){const s=Math.sqrt((i.x-o.calculative.worldRect.center.x)**2+(i.y-o.calculative.worldRect.center.y)**2);s<n&&(n=s,e=t)}}),this.store.hover=this.store.pens[e],this.store.pens[e].calculative.hover=!0}this.active([this.store.hover])}else this.showInput(this.store.hover);this.store.emitter.emit("dblclick",{x:t.x,y:t.y,pen:this.store.hover})};showInput=(t,e,i="transparent")=>{if(!window||!this.store.hover||this.store.hover.locked||this.store.hover.externElement||this.store.hover.disableInput||this.store.hover.disabled)return;if(this.inputDiv.dataset.penId===t.id){this.inputDiv.dataset.isInput="true",this.inputDiv.contentEditable="true",this.inputDiv.focus();const t=window.getSelection();return t.selectAllChildren(this.inputDiv),t.collapseToEnd(),this.inputDiv.scrollTop=this.inputDiv.scrollHeight,void(this.inputDiv.scrollLeft=this.inputDiv.scrollWidth)}e||t.dbInput?(this.inputDiv.style.width="100%",this.inputDiv.style.height="100%"):this.setInputStyle(t);const n=e||t.calculative.worldTextRect,o=`${(void 0===t.calculative.tempText?t.text+""||"":t.calculative.tempText).replace(/\x20/g,"&nbsp;").split(/[\s\n]/).join("</div><div>")}</div>`.replace("</div>","").replace(/\<div\>\<\/div\>/g,"<div><br></div>");this.inputDiv.innerHTML=o,this.inputParent.style.left=n.x+this.store.data.x-(t.calculative.textLeft||0)+"px",this.inputParent.style.top=n.y+this.store.data.y-(t.calculative.textTop||0)+"px";let s=n.width;this.inputParent.style.width=(s<0?12:s)+"px",this.inputParent.style.height=n.height+(t.textTop||0)+"px",this.inputParent.style.zIndex="9999",this.inputParent.style.background=i,t.rotate%360?this.inputParent.style.transform=`rotate(${t.rotate}deg)`:this.inputParent.style.transform=null,this.inputParent.style.display="flex",this.inputDiv.dataset.penId=t.id,this.inputDiv.contentEditable=null==t.disableInput?"true":t.disableInput.toString(),t.dropdownList&&"block"!==this.dropdown.style.display&&(this.dropdown.style.background=t.dropdownBackground||this.store.styles.popContentBg||"#fff",this.dropdown.style.color=t.dropdownColor||"#bdc7db",this.dropdown.style.width=this.inputParent.style.width,this.dropdown.style.fontSize=(t.fontSize||12)+"px",this.setDropdownList(),this.externalElements.style.zIndex="9999"),this.inputDiv.contentEditable="true",this.inputDiv.focus();const a=window.getSelection();a.selectAllChildren(this.inputDiv),a.collapseToEnd(),this.inputDiv.scrollTop=this.inputDiv.scrollHeight,this.inputDiv.scrollLeft=this.inputDiv.scrollWidth,t.calculative.text=void 0,this.initTemplateCanvas([t]),this.render()};setInputStyle=t=>{let e;t.text||(t.text="");for(let t=0;t<document.styleSheets.length;t++)"le5le.com"===document.styleSheets[t].title&&(e=document.styleSheets[t]);let i="overflow: scroll;",n="",o=1;const{scale:s}=this.store.data;if(t.fontSize<12&&(o=12/t.fontSize),t.textAlign?i+=`text-align: ${t.textAlign};`:i+="text-align: center;",t.textAlign&&"pre-line"===t.whiteSpace&&(i+=`align-items: ${{left:"start",center:"center",right:"end"}[t.textAlign]};`),t.textBaseline?i+=`justify-content: ${{top:"start",middle:"center",bottom:"end"}[t.textBaseline]};`:i+="justify-content: center;",t.fontFamily&&(i+=`font-family: ${t.fontFamily};`),t.fontSize&&(t.fontSize*s<12?(i+=`font-size:${t.fontSize}px;`,i+=`zoom:${t.fontSize/12*s};`):i+=`font-size:${t.fontSize*s}px;`),i+=`color:${re(t,this.store)};`,t.fontStyle&&(i+=`font-style: ${t.fontStyle};`),t.fontWeight&&(i+=`font-weight: ${t.fontWeight};`),t.textLeft&&(i+=`margin-left:${s>1?t.textLeft*o:t.textLeft*o/s}px;`),t.textTop&&(i+=`margin-top:${s>1?t.textTop*o:t.textTop*o/s}px;`),t.lineHeight&&(i+=`line-height:${s>1?t.fontSize*t.lineHeight*s:t.fontSize*t.lineHeight*o}px;`),t.textHeight)i+=`height:${s>1?t.textHeight*o*s:t.textHeight*o}px;`;else{let e=t.calculative.worldRect.height/s;e<0&&(e=0);let n=t.fontSize*s<12?e*o:e*s*o;n<t.fontSize*t.lineHeight*s&&(n=t.fontSize*t.lineHeight*s,i+=`top:-${n/2}px;`),i+=`height:${n}px;`}t.letterSpacing&&(i+=`letter-spacing:${t.calculative.letterSpacing}px;`);let a=null;if(t.textWidth)a=t.textWidth<1&&t.textWidth>-1?t.textWidth*t.calculative.worldRect.width:t.textWidth,"pre-line"!==t.whiteSpace&&(a<t.fontSize?i+=`width:${1.2*t.fontSize*o}px;`:i+=`width:${s>1?a*o*s:a*o}px;`);else if(void 0===t.whiteSpace||"break-all"===t.whiteSpace){let e=(t.calculative.worldTextRect.width||12)/s;e<0&&(e=0),i+=`width:${t.fontSize*s<12?e*o:e*s}px;`}t.whiteSpace&&("pre-line"===t.whiteSpace?i+="white-space:pre;":(i+=`white-space:${t.whiteSpace};`,"nowrap"===t.whiteSpace&&(n+="display:contents;"))),"nowrap"!==t.whiteSpace&&1.2*t.fontSize*t.text.length>(a||t.calculative.worldRect.width/s)*Math.floor(t.calculative.worldRect.height/s/(t.lineHeight*t.fontSize))&&(i+="justify-content: start;"),e.deleteRule(0),e.deleteRule(0),e.insertRule(`.meta2d-input\n      .input-div{\n        resize:none;border:none;outline:none;background:transparent;position:absolute;flex-grow:1;height:100%;width: 100%;position:absolute;left:0;top:0;display:flex;flex-direction: column;cursor: text;${i}}`),e.insertRule(`.input-div div{${n}}`)};convertSpecialCharacter(t){var e={lt:"<",gt:">",nbsp:" ",amp:"&",quot:'"'};return t.replace(/&(lt|gt|nbsp|amp|quot);/gi,function(t,i){return e[i]})}hideInput=()=>{if(this.externalElements.style.zIndex="5","flex"===this.inputParent.style.display){this.inputParent.style.display="none";const t=this.store.pens[this.inputDiv.dataset.penId];if(!t)return;if(t.calculative.text=t.text,this.inputDiv.dataset.value=this.inputDiv.innerHTML.replace(/\<div\>/g,"\n").replace(/\<\/div\>/g,"").replace(/\<br\>/g,"").replace(/&nbsp;/g," ").replace(/(<([^>]+)>)/gi,""),this.inputDiv.dataset.value=this.convertSpecialCharacter(this.inputDiv.dataset.value),t.onInput)t.onInput(t,this.inputDiv.dataset.value);else if(t.text!==this.inputDiv.dataset.value){const e=[dt(t,!0)];t.text=this.inputDiv.dataset.value,t.calculative.text=t.text,this.inputDiv.dataset.penId=void 0,t.text&&t.textAutoAdjust&&!t.parentId&&ht(t),nt(t),this.patchFlags=!0,this.pushHistory({type:Z.Update,pens:[dt(t,!0)],initPens:e}),this.store.emitter.emit("change",t),this.store.emitter.emit("valueUpdate",t)}else t.text===this.inputDiv.dataset.value&&0==t.calculative.textLines.length&&nt(t);this.initTemplateCanvas([t])}this.inputDiv.dataset.penId=void 0,this.dropdown.style.display="none",this.inputDiv.dataset.isInput="false",this.inputDiv.contentEditable="false",this.render()};createInput(){let t;this.inputParent.classList.add("meta2d-input"),this.inputDiv.classList.add("input-div"),this.inputParent.appendChild(this.inputDiv),this.dropdown.onmouseleave=()=>{this.store.hover=null},this.inputParent.appendChild(this.dropdown),this.externalElements.appendChild(this.inputParent),this.inputParent.onmousedown=this.stopPropagation,this.inputDiv.onmousedown=this.stopPropagation,this.inputDiv.contentEditable="false",this.dropdown.onmousedown=this.stopPropagation;for(let e=0;e<document.styleSheets.length;e++)"le5le.com"===document.styleSheets[e].title&&(t=document.styleSheets[e]);if(!t){const e=document.createElement("style");e.title="le5le.com",document.head.appendChild(e),t=e.sheet,t.insertRule(".meta2d-input{display:none;position:absolute;outline:none;align-items: center;}"),t.insertRule(".meta2d-input textarea{resize:none;border:none;outline:none;background:transparent;flex-grow:1;height:100%;left:0;top:0}"),t.insertRule(".meta2d-input .right{width:10px;height:10px;flex-shrink:0;border-top: 1px solid;border-right: 1px solid;margin-right: 5px;transition: all .3s cubic-bezier(.645,.045,.355,1);position:absolute;right:1px;}"),t.insertRule(".meta2d-input ul{position:absolute;top:100%;margin-top:4px; width:calc(100% + 10px);min-height:30px;border-radius: 2px;box-shadow: 0 2px 8px #00000026;list-style-type: none;background-color: #fff;padding: 4px 0;max-height: 105px;overflow-y: auto;}"),t.insertRule(".meta2d-input ul li{padding: 5px 12px;line-height: 22px;white-space: nowrap;cursor: pointer;}"),t.insertRule(".meta2d-input ul li:hover{background: #eeeeee;}"),t.insertRule(".input-div::-webkit-scrollbar {display:none}"),t.insertRule(".input-div{scrollbar-width: none;}"),t.insertRule(".meta2d-input .input-div{resize:none;border:none;outline:none;background:transparent;flex-grow:1;height:100%;width: 100%;left:0;top:0;display:flex;text-align: center;justify-content: center;flex-direction: column;}"),t.insertRule(".input-div div{}")}this.inputDiv.onfocus=t=>{if(navigator.userAgent.includes("Firefox")){if(!t.target.innerText){let t=this.inputDiv.offsetWidth/2;"center"!==window.getComputedStyle(this.inputDiv,null).textAlign&&(t=0),this.inputDiv.innerHTML=`<br style="margin-left:${t}px;margin-top:4px;" />`}}else if(t.target.innerText)this.inputDiv.style.paddingTop="";else{let t=window.getComputedStyle(this.inputDiv,null);"center"===t.justifyContent&&(this.inputDiv.style.paddingTop=` ${this.inputDiv.offsetHeight/2-parseFloat(t.lineHeight)/2}px`)}},this.inputDiv.onblur=()=>{setTimeout(()=>{this.hideInput()},300)},this.inputDiv.oninput=t=>{const e=this.store.pens[this.inputDiv.dataset.penId];if(e&&"number"===e.inputType){const e=t.target.innerText,i=e.replace(/[^0-9]/g,"");e!==i&&(t.preventDefault(),t.target.innerText=i)}if(navigator.userAgent.includes("Firefox")){if(!t.target.innerText.trim()){let t=this.inputDiv.offsetWidth/2;"center"!==window.getComputedStyle(this.inputDiv,null).textAlign&&(t=0),this.inputDiv.innerHTML=`<br style="margin-left:${t}px;margin-top:4px;" />`}}else if(t.target.innerText)this.inputDiv.style.paddingTop="";else{let t=window.getComputedStyle(this.inputDiv,null);"center"===t.justifyContent&&(this.inputDiv.style.paddingTop=` ${this.inputDiv.offsetHeight/2-parseFloat(t.lineHeight)/2}px`)}this.store.emitter.emit("input",e)},this.inputDiv.onclick=t=>{t.stopPropagation();const e=this.store.pens[this.inputDiv.dataset.penId];"block"===this.dropdown.style.display?this.dropdown.style.display="none":e?.dropdownList&&this.store.data.locked&&(this.dropdown.style.display="block"),this.store.emitter.emit("clickInput",e)},this.inputDiv.onkeyup=t=>{this.setDropdownList(!0);const e=this.store.pens[this.inputDiv.dataset.penId];this.store.emitter.emit("input",{pen:e,text:t.key}),t.stopPropagation()},this.inputDiv.onkeydown=t=>{t.stopPropagation()},this.inputDiv.onmousedown=this.stopPropagation,this.inputDiv.onwheel=t=>{t.stopPropagation()},this.inputDiv.onpaste=t=>{t.preventDefault();let e="";t.clipboardData&&t.clipboardData.getData&&(e=t.clipboardData.getData("text/plain")),document.execCommand("insertHTML",!1,e)}}clearDropdownList(){if(this.dropdown.hasChildNodes())for(let t=0;t<this.dropdown.childNodes.length;t++)this.dropdown.childNodes[t].remove(),--t}setDropdownList=t=>{this.clearDropdownList();const e=this.store.pens[this.inputDiv.dataset.penId];if(!this.store.data.locked&&!["tablePlus"].includes(e.name))return;if(this.dropdown.style.display="block",!e||!e.dropdownList)return void(this.dropdown.style.display="none");if(!e.dropdownList.length){const t=document.createElement("div");return t.innerText="None",t.style.padding="5px 12px",t.style.color="#ddd",void this.dropdown.appendChild(t)}const i=this.inputDiv.innerHTML.replace(/\<div\>/g,"\n").replace(/\<\/div\>/g,"").replace(/\<br\>/g,"");let n=0;for(const o of e.dropdownList){const e="string"==typeof o?o:o.text;t&&i?e.includes(i)&&this.dropdownAppendOption(e,n):this.dropdownAppendOption(e,n),++n}if(!this.dropdown.hasChildNodes()){const t=document.createElement("div");t.innerText="None",t.style.padding="5px 12px",t.style.color="#ddd",this.dropdown.appendChild(t)}};dropdownAppendOption(t,e){const i=document.createElement("li");i.onwheel=this.stopPropagation,i.innerText=t,i.style.overflow="hidden",i.style.textOverflow="ellipsis",i.title=t,i.style.zoom=this.store.data.scale,i.onmousedown=this.stopPropagation,i.dataset.i=e+"",i.onclick=this.selectDropdown;const n=this.store.pens[this.inputDiv.dataset.penId];i.onmouseenter=()=>{i.style.background=n.dropdownHoverBackground||this.store.styles.activeBg||"#eee",i.style.color=n.dropdownHoverColor||"#bdc7db"},i.onmouseleave=()=>{i.style.background=n.dropdownBackground||this.store.styles.popContentBg||"#fff",i.style.color=n.dropdownColor||"#bdc7db"},this.dropdown.appendChild(i)}selectDropdown=t=>{const e=t.target,i=this.store.pens[this.inputDiv.dataset.penId];if(!e||!i||!i.dropdownList)return;const n=+e.dataset.i,o=i.dropdownList[n];if(!o)return;const s=[dt(i,!0)];"object"==typeof o?(this.updateValue(i,{...o}),i.calculative.text=void 0,this.calcActiveRect()):i.text=o+"",this.inputDiv.innerText=i.text,this.hideInput(),this.pushHistory({type:Z.Update,pens:[dt(i,!0)],initPens:s}),this.render(),this.store.emitter.emit("change",i),this.store.emitter.emit("valueUpdate",i)};find(t){return this.store.data.pens.filter(e=>e.id==t||e.tags&&e.tags.indexOf(t)>-1)}findOne(t){return this.store.data.pens.find(e=>e.id==t||e.tags&&e.tags.indexOf(t)>-1)}changePenId(t,e){if(t===e)return;const i=this.store.pens[t];if(i&&!this.store.pens[e]){if(i.id=e,this.store.pens[e]=this.store.pens[t],i.onChangeId?.(i,t,e),delete this.store.pens[t],i.parentId){const n=this.store.pens[i.parentId],o=n.children?.findIndex(e=>e===t);-1!==o&&n.children?.splice(o,1,e)}i.children?.forEach(t=>{this.store.pens[t].parentId=e}),i.formId&&i.followers.forEach(t=>{this.store.pens[t].formId=e}),i.type===s.Line?this.changeNodeConnectedLine(t,i,this.store.data.pens):(this.changeLineAnchors(t,i,this.store.data.pens),i.connectedLines?.forEach(({lineId:t})=>{Ie(this.store.pens[t])})),i.anchors?.forEach(t=>t.penId=e),i.calculative.worldAnchors?.forEach(t=>t.penId=e)}}updateValue(t,e){const i=this.getPenRect(t),n=t.name;Object.assign(t,e);const o=n!==t.name;e.newId&&this.changePenId(t.id,e.newId);let s,a=!1,r=!1,l=!1,v=!1,g=!1,y=!1,m=!1;for(const i in e)-1===i.indexOf(".")?("rotate"===i?t.disableRotate?t.rotate=t.calculative.rotate||0:s=t.calculative.rotate||0:"canvasLayer"===i||"isBottom"===i||"showChild"===i?y=!0:"image"===i&&(m=!0),"object"==typeof t[i]&&"lineDash"!==i||t.disableRotate&&"rotate"===i||(t.calculative[i]=e[i]),h.includes(i)&&(r=!0),["name","borderRadius","lineSmooth","close"].includes(i)&&(a=!0),d.includes(i)&&(g=!0),u.includes(i)&&(l=!0),f.includes(i)&&(v=!0),t.image&&"gif"!==t.name&&p.includes(i)&&(m=!0)):(delete t[i],jt(t,i,e[i])),"anchors"===i.split(".")[0]&&Ie(t);if(this.setCalculativeByScale(t),o&&(t.onDestroy?.(t),b(t)),g){const n={x:e.x??i.x,y:e.y??i.y,width:e.width??i.width,height:e.height??i.height};this.setPenRect(t,n,!1),this.updateLines(t,!0),this.store.active&&this.store.active.length&&t.id===this.store.active[0].id&&this.calcActiveRect()}else l?this.updatePenRect(t):(r&&nt(t),v&&Me(this.store.pens,t),a&&V.path2dDraws[t.name]&&this.store.path2dMap.set(t,V.path2dDraws[t.name](t)));if(void 0!==s){const e=t.calculative.rotate;t.calculative.rotate=s,this.rotatePen(t,e-s,t.calculative.worldRect)}(e.image||e.backgroundImage||e.strokeImage)&&(t.calculative.image=void 0,t.calculative.backgroundImage=void 0,t.calculative.strokeImage=void 0,this.loadImage(t)),e.lineGradientColors&&(t.calculative.lineGradient=void 0,t.calculative.gradientColorStop=void 0),e.gradientColors&&(t.calculative.gradient=void 0,t.calculative.radialGradient=void 0),e.gradientRadius&&(t.calculative.gradient=void 0,t.calculative.radialGradient=void 0),e.animateLineWidth&&(t.calculative.gradientAnimatePath=void 0),e.gradientSmooth&&(t.calculative.gradientAnimatePath=void 0),y?(this.canvasImage.init(),this.canvasImageBottom.init()):m&&(void 0===t.canvasLayer&&(t.canvasLayer=c.CanvasImageBottom,t.calculative.canvasLayer=c.CanvasImageBottom),t.canvasLayer===c.CanvasImageBottom?this.canvasImageBottom.init():t.canvasLayer===c.CanvasImage&&this.canvasImage.init()),void 0===e.canvasLayer&&t.canvasLayer!==c.CanvasTemplate||this.initTemplateCanvas([t]),void 0!==e.zIndex&&t.calculative.singleton?.div&&ti(t,t.calculative.singleton.div)}execPenResize(t){t.onResize?.(t),t.children?.forEach(t=>{const e=this.store.pens[t];e&&this.execPenResize(e)})}setPenRect(t,e,i=!0){if(t.parentId)Object.assign(t,e);else{const{origin:i,scale:n}=this.store.data;t.x=i.x+e.x*n,t.y=i.y+e.y*n,t.width=e.width*n,t.height=e.height*n}this.updatePenRect(t),this.execPenResize(t),i&&this.render()}getPenRect(t,e=this.store.data.origin,i=this.store.data.scale){if(t)return t.parentId?{x:t.x,y:t.y,width:t.width,height:t.height}:{x:(t.x-e.x)/i,y:(t.y-e.y)/i,width:t.width/i,height:t.height/i}}toPng(t=2,e,i=!1,n){const o=Oi(this.store.data.pens),s=this.store.data.scale;if(!isFinite(o.width))throw new Error("can not to png, because width is not finite");const a=dt(o),r=this.store.data,l=i&&this.store.bkImg;let c=!1,h=!1;if(l){if(o.x+=r.x,o.y+=r.y,Mi(o),Fi(o,this.canvasRect,!0))Object.assign(o,this.canvasRect);else{const t=Ni([...Bi(o),...Bi(this.canvasRect)]);Object.assign(o,t)}c=0===o.x,h=0===o.y}const d=this.store.data.width||this.store.options.width,u=this.store.data.height||this.store.options.height;let f=!1;d&&u&&!this.store.data.component&&(f=!0),f&&(o.x=this.store.data.origin.x,o.y=this.store.data.origin.y,o.width=d*this.store.data.scale,o.height=u*this.store.data.scale);const p=dt(o),v=St(t);o.x-=v[3]*s,o.y-=v[0]*s,o.width+=(v[3]+v[1])*s,o.height+=(v[0]+v[2])*s;const g=(n||1920)/o.width;o.width*=g,o.height*=g,Mi(o);const y=document.createElement("canvas");if(y.width=o.width,y.height=o.height,y.width>32767||y.height>32767||!navigator.userAgent.includes("Firefox")&&y.height*y.width>268435456||navigator.userAgent.includes("Firefox")&&y.height*y.width>472907776)throw new Error("can not to png, because the size exceeds the browser limit");const m=y.getContext("2d");m.textBaseline="middle",m.scale(g,g);const w=this.store.options.downloadBgTransparent?void 0:this.store.data.background||this.store.styles.background;if(w&&f&&(m.save(),m.fillStyle=w,m.fillRect(0,0,p.width+(v[1]+v[3])*s,p.height+(v[0]+v[2])*s),m.restore()),l)if(f)m.drawImage(this.store.bkImg,v[3]*s||0,v[0]*s||0,p.width,p.height);else{const t=o.x<0?-o.x:0,e=o.y<0?-o.y:0;m.drawImage(this.store.bkImg,t,e,this.canvasRect.width,this.canvasRect.height)}if(w&&!f)if(l){const t=o.x<0?-o.x:0,e=o.y<0?-o.y:0;m.save(),m.fillStyle=w,m.fillRect(t,e,this.canvasRect.width,this.canvasRect.height),m.restore()}else m.save(),m.fillStyle=w,m.fillRect(0,0,a.width+(v[3]+v[1])*s,a.height+(v[0]+v[2])*s),m.restore();l?f?m.translate(-o.x,-o.y):m.translate((c?r.x:-a.x)+v[3]*s||0,(h?r.y:-a.y)+v[0]*s||0):m.translate(-o.x,-o.y);for(const t of this.store.data.pens){if(!ri(t,this.store)||0==t.visible)continue;const{active:e}=t.calculative;t.calculative.active=!1,t.calculative.img?me(m,t):ve(m,t,!0),t.calculative.active=e}if(!e)return y.toDataURL();y.toBlob(e)}activeToPng(t=2,e){return this.pensToPng(this.store.active,t,e)}pensToPng(t=this.store.active,e=2,i){if(0===t.length)return;const n=this.getAllByPens(t);let o=n.map(t=>t.id);const s=Oi(n);if(!isFinite(s.width))throw new Error("can not to png, because width is not finite");const a=dt(s),r=St(e);s.x-=r[3],s.y-=r[0],s.width+=r[3]+r[1],s.height+=r[0]+r[2],Mi(s);const l=(i||s.width)/s.width;s.width*=l,s.height*=l;const c=document.createElement("canvas");if(c.width=s.width,c.height=s.height,c.width>32767||c.height>32767||!navigator.userAgent.includes("Firefox")&&c.height*c.width>268435456||navigator.userAgent.includes("Firefox")&&c.height*c.width>472907776)throw new Error("can not to png, because the size exceeds the browser limit");const h=c.getContext("2d");h.textBaseline="middle",h.scale(l,l);const d=this.store.options.downloadBgTransparent?void 0:this.store.data.background||this.store.styles.background;d&&(h.save(),h.fillStyle=d,h.fillRect(0,0,a.width+(r[3]+r[1]),a.height+(r[0]+r[2])),h.restore()),h.translate(-a.x+r[3],-a.y+r[0]);for(const t of this.store.data.pens)if(o.includes(t.id)){if(!ri(t,this.store)||0==t.visible)continue;const{active:e}=t.calculative;t.calculative.active=!1,t.calculative.img?me(h,t):ve(h,t),t.calculative.active=e}return c.toDataURL()}toggleAnchorMode(){if(this.hotkeyType)this.hotkeyType===T.AddAnchor&&(this.hotkeyType=T.None,this.store.hoverAnchor?this.externalElements.style.cursor="vertical-text":this.store.hover&&(this.externalElements.style.cursor="move"));else{if(this.store.options.disableAnchor||this.store.hover?.disableAnchor)return;this.hotkeyType=T.AddAnchor,this.store.hover&&(this.externalElements.style.cursor="pointer")}this.patchFlags=!0}addAnchorHand(){if(this.store.activeAnchor&&this.store.active&&1===this.store.active.length&&this.store.active[0].type){const t=[dt(this.store.active[0],!0)];this.store.activeAnchor.prev?this.store.activeAnchor.next||(this.store.activeAnchor.next={...this.store.activeAnchor.prev},L(this.store.activeAnchor.next,180,this.store.activeAnchor),this.initLineRect(this.store.active[0]),this.patchFlags=!0):(this.store.activeAnchor.next||(this.store.activeAnchor.next={penId:this.store.activeAnchor.penId,x:this.store.activeAnchor.x+50,y:this.store.activeAnchor.y}),this.store.activeAnchor.prev={...this.store.activeAnchor.next},L(this.store.activeAnchor.prev,180,this.store.activeAnchor),this.initLineRect(this.store.active[0]),this.patchFlags=!0),this.pushHistory({type:Z.Update,pens:[dt(this.store.active[0],!0)],initPens:t})}}removeAnchorHand(){if(this.store.activeAnchor&&this.store.active&&1===this.store.active.length&&this.store.active[0].type){const t=[dt(this.store.active[0],!0)];this.hoverType===k.LineAnchorPrev?(this.store.activeAnchor.prev=void 0,this.initLineRect(this.store.active[0]),this.patchFlags=!0):this.hoverType===k.LineAnchorNext?(this.store.activeAnchor.next=void 0,this.initLineRect(this.store.active[0]),this.patchFlags=!0):(this.store.activeAnchor.prev=void 0,this.store.activeAnchor.next=void 0,this.initLineRect(this.store.active[0]),this.patchFlags=!0),this.pushHistory({type:Z.Update,pens:[dt(this.store.active[0])],initPens:t})}}toggleAnchorHand(){1===this.store.active.length&&this.store.active[0].type&&this.store.activeAnchor&&(this.store.activeAnchor.prevNextType||(this.store.activeAnchor.prevNextType=E.Mirror),this.store.activeAnchor.prevNextType=(this.store.activeAnchor.prevNextType+1)%3)}gotoView(t,e){let i=Oi(this.store.data.pens);if(!isFinite(i.width))throw new Error("can not move view, because width is not finite");const n=this.store.data.width||this.store.options.width,o=this.store.data.height||this.store.options.height;n&&o&&(i={x:this.store.data.origin.x,y:this.store.data.origin.y,width:n*this.store.data.scale,height:o*this.store.data.scale}),this.store.data.x=this.canvas.clientWidth/2-t*i.width-i.x,this.store.data.y=this.canvas.clientHeight/2-e*i.height-i.y,this.onMovePens(),this.canvasTemplate.init(),this.canvasImage.init(),this.canvasImageBottom.init(),this.render()}showMagnifier(){this.magnifierCanvas.canvas.style.zIndex="100",this.externalElements.style.zIndex="101",this.magnifierCanvas.magnifier=!0,this.magnifierCanvas.updateDomOffscreen(),this.externalElements.style.cursor="default",this.render()}hideMagnifier(){this.magnifierCanvas.canvas.style.zIndex="5",this.externalElements.style.zIndex="5",this.magnifierCanvas.magnifier=!1,this.externalElements.style.cursor="default",this.magnifierCanvas.render(),this.render()}inFitBorder=t=>{let e;const i=this.store.data.width||this.store.options.width,n=this.store.data.height||this.store.options.height;let o=(t.x-this.store.data.origin.x)/this.store.data.scale,s=(t.y-this.store.data.origin.y)/this.store.data.scale;const a=this.canvasImage.activeFit;this.externalElements.style.cursor="default",s>n*a.y-10&&s<n*a.y+10&&(e="top",this.externalElements.style.cursor="row-resize"),s>n*(a.y+a.height)-10&&s<n*(a.y+a.height)+10&&(e="bottom",this.externalElements.style.cursor="row-resize"),o>i*a.x-10&&o<i*a.x&&(e="left",this.externalElements.style.cursor="col-resize"),o>i*(a.x+a.width)-10&&o<i*(a.x+a.width)+10&&(e="right",this.externalElements.style.cursor="col-resize"),this.canvasImage.currentFit=e};showFit(){this.store.data.locked=0,this.canvasImage.fitFlag=!0,this.canvasImage.activeFit=void 0,this.canvasImage.currentFit=void 0,this.store.data.fits||(this.store.data.fits=[]),this.store.data.fits.forEach(t=>t.active=!1),this.canvasImage.init(),this.canvasImage.render()}hideFit(){this.canvasImage.fitFlag=!1,this.canvasImage.activeFit=void 0,this.canvasImage.currentFit=void 0,this.canvasImage.init(),this.canvasImage.render()}makeFit(){if(this.dragRect.width<100&&this.dragRect.height<100)return;const t=this.store.data.pens.filter(t=>!t.parentId&&!t.isRuleLine&&(Fi(t.calculative.worldRect,this.dragRect,!0)?!(t.type===s.Line&&!this.store.options.dragAllIn)||kn(t,this.dragRect):void 0));if(!t.length)return;const e=this.parent.getRect(t),i=this.store.data.scale,n=this.store.data.width||this.store.options.width,o=this.store.data.height||this.store.options.height;let a={x:(Math.floor(e.x)-this.store.data.origin.x)/i/n,y:(Math.floor(e.y)-this.store.data.origin.y)/i/o,width:(Math.ceil(e.width)+1)/i/n,height:(Math.ceil(e.height)+1)/i/o,children:t.map(t=>t.id),id:Ct(),active:!0};a.x<-.1&&(a.x=-.1),a.y<-.1&&(a.y=-.1),a.width>.5?(a.left=!0,a.right=!0,a.leftValue=(a.x-0)*i*n,a.rightValue=(1-(a.x+a.width))*i*n):a.x<.5?(a.left=!0,a.leftValue=(a.x-0)*i*n):(a.right=!0,a.rightValue=(1-(a.x+a.width))*i*n),a.leftValue<1&&(a.leftValue=0),a.rightValue<1&&(a.rightValue=0),a.height>.5?(a.top=!0,a.bottom=!0,a.topValue=(a.y-0)*i*o,a.bottomValue=(1-(a.y+a.height))*i*o):a.y<.5?(a.top=!0,a.topValue=(a.y-0)*i*o):(a.bottom=!0,a.bottomValue=(1-(a.y+a.height))*i*o),a.topValue<1&&(a.topValue=0),a.bottomValue<1&&(a.bottomValue=0),this.store.data.fits||(this.store.data.fits=[]),this.store.data.fits.forEach(t=>{t.active=!1}),this.store.data.fits.push(a),this.canvasImage.activeFit=a,this.store.emitter.emit("fit",a),this.canvasImage.init(),this.canvasImage.render()}updateFit(t){const e=this.store.data.scale,i=this.store.data.width||this.store.options.width,n=this.store.data.height||this.store.options.height;let o=(t.x-this.store.data.origin.x)/e/i,a=(t.y-this.store.data.origin.y)/e/n;if(this.canvasImage.currentFit){const r=this.canvasImage.activeFit;if("top"===this.canvasImage.currentFit){a<-.1&&(a=-.1);let t=a-r.y;if(r.height-=t,r.height<.01)return void(r.height=.01);r.y=a}if("bottom"===this.canvasImage.currentFit&&(a>1.1&&(a=1.1),r.height=a-r.y,r.height<=.01&&(r.height=.01)),"left"===this.canvasImage.currentFit){o<-.1&&(o=-.1);let t=o-r.x;if(r.width-=t,r.width<.01)return void(r.width=.01);r.x=o}"right"===this.canvasImage.currentFit&&(o>1.1&&(o=1.1),r.width=o-r.x,r.width<=.01&&(r.width=.01));let l={x:r.x*i*e+this.store.data.origin.x,y:r.y*n*e+this.store.data.origin.y,width:r.width*i*e,height:r.height*n*e};Mi(l);const c=this.store.data.pens.filter(t=>!t.parentId&&!t.isRuleLine&&(Fi(t.calculative.worldRect,l,!0)?!(t.type===s.Line&&!this.store.options.dragAllIn)||kn(t,l):void 0));r.left=void 0,r.leftValue=void 0,r.right=void 0,r.rightValue=void 0,r.top=void 0,r.topValue=void 0,r.bottom=void 0,r.bottomValue=void 0,r.width>.5?(r.left=!0,r.right=!0,r.leftValue=(r.x-0)*e*i,r.rightValue=(1-(r.x+r.width))*e*i):r.x<.5?(r.left=!0,r.leftValue=(r.x-0)*e*i):(r.right=!0,r.rightValue=(1-(r.x+r.width))*e*i),Math.abs(r.leftValue)<1&&(r.leftValue=0),Math.abs(r.rightValue)<1&&(r.rightValue=0),r.height>.5?(r.top=!0,r.bottom=!0,r.topValue=(r.y-0)*e*n,r.bottomValue=(1-(r.y+r.height))*e*n):r.y<.5?(r.top=!0,r.topValue=(r.y-0)*e*n):(r.bottom=!0,r.bottomValue=(1-(r.y+r.height))*e*n),Math.abs(r.topValue)<1&&(r.topValue=0),Math.abs(r.bottomValue)<1&&(r.bottomValue=0),r.children=c.map(t=>t.id),this.store.emitter.emit("fit",r),this.mouseDown.x=t.x,this.mouseDown.y=t.y,this.canvasImage.init(),this.canvasImage.render()}}updateFitRect(t=this.canvasImage.activeFit){const e=this.store.data.width||this.store.options.width,i=this.store.data.height||this.store.options.height;t.left&&(t.leftValue?t.x=Math.abs(t.leftValue)<1?t.leftValue:t.leftValue/e:t.x=0),t.right&&(t.rightValue?t.width=1-(Math.abs(t.rightValue)<1?t.rightValue:t.rightValue/e)-t.x:t.width=1-t.x),t.top&&(t.topValue?t.y=Math.abs(t.topValue)<1?t.topValue:t.topValue/i:t.y=0),t.bottom&&(t.bottomValue?t.height=1-(Math.abs(t.bottomValue)<1?t.bottomValue:t.bottomValue/i)-t.y:t.height=1-t.y),this.canvasImage.init(),this.canvasImage.render()}deleteFit(t=this.canvasImage.activeFit){if(!t)return;const e=this.store.data.fits.findIndex(e=>e.id===t.id);this.store.data.fits.splice(e,1),this.canvasImage.activeFit=void 0,this.canvasImage.init(),this.canvasImage.render(),this.store.emitter.emit("fit",void 0)}calcuActiveFit(){const t=this.store.data.width||this.store.options.width,e=this.store.data.height||this.store.options.height;let i=(this.mouseDown.x-this.store.data.origin.x)/this.store.data.scale/t,n=(this.mouseDown.y-this.store.data.origin.y)/this.store.data.scale/e,o=-1,s=-1;this.store.data.fits?.forEach((t,e)=>{t.ex=null,t.ey=null,Ii({x:i,y:n},t)&&(o=e),t.active&&(s=e)}),-1!==o&&o!==s?(this.canvasImage.activeFit=this.store.data.fits[o],this.store.data.fits[o].active=!0,-1!==s&&(this.store.data.fits[s].active=!1),this.store.emitter.emit("fit",this.store.data.fits[o])):-1===o&&-1!==s&&(this.store.data.fits[s].active=!1,this.store.emitter.emit("fit",void 0),this.canvasImage.activeFit=null),this.inactive(),this.canvasImage.init(),this.canvasImage.render()}toggleMagnifier(){this.magnifierCanvas.magnifier=!this.magnifierCanvas.magnifier,this.magnifierCanvas.magnifier&&(this.externalElements.style.cursor="default"),this.render()}destroy(){switch(this.scroll&&this.scroll.destroy(),this.tooltip?.destroy(),this.dialog?.destroy(),this.title?.destroy(),this.popconfirm?.destroy(),this.externalElements.removeEventListener("gesturestart",this.onGesturestart),this.externalElements.ondragover=t=>t.preventDefault(),this.externalElements.ondrop=void 0,this.externalElements.ontouchstart=void 0,this.externalElements.ontouchmove=void 0,this.externalElements.ontouchend=void 0,this.externalElements.onmousedown=void 0,this.externalElements.onmousemove=void 0,this.externalElements.onmouseup=void 0,this.externalElements.onmouseleave=void 0,this.externalElements.ondblclick=void 0,this.store.options.keydown){case Y.Document:document.removeEventListener("keydown",this.onkeydown),document.removeEventListener("keyup",this.onkeyup);break;case Y.Canvas:this.externalElements.removeEventListener("keydown",this.onkeydown),this.externalElements.removeEventListener("keyup",this.onkeyup)}document.removeEventListener("copy",this.onCopy),document.removeEventListener("cut",this.onCut),document.removeEventListener("paste",this.onPaste),window&&window.removeEventListener("message",this.onMessage),window&&window.removeEventListener("resize",this.onResize),window&&window.removeEventListener("scroll",this.onScroll),this.parentElement.innerHTML=""}}function yo(t,e){const i=e||new Path2D;t.onDestroy||(t.onDestroy=wo,t.onMove=xo,t.onRotate=xo,t.onMouseEnter=bo,t.onMouseLeave=ko,t.onMouseMove=Co,t.onMouseUp=To,t.onInput=mo),t.formId=t.id;let n=t.calculative.borderRadius||0,o=n;const{x:s,y:a,width:r,height:l,ex:c,ey:h}=t.calculative.worldRect,{x:d}=t.calculative.worldTextRect;n<1&&(n*=r,o*=l);let u=n<o?n:o;if(r<2*u&&(u=r/2),l<2*u&&(u=l/2),i.moveTo(s+u,a),i.arcTo(c,a,c,h,u),i.arcTo(c,h,s,h,u),i.arcTo(s,h,s,a,u),i.arcTo(s,a,c,a,u),i instanceof Path2D)return i}function mo(t,e){t.text=e,t.calculative.text=t.text,t.calculative.canvas.updatePenRect(t)}function wo(t){}function xo(t){}function bo(t){}function ko(t){const e=t.calculative.canvas.store.active;e&&e.length&&e.forEach(e=>{if(t.followers){let i=t.followers.findIndex(t=>t===e.id);if(-1!==i){const n=t.calculative.canvas.store.pens[e.id+vo];n&&n.calculative&&(Fi(n.calculative.worldRect,t.calculative.worldRect,!0)||(t.followers.splice(i,1),delete e.formId))}}})}function To(t){const e=t.calculative.canvas.store.active;e&&e.length&&e.forEach(e=>{const i=t.calculative.canvas.store.pens[e.id+vo];if(i&&i.calculative){let n=dt(t.calculative.worldRect);n.x-=1,n.y-=1,n.width+=2,n.height+=2,Fi(i.calculative.worldRect,n,!0)&&(t.followers||(t.followers=[]),t.followers.includes(e.id)||t.followers.push(e.id),e.formId=t.id)}})}function Co(t,e){}function Ao(t,e){if(t.formId&&t.formKey&&t.formValue){const e=t.calculative.canvas.store.pens[t.formId];e&&(e.formData||(e.formData={}),e.formData[t.formKey]=t[t.formValue])}}function Ro(t,e){const i=e||new Path2D,{x:n,y:o,width:s,height:a}=t.calculative.worldRect;if(i.ellipse(n+s/2,o+a/2,s/2,a/2,0,0,2*Math.PI),i instanceof Path2D)return i}function So(t,e){const i=e||new Path2D,{x:n,y:o,width:s,height:a}=t.calculative.worldRect;if(i.moveTo(n+s/2,o),i.lineTo(n+s,o+a/2),i.lineTo(n+s/2,o+a),i.lineTo(n,o+a/2),i.lineTo(n+s/2,o),i.closePath(),i instanceof Path2D)return i}function Po(t,e){const i=e||new Path2D,{x:n,y:o,width:s,height:a}=t.calculative.worldRect;if(i.moveTo(n+s/2,o),i.lineTo(n+s,o+a),i.lineTo(n,o+a),i.lineTo(n+s/2,o),i.closePath(),i instanceof Path2D)return i}function Io(t){t.anchors=[{x:.5,y:0},{x:.75,y:.5},{x:.5,y:1},{x:.25,y:.5}].map(({x:e,y:i},n)=>({id:`${n}`,penId:t.id,x:e,y:i}))}function Eo(t,e){const i=e||new Path2D,{x:n,y:o,width:s,height:a}=t.calculative.worldRect;if(i.moveTo(n+s/2,o),i.lineTo(n+s,o+2*a/5),i.lineTo(n+4*s/5,o+a),i.lineTo(n+s/5,o+a),i.lineTo(n,o+2*a/5),i.closePath(),i instanceof Path2D)return i}function _o(t){t.anchors=[{x:.5,y:0},{x:1,y:.4},{x:.8,y:1},{x:.2,y:1},{x:0,y:.4}].map(({x:e,y:i},n)=>({id:`${n}`,penId:t.id,x:e,y:i}))}function Mo(t,e){t.onResize||(t.onResize=Do);const i=e||new Path2D,{width:n,height:o,center:s}=t.calculative.worldRect,a=n>o?o:n,r=s.x,l=s.y,c=l-a/2,h=l-a/4,d=-(h-l)*Math.sin(Math.PI/180*324)+r,u=(h-l)*Math.cos(Math.PI/180*324)+l;i.moveTo(d,u);for(let t=0;t<5;++t)i.lineTo(-(c-l)*Math.sin(Math.PI/180*72*t)+r,(c-l)*Math.cos(Math.PI/180*72*t)+l),i.lineTo((d-r)*Math.cos(Math.PI/180*72*(t+1))-(u-l)*Math.sin(Math.PI/180*72*(t+1))+r,(d-r)*Math.sin(Math.PI/180*72*(t+1))+(u-l)*Math.cos(Math.PI/180*72*(t+1))+l);if(i.closePath(),i instanceof Path2D)return i}function Lo(t){const{width:e,height:i}=t,n=e>i?i:e,o=[];for(let s=0;s<5;++s)o.push({flag:1,id:String(s),penId:t.id,x:.5+n/2*Math.sin(Math.PI/180*72*s)/e,y:-n/2*Math.cos(Math.PI/180*72*s)/i+.5});t.anchors=o}function Do(t){const e=t.anchors.filter(t=>1!==t.flag);Lo(t),t.anchors=t.anchors.concat(...e)}function Oo(t,e){const i=e||new Path2D,{x:n,y:o,width:s,height:a}=t.calculative.worldRect;if(i.moveTo(n+s/4,o),i.lineTo(n+3*s/4,o),i.lineTo(n+s,o+a/2),i.lineTo(n+3*s/4,o+a),i.lineTo(n+1*s/4,o+a),i.lineTo(n,o+a/2),i.lineTo(n+s/4,o),i.closePath(),i instanceof Path2D)return i}function Bo(t,e){const i=e||new Path2D,{x:n,y:o,width:s,height:a}=t.calculative.worldRect;if(i.moveTo(n,o+a/2),i.lineTo(n+a/2,o),i.lineTo(n+a/2,o+a/3),i.lineTo(n+s,o+a/3),i.lineTo(n+s,o+2*a/3),i.lineTo(n+a/2,o+2*a/3),i.lineTo(n+a/2,o+2*a/3),i.lineTo(n+a/2,o+a),i.closePath(),i instanceof Path2D)return i}function No(t,e){const i=e||new Path2D,{x:n,y:o,width:s,height:a}=t.calculative.worldRect;if(i.moveTo(n,o+a/3),i.lineTo(n+(s-a/2),o+a/3),i.lineTo(n+(s-a/2),o),i.lineTo(n+s,o+a/2),i.lineTo(n+(s-a/2),o+a),i.lineTo(n+(s-a/2),o+2*a/3),i.lineTo(n,o+2*a/3),i.closePath(),i instanceof Path2D)return i}function Fo(t,e){const i=e||new Path2D,{x:n,y:o,width:s,height:a}=t.calculative.worldRect;if(i.moveTo(n,o+a/2),i.lineTo(n+a/2,o),i.lineTo(n+a/2,o+a/3),i.lineTo(n+(s-a/2),o+a/3),i.lineTo(n+(s-a/2),o),i.lineTo(n+s,o+a/2),i.lineTo(n+(s-a/2),o+a),i.lineTo(n+(s-a/2),o+2*a/3),i.lineTo(n+a/2,o+2*a/3),i.lineTo(n+a/2,o+a),i.closePath(),i instanceof Path2D)return i}function zo(t,e){const i=e||new Path2D,{x:n,y:o,width:s,height:a,ey:r}=t.calculative.worldRect;if(i.moveTo(n,o),i.lineTo(n+s,o),i.lineTo(n+s,o+3*a/4),i.lineTo(n+8*s/16,o+3*a/4),i.lineTo(n+s/4,r),i.lineTo(n+5*s/16,o+3*a/4),i.lineTo(n,o+3*a/4),i.closePath(),i instanceof Path2D)return i}function jo(t,e){const i=e||new Path2D,{x:n,y:o,width:s,height:a}=t.calculative.worldRect;if(i.moveTo(n+s/5,o+13*a/16),i.bezierCurveTo(n-s/15,o+13*a/16,n-s/15,o+7*a/16,n+s/5,o+7*a/16),i.bezierCurveTo(n+s/5,o,n+4*s/5,o,n+4*s/5,o+7*a/16),i.bezierCurveTo(n+16*s/15,o+7*a/16,n+16*s/15,o+13*a/16,n+4*s/5,o+13*a/16),i.closePath(),i instanceof Path2D)return i}function Ho(t,e){const i=e||new Path2D,{x:n,y:o,width:s,ex:a,ey:r}=t.calculative.worldRect,l=s/6;if(i.moveTo(n,o),i.lineTo(a-l,o),i.lineTo(a,o+l),i.lineTo(a,r),i.lineTo(n,r),i.closePath(),i.moveTo(a-l,o),i.lineTo(a-l,o+l),i.lineTo(a,o+l),i.closePath(),i instanceof Path2D)return i}function Wo(t,e){const i=e||new Path2D,{x:n,y:o,width:s,ex:a,ey:r}=t.calculative.worldRect,l=s/4,c=n+s/2;if(i.arc(c,o+l,l,0,2*Math.PI),i.moveTo(n,o+3*l),i.lineTo(a,o+3*l),i.moveTo(c,o+2*l),i.lineTo(c,o+4*l),i.moveTo(c,o+4*l),i.lineTo(n,r),i.moveTo(c,o+4*l),i.lineTo(a,r),i.closePath(),i instanceof Path2D)return i}const Vo={};function Uo(t){t.onDestroy||(t.onDestroy=qo,t.onMove=$o,t.onResize=Ko,t.onRotate=$o,t.onValue=Yo,t.onChangeId=Xo);const e=new Path2D;if(!t.image)return;const i=t.calculative.canvas.store.id+"-"+t.id;if(!Vo[i]){const e=new Image;e.crossOrigin="anonymous",e.src=t.image,t.calculative.canvas.parent.store.options.cdn&&!(t.image.startsWith("http")||t.image.startsWith("//")||t.image.startsWith("data:image"))&&(e.src=t.calculative.canvas.parent.store.options.cdn+t.image),Vo[i]=e,e.onload=()=>{Vo[i]===e&&(t.calculative.img=e,t.calculative.imgNaturalWidth=e.naturalWidth||t.iconWidth,t.calculative.imgNaturalHeight=e.naturalHeight||t.iconHeight,t.calculative.canvas.externalElements?.parentElement.appendChild(e),Go(t,e))}}return t.calculative.patchFlags&&Vo[i]&&Go(t,Vo[i]),e}function qo(t){const e=t.calculative.canvas.store.id+"-"+t.id;Vo[e]&&(Vo[e].remove(),Vo[e]=void 0)}function $o(t){const e=t.calculative.canvas.store.id+"-"+t.id;Vo[e]&&Go(t,Vo[e])}function Ko(t){const e=t.calculative.canvas.store.id+"-"+t.id;Vo[e]&&Go(t,Vo[e])}function Yo(t){const e=t.calculative.canvas.store.id+"-"+t.id;Vo[e]&&(Go(t,Vo[e]),Vo[e].getAttribute("src")!==t.image&&(Vo[e].src=t.image))}function Xo(t,e,i){const n=t.calculative.canvas.store.id;Vo[n+"-"+e]&&(Vo[n+"-"+i]=Vo[n+"-"+e],delete Vo[n+"-"+e])}function Go(t,e){e.style.objectFit=t.imageRatio?"contain":"fill",ti(t,e)}function Jo(e,i){return e.onResize||(e.onResize=Qo,e.onValue=Zo),t(e,i)}function Qo(t){const e=t.anchors.filter(t=>1!==t.flag);ts(t),t.anchors=t.anchors.concat(...e)}function Zo(t){Qo(t),Ie(t)}function ts(t){const e=[],{x:i,y:n,width:o,height:s}=t,a=function(t){let e=t.calculative.borderRadius||0,i=t.calculative.borderRadius||0;const{width:n,height:o}=t;t.calculative.borderRadius<1&&(e=n*t.calculative.borderRadius,i=o*t.calculative.borderRadius);let s=e<i?e:i;return n<2*s&&(s=n/2),o<2*s&&(s=o/2),s}(t);for(let r=0;r<5;r++){if(2===r)continue;let l=i+o*(r+1)/6,c=n;l<i+a?c=is(i+a,c+a,l,a,-1):l>i+o-a&&(c=is(i+o-a,c+a,l,a,-1)),e.push({id:String(e.length),flag:1,penId:t.id,x:(l-i)/o,y:(c-n)/s})}for(let r=0;r<3;r++){let l=n+s*(r+1)/4,c=i+o;l<n+a?c=es(c-a,n+a,l,a):l>n+s-a&&(c=es(c-a,n+s-a,l,a)),e.push({id:String(e.length),flag:1,penId:t.id,x:(c-i)/o,y:(l-n)/s})}for(let r=0;r<5;r++){if(2===r)continue;let l=i+o*(r+1)/6,c=n+s;l<i+a?c=is(i+a,c-a,l,a):l>i+o-a&&(c=is(i+o-a,c-a,l,a)),e.push({id:String(e.length),flag:1,penId:t.id,x:(l-i)/o,y:(c-n)/s})}for(let r=0;r<3;r++){let l=n+s*(r+1)/4,c=i;l<n+a?c=es(c+a,n+a,l,a,-1):l>n+s-a&&(c=es(c+a,n+s-a,l,a,-1)),e.push({id:String(e.length),flag:1,penId:t.id,x:(c-i)/o,y:(l-n)/s})}t.anchors=e}function es(t,e,i,n,o=1){return o*Math.sqrt(n**2-(i-e)**2)+t}function is(t,e,i,n,o=1){return o*Math.sqrt(n**2-(i-t)**2)+e}function ns(t,e){const i=e||new Path2D,{x:n,y:o,width:s,height:a}=t.calculative.worldRect;if(i.moveTo(n,o+a),i.lineTo(n+s,o+a),i.closePath(),i instanceof Path2D)return i}function os(t){t.anchors=[{x:0,y:1},{x:1,y:1}].map(({x:e,y:i},n)=>({id:n+"",x:e,y:i,penId:t.id}))}var ss;!function(t){t[t.Link=0]="Link",t[t.SetProps=1]="SetProps",t[t.StartAnimate=2]="StartAnimate",t[t.PauseAnimate=3]="PauseAnimate",t[t.StopAnimate=4]="StopAnimate",t[t.JS=5]="JS",t[t.GlobalFn=6]="GlobalFn",t[t.Emit=7]="Emit",t[t.StartVideo=8]="StartVideo",t[t.PauseVideo=9]="PauseVideo",t[t.StopVideo=10]="StopVideo",t[t.SendPropData=11]="SendPropData",t[t.SendVarData=12]="SendVarData",t[t.Navigator=13]="Navigator",t[t.Dialog=14]="Dialog",t[t.SendData=15]="SendData",t[t.PostMessage=16]="PostMessage",t[t.PostMessageToParent=17]="PostMessageToParent",t[t.Message=18]="Message"}(ss||(ss={}));class as{parent;box;boxWidth=320;boxHeight=180;ratio=this.boxWidth/this.boxHeight;padding=5;img;isShow;isDown;view;timer;constructor(t){let e;this.parent=t,this.box=document.createElement("div"),this.img=new Image,this.view=document.createElement("div"),this.box.appendChild(this.img),this.box.appendChild(this.view),this.parent.externalElements?.parentElement.appendChild(this.box),this.box.className="meta2d-map",this.box.onmousedown=this.onMouseDown,this.box.onmousemove=this.onMouseMove,this.box.onmouseup=this.onMouseUp,this.box.onwheel=this.onWheel;for(let t=0;t<document.styleSheets.length;t++)"le5le/map"===document.styleSheets[t].title&&(e=document.styleSheets[t]);if(!e){let t=document.createElement("style");t.type="text/css",t.title="le5le.com/map",document.head.appendChild(t),t=document.createElement("style"),t.type="text/css",document.head.appendChild(t),e=t.sheet,e.insertRule(`.meta2d-map{display:flex;width:${this.boxWidth+2*this.padding}px;height:${this.boxHeight+2*this.padding}px;padding:${this.padding}px;background:#f4f4f4;border:1px solid #ffffff;box-shadow: 0px 0px 14px 0px rgba(0,10,38,0.30);border-radius:8px;position:absolute;z-index:9999;right:0;bottom:0;justify-content:center;align-items:center;cursor:default;user-select:none;overflow: hidden;}`),e.insertRule(".meta2d-map img{max-width:100%;max-height:100%;pointer-events: none;}"),e.insertRule(".meta2d-map div{pointer-events: none;border:1px solid #1890ff;position:absolute}")}}show(){this.box.style.display="flex",this.parent.store.data.pens.length?(this.img.style.display="block",this.img.src=this.parent.toPng(0,void 0,!0),this.setView()):this.img.style.display="none",this.isShow=!0}hide(){this.box.style.display="none",this.isShow=!1}setView(){const t=this.parent.store.data;if(t.pens.length){let e=Oi(t.pens);const i=this.parent.store.data.width||this.parent.store.options.width,n=this.parent.store.data.height||this.parent.store.options.height;if(i&&n?e={x:this.parent.store.data.origin.x,y:this.parent.store.data.origin.y,width:i*this.parent.store.data.scale,height:n*this.parent.store.data.scale}:(clearTimeout(this.timer),this.timer=setTimeout(()=>{this.parent.store.bkImg&&(this.img.src=this.parent.toPng(0,void 0,!0))},300)),Hi(e,t.x,t.y),e.width/e.height>this.ratio){const t=e.width/this.ratio;e.y-=(t-e.height)/2,e.height=t,Mi(e)}else{const t=e.height*this.ratio;e.x-=(t-e.width)/2,e.width=t,Mi(e)}const o=this.parent.canvasRect;let s=0,a=0;if(e.x<0)s=-e.x/e.width;else if(e.x+e.width>o.width){let t=0;o.width>e.width&&(t=o.width-e.width),s=(-e.x+t)/e.width}if(e.y<0)a=-e.y/e.height;else if(e.y+e.height>o.height){let t=0;o.height>e.height&&(t=o.height-e.height),a=(-e.y+t)/e.height}const r=o.width>e.width?1:o.width/e.width,l=o.height>e.height?1:o.height/e.height;this.view.style.left=this.padding+s*this.boxWidth+"px",this.view.style.width=r*this.boxWidth+"px",this.view.style.top=this.padding+a*this.boxHeight+"px",this.view.style.height=l*this.boxHeight+"px"}}onMouseDown=t=>{t.preventDefault(),t.stopPropagation(),this.isDown=!0};onMouseMove=t=>{if(t.preventDefault(),t.stopPropagation(),this.isDown)try{this.parent.gotoView(t.offsetX/this.box.clientWidth,t.offsetY/this.box.clientHeight)}catch(t){console.warn(t.message),this.isDown=!1}};onMouseUp=t=>{t.preventDefault(),t.stopPropagation();try{this.parent.gotoView(t.offsetX/this.box.clientWidth,t.offsetY/this.box.clientHeight)}catch(t){console.warn(t.message)}finally{this.isDown=!1}};onWheel=t=>{let e=.015;if(this.parent.store.options.scaleOff)e=this.parent.store.options.scaleOff,t.deltaY>0&&(e=-this.parent.store.options.scaleOff);else if(/mac os /i.test(navigator.userAgent))t.ctrlKey?t.deltaY>0&&(e*=-1):e*=t.wheelDeltaY/240;else{let i=.2;-1!==t.deltaY.toString().indexOf(".")&&(i=.01),e=t.deltaY>0?-i:i}let{offsetX:i,offsetY:n}=t;const o=this.parent.store.data.width||this.parent.store.options.width,s=this.parent.store.data.height||this.parent.store.options.height;if(o&&s)i=i/this.boxWidth*o*this.parent.store.data.scale+this.parent.store.data.origin.x+this.parent.store.data.x,n=n/this.boxHeight*s*this.parent.store.data.scale+this.parent.store.data.origin.y+this.parent.store.data.y;else{const t=this.parent.parent.getRect();i=i/this.boxWidth*t.width+t.x+this.parent.store.data.x,n=n/this.boxHeight*t.height+t.y+this.parent.store.data.y}this.parent.scale(this.parent.store.data.scale+e,{x:i,y:n})}}var rs=i(22);const ls={success:{color:"#2ba471",icon:'<svg fill="none" viewBox="0 0 24 24"><path d="M12 23a11 11 0 100-22 11 11 0 000 22zM7.5 10.59l3 3 6-6L17.91 9l-7.41 7.41L6.09 12l1.41-1.41z"></path></svg>'},info:{color:"#0052d9",icon:'<svg fill="none" viewBox="0 0 24 24"><path d="M12 23a11 11 0 100-22 11 11 0 000 22zM11 8.5v-2h2v2h-2zm2 1.5v7.5h-2V10h2z"></path></svg>'},warning:{color:"#e37318",icon:'<svg fill="none" viewBox="0 0 24 24"><path d="M12 1a11 11 0 110 22 11 11 0 010-22zm-1 13h2V6.5h-2V14zm2 1.5h-2v2h2v-2z"></path></svg>'},error:{color:"#d54941",icon:'<svg fill="none" viewBox="0 0 24 24"><path d="M12 1a11 11 0 110 22 11 11 0 010-22zm-1 13h2V6.5h-2V14zm2 1.5h-2v2h2v-2z"></path></svg>'},question:{color:"#0052d9",icon:'<svg fill="none" viewBox="0 0 24 24"><path d="M12 23a11 11 0 100-22 11 11 0 000 22zm-.17-11.11c.43-.53.97-.97 1.4-1.32A2 2 0 0012 7a2 2 0 00-1.89 1.33l-.33.95L7.9 8.6l.34-.94a4 4 0 116.24 4.47 7 7 0 00-1.1 1.01c-.27.34-.37.61-.37.85v1.25h-2V14c0-.87.39-1.57.83-2.11zM11 18.25v-2h2v2h-2z"></path></svg>'}},cs={};class hs{parentElement;box;icon;text;closeBtn;duration;content;theme;placement;height;id;constructor(t,e){let i;this.parentElement=t,this.box=document.createElement("div"),this.icon=document.createElement("div"),this.text=document.createElement("div"),this.box.className="meta2d-message",this.icon.className="icon",this.text.className="text",this.icon.innerHTML=ls[e.theme||"info"].icon,this.text.innerHTML=e.content,this.box.appendChild(this.icon),this.box.appendChild(this.text),e.closeBtn&&(this.closeBtn=document.createElement("div"),this.closeBtn.className="close",this.closeBtn.innerHTML="x",this.closeBtn.onclick=()=>{this.close()},this.box.appendChild(this.closeBtn)),t.appendChild(this.box);for(let t=0;t<document.styleSheets.length;t++)"le5le.com/message"===document.styleSheets[t].title&&(i=document.styleSheets[t]);if(!i){let t=document.createElement("style");t.type="text/css",t.title="le5le.com/message",document.head.appendChild(t),t=document.createElement("style"),t.type="text/css",document.head.appendChild(t),i=t.sheet,i.insertRule(".meta2d-message{\n           position:absolute;\n           z-index:999;\n           transform: translateX(-50%); \n           padding:12px 16px;\n           max-width:400px;\n           background:#fff;\n           border-radius:6px;\n           box-shadow:0 3px 14px 2px rgba(0, 0, 0, .05),0 8px 10px 1px rgba(0, 0, 0, 6%),0 5px 5px -3px rgba(0, 0, 0, 10%);\n           display:flex;\n           animation: fadein .5s;}"),i.insertRule("\n        @keyframes fadein {\n          0% {\n              transform: translate(-50%, -100%);\n          }\n          100% {\n              transform: translate(-50%,0);\n          }\n      }"),i.insertRule(".meta2d-message .icon{width:20px;height:20px;}"),i.insertRule(".meta2d-message .text{color:rgba(0, 0, 0, 0.9);font-size:12px;margin-left:8px;line-height:20px;}"),i.insertRule(".meta2d-message .close{width:20px;height:20px;padding-left: 16px; cursor: pointer;}")}this.id=e.id||Ct(),this.duration=e.duration??3e3,this.placement=e.placement||"top",this.theme=e.theme||"info",this.height=e.height}init(){cs[this.id]=this,this.duration&&setTimeout(()=>{this.close()},this.duration);let t=-1;Object.keys(cs).forEach(e=>{cs[e]?.placement===this.placement&&t++}),this.setPosition(this.placement,t),this.icon.children[0].style.fill=ls[this.theme].color}setPosition(t,e=0){switch(t){case"top":this.box.style.top=30+e*(this.height||60)+"px",this.box.style.left="50%";break;case"bottom":this.box.style.bottom=30+e*(this.height||60)+"px",this.box.style.left="50%";break;case"left":this.box.style.top=30+e*(this.height||60)+"px",this.box.style.left="30px";break;case"right":this.box.style.top=30+e*(this.height||60)+"px",this.box.style.right="30px"}}close(){Object.keys(cs).forEach(t=>{if(cs[t]?.placement===this.placement)switch(this.placement){case"top":case"left":case"right":cs[t].box.style.top=parseInt(cs[t].box.style.top)-60+"px";break;case"bottom":cs[t].box.style.bottom=parseInt(cs[t].box.style.bottom)-60+"px"}}),cs[this.id]=null,delete cs[this.id],this.box.remove()}}function ds(t,e){let i=e.payload.topicName,n=e.payload.message,o=`<div style="padding:0px 12px 0px 0px;width:300px;">\n      <div style="display:flex;height: 20px;justify-content: space-between">\n        <div style="color: #000000d9;\n      font-size: 14px;\n      font-weight: 700;">${i}</div><div style="color: #00000073;">${function(t){const e=new Date(t);return e.getFullYear()+"-"+(e.getMonth()+1+"").padStart(2,"0")+"-"+(e.getDate()+"").padStart(2,"0")+" "+(e.getHours()+"").padStart(2,"0")+":"+(e.getMinutes()+"").padStart(2,"0")+":"+(e.getSeconds()+"").padStart(2,"0")}(e.payload.notifyTime)}</div>\n      </div>\n      <span>${n}</span>\n   </div>`;t.message({content:o,duration:0,closeBtn:!0,placement:"right",height:75}),e.payload.detail?.alarmConfigId&&async function(t,e){const i=await fetch(`/api/alarm/config/${e}`,{headers:{"X-Access-Token":localStorage.getItem("X-Access-Token")||new URLSearchParams(location.search).get("X-Access-Token")||"","Content-Type":"application/json"},method:"GET"});if(i.ok){let e=await i.json();e.result.media&&us(t,e.result.media,e.result.playTimes)}}(t,e.payload.detail?.alarmConfigId)}function us(t,e,i){if(t.store.globalAudio||(t.store.globalAudio=document.createElement("audio")),t.store.globalAudio.src=e,t.store.globalAudio.play(),-1===i)t.store.globalAudio.loop=!0;else{t.store.globalAudio.loop=!1;let e=0;t.store.globalAudio.onended=()=>{e++,e<i&&t.store.globalAudio.play()}}}globalThis.doWarning=ds,globalThis.createAudio=us;class fs{store;canvas;websocket;mqttClient;websockets;mqttClients;eventSources;penPluginMap=new Map;socketFn;events={};map;mapTimer;constructor(e,i={}){this.store=et(Ct()),this.setOptions(i),this.setDatabyOptions(i),this.init(e),this.register({rectangle:t,square:o,circle:Ro,svgPath:en,diamond:So,triangle:Po,pentagon:Eo,pentagram:Mo,hexagon:Oo,leftArrow:Bo,rightArrow:No,twowayArrow:Fo,message:zo,cloud:jo,file:Ho,people:Wo,line:dn,iframe:Nn,video:Yn,gif:Uo,mindNode:Jo,mindLine:ns,mindNode2:t,form:yo,combine:t}),this.registerCanvasDraw({cube:nn}),this.registerAnchors({triangle:Io,pentagon:_o,pentagram:Lo,mindNode:ts,mindLine:os}),globalThis.meta2d=this,this.initEventFns(),this.store.emitter.on("*",this.onEvent)}facePen=Fe;getWords=at;calcTextLines=st;calcTextRect=nt;calcTextDrawRect=ot;get beforeAddPen(){return this.canvas.beforeAddPen}set beforeAddPen(t){this.canvas.beforeAddPen=t}get beforeAddPens(){return this.canvas.beforeAddPens}set beforeAddPens(t){this.canvas.beforeAddPens=t}get beforeAddAnchor(){return this.canvas.beforeAddAnchor}set beforeAddAnchor(t){this.canvas.beforeAddAnchor=t}get beforeRemovePens(){return this.canvas.beforeRemovePens}set beforeRemovePens(t){this.canvas.beforeRemovePens=t}get beforeRemoveAnchor(){return this.canvas.beforeRemoveAnchor}set beforeRemoveAnchor(t){this.canvas.beforeRemoveAnchor=t}setOptions(t={}){void 0===t.grid&&void 0===t.gridColor&&void 0===t.gridSize||this.canvas&&(this.canvas.canvasTemplate.bgPatchFlags=!0),void 0===t.rule&&void 0===t.ruleColor&&void 0===t.ruleOptions||(this.store.patchFlagsTop=!0,t.ruleOptions&&this.store.options?.ruleOptions&&(Object.assign(this.store.options.ruleOptions,t.ruleOptions),t.ruleOptions=this.store.options.ruleOptions)),void 0!==t.background&&this.canvas&&(this.canvas.canvasTemplate.bgPatchFlags=!0),void 0!==t.resizeMode&&(t.resizeMode||(this.canvas.hotkeyType=T.None)),void 0===t.width&&void 0===t.height||(this.canvas&&(this.canvas.canvasTemplate.bgPatchFlags=!0),this.canvas&&this.canvas.canvasTemplate.canvas.style.backgroundImage&&(this.canvas.canvasTemplate.canvas.style.backgroundImage="")),this.store.options=Object.assign(this.store.options,t),this.canvas&&void 0!==t.scroll&&(t.scroll?(!this.canvas.scroll&&(this.canvas.scroll=new no(this.canvas)),this.canvas.scroll.show()):this.canvas.scroll&&this.canvas.scroll.hide()),this.canvas?.initGlobalStyle()}getOptions(){return this.store.options}registerTheme(t,e){if(!Array.isArray(e))return;const i=/^\s*\S+\s*:\s*\S+\s*$/;if(!e.every(t=>i.test(t)))return;const n={},o=[];for(let t=0;t<e.length;t++){const i=e[t].split(":"),s=i[0].trim(),a=i[1].trim();o.push([s,a].join(":")),n[s]=a}Q.addTheme(t,o),this.store.theme[t]=n}setTheme(t){if(this.store.data.theme=t,this.setBackgroundColor(this.store.theme[t].background),this.canvas.parentElement.style.background=this.store.theme[t].parentBackground,this.setOptions({ruleColor:this.store.theme[t].ruleColor,ruleOptions:this.store.theme[t].ruleOptions}),!this.store.options.themeOnlyCanvas&&!this.store.data.themeOnlyCanvas){this.store.data.color=this.store.theme[t].color,Q.updateCssRule(this.store.id,t),this.canvas.initGlobalStyle();for(let t=0;t<this.store.data.pens.length;t++){const e=this.store.data.pens[t];e.setTheme&&e.setTheme(e,this.store.styles)}}this.render()}setDatabyOptions(t={}){const{color:e,activeColor:i,activeBackground:n,grid:o,gridColor:s,gridSize:a,fromArrow:r,toArrow:l,rule:c,ruleColor:h,textColor:d,x:u=0,y:f=0}=t;this.setRule({rule:c,ruleColor:h}),this.setGrid({grid:o,gridColor:s,gridSize:a}),this.store.data=Object.assign(this.store.data,{textColor:d,color:e,activeColor:i,activeBackground:n,fromArrow:r,toArrow:l,x:u,y:f})}init(t){this.canvas=new go(this,"string"==typeof t?document.getElementById(t):t,this.store),this.canvas.initGlobalStyle(),this.resize(),this.canvas.listen(),Q.createThemeSheet(this.store.data.theme,this.store.id)}initEventFns(){this.events[ss.Link]=(t,e)=>{if(window&&e.value&&"string"==typeof e.value){let i=e.value;if(i.includes("${")){let e=i.match(/\$\{([^}]+)\}/g)?.map(t=>t.slice(2,-1));e&&e?.forEach(e=>{i=i.replace(`\${${e}}`,t[e]||this.getDynamicParam(e))})}return void window.open(i,e.params??"_blank")}console.warn("[meta2d] Link param is not a string")},this.events[ss.SetProps]=(t,e)=>{const i=e.value;if(i&&"object"==typeof i){const n=e.params?this.find(e.params):this.find(t.id),o={};for(let e in i)if(i[e]?.id)o[e]=this.store.pens[i[e].id]?.[i[e].key];else if("string"==typeof i[e]&&i[e].includes("${")){let n=i[e],s=n.match(/\$\{([^}]+)\}/g)?.map(t=>t.slice(2,-1));s&&s.forEach(e=>{n=n.replace(`\${${e}}`,t[e]||this.getDynamicParam(e))}),o[e]=n}else o[e]=i[e];return n.forEach(t=>{o.hasOwnProperty("visible")&&t.visible!==o.visible&&this.setVisible(t,o.visible),this.setValue({id:t.id,...o},{render:!1,doEvent:!1})}),void this.render()}console.warn("[meta2d] SetProps value is not an object")},this.events[ss.StartAnimate]=(t,e)=>{let i=t;e.value&&(i=this.findOne(e.value)),this.store.animates.has(i)&&!i.calculative.pause&&i.animateName===e.params||(e.targetType&&e.params?this.startAnimate(e.value||[t],e.params):e.value&&"string"!=typeof e.value?console.warn("[meta2d] StartAnimate value is not a string"):this.startAnimate(e.value||[t]))},this.events[ss.PauseAnimate]=(t,e)=>{e.value&&"string"!=typeof e.value?console.warn("[meta2d] PauseAnimate value is not a string"):this.pauseAnimate(e.value||[t])},this.events[ss.StopAnimate]=(t,e)=>{if(e.value&&"string"!=typeof e.value)console.warn("[meta2d] StopAnimate event value is not a string");else{if(e.value){let t=this.findOne(e.value);if(!this.store.animates.has(t))return}else if(!this.store.animates.has(t))return;this.stopAnimate(e.value||[t])}},this.events[ss.StartVideo]=(t,e)=>{e.value&&"string"!=typeof e.value?console.warn("[meta2d] StartVideo value is not a string"):this.startVideo(e.value||[t])},this.events[ss.PauseVideo]=(t,e)=>{e.value&&"string"!=typeof e.value?console.warn("[meta2d] PauseVideo value is not a string"):this.pauseVideo(e.value||[t])},this.events[ss.StopVideo]=(t,e)=>{e.value&&"string"!=typeof e.value?console.warn("[meta2d] StopVideo event value is not a string"):this.stopVideo(e.value||[t])},this.events[ss.JS]=(t,e,i)=>{if(e.value&&!e.fn)try{if("string"!=typeof e.value)throw new Error("[meta2d] Function value must be string");const t=e.value;e.fn=new Function("pen","params","context",t)}catch(t){console.error("[meta2d]: Error on make a function:",t)}e.fn?.(t,i||e.params,{meta2d:this,eventName:e.name})},this.events[ss.GlobalFn]=(t,e)=>{"string"==typeof e.value?globalThis[e.value]&&globalThis[e.value](t,e.params):console.warn("[meta2d] GlobalFn value must be a string")},this.events[ss.Emit]=(t,e)=>{"string"==typeof e.value?this.store.emitter.emit(e.value,{pen:t,params:e.params,eventName:e.name}):console.warn("[meta2d] Emit value must be a string")},this.events[ss.SendPropData]=(t,e)=>{const i=dt(e.value);if(i&&"object"==typeof i){const n=e.params?this.findOne(e.params):t;for(let t in i)void 0!==i[t]&&""!==i[t]||(i[t]=n[t]);return i.id=n.id,void this.doSendDataEvent(i,e.extend)}console.warn("[meta2d] SendPropData value is not an object")},this.events[ss.SendVarData]=(t,e)=>{const i=dt(e.value);if(i&&"object"==typeof i){const n=e.params?this.findOne(e.params):t;let o=[];for(let t in i){let e={dataId:t,value:i[t]};if(!e.value){let t=n.form.find(t=>t.dataIds&&t.dataIds.dataId===e.dataId);t&&(e.value=n[t.key])}o.push(e)}return void this.doSendDataEvent(o,e.extend)}console.warn("[meta2d] SendVarData value is not an object")},this.events[ss.Navigator]=(t,e)=>{e.value&&"string"==typeof e.value&&this.navigatorTo(e.value)},this.events[ss.Dialog]=(t,e)=>{if(e.params&&"string"==typeof e.params){let i=e.params;if(e.params.includes("${")){let n=e.params.match(/\$\{([^}]+)\}/g)?.map(t=>t.slice(2,-1));n&&n?.forEach(e=>{i=i.replace(`\${${e}}`,t[e]||this.getDynamicParam(e))})}Object.keys(e.extend).forEach(t=>{["x","y","width","height"].includes(t)||(-1!==i.indexOf("?")?i+=`&${t}=${e.extend[t]}`:i+=`?${t}=${e.extend[t]}`)});let n=this.getEventData(e.list,t);Object.keys(n).length&&(n=null),this.canvas.dialog.show(e.value,i,e.extend,n)}},this.events[ss.SendData]=(t,e)=>{if(e.data?.length){const i=this.getSendData(e.data);return t.formId&&t.formData&&Object.assign(i,t.formData),void this.sendDataToNetWork(i,t,e)}if(e.list?.length){if(e.network&&"ADIIOT"===e.network.protocol){const i=function(t,e,i){const n=[];return i.list.forEach((i,o)=>{const s=i.params?t.findOne(i.params):e;n[o]={deviceId:s.deviceId,productId:s.productId,properties:{}};for(let e in i.value)if(void 0===i.value[e]||""===i.value[e]){const t=s.realTimes?.find(t=>t.propertyId===e);t&&(n[o].properties[e]=s[t.key])}else if("string"==typeof i.value[e]&&i.value[e]?.indexOf("${")>-1){let a=i.value[e].match(/(?<=\$\{).*?(?=\})/g);a?.length&&(n[o].properties[e]=s[a[0]]??t.getDynamicParam(a[0]))}else n[o].properties[e]=i.value[e]}),n}(this,t,e);return void(i.length&&async function(t,e){e.forEach(async e=>{let i=e.deviceId;if(i&&i.indexOf("${")>-1){let e=i.match(/(?<=\$\{).*?(?=\})/g);e?.length&&(i=t.getDynamicParam(e[0])||i)}(await fetch(`/api/device-instance/${i}/property`,{headers:{"X-Access-Token":localStorage.getItem("X-Access-Token")||new URLSearchParams(location.search).get("X-Access-Token")||"","Content-Type":"application/json"},method:"put",body:JSON.stringify(e.properties)})).ok?(console.info(""),t.message({theme:"success",content:""})):t.message({theme:"error",content:""})})}(this,i))}const i=this.getEventData(e.list,t);return t.deviceId&&(i.deviceId=t.deviceId),t.formId&&t.formData&&Object.assign(i,t.formData),void this.sendDataToNetWork(i,t,e)}const i=dt(e.value);if(i&&"object"==typeof i&&"id"===e.targetType){const n=e.params?this.findOne(e.params):t;for(let t in i)if(void 0===i[t]||""===i[t])i[t]=n[t];else if("string"==typeof i[t]&&i[t]?.indexOf("${")>-1){let e=i[t].match(/\$\{([^}]+)\}/g)?.map(t=>t.slice(2,-1));e?.length&&(i[t]=n[e[0]]??this.getDynamicParam(e[0]))}return n.deviceId&&(i.deviceId=n.deviceId),void this.sendDataToNetWork(i,t,e)}},this.events[ss.PostMessage]=(t,e)=>{if("string"!=typeof e.value)return void console.warn("[meta2d] Emit value must be a string");const i=e.params?this.findOne(e.params):t;if("iframe"!==i.name||!i.iframe)return void console.warn("");let n=Mt(i.iframe.split("?")[1]);const o=this.getEventData(e.list,i);i.calculative.singleton.div.children[0].contentWindow.postMessage(JSON.stringify({name:e.value,id:n.id,data:o}),"*")},this.events[ss.PostMessageToParent]=(t,e)=>{if("string"!=typeof e.value)return void console.warn("[meta2d] Emit value must be a string");const i=this.getEventData(e.list,t);window.parent.postMessage(JSON.stringify({name:e.value,data:i}),"*")},this.events[ss.Message]=(t,e)=>{this.message({theme:e.params,content:e.value,...e.extend})}}getSendData(t){const e={};return t.forEach(t=>{if(t.prop)if(t.id&&""!==t.id){const i=this.findOne(t.id);e[t.prop]=i[t.key]}else if("string"==typeof t.value&&t.value.includes("${")){let i=t.value,n=i.match(/\$\{([^}]+)\}/g)?.map(t=>t.slice(2,-1));n&&n.forEach(t=>{i=i.replace(`\${${t}}`,this.getDynamicParam(t))}),e[t.prop]=i}else e[t.prop]=this.convertType(t.value,t.type)}),e}convertType(t,e){if("string"==typeof t)if(["switch","bool","boolean"].includes(e)){if("false"===t)return!1;if("true"===t)return!0}else if(["integer","number","int","enum","double","float"].includes(e)&&!isNaN(Number(t)))return Number(t);return t}getEventData(t,e){const i={};return t?.length&&t.forEach(t=>{const n=t.params?this.findOne(t.params):e;for(let e in t.value)if(void 0===t.value[e]||""===t.value[e])i[e]=n[e];else if("string"==typeof t.value[e]&&t.value[e]?.indexOf("${")>-1){let o=t.value[e].match(/\$\{([^}]+)\}/g)?.map(t=>t.slice(2,-1));o?.length&&(i[e]=n[o[0]]??this.getDynamicParam(o[0]))}else i[e]=t.value[e]}),Object.keys(i).length?i:{}}message(t){new hs(this.canvas.parentElement,t).init()}closeAll(){for(let t in cs)cs[t].close()}async navigatorTo(t){if(!t)return;let e=Mt()?.id;if(e){const e=new URL(window.location);e.searchParams.set("id",t),history.pushState({},"",e)}const i=await Ft(this.store,t);if(i){this.open(i),this.canvas.opening=!1,this.lock(1);const t=this.store.data.width||this.store.options.width,e=this.store.data.height||this.store.options.height;t&&e?this.fitSizeView(!0,0):this.fitView(!0,10)}}doSendDataEvent(t,e){let i=JSON.stringify(t);this.mqttClient&&this.mqttClient.connected&&(e?e.split(",").forEach(t=>{this.mqttClient.publish(t,i)}):this.store.data.mqttTopics&&this.store.data.mqttTopics.split(",").forEach(t=>{this.mqttClient.publish(t,i)})),this.websocket&&1===this.websocket.readyState&&this.websocket.send(i),(this.store.data.https||this.store.data.http)&&this.sendDatabyHttp(i),this.store.emitter.emit("sendData",i)}async sendDataToNetWork(t,e,i){const n=dt(i.network);if(n.data&&(Object.assign(n,n.data),delete n.data),"iot"!==n.protocol){if(n.url)if("http"===n.protocol){if("object"==typeof n.headers){let t=JSON.stringify(n.headers),e=t.match(/\$\{([^}]+)\}/g)?.map(t=>t.slice(2,-1));if(e?.length)for(let i=0;i<e.length;i++)t=t.replace(`\${${e[i]}}`,this.getDynamicParam(e[i]));n.headers=JSON.parse(t)}let o,s=n.url;if("GET"===n.method&&(o="?"+Object.keys(t).map(e=>e+"="+t[e]).join("&")),s.indexOf("${")>-1){let t=s.match(/\$\{([^}]+)\}/g)?.map(t=>t.slice(2,-1));t&&t.forEach(t=>{s=s.replace(`\${${t}}`,zt(e,t)||this.getDynamicParam(t))})}const a=await fetch(s+(o||""),{headers:n.headers||{},method:n.method,body:"POST"===n.method?JSON.stringify(t):void 0});if(a.ok){if(i.callback){const t=await a.text();if(!i.fn)try{if("string"!=typeof i.callback)throw new Error("[meta2d] Function callback must be string");const t=i.callback;i.fn=new Function("pen","data","context",t)}catch(t){console.error("[meta2d]: Error on make a function:",t)}i.fn?.(e,t,{meta2d:this,e:i})}console.info("http")}}else if("mqtt"===n.protocol){const e=this.mqttClients?.filter(t=>t.options.href===n.url);if(e&&e.length)e[0].connected&&n.topics.split(",").forEach(i=>{e[0].publish(i,JSON.stringify(t))});else{let e=rs.connect(n.url,n.options);e.on("connect",()=>{console.info("mqtt"),n.topics.split(",").forEach(i=>{e.publish(i,JSON.stringify(t)),setTimeout(()=>{e?.end()},1e3)})})}}else if("websocket"===n.protocol){const e=this.websockets?.filter(t=>t.url===n.url);if(e&&e.length)1===e[0].readyState&&e[0].send(JSON.stringify(t));else{let e=new WebSocket(n.url,n.protocols||void 0);e.onopen=function(){console.info("websocket"),e.send(JSON.stringify(t)),setTimeout(()=>{e.close()},100)}}}}else this.iotMqttClient&&this.iotMqttClient.publish(`le5le-iot/property/set/${this.store.data.iot?.token}`,JSON.stringify(t))}resize(t,e){this.canvas.resize(t,e),this.render(),this.store.emitter.emit("resize",{width:t,height:e}),this.canvas.scroll&&this.canvas.scroll.isShow&&this.canvas.scroll.init()}async addPen(t,e,i=!0,n=!1){return await this.canvas.addPen(t,e,i,n)}async addPens(t,e,i=!1){return await this.canvas.addPens(t,e,i)}render(t){this.canvas?.render(t)}async setBackgroundImage(t,e){let i=this;this.store.data.bkImage=t;const n=e?.width||this.store.data?.width||this.store.options?.width,o=e?.height||this.store.data?.height||this.store.options?.height;if(n&&o?(this.canvas.canvasTemplate.canvas.style.backgroundImage=null,this.canvas&&(this.canvas.canvasTemplate.bgPatchFlags=!0)):this.canvas.canvasTemplate.canvas.style.backgroundImage=t?`url('${t}')`:"",t){const e=await async function(t){return new Promise(e=>{const n=new Image;n.src=t,i.store.options.cdn&&!(t.startsWith("http")||t.startsWith("//")||t.startsWith("data:image"))&&(n.src=i.store.options.cdn+t),n.crossOrigin="anonymous",n.onload=()=>{e(n)}})}(t);this.store.bkImg=e,n&&o&&this.canvas&&(this.canvas.canvasTemplate.init(),this.render())}else this.store.bkImg=null}setBackgroundColor(t=this.store.data.background){this.store.data.background=t,this.canvas&&(this.canvas.canvasTemplate.bgPatchFlags=!0)}setGrid({grid:t=this.store.data.grid,gridColor:e=this.store.data.gridColor,gridSize:i=this.store.data.gridSize,gridRotate:n=this.store.data.gridRotate}={}){this.store.data.grid=t,this.store.data.gridColor=e,this.store.data.gridSize=i<0?0:i,this.store.data.gridRotate=n,this.canvas&&(this.canvas.canvasTemplate.bgPatchFlags=!0)}setRule({rule:t=this.store.data.rule,ruleColor:e=this.store.data.ruleColor}={}){this.store.data.rule=t,this.store.data.ruleColor=e,this.store.patchFlagsTop=!0}open(t,e=!0){if(this.clear(!1,t?.template),this.canvas.autoPolylineFlag=!0,t){t.theme&&this.setTheme(t.theme),this.setBackgroundImage(t.bkImage,t),Object.assign(this.store.data,t),this.store.data.pens=[];for(const e of t.pens)e.id||(e.id=Ct()),!e.calculative&&(e.calculative={canvas:this.canvas}),this.store.pens[e.id]=e;for(const e of t.pens)this.canvas.makePen(e)}if(this.canvas.patchFlagsLines.forEach(t=>{t.type&&this.canvas.initLineRect(t)}),this.store.data.template||(this.store.data.template=Ct()),e||(this.canvas.opening=!0),this.doInitJS(),this.initBindDatas(),this.initBinds(),this.doInitFn(),this.loadLineAnimateDraws(),this.initMessageEvents(),this.initGlobalTriggers(),this.startAnimate(),this.startVideo(),this.listenSocket(),this.connectSocket(),this.connectNetwork(),this.startDataMock(),this.canvas.initGlobalStyle(),this.render(),setTimeout(()=>{const t=this.store.data.pens.find(t=>t.autofocus);t&&this.focus(t.id)},100),this.store.data.iconUrls)for(const t of this.store.data.iconUrls)_t(t,()=>{this.render()});this.canvas.autoPolylineFlag=!1,this.store.emitter.emit("opened"),this.canvas.scroll&&this.canvas.scroll.isShow&&this.canvas.scroll.init()}dirtyData(t){const e=this.store.data.pens,i=this.store.data.width||this.store.options.width,n=this.store.data.height||this.store.options.height,o=[];for(let t=e.length-1;t>=0;t--){let s=e[t];if(s.parentId){const t=this.store.pens[s.parentId];s.x>10||s.y>10||s.width>10||s.height>10?o.push(s):t.children&&t.children.includes(s.id)||o.push(s)}if(i&&n){let t=this.getPenRect(s);(t.x<-10||t.y<-10||t.x+t.width>i||t.y+t.height>n)&&o.push(s)}"line"===s.name&&s.anchors.length<2&&o.push(s)}return i&&n||Ai(e).forEach(t=>{o.filter(e=>e.id===t.id).length||o.push(t)}),t&&this.active(o),o}clearDirtyData(){let t=this.dirtyData();this.delete(t,!0)}cacheData(t){if(t&&this.store.options.cacheLength){let e=this.store.cacheDatas.findIndex(e=>e.data&&e.data._id===t);if(-1===e)this.store.cacheDatas.push({data:dt(this.store.data,!0)}),this.store.cacheDatas.length>this.store.options.cacheLength&&this.store.cacheDatas.shift();else{let t=this.store.cacheDatas.splice(e,1)[0];this.store.cacheDatas.push(t)}}}loadCacheData(t){let e=this.store.cacheDatas.findIndex(e=>e.data&&e.data._id===t);-1!==e&&(this.store.data=this.store.cacheDatas[e].data,this.setBackgroundImage(this.store.data.bkImage),this.store.pens={},this.store.data.pens.forEach(t=>{t.calculative.canvas=this.canvas,this.store.pens[t.id]=t,V.path2dDraws[t.name]&&this.store.path2dMap.set(t,V.path2dDraws[t.name](t)),t.type&&this.store.path2dMap.set(t,V.path2dDraws[t.name](t)),t.image&&(t.calculative.imageDrawed=!1,this.canvas.loadImage(t))}),this.render())}loadLineAnimateDraws(){V.lineAnimateDraws={},Object.entries(this.store.data.lineAnimateDraws).forEach(([t,e])=>{V.lineAnimateDraws[t]=new Function("ctx","pen","state","index",e)})}statistics(){const t=this.store.data.pens.length,e=this.store.data.pens.filter(t=>t.image).length,i=this.store.data.pens.filter(t=>t.image&&t.calculative.inView).length,n=this.store.data.pens.filter(t=>t.name.endsWith("Dom")||y.includes(t.name)||this.store.options.domShapes.includes(t.name)||t.externElement).length,o=this.store.animates.size;let s=0;return Object.keys(this.store.bind).forEach(t=>{s+=this.store.bind[t].length}),Object.keys(this.store.bindDatas).forEach(t=>{s+=this.store.bindDatas[t].length}),{:t,:e,:i,dom:n,:o,:s}}initBindDatas(){this.store.bindDatas={},this.store.data.pens.forEach(t=>{t.form?.forEach(e=>{let i;e.dataIds&&(i=Array.isArray(e.dataIds)?e.dataIds:[e.dataIds]),i?.forEach(i=>{this.store.bindDatas[i.dataId]||(this.store.bindDatas[i.dataId]=[]),this.store.bindDatas[i.dataId].push({id:t.id,formItem:e})})})})}jetLinksList=[];jetLinksClient;initBinds(){this.jetLinksList=[],this.store.bind={};const t=[],e=[];this.store.data.pens.forEach(i=>{i.realTimes?.forEach(n=>{if(n.bind&&n.bind.id){let o=n.productId||i.productId,s=n.deviceId||i.deviceId,a=n.propertyId,r=!1;if(o&&o.indexOf("${")>-1){let t=o.match(/(?<=\$\{).*?(?=\})/g);t?.length&&(o=this.getDynamicParam(t[0])||o),r=!0}if(s&&s.indexOf("${")>-1){let t=s.match(/(?<=\$\{).*?(?=\})/g);t?.length&&(s=this.getDynamicParam(t[0])||s),r=!0}if(a&&a.indexOf("${")>-1){let t=a.match(/(?<=\$\{).*?(?=\})/g);t?.length&&(a=this.getDynamicParam(t[0])||a),r=!0}if(r&&n.bind&&(n.bind.id=o+"#"+s+"#"+a),this.store.bind[n.bind.id]||(this.store.bind[n.bind.id]=[]),this.store.bind[n.bind.id].push({id:i.id,key:n.key}),o&&s&&a){const t=this.jetLinksList.findIndex(t=>t.topic.startsWith(`/${o}/${s}`));t>-1?this.jetLinksList[t].properties.includes(n.propertyId)||this.jetLinksList[t].properties.push(n.propertyId):this.jetLinksList.push({topic:`/${o}/${s}`,deviceId:s,properties:[n.propertyId]})}if("iot"===n.bind.class){let i=n.bind.id.split("#"),o=t.findIndex(t=>t.deviceId===i[0]);o>-1?t[o].properties.includes(i[1])||t[o].properties.push(i[1]):t.push({deviceId:i[0],properties:[i[1]],token:n.bind.token}),-1===e.findIndex(t=>t.key===n.bind.id)&&e.push({key:n.bind.id,label:n.bind.label})}else if("sql"===n.bind.class){let t=n.bind.id.split("#");const e=this.store.data.sqls.find(e=>e.bindId===t[0]);if(e){e.keys||(e.keys=[]),t.shift();const i=t.join("#");e.keys.includes(i)||e.keys.push(i)}}}}),i.events?.forEach(e=>{const i=e.actions?.filter(t=>t.action===ss.SendData);i?.forEach(e=>{e.data?.forEach(e=>{if("iot"===e.class){let i=e.prop.split("#"),n=t.findIndex(t=>t.deviceId===i[0]);n>-1?t[n].properties.includes(i[1])||t[n].properties.push(i[1]):t.push({deviceId:i[0],properties:[i[1]],token:e.token})}})})})}),t.length&&(this.store.data.iot||(this.store.data.iot={}),this.store.data.iot.devices=t),e.length&&(this.store.data.iot.list=e)}connectSocket(){this.connectWebsocket(),this.connectMqtt(),this.connectHttp()}doInitJS(){const t=this.store.data.initJs;if(t&&t.trim())try{new Function("context",t)({meta2d:this})}catch(t){console.warn("initJs error",t)}}doInitFn(){let t=Mt(),e=[];for(let i in t)t.hasOwnProperty(i)&&i.startsWith("bind-")&&e.push({id:i.replace("bind-",""),dataId:i.replace("bind-",""),value:t[i]});e.length&&this.setDatas(e,{history:!1})}drawLine(t){t&&ao(this.store),this.canvas.drawingLineName=t}alignPenToGrid(t){this.canvas.alignPenToGrid(t)}drawingPencil(){this.canvas.drawingPencil()}stopPencil(){this.canvas.stopPencil()}lock(t){this.store.data.locked=t,this.finishDrawLine(!0),this.canvas.drawingLineName="",this.stopPencil(),this.store.data.pens.forEach(t=>{!0===t.externElement&&t.calculative.singleton?.div&&ti(t,t.calculative.singleton.div)}),t>0&&this.initMessageEvents()}async finishDrawLine(t){await this.canvas.finishDrawline(t)}async finishPencil(){await this.canvas.finishPencil()}updateLineType(t,e){if(!t||"line"!=t.name||!e||!this.canvas[e])return;t.lineName=e;const i=qe(t),n=$e(t);i.prev=void 0,i.next=void 0,n.prev=void 0,n.next=void 0,t.calculative.worldAnchors=[i,n],t.calculative.activeAnchor=i,this.canvas[e](this.store,t,n),"curve"===t.lineName&&(i.prev={penId:i.penId,x:i.x-50,y:i.y},i.next={penId:i.penId,x:i.x+50,y:i.y},n.prev={penId:n.penId,x:n.x-50,y:n.y},n.next={penId:n.penId,x:n.x+50,y:n.y}),t.calculative.activeAnchor=void 0,this.canvas.initLineRect(t),this.render()}addDrawLineFn(t,e){this.canvas[t]=e,this.canvas.drawLineFns.push(t)}removeDrawLineFn(t){const e=this.canvas.drawLineFns.indexOf(t);e>-1&&this.canvas.drawLineFns.splice(e,1)}showMagnifier(){this.canvas.showMagnifier()}hideMagnifier(){this.canvas.hideMagnifier()}toggleMagnifier(){this.canvas.toggleMagnifier()}clear(t=!0,e){for(const t of this.store.data.pens)t.onDestroy?.(t);it(this.store,e),this.hideInput(),this.canvas.tooltip.hide(),this.map&&this.map.isShow&&(this.map.show(),this.map.setView()),this.canvas.clearCanvas(),sessionStorage.removeItem("page"),this.store.clipboard=void 0,this.store.sameTemplate||(this.canvas.canvasTemplate.bgPatchFlags=!0),this.store.patchFlagsBackground=!0,this.store.patchFlagsTop=!0,this.setBackgroundImage(void 0),t&&this.render()}emit(t,e){this.store.emitter.emit(t,e)}on(t,e){return this.store.emitter.on(t,e),this}off(t,e){return this.store.emitter.off(t,e),this}register=U;registerCanvasDraw=q;registerAnchors=$;registerLineAnimateDraws=(t,e)=>{this.store.data.lineAnimateDraws[t]=e,V.lineAnimateDraws[t]=new Function("ctx","pen","state","index",e)};updateLineAnimateDraws(t,e){e&&(delete this.store.data.lineAnimateDraws[t],delete V.lineAnimateDraws[t],-1!==e&&this.registerLineAnimateDraws(e.name||t,e.code))}registerMoveDock(t){this.canvas.customMoveDock=t}registerResizeDock(t){this.canvas.customResizeDock=t}find(t){return this.canvas.find(t)}findOne(t){return this.canvas.findOne(t)}getPenRect(t){return this.canvas.getPenRect(t)}setPenRect(t,e,i=!0){this.canvas.setPenRect(t,e,i)}startAnimate(t,e){let i;this.stopAnimate(t),i=t?"string"==typeof t?this.find(t):t:this.store.data.pens.filter(t=>(t.type||t.frames)&&t.autoPlay||t.animations&&t.animations.length&&-1!==t.animations.findIndex(t=>t.autoPlay)),i.length&&(i.forEach(t=>{if(t.calculative.pause){const e=Date.now()-t.calculative.pause;t.calculative.pause=void 0,t.calculative.frameStart+=e,t.calculative.frameEnd+=e}else{let i=-1;if(void 0!==e&&t.animations){if("string"==typeof e){if(i=t.animations.findIndex(t=>t.name===e),-1===i)return}else if("number"==typeof e){if(!(t.animations.length>e))return;i=e}}else void 0===e&&(i=t.animations?.findIndex(t=>t.autoPlay),-1===i&&t.animations?.length&&(i=0));if(-1!==i&&void 0!==i){const e=dt(t.animations[i]);e.animateName=e.name,delete e.name,e.currentAnimation=i,!t.type&&e.frames&&(e.showDuration=this.calcAnimateDuration(e)),this.setValue({id:t.id,...e},{doEvent:!1,history:!1})}this.store.animates.add(t),t.type||this.store.animateMap.set(t,t.calculative.canvas.getFrameProps(t))}}),this.initImageCanvas(i),this.canvas.animate())}pauseAnimate(t){let e=[];t?e="string"==typeof t?this.find(t):t:this.store.animates.forEach(t=>{e.push(t)}),e.forEach(t=>{t.calculative.pause||(t.calculative.pause=Date.now())})}stopAnimate(t){let e=[];t?e="string"==typeof t?this.find(t):t:this.store.animates.forEach(t=>{e.push(t)}),e.forEach(t=>{t.currentAnimation=void 0,t.calculative.pause=void 0,t.calculative.start=void 0,t.calculative.cycleStart=void 0,t.calculative.duration=void 0,t.calculative.animatePos=0,this.store.animates.delete(t),this.canvas.restoreNodeAnimate(t),this.canvas.updateLines(t),this.store.animateMap.delete(t)}),this.initImageCanvas(e),setTimeout(()=>{this.canvas?.calcActiveRect(),this.render()},20)}startVideo(t){let e;e=t?"string"==typeof t?this.find(t):t:this.store.data.pens.filter(t=>(t.video||t.audio)&&t.autoPlay),e.forEach(t=>{t.calculative.media?.play(),t.onStartVideo?.(t)})}pauseVideo(t){let e=[];e=t?"string"==typeof t?this.find(t):t:this.store.data.pens.filter(t=>(t.video||t.audio)&&t.autoPlay),e.forEach(t=>{t.calculative.media?.pause(),t.onPauseVideo?.(t)})}stopVideo(t){let e=[];e=t?"string"==typeof t?this.find(t):t:this.store.data.pens.filter(t=>(t.video||t.audio)&&t.autoPlay),e.forEach(t=>{t.calculative.media&&(t.calculative.media.currentTime=0,t.calculative.media.pause()),t.onStopVideo?.(t)})}calcAnimateDuration(t){return t.frames.reduce((t,e)=>t+e.duration,0)}combine(t=this.store.active,e,i=!0){if(!t||!t.length)return;const n=dt(t);if(1===t.length&&t[0].type)return t[0].type=s.Node,this.canvas.active(t),this.pushHistory({type:Z.Update,initPens:n,pens:dt(t,!0)}),void this.render();const o=Oi(t);let r={id:Ct(),name:"combine",...o,children:[],showChild:e};this.canvas.makePen(r);const l=dt(r);let c=1/0;return t.forEach(t=>{const e=this.store.data.pens.findIndex(e=>e.id===t.id);if(e<c&&(c=e),t===r||t.parentId===r.id||t.id===r.id)return;r.children.push(t.id),t.parentId=r.id;const i=qi(t.calculative.worldRect,o);Object.assign(t,i),t.locked=t.lockedOnCombine??a.None,t.locked=t.interaction||m.includes(t.name)?0:t.locked}),this.store.data.pens.splice(c,0,r),this.store.data.pens.pop(),i&&this.canvas.active([r]),this.pushHistory({type:Z.Add,pens:[l],step:3}),this.pushHistory({type:Z.Update,initPens:[l],pens:[r],step:3}),this.pushHistory({type:Z.Update,initPens:n,pens:t,step:3}),null!=e&&(t.forEach(t=>{li(t,!0)}),this.initImageCanvas([r])),this.store.emitter.emit("combine",[r]),this.render(),r}uncombine(t){if(!t&&this.store.active&&(t=this.store.active[0]),!t||!t.children)return;const e=t.children.map(t=>this.store.pens[t]);let i=dt(e);e.forEach(t=>{t.parentId=void 0,t.x=t.calculative.worldRect.x,t.y=t.calculative.worldRect.y,t.width=t.calculative.worldRect.width,t.height=t.calculative.worldRect.height,t.locked=a.None,t.calculative.active=void 0,t.calculative.hover=!1,this.setVisible(t,!0)});const n=this.isCombine(t)?3:2;this.pushHistory({type:Z.Update,initPens:i,pens:e,step:n}),i=[dt(t)],t.children=void 0,this.pushHistory({type:Z.Update,initPens:i,pens:[t],step:n}),this.isCombine(t)&&(this.delete([t]),this.store.histories[this.store.histories.length-1].step=n),this.inactive()}clearCombine(t){if(!t&&this.store.active&&(t=this.store.active[0]),!t||!t.children)return;const e=Ut(t,this.store);e.forEach(t=>{t.parentId=void 0,t.x=t.calculative.worldRect.x,t.y=t.calculative.worldRect.y,t.width=t.calculative.worldRect.width,t.height=t.calculative.worldRect.height,t.locked=a.None,t.calculative.active=void 0,t.calculative.hover=!1,void 0!==t.showChild&&this.setVisible(t,!0),t.children=void 0});const i=[];e.forEach((t,e)=>{"combine"===t.name&&(t.children=void 0,i.push(t))}),this.delete(i,!0,!1),t.children=void 0,this.isCombine(t)&&this.delete([t],!0,!1),this.inactive()}appendChild(t=this.store.active){if(!t)return;if(t.length<2)return;const e=t.findIndex(t=>"combine"===t.name&&void 0!==t.showChild);if(-1!==e){let i=t[e];const n=Oi(t);Object.assign(i,n),Object.assign(i.calculative.worldRect,n),Ie(i),i.children.forEach(t=>{const e=this.store.pens[t],i=qi(e.calculative.worldRect,n);Object.assign(e,i)}),t.forEach(t=>{if(t.id!==i.id){i.children.push(t.id),t.parentId=i.id;const e=qi(t.calculative.worldRect,n);Object.assign(t,e),t.locked=t.lockedOnCombine??a.DisableMove,t.locked=t.interaction||m.includes(t.name)?0:t.locked,li(t,!0)}}),this.initImageCanvas(t),this.render()}else console.warn("Invalid operation!")}updateRectbyChild(t,e,i){if(Mi(t),_i(t),e.calculative.worldRect=t,i.container&&Fi(t,i.calculative.worldRect,!0)){const n=qi(t,i.calculative.worldRect);Object.assign(e,n)}else{if(i.container){let e=Math.min(t.x,i.calculative.worldRect.x),n=Math.min(t.y,i.calculative.worldRect.y),o=Math.max(t.ex,i.calculative.worldRect.ex),s=Math.max(t.ey,i.calculative.worldRect.ey);i.calculative.worldRect={x:e,y:n,width:o-e,height:s-n,ex:o,ey:s},_i(i.calculative.worldRect)}else{const t=i.children.map(t=>this.store.pens[t]);i.calculative.worldRect=Oi(t)}i.parentId||Object.assign(i,i.calculative.worldRect),i.children.forEach(t=>{const e=this.store.pens[t],n=qi(e.calculative.worldRect,i.calculative.worldRect);Object.assign(e,n)}),i.parentId&&this.updateRectbyChild(i.calculative.worldRect,i,this.store.pens[i.parentId])}this.canvas.updatePenRect(i),this.render()}isCombine(t){return"combine"===t.name||!!(t.children&&t.children.length>0)}active(t,e=!0){this.canvas.active(t,e)}inactive(){this.canvas.inactive()}activeAll(){this.canvas.active(this.store.data.pens.filter(t=>!t.parentId&&t.locked!==a.Disable)),this.render()}focus(t){const e=this.findOne(t);e&&(this.store.hover=e,this.store.hover.calculative.hover=!0,this.showInput(e))}delete(t,e=!1,i=!0){this.canvas.delete(t,e,i)}scale(t,e={x:0,y:0}){this.canvas.scale(t,e)}translate(t,e){this.canvas.translate(t,e)}translatePens(t,e,i){this.canvas.translatePens(t,e,i)}getParent(t,e){return Vt(t,e)}getAllChildren(t){return Ut(t,this.store)}getAllFollowers(t){return qt(t,this.store)}data(){const t=dt(this.store.data),{pens:e,paths:i}=this.store.data;t.version=W,t.paths={};for(const n in i)Object.prototype.hasOwnProperty.call(i,n)&&e.find(t=>t.pathId===n)&&(t.paths[n]=i[n]);return t.dataPoints=[...Object.keys(this.store.bind),...Object.keys(this.store.bindDatas)],t}copy(t){this.canvas.copy(t)}cut(t){this.canvas.cut(t)}paste(){this.canvas.paste()}undo(){this.canvas.undo()}redo(){this.canvas.redo()}listenSocket(){try{let t;const e=this.store.data.socketCbJs;if(e&&(t=new Function("e","context",e)),!t)return this.socketFn=null,!1;this.socketFn=t}catch(t){return console.error("Create the function for socket:",t),!1}return!0}websocketTimes=0;connectWebsocket(t){this.closeWebsocket(),t&&(this.store.data.websocket=t),this.store.data.websocket&&(this.websocket=new WebSocket(this.store.data.websocket,this.store.data.websocketProtocols||void 0),this.websocket.onmessage=t=>{this.socketCallback(t.data,{type:"websocket",url:this.store.data.websocket})},this.websocket.onerror=t=>{this.store.emitter.emit("error",{type:"websocket",error:t})},this.websocket.onclose=()=>{if(this.store.options.reconnetTimes&&(this.websocketTimes++,this.websocketTimes>=this.store.options.reconnetTimes))return this.websocketTimes=0,void this.closeWebsocket();console.info("Canvas websocket closed and reconneting..."),this.connectWebsocket()})}closeWebsocket(){this.websocket&&(this.websocket.onclose=void 0,this.websocket.close(),this.websocket=void 0)}mqttTimes=0;connectMqtt(t){if(this.closeMqtt(),t&&(this.store.data.mqtt=t.mqtt,this.store.data.mqttTopics=t.mqttTopics,this.store.data.mqttOptions=t.mqttOptions),this.store.data.mqtt){this.store.data.mqttOptions.clientId&&!this.store.data.mqttOptions.customClientId&&(this.store.data.mqttOptions.clientId=Ct());const t={...this.store.data.mqttOptions};t.username||delete t.username,t.password||delete t.password;const{username:e,password:i}=t;e&&i||!e&&!i?(this.mqttClient=rs.connect(this.store.data.mqtt,t),this.mqttClient.on("message",(t,e)=>{this.socketCallback(e.toString(),{topic:t,type:"mqtt",url:this.store.data.mqtt})}),this.mqttClient.on("error",t=>{this.store.emitter.emit("error",{type:"mqtt",error:t})}),this.mqttClient.on("close",()=>{this.store.options.reconnetTimes&&(this.mqttTimes++,this.mqttTimes>=this.store.options.reconnetTimes&&(this.mqttTimes=0,this.closeMqtt()))}),this.store.data.mqttTopics&&this.mqttClient.subscribe(this.store.data.mqttTopics.split(","))):console.warn("")}}closeMqtt(){this.mqttClient?.end()}httpTimer;httpTimerList=[];connectHttp(){this.closeHttp();const{https:t}=this.store.data;if(t)this.store.data.cancelFirstConnect||t.forEach(async t=>{this.oldRequestHttp(t)}),t.forEach((t,e)=>{t.http&&0!==t.httpTimeInterval&&(t.times=0,this.httpTimerList[e]=setInterval(async()=>{this.oldRequestHttp(t),this.store.options.reconnetTimes&&t.times>=this.store.options.reconnetTimes&&(t.times=0,clearInterval(this.httpTimerList[e]),this.httpTimerList[e]=void 0)},t.httpTimeInterval||1e3))});else{const{http:t,httpTimeInterval:e,httpHeaders:i}=this.store.data;t&&(this.httpTimer=setInterval(async()=>{const e=await fetch(t,{headers:i});if(e.ok){const i=await e.text();this.socketCallback(i,{type:"http",url:t})}},e||1e3))}}async oldRequestHttp(t){let e=dt(t);if(e.http){const i=await fetch(e.http,{headers:e.httpHeaders,method:e.method||"GET",body:"POST"===e.method?JSON.stringify(e.body):void 0});if(i.ok){const t=await i.text();this.socketCallback(t,{type:"http",url:e.http})}else t.times++,this.store.emitter.emit("error",{type:"http",error:i})}}async sendDatabyHttp(t){const{https:e}=this.store.data;if(e)e.forEach(async e=>{e.http&&(await fetch(e.http,{method:"post",body:t,headers:e.httpHeaders})).ok&&console.info("http")});else{const{http:e,httpHeaders:i}=this.store.data;e&&(await fetch(e,{method:"post",body:t,headers:i})).ok&&console.info("http")}}closeHttp(){clearInterval(this.httpTimer),this.httpTimer=void 0,this.httpTimerList&&this.httpTimerList.forEach(t=>{clearInterval(t),t=void 0})}updateTimer;updateTimerList=[];sqlTimerList=[];connectNetwork(){this.closeNetwork();const{networks:t}=this.store.data,e=[];if(t){let i=0,n=0,o=0,s=0;this.mqttClients=[],this.websockets=[],this.eventSources=[],t.forEach(async t=>{"mqtt"===t.protocol?(t.index=i,this.connectNetMqtt(t),i+=1):"websocket"===t.protocol?(t.index=o,this.connectNetWebSocket(t),o+=1):"http"===t.protocol?(t.index=n,e.push({url:t.url,interval:t.interval,headers:t.headers||void 0,method:t.method,body:t.body,enable:t.enable,index:t.index,once:t.once}),n+=1):"ADIIOT"===t.protocol?function(t,e){if(t.jetLinksList.length){let i=e.url;i.startsWith("/")&&(i=("https:"===location.protocol?"wss://":"ws://")+window.location.host+i),t.jetLinksClient=new WebSocket(`${i}/${localStorage.getItem("X-Access-Token")||Dt("X-Access-Token")||new URLSearchParams(location.search).get("X-Access-Token")||""}`),t.jetLinksClient.onmessage=e=>{const i=JSON.parse(e.data);if(i.payload)if(i.payload?.properties){const e=[];for(let t in i.payload.properties)e.push({id:`${i.payload.headers.productId}#${i.payload.deviceId}#${t}`,value:i.payload.properties[t]});t.setDatas(e,{history:!1})}else i.topic.startsWith("/notifications")&&ds(t,i)},t.jetLinksClient.onopen=()=>{t.jetLinksList.forEach(e=>{t.jetLinksClient.send(JSON.stringify({type:"sub",topic:`/device${e.topic}/message/property/report`,parameter:{deviceId:e.deviceId,properties:e.properties,history:1},id:e.topic+"-"+Ct()}))}),e.notification&&t.jetLinksClient.send(JSON.stringify({type:"sub",topic:"/notifications",id:"notification",parameter:{}}))}}}(this,t):"SSE"===t.protocol&&(t.index=s,this.connectSSE(t),s+=1)})}this.onNetworkConnect(e),this.connectIot(),this.connectSqls()}reconnectNetwork(t){const e=this.store.data.networks[t];if("mqtt"===e.protocol)this.mqttClients&&this.mqttClients[e.index]?.end(),this.connectNetMqtt(e);else if("websocket"===e.protocol)this.websockets&&this.websockets[e.index]&&(this.websockets[e.index].onclose=void 0,this.websockets[e.index].close(),this.websockets[e.index]=void 0),this.connectNetWebSocket(e);else if("http"===e.protocol){this.updateTimerList&&(clearInterval(this.updateTimerList[e.index]),this.updateTimerList[e.index]=void 0);const t=dt(e);this.store.data.cancelFirstConnect||this.requestHttp(t),this.updateTimerList[e.index]=setInterval(async()=>{this.requestHttp(t)},t.interval||1e3)}else"SSE"===e.protocol&&(this.eventSources&&(this.eventSources[e.index]?.close(),this.eventSources[e.index]=void 0),this.connectSSE(e))}iotMqttClient;iotTimer;iotWebsocketClient;async connectIot(){const{iot:t}=this.store.data;if(!t||!t?.devices?.length||t&&!1===t.enable)return;const e=globalThis.iotUrl||await this.getMqttUrl();if(!e)return void console.warn("iot Request address error");const i=await this.getIotToken(t.devices,"websocket"===t.protocol?1:void 0);t.token=i,this.iotMqttClient=rs.connect(e),this.iotMqttClient.on("message",(t,n)=>{this.socketCallback(n.toString(),{topic:`le5le-iot/properties/${i}`,type:"iot",url:e,method:"mqtt"})}),this.iotMqttClient.on("error",t=>{this.store.emitter.emit("error",{type:"mqtt",error:t})}),this.iotMqttClient.subscribe(`le5le-iot/properties/${i}`),this.iotTimer=setInterval(()=>{this.iotMqttClient&&this.iotMqttClient.publish("le5le-iot/subscribe/ping",i)},3e5)}closeIot(){if(this.iotMqttClient){const{iot:t}=this.store.data;t?.token&&this.unsubscribeIot(t.token),this.iotMqttClient.end(),this.iotMqttClient=void 0}clearInterval(this.iotTimer),this.iotTimer=void 0}connectSqls(){const{sqls:t}=this.store.data;t&&t.length&&t.forEach(async(t,e)=>{!1!==t.enable&&(await this.doSqlCode(t),t.interval&&(t.index=e,this.sqlTimerList[e]=setInterval(async()=>{await this.doSqlCode(t)},t.interval)))})}connectSSE(t){!1!==t.enable&&(this.eventSources[t.index]=new EventSource(t.url,{withCredentials:t.withCredentials}),this.eventSources[t.index].onmessage=e=>{this.socketCallback(e.data,{type:"SSE",url:t.url,name:t.name,net:t})},this.eventSources[t.index].onerror=t=>{this.store.emitter.emit("error",{type:"SSE",error:t})})}closeSSE(){this.eventSources&&this.eventSources.forEach(t=>{t&&(t.close(),t=void 0)})}connectNetMqtt(t){if(!1===t.enable)return;t.options.clientId&&!t.options.customClientId&&(t.options.clientId=Ct());let e=t.url;if(e.indexOf("${")>-1){let t=e.match(/\$\{([^}]+)\}/g)?.map(t=>t.slice(2,-1));t&&t.forEach(t=>{e=e.replace(`\${${t}}`,this.getDynamicParam(t))})}t.times=0;let i=dt(t.options);if(i?.username&&i.username.includes("${")){let t=i.username.match(/\$\{([^}]+)\}/g)?.map(t=>t.slice(2,-1));t&&t.forEach(t=>{i.username=i.username.replace(`\${${t}}`,this.getDynamicParam(t))})}if(i?.password&&i.password.includes("${")){let t=i.password.match(/\$\{([^}]+)\}/g)?.map(t=>t.slice(2,-1));t&&t.forEach(t=>{i.password=i.password.replace(`\${${t}}`,this.getDynamicParam(t))})}if(this.mqttClients[t.index]=rs.connect(e,i),this.mqttClients[t.index].on("message",(e,i)=>{this.socketCallback(i.toString(),{topic:e,type:"mqtt",url:t.url,name:t.name,net:t})}),this.mqttClients[t.index].on("error",t=>{this.store.emitter.emit("error",{type:"mqtt",error:t})}),this.mqttClients[t.index].on("close",()=>{this.store.options.reconnetTimes&&(t.times++,t.times>=this.store.options.reconnetTimes&&(t.times=0,this.mqttClients&&this.mqttClients[t.index]?.end()))}),t.topics){let e=t.topics;if(e.indexOf("${")>-1){let t=e.match(/\$\{([^}]+)\}/g)?.map(t=>t.slice(2,-1));t&&t.forEach(t=>{e=e.replace(`\${${t}}`,this.getDynamicParam(t))})}this.mqttClients[t.index].subscribe(e.split(","))}}connectNetWebSocket(t){if(this.websockets[t.index]&&(this.websockets[t.index].onclose=void 0,this.websockets[t.index]?.close(),this.websockets[t.index]=void 0),!1===t.enable)return;let e=t.url;if(e.indexOf("${")>-1){let t=e.match(/\$\{([^}]+)\}/g)?.map(t=>t.slice(2,-1));t&&t.forEach(t=>{e=e.replace(`\${${t}}`,this.getDynamicParam(t))})}this.websockets[t.index]=new WebSocket(e,t.protocols||void 0),this.websockets[t.index].onmessage=e=>{this.socketCallback(e.data,{type:"websocket",url:t.url,name:t.name,net:t})},this.websockets[t.index].onerror=t=>{this.store.emitter.emit("error",{type:"websocket",error:t})},this.websockets[t.index].onclose=()=>{if(this.store.options.reconnetTimes&&(t.times++,t.times>=this.store.options.reconnetTimes))return t.times=0,this.websockets[t.index].onclose=void 0,this.websockets[t.index]?.close(),void(this.websockets[t.index]=void 0);setTimeout(()=>{console.info("Canvas websocket closed and reconneting..."),this.connectNetWebSocket(t)},2e3)}}async getMqttUrl(){const t=await fetch("/api/iot/app/mqtt",{method:"GET",headers:{Authorization:`Bearer ${Nt()}`}});if(t.ok){const e=await t.text();let i=JSON.parse(e);if(!i.wssPort&&!i.wsPort)return;return`${"https:"===location.protocol?"wss":"ws"}://${i.host}:${"https:"===location.protocol?i.wssPort:i.wsPort}${i.path}`}}async getIotToken(t,e){const i=await fetch("/api/iot/subscribe/properties",{method:"POST",headers:{Authorization:`Bearer ${Nt()}`},body:JSON.stringify({devices:t,type:e})});if(i.ok){const t=await i.text();return JSON.parse(t).token}}async unsubscribeIot(t){return await fetch("/api/iot/unsubscribe/properties",{method:"POST",headers:{Authorization:`Bearer ${Nt()}`},body:JSON.stringify({token:t})})}async doSqlCode(t){const e=t.method||"get";let i=t.sql;"list"===e&&("oracle"===t.dbType?i.includes("OFFSET")||(i+=` OFFSET ${(t.current||0)*(t.pageSize||20)} ROWS FETCH NEXT ${t.pageSize||20} ROWS ONLY`):i.includes("LIMIT")||(i+=` LIMIT ${t.pageSize||20}`+(t.current>1?" OFFSET "+(t.current-1)*(t.pageSize||20):"")));const n=await fetch(`/api/iot/data/sql/${e}`,{method:"POST",headers:{Authorization:`Bearer ${Dt("token")||localStorage.getItem("token")||new URLSearchParams(location.search).get("token")||""}`},body:JSON.stringify({dbId:t.dbId||t.dbid,sql:i})});if(n.ok){let i=await n.text();if(i){const n=[];if(i=JSON.parse(i),i.error)return void this.store.emitter.emit("error",{type:"sql",error:i.error});t.keys?.forEach(e=>{n.push({id:t.bindId+"#"+e,value:zt(i,e.split("#").join("."))})}),n.push({id:t.bindId,value:i}),this.socketCallback(JSON.stringify(n),{type:"sql",url:`/api/iot/data/sql/${e}`,method:e})}}}randomString(t){t=t||32;let e="";for(let i=0;i<t;i++)e+="ABCDEFGHJKMNPQRSTWXYZabcdefhijkmnprstwxyz2345678".charAt(Math.floor(48*Math.random()));return e}mockValue(t){let e;if(t.enableMock&&void 0!==t.mock)if("float"===t.type)if(t.mock&&-1!==t.mock.indexOf(",")){let i=t.mock.split(","),n=Math.floor(Math.random()*i.length);e=parseFloat(i[n])}else if(t.mock&&-1!==t.mock.indexOf("-")){let i,n,o,s=t.mock.split("-");if("-"===t.mock.charAt(0)?4===s.length?(i=-parseFloat(s[3]),n=-parseFloat(s[1]),o=s[3]):(i=parseFloat(s[2]),n=-parseFloat(s[1]),o=s[2]):(i=parseFloat(s[1]),n=parseFloat(s[0]),o=s[1]),-1!==(o+"").indexOf(".")){let t=(o+"").split(".")[1].length;e=(Math.random()*(i-n)+n).toFixed(t)}else e=Math.random()*(i-n)+n}else e=parseFloat(t.mock);else if("integer"===t.type)if(t.mock&&-1!==t.mock.indexOf(",")){let i=t.mock.split(","),n=Math.floor(Math.random()*i.length);e=parseInt(i[n])}else if(t.mock&&-1!==t.mock.indexOf("-")){let i,n,o=t.mock.split("-");"-"===t.mock.charAt(0)?4===o.length?(i=-parseFloat(o[3]),n=-parseFloat(o[1])):(i=parseFloat(o[2]),n=-parseFloat(o[1])):(i=parseInt(o[1]),n=parseInt(o[0])),e=parseInt(Math.random()*(i-n)+n+"")}else e=parseInt(t.mock);else if("bool"===t.type)e="boolean"==typeof t.mock?t.mock:"true"===t.mock||"false"!==t.mock&&Math.random()<.5;else if("object"===t.type||"array"===t.type)t.mock;else if(t.mock&&-1!==t.mock.indexOf(",")){let i=t.mock.split(",");e=i[Math.floor(Math.random()*i.length)]}else if(t.mock&&t.mock.startsWith("[")&&t.mock.endsWith("]")){let i=parseInt(t.mock.substring(1,t.mock.length-1));e=this.randomString(i)}else e=t.mock;return e}dataMock(){let t=[];this.store.data.dataset?.devices?.forEach(e=>{let i=this.mockValue(e);void 0!==i&&t.push({id:e.id,value:i})}),t.length&&this.setDatas(t,{render:!0,doEvent:!0,history:!1})}networkMock(){if(this.store.data.networks&&this.store.data.networks.length){let t=[];this.store.data.networks.forEach(e=>{!1===e.enable&&e.children?.forEach(e=>{let i=dt(e);i.enableMock=!0;let n=this.mockValue(i);void 0!==n&&t.push({id:e.id,value:n})})}),t.length&&this.setDatas(t,{render:!0,doEvent:!0,history:!1})}}startDataMock(){this.store.data.enableMock?(this.stopDataMock(),this.initBinds(),this.updateTimer=setInterval(()=>{this.store.data.pens.forEach(t=>{this.penMock(t)}),this.networkMock(),this.render()},this.store.data.networkInterval||1e3)):this.stopDataMock()}stopDataMock(){clearInterval(this.updateTimer),this.updateTimer=void 0}penMock(t){if(t.realTimes){let e={};if(t.realTimes.forEach(t=>{let i=this.mockValue(t);void 0!==i&&(e[t.key]=i)}),Object.keys(e).length){let i=t.onBeforeValue?t.onBeforeValue(t,e):e;this.canvas.updateValue(t,i),t.onValue?.(t),this.store.emitter.emit("valueUpdate",t)}}}penNetwork(t){const e={url:t.apiUrl,method:t.apiMethod,headers:t.apiHeaders,body:t.apiBody};this.requestHttp(e),t.apiEnable?(this.store.pensNetwork||(this.store.pensNetwork={}),this.store.pensNetwork[t.id]=e):delete this.store.pensNetwork[t.id]}getDynamicParam(t){return Mt()[t]||localStorage[t]||Dt(t)||globalThis[t]||""}onNetworkConnect(t){if(t&&t.length){if(this.store.pensNetwork)for(let e in this.store.pensNetwork)t.push(this.store.pensNetwork[e]);this.store.data.cancelFirstConnect||t.forEach(async t=>{!1!==t.enable&&this.requestHttp(t)}),t.forEach((t,e)=>{t.times=0,0!==t.interval&&!1!==t.enable&&(t.once?setTimeout(async()=>{this.requestHttp(t)},t.interval||1e3):this.updateTimerList[e]=setInterval(async()=>{this.requestHttp(t),this.store.options.reconnetTimes&&t.times>=this.store.options.reconnetTimes&&(t.times=0,clearInterval(this.updateTimerList[e]),this.updateTimerList[e]=void 0)},t.interval||1e3))})}}async requestHttp(t){let e=dt(t);if(e.url){if(e.url.indexOf("${")>-1){let t=e.url.match(/\$\{([^}]+)\}/g)?.map(t=>t.slice(2,-1));t&&t.forEach(t=>{e.url=e.url.replace(`\${${t}}`,this.getDynamicParam(t))})}if("object"==typeof e.headers){let t=JSON.stringify(e.headers),i=t.match(/\$\{([^}]+)\}/g)?.map(t=>t.slice(2,-1));if(i?.length)for(let e=0;e<i.length;e++)t=t.replace(`\${${i[e]}}`,this.getDynamicParam(i[e]));e.headers=JSON.parse(t)}if("object"==typeof e.body){let t=JSON.stringify(e.body),i=t.match(/\$\{([^}]+)\}/g)?.map(t=>t.slice(2,-1));if(i?.length)for(let e=0;e<i.length;e++)t=t.replace(`\${${i[e]}}`,this.getDynamicParam(i[e]));e.body=JSON.parse(t)}const i=await fetch(e.url,{headers:e.headers,method:e.method,body:"GET"===e.method?void 0:JSON.stringify(e.body)});if(i.ok){const t=await i.text(),n=this.store.data.networks.filter(t=>"http"===t.protocol)[e.index];this.socketCallback(t,{type:"http",url:e.url,name:e.name,net:n})}else t.times++,this.store.emitter.emit("error",{type:"http",error:i})}}closeNetwork(){this.mqttClients&&this.mqttClients.forEach(t=>{t.end()}),this.websockets&&this.websockets.forEach(t=>{t&&(t.onclose=void 0,t.close(),t=void 0)}),this.mqttClients=void 0,this.websockets=void 0,this.updateTimerList&&this.updateTimerList.forEach(t=>{clearInterval(t),t=void 0}),this.sqlTimerList&&this.sqlTimerList.forEach(t=>{clearInterval(t),t=void 0}),this.closeIot(),this.jetLinksClient&&(this.jetLinksClient.close(),this.jetLinksClient=void 0),this.closeSSE()}socketCallback(t,e){this.store.emitter.emit("socket",{message:t,context:e});let i,n=t;if(e.net?.socketCbJs&&(e.net?.socketFn||(e.net.socketFn=new Function("e","context",e.net.socketCbJs)),e.net.socketFn)){if(n=e.net.socketFn(t,{meta2d:this,type:e.type,topic:e.topic,url:e.url,method:e.method}),!n)return;n&&!0!==n&&(t=n)}if(!this.socketFn||(n=this.socketFn(t,{meta2d:this,type:e.type,topic:e.topic,url:e.url,method:e.method}),n)){if(!0===n&&(n=t),n.constructor===Object||n.constructor===Array)i=n;else{if("string"!=typeof n)return;try{i=JSON.parse(n)}catch(t){console.warn("Invalid socket data:",i,t)}}i&&(Array.isArray(i)||(i=[i]),i.length&&(i[0].dataId?this.setDatas(i):i.forEach(t=>{this.setValue(t)})))}}setDatas(t,{render:e=!0,doEvent:i=!0,history:n}={}){const o=new Map;let s,a;t.forEach(e=>{this.store.bindDatas[e.dataId]?.forEach(i=>{const n=this.store.pens[i.id];if(!n)return;let s=o.get(n);if(n.noOnBinds||"function"!=typeof n.onBinds)s?s[i.formItem.key]=e.value:(s={id:i.id,[i.formItem.key]:e.value},o.set(n,s));else{if(s)return;o.set(n,n.onBinds(n,t,i.formItem))}}),this.store.bind[e.id||e.dataId]?.forEach(t=>{const i=this.store.pens[t.id];if(!i)return;let n=o.get(i);n?n[t.key]=e.value:(n={id:t.id,[t.key]:e.value},o.set(i,n))})}),this.store.data.locked&&this.doDataEvent(t),n&&(s=[]),o.forEach((t,e)=>{this.setValue(t,{render:!1,doEvent:i,history:!1}),n&&(s.push(dt(e,!0)),a.push(e))}),e&&this.render(),n&&this.pushHistory({type:Z.Update,initPens:s,pens:a})}setValue(t,{render:e=!0,doEvent:i=!0,history:n}={}){let o,s=[];if(t){if(t.id){if(t.id===this.store.data.id)return this.setDatabyOptions(t),t.bkImage&&this.setBackgroundImage(t.bkImage),t.background&&this.setBackgroundColor(t.background),void this.render();const o=this.store.pens[t.id];if(o)s=[o];else{let o=this.store.bind[t.id];if(o&&o.length)return s=[],void this.setDatas([t],{render:e,doEvent:i,history:n})}}else{if(t.dataId)return s=[],void this.setDatas([t],{render:e,doEvent:i,history:n});if(!t.tag){let o=[];for(let e in t)o.push({dataId:e,id:e,value:t[e]});return void(o.length&&this.setDatas(o,{render:e,doEvent:i,history:n}))}s=this.find(t.tag)}if((n=n&&!this.store.data.locked)&&(o=dt(s)),s.forEach(e=>{const i=e.onBeforeValue?e.onBeforeValue(e,t):t;t.frames&&(this.stopAnimate([e]),t.showDuration||(t.showDuration=t.frames.reduce((t,e)=>t+e.duration,0))),vi(e,i),this.canvas.updateValue(e,i),e.onValue?.(e)}),this.store.data.locked||!this.store.active.length||this.canvas.movingPens||this.canvas.calcActiveRect(),n){let t=dt(s);this.pushHistory({type:Z.Update,initPens:o,pens:t})}i&&s.forEach(t=>{this.store.emitter.emit("valueUpdate",t)}),e&&this.render()}}_setValue(t,e=!1){this.setValue(t,{history:e,render:!1,doEvent:!1})}pushHistory(t){this.canvas.pushHistory(t)}showInput(t,e){this.canvas.showInput(t,e)}hideInput(){this.canvas.hideInput()}clearDropdownList(){this.canvas.clearDropdownList()}clearRuleLines(){this.canvas.clearRuleLines()}onEvent=(t,e)=>{switch(t){case"add":e.forEach(t=>{t.onAdd?.(t)}),this.onSizeUpdate();break;case"enter":e&&e.onMouseEnter&&e.onMouseEnter(e,this.canvas.mousePos),this.store.data.locked&&this.doEvent(e,t);break;case"leave":e&&e.onMouseLeave&&e.onMouseLeave(e,this.canvas.mousePos),this.store.data.locked&&this.doEvent(e,t);break;case"active":case"inactive":this.store.data.locked&&e.forEach(e=>{this.doEvent(e,t)});break;case"click":if(this.store.data.locked&&e.pen&&!e.pen.disabled&&e.pen.switch&&(e.pen.checked=!e.pen.checked,e.pen.calculative.checked=e.pen.checked,e.pen.calculative.gradient=void 0,e.pen.calculative.radialGradient=void 0),e.pen&&e.pen.formId){const t=this.store.pens[e.pen.formId];"submit"===e.pen.formType?this.store.data.locked&&t&&!t.disabled&&this.doEvent(t,"submit"):"reset"===e.pen.formType&&(function(t){const e=t.calculative.canvas.store.pens[t.formId];e.followers.forEach(i=>{const n=t.calculative.canvas.store.pens[i];if(n.formId&&n.formKey&&e.formData[n.formKey]){const e=n[n.formValue];let i="";Array.isArray(e)&&(i=[]),t.calculative.canvas.parent.setValue({id:n.id,[n.formValue]:i},{render:!1,doEvent:!1,history:!1})}}),e.formData={},t.calculative.canvas.parent.render()}(e.pen),this.store.data.locked&&t&&!t.disabled&&this.doEvent(t,"reset"))}e.pen&&e.pen.onClick&&!e.pen.disabled&&e.pen.onClick(e.pen,this.canvas.mousePos),this.store.data.locked&&e.pen&&!e.pen.disabled&&this.doEvent(e.pen,t);break;case"contextmenu":e.pen&&e.pen.onContextmenu&&!e.pen.disabled&&e.pen.onContextmenu(e.pen,this.canvas.mousePos),this.store.data.locked&&e.pen&&!e.pen.disabled&&this.doEvent(e.pen,t);break;case"mousedown":e.pen&&e.pen.onMouseDown&&!e.pen.disabled&&e.pen.onMouseDown(e.pen,this.canvas.mousePos),this.store.data.locked&&e.pen&&!e.pen.disabled&&this.doEvent(e.pen,t);break;case"mouseup":e.pen&&e.pen.onMouseUp&&!e.pen.disabled&&e.pen.onMouseUp(e.pen,this.canvas.mousePos),this.store.data.locked&&e.pen&&!e.pen.disabled&&this.doEvent(e.pen,t);break;case"dblclick":this.store.data.locked&&e.pen&&!e.pen.disabled&&this.doEvent(e.pen,t);break;case"valueUpdate":e&&Ao(e,e.formValue),this.store.data.locked&&this.doEvent(e,t),this.canvas.tooltip.updateText(e);break;case"update":case"delete":case"translatePens":case"rotatePens":case"resizePens":this.onSizeUpdate();break;case"navigator":this.store.data.id||console.warn(""),this.navigatorTo(e.params);break;case"input":this.store.data.locked&&e&&!e.disabled&&this.doEvent(e,t);break;case"change":e.pen&&Ao(e.pen),e.pen?this.store.data.locked&&!e.pen.disabled&&this.doEvent(e.pen,t):this.store.data.locked&&e&&!e.disabled&&this.doEvent(e,t)}this.doMessageEvent(t,e)};doEvent=(t,e)=>{if(!t)return;let i=!1,n=[];if(t.events?.forEach((o,s)=>{if(o.actions&&o.actions.length){if(o.name===e){let e=!1;o.conditions&&o.conditions.length?"and"===o.conditionType?e=o.conditions.every(e=>this.judgeCondition(t,e.key,e)):"or"===o.conditionType&&(e=o.conditions.some(e=>this.judgeCondition(t,e.key,e))):e=!0,e&&n.push(s)}}else if(i=!0,this.events[o.action]&&o.name===e){let e=!o.where?.type;if(o.where){const{fn:i,fnJs:n,comparison:s,key:a,value:r}=o.where;if(i)e=i(t,{meta2d:this});else if(n){try{o.where.fn=new Function("pen","context",n)}catch(t){console.error("Error: make function:",t)}o.where.fn&&(e=o.where.fn(t,{meta2d:this}))}else{let i=t[a];switch(["x","y","width","height"].includes(a)&&(i=this.getPenRect(t)[a]),s){case">":e=i>+r;break;case">=":e=i>=+r;break;case"<":e=i<+r;break;case"<=":e=i<=+r;break;case"=":case"==":e=i==r;break;case"!=":e=i!=r;break;case"[)":e=xt(+i,r);break;case"![)":e=!xt(+i,r);break;case"[]":e=bt(i,r);break;case"![]":e=!bt(i,r)}}}e&&n.push(s)}}),i?t.events?.forEach((e,i)=>{n.includes(i)&&this.events[e.action](t,e)}):t.events?.forEach(async(e,i)=>{if(n.includes(i)){if(e.confirm&&!await this.canvas.popconfirm.showModal(t,this.canvas.mousePos,e.confirmTitle))return;e.actions.forEach(e=>{if(e.timeout){let i=setTimeout(()=>{this.events[e.action]&&(this.events[e.action](t,e),clearTimeout(i),i=null)},e.timeout)}else this.events[e.action]&&this.events[e.action](t,e)})}}),"valueUpdate"===e){t.realTimes?.forEach(e=>{let i=[];e.triggers?.forEach((n,o)=>{let s=!1;n.conditions?.length?"and"===n.conditionType?s=n.conditions.every(i=>this.judgeCondition(t,e.key,i)):"or"===n.conditionType&&(s=n.conditions.some(i=>this.judgeCondition(t,e.key,i))):s=!0,s&&i.push(o)}),e.triggers?.forEach((e,n)=>{i.includes(n)&&e.actions?.forEach(e=>{if(e.timeout){let i=setTimeout(()=>{this.events[e.action]&&(this.events[e.action](t,e),clearTimeout(i),i=null)},e.timeout)}else this.events[e.action](t,e)})})});let e=[];if(this.store.globalTriggers[t.id]?.forEach((t,i)=>{let n=!1;t.conditions?.length?"and"===t.conditionType?n=t.conditions.every(t=>this.judgeCondition(this.store.pens[t.source],t.key,t)):"or"===t.conditionType&&(n=t.conditions.some(t=>this.judgeCondition(this.store.pens[t.source],t.key,t))):n=!0,n&&e.push(i)}),this.store.globalTriggers[t.id]?.forEach((i,n)=>{e.includes(n)&&i.actions?.forEach(e=>{if(e.timeout){let i=setTimeout(()=>{this.events[e.action]&&(this.events[e.action](t,e),clearTimeout(i),i=null)},e.timeout)}else this.events[e.action](t,e)})}),t.triggers?.length)for(let e of t.triggers)if(e.status?.length)for(let i of e.status){let e=!1;if(i.conditions?.length?"and"===i.conditionType?e=i.conditions.every(e=>this.judgeCondition(t,e.key,e)):"or"===i.conditionType&&(e=i.conditions.some(e=>this.judgeCondition(t,e.key,e))):e=!0,e){i.actions?.forEach(e=>{if(e.timeout){let i=setTimeout(()=>{this.events[e.action]&&(this.events[e.action](t,e),clearTimeout(i),i=null)},e.timeout)}else this.events[e.action](t,e)});break}}}this.doEvent(this.store.pens[t.parentId],e)};doMessageEvent(t,e){this.store.messageEvents[t]&&this.store.messageEvents[t].forEach(t=>{let i=!1;t.event.conditions&&t.event.conditions.length?"and"===t.event.conditionType?i=t.event.conditions.every(e=>this.judgeCondition(t.pen,e.key,e)):"or"===t.event.conditionType&&(i=t.event.conditions.some(e=>this.judgeCondition(t.pen,e.key,e))):i=!0,i&&t.event.actions.forEach(i=>{this.events[i.action](t.pen,i,e)})})}doDataEvent=t=>{if(!this.store.data.dataEvents?.length)return;const e=t.reduce((t,{dataId:e,id:i,value:n})=>(t[i||e]=n,t),{});let i=[];this.store.data.dataEvents?.forEach((t,n)=>{let o=!1;t.conditions&&t.conditions.length?"and"===t.conditionType?o=t.conditions.every(t=>this.dataJudegeCondition(e,t.key,t)):"or"===t.conditionType&&(o=t.conditions.some(t=>this.dataJudegeCondition(e,t.key,t))):o=!0,o&&i.push(n)}),this.store.data.dataEvents?.forEach((t,n)=>{i.includes(n)&&t.actions?.forEach(t=>{this.events[t.action](e,t)})})};initGlobalTriggers(){this.store.globalTriggers={},this.store.data.triggers?.forEach(t=>{t.conditions.forEach(e=>{e.source&&(this.store.globalTriggers[e.source]||(this.store.globalTriggers[e.source]=[]),this.store.globalTriggers[e.source].includes(t)||this.store.globalTriggers[e.source].push(t))})})}initMessageEvents(){this.store.messageEvents={},this.store.data.pens.forEach(t=>{t.events?.forEach(e=>{"message"===e.name&&e.message&&(this.store.messageEvents[e.message]||(this.store.messageEvents[e.message]=[]),this.store.messageEvents[e.message].push({pen:t,event:e}))})})}dataJudegeCondition(t,e,i){const{type:n,target:o,fnJs:s,fn:a,operator:r,valueType:l}=i;let c=!1;if("fn"===n){if(a)c=a(t,{meta2d:this});else if(s){try{i.fn=new Function("data","context",s)}catch(t){console.error("Error: make function:",t)}i.fn&&(c=i.fn(t,{meta2d:this}))}}else{let n=i.value;"prop"===l&&(n=t[i.value]);let o=t[e];switch(r){case">":c=o>+n;break;case">=":c=o>=+n;break;case"<":c=o<+n;break;case"<=":c=o<=+n;break;case"=":case"==":c=o==n;break;case"!=":c=o!=n;break;case"[)":c=xt(+o,n);break;case"![)":c=!xt(+o,n);break;case"[]":c=bt(o,n);break;case"![]":c=!bt(o,n)}}return c}judgeCondition(t,e,i){const{type:n,target:o,fnJs:s,fn:a,operator:r,valueType:l}=i;let c=!1;if("fn"===n){if(a)c=a(t,{meta2d:this});else if(s){try{i.fn=new Function("pen","context",s)}catch(t){console.error("Error: make function:",t)}i.fn&&(c=i.fn(t,{meta2d:this}))}}else{let n=i.value;"prop"===l&&(n=this.store.pens[o][i.value]);let s=zt(t,e);switch(["x","y","width","height"].includes(e)&&(s=this.getPenRect(t)[e]),r){case">":c=s>+n;break;case">=":c=s>=+n;break;case"<":c=s<+n;break;case"<=":c=s<=+n;break;case"=":case"==":c=s==n;break;case"!=":c=s!=n;break;case"[)":c=xt(+s,n);break;case"![)":c=!xt(+s,n);break;case"[]":c=bt(s,n);break;case"![]":c=!bt(s,n)}}return c}pushChildren(t,e){const i=[dt(t,!0)],n=[];t.children||(t.children=[]);const o=[];e.forEach(e=>{let s=dt(e,!0);if(e.id&&this.store.pens[e.id]||(this.canvas.makePen(e),s=null),e.parentId){const t=this.store.pens[e.parentId],n=t.children.findIndex(t=>t===e.id);i.push(dt(t,!0)),t.children.splice(n,1),o.push(dt(t,!0))}t.children.push(e.id),e.parentId=t.id;const r=qi(e.calculative.worldRect,t.calculative.worldRect);Object.assign(e,r),e.locked=e.lockedOnCombine??a.DisableMove,e.locked=e.interaction||m.includes(e.name)?0:e.locked,s?(i.push(s),o.push(dt(e,!0))):n.push(dt(e,!0))}),o.push(dt(t,!0));let s=1;n.length&&(s=2,this.pushHistory({type:Z.Add,pens:n,step:s})),this.pushHistory({type:Z.Update,initPens:i,pens:o,step:s})}renderPenRaw=me;toPng(t,e,i=!1,n){return this.canvas.toPng(t,e,i,n)}activeToPng(t,e){return this.canvas.activeToPng(t,e)}pensToPng(t=this.store.active,e,i){return this.canvas.pensToPng(t,e,i)}downloadPng(t,e,i){for(const t of this.store.data.pens)(t.calculative.img||["iframe"].includes(t.name))&&t.onRenderPenRaw?.(t);setTimeout(()=>{const n=document.createElement("a");n.setAttribute("download",(t||this.store.data.name||"le5le.meta2d")+".png"),n.setAttribute("href",this.toPng(e,void 0,!0,i));const o=document.createEvent("MouseEvents");o.initEvent("click",!0,!0),n.dispatchEvent(o)},1e3)}downloadSvg(t){if(!window.C2S)throw console.error("canvas2svg.js","https://assets.le5lecdn.com/2d/canvas2svg.js"),new Error("canvas2svg.js");let e=!1;const i=this.store.data.width||this.store.options.width,n=this.store.data.height||this.store.options.height;i&&n&&!this.store.data.component&&(e=!0);const o=this.getRect();e&&(o.x=this.store.data.origin.x,o.y=this.store.data.origin.y,o.width=i*this.store.data.scale,o.height=n*this.store.data.scale),o.x-=10,o.y-=10;const s=new window.C2S(o.width+20,o.height+20);s.textBaseline="middle",s.strokeStyle=this.store.styles.color;const a=this.store.options.downloadBgTransparent?void 0:this.store.data.background||this.store.styles.background;a&&e&&(s.save(),s.fillStyle=a,s.fillRect(0,0,o.width,o.height),s.restore()),this.store.bkImg&&e&&s.drawImage(this.store.bkImg,0,0,o.width,o.height),a&&!e&&(s.save(),s.fillStyle=a,s.fillRect(0,0,o.width+20,o.height+20),s.restore());for(const t of this.store.data.pens)0!=t.visible&&ri(t,this.store)&&me(s,t,o,!0);let r=s.getSerializedSvg();t?.length&&(r=r.replace("<defs/>",`<defs>\n          <style type="text/css">\n            ${t.join("\n")}\n          </style>\n          {{bk}}\n        </defs>\n        {{bkRect}}`)),a?(r=r.replace("{{bk}}",""),r=r.replace("{{bkRect}}",`<rect x="0" y="0" width="100%" height="100%" fill="${a}"></rect>`)):(r=r.replace("{{bk}}",""),r=r.replace("{{bkRect}}","")),r=r.replace(/--le5le--/g,"&#x");const l=window.URL,c=new Blob([r]),h=l.createObjectURL(c),d=document.createElement("a");d.setAttribute("download",`${this.store.data.name||"le5le.meta2d"}.svg`),d.setAttribute("href",h);const u=document.createEvent("MouseEvents");u.initEvent("click",!0,!0),d.dispatchEvent(u)}getRect(t=this.store.data.pens){return Oi(t)}hiddenTemplate(){this.canvas.canvasTemplate.hidden()}showTemplate(){this.canvas.canvasTemplate.show()}lockTemplate(t){this.store.data.pens.forEach(e=>{e.canvasLayer===c.CanvasTemplate&&(e.locked=t)})}fitView(t=!0,e=10){if(!this.hasView())return;const{canvas:i}=this.canvas,{offsetWidth:n,offsetHeight:o}=i;this.resize(n,o);const s=St(e),a=this.getRect(),r=(n-s[1]-s[3])/a.width,l=(o-s[0]-s[2])/a.height;let c=r;c=t?r>l?l:r:r>l?r:l,this.store.data.fits?.length&&(this.canvas.opening=!0),this.scale(c*this.store.data.scale),this.centerView(),this.store.data.fits?.length&&this.fillView()}fillView(){const t=this.getRect(),e=this.canvas.width-t.width,i=this.canvas.height-t.height;if(Math.abs(e)>10){this.store.data.fits?.forEach(i=>{let n=[];i.children.forEach(t=>{this.store.pens[t]&&(this.store.pens[t].locked=a.None,n.push(this.store.pens[t]))});let o=e/2;if(i.left&&i.right){let o=i.leftValue,s=i.rightValue;o=o?Math.abs(o)<1?o*this.canvas.width:o:0,s=s?Math.abs(s)<1?s*this.canvas.width:s:0;let a=(this.canvas.width-o-s)/(t.width-o-s);n.forEach(i=>{i.image&&i.imageRatio&&i.calculative.worldRect.width/this.canvas.width>.1&&(i.imageRatio=!1),i.calculative.worldRect.x=t.x-e/2+o+(i.calculative.worldRect.x-t.x)*a,i.calculative.worldRect.width*=a,i.calculative.worldRect.ex=i.calculative.worldRect.x+i.calculative.worldRect.width,i.calculative.width=i.calculative.worldRect.width,i.calculative.x=i.calculative.worldRect.x,i.width=i.calculative.worldRect.width,i.x=i.calculative.worldRect.x,this.canvas.updatePenRect(i,{worldRectIsReady:!1}),i.externElement&&i.onResize?.(i),i.children?.length&&Ut(i,this.store).forEach(t=>{t.externElement&&t.onResize?.(t)})})}else i.left?(o=-o,i.leftValue&&(o+=Math.abs(i.leftValue)<1?i.leftValue*this.canvas.width:i.leftValue),this.translatePens(n,o,0)):i.right&&(i.rightValue&&(o-=Math.abs(i.rightValue)<1?i.rightValue*this.canvas.width:i.rightValue),this.translatePens(n,o,0))});const i=this.store.data.pens.filter(t=>"iframe"===t.name);i?.forEach(i=>{const n=i.calculative.worldRect;if(n.width/this.store.data.scale>.8*t.width){let t=n.width;i.calculative.worldRect.x=n.x-e/2,i.calculative.worldRect.width=n.width+e,i.calculative.worldRect.ex=n.ex+e,i.operationalRect.x=i.operationalRect.x*t/i.calculative.worldRect.width,i.operationalRect.width=(i.calculative.worldRect.width-(1-i.operationalRect.width)*t)/i.calculative.worldRect.width,i.onBeforeValue?.(i,{operationalRect:i.operationalRect}),i.onResize?.(i)}});const n=this.store.data.pens.filter(t=>"video"===t.name);n?.forEach(i=>{const n=i.calculative.worldRect;n.width/this.store.data.scale>.8*t.width&&(i.calculative.worldRect.x=n.x-e/2,i.calculative.worldRect.width=n.width+e,i.calculative.worldRect.ex=n.ex+e,i.onResize?.(i))})}if(Math.abs(i)>10){this.store.data.fits?.forEach(e=>{let n=[];e.children.forEach(t=>{this.store.pens[t]&&(this.store.pens[t].locked=a.None,n.push(this.store.pens[t]))});let o=i/2;if(e.top&&e.bottom){let o=e.topValue,s=e.bottomValue;o=o?Math.abs(o)<1?o*this.canvas.height:o:0,s=s?Math.abs(s)<1?s*this.canvas.height:s:0;let a=(this.canvas.height-o-s)/t.height;n.forEach(e=>{e.image&&e.imageRatio&&e.calculative.worldRect.height/this.canvas.height>.1&&(e.imageRatio=!1),e.calculative.worldRect.y=t.y-i/2+o+(e.calculative.worldRect.y-t.y)*a,e.calculative.worldRect.height*=a,e.calculative.worldRect.ey=e.calculative.worldRect.y+e.calculative.worldRect.height,e.calculative.height=e.calculative.worldRect.height,e.calculative.y=e.calculative.worldRect.y,e.height=e.calculative.worldRect.height,e.y=e.calculative.worldRect.y,this.canvas.updatePenRect(e,{worldRectIsReady:!1}),e.externElement&&e.onResize?.(e),e.children?.length&&Ut(e,this.store).forEach(t=>{t.externElement&&t.onResize?.(t)})})}else e.top?(o=-o,e.topValue&&(o+=Math.abs(e.topValue)<1?e.topValue*this.canvas.height:e.topValue),this.translatePens(n,0,o)):e.bottom&&(e.bottomValue&&(o-=Math.abs(e.bottomValue)<1?e.bottomValue*this.canvas.height:e.bottomValue),this.translatePens(n,0,o))});const e=this.store.data.pens.filter(t=>"iframe"===t.name);e?.forEach(e=>{const n=e.calculative.worldRect;if(n.height/this.store.data.scale>.8*t.height){let t=n.height;e.calculative.worldRect.y=n.y-i/2,e.calculative.worldRect.height=n.height+i,e.calculative.worldRect.ey=n.ey+i,e.operationalRect.y=e.operationalRect.y*t/e.calculative.worldRect.width,e.operationalRect.height=(e.calculative.worldRect.height-(1-e.operationalRect.height)*t)/e.calculative.worldRect.height,e.onBeforeValue?.(e,{operationalRect:e.operationalRect}),e.onResize?.(e)}});const n=this.store.data.pens.filter(t=>"video"===t.name);n?.forEach(e=>{const n=e.calculative.worldRect;n.height/this.store.data.scale>.8*t.height&&(e.calculative.worldRect.y=n.y-i/2,e.calculative.worldRect.height=n.height+i,e.calculative.worldRect.ey=n.ey+i,e.onResize?.(e))})}this.canvas.canvasTemplate.fit=!0,this.canvas.canvasTemplate.init(),this.canvas.canvasImage.init(),this.canvas.canvasImageBottom.init(),this.render(!0)}trimPens(){let t=this.store.data.pens.filter(t=>"line"===t.name&&t.anchors.length<2);this.delete(t)}fitTemplateView(t=!0,e=10){if(!this.hasView())return;const{canvas:i}=this.canvas,{offsetWidth:n,offsetHeight:o}=i,s=St(e),a=this.getRect(),r=(n-s[1]-s[3])/a.width,l=(o-s[0]-s[2])/a.height;let c=r;c=t?r>l?l:r:r>l?r:l,this.canvas.templateScale(c*this.store.data.scale);let h=this.getRect(),d=this.store.data.pens.filter(t=>!t.parentId);this.canvas.templateTranslatePens(d,-h.x,-h.y),this.store.data.pens.forEach(t=>{t.type?this.canvas.initLineRect(t):this.canvas.updateLines(t)}),this.centerView()}fitSizeView(t=!0,e=10){const{canvas:i}=this.canvas,{offsetWidth:n,offsetHeight:o}=i;this.resize(n,o);const s=St(e),a=(this.store.data.width||this.store.options.width)*this.store.data.scale,r=(this.store.data.height||this.store.options.height)*this.store.data.scale,l=(n-s[1]-s[3])/a,c=(o-s[0]-s[2])/r;let h=l;h="width"===t?l:"height"===t?c:t?l>c?c:l:l>c?l:c,this.store.data.fits?.length&&(this.canvas.opening=!0),this.scale(h*this.store.data.scale),this.centerSizeView(),this.store.data.fits?.length&&this.fillView()}centerSizeView(){const t=this.getViewCenter(),e={x:0,y:0,width:this.store.data.width||this.store.options.width,height:this.store.data.height||this.store.options.height};_i(e);const{center:i}=e,{scale:n,origin:o,x:s,y:a}=this.store.data;this.translate((t.x-o.x)/n-i.x-s/n,(t.y-o.y)/n-i.y-a/n);const{canvas:r}=this.canvas,l=(r.scrollWidth-r.offsetWidth)/2,c=(r.scrollHeight-r.offsetHeight)/2;r.scrollTo(l,c)}scrollView(t=10,e=!1){if(!this.hasView())return;if(!this.canvas.scroll)return;const{canvas:i}=this.canvas,{offsetWidth:n,offsetHeight:o}=i;this.resize(n,o);const s=St(t),a=this.getRect(),r=(n-s[1]-s[3])/a.width;this.scale(r*this.store.data.scale),this.topView(s[0]),e&&this.canvas.scroll.changeMode()}screenView(t=10,e=!0){if(!this.hasView())return;const{canvas:i}=this.canvas,{offsetWidth:n,offsetHeight:o}=i;this.resize(n,o);const s=St(t),a=this.getRect();let r=(n-s[1]-s[3])/a.width;e||(r=(o-s[0]-s[2])/a.height),this.scale(r*this.store.data.scale),this.topView(s[0])}topView(t=10){if(!this.hasView())return;const e=this.getRect(),i=this.getViewCenter(),n=this.getPenRect(e);_i(n);const{center:o}=n,{scale:s,origin:a,x:r,y:l}=this.store.data;this.translate((i.x-a.x)/s-o.x-r/s,(t-a.y)/s-n.y-l/s);const{canvas:c}=this.canvas,h=(c.scrollWidth-c.offsetWidth)/2,d=(c.scrollHeight-c.offsetHeight)/2;c.scrollTo(h,d)}centerView(){if(!this.hasView())return;const t=this.getRect(),e=this.getViewCenter(),i=this.getPenRect(t);_i(i);const{center:n}=i,{scale:o,origin:s,x:a,y:r}=this.store.data;this.translate((e.x-s.x)/o-n.x-a/o,(e.y-s.y)/o-n.y-r/o);const{canvas:l}=this.canvas,c=(l.scrollWidth-l.offsetWidth)/2,h=(l.scrollHeight-l.offsetHeight)/2;l.scrollTo(c,h)}hasView(){return!!this.store.data.pens.filter(t=>!t.isRuleLine).length}getViewCenter(){const{width:t,height:e}=this.canvas;return{x:t/2,y:e/2}}beSameByFirst(t=this.store.data.pens,e){const i=dt(t),n=t[0],{width:o,height:s}=this.getPenRect(n);for(let i=1;i<t.length;i++){const n=t[i];"width"===e?this.setValue({id:n.id,width:o},{render:!1,doEvent:!1}):"height"===e?this.setValue({id:n.id,height:s},{render:!1,doEvent:!1}):this.setValue({id:n.id,width:o,height:s},{render:!1,doEvent:!1})}this.render(),this.pushHistory({type:Z.Update,initPens:i,pens:t})}beSameByLast(t=this.store.data.pens,e){const i=dt(t),n=t[t.length-1],{width:o,height:s}=this.getPenRect(n);for(let i=0;i<t.length-1;i++){const n=t[i];"width"===e?this.setValue({id:n.id,width:o},{render:!1,doEvent:!1}):"height"===e?this.setValue({id:n.id,height:s},{render:!1,doEvent:!1}):this.setValue({id:n.id,width:o,height:s},{render:!1,doEvent:!1})}this.render(),this.pushHistory({type:Z.Update,initPens:i,pens:t})}formatPainterByFirst(t=this.store.data.pens){const e=dt(t),i=t[0],n={};w.forEach(t=>{n[t]=i[t]});for(let e=1;e<t.length;e++){const i=t[e];this.setValue({id:i.id,...x,...n},{render:!1,doEvent:!1})}this.render(),this.pushHistory({type:Z.Update,initPens:e,pens:t})}formatPainterByLast(t=this.store.data.pens){const e=dt(t),i=t[t.length-1],n={};w.forEach(t=>{n[t]=i[t]});for(let e=0;e<t.length-1;e++){const i=t[e];this.setValue({id:i.id,...x,...n},{render:!1,doEvent:!1})}this.render(),this.pushHistory({type:Z.Update,initPens:e,pens:t})}setFormatPainter(){const t=this.store.active,e={};if(t.length>0){const i=t[0];w.forEach(t=>{e[t]=void 0!==i[t]?i[t]:this.store.options.defaultFormat[t]||this.store.data[t]||this.store.options[t]})}else{const t={};w.forEach(e=>{t[e]=this.store.options.defaultFormat[e]||this.store.data[e]||this.store.options[e]||void 0})}localStorage.setItem("meta2d-formatPainter",JSON.stringify(e))}formatPainter(){const t=this.store.active,e=dt(t),i=JSON.parse(localStorage.getItem("meta2d-formatPainter"));for(let e=0;e<t.length;e++){const n=t[e];this.setValue({id:n.id,...x,...i},{render:!1,doEvent:!1})}this.render(),this.pushHistory({type:Z.Update,initPens:e,pens:t})}clearFormatPainter(){const t=this.store.active,e=dt(t);w.forEach(e=>{for(let i=0;i<t.length;i++){const n=t[i],{fontSize:o,lineHeight:s}=this.store.options;"lineWidth"===e?(n.lineWidth=1,n.calculative.lineWidth=1):"fontSize"===e?(n.fontSize=o,n.calculative.fontSize=o):"lineHeight"===e?(n.lineHeight=s,n.calculative.lineHeight=s):(delete n[e],delete n.calculative[e])}}),this.render(),this.pushHistory({type:Z.Update,initPens:e,pens:t})}alignNodes(t,e=this.store.data.pens,i){!i&&(i=this.getPenRect(this.getRect(e)));const n=dt(e);for(const n of e)this.alignPen(t,n,i);this.initImageCanvas(e),this.initTemplateCanvas(e),this.render(),this.pushHistory({type:Z.Update,initPens:n,pens:e})}alignNodesV(t,e=this.store.data.pens,i=!1){const n=this.store.data.width||this.store.options.width,o=this.store.data.height||this.store.options.height;let s={x:0,y:0,width:n,height:o};const a=dt(e);if(i){const i=this.store.data.scale,s=this.getRect(e),a=(s.x-this.store.data.origin.x)/i,r=(s.y-this.store.data.origin.y)/i,l=s.width/i,c=s.height/i;let h=0,d=0;switch(t){case"left":h=-a;break;case"right":h=n-(a+l);break;case"top":d=-r;break;case"bottom":d=o-(r+c);break;case"center":h=n/2-(a+l/2);break;case"middle":d=o/2-(r+c/2)}this.translatePens(e,h*i,d*i)}else for(const i of e)this.alignPen(t,i,s);this.initImageCanvas(e),this.initTemplateCanvas(e),this.render(),this.pushHistory({type:Z.Update,initPens:a,pens:e})}alignNodesByFirst(t,e=this.store.data.pens){const i=dt(e),n=e[0],o=this.getPenRect(n);for(let i=1;i<e.length;i++){const n=e[i];this.alignPen(t,n,o)}this.initImageCanvas(e),this.initTemplateCanvas(e),this.render(),this.pushHistory({type:Z.Update,initPens:i,pens:e})}alignNodesByLast(t,e=this.store.data.pens){const i=dt(e),n=e[e.length-1],o=this.getPenRect(n);for(let i=0;i<e.length-1;i++){const n=e[i];this.alignPen(t,n,o)}this.initImageCanvas(e),this.initTemplateCanvas(e),this.render(),this.pushHistory({type:Z.Update,initPens:i,pens:e})}alignPen(t,e,i){const n=this.getPenRect(e);switch(t){case"left":n.x=i.x;break;case"right":n.x=i.x+i.width-n.width;break;case"top":n.y=i.y;break;case"bottom":n.y=i.y+i.height-n.height;break;case"center":n.x=i.x+i.width/2-n.width/2;break;case"middle":n.y=i.y+i.height/2-n.height/2}this.setValue({id:e.id,...n},{render:!1,doEvent:!1})}spaceBetweenByDirection(t,e=this.store.data.pens,i){if(!i){let n=1/0,o=-1/0,s="width"===t?"x":"y";e.forEach(t=>{n=Math.min(n,t.calculative.worldRect[s]),o=Math.max(o,t.calculative.worldRect["e"+s])}),i=(o-n)/this.store.data.scale}if((e=e.filter(t=>!t.parentId)).length<=2)return;const n=dt(e),o=e.reduce((e,i)=>e+this.getPenRect(i)[t],0),s=(i-o)/(e.length-1);e=e.sort((e,i)=>"width"===t?e.x-i.x:e.y-i.y);const a=this.getPenRect(e[0]);let r="width"===t?a.x:a.y;for(const i of e){const e=this.getPenRect(i);"width"===t?e.x=r:e.y=r,r+=e[t]+s,this.setValue({id:i.id,...e},{render:!1,doEvent:!1})}this.initImageCanvas(e),this.initTemplateCanvas(e),this.render(),this.pushHistory({type:Z.Update,initPens:n,pens:e})}spaceBetween(t,e){this.spaceBetweenByDirection("width",t,e)}spaceBetweenColumn(t,e){this.spaceBetweenByDirection("height",t,e)}layout(t=this.store.data.pens,e,i=30){const n=this.getPenRect(Oi(t));!e&&(e=n.width);const o=dt(t=t.filter(t=>!t.type&&!t.parentId));let s=0;t.forEach(t=>{const e=this.getPenRect(t);e.height>s&&(s=e.height)});let a=n.x,r=n.y;t.forEach((o,l)=>{const c=this.getPenRect(o);if(c.x=a,c.y=r+s/2-c.height/2,this.setValue({id:o.id,...c},{render:!1,doEvent:!1}),l===t.length-1)return;const h=a+c.width-n.x,d=this.getPenRect(t[l+1]);Math.round(e-h)>=Math.round(d.width+i)?a+=c.width+i:(a=n.x,r+=s+i)}),this.initImageCanvas(t),this.initTemplateCanvas(t),this.render(),this.pushHistory({type:Z.Update,initPens:o,pens:t})}gotoView(t){const e=this.getViewCenter(),i=e.x-t.calculative.worldRect.x-t.calculative.worldRect.width/2,n=e.y-t.calculative.worldRect.y-t.calculative.worldRect.height/2;this.canvas.scroll&&this.canvas.scroll.isShow&&this.canvas.scroll.translate(i-this.store.data.x,n-this.store.data.y),this.store.data.x=i,this.store.data.y=n;for(const t of this.store.data.pens)li(t);this.canvas.canvasImage.init(),this.canvas.canvasImageBottom.init(),this.render()}showMap(){this.map||(this.map=new as(this.canvas)),this.map.show()}hideMap(){this.map.hide()}onSizeUpdate(){this.mapTimer&&(clearTimeout(this.mapTimer),this.mapTimer=void 0),this.mapTimer=setTimeout(()=>{this.map&&this.map.isShow&&this.map.show(),this.canvas&&this.canvas.scroll&&this.canvas.scroll.isShow&&this.canvas.scroll.resize()},500)}toggleAnchorMode(){this.canvas.toggleAnchorMode()}addAnchorHand(){this.canvas.addAnchorHand()}removeAnchorHand(){this.canvas.removeAnchorHand()}toggleAnchorHand(){this.canvas.toggleAnchorHand()}top(t){t||(t=this.store.active),Array.isArray(t)||(t=[t]);for(const e of t){const t=this.store.data.pens,i=[...Ut(e,this.store),e].map(t=>t.id);t.filter(t=>i.includes(t.id)).forEach(e=>{const i=t.findIndex(t=>t.id===e.id);i>-1&&(t.push(t[i]),t.splice(i,1),this.initTemplateCanvas([e]),this.initImageCanvas([e])),this.specificLayerMove(e,"top")})}this.store.emitter.emit("layer",{type:"top",pens:t})}initImageCanvas(t){this.canvas&&this.canvas.initImageCanvas(t)}initTemplateCanvas(t){this.canvas&&this.canvas.initTemplateCanvas(t)}bottom(t){t||(t=this.store.active),Array.isArray(t)||(t=[t]);for(const e of t){const t=this.store.data.pens,i=[...Ut(e,this.store),e].map(t=>t.id),n=t.filter(t=>i.includes(t.id));for(let e=n.length-1;e>=0;e--){const i=n[e],o=t.findIndex(t=>t.id===i.id);o>-1&&(t.unshift(t[o]),t.splice(o+1,1),this.initTemplateCanvas([i]),this.initImageCanvas([i])),this.specificLayerMove(i,"bottom")}}this.store.emitter.emit("layer",{type:"bottom",pens:t})}upByArea(t){if(-1===this.store.data.pens.findIndex(e=>e.id===t.id))return void console.warn("upByArea: pen not in canvas");const e=[t,...Ut(t,this.store)];let i=e.map(t=>this.store.data.pens.findIndex(e=>e.id===t.id));i.includes(-1)&&(console.warn("upByArea: pen children not in canvas"),i=i.filter(t=>-1!==t));const n=Math.min(...i),o=t.calculative.worldRect,s=this.store.data.pens.findIndex((e,i)=>{if(i<=n)return!1;if(e.id===t.id||Wt(e,t))return!1;const s=e.calculative.worldRect;return Fi(o,s)});if(-1!==s){this.store.data.pens.splice(s+1,0,...e);for(const t of e){const e=this.store.data.pens.findIndex(e=>e.id===t.id);e>-1&&this.store.data.pens.splice(e,1)}this.initImageCanvas([t])}else this.up(t)}specificLayerMove(t,e){if(t.image&&"gif"!==t.name){let i=c.CanvasImageBottom;"top"===e?i=c.CanvasImage:"up"!==e&&"down"!==e||(i=c.CanvasMain),this.setValue({id:t.id,canvasLayer:i},{render:!1,doEvent:!1,history:!1})}else if(t.externElement||"gif"===t.name){let i=0;"top"===e?(t.calculative.canvas.maxZindex+=1,i=t.calculative.canvas.maxZindex):"up"===e?i=void 0===t.calculative.zIndex?6:t.calculative.zIndex+1:"down"===e&&(i=void 0===t.calculative.zIndex?3:t.calculative.zIndex-1,i<0&&(i=0)),this.setValue({id:t.id,zIndex:i},{render:!1,doEvent:!1,history:!1}),t.calculative.singleton?.div&&ti(t,t.calculative.singleton.div)}}up(t){t||(t=this.store.active),Array.isArray(t)||(t=[t]);for(const e of t){const t=this.store.data.pens;if(e.children&&e.children.length){const i=[...Ut(e,this.store),e],n=[];for(let e=0;e<t.length;e++){const o=t[e];-1!==i.findIndex(t=>t.id===o.id)&&(o.temIndex=e,n.push(o))}let o=-1,s=0;n.forEach(e=>{e.temIndex-=s,t.splice(e.temIndex,1),s+=1,o=e.temIndex,delete e.temIndex,this.specificLayerMove(e,"up")}),t.splice(o+1,0,...n),this.initTemplateCanvas(n),this.initImageCanvas(n)}else{const i=t.findIndex(t=>t.id===e.id);i>-1&&i!==t.length-1&&(t.splice(i+2,0,t[i]),t.splice(i,1),this.initTemplateCanvas([e]),this.initImageCanvas([e])),this.specificLayerMove(e,"up")}}this.store.emitter.emit("layer",{type:"up",pens:t})}down(t){t||(t=this.store.active),Array.isArray(t)||(t=[t]);for(const e of t){const t=this.store.data.pens;if(e.children&&e.children.length){const i=[...Ut(e,this.store),e],n=[];for(let e=0;e<t.length;e++){const o=t[e];-1!==i.findIndex(t=>t.id===o.id)&&(o.temIndex=e,n.push(o))}let o=-1,s=0;n.forEach((e,i)=>{e.temIndex-=s,t.splice(e.temIndex,1),s+=1,0===i&&(o=e.temIndex),delete e.temIndex,this.specificLayerMove(e,"down")}),t.splice(o-1,0,...n),this.initTemplateCanvas(n),this.initImageCanvas(n)}else{const i=t.findIndex(t=>t.id===e.id);i>-1&&0!==i&&(t.splice(i-1,0,t[i]),t.splice(i+1,1),this.initTemplateCanvas([e]),this.initImageCanvas([e])),this.specificLayerMove(e,"down")}}this.store.emitter.emit("layer",{type:"down",pens:t})}setLayer(t,e,i=this.store.data.pens){const n=i.findIndex(e=>e.id===t.id);n>-1&&(n>e?(i.splice(e,0,i[n]),i.splice(n+1,1)):n<e&&(i.splice(e,0,i[n]),i.splice(n,1))),this.initTemplateCanvas([t]),this.initImageCanvas([t])}changePenId(t,e){this.canvas.changePenId(t,e)}getLines(t,e="all"){if(t.type===s.Line)return[];const i=[];return t.connectedLines?.forEach(({lineId:n})=>{const o=this.store.pens[n];if(o){if(!i.find(t=>t.id===o.id))switch(e){case"all":i.push(o);break;case"in":$e(o).connectTo===t.id&&i.push(o);break;case"out":qe(o).connectTo===t.id&&i.push(o)}}else console.warn(t,"node contain a error connectedLine")}),i}nextNode(t){if(t.type===s.Line){const e=this.store.pens[$e(t).connectTo];return e?[e]:[]}{const e=this.getLines(t,"out"),i=[];return e.forEach(t=>{const e=this.nextNode(t);for(const t of e)!i.find(e=>e.id===t.id)&&i.push(t)}),i}}previousNode(t){if(t.type===s.Line){const e=this.store.pens[qe(t).connectTo];return e?[e]:[]}{const e=this.getLines(t,"in"),i=[];return e.forEach(t=>{const e=this.previousNode(t);for(const t of e)!i.find(e=>e.id===t.id)&&i.push(t)}),i}}getNext(t){if(t.type===s.Line)return void console.warn("");const e=[];return t.connectedLines?.forEach(({lineId:i,anchor:n})=>{const o=t.anchors?.filter(t=>t.id===n)[0],s=this.findOne(i);if(s.anchors[0].connectTo==t.id){const i=s.anchors[s.anchors.length-1].connectTo;if(i){const n=this.findOne(i),a=n.connectedLines?.filter(t=>t.lineId===s.id)[0],r=n.anchors.filter(t=>t.id===a.anchor)[0];e.push({from:t,fromAnchor:o,line:s,to:n,toAnchor:r})}}}),e}addAnchor(t,e,i){if(!t)return;if(t.anchors||(t.anchors=[]),t.calculative.worldAnchors||(t.calculative.worldAnchors=[]),t.type===s.Line&&(i<0&&(i=t.anchors.length+1+i),i>t.anchors.length&&(i=t.anchors.length),i<0&&(i=0),0==i&&t.anchors[0].connectTo||i==t.anchors.length&&t.anchors[i-1].connectTo))return void console.warn("");let n=null,o=null;e.x<=1&&e.x>=0&&e.y<=1&&e.y>=0?(o={id:e.id||Ct(),penId:t.id,x:t.calculative.worldRect.x+t.calculative.worldRect.width*e.x,y:t.calculative.worldRect.y+t.calculative.worldRect.height*e.y},t.calculative.worldRect&&t.rotate%360&&L(o,t.rotate,t.calculative.worldRect.center),n={id:o.id,penId:t.id,x:e.x,y:e.y}):(o={id:e.id||Ct(),penId:t.id,x:e.x,y:e.y},t.calculative.worldRect&&(t.rotate%360&&L(e,-t.rotate,t.calculative.worldRect.center),n={id:o.id,penId:t.id,x:(e.x-t.calculative.worldRect.x)/t.calculative.worldRect.width,y:(e.y-t.calculative.worldRect.y)/t.calculative.worldRect.height})),t.type===s.Line?(t.calculative.worldAnchors.splice(i,0,o),t.anchors.splice(i,0,n),this.canvas.updateLines(t),this.canvas.initLineRect(t),this.render()):(t.calculative.worldAnchors.push(o),t.anchors.push(n))}connectLine(t,e,i,n,o=!0){if(!i){const n=e.calculative.worldRect;i=ze(t,{x:n.x+n.width/2,y:n.y+n.height/2})}if(!n){const i=t.calculative.worldRect;n=ze(e,{x:i.x+i.width/2,y:i.y+i.height/2})}const s=Math.abs(i.x-n.x),a={height:Math.abs(i.y-n.y),lineName:"line",lineWidth:1,name:"line",type:1,width:s,x:Math.min(i.x,n.x),y:Math.min(i.y,n.y),anchors:[{x:i.x>n.x?1:0,y:i.y>n.y?1:0,id:Ct()},{x:i.x>n.x?0:1,y:i.x>n.x?0:1,id:Ct()}]};return this.addPens([a]),We(t,i,a,a.calculative.worldAnchors[0]),We(e,n,a,a.calculative.worldAnchors[1]),a.calculative.active=!1,this.canvas.updateLines(a),this.canvas.updateLines(t),this.canvas.updateLines(e),this.canvas.initLineRect(a),o&&this.render(),a}toComponent(t=this.store.data.pens,e,i){if(1===t.length){const e=dt(t[0]);return e.type=s.Node,e.id=void 0,[e]}const n=dt(t,!0),o=Oi(n);let r={id:Ct(),name:"combine",...o,children:[],showChild:e};i&&(r.anchors=[{id:"0",penId:r.id,x:.5,y:0},{id:"1",penId:r.id,x:1,y:.5},{id:"2",penId:r.id,x:.5,y:1},{id:"3",penId:r.id,x:0,y:.5}]);const l=n.filter(t=>!t.parentId),c=n.find(t=>t.width===o.width&&t.height===o.height),h=c&&void 0===e;return 1===l.length?r=l[0]:h&&(c.children||(c.children=[]),r=c),n.forEach(t=>{if(t===r||t.parentId===r.id)return;if(t.parentId)return;r.children.push(t.id),t.parentId=r.id;const e=qi(t.calculative.worldRect,o);Object.assign(t,e),t.locked=t.lockedOnCombine??a.DisableMove}),h||1===l.length?dt(n):dt([r,...n])}installPenPlugins(t,e){if(!t.tag&&!t.name&&!t.id)return;let i;t.id?i="id":t.tag?i="tag":t.name&&(i="name"),e.forEach(e=>{let n=e.plugin,o=e.options;if(n&&Pi(n)&&i)if(n.install(t,o),this.penPluginMap.has(n)){let e=this.penPluginMap.get(n).find(e=>e[i]===t[i]);e?e.option=o:this.penPluginMap.get(n).push({[i]:t[i],option:o})}else this.penPluginMap.set(n,[{[i]:t[i],option:o}])})}uninstallPenPlugins(t,e){let i;t.id?i="id":t.tag?i="tag":t.name&&(i="name"),i&&e.forEach(e=>{let n=e.plugin;n.uninstall(t,e.options);let o=this.penPluginMap.get(n),s=o.findIndex(e=>e[i]===t[i]);-1!==s&&(o.splice(s,1),0===o.length&&this.penPluginMap.delete(n))})}setVisible(t,e,i=!0){if(this.onSizeUpdate(),this.setValue({id:t.id,visible:e},{render:!1,doEvent:!1}),t.children)for(const i of t.children){const t=this.store.pens[i];t&&this.setVisible(t,e,!1)}let n=Ut(t,this.store);n.push(t),this.initImageCanvas(n),i&&this.render()}clearHover(){this.canvas.clearHover()}closeSocket(){this.closeWebsocket(),this.closeMqtt(),this.closeHttp()}setElemPosition=ti;setLifeCycleFunc=Si;destroy(t){if(this.clear(!1),this.stopDataMock(),this.closeSocket(),this.closeNetwork(),this.closeAll(),Q.destroyThemeSheet(this.store.id),this.store.emitter.all.clear(),this.canvas.destroy(),this.canvas=void 0,V[this.store.id]=void 0,!t){for(const t in V)delete V[t];V.path2dDraws={},V.canvasDraws={},V.anchors={},V.htmlElements={}}}}function ps(t,e){t.onDestroy||(t.onDestroy=gs,t.onAdd=vs);const i=e||new Path2D,{x:n,y:o,width:s,height:a,ex:r}=t.calculative.worldRect;let l=t.calculative.borderRadius||0,c=l;l<1&&(l*=s,c*=a);let h=l<c?l:c;s<2*h&&(h=s/2),a<2*h&&(h=a/2),i.moveTo(n+h,o),i.arcTo(n+s,o,n+s,o+a,h),i.arcTo(n+s,o+a,n,o+a,h),i.arcTo(n,o+a,n,o,h),i.arcTo(n,o,n+s,o,h);const d=.2*a;i.moveTo(n,o+d),i.lineTo(r,o+d);const u=o+d+(a-d)/2;if(i.moveTo(n,u),i.lineTo(r,u),i.closePath(),i instanceof Path2D)return i}function vs(t){const{x:e,y:i,width:n,height:o}=t.calculative.worldRect,s=t.list,a={name:"text",x:e,y:i+.2*o,width:n,height:.4*o,textAlign:"left",textBaseline:"top",textLeft:10,textTop:10},r={name:"text",x:e,y:i+.6*o,width:n,height:.4*o,textAlign:"left",textBaseline:"top",textLeft:10,textTop:10};Object.assign(a,s[0]),Object.assign(r,s[1]),t.calculative.canvas.makePen(a),t.calculative.canvas.makePen(r),t.calculative.canvas.parent.pushChildren(t,[a]),t.calculative.canvas.parent.pushChildren(t,[r])}function gs(t){const e=t.calculative.canvas.store;t.children.forEach(t=>{const i=e.data.pens.findIndex(e=>e.id===t);i>-1&&(e.data.pens.splice(i,1),e.pens[t]=void 0)}),t.children=void 0}function ys(t,e){t.onDestroy||(t.onDestroy=ws,t.onAdd=ms);const i=e||new Path2D,{x:n,y:o,width:s,height:a,ex:r}=t.calculative.worldRect;let l=t.calculative.borderRadius||0,c=l;l<1&&(l*=s,c*=a);let h=l<c?l:c;s<2*h&&(h=s/2),a<2*h&&(h=a/2),i.moveTo(n+h,o),i.arcTo(n+s,o,n+s,o+a,h),i.lineTo(n+s,o+a-h),i.arcTo(n+s,o+a,n,o+a,h),i.arcTo(n,o+a,n,o,h),i.arcTo(n,o,n+s,o,h);const d=.2*a;if(i.moveTo(n,o+d),i.lineTo(r,o+d),i.closePath(),i instanceof Path2D)return i}function ms(t){const{x:e,y:i,width:n,height:o}=t.calculative.worldRect,s=t.list;let a={name:"text",x:e,y:i+.2*o,width:n,height:.8*o,textAlign:"left",textBaseline:"top",textLeft:10,textTop:10};Object.assign(a,s[0]),t.calculative.canvas.makePen(a),t.calculative.canvas.parent.pushChildren(t,[a])}function ws(t){const e=t.calculative.canvas.store;t.children.forEach(t=>{const i=e.data.pens.findIndex(e=>e.id===t);i>-1&&(e.data.pens.splice(i,1),e.pens[t]=void 0)}),t.children=[]}function xs(){return{interfaceClass:ps,simpleClass:ys}}function bs(t,e){const i=e||new Path2D,{x:n,y:o,width:s,height:a}=t.calculative.worldRect;if(i.rect(n,o,s,a),i.closePath(),i instanceof Path2D)return i}function ks(t,e){const i=e.headHeight??50,{x:n,y:o,width:s,height:a,ey:r}=e.calculative.worldRect;let l=e.calculative.borderRadius||0,c=l;e.calculative.borderRadius<1&&(l*=s,c*=a);let h=l<c?l:c;s<2*h&&(h=s/2),i<2*h&&(h=i/2),t.beginPath(),t.moveTo(n+h,o),t.arcTo(n+s,o,n+s,o+i,h),t.arcTo(n+s,o+i,n,o+i,h),t.arcTo(n,o+i,n,o,h),t.arcTo(n,o,n+s,o,h),t.closePath(),t.stroke(),t.save(),t.beginPath(),t.lineWidth=1,t.setLineDash([7,7]);const d=n+s/2;t.moveTo(d,o+i+1),t.lineTo(d,r),t.stroke(),t.restore()}function Ts(){return{sequenceFocus:bs}}function Cs(){return{lifeline:ks}}function As(t,e){const{x:i,y:n,width:o,height:s}=e.calculative.worldRect;t.beginPath(),t.ellipse(i+o/2,n+s/2,o/2,s/2,0,0,2*Math.PI),t.stroke(),t.beginPath(),t.fillStyle=t.strokeStyle,t.ellipse(i+o/2,n+s/2,o/4,s/4,0,0,2*Math.PI),t.fill()}function Rs(t,e){const i=e||new Path2D,{x:n,y:o,width:s,height:a,ey:r}=t.calculative.worldRect,l=t.calculative.lineLeft||.08;let c=t.calculative.borderRadius||0,h=c;c<1&&(c*=s,h=a*c);let d=c<h?c:h;if(s<2*d&&(d=s/2),a<2*d&&(d=a/2),i.moveTo(n+d,o),i.arcTo(n+s,o,n+s,o+a,d),i.arcTo(n+s,o+a,n,o+a,d),i.arcTo(n,o+a,n,o,d),i.arcTo(n,o,n+s,o,d),i.closePath(),i.moveTo(n+l*s,o),i.lineTo(n+l*s,r),i instanceof Path2D)return i}function Ss(t,e){const i=e||new Path2D,{x:n,y:o,width:s,height:a,ex:r}=t.calculative.worldRect,l=t.calculative.lineTop||.08;let c=t.calculative.borderRadius||0,h=c;c<1&&(c*=s,h*=a);let d=c<h?c:h;if(s<2*d&&(d=s/2),a<2*d&&(d=a/2),i.moveTo(n+d,o),i.arcTo(n+s,o,n+s,o+a,d),i.arcTo(n+s,o+a,n,o+a,d),i.arcTo(n,o+a,n,o,d),i.arcTo(n,o,n+s,o,d),i.closePath(),i.moveTo(n,o+l*a),i.lineTo(r,o+l*a),i instanceof Path2D)return i}function Ps(){return{forkV:t,forkH:t,swimlaneH:Rs,swimlaneV:Ss}}function Is(){return{activityFinal:As}}function Es(t,e){const i=e||new Path2D,{x:n,y:o,width:s,ey:a}=t.calculative.worldRect,r=s/4;if(i.moveTo(n+r,o),i.lineTo(n,o),i.lineTo(n,a),i.lineTo(n+r,a),i instanceof Path2D)return i}function _s(t){t.anchors=[{x:.25,y:0},{x:.25,y:1},{x:0,y:.5}].map(({x:e,y:i},n)=>({id:n+"",x:e,y:i,penId:t.id}))}function Ms(t,e){const i=e||new Path2D,{x:n,y:o,width:s,ex:a,ey:r}=t.calculative.worldRect,l=t.offsetX;let c=s/7;if(l>1?c=l:l>0&&(c=s*l),i.moveTo(n+c,o),i.lineTo(a,o),i.lineTo(n+s-c,r),i.lineTo(n,r),i.closePath(),i instanceof Path2D)return i}function Ls(t){t.anchors=[{x:.5,y:0},{x:13/14,y:.5},{x:.5,y:1},{x:1/14,y:.5}].map(({x:e,y:i},n)=>({id:`${n}`,penId:t.id,x:e,y:i}))}function Ds(t,e){const i=e||new Path2D,{x:n,y:o,height:s,ex:a,ey:r}=t.calculative.worldRect,l=s/7;if(i.moveTo(n,o+l),i.bezierCurveTo(n,o-l/2|0,a,o-l/2|0,a,o+l),i.lineTo(a,r-l),i.bezierCurveTo(a,r+l/2|0,n,r+l/2|0,n,r-l),i.closePath(),i.moveTo(n,r-l),i.bezierCurveTo(n,r-2*l|0,a,r-2*l|0,a,r-l),i instanceof Path2D)return i}function Os(t,e){const i=e||new Path2D,{x:n,y:o,width:s,height:a,ex:r,ey:l}=t.calculative.worldRect,c=s/8;if(i.moveTo(n+c,o),i.lineTo(r-c,o),i.bezierCurveTo(r+c/3,o,r+c/3,l,r-c,l),i.lineTo(n+c,l),i.lineTo(n,o+a/2),i.closePath(),i instanceof Path2D)return i}function Bs(t,e){const i=e||new Path2D,{x:n,y:o,width:s,height:a,ex:r,center:l}=t.calculative.worldRect,c=l.x,h=o+6*a/7,d=a/6;if(i.moveTo(n,o),i.lineTo(r,o),i.lineTo(r,h),i.bezierCurveTo(r-20,h-d,c+s/5,h-d,c,h),i.bezierCurveTo(c-s/5,h+d,n,h+d,n,h),i.closePath(),i instanceof Path2D)return i}function Ns(t){t.anchors=[{x:.5,y:0},{x:1,y:.5},{x:.5,y:6/7},{x:0,y:.5}].map(({x:e,y:i},n)=>({id:`${n}`,penId:t.id,x:e,y:i}))}function Fs(t,e){const i=e||new Path2D,{x:n,y:o,width:s,ex:a,ey:r}=t.calculative.worldRect,l=s/10;if(i.moveTo(n+2*l,o),i.bezierCurveTo(n-2*l/3,o,n-2*l/3,r,n+2*l,r),i.lineTo(a,r),i.bezierCurveTo(a-l,r,a-l,o,a,o),i.closePath(),i instanceof Path2D)return i}function zs(t,e){const i=e||new Path2D,{x:n,y:o,width:s,ex:a,ey:r}=t.calculative.worldRect;i.moveTo(n,o),i.lineTo(a,o),i.lineTo(a,r),i.lineTo(n,r),i.closePath();const l=s/7;if(i.moveTo(n,o+l),i.lineTo(a,o+l),i.moveTo(n+l,o),i.lineTo(n+l,r),i instanceof Path2D)return i}function js(t,e){const i=e||new Path2D,{x:n,y:o,height:s,ex:a,ey:r}=t.calculative.worldRect,l=s/4;if(i.moveTo(n,o+l),i.lineTo(a,o),i.lineTo(a,r),i.lineTo(n,r),i.closePath(),i instanceof Path2D)return i}function Hs(t){t.anchors=[{x:.5,y:.125},{x:1,y:.5},{x:.5,y:1},{x:0,y:.5}].map(({x:e,y:i},n)=>({id:`${n}`,penId:t.id,x:e,y:i}))}function Ws(t,e){const i=e||new Path2D,{x:n,y:o,ex:s,ey:a}=t.calculative.worldRect;if(i.moveTo(n,o),i.lineTo(s,o),i.moveTo(n,a),i.lineTo(s,a),i instanceof Path2D)return i}function Vs(t){t.anchors=[{x:.5,y:0},{x:.5,y:1}].map(({x:e,y:i},n)=>({id:n+"",x:e,y:i,penId:t.id}))}function Us(t,e){const i=e||new Path2D,{x:n,y:o,width:s,height:a,ex:r,ey:l}=t.calculative.worldRect;if(i.ellipse(n+s/2,o+a/2,s/2,a/2,0,0,2*Math.PI),i.moveTo(n+s/2,l),i.lineTo(r,l),i.closePath(),i instanceof Path2D)return i}function qs(t,e){const i=e||new Path2D,{x:n,y:o,width:s,ex:a,ey:r}=t.calculative.worldRect,l=s/7;if(i.moveTo(n,o),i.lineTo(a,o),i.lineTo(a,r),i.lineTo(n,r),i.closePath(),i.moveTo(n+l,o),i.lineTo(n+l,r),i.moveTo(a-l,o),i.lineTo(a-l,r),i instanceof Path2D)return i}function $s(){return{flowComment:Es,flowData:Ms,flowDb:Ds,flowDisplay:Os,flowDocument:Bs,flowExternStorage:Fs,flowInternalStorage:zs,flowManually:js,flowParallel:Ws,flowQueue:Us,flowSubprocess:qs}}function Ks(){return{flowDocument:Ns,flowManually:Hs,flowParallel:Vs,flowComment:_s,flowData:Ls}}var Ys;!function(t){t[t.Add=0]="Add",t[t.Replace=1]="Replace",t[t.ReplaceAll=2]="ReplaceAll"}(Ys||(Ys={}));let Xs=["fontSize","nameGap","margin","width","symbolSize","itemWidth","itemHeight","fontWeight","top","left","right","bottom","zoom","edgeSymbolSize","nodeWidth","nodeGap","distance","length","length2","offsetCenter","size","symbolOffset","padding","barWidth","symbolOffset","shadowOffsetY","shadowOffsetX"];function Gs(t){let e=globalThis.echarts;if(!t.echarts||!e)return;if("string"==typeof t.echarts)try{t.echarts=JSON.parse(t.echarts)}catch(t){}Xs=t.calculative.canvas.store.options.diagramOptions.chart?.keyWords||Xs,t.onDestroy||(t.onDestroy=Js,t.onMove=Qs,t.onResize=Zs,t.onRotate=Qs,t.onValue=ea,t.onBeforeValue=ia,t.onBinds=na,t.onMouseEnter=Qs,t.onRenderPenRaw=oa,t.onScale=ta),t.calculative.singleton||(t.calculative.singleton={});const i=new Path2D,n=t.calculative.worldRect;if(!t.calculative.singleton.div){const i=document.createElement("div");i.style.position="absolute",i.style.outline="none",i.style.left="-9999px",i.style.top="-9999px",i.style.width=n.width+"px",i.style.height=n.height+"px",document.body.appendChild(i),t.calculative.canvas.externalElements?.parentElement.appendChild(i),ti(t,i),t.calculative.singleton.div=i,t.calculative.singleton.echart=e.init(i,t.echarts.theme),function(t){const e=t.calculative.singleton.echart,i=["click","dblclick","mousedown","mousemove","mouseup","mouseover","mouseout","globalout","contextmenu"];i.forEach(t=>{e.off(t)}),t.events?.forEach(n=>{n.actions&&n.actions.length&&i.includes(n.name)&&e.on(n.name,e=>{let i=!1;n.conditions&&n.conditions.length?"and"===n.conditionType?i=n.conditions.every(e=>t.calculative.canvas.parent.judgeCondition(t,e.key,e)):"or"===n.conditionType&&(i=n.conditions.some(e=>t.calculative.canvas.parent.judgeCondition(t,e.key,e))):i=!0,i&&n.actions.forEach(i=>{if(i.timeout){let n=setTimeout(()=>{t.calculative.canvas.parent.events[i.action]&&(t.calculative.canvas.parent.events[i.action](t,i,e),clearTimeout(n),n=null)},i.timeout)}else t.calculative.canvas.parent.events[i.action]&&t.calculative.canvas.parent.events[i.action](t,i,e)})})})}(t),t.calculative.singleton.echartsReady=!0,t.echarts.geoName&&!e.getMap(t.echarts.geoName)&&(t.echarts.geoJson?e.registerMap(t.echarts.geoName,t.echarts.geoJson):t.echarts.geoUrl&&(t.calculative.singleton.echartsReady=!1,fetch(t.echarts.geoUrl).then(i=>{i.text().then(i=>{if("string"==typeof i)try{i=JSON.parse(i)}catch{}i.constructor===Object||i.constructor===Array?(e.registerMap(t.echarts.geoName,i),t.calculative.singleton.echartsReady=!0,t.calculative.singleton.echart.setOption(sa(t.echarts.option,t.calculative.canvas.store.data.scale),!0),t.calculative.singleton.echart.resize(),setTimeout(()=>{oa(t)},300)):console.warn("Invalid data:",i)})}))),t.calculative.singleton.echartsReady&&setTimeout(()=>{t.calculative.singleton.echart?.setOption(sa(t.echarts.option,t.calculative.canvas.store.data.scale),!0),setTimeout(()=>oa(t),300)})}return i}function Js(t){if(t.calculative.singleton&&t.calculative.singleton.div){t.calculative.singleton.div.remove();let e=globalThis.echarts;e&&e.dispose(t.calculative.singleton.echart),delete t.calculative.singleton.div,delete t.calculative.singleton.echart}}function Qs(t){t.calculative.singleton.div&&ti(t,t.calculative.singleton.div)}function Zs(t){Qs(t),t.calculative.singleton?.echart&&t.calculative.singleton.echart.resize()}function ta(t){if(!t.calculative.singleton.echart)return;let e=globalThis.echarts;if(ti(t,t.calculative.singleton.div),!t.echarts.geoName||e.getMap(t.echarts.geoName)){if(!t.echarts.diabled){if(t.echarts.option?.dataZoom){const e=t.calculative.singleton.echart.getOption().dataZoom;t.echarts.option.dataZoom?.forEach((t,i)=>{e[i]&&(t.start=e[i].start,t.end=e[i].end)})}t.calculative.singleton.echart.setOption(sa(t.echarts.option,t.calculative.canvas.store.data.scale),!0)}t.calculative.singleton.echart.resize()}}function ea(t){if(t.calculative.singleton.echart&&(ti(t,t.calculative.singleton.div),t.calculative.singleton.echartsReady))if(t.calculative.partialOption){const e=t.calculative.partialOption.echarts.option;Array.isArray(t.echarts?.replaceMerge)&&t.echarts?.replaceMerge.some(t=>e[t])?t.calculative.singleton.echart.setOption(dt(e),{replaceMerge:t.echarts.replaceMerge}):t.calculative.singleton.echart.setOption(dt(e))}else t.calculative.singleton.echart.setOption(sa(t.echarts.option,t.calculative.canvas.store.data.scale),!0)}function ia(t,e){if(t.calculative.partialOption=null,e.echarts){let i=globalThis.echarts;return e.echarts.geoName&&!i.getMap(e.echarts.geoName)&&(e.echarts.geoJson?i.registerMap(e.echarts.geoName,e.echarts.geoJson):e.echarts.geoUrl&&(t.calculative.singleton.echartsReady=!1,fetch(e.echarts.geoUrl).then(n=>{n.text().then(n=>{if("string"==typeof n)try{n=JSON.parse(n)}catch{}if(n.constructor===Object||n.constructor===Array)return i.registerMap(e.echarts.geoName,n),t.calculative.singleton.echartsReady=!0,t.onValue(t),!1;console.warn("Invalid data:",n)})}))),e}if(t.realTimes&&t.realTimes.length){t.echarts.dataMap&&e.data&&(e=function(t,e){if(!t.echarts.dataMap||!e.data)return e;if(e.data){let i={};if(Array.isArray(e.data))for(const n in t.echarts.dataMap)t.echarts.dataMap.hasOwnProperty(n)&&(t.echarts.timeKeys?.length&&t.echarts.timeKeys.includes(t.echarts.dataMap[n])?i[n]=e.data.map(e=>Ht(t.echarts.timeFormat,e[t.echarts.dataMap[n]])):i[n]=e.data.map(e=>e[t.echarts.dataMap[n]]));else for(const n in t.echarts.dataMap)t.echarts.dataMap.hasOwnProperty(n)&&(t.echarts.timeKeys?.length&&t.echarts.timeKeys.includes(t.echarts.dataMap[n])?i[n]=Ht(t.echarts.timeFormat,e.data[t.echarts.dataMap[n]]):i[n]=e.data[t.echarts.dataMap[n]]);return delete e.data,Object.assign(e,i),e}}(t,e));let i=Object.keys(e);const{xAxis:n,yAxis:o}=t.echarts.option,{max:s,replaceMode:a,timeFormat:r}=t.echarts;let l=[],c=!1;for(let o in e)if(o.includes("echarts.option")){c=!0;let h=zt(t,o);if(Array.isArray(h)&&a===Ys.Add&&(h.push(e[o]),s&&h.splice(0,h.length-s),e[o]=h,!i.includes("echarts.option.xAxis.data"))){let i="echarts.option.xAxis.data";Array.isArray(n)&&n.length&&(i="echarts.option.xAxis.0.data");let o=zt(t,i),a=Ht(r||"`${hours}:${minutes}:${seconds}`");o.push(a),s&&o.splice(0,o.length-s),e[i]=o}if(o.includes(".data.")){let t=o.substring(0,o.indexOf(".data.")+5);l.includes(t)||l.push(t)}}if(c){const i=dt(e);t.calculative.partialOption=function(t,e){const i={};return Object.keys(t).forEach(n=>{const o=n.split(".");let s=i;o.forEach((i,a)=>{const r=!isNaN(parseInt(i));if(6===a){let i=o.slice(0,7).join(".");jt(e,n,t[n]);let r=zt(e,i);s[o[a]]=r}else{if(a>6)return;if(a===o.length-1)r?(Array.isArray(s)||(s=[]),s[parseInt(i)]=t[n]):s[i]=t[n];else if(r){const t=parseInt(i);if(Array.isArray(s)||s[o[a-1]],s[t]||(s[t]={}),Array.isArray(s))for(let t=0;t<parseInt(i);t++)s[t]||(s[t]={});s=s[t]}else s[i]||(s[i]="series"===i?[]:{}),s=s[i]}})}),i}(i,t),l.forEach(e=>{let i=zt(t,e);jt(t.calculative.partialOption,e,i)})}return e}if(!e.dataX&&!e.dataY)return e;const i=t.echarts,{max:n,replaceMode:o}=i;let s=e.dataX,a=e.dataY,r=[];a&&r.push("echarts.option.series");const l=i.option.series,c=l.length,{xAxis:h,yAxis:d}=i.option;Array.isArray(h)&&h.length>1&&console.warn("echarts  x  x ");const u=Array.isArray(h)?h[0]:h,f=Array.isArray(d)?d[0]:d;if(o)if(o===Ys.Replace)if(u||f){if(("category"===u.type||"category"===f.type)&&s&&a){const t="category"===u.type?u.data:f.data;!Array.isArray(s)&&(s=[s]),!Array.isArray(a)&&(a=[a]),"category"===u.type?r.push("echarts.option.xAxis"):r.push("echarts.option.yAxis"),1===c?a.forEach((e,i)=>{const n=t.indexOf(s[i]);l[0].data[n]=e}):l.forEach((e,i)=>{a[i].forEach((i,n)=>{const o=t.indexOf(s[n]);e.data[o]=i})})}}else a&&(1===c?(!Array.isArray(a)&&(a=[a]),a.forEach((t,e)=>{const i=l[0].data.find(e=>e.name===t.name);i&&(i.value=t.value)})):l.forEach((t,e)=>{Array.isArray(a[e])||(a[e]=[a[e]]),a[e].forEach((e,i)=>{const n=t.data.find(t=>t.name===e.name);n&&(n.value=e.value)})}));else o===Ys.ReplaceAll&&(s&&(u.data=s,u.data.splice(0,u.data.length-n),r.push("echarts.option.xAxis")),a&&(1===c?(l[0].data=a,l[0].data.splice(0,l[0].data.length-n)):l.forEach((t,e)=>{t.data=a[e],t.data.splice(0,t.data.length-n)})));else{if(s){!Array.isArray(s)&&(s=[s]);const t=u.data;t.push(...s),t.splice(0,t.length-n),r.push("echarts.option.xAxis")}if(a)if(1===c){!Array.isArray(a)&&(a=[a]);const t=l[0].data;t.push(...a),t.splice(0,t.length-n)}else l.forEach((t,e)=>{Array.isArray(a[e])||(a[e]=[a[e]]);const i=t.data;i.push(...a[e]),i.splice(0,i.length-n)})}return t.calculative.partialOption={},r.forEach(e=>{let i=zt(t,e);jt(t.calculative.partialOption,e,i)}),delete e.dataX,delete e.dataY,Object.assign(e,{echarts:i})}function na(t,e,i){if("dataY"!==i.key)return;const n=t.echarts,{xAxis:o,yAxis:s}=n.option;Array.isArray(o)&&o.length>1&&console.warn("echarts  x  x ");const a=Array.isArray(o)?o[0]:o,r=Array.isArray(s)?s[0]:s,l=n.option.series;if(a||r){if("category"===a.type||"category"===r.type){const n=[],o=[],s="category"===a.type?a.data:r.data;return s?.forEach(t=>{const{dataId:s}=i.dataIds.find(e=>e.name===t);if(s){const i=e.find(t=>t.dataId===s);i&&(o.push(t),n.push(i.value))}}),{id:t.id,dataY:n,dataX:o}}if("time"===a.type){const n=[],o=+new Date;let s=!1;if(l.forEach((t,a)=>{const r=[],{dataId:l}=i.dataIds.find(e=>e.name===t.name);if(l){const t=e.find(t=>t.dataId===l);t&&(r.push([o,t.value]),s=!0)}n[a]=r}),!s)return;return n.forEach((t,e)=>{if(!t||0===t.length){const t=l[e].data[l[e].data.length-1];n[e]=[[o,t[1]]]}}),{id:t.id,dataY:1===n.length?n[0]:n}}}else{const n=[];if(Array.isArray(l)&&1===l.length)return l[0].data.forEach(t=>{const{dataId:o}=i.dataIds.find(e=>e.name===t.name);if(o){const i=e.find(t=>t.dataId===o);i&&n.push({name:t.name,value:i.value})}}),{id:t.id,dataY:n}}}function oa(t){const e=new Image;e.src=t.calculative.singleton?.echart?.getDataURL({pixelRatio:2}),t.calculative.img=e}function sa(t,e){const i=dt(t);if(i.dataZoom){let t=["right","top","width","height","left","bottom"];for(let n=0;n<t.length;n++)i.dataZoom.forEach(i=>{isNaN(i[t[n]])||(i[t[n]]*=e)})}return ut(i,Xs,e),i}function aa(t){const e=globalThis.Highcharts;if(!e)return;if("string"==typeof t.highcharts)try{t.highcharts=JSON.parse(t.highcharts.option)}catch(t){}if(!t.highcharts)return;t.onDestroy||(t.onDestroy=ra,t.onMove=la,t.onResize=ca,t.onRotate=la,t.onValue=ha,t.onBeforeValue=da,t.onRenderPenRaw=ua),t.calculative.singleton||(t.calculative.singleton={});const i=new Path2D,n=t.calculative.worldRect;if(!t.calculative.singleton.div){const i=document.createElement("div");i.style.position="absolute",i.style.outline="none",i.style.left="-9999px",i.style.top="-9999px",i.style.width=n.width+"px",i.style.height=n.height+"px",i.style.minWidth="100px",i.style.minHeight="100px",i.id=t.id,document.body.appendChild(i),t.calculative.singleton.div=i,setTimeout(()=>{t.calculative.singleton.highchart=e.chart(t.id,t.highcharts.option);const i=t.calculative.singleton.highchart.getSVG(),n=new Image;n.src="data:image/svg+xml;base64,"+btoa(unescape(encodeURIComponent(i))),t.calculative.img=n}),t.calculative.canvas.externalElements?.parentElement.appendChild(i),ti(t,i)}return t.calculative.patchFlags&&t.calculative.singleton.div&&ti(t,t.calculative.singleton.div),i}function ra(t){t.calculative.singleton&&t.calculative.singleton.div&&(t.calculative.singleton.div.remove(),t.calculative.singleton.highchart.destroy(),delete t.calculative.singleton.div,delete t.calculative.singleton.highchart)}function la(t){t.calculative.singleton.div&&ti(t,t.calculative.singleton.div)}function ca(t){t.calculative.singleton.div&&(ti(t,t.calculative.singleton.div),setTimeout(()=>{t.calculative.singleton.highchart.reflow()},100))}function ha(t){t.calculative.singleton.div&&ti(t,t.calculative.singleton.div)}function da(t,e){if(e.highcharts)return t.calculative.singleton.highchart.update(e.highcharts.option),e;if(!e.dataX&&!e.dataY)return e;const i=t.highcharts,n=i.max;let o=e.dataX,s=e.dataY;const a=i.option.series.length;if(e.overwrite)o&&(i.option.xAxis.categories=o,i.option.xAxis.categories.splice(0,i.option.xAxis.categories.length-n)),s&&(1===a?(i.option.series[0].data=s,i.option.series[0].data.splice(0,i.option.series[0].data.length-n)):i.option.series.forEach((t,e)=>{t.data=s[e],t.data.splice(0,t.data.length-n)})),t.calculative.singleton.highchart.update(i.option);else{let e=[],r=null,l=!1;if(o){Array.isArray(o)||(o=[o]);const t=i.option.xAxis,s=Array.isArray(t)?t[0].categories:t.categories;s&&(s.push(...o),s.splice(0,s.length-n),l=!0),e=[...o]}s&&(1===a?(Array.isArray(s)||(s=[s]),r=[s]):(r=[],i.option.series.forEach((t,e)=>{Array.isArray(s[e])||(s[e]=[s[e]]),r.push(s[e])}))),r&&t.calculative.singleton.highchart.series.forEach((t,i)=>{r[i].forEach((i,o)=>{let s=!1;n&&t.data.length>=n&&(s=!0);const a=l||null==e[o]?i:[e[o],i];t.addPoint(a,!0,s)})})}return delete e.dataX,delete e.dataY,delete e.overwrite,Object.assign(e,{highcharts:i})}function ua(t){if(!t.calculative?.singleton)return;const e=t.calculative.singleton.highchart.getSVG(),i=new Image;i.src="data:image/svg+xml;base64,"+btoa(unescape(encodeURIComponent(e))),t.calculative.img=i}function fa(t){let e=globalThis.lcjs;if(!t.lightningCharts||!e)return;if("string"==typeof t.lightningCharts)try{t.lightningCharts=JSON.parse(t.lightningCharts)}catch(t){}if(!t.lightningCharts)return;t.onDestroy||(t.onDestroy=va,t.onMove=ga,t.onResize=ya,t.onRotate=ga,t.onValue=ma,t.onRenderPenRaw=wa);const i=new Path2D,n=t.calculative.worldRect;if(t.calculative.singleton||(t.calculative.singleton={}),!t.calculative.singleton.div){const e=document.createElement("div");e.style.position="absolute",e.style.outline="none",e.style.left="-9999px",e.style.top="-9999px",e.style.width=n.width+"px",e.style.height=n.height+"px",e.id=t.id,document.body.appendChild(e),t.calculative.singleton.div=e,setTimeout(()=>{pa(t)},100),setTimeout(()=>{t.calculative.canvas.externalElements&&t.calculative.canvas.externalElements.parentElement.appendChild(e),ti(t,e);const i=new Image;i.src=t.calculative.singleton.div.children[0].toDataURL(),t.calculative.img=i},400)}return t.calculative.patchFlags&&t.calculative.singleton.div&&ti(t,t.calculative.singleton.div),i}function pa(t){const{lightningChart:e,PieChartTypes:i,LegendBoxBuilders:n,SliceLabelFormatters:o,Themes:s,GaugeChartTypes:a,SolidLine:r,SolidFill:l,ColorRGBA:c,UIOrigins:h,emptyLine:d,AutoCursorModes:u,AxisScrollStrategies:f,AxisTickStrategies:p,UIElementBuilders:v}=lcjs,g=t.lightningCharts.option.data,y=t.lightningCharts.option.title||"Title",m=s[t.lightningCharts.option.theme||"lightNew"];switch(t.calculative.singleton.lightningChart=e(),t.lightningCharts.option.type){case"line":const e=t.calculative.singleton.lightningChart.ChartXY({container:t.id}).setTitle(y);g.forEach(t=>{e.addLineSeries().setName(t.name).add(t.data)});break;case"bar":const i=t.calculative.singleton.lightningChart;let s;s=e=>{const o=[],s=[],a=i.ChartXY(e).setTitle(y).setAutoCursorMode(u.onHover).setMouseInteractions(!1).setPadding({bottom:30}),r=a.getDefaultAxisX().setMouseInteractions(!1).setScrollStrategy(void 0).setTickStrategy(p.Empty);a.getDefaultAxisY().setMouseInteractions(!1).setTitle(t.lightningCharts.option.yTitle).setInterval(0,70).setScrollStrategy(f.fitting),a.setAutoCursor(t=>t.disposePointMarker().disposeTickMarkerX().disposeTickMarkerY().setGridStrokeXStyle(d).setGridStrokeYStyle(d).setResultTable(t=>{t.setOrigin(h.CenterBottom)}));const l=a.addLegendBox(n.VerticalLegendBox).setAutoDispose({type:"max-width",maxWidth:.2});return{addCategory:t=>{const e=(t=>{const e=a.addRectangleSeries();return e.setCursorResultTableFormatter((e,i,n)=>{let o={name:t.name,value:t.data[t.figures.indexOf(n)]};return e.addRow("Department:",o.name).addRow("# of employees:",String(o.value))}),e})(t).setName(t.name);t.figures=t.data.map(t=>e.add({x:0,y:0,width:0,height:0})),l.add(e),s.push(t),(()=>{let t=0;for(let e=0;e<o.length;e++){const i=o[e],n=t;for(const i of s){const n=i.data[e];void 0!==n&&(i.figures[e].setDimensions({x:t,y:0,width:10,height:n}),t+=12.5)}i.tick.setValue((n+t-2.5)/2),t+=7.5}r.setInterval(-10,t)})()},addGroups:t=>{for(const e of t)o.push({name:e,tick:r.addCustomTick(v.AxisTick).setGridStrokeLength(0).setTextFormatter(t=>e)})}}};const a=s({theme:m,container:t.id});a.addGroups(t.lightningCharts.option.groups);const r=t.lightningCharts.option.categories;g.forEach((t,e)=>a.addCategory({name:r[e],data:t}));break;case"pie":const w=t.calculative.singleton.lightningChart.Pie({theme:m,container:t.id}).setTitle(y).setAnimationsEnabled(!0).setMultipleSliceExplosion(!0);g.map(t=>w.addSlice(t.name,t.value)),w.setInnerRadius(t.lightningCharts.option.innerRadius||0).setLabelFormatter(o.NamePlusRelativeValue),w.addLegendBox(n.VerticalLegendBox).setAutoDispose({type:"max-width",maxWidth:.3}).add(w);break;case"gauge":const x=t.calculative.singleton.lightningChart.Gauge({theme:m,container:t.id}).setTitle(y).setThickness(20).setAngleInterval(t.lightningCharts.option.startAngle||225,t.lightningCharts.option.endAngle||-45);let b=function(t){let e=t.toLowerCase();if(e&&/^#([0-9|a-f]{3}|[0-9|a-f]{6})$/.test(e)){4==e.length&&(e="#"+e[1]+e[1]+e[2]+e[2]+e[3]+e[3]);for(var i=[],n=1;n<7;n+=2)i.push(parseInt("0x"+e.slice(n,n+2)));return i}return e&&/rgb\(\s*(\d{1,3})\s*,\s*(\d{1,3})\s*,\s*(\d{1,3})\s*\)$/.test(e)?e.match(/\(([^)]*)\)/)[1].split(",").map(t=>parseInt(t)):e}(t.lightningCharts.option.background);x.getDefaultSlice().setInterval(t.lightningCharts.option.min||0,t.lightningCharts.option.max||100).setValue(g).setFillStyle(new l({color:c(b[0],b[1],b[2])}))}}function va(t){t.calculative.singleton&&t.calculative.singleton.div&&(t.calculative.singleton.div.remove(),delete t.calculative.singleton.div,delete t.calculative.singleton.lightningChart)}function ga(t){t.calculative.singleton.div&&ti(t,t.calculative.singleton.div)}function ya(t){t.calculative.singleton.div&&ti(t,t.calculative.singleton.div)}function ma(t){t.calculative.singleton.div&&(pa(t),ti(t,t.calculative.singleton.div))}function wa(t){if(!t.calculative?.singleton)return;const e=new Image;e.src=t.calculative.singleton.div.children[0].toDataURL(),t.calculative.img=e}function xa(t){t&&(globalThis.echarts=t),U({echarts:Gs})}function ba(t){t&&(globalThis.Highcharts=t),U({highcharts:aa})}function ka(t){t&&(globalThis.lcjs=t),U({lightningCharts:fa})}var Ta;function Ca(t,e){const i=14*e.calculative.worldRect.height/16,n=(t.match(/[\u4e00-\u9fa5]/g)||"").length;return(t.length-n)*i*.6+n*i}function Aa(t){if("horizontal"==t.direction){const e=[];let i=0;const n=t.height;t.checkboxHeight=n,t.options.forEach((o,s)=>{e.push(s*(40+n)+i),i+=Ca(o.text,t)}),t.optionPos=e;const o=e.length*(40+n)+i;t.checkboxWidth=o,t.width=o,t.calculative.width=o,t.calculative.worldRect={x:t.x,y:t.y,height:t.height,width:t.width,center:{x:t.x+t.width/2,y:t.y+t.height/2}},Mi(t.calculative.worldRect)}else if("vertical"==t.direction){null==t.optionInterval&&(t.optionInterval=20),t.optionHeight||(t.optionHeight=20);const e=[];t.options.forEach((i,n)=>{e.push(n*(t.optionInterval+t.optionHeight))}),t.optionPos=e;const i=e[e.length-1]+t.optionHeight;t.checkboxHeight=i,t.width||(t.height=i,t.calculative.height=i,t.calculative.worldRect={x:t.x,y:t.y,height:t.height,width:t.width,center:{x:t.x+t.width/2,y:t.y+t.height/2}},Mi(t.calculative.worldRect))}}function Ra(t,e){e.onAdd||(e.onAdd=Sa,e.rowPos&&e.colPos&&e.calculative.maxOffsetY||e.onAdd(e),e.onMouseMove=Ea,e.onMouseLeave=_a,e.onMouseDown=Ma,e.onShowInput=Pa,e.onInput=Ia,e.onValue=za,e.onBeforeValue=ja,e.onMouseEnter=$a,e.onWheel=Ha,e.onDestroy=Va),e.data.length!==e.rowPos.length&&(e.initWorldRect=null,e.calculative.isUpdateData=!0,e.onValue(e)),e.data[0].length!==e.colPos.length&&(e.initWorldRect=null,e.calculative.isUpdateData=!0,e.onValue(e));const i=e.calculative.canvas.store;if(e.calculative.canvas.store.data,e.calculative.canvas.store.options,e.color=e.color||i.styles.color,e.textColor=e.textColor||e.color||i.styles.textColor,e.activeColor=e.activeColor||i.styles.activeColor,e.hoverColor=e.hoverColor||i.styles.hoverColor,e.activeBackground=e.activeBackground||i.styles.activeBackground,e.hoverBackground=e.hoverBackground||i.styles.hoverBackground,!e.hasHeader){t.save(),t.beginPath();const{x:i,y:n,width:o,height:s}=e.calculative.worldRect;t.fillStyle="#fff0",t.rect(i-1,n-1,o+2,s+2),t.fill(),t.clip()}!function(t,e){if(!e.colPos)return;const{x:i,y:n,width:o,height:s,ex:a,ey:r}=e.calculative.worldRect;t.save(),t.beginPath(),t.strokeStyle=e.color;let l=e.calculative.borderRadius||0,c=l;l<1&&(l*=o,c*=s);let h=l<c?l:c;if(o<2*h&&(h=o/2),s<2*h&&(h=s/2),t.moveTo(i+h,n),t.arcTo(a,n,a,r,h),t.arcTo(a,r,i,r,h),t.arcTo(i,r,i,n,h),t.arcTo(i,n,a,n,h),e.background&&(t.fillStyle=e.background,t.fill()),!1!==e.bordered&&(t.strokeStyle=e.borderColor||e.color||"#424B61",t.stroke()),!1!==e.hLine){let i=e.rowPos[e.rowPos.length-1];e.hasHeader&&(t.beginPath(),t.moveTo(e.calculative.worldRect.x,e.calculative.worldRect.y+e.rowPos[0]*e.calculative.worldRect.height/e.tableHeight),t.lineTo(e.calculative.worldRect.ex,e.calculative.worldRect.y+e.rowPos[0]*e.calculative.worldRect.height/e.tableHeight),t.strokeStyle=e.borderColor||e.color||"#424B61",t.stroke());for(const n of e.rowPos){if(n===i)continue;const o=n*e.calculative.worldRect.height/e.tableHeight-e.offsetY*e.calculative.canvas.store.data.scale;if(e.hasHeader){if(o<0+e.rowPos[0]||o>e.calculative.worldRect.height)continue}else if(o<0||o>e.calculative.worldRect.height)continue;t.beginPath(),t.moveTo(e.calculative.worldRect.x,e.calculative.worldRect.y+o),t.lineTo(e.calculative.worldRect.ex,e.calculative.worldRect.y+o),t.strokeStyle=e.borderColor||e.color||"#424B61",t.stroke()}}if(!1!==e.vLine){let i=e.colPos[e.colPos.length-1];e.colPos.forEach((n,o)=>{if(n===i)return;const s=n*e.calculative.worldRect.width/e.tableWidth;t.beginPath(),t.moveTo(e.calculative.worldRect.x+s,e.calculative.worldRect.y),t.lineTo(e.calculative.worldRect.x+s,e.calculative.worldRect.ey),t.strokeStyle=e.borderColor||e.color||"#424B61",t.stroke()})}t.restore()}(t,e),function(t,e){if(!e.colPos)return;e.calculative.texts||(e.calculative.texts=[]);for(let i=0;i<e.rowPos.length;i++){if(e.hasHeader&&1===i){t.save(),t.beginPath();const{x:i,y:n,width:o,height:s}=e.calculative.worldRect;t.fillStyle="#fff0",t.rect(i-1,n+e.rowPos[0]*e.calculative.worldRect.height/e.tableHeight-1,o+2,s-e.rowPos[0]*e.calculative.worldRect.height/e.tableHeight+2),t.fill(),t.clip()}let{style:n}=Oa(e,i);for(let o=0;o<e.colPos.length;o++){let{value:s,style:a}=Da(e,i,o),r=!0;if(Array.isArray(a)&&a.length>0){let t=0;a.forEach((e,i)=>{e.wheres&&e.wheres.every(t=>new Function("attr",`return attr ${t.comparison} ${t.value}`)(s))&&(t=i)}),a=a[t]}else a.wheres&&Array.isArray(a.wheres)&&(r=!1,r=a.wheres.every(function(t){return new Function("attr",`return attr ${t.comparison} ${t.value}`)(s)}));let l,c=e.color,h=e.textColor||e.color,d=null,u=null,f=null,p=null;r&&(c=a.color||n.color||e.color,h=a.textColor||n.textColor||e.textColor,d=a.background||n.background,u=(a.fontSize||n.fontSize||0)*e.calculative.canvas.store.data.scale,f=a.fontWeight||n.fontWeight,p=a.fontStyle||n.fontStyle),e.stripe&&(!1!==e.hasHeader?i%2==1&&(d=d||e.stripeColor||"#407FFF1F"):i%2==0&&(d=d||e.stripeColor||"#407FFF1F")),e.calculative.active&&e.calculative.activeCell?.row===i&&e.calculative.activeCell?.col===o&&(c=e.activeColor,d=e.activeBackground,l=c,h=e.activeTextColor||e.activeColor),e.calculative.hover&&e.calculative.hoverCell?.row===i&&e.calculative.hoverCell?.col===o&&(c=e.hoverColor,d=e.hoverBackground,h=e.hoverTextColor||e.hoverColor,l=c);const v=Na(e,i,o);if(v.y+v.height<e.calculative.worldRect.y||v.y>e.calculative.worldRect.height+e.calculative.worldRect.y)continue;d&&(t.save(),t.beginPath(),t.fillStyle=d,t.fillRect(v.x,v.y,v.width+.25*e.calculative.canvas.store.data.scale,v.height),t.restore()),l&&(t.save(),t.beginPath(),t.strokeStyle=l,t.strokeRect(v.x,v.y,v.width,v.height),t.restore()),e.calculative.worldTextRect=v;let g=e.calculative.texts[i];if(e.calculative.texts[i]||(g=[],e.calculative.texts.push(g)),null==g[o]){if("object"==typeof s){const t=e.styles&&e.styles.filter(t=>t.col===o&&void 0===t.row&&t.pens);if(t.length>0){if(g[o]="",e.isFirstTime){e.maxNum&&e.hasHeader&&i>=e.maxNum&&(s.visible=!1);let n=JSON.parse(JSON.stringify(t[0].pens));n.forEach(t=>{Object.assign(t,{row:i,col:o},s),t.activeBackground=t.background,t.hoverBackground=t.background,t.activeColor=t.color,t.hoverColor=t.color,t.activeTextColor=t.textColor,t.hoverTextColor=t.textColor,t.height*=e.calculative.canvas.store.data.scale,t.width*=e.calculative.canvas.store.data.scale}),Fa(e,v,n),e.calculative.canvas.parent.pushChildren(e,n)}continue}}else g[o]=void 0===s?"":s.text||s+"";if(!g[o])continue;g[o]=st(e,g[o])}if(!g[o])continue;t.save(),t.beginPath(),t.fillStyle=h,t.textAlign="center",t.textBaseline="middle",t.font=(p||e.calculative.fontStyle||"")+" normal "+(f||e.calculative.fontWeight||"")+" "+1*(u||e.calculative.fontSize||12)+"px "+e.calculative.fontFamily;let y=e.colStyle&&e.colStyle[o]?.textAlign;if(y&&(t.textAlign=y),1===g[o].length)"left"===y?t.fillText(g[o][0],v.x,v.y+v.height/2):"right"===y?t.fillText(g[o][0],v.x+v.width,v.y+v.height/2):t.fillText(g[o][0],v.x+v.width/2,v.y+v.height/2);else{const i=.55,n=(u||e.calculative.fontSize)*e.calculative.lineHeight*1,s=g[o].length*n;let a=(v.height-s)/2;"left"===y?g[o].forEach((e,o)=>{t.fillText(e,v.x,v.y+a+(o+i)*n)}):"right"===y?g[o].forEach((e,o)=>{t.fillText(e,v.x+v.width,v.y+a+(o+i)*n)}):g[o].forEach((e,o)=>{t.fillText(e,v.x+v.width/2,v.y+a+(o+i)*n)})}t.restore()}}}(t,e),function(t,e){if(!e.calculative.hover)return;if(!e.calculative.hoverCell)return;if(e.calculative.isInput)return;if(!e.calculative.isHover)return;let i=e.calculative.worldRect,n=e.calculative.canvas.mousePos;if(!(n.x>i.x&&n.x<i.x+i.width&&n.y>i.y&&n.y<i.y+i.height))return e.calculative.hover=!1,e.calculative.isHover=!1,void(e.calculative.hoverCell=void 0);const{row:o,col:s}=e.calculative.hoverCell,{x:a,y:r}=e.calculative.canvas.mousePos;if(!e.data[o])return;let l=e.data[o][s];if("object"==typeof l||!l)return;t.save(),t.beginPath(),t.textAlign="start",t.textBaseline="middle",t.font=t.font=(e.calculative.fontStyle||"")+" normal "+(e.calculative.fontWeight||"")+" "+(e.calculative.fontSize||12)+"px "+e.calculative.fontFamily;const c=t.measureText(l).width;t.beginPath(),t.fillStyle="#fff",t.strokeStyle="#000",t.moveTo(a,r),t.rect(a-10,r,c+20,20),t.fill(),t.stroke(),t.beginPath(),t.fillStyle="#000",t.fillText(l,a,r+10),t.restore()}(t,e),t.restore(),e.isFirstTime=!1}function Sa(t){qa(t),t.children?.length||(t.isFirstTime=!0),t.offsetY||(t.offsetY=0),function(t){const e=[],i=[],n={};t.rowHeight||(t.rowHeight=40),t.colWidth||(t.colWidth=150);let o=0;const s=t.styles&&t.styles.filter(t=>void 0!==t.col&&void 0===t.row&&t.width);let a={};s&&s.forEach(t=>{a[t.col]=t.width});for(let i=0;i<t.data[0].length;i++){o+=(a[i]||t.colWidth)*t.calculative.canvas.store.data.scale,e.push(o);let s=t.styles&&t.styles.filter(t=>t.col===i&&void 0===t.row);s&&(n[i]=s[0])}let r=0;const l=t.styles&&t.styles.filter(t=>void 0===t.col&&void 0!==t.row&&t.height);let c={};l&&l.forEach(t=>{c[t.row]=t.height});let h=r;for(let e=0;e<t.data.length;e++)r+=(c[e]||t.rowHeight)*t.calculative.canvas.store.data.scale,i.push(r),e<t.maxNum&&(h=r);if(t.calculative.maxOffsetY=(r-h)/t.calculative.canvas.store.data.scale,t.initWorldRect)return;t.colPos=e,t.rowPos=i,t.colStyle=n,t.initScale=t.calculative.canvas.store.data.scale,t.tableWidth=o,t.tableHeight=h||r,t.calculative.width=o,t.calculative.height=h||r,t.calculative.width=o,t.calculative.height=h||r,t.height||(t.height=t.calculative.height),t.width||(t.width=t.calculative.width);let d=t.x,u=t.y;if(t.parentId){let e=t.calculative.canvas.store.pens[t.parentId];d=e.calculative.worldRect.x+e.calculative.worldRect.width*t.x,u=e.calculative.worldRect.y+e.calculative.worldRect.height*t.y}t.calculative.worldRect={x:d,y:u,height:t.calculative.height,width:t.calculative.width,center:{x:t.x+t.calculative.width/2,y:t.y+t.calculative.height/2}},t.width=t.calculative.width,t.height=t.calculative.height,t.initWorldRect||(t.initWorldRect={width:t.calculative.worldRect.width,height:t.calculative.worldRect.height}),Mi(t.calculative.worldRect)}(t)}function Pa(t,e){if(!t.calculative.hoverCell)return;const{value:i}=Da(t,t.calculative.hoverCell.row,t.calculative.hoverCell.col);if("object"==typeof i)return;t.calculative.isHover=!1,t.calculative.isInput=!0,t.calculative.canvas.render(),t.calculative.inputCell=t.calculative.hoverCell;const n=Na(t,t.calculative.hoverCell.row,t.calculative.hoverCell.col);t.calculative.tempText=i.text||i+"",t.calculative.canvas.showInput(t,n,"#ffffff")}function Ia(t,e){t.calculative.inputCell&&(Ba(t,t.calculative.inputCell.row,t.calculative.inputCell.col,e),t.calculative.isInput=!1,t.calculative.isHover=!0,t.calculative.canvas.render())}function Ea(t,e){t.timer&&(t.calculative.isHover=!1,clearTimeout(t.timer)),t.timer=setTimeout(()=>{t.calculative.isHover=!0,t.calculative.canvas.render()},500),t.calculative.hoverCell=La(t,e),t.calculative.canvas.render()}function _a(t,e){qa(t),t.calculative.hoverCell=void 0,t.calculative.canvas.render()}function Ma(t,e){t.calculative.activeCell=La(t,e),t.calculative.canvas.render()}function La(t,e){const i=t.calculative.worldRect.width/t.tableWidth,n=t.calculative.worldRect.height/t.tableHeight,o={row:0,col:0};for(let n=0;n<t.colPos.length;n++)e.x>t.calculative.worldRect.x+t.colPos[n]*i&&(o.col=n+1);for(let i=0;i<t.rowPos.length;i++)e.y>t.calculative.worldRect.y+t.rowPos[i]*n-t.offsetY*t.calculative.canvas.store.data.scale&&(o.row=i+1);return o}function Da(t,e,i){if(!t.data||!Array.isArray(t.data))return;const n=t.data[e],o=t.styles&&t.styles.filter(t=>t.row===e&&t.col===i);if(Array.isArray(n))return{value:n[i],style:o?.length>0?o.length>1?o:o[0]:{}};n.data&&Array.isArray(n.data)}function Oa(t,e){if(!t.data||!Array.isArray(t.data))return;const i=t.data[e],n=t.styles&&t.styles.filter(t=>t.row===e&&void 0===t.col);if(Array.isArray(i))return{value:i,style:n?.length>0?n[0]:{}};i.data&&Array.isArray(i.data)}function Ba(t,e,i,n){if(!t.data||!Array.isArray(t.data))return;t.isFirstTime=!1,t.calculative.texts=void 0;let o=t.data[e];o&&(o[i]instanceof Object||(o[i]=n),t.calculative.canvas.store.emitter.emit("valueUpdate",t))}function Na(t,e,i){const n=t.calculative.worldRect.width/t.tableWidth,o=t.calculative.worldRect.height/t.tableHeight;let s=0,a=t.colPos[i]*n;i>0&&(s=t.colPos[i-1]*n);let r=0,l=t.rowPos[e]*o;e>0&&(r=t.rowPos[e-1]*o);let c=t.offsetY*t.calculative.canvas.store.data.scale;return 0===e&&t.hasHeader&&(c=0),{x:t.calculative.worldRect.x+s,y:t.calculative.worldRect.y+r-c,ex:t.calculative.worldRect.x+a,ey:t.calculative.worldRect.y+l-c,width:a-s,height:l-r}}function Fa(t,e,i){if(!i||!i.length)return;const n=t.calculative.worldRect.width/t.tableWidth,o=t.calculative.worldRect.height/t.tableHeight;let s=1,a=1;t.initWorldRect&&(t.calculative.worldRect.width!==t.initWorldRect.width&&(s=t.calculative.worldRect.width/t.initWorldRect.width),t.calculative.worldRect.height!==t.initWorldRect.height&&(a=t.calculative.worldRect.height/t.initWorldRect.height));let r=0,l=0,c=0;const h=t.calculative.canvas.store.data.scale;if(i.length>1){for(const t of i)l+t.width*n+20*h*n<e.width?(t.x=e.x+l+10*h*n,t.y=e.y+c+10*h*o,l+=(t.width+10*h)*n,r=Math.max(r,c+(t.height+10*h)*o)):(l=0,c=r,t.x=e.x+l+10*h*n,t.y=e.y+c+10*h*o,r+=(t.height+10*h)*o);if(r+20*h*o<e.height){const t=(e.height-r-10*h*o)/2;for(const e of i)e.y+=t}}else i[0].x=e.x+(e.width-i[0].width)/2,i[0].y=e.y+(e.height-i[0].height)/2;i.forEach(t=>{t.width=t.width*s,t.height=t.height*a})}function za(t){if(t.calculative.isUpdateData){delete t.calculative.isUpdateData;let e=dt(t.children);t.children=[],Sa(t),e&&e.forEach(e=>{t.calculative.canvas.delForce(t.calculative.canvas.findOne(e))}),t.calculative.texts=void 0}}function ja(t,e){if(t.calculative.isUpdateData=!1,void 0!==t.swiper&&(t.swiper?qa(t):Ua(t)),e.styles&&(t.initWorldRect=void 0),e.table||null==e.col&&null==e.row){if(e.dataY){const i=t.replaceMode;let n=[];return i?i===Ta.Replace?(n=t.data,e.dataX&&e.dataX.forEach((t,i)=>{n[t]=e.dataY[i]})):i===Ta.ReplaceAll&&(e.dataX?n[0]=e.dataX:n[0]=t.data[0],n=n.concat(e.dataY)):n=t.data.concat(e.dataY),delete e.dataX,delete e.dataY,t.calculative.isUpdateData=!0,Object.assign(e,{data:n})}(e.data||e.styles||e.maxNum||e.rowHeight||e.colWidth)&&(t.calculative.isUpdateData=!0,t.initWorldRect=null);for(let i of Object.keys(e))i.includes("data.")&&(t.calculative.isUpdateData=!0);return e}let i=t.data[e.row];return i?(i[e.col]instanceof Object||(i[e.col]=e.value),Ba(t,e.row,e.col,e.value),t.calculative.canvas.render(),delete e.col,delete e.row,e):e}function Ha(t,e){if(!t.locked&&!t.calculative.canvas.store.data.locked)return;if(!t.maxNum)return;let i=0;i=e.deltaY>0?4:-4,Wa(t,i)}function Wa(t,e){t.offsetY||(t.offsetY=0),t.offsetY+=e,t.offsetY>t.calculative.maxOffsetY&&(t.offsetY=t.calculative.maxOffsetY),t.offsetY<0&&(t.offsetY=0),t.children?.forEach(e=>{const i=t.calculative.canvas.store.pens[e];!function(t,e){if(!e)return;e.oldY||(e.oldY=e.y);const{y:i,height:n}=e.calculative.worldRect,{y:o,height:s}=t.calculative.worldRect,a=t.calculative.canvas.store.data.scale,r=(t.calculative.worldRect.height,t.tableHeight,t.rowHeight);e.y=e.oldY-t.offsetY*a/t.calculative.worldRect.height;const l=r*(t.initScale||1)/t.tableHeight*t.maxNum;if(t.calculative.canvas.updatePenRect(e),t.hasHeader)if(e.y<t.rowPos[0]/t.tableHeight){if(e.calculative.visible=!1,e.visible=!1,e.y<t.rowPos[0]/t.tableHeight/2){e.oldY+=l;let i=e.row+t.maxNum;if(!t.data[i])return;let n=dt(t.data[i][e.col]);n.background&&(n.activeBackground=n.background,n.hoverBackground=n.background),n.color&&(n.hoverColor=n.color,n.activeColor=n.color),n.textColor&&(n.activeTextColor=n.textColor,n.hoverTextColor=n.textColor),Object.assign(e,n,{row:i}),Object.assign(e.calculative,n,{row:i})}}else if(e.y+e.height>1){if(e.calculative.visible=!1,e.visible=!1,e.y+e.height/2>1){e.oldY-=l;let i=e.row-t.maxNum;if(!t.data[i])return;let n=dt(t.data[i][e.col]);n.background&&(n.activeBackground=n.background,n.hoverBackground=n.background),n.color&&(n.hoverColor=n.color,n.activeColor=n.color),n.textColor&&(n.activeTextColor=n.textColor,n.hoverTextColor=n.textColor),Object.assign(e,n,{row:i}),Object.assign(e.calculative,n,{row:i})}}else e.visible=!0,e.calculative.visible=!0;else if(e.y<0){if(e.calculative.visible=!1,e.visible=!1,e.y<-r/t.tableHeight/2){e.oldY+=l;let i=e.row+t.maxNum;if(!t.data[i])return;let n=dt(t.data[i][e.col]);n.background&&(n.activeBackground=n.background,n.hoverBackground=n.background),n.color&&(n.hoverColor=n.color,n.activeColor=n.color),n.textColor&&(n.activeTextColor=n.textColor,n.hoverTextColor=n.textColor),Object.assign(e,n,{row:i}),Object.assign(e.calculative,n,{row:i})}}else if(e.y+e.height>1){if(e.calculative.visible=!1,e.visible=!1,e.y+e.height/2>1){e.oldY-=l;let i=e.row-t.maxNum;if(!t.data[i])return;let n=dt(t.data[i][e.col]);n.background&&(n.activeBackground=n.background,n.hoverBackground=n.background),n.color&&(n.hoverColor=n.color,n.activeColor=n.color),n.textColor&&(n.activeTextColor=n.textColor,n.hoverTextColor=n.textColor),Object.assign(e,n,{row:i}),Object.assign(e.calculative,n,{row:i})}}else e.calculative.visible=!0,e.visible=!0}(t,i)}),t.calculative.canvas.render()}function Va(t){Ua(t)}function Ua(t){t.interval&&(globalThis.clearInterval(t.interval),t.interval=null)}function qa(t){if(t.maxNum&&t.swiper){if(t.interval)return;t.interval=globalThis.setInterval(()=>{t.offsetY>=t.calculative.maxOffsetY?(t.offsetY=0,function(t){t.children?.forEach(e=>{const i=t.rowHeight,n=t.calculative.canvas.store.pens[e];if(!n)return;const o=i*(t.initScale||1)/t.tableHeight*t.maxNum;n.oldY-=o;const s=n.row-t.maxNum;if(!t.data[s])return;let a=dt(t.data[s][n.col]);a.background&&(a.activeBackground=a.background,a.hoverBackground=a.background),a.color&&(a.hoverColor=a.color,a.activeColor=a.color),a.textColor&&(a.activeTextColor=a.textColor,a.hoverTextColor=a.textColor),n.calculative.visible=!0,n.visible=!0,Object.assign(n,a,{row:s}),Object.assign(n.calculative,a,{row:s})}),t.calculative.canvas.render()}(t)):t.offsetY%t.rowHeight?Wa(t,1):(t.calculative.stap||(t.calculative.stap=0),t.calculative.stap+=1,12==t.calculative.stap&&(t.calculative.stap=0,Wa(t,1)))},50)}}function $a(t){Ua(t)}function Ka(t,e){e.onClick||(e.onClick=Ya,e.setTheme=Xa);let i=e.calculative.worldRect.x,n=e.calculative.worldRect.y,o=e.calculative.worldRect.width,s=e.calculative.worldRect.height;o<1.5*s&&(o=1.5*s),t.beginPath(),t.arc(i+s/2,n+s/2,s/2,Math.PI/2,3*Math.PI/2),t.lineTo(i+o-s/2,n),t.arc(i+o-s/2,n+s/2,s/2,-Math.PI/2,Math.PI/2),t.lineTo(i+s/2,n+s),e.checked?(t.fillStyle=e.onColor,(e.disabled||e.disable)&&(t.fillStyle=e.disableOnColor||yt(.6,e.onColor)),e.lineWidth&&(t.strokeStyle=e.onStrokeColor,t.stroke()),t.fill(),t.closePath(),t.beginPath(),t.fillStyle="#ffffff",t.moveTo(i+2*s,n+s/2),t.arc(i+o-s/2,n+s/2,s/2>2?s/2-2:1,0,2*Math.PI),t.fill()):(t.fillStyle=e.offColor,(e.disabled||e.disable)&&(t.fillStyle=e.disableOffColor||yt(.6,e.offColor)),e.lineWidth&&(t.strokeStyle=e.offStrokeColor,t.stroke()),t.fill(),t.closePath(),t.beginPath(),t.fillStyle="#ffffff",t.moveTo(i+s,n+s/2),t.arc(i+s/2,n+s/2,s/2>2?s/2-2:1,0,2*Math.PI),t.fill()),t.closePath()}function Ya(t){t.disableDefaultClick||t.disabled||t.disable||(t.checked=!t.checked,t.calculative.canvas.store.emitter.emit("valueUpdate",t),t.calculative.canvas.render())}function Xa(t,e){for(const i in e)if(Object.prototype.hasOwnProperty.call(e,i)){const n=e[i];t.hasOwnProperty(i)&&(t[i]=n),t.calculative.hasOwnProperty(i)&&(t.calculative[i]=n)}t.onStrokeColor=e.borderColor,t.offStrokeColor=e.borderColor}function Ga(t,e){e.onAdd||(e.onAdd=Ja,e.onResize=Ja,e.onMove=Ja,e.onMouseMove=tr,e.onMouseDown=Za,e.onValue=er,e.onBeforeValue=ir,e.setTheme=nr),e.calculative.barRect||Ja(e);const i=e.calculative.canvas.store;e.calculative.canvas.store.options;let n=e.background;e.disabled&&(n=e.disabledBackground||yt(.6,n)),t.fillStyle=n,t.beginPath();let o=e.calculative.worldRect.x+e.calculative.barRect.x,s=e.calculative.worldRect.y+e.calculative.barRect.y,a=e.calculative.barRect.width,r=e.calculative.barRect.height,l=r/2;t.moveTo(o+l,s),t.arcTo(o+a,s,o+a,s+r,l),t.arcTo(o+a,s+r,o,s+r,l),t.arcTo(o,s+r,e.x,e.y,l),t.arcTo(o,s,o+a,s,l),t.fill();let c=e.activeColor||i.styles.activeColor;e.disabled&&(c=e.disabledColor||yt(.6,c)),t.fillStyle=c,t.beginPath(),a=e.calculative.ballRect.x,t.moveTo(o+l,s),t.arcTo(o+a,s,o+a,s+r,l),t.arcTo(o+a,s+r,o,s+r,l),t.arcTo(o,s+r,e.x,e.y,l),t.arcTo(o,s,o+a,s,l),t.fill(),t.fillStyle=e.btnBackground||"#fff",t.strokeStyle=c,t.lineWidth=2,t.beginPath(),o=e.calculative.worldRect.x+e.calculative.ballRect.x,s=e.calculative.worldRect.y+e.calculative.ballRect.y+e.calculative.ballRect.height/2,t.lineWidth=e.calculative.ballRect.width/10,t.arc(o,s,e.calculative.ballRect.width/2,0,2*Math.PI),t.fill(),t.stroke()}function Ja(t){if(t._textWidth||(t._textWidth=t.textWidth||50,t._fontSize=t.fontSize||12),t.textWidth=t.calculative.worldRect.width,t.calculative.textWidth=t.textWidth,t.unit||(t.unit="%"),t.sliderWidth||(t.sliderWidth=t.width),t.sliderHeight||(t.sliderHeight=t.height),!t.calculative.worldRect)return;const e=t.calculative.worldRect.width/t.sliderWidth,i=t.calculative.worldRect.height/t.sliderHeight,n=Math.min(e,i);t.fontSize=t._fontSize*n;const o=t.calculative.worldRect.width-t._textWidth*n;t.textLeft=o+10*n,t.calculative.textLeft=t.textLeft,t.calculative.barRect={x:0,y:(t.calculative.worldRect.height-t.barHeight*i)/2,width:o,height:t.barHeight*i},Mi(t.calculative.barRect),Qa(t)}function Qa(t){const e=3.5*t.calculative.barRect.height,i=t.calculative.barRect.width*t.value/100;t.calculative.ballRect={x:i,y:(t.calculative.worldRect.height-e)/2,width:e,height:e},Mi(t.calculative.ballRect),t.calculative.text=t.value+t.unit,nt(t)}function Za(t,e){if(t.disabled)return;const i=e.x-t.calculative.worldRect.x;if(i>t.calculative.barRect.width)return;let n=Math.round(i/t.calculative.barRect.width*100);n<t.min||n>t.max||n<0||n>100||(t.value=n,Qa(t),t.calculative.text=t.value+t.unit,nt(t),t.calculative.canvas.store.emitter.emit("valueUpdate",t),t.calculative.canvas.render())}function tr(t,e){t.calculative.canvas.mouseDown&&Za(t,e)}function er(t){t.calculative.isUpdateData&&(delete t.calculative.isUpdateData,Ja(t)),Qa(t)}function ir(t,e){return t.calculative.isUpdateData=!1,(e.textWidth||e.barHeight)&&(e.textWidth&&(t._textWidth=0),t.calculative.isUpdateData=!0),e}function nr(t,e){for(const i in e)if(Object.prototype.hasOwnProperty.call(e,i)){const n=e[i];t.hasOwnProperty(i)&&(t[i]=n),t.calculative.hasOwnProperty(i)&&(t.calculative[i]=n)}t.background=e.sliderBg,t.calculative.background=e.sliderBg,t.btnBackground=e.sliderBtnBg,t.calculative.btnBackground=e.sliderBtnBg,t.activeColor=e.tabActiveBg,t.calculative.activeColor=e.tabActiveBg}function or(t,e){e.onMouseDown||(e.onMouseDown=sr),e.options||(e.options=e.data);let i=e.calculative.worldRect.x,n=e.calculative.worldRect.y,o=e.calculative.worldRect.height;e.calculative.worldRect.width;const{fontStyle:s,fontWeight:a,fontSize:r,fontFamily:l,lineHeight:c}=e.calculative;t.beginPath(),t.moveTo(i,n),t.arcTo(i+o,n,i+o,n+o,2),t.arcTo(i+o,n+o,i,n+o,2),t.arcTo(i,n+o,i,n,2),t.arcTo(i,n,i+o,n,2),t.strokeStyle="#d9d9d9",t.fillStyle="#ffffff00",e.checked&&(t.fillStyle=e.background||"#1890ff",t.strokeStyle=e.background||"#1890ff"),(e.isForbidden||e.disabled)&&(t.fillStyle=e.disabledBackground||yt(.6,e.background)||"#ebebeb",t.strokeStyle=e.disabledColor||yt(.6,e.color)||"#d9d9d9"),t.closePath(),t.fill(),t.stroke(),t.save(),e.checked&&(t.beginPath(),t.lineWidth=o/10,t.strokeStyle="#ffffff",t.moveTo(i+102/506*o,n+o/2),t.lineTo(i+220/506*o,n+346/460*o),t.lineTo(i+404/506*o,n+142/460*o),t.stroke()),t.restore(),t.save(),t.fillStyle=e.disabled||e.isForbidden?e.disabledTextColor||yt(.6,e.textColor||e.color)||"#00000040":re(e,e.calculative.canvas.parent.store)||"#000000d9",t.textAlign="start",t.textBaseline="middle",t.font=ue({fontStyle:s,fontWeight:a,fontFamily:l||e.calculative.canvas.parent.store.options.fontFamily,fontSize:r,lineHeight:c}),t.fillText(e.value+"",i+o+10,n+o/2),t.restore()}function sr(t,e){t.isForbidden||(t.checked=!t.checked,t.calculative.canvas.store.emitter.emit("valueUpdate",t),t.calculative.canvas.render())}function ar(t,e){e.options||(e.options=e.data),e.onAdd||(e.onAdd=rr,e.optionPos||(e.onAdd(e),e.calculative.canvas.parent.active([e])),e.onMouseDown=lr,e.onValue=cr,e.onBeforeValue=hr);let i=e.calculative.worldRect.x,n=e.calculative.worldRect.y,o=e.calculative.worldRect.height,s=e.calculative.worldRect.width;if(!e.optionPos)return;const{fontStyle:a,fontWeight:r,fontSize:l,fontFamily:c,lineHeight:h}=e.calculative;if("horizontal"==e.direction)for(let l=0;l<e.optionPos.length;l++){const d=e.optionPos[l]*s/e.checkboxWidth,u=e.options[l].isForbidden||e.disabled;t.beginPath(),t.arc(i+d+o/2,n+o/2,o/2,0,2*Math.PI),t.strokeStyle="#d9d9d9",t.fillStyle="#ffffff00",e.options[l].text===e.checked&&(t.strokeStyle=e.options[l].background||e.background||"#1890ff"),u&&(t.fillStyle=e.disabledBackground||yt(.6,e.background)||"#ebebeb",t.strokeStyle=e.disabledColor||yt(.6,e.color)||"#d9d9d9",e.options[l].text===e.checked&&(t.fillStyle="#ffffff00")),t.closePath(),t.fill(),t.stroke(),t.save(),e.options[l].text===e.checked&&(t.beginPath(),t.strokeStyle=e.options[l].background?e.options[l].background+"20":e.background||"#1890ff20",u&&(t.strokeStyle=e.disabledBackground||yt(.6,e.background)||"#ebebeb"),t.arc(i+o/2+d,n+o/2,o/2+1.5,0,2*Math.PI),t.stroke(),t.closePath(),t.beginPath(),t.fillStyle=e.options[l].background||e.background||"#1890ff",u&&(t.fillStyle=e.disabledBackground||yt(.6,e.background)||"#ebebeb"),t.arc(i+o/2+d,n+o/2,o/4,0,2*Math.PI),t.fill(),t.closePath()),t.restore(),t.save(),t.fillStyle=u?e.disabledTextColor||"#00000040":re(e,e.calculative.canvas.parent.store)||"#000000d9";const f=14*e.calculative.worldRect.height/16;t.textAlign="start",t.textBaseline="middle",t.font=ue({fontStyle:a,fontWeight:r,fontFamily:c||e.calculative.canvas.parent.store.options.fontFamily,fontSize:f,lineHeight:h}),t.fillText(e.options[l].text,i+o+d+10/e.checkboxWidth*s,n+o/2),t.restore()}else if("vertical"==e.direction){const s=e.optionHeight*o/e.checkboxHeight;for(let l=0;l<e.optionPos.length;l++){const d=e.optionPos[l]*o/e.checkboxHeight,u=e.options[l].isForbidden;t.beginPath(),t.arc(i+s/2,n+s/2+d,s/2,0,2*Math.PI),t.strokeStyle="#d9d9d9",t.fillStyle="#ffffff00",e.options[l].text===e.checked&&(t.strokeStyle=e.options[l].background||"#1890ff"),u&&(t.fillStyle="#ebebeb",t.strokeStyle="#d9d9d9"),t.closePath(),t.fill(),t.stroke(),t.save(),u||e.options[l].text!==e.checked||(t.beginPath(),t.strokeStyle=e.options[l].background?e.options[l].background+"20":"#1890ff20",t.arc(i+s/2,n+s/2+d,s/2+1.5,0,2*Math.PI),t.stroke(),t.closePath(),t.beginPath(),t.fillStyle=e.options[l].background||"#1890ff",t.arc(i+s/2,n+s/2+d,s/4,0,2*Math.PI),t.fill(),t.closePath()),t.restore(),t.save(),t.fillStyle=u?"#00000040":re(e,e.calculative.canvas.parent.store)||"#000000d9";const f=14*e.calculative.worldRect.height/e.checkboxHeight;t.textAlign="start",t.textBaseline="middle",t.font=ue({fontStyle:a,fontWeight:r,fontFamily:c||e.calculative.canvas.parent.store.options.fontFamily,fontSize:f,lineHeight:h}),t.fillText(e.options[l].text,i+s+10,n+s/2+d),t.restore()}}}function rr(t){Aa(t)}function lr(t,e){if("horizontal"==t.direction)for(let i=0;i<t.optionPos.length;i++)!t.options[i].isForbidden&&e.x>t.calculative.worldRect.x+t.optionPos[i]*t.calculative.worldRect.width/t.checkboxWidth&&e.x<t.calculative.worldRect.x+(t.optionPos[i]+t.height)/t.checkboxWidth*t.calculative.worldRect.width+Ca(t.options[i].text,t)+10/t.checkboxWidth*t.calculative.worldRect.width&&(t.checked=t.options[i].text,t.calculative.canvas.store.emitter.emit("valueUpdate",t));else if("vertical"==t.direction){const i=t.calculative.worldRect.height/t.checkboxHeight;for(let n=0;n<t.optionPos.length;n++)!t.options[n].isForbidden&&e.y>t.calculative.worldRect.y+t.optionPos[n]*i&&e.y<t.calculative.worldRect.y+(t.optionPos[n]+t.optionHeight)*i&&(t.checked=t.options[n].text,t.calculative.canvas.store.emitter.emit("valueUpdate",t))}t.calculative.canvas.render()}function cr(t){t.calculative.flag&&Aa(t)}function hr(t,e){return t.calculative.flag=!1,void 0===e.options&&void 0===e.direction&&void 0===e.optionInterval&&void 0===e.optionHeight||(t.calculative.flag=!0),e}function dr(){return{radio:ar,switch:Ka,slider:Ga,checkbox:or,table:Ra,table2:Ra}}function ur(t,e){const i=e||new Path2D,{x:n,y:o,width:s,height:a}=t.calculative.worldRect,r=a/6,l=s/4;if(i.moveTo(n+2*l,o+0),i.lineTo(n+2*l,o+r),i.moveTo(n,o+r+2*l),i.arc(n+2*l,o+r+2*l,2*l,1*Math.PI,2*Math.PI,!1),i.lineTo(n+4*l,o+5*r),i.lineTo(n,o+5*r),i.lineTo(n,o+r+2*l),i.moveTo(n+l,o+5*r),i.lineTo(n+l,o+6*r),i.moveTo(n+2*l,o+5*r),i.lineTo(n+2*l,o+6*r),i.moveTo(n+3*l,o+5*r),i.lineTo(n+3*l,o+6*r),i.closePath(),i instanceof Path2D)return i}function fr(t){t.anchors=[{x:.5,y:0},{x:.25,y:1},{x:.5,y:1},{x:.75,y:1}].map(({x:e,y:i},n)=>({id:`${n}`,penId:t.id,x:e,y:i}))}function pr(t,e){const i=e||new Path2D,{x:n,y:o,width:s,height:a}=t.calculative.worldRect,r=a-s,l=.5*s;if(i.moveTo(n+s/2,o),i.lineTo(n+s/2,o+r),i.moveTo(n+s,o+l+r),i.arc(n+s/2,o+l+r,l,0,2*Math.PI,!1),i.closePath(),i instanceof Path2D)return i}function vr(t){t.anchors=[{x:.5,y:0},{x:.5,y:1}].map(({x:e,y:i},n)=>({id:`${n}`,penId:t.id,x:e,y:i}))}function gr(t,e){const i=e||new Path2D,{x:n,y:o,width:s,height:a}=t.calculative.worldRect,r=a/2,l=s/5;if(i.moveTo(n,o+r),i.lineTo(n+l,o+r),i.moveTo(n+5*l,o+r),i.ellipse(n+3*l,o+r,2*l,r,0,0,2*Math.PI),i.closePath(),i instanceof Path2D)return i}function yr(t){t.anchors=[{x:.6,y:0},{x:1,y:.5},{x:.6,y:1},{x:0,y:.5}].map(({x:e,y:i},n)=>({id:`${n}`,penId:t.id,x:e,y:i}))}function mr(t,e){const i=e||new Path2D,{x:n,y:o,width:s,height:a}=t.calculative.worldRect,r=a/4,l=.5*s;if(i.moveTo(n+l,o),i.lineTo(n+l,o+r),i.moveTo(n,o+r),i.rect(n,o+r,2*l,2*r),i.moveTo(n+l,o+3*r),i.lineTo(n+l,o+4*r),i.closePath(),i instanceof Path2D)return i}function wr(t,e){const i=e||new Path2D,{x:n,y:o,width:s,height:a}=t.calculative.worldRect,r=a/8,l=.25*s;if(i.moveTo(n+2*l,o),i.lineTo(n+2*l,o+2*r),i.lineTo(n+3*l,o+3*r),i.lineTo(n+3*l,o+5*r),i.lineTo(n+2*l,o+6*r),i.lineTo(n+1*l,o+5*r),i.lineTo(n+1*l,o+3*r),i.lineTo(n+2*l,o+2*r),i.moveTo(n+3*l,o+4*r),i.lineTo(n+4*l,o+4*r),i.moveTo(n+2*l,o+6*r),i.lineTo(n+2*l,o+8*r),i.closePath(),i instanceof Path2D)return i}function xr(t){t.anchors=[{x:.5,y:0},{x:1,y:.5},{x:.5,y:1}].map(({x:e,y:i},n)=>({id:`${n}`,penId:t.id,x:e,y:i}))}function br(t,e){const i=e||new Path2D,{x:n,y:o,width:s,height:a}=t.calculative.worldRect,r=s/2,l=a/10;if(i.moveTo(n+r,o),i.lineTo(n+r,o+l),i.moveTo(n+r,o+l),i.quadraticCurveTo(n+2*r,o+l,n+2*r,o+9*l),i.moveTo(n+r,o+l),i.quadraticCurveTo(n,o+l,n,o+9*l),i.quadraticCurveTo(n+r,o+6*l,n+2*r,o+9*l),i.moveTo(n+r,o+3*a/4),i.lineTo(n+r,o+a),i.moveTo(n+2*r/5,o+201*a/250),i.lineTo(n+2*r/5,o+a),i.moveTo(n+8*r/5,o+201*a/250),i.lineTo(n+8*r/5,o+a),i.closePath(),i instanceof Path2D)return i}function kr(t){t.anchors=[{x:.5,y:0},{x:.2,y:1},{x:.5,y:1},{x:.8,y:1}].map(({x:e,y:i},n)=>({id:`${n}`,penId:t.id,x:e,y:i}))}function Tr(t,e){const i=e||new Path2D,{x:n,y:o,width:s,height:a}=t.calculative.worldRect,r=a/6,l=s/4;if(i.moveTo(n+2*l,o+0),i.lineTo(n+2*l,o+r),i.moveTo(n,o+r+2*l),i.arc(n+2*l,o+r+2*l,2*l,1*Math.PI,2*Math.PI,!1),i.lineTo(n+4*l,o+5*r),i.lineTo(n,o+5*r),i.lineTo(n,o+r+2*l),i.moveTo(n,o+5*r-r/3),i.lineTo(n+4*l,o+5*r-r/3),i.moveTo(n+l,o+5*r),i.lineTo(n+l,o+6*r),i.moveTo(n+2*l,o+5*r),i.lineTo(n+2*l,o+6*r),i.moveTo(n+3*l,o+5*r),i.lineTo(n+3*l,o+6*r),i.closePath(),i instanceof Path2D)return i}function Cr(t,e){const i=e||new Path2D,{x:n,y:o,width:s,height:a}=t.calculative.worldRect,r=a/4,l=.5*s;if(i.moveTo(n+l,o),i.lineTo(n+l,o+r),i.lineTo(n+2*l,o+2*r),i.lineTo(n+2*l,o+4*r),i.lineTo(n,o+4*r),i.lineTo(n,o+2*r),i.lineTo(n+l,o+r),i.closePath(),i instanceof Path2D)return i}function Ar(t,e){const i=e||new Path2D,{x:n,y:o,width:s,height:a}=t.calculative.worldRect,r=a/4,l=s/2;if(i.moveTo(n+l,o),i.lineTo(n+l,o+r),i.lineTo(n+2*l,o+4*r),i.lineTo(n,o+4*r),i.lineTo(n+l,o+r),i.closePath(),i instanceof Path2D)return i}function Rr(t,e){const i=e||new Path2D,{x:n,y:o,width:s,height:a}=t.calculative.worldRect,r=a/3,l=.5*s;if(i.moveTo(n+l,o),i.lineTo(n+l,o+r),i.lineTo(n+s,o+2*r),i.lineTo(n+l,o+a),i.lineTo(n,o+2*r),i.lineTo(n+l,o+r),i.closePath(),i instanceof Path2D)return i}function Sr(t){t.anchors=[{x:.5,y:0},{x:1,y:2/3},{x:.5,y:1},{x:0,y:2/3}].map(({x:e,y:i},n)=>({id:`${n}`,penId:t.id,x:e,y:i}))}function Pr(t,e){const{x:i,y:n,width:o,height:s}=e.calculative.worldRect,a=o/2,r=s/10;t.beginPath(),t.moveTo(i+a,n),t.lineTo(i+a,n+r),t.moveTo(i+a,n+r),t.quadraticCurveTo(i+2*a,n+r,i+2*a,n+9*r),t.moveTo(i+a,n+r),t.quadraticCurveTo(i,n+r,i,n+9*r),t.quadraticCurveTo(i+a,n+6*r,i+2*a,n+9*r),t.moveTo(i+a,n+3*s/4),t.lineTo(i+a,n+9*s/10),t.moveTo(i+2*a/5,n+201*s/250),t.lineTo(i+2*a/5,n+9*s/10),t.moveTo(i+8*a/5,n+201*s/250),t.lineTo(i+8*a/5,n+9*s/10),t.stroke(),t.closePath(),t.beginPath();const l=2*a>10*r?r:a/5;t.fillStyle="#333333",t.font=l+"px Arial",t.textBaseline="bottom",t.textAlign="center",t.fillText("o",i+a,n+s),t.fillText("m",i+2*a/5,n+s),t.fillText("o",i+8*a/5,n+s),t.closePath()}function Ir(t,e){const i=e||new Path2D,{x:n,y:o,width:s,height:a}=t.calculative.worldRect;let r=s/2,l=a/10;if(i.moveTo(n+r,o),i.lineTo(n+r,o+l),i.moveTo(n+r,o+l),i.quadraticCurveTo(n+2*r,o+l,n+2*r,o+9*l),i.moveTo(n+r,o+l),i.quadraticCurveTo(n,o+l,n,o+9*l),i.quadraticCurveTo(n+r,o+6*l,n+2*r,o+9*l),i.moveTo(n,o+10*l),i.quadraticCurveTo(n+r,o+7*l,n+2*r,o+10*l),i.moveTo(n+2*r/5,o+201*a/250+l),i.lineTo(n+2*r/5,o+a),i.moveTo(n+8*r/5,o+201*a/250+l),i.lineTo(n+8*r/5,o+a),i.closePath(),i instanceof Path2D)return i}function Er(t){t.anchors=[{x:.5,y:0},{x:.2,y:1},{x:.8,y:1}].map(({x:e,y:i},n)=>({id:`${n}`,penId:t.id,x:e,y:i}))}function _r(){return{andGate:ur,basicEvent:pr,conditionalEvent:gr,event:mr,forbiddenGate:wr,orGate:br,priorityAndGate:Tr,switchEvent:Cr,transferSymbol:Ar,unexpandedEvent:Rr,xorGate:Ir}}function Mr(){return{votingGate:Pr}}function Lr(){return{andGate:fr,orGate:kr,priorityAndGate:fr,votingGate:kr,xorGate:Er,forbiddenGate:xr,basicEvent:vr,unexpandedEvent:Sr,conditionalEvent:yr,transferSymbol:vr}}!function(t){t[t.Add=0]="Add",t[t.Replace=1]="Replace",t[t.ReplaceAll=2]="ReplaceAll"}(Ta||(Ta={}));const Dr=15;function Or(t,e=Dr){let i=""+t;return i.indexOf(".")>=0&&(i=Number.parseFloat(i).toFixed(e)),Number.parseFloat(i)}function Br(t){return"number"==typeof t&&Number.isFinite(t)}function Nr(t,e){const i=e.calculative.worldRect.x,n=e.calculative.worldRect.y,o=e.calculative.worldRect.width,s=e.calculative.worldRect.height;let a=e.calculative.canvas.store.data.scale,r=[];if(e.echarts)for(let t=0;t<e.echarts.option.series.length;t++)r.push(e.echarts.option.series[t].data);else r=e.data;let l=[];for(let t=0;t<r.length;t++)l=l.concat(r[t]);let c=function(t){t={max:null,min:null,splitNumber:4,symmetrical:!1,deviation:!1,preferZero:!1,...t};const e=[10,15,20,25,30,40,50,60,70,80,90,100,150];let{max:i,min:n,splitNumber:o,symmetrical:s,deviation:a,preferZero:r}=t;if(!Br(i)||!Br(n)||i<n)return{splitNumber:o};if(i===n&&0===i)return{max:Or(e[0]*o),min:n,interval:e[0],splitNumber:o};i===n&&(r=!0),(!Br(o)||o<=0)&&(o=4),r&&i*n>0&&(i<0?i=0:n=0);const l=(i-n)/o;let c=Math.floor(Math.log10(l)-1);c=Math.pow(10,c);const h=l/c;let d,u=e[0]*c,f=-1;for(d=0;d<e.length;d++)if(e[d]>h){u=e[d]*c;break}let p=i,v=n;function g(t){if(p=parseInt(""+(i/t+1))*t,v=parseInt(""+(n/t-1))*t,0===i&&(p=0),0===n&&(v=0),s&&p*v<0){const t=Math.max(Math.abs(p),Math.abs(v));p=t,v=-t}}if(g(u),a)return{max:Or(p),min:Or(v),interval:Or(u),splitNumber:Math.round((p-v)/u)};if(!s||p*v>0){let t;t:do{if(t=Math.round((p-v)/u),(d-f)*(t-o)<0)for(;t<o;)if(v-n<=p-i&&0!==v||0===p?v-=u:p+=u,t++,t===o)break t;if(d>=e.length-1||d<=0||t===o)break;f=d,u=t>o?e[++d]*c:e[--d]*c,g(u)}while(t!==o)}p=Or(p),v=Or(v);const y=Or((p-v)/o);return{max:p,min:v,interval:y,splitNumber:o}}({max:Math.max.apply(null,l),min:Math.min.apply(null,l),splitNumber:5}),h=e.echarts?e.echarts.option.xAxis.data.length:e.xAxisData.length;t.beginPath(),t.strokeStyle="#BFBFBF",t.lineWidth=6*a,t.lineCap="butt";let d=(o-1*(h+1))/h;t.setLineDash([1,d]),t.moveTo(i,n+s+3*a),t.lineTo(i+o,n+s+3*a),t.stroke(),t.closePath(),t.beginPath(),t.lineWidth=1*a,t.setLineDash([]),t.moveTo(i,n+s),t.lineTo(i+o,n+s),t.stroke(),t.closePath(),t.beginPath(),t.fillStyle="#BFBFBF",t.strokeStyle="#E9E9E9",t.setLineDash([2,2]);let u={fontStyle:e.yAxis?.axisLabel?.fontStyle||e.fontStyle,textDecoration:e.yAxis?.axisLabel?.textDecoration,fontWeight:e.yAxis?.axisLabel?.fontWeight||e.fontWeight,fontFamily:e.yAxis?.axisLabel?.fontFamily||e.fontFamily,fontSize:e.yAxis?.axisLabel?.fontSize||e.fontSize,lineHeight:e.yAxis?.axisLabel?.lineHeight||e.lineHeight};t.fillStyle=e.yAxis?.axisLabel?.fontColor||e.color;for(let e=0;e<c.splitNumber+1;e++){let r=e*s/c.splitNumber;t.textAlign="right",t.textBaseline="middle",t.font=ue(u),t.fillText(c.max-e*c.interval+"",i-10*a,n+r),t.fill(),e<c.splitNumber&&(t.beginPath(),t.moveTo(i,n+r),t.lineTo(i+o,n+r),t.stroke())}t.closePath(),t.beginPath(),t.strokeStyle="#BFBFBF";let f=e.echarts?e.echarts.option.xAxis.data:e.xAxisData,p=0;for(let o=0;o<f.length;o++){p=i+(1+d/2)+(d+1)*o,t.textAlign="center",t.textBaseline="top";let r={fontStyle:e.xAxis?.axisLabel?.fontStyle||e.calculative.fontStyle,textDecoration:e.xAxis?.axisLabel?.textDecoration,fontWeight:e.xAxis?.axisLabel?.fontWeight||e.calculative.fontWeight,fontFamily:e.xAxis?.axisLabel?.fontFamily||e.calculative.fontFamily,fontSize:e.xAxis?.axisLabel?.fontSize||e.calculative.fontSize,lineHeight:e.xAxis?.axisLabel?.lineHeight||e.calculative.lineHeight};t.font=ue(r),t.fillStyle=e.xAxis?.axisLabel?.fontColor||e.calculative.color,t.fillText(f[o],p,n+s+10*a),t.fill()}return t.closePath(),t.setLineDash([]),{dash:d,normalizedOption:c}}function Fr(t,e){if(!isNaN(t))return-1===e?t:Math.round(1e3*Number(t))/1e3}var zr;function jr(t,e){e.onBeforeValue||(e.onBeforeValue=Hr);const i=e.calculative.worldRect.x,n=e.calculative.worldRect.y,o=(e.calculative.worldRect.width,e.calculative.worldRect.height);let s=e.calculative.canvas.store.data.scale,a=[];e.echarts&&!e.echarts.option.color&&(e.echarts.option.color=["#1890ff","#2FC25B","#FACC14","#c23531","#2f4554","#61a0a8","#d48265"]);let r=Nr(t,e),l=r.dash,c=r.normalizedOption;const h=!!(e.echarts?e.echarts.option.series[0].smooth:e.smooth);let d=[];if(e.echarts)for(let t=0;t<e.echarts.option.series.length;t++)a.push(e.echarts.option.series[t].data);else a=e.data;for(let r=0;r<a.length;r++){t.beginPath();let u=a[r];t.strokeStyle=e.echarts?e.echarts.option.color[r]:e.chartsColor[r],t.fillStyle=e.echarts?e.echarts.option.color[r]:e.chartsColor[r];let f=i+(1+l/2),p=n+o-(u[0]-c.min)/(c.max-c.min)*o;if(t.moveTo(f,p),d.push({x:f,y:p}),h)if(u.length<=2)for(let e=1;e<u.length;e++)f=i+(1+l/2)+(l+1)*e,p=n+o-(u[e]-c.min)/(c.max-c.min)*o,t.lineTo(f,p),d.push({x:f,y:p});else{let e,s,a,r;u.forEach((h,v)=>{f=i+(1+l/2)+(l+1)*v,p=n+o-(u[v]-c.min)/(c.max-c.min)*o;let g=i+(1+l/2)+(l+1)*(v+1),y=n+o-(u[v+1]-c.min)/(c.max-c.min)*o,m=i+(1+l/2)+(l+1)*(v-1),w=n+o-(u[v-1]-c.min)/(c.max-c.min)*o,x=i+(1+l/2)+(l+1)*(v+2),b=n+o-(u[v+2]-c.min)/(c.max-c.min)*o;0===v?(m=i+(1+l/2)+(l+1)*v,w=n+o-(u[v]-c.min)/(c.max-c.min)*o):v===u.length-2&&(x=i+(1+l/2)+(l+1)*(v+1),b=n+o-(u[v+1]-c.min)/(c.max-c.min)*o),d.push({x:f,y:p}),e=f+(g-m)/4,s=p+(y-w)/4,a=g-(x-f)/4,r=y-(b-p)/4,t.bezierCurveTo(e,s,a,r,g,y)})}else for(let e=1;e<u.length;e++)f=i+(1+l/2)+(l+1)*e,p=n+o-(u[e]-c.min)/(c.max-c.min)*o,t.lineTo(f,p),d.push({x:f,y:p});t.stroke(),t.closePath(),t.save(),d.forEach((e,i)=>{t.beginPath(),t.strokeStyle="#fff",t.lineWidth=2*s,t.arc(e.x,e.y,4*s,0,2*Math.PI),t.stroke(),t.fill(),t.closePath()}),t.restore(),d=[]}}function Hr(t,e){if(e.xAxisData||e.data||!e.dataX&&!e.dataY)return e;const i=t.xAxisData,n=t.data,o=t.replaceMode;let s=[],a=[];return o?o===zr.Replace?(e.dataX.forEach((t,o)=>{let s=i.indexOf(t);n.forEach((t,i)=>{t[s]=e.dataY[i][o]})}),s=i,a=n):o===zr.ReplaceAll&&(s=e.dataX,a=e.dataY):(s=[...i,...e.dataX],n.forEach((t,i)=>{let n=[...t,...e.dataY[i]];a.push(n)})),delete e.dataX,delete e.dataY,Object.assign(e,{xAxisData:s,data:a})}function Wr(t,e){e.onBeforeValue||(e.onBeforeValue=Vr);let i=e.calculative.canvas.store.data.scale;const n=e.calculative.worldRect.x,o=e.calculative.worldRect.y,s=e.calculative.worldRect.width,a=e.calculative.worldRect.height,r=!!e.echarts;e.echarts?(e.echarts.option.color||(e.echarts.option.color=["#1890ff","#2FC25B","#FACC14","#c23531","#2f4554","#61a0a8","#d48265"]),e.chartsColor=e.echarts.option.color):e.chartsColor||(e.chartsColor=["#1890ff","#2FC25B","#FACC14","#c23531","#2f4554","#61a0a8","#d48265"]);const l=r?e.echarts.option.series:e.data;let c=0;for(let h=0;h<l.length;h++){let d=l[h],u=s/2;a<s&&(u=a/2);const f=n+s/2,p=o+a/2;let v=0;v=r?d.data.reduce((t,e)=>t+e.value,0):d.reduce((t,e)=>t+e.value,0);const g=u*parseFloat(r?d.radius[0]:e.chartsRadius[h][0])/100,y=u*parseFloat(r?d.radius[1]:e.chartsRadius[h][1])/100;if(g>y)return;let m=0,w=0;t.strokeStyle=r&&d.itemStyle?.borderColor||"#fff",t.lineWidth=(r&&d.itemStyle?.borderWidth||2)*i;const x=r?d.data:d;x.forEach((n,o)=>{w+=2*Math.PI*n.value/v,t.beginPath();let s=c+o;s>=e.chartsColor.length&&(s%=e.chartsColor.length),t.fillStyle=r?e.echarts.option.color[s]:e.chartsColor[s],t.moveTo(f+g*Math.sin(w),p-g*Math.cos(w)),t.arc(f,p,g,-Math.PI/2+w,-Math.PI/2+m,!0),t.lineTo(f+y*Math.sin(m),p-y*Math.cos(m)),t.arc(f,p,y,-Math.PI/2+m,-Math.PI/2+w),t.lineTo(f+g*Math.sin(w),p-g*Math.cos(w)),t.stroke(),t.fill(),t.closePath();let a=(m+w)/2,l=f+(y+10*i)*Math.sin(a),h=p-(y+10*i)*Math.cos(a),u=t.fillStyle;d.label||(d.label={position:"outside",show:!0}),r&&["inner","inside"].includes(d.label.position)?(t.fillStyle="#ffffff",l=f+(y-g)/2*Math.sin(a),h=p-(y-g)/2*Math.cos(a)):r&&d.label.position,d.labelLine||(d.labelLine={show:!0}),(r&&!1!==d.labelLine.show||!r)&&(t.beginPath(),t.strokeStyle=r?e.echarts.option.color[c+o]:e.chartsColor[c+o],t.moveTo(f+y*Math.sin(a),p-y*Math.cos(a)),t.lineTo(l,h));let x={fontStyle:e.tickLabel?.fontStyle||e.calculative.fontStyle,fontWeight:e.tickLabel?.fontWeight||e.calculative.fontWeight,fontFamily:e.tickLabel?.fontFamily||e.calculative.fontFamily,lineHeight:e.tickLabel?.lineHeight||e.calculative.lineHeight,fontSize:(e.tickLabel?.fontSize||e.calculative.fontSize)*i};t.font=ue(x),t.textBaseline="middle",t.textAlign="center",a>Math.PI?((r&&"outside"===d.label.position||!r)&&(t.textAlign="end"),(r&&!1!==d.labelLine.show||!r&&(e.tickLabel?.labelLine?.show??1))&&t.lineTo(l-5*i,h),(r&&!1!==d.label.show||!r&&(e.tickLabel?.show??1))&&t.fillText(n.name,l-5*i,h)):((r&&"outside"===d.label.position||!r)&&(t.textAlign="start"),(r&&!1!==d.labelLine.show||!r)&&t.lineTo(l+5*i,h),(r&&!1!==d.label.show||!r&&(e.tickLabel?.show??1))&&t.fillText(n.name,l+5*i,h)),t.stroke(),t.closePath(),t.fillStyle=u,t.strokeStyle=r&&d.itemStyle?.borderColor||"#fff",m=w}),c+=x.length}}function Vr(t,e){if(e.data||!e.dataX&&!e.dataY)return e;const i=t.data,n=t.replaceMode;let o=[];return n?n===zr.Replace?(e.dataY.forEach((t,e)=>{t.forEach((t,n)=>{let o=i[e].filter(e=>e.name===t.name);o.length>0&&(o[0].value=t.value)})}),o=i):n===zr.ReplaceAll&&(o=e.dataY):i.forEach((t,i)=>{let n=[...t,...e.dataY[i]];o.push(n)}),delete e.dataX,delete e.dataY,Object.assign(e,{data:o})}function Ur(t,e){e.onBeforeValue||(e.onBeforeValue=Hr);let i=e.calculative.canvas.store.data.scale;const n=e.calculative.worldRect.x,o=e.calculative.worldRect.y,s=(e.calculative.worldRect.width,e.calculative.worldRect.height);let a=[];if(e.echarts&&!e.echarts.option.color&&(e.echarts.option.color=["#1890ff","#2FC25B","#FACC14","#c23531","#2f4554","#61a0a8","#d48265"]),e.echarts)for(let t=0;t<e.echarts.option.series.length;t++)a.push(e.echarts.option.series[t].data);else a=e.data;let r=Nr(t,e),l=r.dash,c=r.normalizedOption,h=4*l/5/a.length;for(let r=0;r<a.length;r++){t.beginPath();let d=a[r];t.fillStyle=e.echarts?e.echarts.option.color[r]:e.chartsColor[r],t.strokeStyle="#ffffff",t.lineWidth=1*i;let u=0,f=0,p=0;for(let e=0;e<d.length;e++)u=n+(1+.1*l)+(l+1)*e+h*r,p=(d[e]-c.min)/(c.max-c.min)*s,f=o+s-p,t.rect(u,f,h-1,p-1),t.stroke(),t.fill();t.closePath()}}function qr(t,e){e.onAdd||(e.onAdd=$r,e.onDestroy=Kr,e.onClick=Yr,e.clockInterval&&(e.onDestroy(e),e.onAdd(e)));const i=e.calculative.worldRect.x,n=e.calculative.worldRect.y,o=e.calculative.worldRect.width,s=e.calculative.worldRect.height;let a=e.calculative.canvas.store.data.scale,r={startAngle:225,endAngle:-45,min:0,max:100,splitNumber:10};if(e.echarts&&e.echarts.option){let t=e.echarts.option.series[0];e.startAngle=t.startAngle||r.startAngle,e.endAngle=t.endAngle||r.endAngle,e.min=t.min||r.min,e.max=t.max||r.max,e.axisLine=t.axisLine.lineStyle.color,e.unit=t.detail.formatter.replace("{value}",""),e.value=t.data[0].value,e.splitNumber=t.splitNumber||r.splitNumber}let l,c=o>s?s/2*9/10:o/2*9/10,h=i+o/2,d=n+s/2,u=(e={...r,...e}).echarts?e.echarts.option.series[0].data[0].value:e.value,f=e.startAngle-e.endAngle,p=e.background||"#E6EBF8";t.strokeStyle=p;let v=c/10;t.lineWidth=v,t.beginPath(),t.lineCap="round",t.arc(h,d,c,-e.startAngle/180*Math.PI,-e.endAngle/180*Math.PI),t.stroke(),t.closePath();let g=0;if(e.axisLine&&!e.isClock)for(let i=e.axisLine.length-1;i>=0;i--)e.axisLine[i][0]*(e.max-e.min)<u?g=e.axisLine[i][0]:(g=(u-e.min)/(e.max-e.min),l=e.axisLine[i][1]),t.beginPath(),t.strokeStyle=e.axisLine[i][1],t.arc(h,d,c,-e.startAngle/180*Math.PI,(-e.startAngle+g*f)/180*Math.PI),t.stroke(),t.closePath();t.lineCap="butt";let y=2*a,m=c-v;m<0&&(m=0);let w=f/180*Math.PI*m,x=(w-y*e.splitNumber)/e.splitNumber,b=f/180*Math.PI*y/2/w;t.beginPath(),t.strokeStyle=e.color||"#999999",t.lineWidth=c/20,t.setLineDash([y,x]),t.arc(h,d,m,-e.startAngle/180*Math.PI-b,-e.endAngle/180*Math.PI+b),t.stroke(),t.closePath();let k=1*a,T=c-v;T<0&&(T=0);let C=f/180*Math.PI*T,A=(C-5*k*e.splitNumber)/5/e.splitNumber,R=f/180*Math.PI*k/2/C;t.beginPath(),t.strokeStyle=e.color||"#999999",t.lineWidth=c/40,t.setLineDash([k,A]),t.arc(h,d,T,-e.startAngle/180*Math.PI-R,-e.endAngle/180*Math.PI+R),t.stroke(),t.closePath(),t.beginPath();let S=e.max-e.min,P=S/e.splitNumber,I={fontStyle:e.tickLabel?.fontStyle||e.calculative.fontStyle,textDecoration:e.tickLabel?.textDecoration||e.textDecoration,fontWeight:e.tickLabel?.fontWeight||e.calculative.fontWeight,fontFamily:e.tickLabel?.fontFamily||e.calculative.fontFamily,fontSize:(e.tickLabel?.fontSize||e.calculative.fontSize)*a,lineHeight:e.tickLabel?.lineHeight||e.calculative.lineHeight};t.font=ue(I);let E=c-v-c/20;for(let i=0;i<=e.splitNumber;i++){if(Math.abs(e.startAngle)+Math.abs(e.endAngle)===360&&0==i)continue;let n=e.startAngle-P*i/S*f,o=Math.cos(n/180*Math.PI),s=Math.sin(n/180*Math.PI);t.fillStyle=e.tickLabel?.color||"#999999",t.textAlign=o>.02?"end":o<-.02?"start":"center",t.textBaseline=s>.02?"top":s<-.02?"bottom":"middle",t.fillText(Fr(P*i+e.min,1),h+E*o,d-E*s),t.fill()}t.closePath();let _=1,M=["value"];if(e.isClock&&(_=3,M=["hourvalue","minutevalue","secondvalue"]),e.isClock)for(let i=0;i<_;i++){let n=(e.startAngle-(e[M[i]]-e.min)/(e.max-e.min)*f)/180*Math.PI;i>0&&(n=(e.startAngle-(e[M[i]]-e.min)/(5*e.max-e.min)*f)/180*Math.PI);let o=.8*c;"hourvalue"===M[i]&&(o=.6*c),"minutevalue"===M[i]&&(o=.7*c);let s=1*c/40;t.beginPath(),t.setLineDash([]),t.lineWidth=c/(i+1)/20,t.strokeStyle=e.color||"#999999",t.moveTo(h-3*s*Math.cos(n),d+3*s*Math.sin(n)),t.lineTo(h+o*Math.cos(n),d-o*Math.sin(n)),t.stroke()}else{let i=(e.startAngle-(u-e.min)/(e.max-e.min)*f)/180*Math.PI,n=.8*c,o=1*c/40;t.beginPath(),t.setLineDash([]),t.lineWidth=2,t.fillStyle=l,t.moveTo(h-3*o*Math.cos(i),d+3*o*Math.sin(i)),t.lineTo(h+o*Math.cos(i-Math.PI/2),d-o*Math.sin(i-Math.PI/2)),t.lineTo(h+n*Math.cos(i),d-n*Math.sin(i)),t.lineTo(h+o*Math.cos(i+Math.PI/2),d-o*Math.sin(i+Math.PI/2)),t.lineTo(h-3*o*Math.cos(i),d+3*o*Math.sin(i)),t.fill()}t.beginPath(),t.textAlign="center",t.textBaseline="middle";let L={fontStyle:e.titleLabel?.fontStyle||e.calculative.fontStyle,textDecoration:e.titleLabel?.textDecoration||e.textDecoration,fontWeight:e.titleLabel?.fontWeight||e.calculative.fontWeight,fontFamily:e.titleLabel?.fontFamily||e.calculative.fontFamily,fontSize:(e.titleLabel?.fontSize||e.calculative.fontSize)*a,lineHeight:e.titleLabel?.lineHeight||e.calculative.lineHeight};t.font=ue(L),t.fillStyle=e.titleLabel?.color||l,e.isClock?t.fillText(("0"+parseInt(e.hourvalue)).slice(-2)+":"+("0"+parseInt(e.minutevalue)).slice(-2)+":"+("0"+parseInt(e.secondvalue)).slice(-2),h,d+c/2):t.fillText(u+" "+(e.unit||""),h,d+c/2),t.fill(),e.isClock&&(t.beginPath(),t.fillStyle=e.color||"#999999",t.strokeStyle="#ffffff",t.arc(h,d,c/20,0,2*Math.PI),t.stroke(),t.fill(),t.closePath())}function $r(t){if(t.isClock)t.clockInterval=setInterval(()=>{let e=new Date,i=e.getSeconds(),n=e.getMinutes()+i/60,o=e.getHours()%12+n/60;t.calculative.canvas.parent.setValue({id:t.id,hourvalue:o,minutevalue:n,secondvalue:i},{render:!0,doEvent:!1})},1e3);else{const e=t.value;t.value=0,t.frames=[{duration:2e3,value:e}],t.calculative.canvas.parent.startAnimate(t.id),setTimeout(()=>{t.value=e},1e3)}}function Kr(t){t.clockInterval&&(clearInterval(t.clockInterval),t.clockInterval=void 0)}function Yr(t){t.isClock&&(t.onDestroy(t),t.onAdd(t))}function Xr(){return{lineChart:jr,histogram:Ur,pieChart:Wr,gauge:qr}}!function(t){t[t.Add=0]="Add",t[t.Replace=1]="Replace",t[t.ReplaceAll=2]="ReplaceAll"}(zr||(zr={})),globalThis.Meta2d=fs,globalThis.registerCommonDiagram=function(){const t=globalThis.meta2d;t&&(xa(),ba(),ka(),t.register($s()),t.registerAnchors(Ks()),t.register(Ps()),t.registerCanvasDraw(Is()),t.register(xs()),t.register(Ts()),t.registerCanvasDraw(Cs()),t.registerCanvasDraw(dr()),t.registerCanvasDraw(Xr()),t.register(_r()),t.registerCanvasDraw(Mr()),t.registerAnchors(Lr()))}})(),n})());