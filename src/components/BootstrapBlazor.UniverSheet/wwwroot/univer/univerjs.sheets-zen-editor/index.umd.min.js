(function(d,o){typeof exports=="object"&&typeof module<"u"?o(exports,require("@univerjs/core"),require("@univerjs/docs-ui"),require("@univerjs/engine-render"),require("@univerjs/sheets-ui"),require("@univerjs/ui"),require("react/jsx-runtime"),require("@univerjs/design"),require("react"),require("rxjs"),require("@univerjs/sheets")):typeof define=="function"&&define.amd?define(["exports","@univerjs/core","@univerjs/docs-ui","@univerjs/engine-render","@univerjs/sheets-ui","@univerjs/ui","react/jsx-runtime","@univerjs/design","react","rxjs","@univerjs/sheets"],o):(d=typeof globalThis<"u"?globalThis:d||self,o(d.UniverSheetsZenEditor={},d.UniverCore,d.UniverDocsUi,d.UniverEngineRender,d.UniverSheetsUi,d.UniverUi,d.React,d.UniverDesign,d.React,d.rxjs,d.UniverSheets))})(this,function(d,o,g,B,I,l,m,A,_,y,T){"use strict";var _e=Object.defineProperty;var Ie=(d,o,g)=>o in d?_e(d,o,{enumerable:!0,configurable:!0,writable:!0,value:g}):d[o]=g;var N=(d,o,g)=>Ie(d,typeof o!="symbol"?o+"":o,g);var P;const D={id:"zen-editor.command.open-zen-editor",type:o.CommandType.COMMAND,handler:async e=>{var j;const n=e.get(l.IZenZoneService),i=e.get(g.IEditorService),t=e.get(I.IEditorBridgeService),r=e.get(o.IUniverInstanceService),s=e.get(l.ISidebarService);s.visible&&(s.close(),await o.delayAnimationFrame()),n.open();const a=i.getEditor(o.DOCS_ZEN_EDITOR_UNIT_ID_KEY);if(a==null)return!1;const c=t.getLatestEditCellState();if(c==null)return!1;const u=(j=c.documentLayoutObject.documentModel)==null?void 0:j.getSnapshot();if(u==null)return!1;r.focusUnit(o.DOCS_ZEN_EDITOR_UNIT_ID_KEY);const{body:f,drawings:C,drawingsOrder:h,tableSource:S,settings:p}=o.Tools.deepClone(u),O={...a.getDocumentData(),body:f,drawings:C,drawingsOrder:h,tableSource:S,settings:p},E=[{startOffset:0,endOffset:0,collapsed:!0}];return a.focus(),a.setDocumentData(O,E),a.clearUndoRedoHistory(),!0}},b={id:"zen-editor.command.cancel-zen-edit",type:o.CommandType.COMMAND,handler:async e=>{const n=e.get(l.IZenZoneService),i=e.get(I.IEditorBridgeService),t=e.get(o.IUniverInstanceService),r=e.get(l.ISidebarService);r.visible&&(r.close(),await o.delayAnimationFrame()),n.close();const s=t.getCurrentUnitForType(o.UniverInstanceType.UNIVER_SHEET);return s?(t.focusUnit(s.getUnitId()),i.refreshEditCellState(),!0):!1}},M={id:"zen-editor.command.confirm-zen-edit",type:o.CommandType.COMMAND,handler:async e=>{var f;const n=e.get(l.IZenZoneService),i=e.get(I.IEditorBridgeService),t=e.get(o.IUniverInstanceService),r=e.get(g.IEditorService),s=e.get(l.ISidebarService);s.visible&&(s.close(),await o.delayAnimationFrame()),n.close();const a=r.getEditor(o.DOCS_ZEN_EDITOR_UNIT_ID_KEY);if(a==null)return!1;const c=e.get(B.IRenderManagerService),u=t.getCurrentUnitForType(o.UniverInstanceType.UNIVER_SHEET);if(u){const C=u.getUnitId(),h=(f=c.getRenderById(C))==null?void 0:f.with(I.EditingRenderController);if(h){const S=o.Tools.deepClone(a.getDocumentData());S.documentStyle.documentFlavor=o.DocumentFlavor.UNSPECIFIED,h.submitCellData(new o.DocumentDataModel(S))}return t.focusUnit(u.getUnitId()),i.refreshEditCellState(),!0}return!1}},q="sheets-zen-editor.config",L={};var v=function(){return v=Object.assign||function(e){for(var n,i=1,t=arguments.length;i<t;i++){n=arguments[i];for(var r in n)Object.prototype.hasOwnProperty.call(n,r)&&(e[r]=n[r])}return e},v.apply(this,arguments)},H=function(e,n){var i={};for(var t in e)Object.prototype.hasOwnProperty.call(e,t)&&n.indexOf(t)<0&&(i[t]=e[t]);if(e!=null&&typeof Object.getOwnPropertySymbols=="function")for(var r=0,t=Object.getOwnPropertySymbols(e);r<t.length;r++)n.indexOf(t[r])<0&&Object.prototype.propertyIsEnumerable.call(e,t[r])&&(i[t[r]]=e[t[r]]);return i},x=_.forwardRef(function(e,n){var i=e.icon,t=e.id,r=e.className,s=e.extend,a=H(e,["icon","id","className","extend"]),c="univerjs-icon univerjs-icon-".concat(t," ").concat(r||"").trim(),u=_.useRef("_".concat(J()));return F(i,"".concat(t),{defIds:i.defIds,idSuffix:u.current},v({ref:n,className:c},a),s)});function F(e,n,i,t,r){return _.createElement(e.tag,v(v({key:n},G(e,i,r)),t),(X(e,i).children||[]).map(function(s,a){return F(s,"".concat(n,"-").concat(e.tag,"-").concat(a),i,void 0,r)}))}function G(e,n,i){var t=v({},e.attrs);i!=null&&i.colorChannel1&&t.fill==="colorChannel1"&&(t.fill=i.colorChannel1),e.tag==="mask"&&t.id&&(t.id=t.id+n.idSuffix),Object.entries(t).forEach(function(s){var a=s[0],c=s[1];a==="mask"&&typeof c=="string"&&(t[a]=c.replace(/url\(#(.*)\)/,"url(#$1".concat(n.idSuffix,")")))});var r=n.defIds;return!r||r.length===0||(e.tag==="use"&&t["xlink:href"]&&(t["xlink:href"]=t["xlink:href"]+n.idSuffix),Object.entries(t).forEach(function(s){var a=s[0],c=s[1];typeof c=="string"&&(t[a]=c.replace(/url\(#(.*)\)/,"url(#$1".concat(n.idSuffix,")")))})),t}function X(e,n){var i,t=n.defIds;return!t||t.length===0?e:e.tag==="defs"&&(!((i=e.children)===null||i===void 0)&&i.length)?v(v({},e),{children:e.children.map(function(r){return typeof r.attrs.id=="string"&&t&&t.includes(r.attrs.id)?v(v({},r),{attrs:v(v({},r.attrs),{id:r.attrs.id+n.idSuffix})}):r})}):e}function J(){return Math.random().toString(36).substring(2,8)}x.displayName="UniverIcon";var Q={tag:"svg",attrs:{xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 16 16",width:"1em",height:"1em"},children:[{tag:"path",attrs:{fill:"currentColor",d:"M14.1544 3.75557C14.3887 3.98988 14.3887 4.36978 14.1544 4.6041L6.51409 12.2444C6.40157 12.3569 6.24896 12.4201 6.08983 12.4201C5.9307 12.4201 5.77808 12.3569 5.66556 12.2444L1.84541 8.42425C1.6111 8.18993 1.6111 7.81003 1.84541 7.57572C2.07973 7.34141 2.45963 7.34141 2.69394 7.57572L6.08983 10.9716L13.3059 3.75557C13.5402 3.52126 13.9201 3.52126 14.1544 3.75557Z",fillRule:"evenodd",clipRule:"evenodd"}}]},$=_.forwardRef(function(e,n){return _.createElement(x,Object.assign({},e,{id:"check-mark-icon",ref:n,icon:Q}))});$.displayName="CheckMarkIcon";var ee={tag:"svg",attrs:{xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 16 16",width:"1em",height:"1em"},children:[{tag:"path",attrs:{fill:"currentColor",d:"M3.71274 2.86421C3.47843 2.6299 3.09853 2.6299 2.86421 2.86421C2.6299 3.09853 2.6299 3.47843 2.86421 3.71274L7.15154 8.00007L2.86421 12.2874C2.6299 12.5217 2.6299 12.9016 2.86421 13.1359C3.09853 13.3702 3.47843 13.3702 3.71274 13.1359L8.00007 8.84859L12.2874 13.1359C12.5217 13.3702 12.9016 13.3702 13.1359 13.1359C13.3702 12.9016 13.3702 12.5217 13.1359 12.2874L8.84859 8.00007L13.1359 3.71274C13.3702 3.47843 13.3702 3.09853 13.1359 2.86421C12.9016 2.6299 12.5217 2.6299 12.2874 2.86421L8.00007 7.15154L3.71274 2.86421Z"}}]},V=_.forwardRef(function(e,n){return _.createElement(x,Object.assign({},e,{id:"close-icon",ref:n,icon:ee}))});V.displayName="CloseIcon";class te{constructor(){N(this,"_position",null);N(this,"_position$",new y.BehaviorSubject(null));N(this,"position$",this._position$.asObservable())}dispose(){this._position$.complete(),this._position=null}setPosition(n){this._position=n,this._refresh(n)}getPosition(){return this._position}_refresh(n){this._position$.next(n)}}const z=o.createIdentifier("univer.sheet-zen-editor-manager.service"),ne="ZEN_EDITOR_PLUGIN_ZEN_EDITOR_COMPONENT",ie={id:o.DOCS_ZEN_EDITOR_UNIT_ID_KEY,body:{dataStream:`${o.DEFAULT_EMPTY_DOCUMENT_VALUE}`,textRuns:[],tables:[],customBlocks:[],paragraphs:[{startIndex:0}],sectionBreaks:[{startIndex:1}]},tableSource:{},documentStyle:{pageSize:{width:595,height:Number.POSITIVE_INFINITY},documentFlavor:o.DocumentFlavor.MODERN,marginTop:0,marginBottom:0,marginRight:0,marginLeft:0,renderConfig:{vertexAngle:0,centerAngle:0}},drawings:{},drawingsOrder:[]};function re(){const e=_.useRef(null),n=l.useDependency(z),i=l.useDependency(g.IEditorService),t=l.useDependency(o.ICommandService);_.useEffect(()=>{const c=e.current;if(!c)return;const u=i.register({editorUnitId:o.DOCS_ZEN_EDITOR_UNIT_ID_KEY,initialSnapshot:ie,scrollBar:!0,backScrollOffset:100},c),f=new ResizeObserver(()=>{n.setPosition(c.getBoundingClientRect())});return f.observe(c),()=>{u.dispose(),f.unobserve(c)}},[]);function r(){const c=i.getEditor(o.DOCS_ZEN_EDITOR_UNIT_ID_KEY);c==null||c.blur(),t.executeCommand(b.id)}function s(){const c=i.getEditor(o.DOCS_ZEN_EDITOR_UNIT_ID_KEY);c==null||c.blur(),t.executeCommand(M.id)}const a="univer-flex univer-w-7 univer-cursor-pointer univer-items-center univer-justify-center univer-transition-colors";return m.jsxs("div",{className:"univer-absolute univer-inset-0 univer-size-full univer-bg-white",children:[m.jsxs("div",{className:"univer-absolute univer-right-6 univer-top-2 univer-z-10 univer-flex univer-items-center univer-justify-center",children:[m.jsx("span",{className:A.clsx(a,`
                      univer-text-red-500
                      hover:univer-text-red-600
                    `),onClick:r,children:m.jsx(V,{className:"univer-size-5"})}),m.jsx("span",{className:A.clsx(a,`
                      univer-text-green-500
                      hover:univer-text-green-600
                    `),onClick:s,children:m.jsx($,{className:"univer-size-5"})})]}),m.jsx("div",{ref:e,className:"univer-absolute univer-inset-0 univer-size-full"})]})}function oe(e){const n=e.get(I.IEditorBridgeService);return{id:D.id,type:l.MenuItemType.BUTTON,title:"rightClick.zenEditor",icon:"AmplifyIcon",hidden$:I.getCurrentExclusiveRangeInterest$(e),disabled$:n.currentEditCell$.pipe(y.switchMap(i=>I.getCurrentRangeDisable$(e,{workbookTypes:[T.WorkbookEditablePermission],worksheetTypes:[T.WorksheetEditPermission,T.WorksheetSetCellValuePermission,T.WorksheetSetCellStylePermission],rangeTypes:[T.RangeProtectionPermissionEditPoint]}).pipe(y.map(t=>{var r,s,a,c;return t||((c=(a=(s=(r=i==null?void 0:i.documentLayoutObject.documentModel)==null?void 0:r.getBody())==null?void 0:s.customBlocks)==null?void 0:a.length)!=null?c:0)>0}))))}}const se={[l.ContextMenuPosition.MAIN_AREA]:{[l.ContextMenuGroup.OTHERS]:{[D.id]:{order:2,menuItemFactory:oe}}}},ae={id:M.id,description:"shortcut.sheet.zen-edit-confirm",group:"4_sheet-edit",preconditions:e=>Y(e),binding:l.KeyCode.ENTER|l.MetaKeys.ALT},ce={id:b.id,description:"shortcut.sheet.zen-edit-cancel",group:"4_sheet-edit",preconditions:e=>Y(e),binding:l.KeyCode.ESC};function Y(e){return e.getContextValue(o.FOCUSING_DOC)&&e.getContextValue(o.FOCUSING_UNIVER_EDITOR)&&e.getContextValue(o.EDITOR_ACTIVATED)&&!e.getContextValue(o.FOCUSING_EDITOR_STANDALONE)}var de=Object.getOwnPropertyDescriptor,le=(e,n,i,t)=>{for(var r=t>1?void 0:t?de(n,i):n,s=e.length-1,a;s>=0;s--)(a=e[s])&&(r=a(r)||r);return r},R=(e,n)=>(i,t)=>n(i,t,e);let w=class extends o.Disposable{constructor(e,n,i,t){super(),this._zenZoneService=e,this._commandService=n,this._menuManagerService=i,this._shortcutService=t,this._initialize()}_initialize(){this._initCustomComponents(),this._initCommands(),this._initMenus(),this._initShortcuts()}_initCustomComponents(){this.disposeWithMe(this._zenZoneService.set(ne,re))}_initCommands(){[D,b,M].forEach(e=>{this.disposeWithMe(this._commandService.registerCommand(e))})}_initMenus(){this._menuManagerService.mergeMenu(se)}_initShortcuts(){[ae,ce].forEach(e=>{this.disposeWithMe(this._shortcutService.registerShortcut(e))})}};w=le([R(0,l.IZenZoneService),R(1,o.ICommandService),R(2,l.IMenuManagerService),R(3,l.IShortcutService)],w);var ue=Object.getOwnPropertyDescriptor,ve=(e,n,i,t)=>{for(var r=t>1?void 0:t?ue(n,i):n,s=e.length-1,a;s>=0;s--)(a=e[s])&&(r=a(r)||r);return r},K=(e,n)=>(i,t)=>n(i,t,e);let Z=class extends o.RxDisposable{constructor(e,n){super(),this._zenEditorManagerService=e,this._renderManagerService=n,this._initialize()}_initialize(){this._syncZenEditorSize()}_syncZenEditorSize(){this._zenEditorManagerService.position$.pipe(y.takeUntil(this.dispose$)).subscribe(e=>{if(e==null)return;const{width:n,height:i}=e,t=I.getEditorObject(o.DOCS_ZEN_EDITOR_UNIT_ID_KEY,this._renderManagerService);t!=null&&requestIdleCallback(()=>{t.engine.resizeBySize(n,i),this._calculatePagePosition(t),this._scrollToTop()})})}_calculatePagePosition(e){const{document:n,scene:i,docBackground:t}=e,r=i==null?void 0:i.getParent(),{width:s,height:a,pageMarginLeft:c,pageMarginTop:u}=n;if(r==null||s===Number.POSITIVE_INFINITY||a===Number.POSITIVE_INFINITY)return;const{width:f,height:C}=r;let h=0;const S=u;let p=0,U=0,O=Number.POSITIVE_INFINITY;const{scaleX:E,scaleY:j}=i.getAncestorScale();f>(s+c*2)*E?(h=f/2-s*E/2,h/=E,p=(f-c*2)/E,O=0):(h=c,p=s+c*2,O=(p-f/E)/2),C>a?U=(C-u*2)/j:U=a+u*2,i.resize(p,U),n.translate(h,S),t.translate(h,S);const k=i.getViewport(g.VIEWPORT_KEY.VIEW_MAIN);if(O!==Number.POSITIVE_INFINITY&&k!=null){const he=k.transScroll2ViewportScrollValue(O,0).x;k.scrollToBarPos({x:he})}return this}_scrollToTop(){var i;const e=(i=this._renderManagerService.getRenderById(o.DOCS_ZEN_EDITOR_UNIT_ID_KEY))==null?void 0:i.with(g.DocBackScrollRenderController),n={startOffset:0,endOffset:0};e&&e.scrollToRange(n)}};Z=ve([K(0,z),K(1,B.IRenderManagerService)],Z);var fe=Object.getOwnPropertyDescriptor,ge=(e,n,i,t)=>{for(var r=t>1?void 0:t?fe(n,i):n,s=e.length-1,a;s>=0;s--)(a=e[s])&&(r=a(r)||r);return r},W=(e,n)=>(i,t)=>n(i,t,e);d.UniverSheetsZenEditorPlugin=(P=class extends o.Plugin{constructor(n=L,i,t){super(),this._config=n,this._injector=i,this._configService=t;const{menu:r,...s}=o.merge({},L,this._config);r&&this._configService.setConfig("menu",r,{merge:!0}),this._configService.setConfig(q,s),this._initializeDependencies(this._injector)}_initializeDependencies(n){[[w],[Z],[z,{useClass:te}]].forEach(t=>n.add(t))}onReady(){this._injector.get(w)}onSteady(){this._injector.get(Z)}},N(P,"pluginName","SHEET_ZEN_EDITOR_PLUGIN"),N(P,"type",o.UniverInstanceType.UNIVER_SHEET),P),d.UniverSheetsZenEditorPlugin=ge([W(1,o.Inject(o.Injector)),W(2,o.IConfigService)],d.UniverSheetsZenEditorPlugin),d.CancelZenEditCommand=b,d.ConfirmZenEditCommand=M,d.OpenZenEditorCommand=D,Object.defineProperty(d,Symbol.toStringTag,{value:"Module"})});
