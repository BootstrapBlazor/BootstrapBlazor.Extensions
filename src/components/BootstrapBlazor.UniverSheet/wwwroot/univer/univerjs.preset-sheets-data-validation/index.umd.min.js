// @univerjs/data-validation/index
(function(l,r){typeof exports=="object"&&typeof module<"u"?r(exports,require("@univerjs/core"),require("rxjs")):typeof define=="function"&&define.amd?define(["exports","@univerjs/core","rxjs"],r):(l=typeof globalThis<"u"?globalThis:l||self,r(l.UniverDataValidation={},l.UniverCore,l.rxjs))})(this,function(l,r,g){"use strict";var na=Object.defineProperty;var oa=(l,r,g)=>r in l?na(l,r,{enumerable:!0,configurable:!0,writable:!0,value:g}):l[r]=g;var c=(l,r,g)=>oa(l,typeof r!="symbol"?r+"":r,g);var T;function D(n){return{type:n.type,operator:n.operator,formula1:n.formula1,formula2:n.formula2,allowBlank:n.allowBlank}}function N(n){return{error:n.error,errorStyle:n.errorStyle,errorTitle:n.errorTitle,imeMode:n.imeMode,prompt:n.prompt,promptTitle:n.promptTitle,showDropDown:n.showDropDown,showErrorMessage:n.showErrorMessage,showInputMessage:n.showInputMessage,renderMode:n.renderMode,bizInfo:n.bizInfo}}var h=(n=>(n[n.SETTING=0]="SETTING",n[n.RANGE=1]="RANGE",n[n.OPTIONS=2]="OPTIONS",n[n.ALL=3]="ALL",n))(h||{}),w=Object.getOwnPropertyDescriptor,b=(n,a,i,e)=>{for(var t=e>1?void 0:e?w(a,i):a,o=n.length-1,d;o>=0;o--)(d=n[o])&&(t=d(t)||t);return t},B=(n,a)=>(i,e)=>a(i,e,n);l.DataValidationModel=class extends r.Disposable{constructor(i){super();c(this,"_model",new Map);c(this,"_ruleChange$",new g.Subject);c(this,"ruleChange$",this._ruleChange$.asObservable());c(this,"ruleChangeDebounce$",this.ruleChange$.pipe(g.debounceTime(20)));this._logService=i,this.disposeWithMe({dispose:()=>{this._ruleChange$.complete()}})}_ensureMap(i,e){this._model.has(i)||this._model.set(i,new Map);const t=this._model.get(i);if(t.has(e))return t.get(e);const o={map:new Map,list:[]};return t.set(e,o),o}_addSubUnitRule(i,e,t){const{map:o,list:d}=i,p=(Array.isArray(e)?e:[e]).filter(u=>!o.has(u.uid));typeof t=="number"&&t<d.length?d.splice(t,0,...p):d.push(...p),p.forEach(u=>{o.set(u.uid,u)})}_removeSubUnitRule(i,e){const{map:t,list:o}=i,d=o.findIndex(s=>s.uid===e);d>-1&&(o.splice(d,1),t.delete(e))}_updateSubUnitRule(i,e,t){const{map:o,list:d}=i,s=o.get(e),p=d.findIndex(m=>e===m.uid);if(!s)throw new Error(`Data validation rule is not found, ruleId: ${e}.`);const u={...s};switch(t.type){case h.RANGE:{u.ranges=t.payload;break}case h.SETTING:{Object.assign(u,D(t.payload));break}case h.OPTIONS:{Object.assign(u,N(t.payload));break}case h.ALL:{Object.assign(u,t.payload);break}}return d[p]=u,o.set(e,u),u}_addRuleSideEffect(i,e,t,o){if(!this._ensureMap(i,e).map.get(t.uid))return{rule:t,type:"add",unitId:i,subUnitId:e,source:o}}addRule(i,e,t,o,d){try{const s=this._ensureMap(i,e),u=(Array.isArray(t)?t:[t]).map(m=>this._addRuleSideEffect(i,e,m,o));this._addSubUnitRule(s,t,d),u.forEach(m=>{m&&this._ruleChange$.next(m)})}catch(s){this._logService.error(s)}}updateRule(i,e,t,o,d){try{const s=this._ensureMap(i,e),p=r.Tools.deepClone(s.map.get(t));if(!p)throw new Error(`Data validation rule is not found, ruleId: ${t}.`);const u=this._updateSubUnitRule(s,t,o);this._ruleChange$.next({rule:u,type:"update",unitId:i,subUnitId:e,source:d,updatePayload:o,oldRule:p})}catch(s){this._logService.error(s)}}removeRule(i,e,t,o){try{const d=this._ensureMap(i,e),s=d.map.get(t);s&&(this._removeSubUnitRule(d,t),this._ruleChange$.next({rule:s,type:"remove",unitId:i,subUnitId:e,source:o}))}catch(d){this._logService.error(d)}}getRuleById(i,e,t){return this._ensureMap(i,e).map.get(t)}getRuleIndex(i,e,t){return this._ensureMap(i,e).list.findIndex(d=>d.uid===t)}getRules(i,e){return[...this._ensureMap(i,e).list]}getUnitRules(i){const e=this._model.get(i);if(!e)return[];const t=[];return e.forEach((o,d)=>{t.push([d,o.list])}),t}deleteUnitRules(i){this._model.delete(i)}getSubUnitIds(i){var e,t;return Array.from((t=(e=this._model.get(i))==null?void 0:e.keys())!=null?t:[])}getAll(){return Array.from(this._model.keys()).map(i=>[i,this.getUnitRules(i)])}},l.DataValidationModel=b([B(0,r.ILogService)],l.DataValidationModel);var P=Object.getOwnPropertyDescriptor,q=(n,a,i,e)=>{for(var t=e>1?void 0:e?P(a,i):a,o=n.length-1,d;o>=0;o--)(d=n[o])&&(t=d(t)||t);return t},M=(n,a)=>(i,e)=>a(i,e,n);const G="SHEET_DATA_VALIDATION_PLUGIN";l.DataValidationResourceController=class extends r.Disposable{constructor(a,i,e){super(),this._resourceManagerService=a,this._univerInstanceService=i,this._dataValidationModel=e,this._initSnapshot()}_initSnapshot(){const a=e=>{const t=this._dataValidationModel.getUnitRules(e),o={};return t?(t.forEach(([d,s])=>{o[d]=s}),JSON.stringify(o)):""},i=e=>{if(!e)return{};try{return JSON.parse(e)}catch{return{}}};this.disposeWithMe(this._resourceManagerService.registerPluginResource({pluginName:G,businesses:[r.UniverInstanceType.UNIVER_SHEET],toJson:e=>a(e),parseJson:e=>i(e),onUnLoad:e=>{this._dataValidationModel.deleteUnitRules(e)},onLoad:(e,t)=>{Object.keys(t).forEach(o=>{t[o].forEach(s=>{this._dataValidationModel.addRule(e,o,s,"patched")})})}}))}},l.DataValidationResourceController=q([M(0,r.IResourceManagerService),M(1,r.IUniverInstanceService),M(2,r.Inject(l.DataValidationModel))],l.DataValidationResourceController);var I=(n=>(n.SHEET="sheet",n))(I||{});class R{constructor(){c(this,"_validatorByScopes",new Map);c(this,"_validatorMap",new Map);c(this,"_validatorsChange$",new g.BehaviorSubject(void 0));c(this,"validatorsChange$",this._validatorsChange$.asObservable())}_addValidatorToScope(a,i){this._validatorByScopes.has(i)||this._validatorByScopes.set(i,[]);const e=this._validatorByScopes.get(i);if(e.findIndex(t=>t.id===a.id)>-1)throw new Error(`Validator item with the same id ${a.id} has already been added!`);e.push(a)}_removeValidatorFromScope(a,i){const e=this._validatorByScopes.get(i);if(!e)return;const t=e.findIndex(o=>o.id===a.id);t>-1&&e.splice(t,1)}register(a){return this._validatorMap.set(a.id,a),Array.isArray(a.scopes)?a.scopes.forEach(i=>{this._addValidatorToScope(a,i)}):this._addValidatorToScope(a,a.scopes),this._validatorsChange$.next(),r.toDisposable(()=>{this._validatorMap.delete(a.id),Array.isArray(a.scopes)?a.scopes.forEach(i=>{this._removeValidatorFromScope(a,i)}):this._removeValidatorFromScope(a,a.scopes),this._validatorsChange$.next()})}getValidatorItem(a){return this._validatorMap.get(a)}getValidatorsByScope(a){return this._validatorByScopes.get(a)}}const O={type:r.CommandType.MUTATION,id:"data-validation.mutation.addRule",handler(n,a){if(!a)return!1;const{unitId:i,subUnitId:e,rule:t,index:o,source:d="command"}=a;return n.get(l.DataValidationModel).addRule(i,e,t,d,o),!0}},v={type:r.CommandType.MUTATION,id:"data-validation.mutation.removeRule",handler(n,a){if(!a)return!1;const{unitId:i,subUnitId:e,ruleId:t,source:o="command"}=a,d=n.get(l.DataValidationModel);return Array.isArray(t)?t.forEach(s=>{d.removeRule(i,e,s,o)}):d.removeRule(i,e,t,o),!0}},_={type:r.CommandType.MUTATION,id:"data-validation.mutation.updateRule",handler(n,a){if(!a)return!1;const{unitId:i,subUnitId:e,ruleId:t,payload:o,source:d="command"}=a;return n.get(l.DataValidationModel).updateRule(i,e,t,o,d),!0}},j={type:r.CommandType.COMMAND,id:"data-validation.command.addRule",async handler(n,a){if(n.get(r.ILogService).error("[Deprecated]: `AddDataValidationCommand` is deprecated, please use `AddSheetDataValidationCommand` in `@univerjs/sheets-data-validation` instead!"),!a)return!1;const{rule:e,unitId:t,subUnitId:o}=a,d=n.get(r.ICommandService),s=n.get(r.IUndoRedoService),p={...a,rule:{...a.rule,ranges:[a.rule.range]}},u=[{id:O.id,params:p}],m=[{id:v.id,params:{unitId:t,subUnitId:o,ruleId:e.uid}}];return s.pushUndoRedo({unitID:t,redoMutations:u,undoMutations:m}),await d.executeCommand(O.id,p),!0}},$={type:r.CommandType.COMMAND,id:"data-validation.command.removeRule",handler(n,a){if(n.get(r.ILogService).error("[Deprecated]: `RemoveDataValidationCommand` is deprecated, please use `RemoveSheetDataValidationCommand` in `@univerjs/sheets-data-validation` instead!"),!a)return!1;const{unitId:e,subUnitId:t,ruleId:o}=a,d=n.get(r.ICommandService),s=n.get(r.IUndoRedoService),p=n.get(l.DataValidationModel),u=[{id:v.id,params:a}],m=[{id:O.id,params:{unitId:e,subUnitId:t,rule:{...p.getRuleById(e,t,o)},index:p.getRuleIndex(e,t,o)}}];return s.pushUndoRedo({undoMutations:m,redoMutations:u,unitID:a.unitId}),d.executeCommand(v.id,a),!0}},H={type:r.CommandType.COMMAND,id:"data-validation.command.updateDataValidationSetting",handler(n,a){if(n.get(r.ILogService).warn("[Deprecated]: `UpdateDataValidationOptionsCommand` is deprecated, please use `UpdateSheetDataValidationOptionsCommand` in `@univerjs/sheets-data-validation` instead!"),!a)return!1;const e=n.get(r.ICommandService),t=n.get(r.IUndoRedoService),o=n.get(l.DataValidationModel),{unitId:d,subUnitId:s,ruleId:p,options:u}=a,m=o.getRuleById(d,s,p);if(!m)return!1;const V={unitId:d,subUnitId:s,ruleId:p,payload:{type:h.OPTIONS,payload:u}},E=[{id:_.id,params:V}],f={unitId:d,subUnitId:s,ruleId:p,payload:{type:h.OPTIONS,payload:N(m)}},S=[{id:_.id,params:f}];return t.pushUndoRedo({unitID:d,redoMutations:E,undoMutations:S}),e.executeCommand(_.id,V),!0}},Q={type:r.CommandType.COMMAND,id:"data-validation.command.updateDataValidationOptions",handler(n,a){if(n.get(r.ILogService).error("[Deprecated]: `UpdateDataValidationSettingCommand` is deprecated, please use `UpdateSheetDataValidationSettingCommand` in `@univerjs/sheets-data-validation` instead!"),!a)return!1;const e=n.get(r.ICommandService),t=n.get(r.IUndoRedoService),o=n.get(l.DataValidationModel),d=n.get(R),{unitId:s,subUnitId:p,ruleId:u,setting:m}=a,V=d.getValidatorItem(m.type);if(!V)return!1;const E=o.getRuleById(s,p,u);if(!E)return!1;const f={...E,...m};if(!V.validatorFormula(f,s,p).success)return!1;const S={unitId:s,subUnitId:p,ruleId:u,payload:{type:h.SETTING,payload:{...m,...V.normalizeFormula(f,s,p)}}},ea=[{id:_.id,params:S}],ia={unitId:s,subUnitId:p,ruleId:u,payload:{type:h.SETTING,payload:D(E)}},ra=[{id:_.id,params:ia}];return t.pushUndoRedo({unitID:s,redoMutations:ea,undoMutations:ra}),e.executeCommand(_.id,S),!0}},F={type:r.CommandType.COMMAND,id:"data-validation.command.removeAll",handler(n,a){if(n.get(r.ILogService).error("[Deprecated]: `RemoveAllDataValidationCommand` is deprecated, please use `RemoveSheetAllDataValidationCommand` in `@univerjs/sheets-data-validation` instead!"),!a)return!1;const{unitId:e,subUnitId:t}=a,o=n.get(r.ICommandService),d=n.get(l.DataValidationModel),s=n.get(r.IUndoRedoService),p=[...d.getRules(e,t)],u={unitId:e,subUnitId:t,ruleId:p.map(E=>E.uid)},m=[{id:v.id,params:u}],V=[{id:O.id,params:{unitId:e,subUnitId:t,rule:p}}];return s.pushUndoRedo({redoMutations:m,undoMutations:V,unitID:e}),o.executeCommand(v.id,u),!0}},W="data-validation.config",y={};var k=Object.getOwnPropertyDescriptor,x=(n,a,i,e)=>{for(var t=e>1?void 0:e?k(a,i):a,o=n.length-1,d;o>=0;o--)(d=n[o])&&(t=d(t)||t);return t},A=(n,a)=>(i,e)=>a(i,e,n);const J="UNIVER_DATA_VALIDATION_PLUGIN";l.UniverDataValidationPlugin=(T=class extends r.Plugin{constructor(a=y,i,e,t){super(),this._config=a,this._injector=i,this._commandService=e,this._configService=t;const{...o}=r.merge({},y,this._config);this._configService.setConfig(W,o)}onStarting(){[[l.DataValidationModel],[R],[l.DataValidationResourceController]].forEach(a=>this._injector.add(a)),[j,F,H,Q,$,O,_,v].forEach(a=>{this._commandService.registerCommand(a)})}onReady(){this._injector.get(l.DataValidationResourceController)}},c(T,"pluginName",J),c(T,"type",r.UniverInstanceType.UNIVER_SHEET),T),l.UniverDataValidationPlugin=x([A(1,r.Inject(r.Injector)),A(2,r.ICommandService),A(3,r.IConfigService)],l.UniverDataValidationPlugin),r.DataValidationOperator.BETWEEN+"",r.DataValidationOperator.EQUAL+"",r.DataValidationOperator.GREATER_THAN+"",r.DataValidationOperator.GREATER_THAN_OR_EQUAL+"",r.DataValidationOperator.LESS_THAN+"",r.DataValidationOperator.LESS_THAN_OR_EQUAL+"",r.DataValidationOperator.NOT_BETWEEN+"",r.DataValidationOperator.NOT_EQUAL+"";const z={[r.DataValidationOperator.BETWEEN]:"dataValidation.ruleName.between",[r.DataValidationOperator.EQUAL]:"dataValidation.ruleName.equal",[r.DataValidationOperator.GREATER_THAN]:"dataValidation.ruleName.greaterThan",[r.DataValidationOperator.GREATER_THAN_OR_EQUAL]:"dataValidation.ruleName.greaterThanOrEqual",[r.DataValidationOperator.LESS_THAN]:"dataValidation.ruleName.lessThan",[r.DataValidationOperator.LESS_THAN_OR_EQUAL]:"dataValidation.ruleName.lessThanOrEqual",[r.DataValidationOperator.NOT_BETWEEN]:"dataValidation.ruleName.notBetween",[r.DataValidationOperator.NOT_EQUAL]:"dataValidation.ruleName.notEqual"},K={[r.DataValidationOperator.BETWEEN]:"dataValidation.errorMsg.between",[r.DataValidationOperator.EQUAL]:"dataValidation.errorMsg.equal",[r.DataValidationOperator.GREATER_THAN]:"dataValidation.errorMsg.greaterThan",[r.DataValidationOperator.GREATER_THAN_OR_EQUAL]:"dataValidation.errorMsg.greaterThanOrEqual",[r.DataValidationOperator.LESS_THAN]:"dataValidation.errorMsg.lessThan",[r.DataValidationOperator.LESS_THAN_OR_EQUAL]:"dataValidation.errorMsg.lessThanOrEqual",[r.DataValidationOperator.NOT_BETWEEN]:"dataValidation.errorMsg.notBetween",[r.DataValidationOperator.NOT_EQUAL]:"dataValidation.errorMsg.notEqual"},Y={[r.DataValidationOperator.BETWEEN]:"dataValidation.textLength.errorMsg.between",[r.DataValidationOperator.EQUAL]:"dataValidation.textLength.errorMsg.equal",[r.DataValidationOperator.GREATER_THAN]:"dataValidation.textLength.errorMsg.greaterThan",[r.DataValidationOperator.GREATER_THAN_OR_EQUAL]:"dataValidation.textLength.errorMsg.greaterThanOrEqual",[r.DataValidationOperator.LESS_THAN]:"dataValidation.textLength.errorMsg.lessThan",[r.DataValidationOperator.LESS_THAN_OR_EQUAL]:"dataValidation.textLength.errorMsg.lessThanOrEqual",[r.DataValidationOperator.NOT_BETWEEN]:"dataValidation.textLength.errorMsg.notBetween",[r.DataValidationOperator.NOT_EQUAL]:"dataValidation.textLength.errorMsg.notEqual"},X=[r.DataValidationOperator.BETWEEN,r.DataValidationOperator.NOT_BETWEEN];var Z=Object.getOwnPropertyDescriptor,aa=(n,a,i,e)=>{for(var t=e>1?void 0:e?Z(a,i):a,o=n.length-1,d;o>=0;o--)(d=n[o])&&(t=d(t)||t);return t},U=(n,a)=>(i,e)=>a(i,e,n);const L="{FORMULA1}",C="{FORMULA2}",ta={[r.DataValidationOperator.BETWEEN]:"dataValidation.operators.between",[r.DataValidationOperator.EQUAL]:"dataValidation.operators.equal",[r.DataValidationOperator.GREATER_THAN]:"dataValidation.operators.greaterThan",[r.DataValidationOperator.GREATER_THAN_OR_EQUAL]:"dataValidation.operators.greaterThanOrEqual",[r.DataValidationOperator.LESS_THAN]:"dataValidation.operators.lessThan",[r.DataValidationOperator.LESS_THAN_OR_EQUAL]:"dataValidation.operators.lessThanOrEqual",[r.DataValidationOperator.NOT_BETWEEN]:"dataValidation.operators.notBetween",[r.DataValidationOperator.NOT_EQUAL]:"dataValidation.operators.notEqual"};l.BaseDataValidator=class{constructor(a,i){c(this,"offsetFormulaByRange",!0);c(this,"formulaInput");c(this,"canvasRender",null);c(this,"dropdown");c(this,"optionsInput");c(this,"skipDefaultFontRender");this.localeService=a,this.injector=i}get operatorNames(){return this.operators.map(a=>this.localeService.t(ta[a]))}get titleStr(){return this.localeService.t(this.title)}generateRuleName(a){var e,t;if(!a.operator)return this.titleStr;const i=this.localeService.t(z[a.operator]).replace(L,(e=a.formula1)!=null?e:"").replace(C,(t=a.formula2)!=null?t:"");return`${this.titleStr} ${i}`}generateRuleErrorMessage(a,i){var t,o;return a.operator?`${this.localeService.t(K[a.operator]).replace(L,(t=a.formula1)!=null?t:"").replace(C,(o=a.formula2)!=null?o:"")}`:this.titleStr}getExtraStyle(a,i,e,t,o){}getRuleFinalError(a,i){return a.showErrorMessage&&a.error?a.error:this.generateRuleErrorMessage(a,i)}isEmptyCellValue(a){return a===""||a===void 0||a===null}normalizeFormula(a,i,e){return{formula1:a.formula1,formula2:a.formula2}}async isValidType(a,i,e){return!0}transform(a,i,e){return a}async validatorIsEqual(a,i,e){const{formula1:t}=i,{value:o}=a;return Number.isNaN(t)?!0:o===t}async validatorIsNotEqual(a,i,e){const{formula1:t}=i;return Number.isNaN(t)?!0:a.value!==t}async validatorIsBetween(a,i,e){const{formula1:t,formula2:o}=i;if(Number.isNaN(t)||Number.isNaN(o))return!0;const d=Math.min(t,o),s=Math.max(t,o);return a.value>=d&&a.value<=s}async validatorIsNotBetween(a,i,e){const{formula1:t,formula2:o}=i;if(Number.isNaN(t)||Number.isNaN(o))return!0;const d=Math.min(t,o),s=Math.max(t,o);return a.value<d||a.value>s}async validatorIsGreaterThan(a,i,e){const{formula1:t}=i;return Number.isNaN(t)?!0:a.value>t}async validatorIsGreaterThanOrEqual(a,i,e){const{formula1:t}=i;return Number.isNaN(t)?!0:a.value>=t}async validatorIsLessThan(a,i,e){const{formula1:t}=i;return Number.isNaN(t)?!0:a.value<t}async validatorIsLessThanOrEqual(a,i,e){const{formula1:t}=i;return Number.isNaN(t)?!0:a.value<=t}async validator(a,i){const{value:e,unitId:t,subUnitId:o}=a,d=this.isEmptyCellValue(e),{allowBlank:s=!0,operator:p}=i;if(d)return s;const u=await this.parseFormula(i,t,o,a.row,a.column);if(!u.isFormulaValid||!await this.isValidType(a,u,i))return!1;if(!r.Tools.isDefine(p))return!0;const m=this.transform(a,u,i);switch(p){case r.DataValidationOperator.BETWEEN:return this.validatorIsBetween(m,u,i);case r.DataValidationOperator.EQUAL:return this.validatorIsEqual(m,u,i);case r.DataValidationOperator.GREATER_THAN:return this.validatorIsGreaterThan(m,u,i);case r.DataValidationOperator.GREATER_THAN_OR_EQUAL:return this.validatorIsGreaterThanOrEqual(m,u,i);case r.DataValidationOperator.LESS_THAN:return this.validatorIsLessThan(m,u,i);case r.DataValidationOperator.LESS_THAN_OR_EQUAL:return this.validatorIsLessThanOrEqual(m,u,i);case r.DataValidationOperator.NOT_BETWEEN:return this.validatorIsNotBetween(m,u,i);case r.DataValidationOperator.NOT_EQUAL:return this.validatorIsNotEqual(m,u,i);default:throw new Error("Unknown operator.")}}},l.BaseDataValidator=aa([U(0,r.Inject(r.LocaleService)),U(1,r.Inject(r.Injector))],l.BaseDataValidator),l.AddDataValidationMutation=O,l.DataValidatorRegistryScope=I,l.DataValidatorRegistryService=R,l.RemoveDataValidationMutation=v,l.TWO_FORMULA_OPERATOR_COUNT=X,l.TextLengthErrorTitleMap=Y,l.UpdateDataValidationMutation=_,l.UpdateRuleType=h,l.getRuleOptions=N,l.getRuleSetting=D,Object.defineProperty(l,Symbol.toStringTag,{value:"Module"})});


// @univerjs/sheets-data-validation/index
(function(m,r){typeof exports=="object"&&typeof module<"u"?r(exports,require("@univerjs/core"),require("@univerjs/data-validation"),require("@univerjs/sheets"),require("rxjs"),require("@univerjs/sheets-formula"),require("@univerjs/engine-formula")):typeof define=="function"&&define.amd?define(["exports","@univerjs/core","@univerjs/data-validation","@univerjs/sheets","rxjs","@univerjs/sheets-formula","@univerjs/engine-formula"],r):(m=typeof globalThis<"u"?globalThis:m||self,r(m.UniverSheetsDataValidation={},m.UniverCore,m.UniverDataValidation,m.UniverSheets,m.rxjs,m.UniverSheetsFormula,m.UniverEngineFormula))})(this,function(m,r,p,D,A,K,T){"use strict";var Tt=Object.defineProperty;var Ot=(m,r,p)=>r in m?Tt(m,r,{enumerable:!0,configurable:!0,writable:!0,value:p}):m[r]=p;var _=(m,r,p)=>Ot(m,typeof r!="symbol"?r+"":r,p);const ve="SHEET_DATA_VALIDATION_PLUGIN";var He=Object.getOwnPropertyDescriptor,Pe=(o,s,e,t)=>{for(var a=t>1?void 0:t?He(s,e):s,i=o.length-1,n;i>=0;i--)(n=o[i])&&(a=n(a)||a);return a},Re=(o,s)=>(e,t)=>s(e,t,o);m.DataValidationCacheService=class extends r.Disposable{constructor(e,t){super();_(this,"_cacheMatrix",new Map);_(this,"_dirtyRanges$",new A.Subject);_(this,"dirtyRanges$",this._dirtyRanges$.asObservable());this._commandService=e,this._univerInstanceService=t,this._initDirtyRanges(),this._initSheetRemove()}_initDirtyRanges(){this.disposeWithMe(this._commandService.onCommandExecuted(e=>{if(e.id===D.SetRangeValuesMutation.id){const{cellValue:t,unitId:a,subUnitId:i}=e.params;if(t){const n=new r.ObjectMatrix(t).getDataRange();if(n.endRow===-1)return;this.markRangeDirty(a,i,[n],!0)}}}))}_initSheetRemove(){this.disposeWithMe(this._commandService.onCommandExecuted(e=>{var t;if(e.id===D.RemoveSheetMutation.id){const{unitId:a,subUnitId:i}=e.params;(t=this._cacheMatrix.get(a))==null||t.delete(i)}})),this.disposeWithMe(this._univerInstanceService.unitDisposed$.subscribe(e=>{e.type===r.UniverInstanceType.UNIVER_SHEET&&this._cacheMatrix.delete(e.getUnitId())}))}_ensureCache(e,t){let a=this._cacheMatrix.get(e);a||(a=new Map,this._cacheMatrix.set(e,a));let i=a.get(t);return i||(i=new r.ObjectMatrix,a.set(t,i)),i}ensureCache(e,t){return this._ensureCache(e,t)}addRule(e,t,a){this.markRangeDirty(e,t,a.ranges)}removeRule(e,t,a){this._deleteRange(e,t,a.ranges)}markRangeDirty(e,t,a,i){const n=this._ensureCache(e,t);a.forEach(l=>{r.Range.foreach(l,(u,d)=>{n.setValue(u,d,void 0)})}),this._dirtyRanges$.next({unitId:e,subUnitId:t,ranges:a,isSetRange:i})}_deleteRange(e,t,a){const i=this._ensureCache(e,t);a.forEach(n=>{r.Range.foreach(n,(l,u)=>{i.realDeleteValue(l,u)})}),this._dirtyRanges$.next({unitId:e,subUnitId:t,ranges:a})}getValue(e,t,a,i){return this._ensureCache(e,t).getValue(a,i)}},m.DataValidationCacheService=Pe([Re(0,r.Inject(r.ICommandService)),Re(1,r.Inject(r.IUniverInstanceService))],m.DataValidationCacheService);function w(o){var s,e;return(e=(s=o==null?void 0:o[0])==null?void 0:s[0])==null?void 0:e.v}function j(o){var s;return(s=o==null?void 0:o[0])==null?void 0:s[0]}function y(o){return!T.ERROR_TYPE_SET.has(o)}function H(o,s){var t;const e=s.getValidatorItem(o);return(t=e==null?void 0:e.offsetFormulaByRange)!=null?t:!1}var We=Object.getOwnPropertyDescriptor,$e=(o,s,e,t)=>{for(var a=t>1?void 0:t?We(s,e):s,i=o.length-1,n;i>=0;i--)(n=o[i])&&(a=n(a)||a);return a},P=(o,s)=>(e,t)=>s(e,t,o);m.DataValidationCustomFormulaService=class extends r.Disposable{constructor(e,t,a,i,n){super();_(this,"_ruleFormulaMap",new Map);_(this,"_ruleFormulaMap2",new Map);this._instanceSrv=e,this._registerOtherFormulaService=t,this._dataValidationModel=a,this._dataValidationCacheService=i,this._validatorRegistryService=n,this._initFormulaResultHandler(),this._initDirtyRanges()}_initFormulaResultHandler(){this.disposeWithMe(this._registerOtherFormulaService.formulaResult$.subscribe(e=>{for(const t in e){const a=e[t];if(this._instanceSrv.getUnitType(t)===r.UniverInstanceType.UNIVER_SHEET)for(const n in a){const l=a[n],{ruleFormulaMap:u}=this._ensureMaps(t,n);l.forEach(d=>{var g,S;const c=u.get((g=d.extra)==null?void 0:g.ruleId),h=this._dataValidationModel.getRuleById(t,n,(S=d.extra)==null?void 0:S.ruleId);h&&c&&this._dataValidationCacheService.markRangeDirty(t,n,h.ranges)})}}}))}_ensureMaps(e,t){let a=this._ruleFormulaMap.get(e),i=this._ruleFormulaMap2.get(e);a||(a=new Map,this._ruleFormulaMap.set(e,a)),i||(i=new Map,this._ruleFormulaMap2.set(e,i));let n=a.get(t);n||(n=new Map,a.set(t,n));let l=i.get(t);return l||(l=new Map,i.set(t,l)),{ruleFormulaMap:n,ruleFormulaMap2:l}}_registerFormula(e,t,a,i,n){return this._registerOtherFormulaService.registerFormulaWithRange(e,t,i,n,{ruleId:a})}_handleDirtyRanges(e,t,a){this._dataValidationModel.getRules(e,t).forEach(n=>{const l=n.ranges;r.Rectangle.doAnyRangesIntersect(l,a)&&this.makeRuleDirty(e,t,n.uid)})}_initDirtyRanges(){this._dataValidationCacheService.dirtyRanges$.subscribe(e=>{e.isSetRange&&this._handleDirtyRanges(e.unitId,e.subUnitId,e.ranges)})}deleteByRuleId(e,t,a){const{ruleFormulaMap:i,ruleFormulaMap2:n}=this._ensureMaps(e,t),l=this._dataValidationModel.getRuleById(e,t,a),u=i.get(a);if(!l||!u)return;const d=i.get(a);d&&(i.delete(a),this._registerOtherFormulaService.deleteFormula(e,t,[d.formulaId]));const c=n.get(a);c&&(n.delete(a),this._registerOtherFormulaService.deleteFormula(e,t,[c.formulaId]))}_addFormulaByRange(e,t,a,i,n,l){const{ruleFormulaMap:u,ruleFormulaMap2:d}=this._ensureMaps(e,t),c=l[0].startRow,h=l[0].startColumn;if(i&&r.isFormulaString(i)){const g=this._registerFormula(e,t,a,i,l);u.set(a,{formula:i,originCol:h,originRow:c,formulaId:g})}if(n&&r.isFormulaString(n)){const g=this._registerFormula(e,t,a,n,l);d.set(a,{formula:n,originCol:h,originRow:c,formulaId:g})}}addRule(e,t,a){if(H(a.type,this._validatorRegistryService)){const{ranges:i,formula1:n,formula2:l,uid:u}=a;this._addFormulaByRange(e,t,u,n,l,i)}}async getCellFormulaValue(e,t,a,i,n){var v,R;const{ruleFormulaMap:l}=this._ensureMaps(e,t),u=l.get(a);if(!u)return Promise.resolve(void 0);const d=await this._registerOtherFormulaService.getFormulaValue(e,t,u.formulaId),{originRow:c,originCol:h}=u,g=i-c,S=n-h;return j((R=(v=d==null?void 0:d.result)==null?void 0:v[g])==null?void 0:R[S])}async getCellFormula2Value(e,t,a,i,n){var v,R;const{ruleFormulaMap2:l}=this._ensureMaps(e,t),u=l.get(a);if(!u)return Promise.resolve(void 0);const d=await this._registerOtherFormulaService.getFormulaValue(e,t,u.formulaId),{originRow:c,originCol:h}=u,g=i-c,S=n-h;return j((R=(v=d==null?void 0:d.result)==null?void 0:v[g])==null?void 0:R[S])}getCellFormulaValueSync(e,t,a,i,n){var v,R;const{ruleFormulaMap:l}=this._ensureMaps(e,t),u=l.get(a);if(!u)return;const d=this._registerOtherFormulaService.getFormulaValueSync(e,t,u.formulaId),{originRow:c,originCol:h}=u,g=i-c,S=n-h;return j((R=(v=d==null?void 0:d.result)==null?void 0:v[g])==null?void 0:R[S])}getCellFormula2ValueSync(e,t,a,i,n){var v,R;const{ruleFormulaMap2:l}=this._ensureMaps(e,t),u=l.get(a);if(!u)return;const d=this._registerOtherFormulaService.getFormulaValueSync(e,t,u.formulaId),{originRow:c,originCol:h}=u,g=i-c,S=n-h;return j((R=(v=d==null?void 0:d.result)==null?void 0:v[g])==null?void 0:R[S])}getRuleFormulaInfo(e,t,a){const{ruleFormulaMap:i}=this._ensureMaps(e,t);return i.get(a)}makeRuleDirty(e,t,a){var l,u,d,c;const i=(u=(l=this._ruleFormulaMap.get(e))==null?void 0:l.get(t))==null?void 0:u.get(a),n=(c=(d=this._ruleFormulaMap2.get(e))==null?void 0:d.get(t))==null?void 0:c.get(a);i&&this._registerOtherFormulaService.markFormulaDirty(e,t,i.formulaId),n&&this._registerOtherFormulaService.markFormulaDirty(e,t,n.formulaId)}},m.DataValidationCustomFormulaService=$e([P(0,r.IUniverInstanceService),P(1,r.Inject(K.RegisterOtherFormulaService)),P(2,r.Inject(p.DataValidationModel)),P(3,r.Inject(m.DataValidationCacheService)),P(4,r.Inject(p.DataValidatorRegistryService))],m.DataValidationCustomFormulaService);var ke=Object.getOwnPropertyDescriptor,xe=(o,s,e,t)=>{for(var a=t>1?void 0:t?ke(s,e):s,i=o.length-1,n;i>=0;i--)(n=o[i])&&(a=n(a)||a);return a},W=(o,s)=>(e,t)=>s(e,t,o);m.DataValidationFormulaService=class extends r.Disposable{constructor(e,t,a,i,n){super();_(this,"_formulaRuleMap",new Map);this._instanceService=e,this._registerOtherFormulaService=t,this._dataValidationCacheService=a,this._dataValidationModel=i,this._validatorRegistryService=n,this._initFormulaResultHandler()}_initFormulaResultHandler(){this.disposeWithMe(this._registerOtherFormulaService.formulaResult$.subscribe(e=>{for(const t in e){const a=e[t];if(this._instanceService.getUnitType(t)===r.UniverInstanceType.UNIVER_SHEET)for(const n in a){const l=a[n],u=this._ensureRuleFormulaMap(t,n);l.forEach(d=>{var c,h;if(u.get((c=d.extra)==null?void 0:c.ruleId)){const g=this._dataValidationModel.getRuleById(t,n,(h=d.extra)==null?void 0:h.ruleId);g&&this._dataValidationCacheService.markRangeDirty(t,n,g.ranges)}})}}}))}_ensureRuleFormulaMap(e,t){let a=this._formulaRuleMap.get(e);a||(a=new Map,this._formulaRuleMap.set(e,a));let i=a.get(t);return i||(i=new Map,a.set(t,i)),i}_registerSingleFormula(e,t,a,i){const n=[{startColumn:0,endColumn:0,startRow:0,endRow:0}];return this._registerOtherFormulaService.registerFormulaWithRange(e,t,a,n,{ruleId:i})}addRule(e,t,a){if(!H(a.type,this._validatorRegistryService)&&a.type!==r.DataValidationType.CHECKBOX){const{formula1:i,formula2:n,uid:l}=a,u=r.isFormulaString(i),d=r.isFormulaString(n);if(!u&&!d)return;const c=this._ensureRuleFormulaMap(e,t),h=[void 0,void 0];if(u){const g=this._registerSingleFormula(e,t,i,l);h[0]={id:g,text:i}}if(d){const g=this._registerSingleFormula(e,t,n,l);h[1]={id:g,text:n}}c.set(l,h)}}removeRule(e,t,a){const n=this._ensureRuleFormulaMap(e,t).get(a);if(!n)return;const[l,u]=n,d=[l==null?void 0:l.id,u==null?void 0:u.id].filter(Boolean);d.length&&this._registerOtherFormulaService.deleteFormula(e,t,d)}getRuleFormulaResult(e,t,a){const n=this._ensureRuleFormulaMap(e,t).get(a);if(!n)return Promise.resolve(null);const l=async u=>u&&this._registerOtherFormulaService.getFormulaValue(e,t,u.id);return Promise.all([l(n[0]),l(n[1])])}getRuleFormulaResultSync(e,t,a){const n=this._ensureRuleFormulaMap(e,t).get(a);if(n)return n.map(l=>{if(l)return this._registerOtherFormulaService.getFormulaValueSync(e,t,l.id)})}getRuleFormulaInfo(e,t,a){return this._ensureRuleFormulaMap(e,t).get(a)}},m.DataValidationFormulaService=xe([W(0,r.IUniverInstanceService),W(1,r.Inject(K.RegisterOtherFormulaService)),W(2,r.Inject(m.DataValidationCacheService)),W(3,r.Inject(p.DataValidationModel)),W(4,r.Inject(p.DataValidatorRegistryService))],m.DataValidationFormulaService);function U(o){return r.getOriginCellValue(o)}function Ve(o){var s;return String((s=U(o))!=null?s:"")}class ue{constructor(s,e,t,a,i=!1){_(this,"_map");_(this,"_tree",new r.RBush);_(this,"_dirty",!0);_(this,"_buildTree",()=>{if(!this._dirty||this._disableTree)return;this._tree.clear();const s=[];this._map.forEach((e,t)=>{e.forEach(a=>{s.push({minX:a.startRow,maxX:a.endRow,minY:a.startColumn,maxY:a.endColumn,ruleId:t})})}),this._tree.load(s),this._dirty=!1});_(this,"_debonceBuildTree",r.debounce(this._buildTree,0));this._unitId=e,this._subUnitId=t,this._univerInstanceService=a,this._disableTree=i,this._map=s,this._buildTree()}get _worksheet(){var s;return(s=this._univerInstanceService.getUnit(this._unitId,r.UniverInstanceType.UNIVER_SHEET))==null?void 0:s.getSheetBySheetId(this._subUnitId)}_addRule(s,e){if(!this._worksheet)return;const t=r.Rectangle.mergeRanges(e.map(a=>r.Range.transformRange(a,this._worksheet)));this._map.forEach((a,i)=>{const n=r.Rectangle.subtractMulti(a,t);n.length===0?this._map.delete(i):this._map.set(i,n)}),this._dirty=!0,this._map.set(s,t),this._debonceBuildTree()}addRule(s){this._addRule(s.uid,s.ranges)}removeRange(s){if(!this._worksheet)return;const e=s.map(t=>r.Range.transformRange(t,this._worksheet));this._map.forEach((t,a)=>{const i=r.Rectangle.subtractMulti(t,e);i.length===0?this._map.delete(a):this._map.set(a,i)}),this._dirty=!0,this._debonceBuildTree()}_removeRule(s){this._map.delete(s),this._dirty=!0,this._debonceBuildTree()}removeRule(s){this._removeRule(s.uid)}updateRange(s,e){this._removeRule(s),this._addRule(s,e)}addRangeRules(s){s.forEach(({id:e,ranges:t})=>{if(!t.length)return;let a=this._map.get(e);a?(this._map.set(e,r.Rectangle.mergeRanges([...a,...t])),a=this._map.get(e)):(a=t,this._map.set(e,a)),this._map.forEach((i,n)=>{if(n===e)return;const l=r.Rectangle.subtractMulti(i,t);l.length===0?this._map.delete(n):this._map.set(n,l)})}),this._dirty=!0,this._debonceBuildTree()}diff(s){const e=[];let t=0;return s.forEach((a,i)=>{var u;const n=(u=this._map.get(a.uid))!=null?u:[],l=a.ranges;n.length!==0&&(n.length!==l.length||n.some((d,c)=>!r.Rectangle.equals(d,l[c])))&&e.push({type:"update",ruleId:a.uid,oldRanges:l,newRanges:r.Rectangle.sort(n),rule:a}),n.length===0&&(e.push({type:"delete",rule:a,index:i-t}),t++)}),e}diffWithAddition(s,e){const t=[];let a=0;return s.forEach((i,n)=>{var d;const l=(d=this._map.get(i.uid))!=null?d:[],u=i.ranges;l.length!==0&&(l.length!==u.length||l.some((c,h)=>!r.Rectangle.equals(c,u[h])))&&t.push({type:"update",ruleId:i.uid,oldRanges:u,newRanges:r.Rectangle.sort(l),rule:i}),l.length===0&&(t.push({type:"delete",rule:i,index:n-a}),a++)}),Array.from(e).forEach(i=>{var l;const n=(l=this._map.get(i.uid))!=null?l:[];t.push({type:"add",rule:{...i,ranges:r.Rectangle.sort(n)}})}),t}clone(){return new ue(new Map(r.Tools.deepClone(Array.from(this._map.entries()))),this._unitId,this._subUnitId,this._univerInstanceService,!0)}getValue(s,e){this._dirty&&this._buildTree();const t=this._tree.search({minX:s,maxX:s,minY:e,maxY:e});return t.length>0?t[0].ruleId:void 0}}var qe=Object.getOwnPropertyDescriptor,Qe=(o,s,e,t)=>{for(var a=t>1?void 0:t?qe(s,e):s,i=o.length-1,n;i>=0;i--)(n=o[i])&&(a=n(a)||a);return a},N=(o,s)=>(e,t)=>s(e,t,o);m.SheetDataValidationModel=class extends r.Disposable{constructor(e,t,a,i,n,l,u){super();_(this,"_ruleMatrixMap",new Map);_(this,"_validStatusChange$",new A.Subject);_(this,"_ruleChange$",new A.Subject);_(this,"ruleChange$",this._ruleChange$.asObservable());_(this,"validStatusChange$",this._validStatusChange$.asObservable());this._dataValidationModel=e,this._univerInstanceService=t,this._dataValidatorRegistryService=a,this._dataValidationCacheService=i,this._dataValidationFormulaService=n,this._dataValidationCustomFormulaService=l,this._commandService=u,this._initRuleUpdateListener(),this.disposeWithMe(()=>{this._ruleChange$.complete(),this._validStatusChange$.complete()}),this._initUniverInstanceListener()}_initUniverInstanceListener(){this.disposeWithMe(this._univerInstanceService.unitDisposed$.subscribe(e=>{this._ruleMatrixMap.delete(e.getUnitId())})),this.disposeWithMe(this._commandService.onCommandExecuted(e=>{if(e.id===D.RemoveSheetMutation.id){const{unitId:t,subUnitId:a}=e.params,i=this._ruleMatrixMap.get(t);i&&i.delete(a)}}))}_initRuleUpdateListener(){const e=this._dataValidationModel.getAll();for(const[t,a]of e)for(const[i,n]of a)for(const l of n)this._addRule(t,i,l),this._ruleChange$.next({type:"add",unitId:t,subUnitId:i,rule:l,source:"patched"});this.disposeWithMe(this._dataValidationModel.ruleChange$.subscribe(t=>{switch(t.type){case"add":this._addRule(t.unitId,t.subUnitId,t.rule);break;case"update":this._updateRule(t.unitId,t.subUnitId,t.rule.uid,t.oldRule,t.updatePayload);break;case"remove":this._removeRule(t.unitId,t.subUnitId,t.rule);break}this._ruleChange$.next(t)}))}_ensureRuleMatrix(e,t){let a=this._ruleMatrixMap.get(e);a||(a=new Map,this._ruleMatrixMap.set(e,a));let i=a.get(t);return i||(i=new ue(new Map,e,t,this._univerInstanceService),a.set(t,i)),i}_addRuleSideEffect(e,t,a){this._ensureRuleMatrix(e,t).addRule(a),this._dataValidationCacheService.addRule(e,t,a),this._dataValidationFormulaService.addRule(e,t,a),this._dataValidationCustomFormulaService.addRule(e,t,a)}_addRule(e,t,a){(Array.isArray(a)?a:[a]).forEach(n=>{this._addRuleSideEffect(e,t,n)})}_updateRule(e,t,a,i,n){const l=this._ensureRuleMatrix(e,t),u={...i,...n.payload};n.type===p.UpdateRuleType.RANGE?l.updateRange(a,n.payload):n.type===p.UpdateRuleType.ALL&&l.updateRange(a,n.payload.ranges),this._dataValidationCacheService.removeRule(e,t,i),this._dataValidationCacheService.addRule(e,t,u),this._dataValidationFormulaService.removeRule(e,t,i.uid),this._dataValidationFormulaService.addRule(e,t,u),this._dataValidationCustomFormulaService.deleteByRuleId(e,t,a),this._dataValidationCustomFormulaService.addRule(e,t,u)}_removeRule(e,t,a){this._ensureRuleMatrix(e,t).removeRule(a),this._dataValidationCacheService.removeRule(e,t,a),this._dataValidationCustomFormulaService.deleteByRuleId(e,t,a.uid)}getValidator(e){return this._dataValidatorRegistryService.getValidatorItem(e)}getRuleIdByLocation(e,t,a,i){return this._ensureRuleMatrix(e,t).getValue(a,i)}getRuleByLocation(e,t,a,i){const n=this.getRuleIdByLocation(e,t,a,i);if(n)return this._dataValidationModel.getRuleById(e,t,n)}validator(e,t,a){const{col:i,row:n,unitId:l,subUnitId:u,worksheet:d}=t,c=(R,V)=>{a&&a(R,V),V&&this._validStatusChange$.next({unitId:l,subUnitId:u,ruleId:e.uid,status:R,row:n,col:i})},h=d.getCellValueOnly(n,i),g=this.getValidator(e.type),S=d.getCellRaw(n,i),v=U(S);if(g){const R=this._dataValidationCacheService.ensureCache(l,u),V=R.getValue(n,i);return V==null?(R.setValue(n,i,r.DataValidationStatus.VALIDATING),g.validator({value:v,unitId:l,subUnitId:u,row:n,column:i,worksheet:t.worksheet,workbook:t.workbook,interceptValue:U(h),t:S==null?void 0:S.t},e).then(f=>{const M=f?r.DataValidationStatus.VALID:r.DataValidationStatus.INVALID,O=R.getValue(n,i);M===r.DataValidationStatus.VALID?R.realDeleteValue(n,i):R.setValue(n,i,M),c(M,V!==O)}),r.DataValidationStatus.VALIDATING):(c(V!=null?V:r.DataValidationStatus.VALID,!1),V!=null?V:r.DataValidationStatus.VALID)}else return c(r.DataValidationStatus.VALID,!1),r.DataValidationStatus.VALID}getRuleObjectMatrix(e,t){return this._ensureRuleMatrix(e,t)}getRuleById(e,t,a){return this._dataValidationModel.getRuleById(e,t,a)}getRuleIndex(e,t,a){return this._dataValidationModel.getRuleIndex(e,t,a)}getRules(e,t){return[...this._dataValidationModel.getRules(e,t)]}getUnitRules(e){return this._dataValidationModel.getUnitRules(e)}deleteUnitRules(e){return this._dataValidationModel.deleteUnitRules(e)}getSubUnitIds(e){return this._dataValidationModel.getSubUnitIds(e)}getAll(){return this._dataValidationModel.getAll()}},m.SheetDataValidationModel=Qe([N(0,r.Inject(p.DataValidationModel)),N(1,r.IUniverInstanceService),N(2,r.Inject(p.DataValidatorRegistryService)),N(3,r.Inject(m.DataValidationCacheService)),N(4,r.Inject(m.DataValidationFormulaService)),N(5,r.Inject(m.DataValidationCustomFormulaService)),N(6,r.ICommandService)],m.SheetDataValidationModel);const $=1,k=0;function De(o,s){return r.Tools.isBlank(o)?s.t("dataValidation.validFail.value"):r.isFormulaString(o)?s.t("dataValidation.validFail.primitive"):""}const x=o=>r.Tools.isDefine(o)&&String(o).toLowerCase()==="true"?"1":String(o).toLowerCase()==="false"?"0":o;class Me extends p.BaseDataValidator{constructor(){super(...arguments);_(this,"id",r.DataValidationType.CHECKBOX);_(this,"title","dataValidation.checkbox.title");_(this,"operators",[]);_(this,"scopes",["sheet"]);_(this,"offsetFormulaByRange",!1);_(this,"_formulaService",this.injector.get(m.DataValidationFormulaService));_(this,"skipDefaultFontRender",(e,t,a)=>{const{unitId:i,subUnitId:n}=a,{formula1:l,formula2:u}=this.parseFormulaSync(e,i,n),d=`${t!=null?t:""}`;return!d||d===`${l}`||d===`${u}`})}validatorFormula(e,t,a){const{formula1:i,formula2:n}=e,l=i===n;if(r.Tools.isBlank(i)&&r.Tools.isBlank(n))return{success:!0};if(l)return{success:!1,formula1:this.localeService.t("dataValidation.validFail.checkboxEqual"),formula2:this.localeService.t("dataValidation.validFail.checkboxEqual")};const u=De(i,this.localeService),d=De(n,this.localeService);return{success:!u&&!d,formula1:u,formula2:d}}async parseFormula(e,t,a){var h,g,S,v;const{formula1:i=$,formula2:n=k}=e,l=await this._formulaService.getRuleFormulaResult(t,a,e.uid),u=r.isFormulaString(i)?w((g=(h=l==null?void 0:l[0])==null?void 0:h.result)==null?void 0:g[0][0]):i,d=r.isFormulaString(n)?w((v=(S=l==null?void 0:l[1])==null?void 0:S.result)==null?void 0:v[0][0]):n,c=y(String(u))&&y(String(d));return{formula1:x(u),formula2:x(d),originFormula1:u,originFormula2:d,isFormulaValid:c}}getExtraStyle(e,t){return{tb:r.WrapStrategy.CLIP}}parseFormulaSync(e,t,a){var h,g,S,v;const{formula1:i=$,formula2:n=k}=e,l=this._formulaService.getRuleFormulaResultSync(t,a,e.uid),u=r.isFormulaString(i)?w((g=(h=l==null?void 0:l[0])==null?void 0:h.result)==null?void 0:g[0][0]):i,d=r.isFormulaString(n)?w((v=(S=l==null?void 0:l[1])==null?void 0:S.result)==null?void 0:v[0][0]):n,c=y(String(u))&&y(String(d));return{formula1:x(u),formula2:x(d),originFormula1:u,originFormula2:d,isFormulaValid:c}}async isValidType(e,t,a){const{value:i,unitId:n,subUnitId:l}=e,{formula1:u,formula2:d,originFormula1:c,originFormula2:h}=await this.parseFormula(a,n,l);return!r.Tools.isDefine(u)||!r.Tools.isDefine(d)?!0:r.Tools.isDefine(i)&&(String(i)===String(u)||String(i)===String(d)||String(i)===String(c!=null?c:"")||String(i)===String(h!=null?h:""))}generateRuleErrorMessage(e){return this.localeService.t("dataValidation.checkbox.error")}}const Ge={[r.DataValidationOperator.BETWEEN]:"dataValidation.date.operators.between",[r.DataValidationOperator.EQUAL]:"dataValidation.date.operators.equal",[r.DataValidationOperator.GREATER_THAN]:"dataValidation.date.operators.greaterThan",[r.DataValidationOperator.GREATER_THAN_OR_EQUAL]:"dataValidation.date.operators.greaterThanOrEqual",[r.DataValidationOperator.LESS_THAN]:"dataValidation.date.operators.lessThan",[r.DataValidationOperator.LESS_THAN_OR_EQUAL]:"dataValidation.date.operators.lessThanOrEqual",[r.DataValidationOperator.NOT_BETWEEN]:"dataValidation.date.operators.notBetween",[r.DataValidationOperator.NOT_EQUAL]:"dataValidation.date.operators.notEqual"};r.DataValidationOperator.BETWEEN+"",r.DataValidationOperator.EQUAL+"",r.DataValidationOperator.GREATER_THAN+"",r.DataValidationOperator.GREATER_THAN_OR_EQUAL+"",r.DataValidationOperator.LESS_THAN+"",r.DataValidationOperator.LESS_THAN_OR_EQUAL+"",r.DataValidationOperator.NOT_BETWEEN+"",r.DataValidationOperator.NOT_EQUAL+"";const Ye={[r.DataValidationOperator.BETWEEN]:"dataValidation.date.ruleName.between",[r.DataValidationOperator.EQUAL]:"dataValidation.date.ruleName.equal",[r.DataValidationOperator.GREATER_THAN]:"dataValidation.date.ruleName.greaterThan",[r.DataValidationOperator.GREATER_THAN_OR_EQUAL]:"dataValidation.date.ruleName.greaterThanOrEqual",[r.DataValidationOperator.LESS_THAN]:"dataValidation.date.ruleName.lessThan",[r.DataValidationOperator.LESS_THAN_OR_EQUAL]:"dataValidation.date.ruleName.lessThanOrEqual",[r.DataValidationOperator.NOT_BETWEEN]:"dataValidation.date.ruleName.notBetween",[r.DataValidationOperator.NOT_EQUAL]:"dataValidation.date.ruleName.notEqual"},Xe={[r.DataValidationOperator.BETWEEN]:"dataValidation.date.errorMsg.between",[r.DataValidationOperator.EQUAL]:"dataValidation.date.errorMsg.equal",[r.DataValidationOperator.GREATER_THAN]:"dataValidation.date.errorMsg.greaterThan",[r.DataValidationOperator.GREATER_THAN_OR_EQUAL]:"dataValidation.date.errorMsg.greaterThanOrEqual",[r.DataValidationOperator.LESS_THAN]:"dataValidation.date.errorMsg.lessThan",[r.DataValidationOperator.LESS_THAN_OR_EQUAL]:"dataValidation.date.errorMsg.lessThanOrEqual",[r.DataValidationOperator.NOT_BETWEEN]:"dataValidation.date.errorMsg.notBetween",[r.DataValidationOperator.NOT_EQUAL]:"dataValidation.date.errorMsg.notEqual"},z=[r.DataValidationOperator.BETWEEN,r.DataValidationOperator.NOT_BETWEEN],q="{FORMULA1}",Q="{FORMULA2}";function Ke(o){return o.filter(Boolean).join(",")}function G(o){return o.split(",").filter(Boolean)}function ze(o){const s=U(o);return s==null?"":s.toString()}function Z(o,s,e){const{formula1:t,formula2:a}=s,i=s.ranges[0].startRow,n=s.ranges[0].startColumn,l=e.row-i,u=e.col-n,d=r.isFormulaString(t)?o.moveFormulaRefOffset(t,u,l,!0):t,c=r.isFormulaString(a)?o.moveFormulaRefOffset(a,u,l,!0):a;return{transformedFormula1:d,transformedFormula2:c}}const de=o=>{var e,t;if(o==null||typeof o=="boolean")return;if(typeof o=="number"||!Number.isNaN(+o))return+o;const s=(e=r.numfmt.parseDate(o))==null?void 0:e.v;return r.Tools.isDefine(s)?s:(t=r.numfmt.parseDate(r.dayjs(o).format("YYYY-MM-DD HH:mm:ss")))==null?void 0:t.v};class ye extends p.BaseDataValidator{constructor(){super(...arguments);_(this,"id",r.DataValidationType.DATE);_(this,"title","dataValidation.date.title");_(this,"operators",[r.DataValidationOperator.BETWEEN,r.DataValidationOperator.EQUAL,r.DataValidationOperator.GREATER_THAN,r.DataValidationOperator.GREATER_THAN_OR_EQUAL,r.DataValidationOperator.LESS_THAN,r.DataValidationOperator.LESS_THAN_OR_EQUAL,r.DataValidationOperator.NOT_BETWEEN,r.DataValidationOperator.NOT_EQUAL]);_(this,"scopes",["sheet"]);_(this,"_customFormulaService",this.injector.get(m.DataValidationCustomFormulaService));_(this,"_lexerTreeBuilder",this.injector.get(T.LexerTreeBuilder))}async parseFormula(e,t,a,i,n){const l=await this._customFormulaService.getCellFormulaValue(t,a,e.uid,i,n),u=await this._customFormulaService.getCellFormula2Value(t,a,e.uid,i,n),{formula1:d,formula2:c}=e,h=y(String(l==null?void 0:l.v))&&y(String(u==null?void 0:u.v));return{formula1:de(r.isFormulaString(d)?l==null?void 0:l.v:d),formula2:de(r.isFormulaString(c)?u==null?void 0:u.v:c),isFormulaValid:h}}async isValidType(e){const{interceptValue:t,value:a}=e;return typeof a=="number"&&typeof t=="string"?!0:typeof t=="string"?!!r.numfmt.parseDate(t):!1}_validatorSingleFormula(e){return!r.Tools.isBlank(e)&&(r.isFormulaString(e)||!Number.isNaN(+e)||!!(e&&r.numfmt.parseDate(e)))}validatorFormula(e,t,a){const i=e.operator;if(!i)return{success:!1};const n=this._validatorSingleFormula(e.formula1),l=this.localeService.t("dataValidation.validFail.date");if(z.includes(i)){const d=this._validatorSingleFormula(e.formula2);return{success:n&&d,formula1:n?void 0:l,formula2:d?void 0:l}}return{success:n,formula1:n?void 0:l}}normalizeFormula(e,t,a){const{formula1:i,formula2:n,bizInfo:l}=e,u=d=>{var h;if(!d)return d;let c;if(!Number.isNaN(+d))c=r.numfmt.dateFromSerial(+d);else{const g=(h=r.numfmt.parseDate(d))==null?void 0:h.v;if(g==null)return"";c=r.numfmt.dateFromSerial(g)}return r.dayjs(`${c[0]}/${c[1]}/${c[2]} ${c[3]}:${c[4]}:${c[5]}`).format(l!=null&&l.showTime?"YYYY-MM-DD HH:mm:ss":"YYYY-MM-DD")};return{formula1:r.isFormulaString(i)?i:u(`${i}`),formula2:r.isFormulaString(n)?n:u(`${n}`)}}transform(e,t,a){const{value:i}=e;return{...e,value:de(i)}}get operatorNames(){return this.operators.map(e=>this.localeService.t(Ge[e]))}generateRuleName(e){var a,i;if(!e.operator)return this.titleStr;const t=this.localeService.t(Ye[e.operator]).replace(q,(a=e.formula1)!=null?a:"").replace(Q,(i=e.formula2)!=null?i:"");return`${this.titleStr} ${t}`}generateRuleErrorMessage(e,t){if(!e.operator)return this.titleStr;const{transformedFormula1:a,transformedFormula2:i}=Z(this._lexerTreeBuilder,e,t);return`${this.localeService.t(Xe[e.operator]).replace(q,a!=null?a:"").replace(Q,i!=null?i:"")}`}}r.DataValidationOperator.BETWEEN+"",r.DataValidationOperator.EQUAL+"",r.DataValidationOperator.GREATER_THAN+"",r.DataValidationOperator.GREATER_THAN_OR_EQUAL+"",r.DataValidationOperator.LESS_THAN+"",r.DataValidationOperator.LESS_THAN_OR_EQUAL+"",r.DataValidationOperator.NOT_BETWEEN+"",r.DataValidationOperator.NOT_EQUAL+"",r.DataValidationOperator.BETWEEN+"",r.DataValidationOperator.EQUAL+"",r.DataValidationOperator.GREATER_THAN+"",r.DataValidationOperator.GREATER_THAN_OR_EQUAL+"",r.DataValidationOperator.LESS_THAN+"",r.DataValidationOperator.LESS_THAN_OR_EQUAL+"",r.DataValidationOperator.NOT_BETWEEN+"",r.DataValidationOperator.NOT_EQUAL+"";const Te={[r.DataValidationOperator.BETWEEN]:"dataValidation.errorMsg.between",[r.DataValidationOperator.EQUAL]:"dataValidation.errorMsg.equal",[r.DataValidationOperator.GREATER_THAN]:"dataValidation.errorMsg.greaterThan",[r.DataValidationOperator.GREATER_THAN_OR_EQUAL]:"dataValidation.errorMsg.greaterThanOrEqual",[r.DataValidationOperator.LESS_THAN]:"dataValidation.errorMsg.lessThan",[r.DataValidationOperator.LESS_THAN_OR_EQUAL]:"dataValidation.errorMsg.lessThanOrEqual",[r.DataValidationOperator.NOT_BETWEEN]:"dataValidation.errorMsg.notBetween",[r.DataValidationOperator.NOT_EQUAL]:"dataValidation.errorMsg.notEqual"};function J(o){let s=o;return typeof o=="string"?((o.startsWith("¥")||o.startsWith("$"))&&(s=o.slice(1)),+s):+o}class Ze extends p.BaseDataValidator{constructor(){super(...arguments);_(this,"_customFormulaService",this.injector.get(m.DataValidationCustomFormulaService));_(this,"id",r.DataValidationType.DECIMAL);_(this,"_lexerTreeBuilder",this.injector.get(T.LexerTreeBuilder));_(this,"title","dataValidation.decimal.title");_(this,"operators",[r.DataValidationOperator.BETWEEN,r.DataValidationOperator.EQUAL,r.DataValidationOperator.GREATER_THAN,r.DataValidationOperator.GREATER_THAN_OR_EQUAL,r.DataValidationOperator.LESS_THAN,r.DataValidationOperator.LESS_THAN_OR_EQUAL,r.DataValidationOperator.NOT_BETWEEN,r.DataValidationOperator.NOT_EQUAL]);_(this,"scopes",["sheet"])}_isFormulaOrNumber(e){return!r.Tools.isBlank(e)&&(r.isFormulaString(e)||!Number.isNaN(+e))}async isValidType(e,t,a){const{value:i}=e;return!Number.isNaN(J(i))}transform(e,t,a){const{value:i}=e;return{...e,value:J(i)}}_parseNumber(e){return e==null?Number.NaN:+e}async parseFormula(e,t,a,i,n){const l=await this._customFormulaService.getCellFormulaValue(t,a,e.uid,i,n),u=await this._customFormulaService.getCellFormula2Value(t,a,e.uid,i,n),{formula1:d,formula2:c}=e,h=y(String(l==null?void 0:l.v))&&y(String(u==null?void 0:u.v));return{formula1:this._parseNumber(r.isFormulaString(d)?l==null?void 0:l.v:d),formula2:this._parseNumber(r.isFormulaString(c)?u==null?void 0:u.v:c),isFormulaValid:h}}validatorFormula(e,t,a){const i=e.operator;if(!i)return{success:!1};const n=r.Tools.isDefine(e.formula1)&&this._isFormulaOrNumber(e.formula1),l=r.Tools.isDefine(e.formula2)&&this._isFormulaOrNumber(e.formula2),u=z.includes(i),d=this.localeService.t("dataValidation.validFail.number");return u?{success:n&&l,formula1:n?void 0:d,formula2:l?void 0:d}:{success:n,formula1:n?"":d}}generateRuleErrorMessage(e,t){if(!e.operator)return this.titleStr;const{transformedFormula1:a,transformedFormula2:i}=Z(this._lexerTreeBuilder,e,t);return`${this.localeService.t(Te[e.operator]).replace(q,a!=null?a:"").replace(Q,i!=null?i:"")}`}}function ce(o){if(!o)return[];const s=new Set;return o.forEach(e=>{e.forEach(t=>{var i,n;const a=U(t);if(a!=null){if(typeof a!="string"&&typeof(t==null?void 0:t.s)=="object"&&((n=(i=t.s)==null?void 0:i.n)!=null&&n.pattern)){s.add(r.numfmt.format(t.s.n.pattern,a,{throws:!1}));return}y(a.toString())&&s.add(a.toString())}})}),[...s]}const Je=["if","indirect","choose","offset"];function et(o,s){if(!r.isFormulaString(o)||T.isReferenceString(o.slice(1)))return!0;const t=s.sequenceNodesBuilder(o);return t&&t.some(a=>typeof a=="object"&&a.nodeType===T.sequenceNodeType.FUNCTION&&Je.indexOf(a.token.toLowerCase())>-1)}function tt(o,s){const{formula1:e="",ranges:t}=o;if(T.isReferenceString(e.slice(1))){const i=T.deserializeRangeWithSheet(e.slice(1));if((!i.sheetName||i.sheetName===s)&&t.some(n=>r.Rectangle.intersects(n,i.range)))return!0}return!1}class me extends p.BaseDataValidator{constructor(){super(...arguments);_(this,"formulaService",this.injector.get(m.DataValidationFormulaService));_(this,"_lexer",this.injector.get(T.LexerTreeBuilder));_(this,"_univerInstanceService",this.injector.get(r.IUniverInstanceService));_(this,"offsetFormulaByRange",!1);_(this,"id",r.DataValidationType.LIST);_(this,"title","dataValidation.list.title");_(this,"operators",[]);_(this,"scopes",["sheet"]);_(this,"skipDefaultFontRender",e=>e.renderMode!==r.DataValidationRenderMode.TEXT)}validatorFormula(e,t,a){var d,c,h;const i=!r.Tools.isBlank(e.formula1),n=et((d=e.formula1)!=null?d:"",this._lexer),l=(h=(c=this._univerInstanceService.getUnit(t,r.UniverInstanceType.UNIVER_SHEET))==null?void 0:c.getSheetBySheetId(a))==null?void 0:h.getName(),u=tt(e,l!=null?l:"");return{success:!!(i&&n&&!u),formula1:i?n?u?this.localeService.t("dataValidation.validFail.listIntersects"):void 0:this.localeService.t("dataValidation.validFail.listInvalid"):this.localeService.t("dataValidation.validFail.list")}}getExtraStyle(e,t,{style:a}){var n;const i=(n=a.tb!==r.WrapStrategy.OVERFLOW?a.tb:r.WrapStrategy.CLIP)!=null?n:r.WrapStrategy.WRAP;if(e.type===r.DataValidationType.LIST&&(e.renderMode===r.DataValidationRenderMode.ARROW||e.renderMode===r.DataValidationRenderMode.TEXT)){const l=this.getListWithColorMap(e),u=`${t!=null?t:""}`,d=l[u];if(d)return{bg:{rgb:d},tb:i}}return{tb:i}}parseCellValue(e){const t=e.toString();return G(t)}async parseFormula(e,t,a){var u,d;const i=await this.formulaService.getRuleFormulaResult(t,a,e.uid),n=w((d=(u=i==null?void 0:i[0])==null?void 0:u.result)==null?void 0:d[0][0]);return{formula1:void 0,formula2:void 0,isFormulaValid:y(String(n))}}async isValidType(e,t,a){var g,S;const{value:i,unitId:n,subUnitId:l}=e,{formula1:u=""}=a,d=await this.formulaService.getRuleFormulaResult(n,l,a.uid),c=r.isFormulaString(u)?ce((S=(g=d==null?void 0:d[0])==null?void 0:g.result)==null?void 0:S[0][0]):G(u);return this.parseCellValue(i).every(v=>c.includes(v))}generateRuleName(){return this.localeService.t("dataValidation.list.name")}generateRuleErrorMessage(){return this.localeService.t("dataValidation.list.error")}getList(e,t,a){var g,S,v,R;const{formula1:i=""}=e,n=this.injector.get(r.IUniverInstanceService),l=(g=t?n.getUniverSheetInstance(t):void 0)!=null?g:n.getCurrentUnitForType(r.UniverInstanceType.UNIVER_SHEET);if(!l)return[];const u=(S=a?l.getSheetBySheetId(a):void 0)!=null?S:l.getActiveSheet();if(!u)return[];const d=l.getUnitId(),c=u.getSheetId(),h=this.formulaService.getRuleFormulaResultSync(d,c,e.uid);return r.isFormulaString(i)?ce((R=(v=h==null?void 0:h[0])==null?void 0:v.result)==null?void 0:R[0][0]):G(i)}async getListAsync(e,t,a){var g,S,v,R;const{formula1:i=""}=e,n=this.injector.get(r.IUniverInstanceService),l=(g=t?n.getUniverSheetInstance(t):void 0)!=null?g:n.getCurrentUnitForType(r.UniverInstanceType.UNIVER_SHEET);if(!l)return[];const u=(S=a?l.getSheetBySheetId(a):void 0)!=null?S:l.getActiveSheet();if(!u)return[];const d=l.getUnitId(),c=u.getSheetId(),h=await this.formulaService.getRuleFormulaResult(d,c,e.uid);return r.isFormulaString(i)?ce((R=(v=h==null?void 0:h[0])==null?void 0:v.result)==null?void 0:R[0][0]):G(i)}getListWithColor(e,t,a){const i=this.getList(e,t,a),n=(e.formula2||"").split(",");return i.map((l,u)=>({label:l,color:n[u]}))}getListWithColorMap(e,t,a){const i=this.getListWithColor(e,t,a),n={};return i.forEach(l=>{l.color&&(n[l.label]=l.color)}),n}}class at extends p.BaseDataValidator{constructor(){super(...arguments);_(this,"id",r.DataValidationType.TEXT_LENGTH);_(this,"title","dataValidation.textLength.title");_(this,"_lexerTreeBuilder",this.injector.get(T.LexerTreeBuilder));_(this,"operators",[r.DataValidationOperator.BETWEEN,r.DataValidationOperator.EQUAL,r.DataValidationOperator.GREATER_THAN,r.DataValidationOperator.GREATER_THAN_OR_EQUAL,r.DataValidationOperator.LESS_THAN,r.DataValidationOperator.LESS_THAN_OR_EQUAL,r.DataValidationOperator.NOT_BETWEEN,r.DataValidationOperator.NOT_EQUAL]);_(this,"scopes",["sheet"]);_(this,"_customFormulaService",this.injector.get(m.DataValidationCustomFormulaService))}_isFormulaOrInt(e){return!r.Tools.isBlank(e)&&(r.isFormulaString(e)||!Number.isNaN(+e)&&Number.isInteger(+e))}validatorFormula(e,t,a){const i=e.operator;if(!i)return{success:!1};const n=r.Tools.isDefine(e.formula1)&&this._isFormulaOrInt(e.formula1),l=r.Tools.isDefine(e.formula2)&&this._isFormulaOrInt(e.formula2),u=z.includes(i),d=this.localeService.t("dataValidation.validFail.number");return u?{success:n&&l,formula1:n?void 0:d,formula2:l?void 0:d}:{success:n,formula1:d}}_parseNumber(e){return e==null?Number.NaN:+e}async parseFormula(e,t,a,i,n){const l=await this._customFormulaService.getCellFormulaValue(t,a,e.uid,i,n),u=await this._customFormulaService.getCellFormula2Value(t,a,e.uid,i,n),{formula1:d,formula2:c}=e,h=y(String(l==null?void 0:l.v))&&y(String(u==null?void 0:u.v));return{formula1:this._parseNumber(r.isFormulaString(d)?l==null?void 0:l.v:d),formula2:this._parseNumber(r.isFormulaString(c)?u==null?void 0:u.v:c),isFormulaValid:h}}transform(e,t,a){return{...e,value:e.value.toString().length}}async isValidType(e,t,a){const{value:i}=e;return typeof i=="string"||typeof i=="number"}generateRuleErrorMessage(e,t){if(!e.operator)return this.titleStr;const{transformedFormula1:a,transformedFormula2:i}=Z(this._lexerTreeBuilder,e,t);return`${this.localeService.t(p.TextLengthErrorTitleMap[e.operator]).replace(q,a!=null?a:"").replace(Q,i!=null?i:"")}`}}function Oe(o){var e,t;return o?o.p?!((t=(e=o.p.body)==null?void 0:e.dataStream)!=null?t:"").slice(0,-2).trim():r.Tools.isBlank(o.v):!0}function Y(o,s,e,t,a="command",i=!0){const n=t.get(T.LexerTreeBuilder),l=t.get(p.DataValidatorRegistryService),u=[],d=[],c=t.get(m.SheetDataValidationModel),h=t.get(r.IUniverInstanceService),g=D.getSheetCommandTarget(h,{unitId:o,subUnitId:s});if(!g)return{redoMutations:u,undoMutations:d};const{worksheet:S}=g,v=new r.ObjectMatrix;let R=!1;function V(f,M){i&&f.forEach(O=>{r.Range.foreach(O,(F,E)=>{const I=S.getCellRaw(F,E),B=Ve(I);(Oe(I)||B===M)&&!(I!=null&&I.p)&&(R=!0,v.setValue(F,E,{v:M,p:null}))})})}if(e.forEach(f=>{switch(f.type){case"delete":u.push({id:p.RemoveDataValidationMutation.id,params:{unitId:o,subUnitId:s,ruleId:f.rule.uid,source:a}}),d.unshift({id:p.AddDataValidationMutation.id,params:{unitId:o,subUnitId:s,rule:f.rule,index:f.index,source:a}});break;case"update":{if(H(f.rule.type,l)){const O=f.oldRanges[0].startRow,F=f.oldRanges[0].startColumn,E=f.newRanges[0].startRow,I=f.newRanges[0].startColumn,B=E-O,ne=I-F,oe=r.isFormulaString(f.rule.formula1)?n.moveFormulaRefOffset(f.rule.formula1,ne,B):f.rule.formula1,se=r.isFormulaString(f.rule.formula2)?n.moveFormulaRefOffset(f.rule.formula2,ne,B):f.rule.formula2;oe!==f.rule.formula1||se!==f.rule.formula2||!r.isRangesEqual(f.newRanges,f.oldRanges)?(u.push({id:p.UpdateDataValidationMutation.id,params:{unitId:o,subUnitId:s,ruleId:f.ruleId,payload:{type:p.UpdateRuleType.ALL,payload:{formula1:oe,formula2:se,ranges:f.newRanges}}}}),d.unshift({id:p.UpdateDataValidationMutation.id,params:{unitId:o,subUnitId:s,ruleId:f.ruleId,payload:{type:p.UpdateRuleType.ALL,payload:{formula1:f.rule.formula1,formula2:f.rule.formula2,ranges:f.oldRanges}}}})):(u.push({id:p.UpdateDataValidationMutation.id,params:{unitId:o,subUnitId:s,ruleId:f.ruleId,payload:{type:p.UpdateRuleType.RANGE,payload:f.newRanges},source:a}}),d.unshift({id:p.UpdateDataValidationMutation.id,params:{unitId:o,subUnitId:s,ruleId:f.ruleId,payload:{type:p.UpdateRuleType.RANGE,payload:f.oldRanges},source:a}}))}else u.push({id:p.UpdateDataValidationMutation.id,params:{unitId:o,subUnitId:s,ruleId:f.ruleId,payload:{type:p.UpdateRuleType.RANGE,payload:f.newRanges},source:a}}),d.unshift({id:p.UpdateDataValidationMutation.id,params:{unitId:o,subUnitId:s,ruleId:f.ruleId,payload:{type:p.UpdateRuleType.RANGE,payload:f.oldRanges},source:a}});const M=c.getRuleById(o,s,f.ruleId);if(M&&M.type===r.DataValidationType.CHECKBOX){const F=c.getValidator(r.DataValidationType.CHECKBOX).parseFormulaSync(M,o,s);V(f.newRanges,F.formula2)}break}case"add":{if(u.push({id:p.AddDataValidationMutation.id,params:{unitId:o,subUnitId:s,rule:f.rule,source:a}}),d.unshift({id:p.RemoveDataValidationMutation.id,params:{unitId:o,subUnitId:s,ruleId:f.rule.uid,source:a}}),f.rule.type===r.DataValidationType.CHECKBOX){const O=c.getValidator(r.DataValidationType.CHECKBOX).parseFormulaSync(f.rule,o,s);V(f.rule.ranges,O.originFormula2)}break}}}),R){const f={id:D.SetRangeValuesMutation.id,params:{unitId:o,subUnitId:s,cellValue:v.getData()}},M={id:D.SetRangeValuesMutation.id,params:D.SetRangeValuesUndoMutationFactory(t,f.params)};u.push(f),d.push(M)}return{redoMutations:u,undoMutations:d}}const Fe={type:r.CommandType.COMMAND,id:"sheet.command.updateDataValidationRuleRange",handler(o,s){if(!s)return!1;const{unitId:e,subUnitId:t,ranges:a,ruleId:i}=s,n=o.get(m.SheetDataValidationModel),l=o.get(r.ICommandService),u=o.get(r.IUndoRedoService);if(!n.getRuleById(e,t,i))return!1;const c=n.getRuleObjectMatrix(e,t).clone();c.updateRange(i,a);const h=c.diff(n.getRules(e,t)),{redoMutations:g,undoMutations:S}=Y(e,t,h,o);return u.pushUndoRedo({undoMutations:S,redoMutations:g,unitID:e}),r.sequenceExecute(g,l),!0}},Ie={type:r.CommandType.COMMAND,id:"sheet.command.addDataValidation",handler(o,s){if(!s)return!1;const{unitId:e,subUnitId:t,rule:a}=s,i=o.get(m.SheetDataValidationModel),n=o.get(r.ICommandService),l=o.get(r.IUndoRedoService),u=i.getRuleObjectMatrix(e,t).clone();u.addRule(a);const d=u.diff(i.getRules(e,t)),c=i.getValidator(a.type),h={unitId:e,subUnitId:t,rule:{...a,...c==null?void 0:c.normalizeFormula(a,e,t)}},{redoMutations:g,undoMutations:S}=Y(e,t,d,o);return g.push({id:p.AddDataValidationMutation.id,params:h}),S.unshift({id:p.RemoveDataValidationMutation.id,params:{unitId:e,subUnitId:t,ruleId:a.uid}}),l.pushUndoRedo({unitID:e,redoMutations:g,undoMutations:S}),r.sequenceExecute(g,n),!0}},Ee={type:r.CommandType.COMMAND,id:"sheets.command.update-data-validation-setting",handler(o,s){if(!s)return!1;const e=o.get(r.ICommandService),t=o.get(r.IUndoRedoService),a=o.get(m.SheetDataValidationModel),i=o.get(p.DataValidatorRegistryService),{unitId:n,subUnitId:l,ruleId:u,setting:d}=s,c=i.getValidatorItem(d.type);if(!c)return!1;const h=a.getRuleById(n,l,u);if(!h)return!1;const g={...h,...d};if(!c.validatorFormula(g,n,l).success)return!1;const S={unitId:n,subUnitId:l,ruleId:u,payload:{type:p.UpdateRuleType.SETTING,payload:{...d,...c.normalizeFormula(g,n,l)}}},v=[{id:p.UpdateDataValidationMutation.id,params:S}],R={unitId:n,subUnitId:l,ruleId:u,payload:{type:p.UpdateRuleType.SETTING,payload:p.getRuleSetting(h)}},V=[{id:p.UpdateDataValidationMutation.id,params:R}];if(d.type===r.DataValidationType.CHECKBOX){const M=h.ranges,O=o.get(r.IUniverInstanceService),F=D.getSheetCommandTarget(O,{unitId:n,subUnitId:l});if(F){const E=new r.ObjectMatrix,{worksheet:I}=F,{formula2:B=k,formula1:ne=$}=h,{formula2:oe=k,formula1:se=$}=d;let Se=!1;if(M.forEach(le=>{r.Range.foreach(le,(X,fe)=>{const C=I.getCellRaw(X,fe),je=Ve(C);(Oe(C)||je===String(B))&&!(C!=null&&C.p)?(E.setValue(X,fe,{v:oe,p:null}),Se=!0):je===String(ne)&&!(C!=null&&C.p)&&(E.setValue(X,fe,{v:se,p:null}),Se=!0)})}),Se){const le={id:D.SetRangeValuesMutation.id,params:{unitId:n,subUnitId:l,cellValue:E.getData()}},X={id:D.SetRangeValuesMutation.id,params:D.SetRangeValuesUndoMutationFactory(o,le.params)};v.push(le),V.push(X)}}}return r.sequenceExecute(v,e).result?(t.pushUndoRedo({unitID:n,redoMutations:v,undoMutations:V}),!0):!1}},Ce={type:r.CommandType.COMMAND,id:"sheets.command.update-data-validation-options",handler(o,s){if(!s)return!1;const e=o.get(r.ICommandService),t=o.get(r.IUndoRedoService),a=o.get(m.SheetDataValidationModel),{unitId:i,subUnitId:n,ruleId:l,options:u}=s,d=a.getRuleById(i,n,l);if(!d)return!1;const c={unitId:i,subUnitId:n,ruleId:l,payload:{type:p.UpdateRuleType.OPTIONS,payload:u}},h=[{id:p.UpdateDataValidationMutation.id,params:c}],g={unitId:i,subUnitId:n,ruleId:l,payload:{type:p.UpdateRuleType.OPTIONS,payload:p.getRuleOptions(d)}},S=[{id:p.UpdateDataValidationMutation.id,params:g}];return t.pushUndoRedo({unitID:i,redoMutations:h,undoMutations:S}),e.executeCommand(p.UpdateDataValidationMutation.id,c),!0}},Ne={type:r.CommandType.COMMAND,id:"sheets.command.clear-range-data-validation",handler(o,s){if(!s)return!1;const{unitId:e,subUnitId:t,ranges:a}=s,i=o.get(r.ICommandService),n=o.get(r.IUniverInstanceService),l=D.getSheetCommandTarget(n,{unitId:e,subUnitId:t}),u=o.get(m.SheetDataValidationModel);if(!l)return!1;const d=o.get(r.IUndoRedoService),c=u.getRuleObjectMatrix(e,t).clone();c.removeRange(a);const h=c.diff(u.getRules(e,t)),{redoMutations:g,undoMutations:S}=Y(e,t,h,o);return d.pushUndoRedo({unitID:e,redoMutations:g,undoMutations:S}),r.sequenceExecute(g,i).result}},Ae={type:r.CommandType.COMMAND,id:"sheet.command.remove-all-data-validation",handler(o,s){if(!s)return!1;const{unitId:e,subUnitId:t}=s,a=o.get(r.ICommandService),i=o.get(m.SheetDataValidationModel),n=o.get(r.IUndoRedoService),l=[...i.getRules(e,t)],u={unitId:e,subUnitId:t,ruleId:l.map(h=>h.uid)},d=[{id:p.RemoveDataValidationMutation.id,params:u}],c=[{id:p.AddDataValidationMutation.id,params:{unitId:e,subUnitId:t,rule:l}}];return n.pushUndoRedo({redoMutations:d,undoMutations:c,unitID:e}),a.executeCommand(p.RemoveDataValidationMutation.id,u),!0}},it=(o,s)=>{const e=o.get(m.SheetDataValidationModel),{unitId:t,subUnitId:a,ruleId:i,source:n}=s;if(Array.isArray(i)){const u=i.map(d=>e.getRuleById(t,a,d)).filter(Boolean);return[{id:p.AddDataValidationMutation.id,params:{unitId:t,subUnitId:a,rule:u,source:n}}]}return[{id:p.AddDataValidationMutation.id,params:{unitId:t,subUnitId:a,rule:{...e.getRuleById(t,a,i)},index:e.getRuleIndex(t,a,i)}}]},we={type:r.CommandType.COMMAND,id:"sheet.command.remove-data-validation-rule",handler(o,s){if(!s)return!1;const{unitId:e,subUnitId:t,ruleId:a}=s,i=o.get(r.ICommandService),n=o.get(r.IUndoRedoService),l=o.get(m.SheetDataValidationModel),u=[{id:p.RemoveDataValidationMutation.id,params:s}],d=[{id:p.AddDataValidationMutation.id,params:{unitId:e,subUnitId:t,rule:{...l.getRuleById(e,t,a)},index:l.getRuleIndex(e,t,a)}}];return n.pushUndoRedo({undoMutations:d,redoMutations:u,unitID:s.unitId}),i.executeCommand(p.RemoveDataValidationMutation.id,s),!0}},rt="sheets-data-validation.config",Ue={};var nt=Object.getOwnPropertyDescriptor,ot=(o,s,e,t)=>{for(var a=t>1?void 0:t?nt(s,e):s,i=o.length-1,n;i>=0;i--)(n=o[i])&&(a=n(a)||a);return a},he=(o,s)=>(e,t)=>s(e,t,o);let ee=class extends r.Disposable{constructor(s,e,t){super();_(this,"_disposableMap",new Map);_(this,"registerRule",(s,e,t)=>{H(t.type,this._validatorRegistryService)&&this.register(s,e,t)});this._dataValidationModel=s,this._formulaRefRangeService=e,this._validatorRegistryService=t,this._initRefRange()}_getIdWithUnitId(s,e,t){return`${s}_${e}_${t}`}register(s,e,t){const a=t.ranges,i=t.formula1,n=t.formula2,l=this._formulaRefRangeService.registerRangeFormula(s,e,a,[i!=null?i:"",n!=null?n:""],d=>{if(d.length===0)return{undos:[{id:p.AddDataValidationMutation.id,params:{unitId:s,subUnitId:e,rule:t,source:"patched"}}],redos:[{id:p.RemoveDataValidationMutation.id,params:{unitId:s,subUnitId:e,ruleId:t.uid,source:"patched"}}]};const c=[],h=[],g=d[0];c.push({id:p.UpdateDataValidationMutation.id,params:{unitId:s,subUnitId:e,ruleId:t.uid,payload:{type:p.UpdateRuleType.ALL,payload:{ranges:g.ranges,formula1:g.formulas[0],formula2:g.formulas[1]}},source:"patched"}}),h.push({id:p.UpdateDataValidationMutation.id,params:{unitId:s,subUnitId:e,ruleId:t.uid,payload:{type:p.UpdateRuleType.ALL,payload:{ranges:a,formula1:i,formula2:n}},source:"patched"}});for(let S=1;S<d.length;S++){const v=d[S],R=r.generateRandomId();c.push({id:p.AddDataValidationMutation.id,params:{unitId:s,subUnitId:e,rule:{...t,uid:R,formula1:v.formulas[0],formula2:v.formulas[1],ranges:v.ranges},source:"patched"}}),h.push({id:p.RemoveDataValidationMutation.id,params:{unitId:s,subUnitId:e,ruleId:R,source:"patched"}})}return{undos:h,redos:c}}),u=this._getIdWithUnitId(s,e,t.uid);this._disposableMap.set(u,l)}_initRefRange(){const s=this._dataValidationModel.getAll();for(const[e,t]of s)for(const[a,i]of t)for(const n of i)this.registerRule(e,a,n);this.disposeWithMe(this._dataValidationModel.ruleChange$.subscribe(e=>{const{unitId:t,subUnitId:a,rule:i}=e;switch(e.type){case"add":{const n=e.rule;this.registerRule(e.unitId,e.subUnitId,n);break}case"remove":{const n=this._disposableMap.get(this._getIdWithUnitId(t,a,i.uid));n&&n.dispose();break}case"update":{const n=e.rule,l=this._disposableMap.get(this._getIdWithUnitId(t,a,n.uid));l&&l.dispose(),this.registerRule(e.unitId,e.subUnitId,n);break}}})),this.disposeWithMe(r.toDisposable(()=>{this._disposableMap.forEach(e=>{e.dispose()}),this._disposableMap.clear()}))}};ee=ot([he(0,r.Inject(m.SheetDataValidationModel)),he(1,r.Inject(K.FormulaRefRangeService)),he(2,r.Inject(p.DataValidatorRegistryService))],ee);var be=(o=>(o[o.View=0]="View",o[o.Edit=1]="Edit",o[o.ManageCollaborator=2]="ManageCollaborator",o[o.Print=3]="Print",o[o.Duplicate=4]="Duplicate",o[o.Comment=5]="Comment",o[o.Copy=6]="Copy",o[o.Share=7]="Share",o[o.Export=8]="Export",o[o.MoveWorksheet=9]="MoveWorksheet",o[o.DeleteWorksheet=10]="DeleteWorksheet",o[o.HideWorksheet=11]="HideWorksheet",o[o.RenameWorksheet=12]="RenameWorksheet",o[o.CreateWorksheet=13]="CreateWorksheet",o[o.SetWorksheetStyle=14]="SetWorksheetStyle",o[o.EditWorksheetCell=15]="EditWorksheetCell",o[o.InsertHyperlink=16]="InsertHyperlink",o[o.Sort=17]="Sort",o[o.Filter=18]="Filter",o[o.PivotTable=19]="PivotTable",o[o.FloatImg=20]="FloatImg",o[o.History=21]="History",o[o.RwHgtClWdt=22]="RwHgtClWdt",o[o.ViemRwHgtClWdt=23]="ViemRwHgtClWdt",o[o.ViewFilter=24]="ViewFilter",o[o.MoveSheet=25]="MoveSheet",o[o.DeleteSheet=26]="DeleteSheet",o[o.HideSheet=27]="HideSheet",o[o.CopySheet=28]="CopySheet",o[o.RenameSheet=29]="RenameSheet",o[o.CreateSheet=30]="CreateSheet",o[o.SelectProtectedCells=31]="SelectProtectedCells",o[o.SelectUnProtectedCells=32]="SelectUnProtectedCells",o[o.SetCellStyle=33]="SetCellStyle",o[o.SetCellValue=34]="SetCellValue",o[o.SetRowStyle=35]="SetRowStyle",o[o.SetColumnStyle=36]="SetColumnStyle",o[o.InsertRow=37]="InsertRow",o[o.InsertColumn=38]="InsertColumn",o[o.DeleteRow=39]="DeleteRow",o[o.DeleteColumn=40]="DeleteColumn",o[o.EditExtraObject=41]="EditExtraObject",o[o.Delete=42]="Delete",o[o.RecoverHistory=43]="RecoverHistory",o[o.ViewHistory=44]="ViewHistory",o[o.CreatePermissionObject=45]="CreatePermissionObject",o[o.UNRECOGNIZED=-1]="UNRECOGNIZED",o))(be||{}),st=Object.getOwnPropertyDescriptor,lt=(o,s,e,t)=>{for(var a=t>1?void 0:t?st(s,e):s,i=o.length-1,n;i>=0;i--)(n=o[i])&&(a=n(a)||a);return a},ge=(o,s)=>(e,t)=>s(e,t,o);m.DataValidationFormulaController=class extends r.Disposable{constructor(s,e,t){super(),this._univerInstanceService=s,this._permissionService=e,this._lexerTreeBuilder=t}getFormulaRefCheck(s){var t,a;const e=this._lexerTreeBuilder.sequenceNodesBuilder(s);if(!e)return!0;for(let i=0;i<e.length;i++){const n=e[i];if(typeof n=="string")continue;const{token:l}=n,u=T.deserializeRangeWithSheetWithCache(l),d=this._univerInstanceService.getCurrentUnitForType(r.UniverInstanceType.UNIVER_SHEET);let c=d.getActiveSheet();const h=d.getUnitId();if(u.sheetName){if(c=d.getSheetBySheetName(u.sheetName),!c)return!1;const V=c==null?void 0:c.getSheetId();if(!this._permissionService.getPermissionPoint(new D.WorksheetViewPermission(h,V).id))return!1}if(!c)return!1;const{startRow:g,endRow:S,startColumn:v,endColumn:R}=u.range;for(let V=g;V<=S;V++)for(let f=v;f<=R;f++){const M=(a=(t=c.getCell(V,f))==null?void 0:t.selectionProtection)==null?void 0:a[0];if((M==null?void 0:M[be.View])===!1)return!1}}return!0}},m.DataValidationFormulaController=lt([ge(0,r.IUniverInstanceService),ge(1,r.IPermissionService),ge(2,r.Inject(T.LexerTreeBuilder))],m.DataValidationFormulaController);var ut=Object.getOwnPropertyDescriptor,dt=(o,s,e,t)=>{for(var a=t>1?void 0:t?ut(s,e):s,i=o.length-1,n;i>=0;i--)(n=o[i])&&(a=n(a)||a);return a},b=(o,s)=>(e,t)=>s(e,t,o);let te=class extends r.Disposable{constructor(s,e,t,a,i,n){super();_(this,"_disposableMap",new Map);_(this,"registerRule",(s,e,t)=>{H(t.type,this._validatorRegistryService)||(this.register(s,e,t),this.registerFormula(s,e,t))});this._dataValidationModel=s,this._injector=e,this._refRangeService=t,this._dataValidationFormulaService=a,this._formulaRefRangeService=i,this._validatorRegistryService=n,this._initRefRange()}_getIdWithUnitId(s,e,t){return`${s}_${e}_${t}`}registerFormula(s,e,t){var d;const a=t.uid,i=this._getIdWithUnitId(s,e,a),n=(d=this._disposableMap.get(i))!=null?d:new Set,l=(c,h)=>{const g=this._dataValidationModel.getRuleById(s,e,a);if(!g)return{redos:[],undos:[]};const S=g[c];if(!S||S===h)return{redos:[],undos:[]};const v={unitId:s,subUnitId:e,ruleId:t.uid,payload:{type:p.UpdateRuleType.SETTING,payload:{type:g.type,formula1:g.formula1,formula2:g.formula2,[c]:h}},source:"patched"},R={unitId:s,subUnitId:e,ruleId:t.uid,payload:{type:p.UpdateRuleType.SETTING,payload:{type:g.type,formula1:g.formula1,formula2:g.formula2}},source:"patched"},V=[{id:p.UpdateDataValidationMutation.id,params:v}],f=[{id:p.UpdateDataValidationMutation.id,params:R}];return{redos:V,undos:f}},u=this._dataValidationFormulaService.getRuleFormulaInfo(s,e,a);if(u){const[c,h]=u;if(c){const g=this._formulaRefRangeService.registerFormula(s,e,c.text,S=>l("formula1",S));n.add(()=>g.dispose())}if(h){const g=this._formulaRefRangeService.registerFormula(s,e,h.text,S=>l("formula2",S));n.add(()=>g.dispose())}}}register(s,e,t){var u;const a=d=>{const c=[...t.ranges],g=c.map(v=>D.handleCommonDefaultRangeChangeWithEffectRefCommands(v,d)).filter(v=>!!v).flat();if(r.isRangesEqual(g,c))return{redos:[],undos:[]};if(g.length){const v={unitId:s,subUnitId:e,ruleId:t.uid,payload:{type:p.UpdateRuleType.RANGE,payload:g},source:"patched"},R=[{id:p.UpdateDataValidationMutation.id,params:v}],V=[{id:p.UpdateDataValidationMutation.id,params:{unitId:s,subUnitId:e,ruleId:t.uid,payload:{type:p.UpdateRuleType.RANGE,payload:c},source:"patched"}}];return{redos:R,undos:V}}else{const v={unitId:s,subUnitId:e,ruleId:t.uid},R=[{id:p.RemoveDataValidationMutation.id,params:v}],V=it(this._injector,v);return{redos:R,undos:V}}},i=[];t.ranges.forEach(d=>{const c=this._refRangeService.registerRefRange(d,a,s,e);i.push(()=>c.dispose())});const n=this._getIdWithUnitId(s,e,t.uid),l=(u=this._disposableMap.get(n))!=null?u:new Set;l.add(()=>i.forEach(d=>d())),this._disposableMap.set(n,l)}_initRefRange(){const s=this._dataValidationModel.getAll();for(const[e,t]of s)for(const[a,i]of t)for(const n of i)this.registerRule(e,a,n);this.disposeWithMe(this._dataValidationModel.ruleChange$.subscribe(e=>{const{unitId:t,subUnitId:a,rule:i}=e;switch(e.type){case"add":{const n=e.rule;this.registerRule(e.unitId,e.subUnitId,n);break}case"remove":{const n=this._disposableMap.get(this._getIdWithUnitId(t,a,i.uid));n&&n.forEach(l=>l());break}case"update":{const n=e.rule,l=this._disposableMap.get(this._getIdWithUnitId(t,a,n.uid));l&&l.forEach(u=>u()),this.registerRule(e.unitId,e.subUnitId,n);break}}})),this.disposeWithMe(r.toDisposable(()=>{this._disposableMap.forEach(e=>{e.forEach(t=>t())}),this._disposableMap.clear()}))}};te=dt([b(0,r.Inject(m.SheetDataValidationModel)),b(1,r.Inject(r.Injector)),b(2,r.Inject(D.RefRangeService)),b(3,r.Inject(m.DataValidationFormulaService)),b(4,r.Inject(K.FormulaRefRangeService)),b(5,r.Inject(p.DataValidatorRegistryService))],te);var ct=Object.getOwnPropertyDescriptor,mt=(o,s,e,t)=>{for(var a=t>1?void 0:t?ct(s,e):s,i=o.length-1,n;i>=0;i--)(n=o[i])&&(a=n(a)||a);return a},pe=(o,s)=>(e,t)=>s(e,t,o);let ae=class extends r.Disposable{constructor(o,s,e){super(),this._sheetInterceptorService=o,this._univerInstanceService=s,this._sheetDataValidationModel=e,this._initSheetChange()}_initSheetChange(){this.disposeWithMe(this._sheetInterceptorService.interceptCommand({getMutations:o=>{var s;if(o.id===D.RemoveSheetCommand.id){const e=o.params,t=e.unitId||this._univerInstanceService.getCurrentUnitForType(r.UniverInstanceType.UNIVER_SHEET).getUnitId(),a=this._univerInstanceService.getUniverSheetInstance(t);if(!a)return{redos:[],undos:[]};const i=e.subUnitId||((s=a.getActiveSheet())==null?void 0:s.getSheetId());if(!i)return{redos:[],undos:[]};const n=this._sheetDataValidationModel.getRules(t,i);if(n.length===0)return{redos:[],undos:[]};const l=n.map(c=>c.uid),u={unitId:t,subUnitId:i,ruleId:l,source:"patched"},d={unitId:t,subUnitId:i,rule:[...n],source:"patched"};return{redos:[{id:p.RemoveDataValidationMutation.id,params:u}],undos:[{id:p.AddDataValidationMutation.id,params:d}]}}return{redos:[],undos:[]}}}))}};ae=mt([pe(0,r.Inject(D.SheetInterceptorService)),pe(1,r.Inject(r.IUniverInstanceService)),pe(2,r.Inject(m.SheetDataValidationModel))],ae);class ht extends p.BaseDataValidator{constructor(){super(...arguments);_(this,"id",r.DataValidationType.ANY);_(this,"title","dataValidation.any.title");_(this,"operators",[]);_(this,"scopes",["sheet"]);_(this,"offsetFormulaByRange",!1)}async parseFormula(e,t,a){return{formula1:e.formula1,formula2:e.formula2,isFormulaValid:!0}}validatorFormula(e,t,a){return{success:!0}}async isValidType(e,t,a){return!0}generateRuleErrorMessage(e){return this.localeService.t("dataValidation.any.error")}}class gt extends p.BaseDataValidator{constructor(){super(...arguments);_(this,"id",r.DataValidationType.CUSTOM);_(this,"title","dataValidation.custom.title");_(this,"operators",[]);_(this,"scopes",["sheet"]);_(this,"_customFormulaService",this.injector.get(m.DataValidationCustomFormulaService));_(this,"_lexerTreeBuilder",this.injector.get(T.LexerTreeBuilder))}validatorFormula(e,t,a){var d;const i=r.isFormulaString(e.formula1),n=(d=e.formula1)!=null?d:"",u=this._lexerTreeBuilder.checkIfAddBracket(n)===0&&n.startsWith(T.operatorToken.EQUALS);return{success:i&&u,formula1:i&&u?"":this.localeService.t("dataValidation.validFail.formula")}}async parseFormula(e,t,a){return{formula1:void 0,formula2:void 0,isFormulaValid:!0}}async isValidType(e,t,a){const{column:i,row:n,unitId:l,subUnitId:u}=e,d=await this._customFormulaService.getCellFormulaValue(l,u,a.uid,n,i),c=d==null?void 0:d.v;return y(String(c))&&r.Tools.isDefine(c)&&c!==""?d.t===r.CellValueType.BOOLEAN?!!c:typeof c=="boolean"?c:typeof c=="number"?!!c:typeof c=="string"?y(c):!!c:!1}generateRuleErrorMessage(e){return this.localeService.t("dataValidation.custom.error")}generateRuleName(e){var t;return this.localeService.t("dataValidation.custom.ruleName").replace("{FORMULA1}",(t=e.formula1)!=null?t:"")}}class Le extends me{constructor(){super(...arguments);_(this,"id",r.DataValidationType.LIST_MULTIPLE);_(this,"title","dataValidation.listMultiple.title");_(this,"offsetFormulaByRange",!1);_(this,"skipDefaultFontRender",()=>!0)}}class pt extends p.BaseDataValidator{constructor(){super(...arguments);_(this,"_customFormulaService",this.injector.get(m.DataValidationCustomFormulaService));_(this,"_lexerTreeBuilder",this.injector.get(T.LexerTreeBuilder));_(this,"id",r.DataValidationType.WHOLE);_(this,"title","dataValidation.whole.title");_(this,"operators",[r.DataValidationOperator.BETWEEN,r.DataValidationOperator.EQUAL,r.DataValidationOperator.GREATER_THAN,r.DataValidationOperator.GREATER_THAN_OR_EQUAL,r.DataValidationOperator.LESS_THAN,r.DataValidationOperator.LESS_THAN_OR_EQUAL,r.DataValidationOperator.NOT_BETWEEN,r.DataValidationOperator.NOT_EQUAL]);_(this,"scopes",["sheet"])}_isFormulaOrInt(e){return!r.Tools.isBlank(e)&&(r.isFormulaString(e)||!Number.isNaN(+e)&&Number.isInteger(+e))}async isValidType(e,t,a){const{value:i}=e,n=J(i);return!Number.isNaN(n)&&Number.isInteger(n)}transform(e,t,a){const{value:i}=e;return{...e,value:J(i)}}_parseNumber(e){return e==null?Number.NaN:+e}async parseFormula(e,t,a,i,n){const l=await this._customFormulaService.getCellFormulaValue(t,a,e.uid,i,n),u=await this._customFormulaService.getCellFormula2Value(t,a,e.uid,i,n),{formula1:d,formula2:c}=e,h=r.isFormulaString(d)?l==null?void 0:l.v:d,g=r.isFormulaString(c)?u==null?void 0:u.v:c,S=y(`${h}`)&&y(`${g}`);return{formula1:this._parseNumber(h),formula2:this._parseNumber(g),isFormulaValid:S}}validatorFormula(e,t,a){const i=e.operator;if(!i)return{success:!1};const n=r.Tools.isDefine(e.formula1)&&this._isFormulaOrInt(e.formula1),l=r.Tools.isDefine(e.formula2)&&this._isFormulaOrInt(e.formula2),u=z.includes(i),d=this.localeService.t("dataValidation.validFail.number");return u?{success:n&&l,formula1:n?void 0:d,formula2:l?void 0:d}:{success:n,formula1:d}}generateRuleErrorMessage(e,t){if(!e.operator)return this.titleStr;const{transformedFormula1:a,transformedFormula2:i}=Z(this._lexerTreeBuilder,e,t);return`${this.localeService.t(Te[e.operator]).replace(q,a!=null?a:"").replace(Q,i!=null?i:"")}`}}var _t=Object.getOwnPropertyDescriptor,St=(o,s,e,t)=>{for(var a=t>1?void 0:t?_t(s,e):s,i=o.length-1,n;i>=0;i--)(n=o[i])&&(a=n(a)||a);return a},L=(o,s)=>(e,t)=>s(e,t,o);let ie=class extends r.RxDisposable{constructor(o,s,e,t,a,i){super(),this._univerInstanceService=o,this._dataValidatorRegistryService=s,this._injector=e,this._selectionManagerService=t,this._sheetInterceptorService=a,this._sheetDataValidationModel=i,this._init()}_init(){this._registerValidators(),this._initCommandInterceptor()}_registerValidators(){[ht,Ze,pt,at,ye,Me,me,Le,gt].forEach(o=>{const s=this._injector.createInstance(o);this.disposeWithMe(this._dataValidatorRegistryService.register(s)),this.disposeWithMe(r.toDisposable(()=>this._injector.delete(o)))})}_initCommandInterceptor(){this._sheetInterceptorService.interceptCommand({getMutations:o=>{var s;if(o.id===D.ClearSelectionAllCommand.id){const e=this._univerInstanceService.getCurrentUnitForType(r.UniverInstanceType.UNIVER_SHEET),t=e.getUnitId(),a=e.getActiveSheet();if(!a)throw new Error("No active sheet found");const i=a.getSheetId(),n=(s=this._selectionManagerService.getCurrentSelections())==null?void 0:s.map(h=>h.range),l=this._sheetDataValidationModel.getRuleObjectMatrix(t,i).clone();n&&l.removeRange(n);const u=l.diff(this._sheetDataValidationModel.getRules(t,i)),{redoMutations:d,undoMutations:c}=Y(t,i,u,this._injector,"patched");return{undos:c,redos:d}}return{undos:[],redos:[]}}})}};ie=St([L(0,r.IUniverInstanceService),L(1,r.Inject(p.DataValidatorRegistryService)),L(2,r.Inject(r.Injector)),L(3,r.Inject(D.SheetsSelectionsService)),L(4,r.Inject(D.SheetInterceptorService)),L(5,r.Inject(m.SheetDataValidationModel))],ie);var ft=Object.getOwnPropertyDescriptor,vt=(o,s,e,t)=>{for(var a=t>1?void 0:t?ft(s,e):s,i=o.length-1,n;i>=0;i--)(n=o[i])&&(a=n(a)||a);return a},re=(o,s)=>(e,t)=>s(e,t,o);m.SheetsDataValidationValidatorService=class extends r.Disposable{constructor(s,e,t,a){super(),this._univerInstanceService=s,this._sheetDataValidationModel=e,this._dataValidationCacheService=t,this._lifecycleService=a,this._initRecalculate()}_initRecalculate(){const s=e=>{if(e.length===0)return;const t=this._univerInstanceService.getCurrentUnitForType(r.UniverInstanceType.UNIVER_SHEET),a=t==null?void 0:t.getActiveSheet(),i={};e.flat().forEach(n=>{i[n.unitId]||(i[n.unitId]={}),i[n.unitId][n.subUnitId]||(i[n.unitId][n.subUnitId]=[]);const l=this._univerInstanceService.getUnit(n.unitId,r.UniverInstanceType.UNIVER_SHEET),u=l==null?void 0:l.getSheetBySheetId(n.subUnitId);u&&i[n.unitId][n.subUnitId].push(...n.ranges.map(d=>r.Range.transformRange(d,u)))}),Object.entries(i).forEach(([n,l])=>{Object.entries(l).forEach(([u,d])=>{(t==null?void 0:t.getUnitId())===n&&(a==null?void 0:a.getSheetId())===u?this.validatorRanges(n,u,d):requestIdleCallback(()=>{this.validatorRanges(n,u,d)})})})};this.disposeWithMe(this._dataValidationCacheService.dirtyRanges$.pipe(A.bufferWhen(()=>this._lifecycleService.lifecycle$.pipe(A.filter(e=>e===r.LifecycleStages.Rendered)))).subscribe(s)),this.disposeWithMe(this._dataValidationCacheService.dirtyRanges$.pipe(A.filter(()=>this._lifecycleService.stage>=r.LifecycleStages.Rendered),r.bufferDebounceTime(20)).subscribe(s))}async _validatorByCell(s,e,t,a){const i=s.getUnitId(),n=e.getSheetId();if(!r.Tools.isDefine(t)||!r.Tools.isDefine(a))throw new Error(`row or col is not defined, row: ${t}, col: ${a}`);const l=this._sheetDataValidationModel.getRuleByLocation(i,n,t,a);return l?new Promise(u=>{this._sheetDataValidationModel.validator(l,{unitId:i,subUnitId:n,row:t,col:a,worksheet:e,workbook:s},d=>{u(d)})}):r.DataValidationStatus.VALID}async validatorCell(s,e,t,a){const i=this._univerInstanceService.getUnit(s,r.UniverInstanceType.UNIVER_SHEET);if(!i)throw new Error(`cannot find current workbook, unitId: ${s}`);const n=i.getSheetBySheetId(e);if(!n)throw new Error(`cannot find current worksheet, sheetId: ${e}`);return this._validatorByCell(i,n,t,a)}validatorRanges(s,e,t){if(!t.length)return Promise.resolve([]);const a=this._univerInstanceService.getUnit(s,r.UniverInstanceType.UNIVER_SHEET);if(!a)throw new Error(`cannot find current workbook, unitId: ${s}`);const i=a.getSheetBySheetId(e);if(!i)throw new Error(`cannot find current worksheet, sheetId: ${e}`);return Promise.all(t.map(n=>{const l=[];return r.Range.foreach(n,(u,d)=>{l.push(this._validatorByCell(a,i,u,d))}),Promise.all(l)}))}async validatorWorksheet(s,e){const t=this._univerInstanceService.getUnit(s,r.UniverInstanceType.UNIVER_SHEET);if(!t)throw new Error(`cannot find current workbook, unitId: ${s}`);const a=t.getSheetBySheetId(e);if(!a)throw new Error(`cannot find current worksheet, sheetId: ${e}`);const i=this._sheetDataValidationModel.getRules(s,e);return await Promise.all(i.map(n=>Promise.all(n.ranges.map(l=>{const u=[];return r.Range.foreach(l,(d,c)=>{u.push(this._validatorByCell(t,a,d,c))}),u})))),this._dataValidationCacheService.ensureCache(s,e)}async validatorWorkbook(s){const e=this._sheetDataValidationModel.getSubUnitIds(s),t=await Promise.all(e.map(i=>this.validatorWorksheet(s,i))),a={};return t.forEach((i,n)=>{a[e[n]]=i}),a}getDataValidations(s,e,t){const a=this._sheetDataValidationModel.getRuleObjectMatrix(s,e),i=new Set;return t.forEach(l=>{r.Range.foreach(l,(u,d)=>{const c=a.getValue(u,d);c&&i.add(c)})}),Array.from(i).map(l=>this._sheetDataValidationModel.getRuleById(s,e,l)).filter(Boolean)}getDataValidation(s,e,t){return this.getDataValidations(s,e,t)[0]}},m.SheetsDataValidationValidatorService=vt([re(0,r.IUniverInstanceService),re(1,r.Inject(m.SheetDataValidationModel)),re(2,r.Inject(m.DataValidationCacheService)),re(3,r.Inject(r.LifecycleService))],m.SheetsDataValidationValidatorService);var Rt=Object.defineProperty,Vt=Object.getOwnPropertyDescriptor,Dt=(o,s,e)=>s in o?Rt(o,s,{enumerable:!0,configurable:!0,writable:!0,value:e}):o[s]=e,Mt=(o,s,e,t)=>{for(var a=t>1?void 0:t?Vt(s,e):s,i=o.length-1,n;i>=0;i--)(n=o[i])&&(a=n(a)||a);return a},_e=(o,s)=>(e,t)=>s(e,t,o),Be=(o,s,e)=>Dt(o,typeof s!="symbol"?s+"":s,e);m.UniverSheetsDataValidationPlugin=class extends r.Plugin{constructor(s=Ue,e,t,a){super(),this._config=s,this._injector=e,this._commandService=t,this._configService=a;const{...i}=r.merge({},Ue,this._config);this._configService.setConfig(rt,i)}onStarting(){[[m.DataValidationCacheService],[m.DataValidationFormulaService],[m.DataValidationCustomFormulaService],[m.SheetsDataValidationValidatorService],[m.SheetDataValidationModel],[ie],[m.DataValidationFormulaController],[ae],[te],[ee]].forEach(s=>{this._injector.add(s)}),[Ie,Fe,Ee,Ce,we,Ae,Ne].forEach(s=>{this._commandService.registerCommand(s)}),this._injector.get(m.DataValidationCacheService),this._injector.get(m.SheetsDataValidationValidatorService),this._injector.get(ie),this._injector.get(ee),this._injector.get(te)}onReady(){this._injector.get(ae)}onRendered(){this._injector.get(m.DataValidationFormulaController)}},Be(m.UniverSheetsDataValidationPlugin,"pluginName",ve),Be(m.UniverSheetsDataValidationPlugin,"type",r.UniverInstanceType.UNIVER_SHEET),m.UniverSheetsDataValidationPlugin=Mt([r.DependentOn(p.UniverDataValidationPlugin),_e(1,r.Inject(r.Injector)),_e(2,r.ICommandService),_e(3,r.IConfigService)],m.UniverSheetsDataValidationPlugin);function yt(o){const e=o.get(D.SheetsSelectionsService).getCurrentSelections().map(i=>i.range);return{uid:r.Tools.generateRandomId(6),type:r.DataValidationType.DECIMAL,operator:r.DataValidationOperator.EQUAL,formula1:"100",ranges:e!=null?e:[{startColumn:0,endColumn:0,startRow:0,endRow:0}]}}m.AddSheetDataValidationCommand=Ie,m.CHECKBOX_FORMULA_1=$,m.CHECKBOX_FORMULA_2=k,m.CheckboxValidator=Me,m.ClearRangeDataValidationCommand=Ne,m.DATA_VALIDATION_PLUGIN_NAME=ve,m.DateValidator=ye,m.ListMultipleValidator=Le,m.ListValidator=me,m.RemoveSheetAllDataValidationCommand=Ae,m.RemoveSheetDataValidationCommand=we,m.UpdateSheetDataValidationOptionsCommand=Ce,m.UpdateSheetDataValidationRangeCommand=Fe,m.UpdateSheetDataValidationSettingCommand=Ee,m.createDefaultNewRule=yt,m.deserializeListOptions=G,m.getCellValueOrigin=U,m.getDataValidationCellValue=ze,m.getDataValidationDiffMutations=Y,m.getFormulaCellData=j,m.getFormulaResult=w,m.isLegalFormulaResult=y,m.serializeListOptions=Ke,m.transformCheckboxValue=x,Object.defineProperty(m,Symbol.toStringTag,{value:"Module"})});


// @univerjs/sheets-data-validation/facade
(function(d,n){typeof exports=="object"&&typeof module<"u"?n(exports,require("@univerjs/sheets-data-validation"),require("@univerjs/sheets/facade"),require("@univerjs/core"),require("@univerjs/data-validation"),require("@univerjs/engine-formula"),require("@univerjs/core/facade"),require("rxjs")):typeof define=="function"&&define.amd?define(["exports","@univerjs/sheets-data-validation","@univerjs/sheets/facade","@univerjs/core","@univerjs/data-validation","@univerjs/engine-formula","@univerjs/core/facade","rxjs"],n):(d=typeof globalThis<"u"?globalThis:d||self,n(d.UniverSheetsDataValidationFacade={},d.UniverSheetsDataValidation,d.UniverSheetsFacade,d.UniverCore,d.UniverDataValidation,d.UniverEngineFormula,d.UniverCoreFacade,d.rxjs))})(this,function(d,n,m,a,S,w,E,I){"use strict";var A=Object.defineProperty;var O=(d,n,m)=>n in d?A(d,n,{enumerable:!0,configurable:!0,writable:!0,value:m}):d[n]=m;var f=(d,n,m)=>O(d,typeof n!="symbol"?n+"":n,m);class p{constructor(t){f(this,"_rule");this._rule=t!=null?t:{uid:a.generateRandomId(),ranges:void 0,type:a.DataValidationType.CUSTOM}}build(){return new g(this._rule)}copy(){return new p({...this._rule,uid:a.generateRandomId()})}getAllowInvalid(){return this._rule.errorStyle!==a.DataValidationErrorStyle.STOP}getCriteriaType(){return this._rule.type}getCriteriaValues(){return[this._rule.operator,this._rule.formula1,this._rule.formula2]}getHelpText(){return this._rule.error}requireCheckbox(t,e){return this._rule.type=a.DataValidationType.CHECKBOX,this._rule.formula1=t,this._rule.formula2=e,this}requireDateAfter(t){return this._rule.type=a.DataValidationType.DATE,this._rule.formula1=t.toLocaleDateString(),this._rule.operator=a.DataValidationOperator.GREATER_THAN,this}requireDateBefore(t){return this._rule.type=a.DataValidationType.DATE,this._rule.formula1=t.toLocaleDateString(),this._rule.formula2=void 0,this._rule.operator=a.DataValidationOperator.LESS_THAN,this}requireDateBetween(t,e){return this._rule.type=a.DataValidationType.DATE,this._rule.formula1=t.toLocaleDateString(),this._rule.formula2=e.toLocaleDateString(),this._rule.operator=a.DataValidationOperator.BETWEEN,this}requireDateEqualTo(t){return this._rule.type=a.DataValidationType.DATE,this._rule.formula1=t.toLocaleDateString(),this._rule.formula2=void 0,this._rule.operator=a.DataValidationOperator.EQUAL,this}requireDateNotBetween(t,e){return this._rule.type=a.DataValidationType.DATE,this._rule.formula1=t.toLocaleDateString(),this._rule.formula2=e.toLocaleDateString(),this._rule.operator=a.DataValidationOperator.NOT_BETWEEN,this}requireDateOnOrAfter(t){return this._rule.type=a.DataValidationType.DATE,this._rule.formula1=t.toLocaleDateString(),this._rule.formula2=void 0,this._rule.operator=a.DataValidationOperator.GREATER_THAN_OR_EQUAL,this}requireDateOnOrBefore(t){return this._rule.type=a.DataValidationType.DATE,this._rule.formula1=t.toLocaleDateString(),this._rule.formula2=void 0,this._rule.operator=a.DataValidationOperator.LESS_THAN_OR_EQUAL,this}requireFormulaSatisfied(t){return this._rule.type=a.DataValidationType.CUSTOM,this._rule.formula1=t,this._rule.formula2=void 0,this}requireNumberBetween(t,e,r){return this._rule.formula1=`${t}`,this._rule.formula2=`${e}`,this._rule.operator=a.DataValidationOperator.BETWEEN,this._rule.type=r?a.DataValidationType.WHOLE:a.DataValidationType.DECIMAL,this}requireNumberEqualTo(t,e){return this._rule.formula1=`${t}`,this._rule.formula2=void 0,this._rule.operator=a.DataValidationOperator.EQUAL,this._rule.type=e?a.DataValidationType.WHOLE:a.DataValidationType.DECIMAL,this}requireNumberGreaterThan(t,e){return this._rule.formula1=`${t}`,this._rule.formula2=void 0,this._rule.operator=a.DataValidationOperator.GREATER_THAN,this._rule.type=e?a.DataValidationType.WHOLE:a.DataValidationType.DECIMAL,this}requireNumberGreaterThanOrEqualTo(t,e){return this._rule.formula1=`${t}`,this._rule.formula2=void 0,this._rule.operator=a.DataValidationOperator.GREATER_THAN_OR_EQUAL,this._rule.type=e?a.DataValidationType.WHOLE:a.DataValidationType.DECIMAL,this}requireNumberLessThan(t,e){return this._rule.formula1=`${t}`,this._rule.formula2=void 0,this._rule.operator=a.DataValidationOperator.LESS_THAN,this._rule.type=e?a.DataValidationType.WHOLE:a.DataValidationType.DECIMAL,this}requireNumberLessThanOrEqualTo(t,e){return this._rule.formula1=`${t}`,this._rule.formula2=void 0,this._rule.operator=a.DataValidationOperator.LESS_THAN_OR_EQUAL,this._rule.type=e?a.DataValidationType.WHOLE:a.DataValidationType.DECIMAL,this}requireNumberNotBetween(t,e,r){return this._rule.formula1=`${t}`,this._rule.formula2=`${e}`,this._rule.operator=a.DataValidationOperator.NOT_BETWEEN,this._rule.type=r?a.DataValidationType.WHOLE:a.DataValidationType.DECIMAL,this}requireNumberNotEqualTo(t,e){return this._rule.formula1=`${t}`,this._rule.formula2=void 0,this._rule.operator=a.DataValidationOperator.NOT_EQUAL,this._rule.type=e?a.DataValidationType.WHOLE:a.DataValidationType.DECIMAL,this}requireValueInList(t,e,r){return this._rule.type=e?a.DataValidationType.LIST_MULTIPLE:a.DataValidationType.LIST,this._rule.formula1=t.join(","),this._rule.formula2=void 0,this._rule.showDropDown=r!=null?r:!0,this}requireValueInRange(t,e,r){return this._rule.type=e?a.DataValidationType.LIST_MULTIPLE:a.DataValidationType.LIST,this._rule.formula1=`=${w.serializeRangeToRefString({unitId:t.getUnitId(),sheetName:t.getSheetName(),range:t.getRange()})}`,this._rule.formula2=void 0,this._rule.showDropDown=r!=null?r:!0,this}setAllowInvalid(t){return this._rule.errorStyle=t?a.DataValidationErrorStyle.WARNING:a.DataValidationErrorStyle.STOP,this}setAllowBlank(t){return this._rule.allowBlank=t,this}setOptions(t){return Object.assign(this._rule,t),this}}class g{constructor(t,e,r){f(this,"rule");f(this,"_worksheet");f(this,"_injector");this._injector=r,this.rule=t,this._worksheet=e}getAllowInvalid(){return this.rule.errorStyle!==a.DataValidationErrorStyle.STOP}getCriteriaType(){return this.rule.type}getCriteriaValues(){return[this.rule.operator,this.rule.formula1,this.rule.formula2]}getHelpText(){return this.rule.error}copy(){return new p(this.rule)}getApplied(){if(!this._worksheet)return!1;const e=this._injector.get(S.DataValidationModel).getRuleById(this._worksheet.getUnitId(),this._worksheet.getSheetId(),this.rule.uid);return!!(e&&e.ranges.length)}getRanges(){if(!this.getApplied())return[];const t=this._injector.get(a.IUniverInstanceService).getUnit(this._worksheet.getUnitId());return this.rule.ranges.map(e=>this._injector.createInstance(m.FRange,t,this._worksheet,e))}getUnitId(){var t;return(t=this._worksheet)==null?void 0:t.getUnitId()}getSheetId(){var t;return(t=this._worksheet)==null?void 0:t.getSheetId()}setCriteria(t,e,r=!0){if(this.getApplied()&&!this._injector.get(a.ICommandService).syncExecuteCommand(n.UpdateSheetDataValidationSettingCommand.id,{unitId:this.getUnitId(),subUnitId:this.getSheetId(),ruleId:this.rule.uid,setting:{operator:e[0],formula1:e[1],formula2:e[2],type:this.rule.type,allowBlank:r}}))throw new Error("setCriteria failed");return this.rule.operator=e[0],this.rule.formula1=e[1],this.rule.formula2=e[2],this.rule.type=t,this.rule.allowBlank=r,this}setOptions(t){if(this.getApplied()&&!this._injector.get(a.ICommandService).syncExecuteCommand(n.UpdateSheetDataValidationOptionsCommand.id,{unitId:this.getUnitId(),subUnitId:this.getSheetId(),ruleId:this.rule.uid,options:{...S.getRuleOptions(this.rule),...t}}))throw new Error("setOptions failed");return Object.assign(this.rule,t),this}setRanges(t){if(this.getApplied()&&!this._injector.get(a.ICommandService).syncExecuteCommand(n.UpdateSheetDataValidationRangeCommand.id,{unitId:this.getUnitId(),subUnitId:this.getSheetId(),ruleId:this.rule.uid,ranges:t.map(i=>i.getRange())}))throw new Error("setRanges failed");return this.rule.ranges=t.map(e=>e.getRange()),this}delete(){return this.getApplied()?this._injector.get(a.ICommandService).syncExecuteCommand(n.RemoveSheetDataValidationCommand.id,{unitId:this.getUnitId(),subUnitId:this.getSheetId(),ruleId:this.rule.uid}):!1}}class C extends m.FRange{setDataValidation(t){if(!t)return this._commandService.syncExecuteCommand(n.ClearRangeDataValidationCommand.id,{unitId:this._workbook.getUnitId(),subUnitId:this._worksheet.getSheetId(),ranges:[this._range]}),this;const e={unitId:this._workbook.getUnitId(),subUnitId:this._worksheet.getSheetId(),rule:{...t.rule,ranges:[this._range]}};return this._commandService.syncExecuteCommand(n.AddSheetDataValidationCommand.id,e),this}getDataValidation(){const e=this._injector.get(n.SheetsDataValidationValidatorService).getDataValidation(this._workbook.getUnitId(),this._worksheet.getSheetId(),[this._range]);return e&&new g(e,this._worksheet,this._injector)}getDataValidations(){return this._injector.get(n.SheetsDataValidationValidatorService).getDataValidations(this._workbook.getUnitId(),this._worksheet.getSheetId(),[this._range]).map(e=>new g(e,this._worksheet,this._injector))}async getValidatorStatus(){return this._injector.get(n.SheetsDataValidationValidatorService).validatorRanges(this._workbook.getUnitId(),this._worksheet.getSheetId(),[this._range])}}m.FRange.extend(C);class T extends E.FUniver{static newDataValidation(){return new p}newDataValidation(){return new p}_initialize(t){const e=t.get(a.ICommandService);this.registerEventHandler(this.Event.SheetDataValidationChanged,()=>t.has(n.SheetDataValidationModel)?t.get(n.SheetDataValidationModel).ruleChange$.subscribe(i=>{const{unitId:o,subUnitId:u,rule:l,oldRule:s,type:h}=i,D=this.getSheetTarget(o,u);if(!D)return;const{workbook:V,worksheet:c}=D,v=new g(l,c.getSheet(),this._injector);this.fireEvent(this.Event.SheetDataValidationChanged,{origin:i,worksheet:c,workbook:V,changeType:h,oldRule:s,rule:v})}):{dispose:()=>{}}),this.registerEventHandler(this.Event.SheetDataValidatorStatusChanged,()=>t.has(n.SheetDataValidationModel)?t.get(n.SheetDataValidationModel).validStatusChange$.subscribe(i=>{const{unitId:o,subUnitId:u,ruleId:l,status:s,row:h,col:D}=i,V=this.getSheetTarget(o,u);if(!V)return;const{workbook:c,worksheet:v}=V,k=v.getDataValidation(l);k&&this.fireEvent(this.Event.SheetDataValidatorStatusChanged,{workbook:c,worksheet:v,row:h,column:D,rule:k,status:s})}):{dispose:()=>{}}),this.registerEventHandler(this.Event.BeforeSheetDataValidationAdd,()=>e.beforeCommandExecuted(r=>{if(r.id===n.AddSheetDataValidationCommand.id){const i=r.params,o=this.getSheetTarget(i.unitId,i.subUnitId);if(!o)return;const{workbook:u,worksheet:l}=o,s={worksheet:l,workbook:u,rule:i.rule};if(this.fireEvent(this.Event.BeforeSheetDataValidationAdd,s),s.cancel)throw new a.CanceledError}})),this.registerEventHandler(this.Event.BeforeSheetDataValidationCriteriaUpdate,()=>e.beforeCommandExecuted(r=>{if(r.id===n.UpdateSheetDataValidationSettingCommand.id){const i=r.params,o=this.getSheetTarget(i.unitId,i.subUnitId);if(!o)return;const{workbook:u,worksheet:l}=o,s=l.getDataValidation(i.ruleId);if(!s)return;const h={worksheet:l,workbook:u,rule:s,ruleId:i.ruleId,newCriteria:i.setting};if(this.fireEvent(this.Event.BeforeSheetDataValidationCriteriaUpdate,h),h.cancel)throw new a.CanceledError}})),this.registerEventHandler(this.Event.BeforeSheetDataValidationRangeUpdate,()=>e.beforeCommandExecuted(r=>{if(r.id===n.UpdateSheetDataValidationRangeCommand.id){const i=r.params,o=this.getSheetTarget(i.unitId,i.subUnitId);if(!o)return;const{workbook:u,worksheet:l}=o,s=l.getDataValidation(i.ruleId);if(!s)return;const h={worksheet:l,workbook:u,rule:s,ruleId:i.ruleId,newRanges:i.ranges};if(this.fireEvent(this.Event.BeforeSheetDataValidationRangeUpdate,h),h.cancel)throw new a.CanceledError}})),this.registerEventHandler(this.Event.BeforeSheetDataValidationOptionsUpdate,()=>e.beforeCommandExecuted(r=>{if(r.id===n.UpdateSheetDataValidationOptionsCommand.id){const i=r.params,o=this.getSheetTarget(i.unitId,i.subUnitId);if(!o)return;const{workbook:u,worksheet:l}=o,s=l.getDataValidation(i.ruleId);if(!s)return;const h={worksheet:l,workbook:u,rule:s,ruleId:i.ruleId,newOptions:i.options};if(this.fireEvent(this.Event.BeforeSheetDataValidationOptionsUpdate,h),h.cancel)throw new a.CanceledError}})),this.registerEventHandler(this.Event.BeforeSheetDataValidationDelete,()=>e.beforeCommandExecuted(r=>{if(r.id===n.RemoveSheetDataValidationCommand.id){const i=r.params,o=this.getSheetTarget(i.unitId,i.subUnitId);if(!o)return;const{workbook:u,worksheet:l}=o,s=l.getDataValidation(i.ruleId);if(!s)return;const h={worksheet:l,workbook:u,rule:s,ruleId:i.ruleId};if(this.fireEvent(this.Event.BeforeSheetDataValidationDelete,h),h.cancel)throw new a.CanceledError}})),this.registerEventHandler(this.Event.BeforeSheetDataValidationDeleteAll,()=>e.beforeCommandExecuted(r=>{if(r.id===n.RemoveSheetAllDataValidationCommand.id){const i=r.params,o=this.getSheetTarget(i.unitId,i.subUnitId);if(!o)return;const{workbook:u,worksheet:l}=o,s={worksheet:l,workbook:u,rules:l.getDataValidations()};if(this.fireEvent(this.Event.BeforeSheetDataValidationDeleteAll,s),s.cancel)throw new a.CanceledError}}))}}E.FUniver.extend(T);class U extends m.FWorkbook{_initialize(){Object.defineProperty(this,"_dataValidationModel",{get(){return this._injector.get(n.SheetDataValidationModel)}})}getValidatorStatus(){return this._injector.get(n.SheetsDataValidationValidatorService).validatorWorkbook(this._workbook.getUnitId())}onDataValidationChange(t){return a.toDisposable(this._dataValidationModel.ruleChange$.pipe(I.filter(e=>e.unitId===this._workbook.getUnitId())).subscribe(t))}onDataValidationStatusChange(t){return a.toDisposable(this._dataValidationModel.validStatusChange$.pipe(I.filter(e=>e.unitId===this._workbook.getUnitId())).subscribe(t))}onBeforeAddDataValidation(t){return a.toDisposable(this._commandService.beforeCommandExecuted((e,r)=>{const i=e.params;if(e.id===n.AddSheetDataValidationCommand.id){if(i.unitId!==this._workbook.getUnitId())return;if(t(i,r)===!1)throw new Error("Command is stopped by the hook onBeforeAddDataValidation")}}))}onBeforeUpdateDataValidationCriteria(t){return a.toDisposable(this._commandService.beforeCommandExecuted((e,r)=>{const i=e.params;if(e.id===n.UpdateSheetDataValidationSettingCommand.id){if(i.unitId!==this._workbook.getUnitId())return;if(t(i,r)===!1)throw new Error("Command is stopped by the hook onBeforeUpdateDataValidationCriteria")}}))}onBeforeUpdateDataValidationRange(t){return a.toDisposable(this._commandService.beforeCommandExecuted((e,r)=>{const i=e.params;if(e.id===n.UpdateSheetDataValidationRangeCommand.id){if(i.unitId!==this._workbook.getUnitId())return;if(t(i,r)===!1)throw new Error("Command is stopped by the hook onBeforeUpdateDataValidationRange")}}))}onBeforeUpdateDataValidationOptions(t){return a.toDisposable(this._commandService.beforeCommandExecuted((e,r)=>{const i=e.params;if(e.id===n.UpdateSheetDataValidationOptionsCommand.id){if(i.unitId!==this._workbook.getUnitId())return;if(t(i,r)===!1)throw new Error("Command is stopped by the hook onBeforeUpdateDataValidationOptions")}}))}onBeforeDeleteDataValidation(t){return a.toDisposable(this._commandService.beforeCommandExecuted((e,r)=>{const i=e.params;if(e.id===n.RemoveSheetDataValidationCommand.id){if(i.unitId!==this._workbook.getUnitId())return;if(t(i,r)===!1)throw new Error("Command is stopped by the hook onBeforeDeleteDataValidation")}}))}onBeforeDeleteAllDataValidation(t){return a.toDisposable(this._commandService.beforeCommandExecuted((e,r)=>{const i=e.params;if(e.id===n.RemoveSheetAllDataValidationCommand.id){if(i.unitId!==this._workbook.getUnitId())return;if(t(i,r)===!1)throw new Error("Command is stopped by the hook onBeforeDeleteAllDataValidation")}}))}}m.FWorkbook.extend(U);class y extends m.FWorksheet{getDataValidations(){return this._injector.get(S.DataValidationModel).getRules(this._workbook.getUnitId(),this._worksheet.getSheetId()).map(e=>new g(e,this._worksheet,this._injector))}getValidatorStatus(){return this._injector.get(n.SheetsDataValidationValidatorService).validatorWorksheet(this._workbook.getUnitId(),this._worksheet.getSheetId())}getValidatorStatusAsync(){return this.getValidatorStatus()}getDataValidation(t){const r=this._injector.get(S.DataValidationModel).getRuleById(this._workbook.getUnitId(),this._worksheet.getSheetId(),t);return r?new g(r,this._worksheet,this._injector):null}}m.FWorksheet.extend(y);class b{get SheetDataValidationChanged(){return"SheetDataValidationChanged"}get SheetDataValidatorStatusChanged(){return"SheetDataValidatorStatusChanged"}get BeforeSheetDataValidationAdd(){return"BeforeSheetDataValidationAdd"}get BeforeSheetDataValidationDelete(){return"BeforeSheetDataValidationDelete"}get BeforeSheetDataValidationDeleteAll(){return"BeforeSheetDataValidationDeleteAll"}get BeforeSheetDataValidationCriteriaUpdate(){return"BeforeSheetDataValidationCriteriaUpdate"}get BeforeSheetDataValidationRangeUpdate(){return"BeforeSheetDataValidationRangeUpdate"}get BeforeSheetDataValidationOptionsUpdate(){return"BeforeSheetDataValidationOptionsUpdate"}}E.FEventName.extend(b),d.FDataValidation=g,d.FDataValidationBuilder=p,Object.defineProperty(d,Symbol.toStringTag,{value:"Module"})});


// @univerjs/sheets-data-validation-ui/index
(function(x,u){typeof exports=="object"&&typeof module<"u"?u(exports,require("react/jsx-runtime"),require("@univerjs/core"),require("@univerjs/design"),require("@univerjs/engine-render"),require("@univerjs/sheets"),require("@univerjs/sheets-data-validation"),require("@univerjs/sheets-numfmt"),require("@univerjs/sheets-ui"),require("@univerjs/ui"),require("react"),require("@univerjs/data-validation"),require("@univerjs/docs"),require("rxjs"),require("@univerjs/engine-formula"),require("@univerjs/sheets-formula-ui")):typeof define=="function"&&define.amd?define(["exports","react/jsx-runtime","@univerjs/core","@univerjs/design","@univerjs/engine-render","@univerjs/sheets","@univerjs/sheets-data-validation","@univerjs/sheets-numfmt","@univerjs/sheets-ui","@univerjs/ui","react","@univerjs/data-validation","@univerjs/docs","rxjs","@univerjs/engine-formula","@univerjs/sheets-formula-ui"],u):(x=typeof globalThis<"u"?globalThis:x||self,u(x.UniverSheetsDataValidationUi={},x.React,x.UniverCore,x.UniverDesign,x.UniverEngineRender,x.UniverSheets,x.UniverSheetsDataValidation,x.UniverSheetsNumfmt,x.UniverSheetsUi,x.UniverUi,x.React,x.UniverDataValidation,x.UniverDocs,x.rxjs,x.UniverEngineFormula,x.UniverSheetsFormulaUi))})(this,function(x,u,r,L,k,X,E,Kt,$,f,V,J,Gt,ie,tt,nt){"use strict";var Ta=Object.defineProperty;var Oa=(x,u,r)=>u in x?Ta(x,u,{enumerable:!0,configurable:!0,writable:!0,value:r}):x[u]=r;var R=(x,u,r)=>Oa(x,typeof u!="symbol"?u+"":u,r);var Qe,et;var qt=Object.getOwnPropertyDescriptor,Zt=(e,t,a,n)=>{for(var o=n>1?void 0:n?qt(t,a):t,i=e.length-1,s;i>=0;i--)(s=e[i])&&(o=s(o)||o);return o},we=(e,t)=>(a,n)=>t(a,n,e);let Ae=class extends r.Disposable{constructor(e,t,a,n,o,i){super(),this._sheetInterceptorService=e,this._dataValidationModel=t,this._dataValidatorRegistryService=a,this._dialogService=n,this._localeService=o,this._sheetsDataValidationValidatorService=i,this._initEditorBridgeInterceptor()}_initEditorBridgeInterceptor(){this._sheetInterceptorService.writeCellInterceptor.intercept(X.VALIDATE_CELL,{handler:async(e,t,a)=>{const n=await e,{row:o,col:i,unitId:s,subUnitId:l}=t,d=this._dataValidationModel.getRuleIdByLocation(s,l,o,i),h=d?this._dataValidationModel.getRuleById(s,l,d):void 0;if(n===!1)return a(Promise.resolve(!1));if(!h||h.errorStyle!==r.DataValidationErrorStyle.STOP)return a(Promise.resolve(!0));const p=this._dataValidatorRegistryService.getValidatorItem(h.type);return!p||await this._sheetsDataValidationValidatorService.validatorCell(s,l,o,i)===r.DataValidationStatus.VALID?a(Promise.resolve(!0)):(this._dialogService.open({width:368,title:{title:this._localeService.t("dataValidation.alert.title")},id:"reject-input-dialog",children:{title:p.getRuleFinalError(h,{row:o,col:i,unitId:s,subUnitId:l})},footer:{title:V.createElement(L.Button,{type:"primary",onClick:()=>this._dialogService.close("reject-input-dialog")},this._localeService.t("dataValidation.alert.ok"))},onClose:()=>{this._dialogService.close("reject-input-dialog")}}),a(Promise.resolve(!1)))}})}showReject(e){this._dialogService.open({width:368,title:{title:this._localeService.t("dataValidation.alert.title")},id:"reject-input-dialog",children:{title:e},footer:{title:V.createElement(L.Button,{type:"primary",onClick:()=>this._dialogService.close("reject-input-dialog")},this._localeService.t("dataValidation.alert.ok"))},onClose:()=>{this._dialogService.close("reject-input-dialog")}})}};Ae=Zt([we(0,r.Inject(X.SheetInterceptorService)),we(1,r.Inject(E.SheetDataValidationModel)),we(2,r.Inject(J.DataValidatorRegistryService)),we(3,f.IDialogService),we(4,r.Inject(r.LocaleService)),we(5,r.Inject(E.SheetsDataValidationValidatorService))],Ae);const Dt={dvDateDropdown:"univer-dv-date-dropdown",dvDateDropdownBtns:"univer-dv-date-dropdown-btns"},Jt=e=>{if(e==null||typeof e=="boolean")return;if(typeof e=="number"||!Number.isNaN(+e))return r.dayjs(r.numfmt.format("yyyy-MM-dd HH:mm:ss",Number(e)));const t=r.dayjs(e);if(t.isValid())return t};function Qt(e){var I;const{location:t,hideFn:a}=e,{worksheet:n,row:o,col:i,unitId:s,subUnitId:l,workbook:d}=t,h=f.useDependency(r.ICommandService),p=f.useDependency(Ae),v=n.getCell(o,i),c=E.getCellValueOrigin(n.getCellRaw(o,i)),D=Jt(c),[g,M]=V.useState(D),w=g&&g.isValid()?g:r.dayjs(),m=f.useDependency(r.LocaleService),S=f.useDependency(E.SheetDataValidationModel),_=S.getRuleByLocation(s,l,o,i);if(!_)return null;const T=S.getValidator(_.type);if(!v||!T)return;const C=!!((I=_.bizInfo)!=null&&I.showTime),y=async()=>{var j,W,Y;if(!w)return;const N=w.format(C?"YYYY-MM-DD HH:mm:ss":"YYYY-MM-DD 00:00:00"),H=(j=r.numfmt.parseDate(N))==null?void 0:j.v,A=d.getStyles().getStyleByCell(v),F=(Y=(W=A==null?void 0:A.n)==null?void 0:W.pattern)!=null?Y:"",U=Kt.getPatternType(F);_.errorStyle!==r.DataValidationErrorStyle.STOP||await T.validator({value:H,unitId:s,subUnitId:l,row:o,column:i,worksheet:n,workbook:d,interceptValue:N.replace("Z","").replace("T"," "),t:r.CellValueType.NUMBER},_)?(a(),await h.executeCommand($.SetCellEditVisibleOperation.id,{visible:!1,eventType:k.DeviceInputEventType.Keyboard,unitId:s,keycode:f.KeyCode.ESC}),await h.executeCommand(X.SetRangeValuesCommand.id,{unitId:s,subUnitId:l,range:{startColumn:i,endColumn:i,startRow:o,endRow:o},value:{v:H,t:2,p:null,f:null,si:null,s:{n:{pattern:C?U==="datetime"?F:"yyyy-MM-dd hh:mm:ss":U==="date"?F:"yyyy-MM-dd"}}}})):p.showReject(T.getRuleFinalError(_,{row:o,col:i,unitId:s,subUnitId:l}))};return u.jsxs("div",{className:Dt.dvDateDropdown,children:[u.jsx(L.DatePanel,{defaultValue:w,pickerValue:w,showTime:C||void 0,onSelect:async O=>{M(O)},onPanelChange:O=>{M(O)},disabledDate:O=>!r.numfmt.parseDate(O.format("YYYY-MM-DD"))}),u.jsx("div",{className:Dt.dvDateDropdownBtns,children:u.jsx(L.Button,{size:"small",type:"primary",onClick:y,disabled:!w.isValid(),children:m.t("dataValidation.alert.ok")})})]})}var se=function(){return se=Object.assign||function(e){for(var t,a=1,n=arguments.length;a<n;a++){t=arguments[a];for(var o in t)Object.prototype.hasOwnProperty.call(t,o)&&(e[o]=t[o])}return e},se.apply(this,arguments)},en=function(e,t){var a={};for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&t.indexOf(n)<0&&(a[n]=e[n]);if(e!=null&&typeof Object.getOwnPropertySymbols=="function")for(var o=0,n=Object.getOwnPropertySymbols(e);o<n.length;o++)t.indexOf(n[o])<0&&Object.prototype.propertyIsEnumerable.call(e,n[o])&&(a[n[o]]=e[n[o]]);return a},ge=V.forwardRef(function(e,t){var a=e.icon,n=e.id,o=e.className,i=e.extend,s=en(e,["icon","id","className","extend"]),l="univerjs-icon univerjs-icon-".concat(n," ").concat(o||"").trim(),d=V.useRef("_".concat(an()));return yt(a,"".concat(n),{defIds:a.defIds,idSuffix:d.current},se({ref:t,className:l},s),i)});function yt(e,t,a,n,o){return V.createElement(e.tag,se(se({key:t},tn(e,a,o)),n),(nn(e,a).children||[]).map(function(i,s){return yt(i,"".concat(t,"-").concat(e.tag,"-").concat(s),a,void 0,o)}))}function tn(e,t,a){var n=se({},e.attrs);a!=null&&a.colorChannel1&&n.fill==="colorChannel1"&&(n.fill=a.colorChannel1),e.tag==="mask"&&n.id&&(n.id=n.id+t.idSuffix),Object.entries(n).forEach(function(i){var s=i[0],l=i[1];s==="mask"&&typeof l=="string"&&(n[s]=l.replace(/url\(#(.*)\)/,"url(#$1".concat(t.idSuffix,")")))});var o=t.defIds;return!o||o.length===0||(e.tag==="use"&&n["xlink:href"]&&(n["xlink:href"]=n["xlink:href"]+t.idSuffix),Object.entries(n).forEach(function(i){var s=i[0],l=i[1];typeof l=="string"&&(n[s]=l.replace(/url\(#(.*)\)/,"url(#$1".concat(t.idSuffix,")")))})),n}function nn(e,t){var a,n=t.defIds;return!n||n.length===0?e:e.tag==="defs"&&(!((a=e.children)===null||a===void 0)&&a.length)?se(se({},e),{children:e.children.map(function(o){return typeof o.attrs.id=="string"&&n&&n.indexOf(o.attrs.id)>-1?se(se({},o),{attrs:se(se({},o.attrs),{id:o.attrs.id+t.idSuffix})}):o})}):e}function an(){return Math.random().toString(36).substring(2,8)}ge.displayName="UniverIcon";var on={tag:"svg",attrs:{fill:"none",viewBox:"0 0 16 16",width:"1em",height:"1em"},children:[{tag:"path",attrs:{fill:"currentColor",d:"M14.1544 3.75557C14.3887 3.98988 14.3887 4.36978 14.1544 4.6041L6.51409 12.2444C6.40157 12.3569 6.24896 12.4201 6.08983 12.4201C5.9307 12.4201 5.77808 12.3569 5.66556 12.2444L1.84541 8.42425C1.6111 8.18993 1.6111 7.81003 1.84541 7.57572C2.07973 7.34141 2.45963 7.34141 2.69394 7.57572L6.08983 10.9716L13.3059 3.75557C13.5402 3.52126 13.9201 3.52126 14.1544 3.75557Z",fillRule:"evenodd",clipRule:"evenodd"}}]},wt=V.forwardRef(function(e,t){return V.createElement(ge,Object.assign({},e,{id:"check-mark-single",ref:t,icon:on}))});wt.displayName="CheckMarkSingle";var rn={tag:"svg",attrs:{fill:"none",viewBox:"0 0 17 16",width:"1em",height:"1em"},children:[{tag:"path",attrs:{fill:"currentColor",d:"M1.4917 3.07803C1.4917 2.19437 2.20804 1.47803 3.0917 1.47803H5.6917C6.57536 1.47803 7.2917 2.19437 7.2917 3.07803V5.67803C7.2917 6.56168 6.57535 7.27803 5.6917 7.27803H3.0917C2.20804 7.27803 1.4917 6.56168 1.4917 5.67803V3.07803ZM3.0917 2.67803C2.87078 2.67803 2.6917 2.85711 2.6917 3.07803V5.67803C2.6917 5.89894 2.87079 6.07803 3.0917 6.07803H5.6917C5.91261 6.07803 6.0917 5.89894 6.0917 5.67803V3.07803C6.0917 2.85711 5.91261 2.67803 5.6917 2.67803H3.0917Z",fillRule:"evenodd",clipRule:"evenodd"}},{tag:"path",attrs:{fill:"currentColor",d:"M14.6175 2.45279C14.8518 2.68711 14.8518 3.06701 14.6175 3.30132L11.6151 6.30365C11.3957 6.52307 11.0451 6.53897 10.8067 6.34031L8.80915 4.67566C8.55458 4.46352 8.52019 4.08518 8.73233 3.83062 8.94447 3.57605 9.32281 3.54166 9.57737 3.7538L11.154 5.06767 13.769 2.45278C14.0033 2.21847 14.3832 2.21848 14.6175 2.45279zM14.1175 9.19746C14.3518 9.43178 14.3518 9.81168 14.1175 10.046L12.5418 11.6217 14.1175 13.1975C14.3518 13.4318 14.3518 13.8117 14.1175 14.046 13.8832 14.2803 13.5033 14.2803 13.269 14.046L11.6933 12.4703 10.1175 14.046C9.88321 14.2803 9.50331 14.2803 9.269 14.046 9.03468 13.8117 9.03468 13.4318 9.269 13.1975L10.8447 11.6217 9.269 10.046C9.03468 9.81168 9.03468 9.43178 9.269 9.19746 9.50331 8.96315 9.88321 8.96315 10.1175 9.19746L11.6933 10.7732 13.269 9.19746C13.5033 8.96315 13.8832 8.96315 14.1175 9.19746z"}},{tag:"path",attrs:{fill:"currentColor",d:"M3.0917 8.72168C2.20804 8.72168 1.4917 9.43802 1.4917 10.3217V12.9217C1.4917 13.8053 2.20804 14.5217 3.0917 14.5217H5.6917C6.57535 14.5217 7.2917 13.8053 7.2917 12.9217V10.3217C7.2917 9.43802 6.57536 8.72168 5.6917 8.72168H3.0917ZM2.6917 10.3217C2.6917 10.1008 2.87078 9.92168 3.0917 9.92168H5.6917C5.91261 9.92168 6.0917 10.1008 6.0917 10.3217V12.9217C6.0917 13.1426 5.91261 13.3217 5.6917 13.3217H3.0917C2.87079 13.3217 2.6917 13.1426 2.6917 12.9217V10.3217Z",fillRule:"evenodd",clipRule:"evenodd"}}]},Vt=V.forwardRef(function(e,t){return V.createElement(ge,Object.assign({},e,{id:"data-validation-single",ref:t,icon:rn}))});Vt.displayName="DataValidationSingle";var sn={tag:"svg",attrs:{fill:"none",viewBox:"0 0 16 16",width:"1em",height:"1em"},children:[{tag:"path",attrs:{fill:"currentColor",d:"M5.3313 1.4667C5.3313 1.13533 5.59993.866699 5.9313.866699H10.069C10.4004.866699 10.669 1.13533 10.669 1.4667 10.669 1.79807 10.4004 2.0667 10.069 2.0667H5.9313C5.59993 2.0667 5.3313 1.79807 5.3313 1.4667zM1.09985 3.64443C1.09985 3.31306 1.36848 3.04443 1.69985 3.04443H14.2999C14.6312 3.04443 14.8999 3.31306 14.8999 3.64443 14.8999 3.9758 14.6312 4.24443 14.2999 4.24443H1.69985C1.36848 4.24443 1.09985 3.9758 1.09985 3.64443zM6.12398 8.30171C6.35829 8.0674 6.73819 8.0674 6.97251 8.30171L8.00007 9.32928 9.02764 8.30171C9.26195 8.0674 9.64185 8.0674 9.87617 8.30171 10.1105 8.53603 10.1105 8.91593 9.87617 9.15024L8.8486 10.1778 9.87617 11.2054C10.1105 11.4397 10.1105 11.8196 9.87617 12.0539 9.64185 12.2882 9.26195 12.2882 9.02764 12.0539L8.00007 11.0263 6.97251 12.0539C6.73819 12.2882 6.35829 12.2882 6.12398 12.0539 5.88966 11.8196 5.88966 11.4397 6.12398 11.2054L7.15154 10.1778 6.12398 9.15024C5.88966 8.91593 5.88966 8.53603 6.12398 8.30171z"}},{tag:"path",attrs:{fill:"currentColor",d:"M4.75332 5.22217C3.86966 5.22217 3.15332 5.93851 3.15332 6.82217V12.5331C3.15332 13.9691 4.31738 15.1332 5.75332 15.1332H10.2465C11.6825 15.1332 12.8465 13.9691 12.8465 12.5331V6.82217C12.8465 5.93851 12.1302 5.22217 11.2465 5.22217H4.75332ZM4.35332 6.82217C4.35332 6.60125 4.53241 6.42217 4.75332 6.42217H11.2465C11.4674 6.42217 11.6465 6.60125 11.6465 6.82217V12.5331C11.6465 13.3063 11.0197 13.9332 10.2465 13.9332H5.75332C4.98012 13.9332 4.35332 13.3063 4.35332 12.5331V6.82217Z",fillRule:"evenodd",clipRule:"evenodd"}}]},at=V.forwardRef(function(e,t){return V.createElement(ge,Object.assign({},e,{id:"delete-single",ref:t,icon:sn}))});at.displayName="DeleteSingle";var ln={tag:"svg",attrs:{fill:"none",viewBox:"0 0 16 16",width:"1em",height:"1em"},children:[{tag:"path",attrs:{fill:"currentColor",d:"M8.6 1.99991C8.60001 1.66854 8.33138 1.39991 8.00001 1.3999C7.66864 1.3999 7.40001 1.66853 7.4 1.9999L7.39996 7.3999H1.9999C1.66853 7.3999 1.3999 7.66853 1.3999 7.9999C1.3999 8.33127 1.66853 8.5999 1.9999 8.5999H7.39995L7.3999 13.9999C7.3999 14.3313 7.66853 14.5999 7.9999 14.5999C8.33127 14.5999 8.5999 14.3313 8.5999 13.9999L8.59995 8.5999H13.9999C14.3313 8.5999 14.5999 8.33127 14.5999 7.9999C14.5999 7.66853 14.3313 7.3999 13.9999 7.3999H8.59996L8.6 1.99991Z"}}]},Et=V.forwardRef(function(e,t){return V.createElement(ge,Object.assign({},e,{id:"increase-single",ref:t,icon:ln}))});Et.displayName="IncreaseSingle";var dn={tag:"svg",attrs:{fill:"none",viewBox:"0 0 16 16",width:"1em",height:"1em"},children:[{tag:"path",attrs:{fill:"currentColor",d:"M11.3536 6.14645C11.5488 6.34171 11.5488 6.65829 11.3536 6.85355L8.35355 9.85355C8.15829 10.0488 7.84171 10.0488 7.64645 9.85355L4.64645 6.85355C4.45118 6.65829 4.45118 6.34171 4.64645 6.14645C4.84171 5.95118 5.15829 5.95118 5.35355 6.14645L8 8.79289L10.6464 6.14645C10.8417 5.95118 11.1583 5.95118 11.3536 6.14645Z",fillRule:"evenodd",clipRule:"evenodd"}}]},Mt=V.forwardRef(function(e,t){return V.createElement(ge,Object.assign({},e,{id:"more-down-single",ref:t,icon:dn}))});Mt.displayName="MoreDownSingle";var cn={tag:"svg",attrs:{fill:"none",viewBox:"0 0 16 16",width:"1em",height:"1em"},children:[{tag:"path",attrs:{fill:"currentColor",d:"M4.64645 9.85355C4.45118 9.65829 4.45118 9.34171 4.64645 9.14645L7.64645 6.14645C7.84171 5.95118 8.15829 5.95118 8.35355 6.14645L11.3536 9.14645C11.5488 9.34171 11.5488 9.65829 11.3536 9.85355C11.1583 10.0488 10.8417 10.0488 10.6464 9.85355L8 7.20711L5.35355 9.85355C5.15829 10.0488 4.84171 10.0488 4.64645 9.85355Z",fillRule:"evenodd",clipRule:"evenodd"}}]},bt=V.forwardRef(function(e,t){return V.createElement(ge,Object.assign({},e,{id:"more-up-single",ref:t,icon:cn}))});bt.displayName="MoreUpSingle";var un={tag:"svg",attrs:{fill:"none",viewBox:"0 0 16 16",width:"1em",height:"1em"},children:[{tag:"mask",attrs:{id:"mask0_622_8",style:{maskType:"alpha"},width:16,height:16,x:0,y:0,maskUnits:"userSpaceOnUse"},children:[{tag:"path",attrs:{fill:"#D9D9D9",d:"M0 0H16V16H0z"}}]},{tag:"g",attrs:{fill:"currentColor",mask:"url(#mask0_622_8)"},children:[{tag:"path",attrs:{d:"M6 5C6.55228 5 7 4.55228 7 4 7 3.44772 6.55228 3 6 3 5.44772 3 5 3.44772 5 4 5 4.55228 5.44772 5 6 5zM6 9C6.55228 9 7 8.55229 7 8 7 7.44772 6.55228 7 6 7 5.44772 7 5 7.44772 5 8 5 8.55229 5.44772 9 6 9zM7 12C7 12.5523 6.55228 13 6 13 5.44772 13 5 12.5523 5 12 5 11.4477 5.44772 11 6 11 6.55228 11 7 11.4477 7 12zM10 5C10.5523 5 11 4.55228 11 4 11 3.44772 10.5523 3 10 3 9.44771 3 9 3.44772 9 4 9 4.55228 9.44771 5 10 5zM11 8C11 8.55229 10.5523 9 10 9 9.44771 9 9 8.55229 9 8 9 7.44772 9.44771 7 10 7 10.5523 7 11 7.44772 11 8zM10 13C10.5523 13 11 12.5523 11 12 11 11.4477 10.5523 11 10 11 9.44771 11 9 11.4477 9 12 9 12.5523 9.44771 13 10 13z"}}]}]},Lt=V.forwardRef(function(e,t){return V.createElement(ge,Object.assign({},e,{id:"sequence-single",ref:t,icon:un}))});Lt.displayName="SequenceSingle";var hn=Object.getOwnPropertyDescriptor,pn=(e,t,a,n)=>{for(var o=n>1?void 0:n?hn(t,a):t,i=e.length-1,s;i>=0;i--)(s=e[i])&&(o=s(o)||o);return o},Tt=(e,t)=>(a,n)=>t(a,n,e);let ue=class extends r.Disposable{constructor(t,a){super();R(this,"_open$",new ie.BehaviorSubject(!1));R(this,"open$",this._open$.pipe(ie.distinctUntilChanged()));R(this,"_activeRule");R(this,"_activeRule$",new ie.BehaviorSubject(void 0));R(this,"activeRule$",this._activeRule$.asObservable());R(this,"_closeDisposable",null);this._univerInstanceService=t,this._sidebarService=a,this.disposeWithMe(this._univerInstanceService.getCurrentTypeOfUnit$(r.UniverInstanceType.UNIVER_SHEET).pipe(ie.filter(n=>!n)).subscribe(()=>{this.close()})),this.disposeWithMe(this._sidebarService.sidebarOptions$.subscribe(n=>{n.id===Ne&&(n.visible||setTimeout(()=>{this._sidebarService.sidebarOptions$.next({visible:!1})}))}))}get activeRule(){return this._activeRule}get isOpen(){return this._open$.getValue()}dispose(){var t;super.dispose(),this._open$.next(!1),this._open$.complete(),this._activeRule$.complete(),(t=this._closeDisposable)==null||t.dispose()}open(){this._open$.next(!0)}close(){var t;this._open$.next(!1),(t=this._closeDisposable)==null||t.dispose()}setCloseDisposable(t){this._closeDisposable=r.toDisposable(()=>{t.dispose(),this._closeDisposable=null})}setActiveRule(t){this._activeRule=t,this._activeRule$.next(t)}};ue=pn([Tt(0,r.IUniverInstanceService),Tt(1,f.ISidebarService)],ue);function vn(){const e=f.useDependency(me),t=f.useObservable(e.activeDropdown$,e.activeDropdown),a=f.useDependency(f.ComponentManager);if(!t)return null;const{location:n,componentKey:o}=t,i=a.get(o),s=`${n.unitId}-${n.subUnitId}-${n.row}-${n.col}`;if(!i)return null;const l=()=>{e.hideDropdown()};return u.jsx(i,{location:n,hideFn:l},s)}const Ot="sheet.ui.dropdown";var gn=Object.getOwnPropertyDescriptor,mn=(e,t,a,n)=>{for(var o=n>1?void 0:n?gn(t,a):t,i=e.length-1,s;i>=0;i--)(s=e[i])&&(o=s(o)||o);return o},Se=(e,t)=>(a,n)=>t(a,n,e);let me=class extends r.Disposable{constructor(t,a,n,o,i,s,l){super();R(this,"_activeDropdown");R(this,"_activeDropdown$",new ie.Subject);R(this,"_currentPopup",null);R(this,"activeDropdown$",this._activeDropdown$.asObservable());R(this,"_zenVisible",!1);this._canvasPopupManagerService=t,this._univerInstanceService=a,this._dataValidatorRegistryService=n,this._zenZoneService=o,this._renderManagerService=i,this._dataValidationModel=s,this._sheetsSelectionsService=l,this._init(),this._initSelectionChange(),this.disposeWithMe(()=>{this._activeDropdown$.complete()})}get activeDropdown(){return this._activeDropdown}_init(){this.disposeWithMe(this._zenZoneService.visible$.subscribe(t=>{this._zenVisible=t,t&&this.hideDropdown()}))}_getDropdownByCell(t,a,n,o){const i=t?this._univerInstanceService.getUnit(t,r.UniverInstanceType.UNIVER_SHEET):this._univerInstanceService.getCurrentUnitForType(r.UniverInstanceType.UNIVER_SHEET);if(!i)return;const s=a?i.getSheetBySheetId(a):i.getActiveSheet();if(!s)return;const l=this._dataValidationModel.getRuleByLocation(i.getUnitId(),s.getSheetId(),n,o);if(!l)return;const d=this._dataValidatorRegistryService.getValidatorItem(l.type);return d==null?void 0:d.dropdown}_initSelectionChange(){this.disposeWithMe(this._sheetsSelectionsService.selectionMoveEnd$.subscribe(t=>{t&&t.every(a=>!(a.primary&&this._getDropdownByCell(a.primary.unitId,a.primary.sheetId,a.primary.actualRow,a.primary.actualColumn)))&&this.hideDropdown()}))}showDropdown(t,a=!0){const{location:n}=t,{row:o,col:i,unitId:s,subUnitId:l}=n;if(this._currentPopup&&this._currentPopup.dispose(),this._zenVisible)return;this._activeDropdown=t,this._activeDropdown$.next(this._activeDropdown);const d=this._renderManagerService.getRenderById(r.DOCS_FORMULA_BAR_EDITOR_UNIT_ID_KEY),h=this._canvasPopupManagerService.attachPopupToCell(o,i,{componentKey:Ot,onClickOutside:()=>{a&&this.hideDropdown()},offset:[0,3],excludeOutside:[d==null?void 0:d.engine.getCanvasElement()].filter(Boolean)},s,l);if(!h)throw new Error("[DataValidationDropdownManagerService]: cannot show dropdown!");const p=new r.DisposableCollection;p.add(h),p.add({dispose:()=>{var v,c;(c=(v=this._activeDropdown)==null?void 0:v.onHide)==null||c.call(v)}}),this._currentPopup=p}hideDropdown(){this._activeDropdown&&(this._currentPopup&&this._currentPopup.dispose(),this._currentPopup=null,this._activeDropdown=null,this._activeDropdown$.next(null))}showDataValidationDropdown(t,a,n,o,i){const s=this._univerInstanceService.getUnit(t,r.UniverInstanceType.UNIVER_SHEET);if(!s)return;const l=s.getSheetBySheetId(a);if(!l)return;const d=this._dataValidationModel.getRuleByLocation(s.getUnitId(),l.getSheetId(),n,o);if(!d)return;const h=this._dataValidatorRegistryService.getValidatorItem(d.type);if(!h||!h.dropdown){this.hideDropdown();return}this.showDropdown({location:{workbook:s,worksheet:l,row:n,col:o,unitId:t,subUnitId:a},componentKey:h.dropdown,onHide:i})}};me=mn([Se(0,r.Inject($.SheetCanvasPopManagerService)),Se(1,r.IUniverInstanceService),Se(2,r.Inject(J.DataValidatorRegistryService)),Se(3,f.IZenZoneService),Se(4,k.IRenderManagerService),Se(5,r.Inject(E.SheetDataValidationModel)),Se(6,r.Inject(X.SheetsSelectionsService))],me);const Ne="DataValidationPanel",Ie={id:"data-validation.operation.open-validation-panel",type:r.CommandType.OPERATION,handler(e,t){if(!t)return!1;const{ruleId:a,isAdd:n}=t,o=e.get(ue),i=e.get(J.DataValidationModel),s=e.get(r.IUniverInstanceService),l=e.get(f.ISidebarService),d=X.getSheetCommandTarget(s);if(!d)return!1;const{unitId:h,subUnitId:p}=d,v=a?i.getRuleById(h,p,a):void 0;o.open(),o.setActiveRule(v&&{unitId:h,subUnitId:p,rule:v});const c=l.open({id:Ne,header:{title:n?"dataValidation.panel.addTitle":"dataValidation.panel.title"},children:{label:Ne},width:312,onClose:()=>o.close()});return o.setCloseDisposable(c),!0}},ot={id:"data-validation.operation.close-validation-panel",type:r.CommandType.OPERATION,handler(e){return e.get(ue).close(),!0}},Pt={id:"data-validation.operation.toggle-validation-panel",type:r.CommandType.OPERATION,handler(e){const t=e.get(r.ICommandService),a=e.get(ue);return a.open(),a.isOpen?t.executeCommand(ot.id):t.executeCommand(Ie.id),!0}},Ue={type:r.CommandType.OPERATION,id:"sheet.operation.show-data-validation-dropdown",handler(e,t){if(!t)return!1;const a=e.get(me),{unitId:n,subUnitId:o,row:i,column:s}=t,l=a.activeDropdown,d=l==null?void 0:l.location;return d&&d.unitId===n&&d.subUnitId===o&&d.row===i&&d.col===s||a.showDataValidationDropdown(n,o,i,s),!0}},Rt={type:r.CommandType.OPERATION,id:"sheet.operation.hide-data-validation-dropdown",handler(e,t){return t?(e.get(me).hideDropdown(),!0):!1}},_e="#ECECEC",it="sheets-data-validation-ui.config",Be={},ve={dvListDropdown:"univer-dv-list-dropdown",dvListDropdownTitle:"univer-dv-list-dropdown-title",dvListDropdownList:"univer-dv-list-dropdown-list",dvListDropdownListContainer:"univer-dv-list-dropdown-list-container",dvListDropdownSelectedIcon:"univer-dv-list-dropdown-selected-icon",dvListDropdownItemContainer:"univer-dv-list-dropdown-item-container",dvListDropdownItem:"univer-dv-list-dropdown-item",dvListDropdownSplit:"univer-dv-list-dropdown-split",dvListDropdownEdit:"univer-dv-list-dropdown-edit"},fn=e=>{var C,y;const{value:t,onChange:a,multiple:n,options:o,title:i,onEdit:s,style:l,filter:d,location:h}=e,p=f.useDependency(r.LocaleService),v=f.useDependency(r.IConfigService),c=d==null?void 0:d.toLowerCase(),{row:D,col:g,unitId:M,subUnitId:w}=h,m=o.filter(I=>c?I.label.toLowerCase().includes(c):!0),S=(y=(C=v.getConfig(it))==null?void 0:C.showEditOnDropdown)!=null?y:!0,_=f.useDependency(X.SheetPermissionCheckController),T=V.useMemo(()=>_.permissionCheckWithRanges({workbookTypes:[X.WorkbookEditablePermission],rangeTypes:[X.RangeProtectionPermissionEditPoint],worksheetTypes:[X.WorksheetEditPermission]},[{startColumn:g,startRow:D,endColumn:g,endRow:D}],M,w),[_,g,D,M,w]);return u.jsxs("div",{className:ve.dvListDropdown,style:l,children:[u.jsx("div",{className:ve.dvListDropdownTitle,children:i}),u.jsx("div",{className:ve.dvListDropdownList,children:u.jsx(L.Scrollbar,{children:u.jsx("div",{className:ve.dvListDropdownListContainer,children:m.map((I,O)=>{const N=t.indexOf(I.value)>-1,H=()=>{let F;N?F=new Set(t.filter(j=>j!==I.value)):F=new Set(n?[...t,I.value]:[I.value]);const U=[];o.forEach(j=>{F.has(j.value)&&U.push(j.value)}),a(U)},A=I.label.toLocaleLowerCase().indexOf(c);return u.jsxs("div",{className:ve.dvListDropdownItemContainer,onClick:H,children:[u.jsx("div",{className:ve.dvListDropdownItem,style:{background:I.color||_e},children:c&&I.label.toLowerCase().includes(c)?u.jsxs(u.Fragment,{children:[u.jsx("span",{children:I.label.substring(0,A)}),u.jsx("span",{style:{fontWeight:"bold"},children:I.label.substring(A,A+c.length)}),u.jsx("span",{children:I.label.substring(A+c.length)})]}):I.label}),u.jsx("div",{className:ve.dvListDropdownSelectedIcon,children:N?u.jsx(wt,{}):null})]},O)})})},d)}),S&&T?u.jsxs(u.Fragment,{children:[u.jsx("div",{className:ve.dvListDropdownSplit}),u.jsx("div",{className:ve.dvListDropdownEdit,children:u.jsx("a",{onClick:s,children:p.t("dataValidation.list.edit")})})]}):null]})};function Sn(e){var W,Y,q,Z;const{location:t,hideFn:a}=e,{worksheet:n,row:o,col:i,unitId:s,subUnitId:l}=t,d=f.useDependency(J.DataValidationModel),[h,p]=V.useState(""),v=f.useDependency(r.ICommandService),c=f.useDependency(r.LocaleService),[D,g]=V.useState(""),M=f.useDependency($.IEditorBridgeService),w=f.useDependency(r.IUniverInstanceService),m=V.useMemo(()=>d.ruleChange$.pipe(ie.debounceTime(16)),[]),S=f.useDependency(E.SheetDataValidationModel);f.useObservable(m);const _=f.RectPopup.useContext(),T=((Y=(W=_.current)==null?void 0:W.right)!=null?Y:0)-((Z=(q=_.current)==null?void 0:q.left)!=null?Z:0);if(V.useEffect(()=>{const G=v.onCommandExecuted(ee=>{var te,ae;if(ee.id===Gt.RichTextEditingMutation.id){const oe=ee.params,{unitId:le}=oe,re=w.getUnit(le,r.UniverInstanceType.UNIVER_DOC);if(!re||!M.isVisible().visible)return;const de=r.BuildTextUtils.transform.getPlainText((ae=(te=re.getSnapshot().body)==null?void 0:te.dataStream)!=null?ae:"");p(de)}});return()=>{G.dispose()}},[v,M,w]),!n)return null;const C=S.getRuleByLocation(s,l,o,i);if(!C)return null;const y=S.getValidator(C.type);if(!y)return null;const I=n.getCell(o,i),O=(C==null?void 0:C.renderMode)===r.DataValidationRenderMode.CUSTOM||(C==null?void 0:C.renderMode)===void 0;if(!I||!C||!y||y.id.indexOf(r.DataValidationType.LIST)!==0)return;const N=C.type===r.DataValidationType.LIST_MULTIPLE,H=y.getListWithColor(C,s,l),A=D||E.getDataValidationCellValue(n.getCellRaw(o,i)),F=E.deserializeListOptions(A),U=()=>{v.executeCommand(Ie.id,{ruleId:C.uid}),a()},j=H.map(G=>({label:G.label,value:G.label,color:O||G.color?G.color:"transparent"}));return u.jsx(fn,{style:{minWidth:T,maxWidth:Math.max(T,200)},title:N?c.t("dataValidation.listMultiple.dropdown"):c.t("dataValidation.list.dropdown"),value:F,multiple:N,onChange:async G=>{const ee=E.serializeListOptions(G),te={unitId:s,subUnitId:l,range:{startColumn:i,endColumn:i,startRow:o,endRow:o},value:{v:ee,p:null,f:null,si:null}};M.isVisible()&&v.executeCommand($.SetCellEditVisibleOperation.id,{visible:!1,eventType:k.DeviceInputEventType.Keyboard,unitId:s,keycode:f.KeyCode.ESC}),g(ee),N||a(),M.isVisible().visible&&await v.executeCommand($.SetCellEditVisibleOperation.id,{visible:!1,eventType:k.DeviceInputEventType.Keyboard,unitId:s,keycode:f.KeyCode.ESC}),v.executeCommand(X.SetRangeValuesCommand.id,te)},options:j,onEdit:U,filter:h,location:t})}const rt={dataValidationOptionsButton:"univer-data-validation-options-button",dataValidationOptionsButtonIcon:"univer-data-validation-options-button-icon"};function In(e){var h;const t=f.useDependency(r.LocaleService),a=f.useDependency(f.ComponentManager),{value:n,onChange:o,extraComponent:i}=e,[s,l]=V.useState(!1),d=i?a.get(i):null;return u.jsxs(u.Fragment,{children:[u.jsxs("div",{className:rt.dataValidationOptionsButton,onClick:()=>l(!s),children:[t.t("dataValidation.panel.options"),s?u.jsx(bt,{className:rt.dataValidationOptionsButtonIcon}):u.jsx(Mt,{className:rt.dataValidationOptionsButtonIcon})]}),s&&u.jsxs(u.Fragment,{children:[d?u.jsx(d,{value:n,onChange:o}):null,u.jsx(L.FormLayout,{label:t.t("dataValidation.panel.invalid"),children:u.jsxs(L.RadioGroup,{value:`${(h=n.errorStyle)!=null?h:r.DataValidationErrorStyle.WARNING}`,onChange:p=>o({...n,errorStyle:+p}),children:[u.jsx(L.Radio,{value:`${r.DataValidationErrorStyle.WARNING}`,children:t.t("dataValidation.panel.showWarning")}),u.jsx(L.Radio,{value:`${r.DataValidationErrorStyle.STOP}`,children:t.t("dataValidation.panel.rejectInput")})]})}),u.jsx(L.FormLayout,{label:t.t("dataValidation.panel.messageInfo"),children:u.jsx(L.Checkbox,{checked:n.showErrorMessage,onChange:()=>o({...n,showErrorMessage:!n.showErrorMessage}),children:t.t("dataValidation.panel.showInfo")})}),n.showErrorMessage?u.jsx(L.FormLayout,{children:u.jsx(L.Input,{value:n.error,onChange:p=>o({...n,error:p})})}):null]})]})}const Ve={dataValidationDetail:"univer-data-validation-detail",dataValidationDetailFormItem:"univer-data-validation-detail-form-item",dataValidationDetailButtons:"univer-data-validation-detail-buttons",dataValidationDetailButton:"univer-data-validation-detail-button"},_n=e=>r.debounce(async(t,a,n,o)=>{const i=await e.executeCommand(t,a,n);o==null||o(i)},1e3);function Cn(e,t,a){var n,o,i,s;return t?((o=(n=e.getUnit(t))==null?void 0:n.getSheetBySheetName(a))==null?void 0:o.getSheetId())||"":((s=(i=e.getCurrentUnitForType(r.UniverInstanceType.UNIVER_SHEET))==null?void 0:i.getSheetBySheetName(a))==null?void 0:s.getSheetId())||""}function Dn(){var de;const[e,t]=V.useState(0),a=f.useDependency(ue),n=f.useObservable(a.activeRule$,a.activeRule),{unitId:o,subUnitId:i,rule:s}=n||{},l=s.uid,d=f.useDependency(J.DataValidatorRegistryService),h=f.useDependency(r.IUniverInstanceService),p=f.useDependency(f.ComponentManager),v=f.useDependency(r.ICommandService),c=f.useDependency(J.DataValidationModel),D=f.useDependency(r.LocaleService),[g,M]=V.useState(s),w=d.getValidatorItem(g.type),[m,S]=V.useState(!1),_=d.getValidatorsByScope(J.DataValidatorRegistryScope.SHEET),[T,C]=V.useState(()=>g.ranges.map(P=>({unitId:"",sheetId:"",range:P}))),y=V.useMemo(()=>_n(v),[v]),[I,O]=V.useState(!1),[N,H]=V.useState(!1),A=V.useRef(null),F=f.useDependency(X.SheetsSelectionsService);if(V.useEffect(()=>()=>{const P=F.getCurrentLastSelection();P&&F.setSelections([P])},[F]),V.useEffect(()=>{v.onCommandExecuted(P=>{(P.id===r.UndoCommand.id||P.id===r.RedoCommand.id)&&setTimeout(()=>{const b=c.getRuleById(o,i,l);t(B=>B+1),b&&(M(b),C(b.ranges.map(B=>({unitId:"",sheetId:"",range:B}))))},20)})},[v,c,l,i,o]),!w)return null;const U=w.operators,j=w.operatorNames,W=g.operator?J.TWO_FORMULA_OPERATOR_COUNT.includes(g.operator):!1,Y=()=>{var P,b,B;(b=(P=A.current)==null?void 0:P.editor)!=null&&b.isFocus()&&q((B=A.current)==null?void 0:B.getValue()),!(!g.ranges.length||I)&&(w.validatorFormula(g,o,i).success?a.setActiveRule(null):S(!0))},q=f.useEvent(P=>{const b=P.split(",").filter(Boolean).map(tt.deserializeRangeWithSheet).map(K=>{const fe=K.sheetName;if(fe){const La=Cn(h,K.unitId,fe);return{...K,sheetId:La}}return{...K,sheetId:""}});if(r.isUnitRangesEqual(b,T))return;C(b);const B=b.filter(K=>(!K.unitId||K.unitId===o)&&(!K.sheetId||K.sheetId===i)).map(K=>K.range);if(M({...g,ranges:B}),B.length===0)return;const z={unitId:o,subUnitId:i,ruleId:l,ranges:B};y(E.UpdateSheetDataValidationRangeCommand.id,z)}),Z=P=>{if(r.shallowEqual(P,J.getRuleSetting(g)))return;M({...g,...P});const b={unitId:o,subUnitId:i,ruleId:l,setting:P};y(E.UpdateSheetDataValidationSettingCommand.id,b,void 0)},G=async()=>{await v.executeCommand(E.RemoveSheetDataValidationCommand.id,{ruleId:l,unitId:o,subUnitId:i}),a.setActiveRule(null)},ee={type:g.type,operator:g.operator,formula1:g.formula1,formula2:g.formula2,allowBlank:g.allowBlank},te=P=>{const b=d.getValidatorItem(P);if(!b)return;const B=b.operators,z=c.getRuleById(o,i,l),K=P===(z==null?void 0:z.type)||P.includes("list")&&(z!=null&&z.type.includes("list"))?{...z,type:P}:{...g,type:P,operator:B[0],formula1:void 0,formula2:void 0};M(K),v.executeCommand(E.UpdateSheetDataValidationSettingCommand.id,{unitId:o,subUnitId:i,ruleId:g.uid,setting:J.getRuleSetting(K)})},ae=p.get(w.formulaInput),oe=V.useMemo(()=>T.map(P=>tt.serializeRange(P.range)).join(","),[]),le=J.getRuleOptions(g),re=P=>{r.shallowEqual(P,J.getRuleOptions(g))||(M({...g,...P}),y(E.UpdateSheetDataValidationOptionsCommand.id,{unitId:o,subUnitId:i,ruleId:l,options:P}))};return u.jsxs("div",{className:Ve.dataValidationDetail,children:[u.jsx(L.FormLayout,{label:D.t("dataValidation.panel.range"),error:!g.ranges.length||I?D.t("dataValidation.panel.rangeError"):"",children:u.jsx(nt.RangeSelector,{selectorRef:A,unitId:o,subUnitId:i,initialValue:oe,onChange:(P,b)=>{var B;!N&&((B=A.current)!=null&&B.verify())&&q(b)},onFocusChange:(P,b)=>{var B;H(P),!P&&b&&((B=A.current)!=null&&B.verify())&&q(b)},onVerify:P=>O(!P)})}),u.jsx(L.FormLayout,{label:D.t("dataValidation.panel.type"),children:u.jsx(L.Select,{options:_==null?void 0:_.map(P=>({label:D.t(P.title),value:P.id})),value:g.type,onChange:te,className:Ve.dataValidationDetailFormItem})}),U!=null&&U.length?u.jsx(L.FormLayout,{label:D.t("dataValidation.panel.operator"),children:u.jsx(L.Select,{options:U.map((P,b)=>({value:`${P}`,label:j[b]})),value:`${g.operator}`,onChange:P=>{Z({...ee,operator:P})},className:Ve.dataValidationDetailFormItem})}):null,ae?u.jsx(L.FormLayout,{children:u.jsx(ae,{isTwoFormula:W,value:{formula1:g.formula1,formula2:g.formula2},onChange:P=>{Z({...ee,...P})},showError:m,validResult:w.validatorFormula(g,o,i),unitId:o,subUnitId:i,ruleId:l},e+g.type)}):null,u.jsx(L.FormLayout,{children:u.jsx(L.Checkbox,{checked:(de=g.allowBlank)!=null?de:!0,onChange:()=>{var P;return Z({...ee,allowBlank:!((P=g.allowBlank)==null||P)})},children:D.t("dataValidation.panel.allowBlank")})}),u.jsx(In,{value:le,onChange:re,extraComponent:w.optionsInput}),u.jsxs("div",{className:Ve.dataValidationDetailButtons,children:[u.jsx(L.Button,{className:Ve.dataValidationDetailButton,onClick:G,children:D.t("dataValidation.panel.removeRule")}),u.jsx(L.Button,{className:Ve.dataValidationDetailButton,type:"primary",onClick:Y,children:D.t("dataValidation.panel.done")})]})]})}const je={dataValidationItemContainer:"univer-data-validation-item-container",dataValidationItemTitle:"univer-data-validation-item-title",dataValidationItemContent:"univer-data-validation-item-content",dataValidationItemIcon:"univer-data-validation-item-icon"},yn=e=>{const{rule:t,onClick:a,unitId:n,subUnitId:o,disable:i}=e,s=f.useDependency(J.DataValidatorRegistryService),l=f.useDependency(r.ICommandService),d=f.useDependency($.IMarkSelectionService),h=s.getValidatorItem(t.type),p=V.useRef(void 0),[v,c]=V.useState(!1),D=f.useDependency(r.ThemeService),g=f.useObservable(D.currentTheme$),M=V.useMemo(()=>{var _;const m=(_=g==null?void 0:g.loopColor2)!=null?_:"#49B811",S=new r.ColorKit(m).toRgb();return{fill:`rgba(${S.r}, ${S.g}, ${S.b}, 0.1)`,stroke:m}},[g]),w=m=>{l.executeCommand(E.RemoveSheetDataValidationCommand.id,{ruleId:t.uid,unitId:n,subUnitId:o}),m.stopPropagation()};return V.useEffect(()=>()=>{var m;p.current&&((m=p.current)==null||m.forEach(S=>{S&&d.removeShape(S)}))},[d]),u.jsxs("div",{className:je.dataValidationItemContainer,onClick:a,onMouseEnter:()=>{i||(c(!0),p.current=t.ranges.map(m=>d.addShape({range:m,style:M,primary:null})))},onMouseLeave:()=>{var m;c(!1),(m=p.current)==null||m.forEach(S=>{S&&d.removeShape(S)}),p.current=void 0},children:[u.jsx("div",{className:je.dataValidationItemTitle,children:h==null?void 0:h.generateRuleName(t)}),u.jsx("div",{className:je.dataValidationItemContent,children:t.ranges.map(m=>tt.serializeRange(m)).join(",")}),v?u.jsx("div",{className:je.dataValidationItemIcon,onClick:w,children:u.jsx(at,{})}):null]})},We={dataValidationList:"univer-data-validation-list",dataValidationListButtons:"univer-data-validation-list-buttons",dataValidationListButton:"univer-data-validation-list-button"};function wn(e){const t=f.useDependency(E.SheetDataValidationModel),a=f.useDependency(r.IUniverInstanceService),n=f.useDependency(r.ICommandService),o=f.useDependency(r.Injector),i=f.useDependency(ue),s=f.useDependency(r.LocaleService),[l,d]=V.useState([]),{workbook:h}=e,p=f.useObservable(h.activeSheet$,void 0,!0),v=h.getUnitId(),c=p==null?void 0:p.getSheetId();V.useEffect(()=>{d(t.getRules(v,c));const S=t.ruleChange$.subscribe(_=>{_.unitId===v&&_.subUnitId===c&&d(t.getRules(v,c))});return()=>{S.unsubscribe()}},[v,c,t]);const D=async()=>{const S=E.createDefaultNewRule(o),_={unitId:v,subUnitId:c,rule:S};await n.executeCommand(E.AddSheetDataValidationCommand.id,_),i.setActiveRule({unitId:v,subUnitId:c,rule:S})},g=()=>{n.executeCommand(E.RemoveSheetAllDataValidationCommand.id,{unitId:v,subUnitId:c})},w=(S=>{const _=a.getCurrentUnitForType(r.UniverInstanceType.UNIVER_SHEET),T=_.getActiveSheet(),C=_.getUnitId(),y=T.getSheetId();return S.map(O=>X.checkRangesEditablePermission(o,C,y,O.ranges)?{...O}:{...O,disable:!0})})(l),m=w==null?void 0:w.some(S=>S.disable);return u.jsxs("div",{className:We.dataValidationList,children:[w==null?void 0:w.map(S=>{var _;return u.jsx(yn,{unitId:v,subUnitId:c,onClick:()=>{S.disable||i.setActiveRule({unitId:v,subUnitId:c,rule:S})},rule:S,disable:(_=S.disable)!=null?_:!1},S.uid)}),u.jsxs("div",{className:We.dataValidationListButtons,children:[l.length&&!m?u.jsx(L.Button,{className:We.dataValidationListButton,onClick:g,children:s.t("dataValidation.panel.removeAll")}):null,u.jsx(L.Button,{className:We.dataValidationListButton,type:"primary",onClick:D,children:s.t("dataValidation.panel.add")})]})]})}const Vn=()=>{const e=f.useDependency(ue),t=f.useObservable(e.activeRule$,e.activeRule),a=f.useDependency(r.IUniverInstanceService),n=f.useObservable(()=>a.getCurrentTypeOfUnit$(r.UniverInstanceType.UNIVER_SHEET),void 0,void 0,[]),o=f.useObservable(()=>{var i;return(i=n==null?void 0:n.activeSheet$)!=null?i:ie.of(null)},void 0,void 0,[]);return!n||!o?null:t&&t.subUnitId===o.getSheetId()?u.jsx(Dn,{},t.rule.uid):u.jsx(wn,{workbook:n})},$e="data-validation.list.dropdown",st="data-validation.date.dropdown",He={type:r.CommandType.COMMAND,id:"data-validation.command.addRuleAndOpen",handler(e){const t=e.get(r.IUniverInstanceService),a=X.getSheetCommandTarget(t);if(!a)return!1;const{workbook:n,worksheet:o}=a,i=E.createDefaultNewRule(e),s=e.get(r.ICommandService),l=n.getUnitId(),d=o.getSheetId(),h={rule:i,unitId:l,subUnitId:d};return s.syncExecuteCommand(E.AddSheetDataValidationCommand.id,h)?(s.syncExecuteCommand(Ie.id,{ruleId:i.uid,isAdd:!0}),!0):!1}};var En=Object.getOwnPropertyDescriptor,Mn=(e,t,a,n)=>{for(var o=n>1?void 0:n?En(t,a):t,i=e.length-1,s;i>=0;i--)(s=e[i])&&(o=s(o)||o);return o},Ee=(e,t)=>(a,n)=>t(a,n,e);const Ce="SHEET_DATA_VALIDATION_ALERT";let Fe=class extends r.Disposable{constructor(e,t,a,n,o,i){super(),this._hoverManagerService=e,this._cellAlertManagerService=t,this._univerInstanceService=a,this._localeService=n,this._zenZoneService=o,this._dataValidationModel=i,this._init()}_init(){this._initCellAlertPopup(),this._initZenService()}_initCellAlertPopup(){this.disposeWithMe(this._hoverManagerService.currentCell$.pipe(ie.debounceTime(100)).subscribe(e=>{var t;if(e){const a=this._univerInstanceService.getUnit(e.location.unitId,r.UniverInstanceType.UNIVER_SHEET),n=a.getSheetBySheetId(e.location.subUnitId);if(!n)return;const o=this._dataValidationModel.getRuleByLocation(e.location.unitId,e.location.subUnitId,e.location.row,e.location.col);if(!o){this._cellAlertManagerService.removeAlert(Ce);return}if(this._dataValidationModel.validator(o,{...e.location,workbook:a,worksheet:n})===r.DataValidationStatus.INVALID){const s=this._cellAlertManagerService.currentAlert.get(Ce),l=(t=s==null?void 0:s.alert)==null?void 0:t.location;if(l&&l.row===e.location.row&&l.col===e.location.col&&l.subUnitId===e.location.subUnitId&&l.unitId===e.location.unitId){this._cellAlertManagerService.removeAlert(Ce);return}const d=this._dataValidationModel.getValidator(o.type);if(!d){this._cellAlertManagerService.removeAlert(Ce);return}this._cellAlertManagerService.showAlert({type:$.CellAlertType.ERROR,title:this._localeService.t("dataValidation.error.title"),message:d==null?void 0:d.getRuleFinalError(o,e.location),location:e.location,width:200,height:74,key:Ce});return}}this._cellAlertManagerService.removeAlert(Ce)}))}_initZenService(){this.disposeWithMe(this._zenZoneService.visible$.subscribe(e=>{e&&this._cellAlertManagerService.removeAlert(Ce)}))}};Fe=Mn([Ee(0,r.Inject($.HoverManagerService)),Ee(1,r.Inject($.CellAlertManagerService)),Ee(2,r.IUniverInstanceService),Ee(3,r.Inject(r.LocaleService)),Ee(4,f.IZenZoneService),Ee(5,r.Inject(E.SheetDataValidationModel))],Fe);var bn=Object.getOwnPropertyDescriptor,Ln=(e,t,a,n)=>{for(var o=n>1?void 0:n?bn(t,a):t,i=e.length-1,s;i>=0;i--)(s=e[i])&&(o=s(o)||o);return o},lt=(e,t)=>(a,n)=>t(a,n,e);let Me=class extends r.Disposable{constructor(e,t,a){super(),this._autoFillService=e,this._sheetDataValidationModel=t,this._injector=a,this._initAutoFill()}_initAutoFill(){const e=()=>({redos:[],undos:[]}),t=(n,o)=>{const{source:i,target:s,unitId:l,subUnitId:d}=n,h=this._sheetDataValidationModel.getRuleObjectMatrix(l,d).clone(),p=$.virtualizeDiscreteRanges([i,s]),[v,c]=p.ranges,{mapFunc:D}=p,g={row:v.startRow,col:v.startColumn},M=$.getAutoFillRepeatRange(v,c),w=new r.ObjectMatrix,m=new Set;M.forEach(y=>{const I=y.repeatStartCell,O=y.relativeRange,N={startRow:g.row,startColumn:g.col,endColumn:g.col,endRow:g.row},H={startRow:I.row,startColumn:I.col,endColumn:I.col,endRow:I.row};r.Range.foreach(O,(A,F)=>{const U=r.Rectangle.getPositionRange({startRow:A,startColumn:F,endColumn:F,endRow:A},N),{row:j,col:W}=D(U.startRow,U.startColumn),Y=this._sheetDataValidationModel.getRuleIdByLocation(l,d,j,W)||"",q=r.Rectangle.getPositionRange({startRow:A,startColumn:F,endColumn:F,endRow:A},H),{row:Z,col:G}=D(q.startRow,q.startColumn);w.setValue(Z,G,Y),m.add(Y)})});const S=Array.from(m).map(y=>({id:y,ranges:r.queryObjectMatrix(w,I=>I===y)}));h.addRangeRules(S);const _=h.diff(this._sheetDataValidationModel.getRules(l,d)),{redoMutations:T,undoMutations:C}=E.getDataValidationDiffMutations(l,d,_,this._injector,"patched",o===$.APPLY_TYPE.ONLY_FORMAT);return{undos:C,redos:T}},a={id:E.DATA_VALIDATION_PLUGIN_NAME,onBeforeFillData:n=>{const{source:o,unitId:i,subUnitId:s}=n;for(const l of o.rows)for(const d of o.cols){const h=this._sheetDataValidationModel.getRuleByLocation(i,s,l,d);if(h&&h.type===r.DataValidationType.CHECKBOX){this._autoFillService.setDisableApplyType($.APPLY_TYPE.SERIES,!0);return}}},onFillData:(n,o,i)=>i===$.APPLY_TYPE.COPY||i===$.APPLY_TYPE.ONLY_FORMAT||i===$.APPLY_TYPE.SERIES?t(n,i):e(),onAfterFillData:()=>{}};this.disposeWithMe(this._autoFillService.addHook(a))}};Me=Ln([lt(0,$.IAutoFillService),lt(1,r.Inject(E.SheetDataValidationModel)),lt(2,r.Inject(r.Injector))],Me);var Tn=Object.getOwnPropertyDescriptor,On=(e,t,a,n)=>{for(var o=n>1?void 0:n?Tn(t,a):t,i=e.length-1,s;i>=0;i--)(s=e[i])&&(o=s(o)||o);return o},dt=(e,t)=>(a,n)=>t(a,n,e);let be=class extends r.Disposable{constructor(t,a,n){super();R(this,"_copyInfo");this._sheetClipboardService=t,this._sheetDataValidationModel=a,this._injector=n,this._initCopyPaste()}_initCopyPaste(){this._sheetClipboardService.addClipboardHook({id:E.DATA_VALIDATION_PLUGIN_NAME,onBeforeCopy:(t,a,n)=>this._collect(t,a,n),onPasteCells:(t,a,n,o)=>{const{copyType:i=$.COPY_TYPE.COPY,pasteType:s}=o,{range:l}=t||{},{range:d,unitId:h,subUnitId:p}=a;return this._generateMutations(d,{copyType:i,pasteType:s,copyRange:l,unitId:h,subUnitId:p})}})}_collect(t,a,n){const o=new r.ObjectMatrix;this._copyInfo={unitId:t,subUnitId:a,matrix:o};const i=this._injector.invoke(d=>X.rangeToDiscreteRange(n,d,t,a));if(!i)return;const{rows:s,cols:l}=i;s.forEach((d,h)=>{l.forEach((p,v)=>{const c=this._sheetDataValidationModel.getRuleIdByLocation(t,a,d,p);o.setValue(h,v,c!=null?c:"")})})}_generateMutations(t,a){if(!this._copyInfo)return{redos:[],undos:[]};if(a.copyType===$.COPY_TYPE.CUT)return this._copyInfo=null,{redos:[],undos:[]};if(!this._copyInfo||!this._copyInfo.matrix.getSizeOf()||!a.copyRange)return{redos:[],undos:[]};if([$.PREDEFINED_HOOK_NAME.SPECIAL_PASTE_COL_WIDTH,$.PREDEFINED_HOOK_NAME.SPECIAL_PASTE_VALUE,$.PREDEFINED_HOOK_NAME.SPECIAL_PASTE_FORMAT,$.PREDEFINED_HOOK_NAME.SPECIAL_PASTE_FORMULA].includes(a.pasteType))return{redos:[],undos:[]};const{unitId:o,subUnitId:i}=this._copyInfo;if(a.unitId!==o||i!==a.subUnitId){const s=this._sheetDataValidationModel.getRuleObjectMatrix(a.unitId,a.subUnitId).clone(),l=new r.ObjectMatrix,d=new Set,{ranges:[h,p],mapFunc:v}=$.virtualizeDiscreteRanges([a.copyRange,t]),c=$.getRepeatRange(h,p,!0),D=new Map;c.forEach(({startRange:m})=>{var S;(S=this._copyInfo)==null||S.matrix.forValue((_,T,C)=>{const y=r.Rectangle.getPositionRange({startRow:_,endRow:_,startColumn:T,endColumn:T},m),I=`${i}-${C}`,O=this._sheetDataValidationModel.getRuleById(o,i,C);!this._sheetDataValidationModel.getRuleById(a.unitId,a.subUnitId,I)&&O&&D.set(I,{...O,uid:I});const{row:N,col:H}=v(y.startRow,y.startColumn);d.add(I),l.setValue(N,H,I)})});const g=Array.from(d).map(m=>({id:m,ranges:r.queryObjectMatrix(l,S=>S===m)}));s.addRangeRules(g);const{redoMutations:M,undoMutations:w}=E.getDataValidationDiffMutations(a.unitId,a.subUnitId,s.diffWithAddition(this._sheetDataValidationModel.getRules(a.unitId,a.subUnitId),D.values()),this._injector,"patched",!1);return{redos:M,undos:w}}else{const s=this._sheetDataValidationModel.getRuleObjectMatrix(o,i).clone(),l=new r.ObjectMatrix,d=new Set,{ranges:[h,p],mapFunc:v}=$.virtualizeDiscreteRanges([a.copyRange,t]);$.getRepeatRange(h,p,!0).forEach(({startRange:w})=>{var m;(m=this._copyInfo)==null||m.matrix.forValue((S,_,T)=>{const C=r.Rectangle.getPositionRange({startRow:S,endRow:S,startColumn:_,endColumn:_},w),{row:y,col:I}=v(C.startRow,C.startColumn);l.setValue(y,I,T),d.add(T)})});const D=Array.from(d).map(w=>({id:w,ranges:r.queryObjectMatrix(l,m=>m===w)}));s.addRangeRules(D);const{redoMutations:g,undoMutations:M}=E.getDataValidationDiffMutations(o,i,s.diff(this._sheetDataValidationModel.getRules(o,i)),this._injector,"patched",!1);return{redos:g,undos:M}}}};be=On([dt(0,$.ISheetClipboardService),dt(1,r.Inject(E.SheetDataValidationModel)),dt(2,r.Inject(r.Injector))],be);var Pn=Object.getOwnPropertyDescriptor,Rn=(e,t,a,n)=>{for(var o=n>1?void 0:n?Pn(t,a):t,i=e.length-1,s;i>=0;i--)(s=e[i])&&(o=s(o)||o);return o},ct=(e,t)=>(a,n)=>t(a,n,e);let Le=class extends r.Disposable{constructor(e,t,a){super(),this._localeService=e,this._commandService=t,this._sheetPermissionCheckController=a,this._commandExecutedListener()}_commandExecutedListener(){this.disposeWithMe(this._commandService.beforeCommandExecuted(e=>{e.id===E.AddSheetDataValidationCommand.id&&(this._sheetPermissionCheckController.permissionCheckWithRanges({workbookTypes:[X.WorkbookEditablePermission],rangeTypes:[X.RangeProtectionPermissionEditPoint],worksheetTypes:[X.WorksheetEditPermission,X.WorksheetSetCellStylePermission]})||this._sheetPermissionCheckController.blockExecuteWithoutPermission(this._localeService.t("permission.dialog.setStyleErr"))),e.id===E.UpdateSheetDataValidationRangeCommand.id&&(this._sheetPermissionCheckController.permissionCheckWithRanges({workbookTypes:[X.WorkbookEditablePermission],rangeTypes:[X.RangeProtectionPermissionEditPoint],worksheetTypes:[X.WorksheetEditPermission,X.WorksheetSetCellStylePermission]},e.params.ranges)||this._sheetPermissionCheckController.blockExecuteWithoutPermission(this._localeService.t("permission.dialog.setStyleErr")))}))}};Le=Rn([ct(0,r.Inject(r.LocaleService)),ct(1,r.ICommandService),ct(2,r.Inject(X.SheetPermissionCheckController))],Le);const At="data-validation-single",Ft="sheet.menu.data-validation";function An(e){return{id:Ft,type:f.MenuItemType.SUBITEMS,icon:At,tooltip:"dataValidation.title",hidden$:f.getMenuHiddenObservable(e,r.UniverInstanceType.UNIVER_SHEET),disabled$:$.getCurrentRangeDisable$(e,{workbookTypes:[X.WorkbookEditablePermission],worksheetTypes:[X.WorksheetSetCellStylePermission,X.WorksheetEditPermission],rangeTypes:[X.RangeProtectionPermissionEditPoint]})}}function Fn(e){return{id:Ie.id,title:"dataValidation.panel.title",type:f.MenuItemType.BUTTON}}function kn(e){return{id:He.id,title:"dataValidation.panel.add",type:f.MenuItemType.BUTTON}}const Nn={[f.RibbonStartGroup.FORMULAS_INSERT]:{[Ft]:{order:9,menuItemFactory:An,[Ie.id]:{order:0,menuItemFactory:Fn},[He.id]:{order:1,menuItemFactory:kn}}}};var Un=Object.getOwnPropertyDescriptor,kt=(e,t,a,n)=>{for(var o=n>1?void 0:n?Un(t,a):t,i=e.length-1,s;i>=0;i--)(s=e[i])&&(o=s(o)||o);return o},Q=(e,t)=>(a,n)=>t(a,n,e);const Nt={tr:{size:6,color:"#fe4b4b"}};let Te=class extends r.RxDisposable{constructor(e,t,a,n,o,i,s,l,d,h,p){super(),this._commandService=e,this._menuManagerService=t,this._renderManagerService=a,this._univerInstanceService=n,this._autoHeightController=o,this._dropdownManagerService=i,this._sheetDataValidationModel=s,this._dataValidatorRegistryService=l,this._sheetInterceptorService=d,this._dataValidationCacheService=h,this._editorBridgeService=p,this._initMenu(),this._initDropdown(),this._initViewModelIntercept(),this._initAutoHeight()}_initMenu(){this._menuManagerService.mergeMenu(Nn)}_initDropdown(){this._editorBridgeService&&this.disposeWithMe(this._editorBridgeService.visible$.subscribe(e=>{var a;if(!e.visible){((a=this._dropdownManagerService.activeDropdown)==null?void 0:a.trigger)==="editor-bridge"&&this._dropdownManagerService.hideDropdown();return}const t=this._editorBridgeService.getEditCellState();if(t){const{unitId:n,sheetId:o,row:i,column:s}=t,l=this._univerInstanceService.getUniverSheetInstance(n);if(!l)return;const d=this._sheetDataValidationModel.getRuleByLocation(n,o,i,s);if(!d)return;const h=this._dataValidatorRegistryService.getValidatorItem(d.type);if(!(h!=null&&h.dropdown))return;const p=l.getActiveSheet();if(!p)return;const v=this._dropdownManagerService.activeDropdown,c=v==null?void 0:v.location;if(c&&c.unitId===n&&c.subUnitId===o&&c.row===i&&c.col===s)return;this._dropdownManagerService.showDropdown({location:{unitId:n,subUnitId:o,row:i,col:s,workbook:l,worksheet:p},componentKey:h.dropdown,onHide:()=>{},trigger:"editor-bridge"},!1)}}))}_initViewModelIntercept(){this.disposeWithMe(this._sheetInterceptorService.intercept(X.INTERCEPTOR_POINT.CELL_CONTENT,{effect:r.InterceptorEffectEnum.Style,priority:X.InterceptCellContentPriority.DATA_VALIDATION,handler:(e,t,a)=>{var m,S,_,T,C;const{row:n,col:o,unitId:i,subUnitId:s,workbook:l,worksheet:d}=t,h=this._sheetDataValidationModel.getRuleIdByLocation(i,s,n,o);if(!h)return a(e);const p=this._sheetDataValidationModel.getRuleById(i,s,h);if(!p)return a(e);const v=(m=this._dataValidationCacheService.getValue(i,s,n,o))!=null?m:r.DataValidationStatus.VALID,c=this._dataValidatorRegistryService.getValidatorItem(p.type),D=t.rawData;let g;const M={get value(){var y;return g!==void 0||(g=(y=E.getCellValueOrigin(D))!=null?y:null),g}},w={get value(){var y;return`${(y=M.value)!=null?y:""}`}};return a({...e,markers:{...e==null?void 0:e.markers,...v===r.DataValidationStatus.INVALID?Nt:null},customRender:[...(S=e==null?void 0:e.customRender)!=null?S:[],...c!=null&&c.canvasRender?[c.canvasRender]:[]],fontRenderExtension:{...e==null?void 0:e.fontRenderExtension,isSkip:((_=e==null?void 0:e.fontRenderExtension)==null?void 0:_.isSkip)||((T=c==null?void 0:c.skipDefaultFontRender)==null?void 0:T.call(c,p,M.value,t))},interceptorStyle:{...e==null?void 0:e.interceptorStyle,...c==null?void 0:c.getExtraStyle(p,w.value,{get style(){const y=l.getStyles();return(typeof(e==null?void 0:e.s)=="string"?y.get(e==null?void 0:e.s):e==null?void 0:e.s)||{}}},n,o)},interceptorAutoHeight:()=>{var N,H,A,F,U,j;const y=(H=(N=this._renderManagerService.getRenderById(i))==null?void 0:N.with($.SheetSkeletonManagerService).getSkeletonParam(s))==null?void 0:H.skeleton;if(!y)return;const I=y.worksheet.getMergedCell(n,o),O={data:e,style:y.getStyles().getStyleByCell(e),primaryWithCoord:y.getCellWithCoordByIndex((A=I==null?void 0:I.startRow)!=null?A:n,(F=I==null?void 0:I.startColumn)!=null?F:o),unitId:i,subUnitId:s,row:n,col:o,workbook:l,worksheet:d};return(j=(U=c==null?void 0:c.canvasRender)==null?void 0:U.calcCellAutoHeight)==null?void 0:j.call(U,O)},interceptorAutoWidth:()=>{var N,H,A,F,U,j;const y=(H=(N=this._renderManagerService.getRenderById(i))==null?void 0:N.with($.SheetSkeletonManagerService).getSkeletonParam(s))==null?void 0:H.skeleton;if(!y)return;const I=y.worksheet.getMergedCell(n,o),O={data:e,style:y.getStyles().getStyleByCell(e),primaryWithCoord:y.getCellWithCoordByIndex((A=I==null?void 0:I.startRow)!=null?A:n,(F=I==null?void 0:I.startColumn)!=null?F:o),unitId:i,subUnitId:s,row:n,col:o,workbook:l,worksheet:d};return(j=(U=c==null?void 0:c.canvasRender)==null?void 0:U.calcCellAutoWidth)==null?void 0:j.call(U,O)},coverable:((C=e==null?void 0:e.coverable)!=null?C:!0)&&!(p.type===r.DataValidationType.LIST||p.type===r.DataValidationType.LIST_MULTIPLE)})}}))}_initAutoHeight(){this._sheetDataValidationModel.ruleChange$.pipe(ie.filter(e=>e.source==="command"),ie.bufferTime(100)).subscribe(e=>{if(e.length===0)return;const t=[];if(e.forEach(a=>{var n;(a.rule.type===r.DataValidationType.LIST_MULTIPLE||a.rule.type===r.DataValidationType.LIST)&&(n=a.rule)!=null&&n.ranges&&t.push(...a.rule.ranges)}),t.length){const a=this._autoHeightController.getUndoRedoParamsOfAutoHeight(t);r.sequenceExecute(a.redos,this._commandService)}})}};Te=kt([Q(0,r.ICommandService),Q(1,f.IMenuManagerService),Q(2,k.IRenderManagerService),Q(3,r.IUniverInstanceService),Q(4,r.Inject($.AutoHeightController)),Q(5,r.Inject(me)),Q(6,r.Inject(E.SheetDataValidationModel)),Q(7,r.Inject(J.DataValidatorRegistryService)),Q(8,r.Inject(X.SheetInterceptorService)),Q(9,r.Inject(E.DataValidationCacheService)),Q(10,r.Optional($.IEditorBridgeService))],Te);let Ut=class extends r.RxDisposable{constructor(e,t,a,n,o,i,s){super(),this._commandService=e,this._renderManagerService=t,this._autoHeightController=a,this._dataValidatorRegistryService=n,this._sheetInterceptorService=o,this._sheetDataValidationModel=i,this._dataValidationCacheService=s,this._initViewModelIntercept(),this._initAutoHeight()}_initViewModelIntercept(){this.disposeWithMe(this._sheetInterceptorService.intercept(X.INTERCEPTOR_POINT.CELL_CONTENT,{effect:r.InterceptorEffectEnum.Style,priority:X.InterceptCellContentPriority.DATA_VALIDATION,handler:(e,t,a)=>{var w,m,S,_,T;const{row:n,col:o,unitId:i,subUnitId:s,workbook:l,worksheet:d}=t,h=this._sheetDataValidationModel.getRuleIdByLocation(i,s,n,o);if(!h)return a(e);const p=this._sheetDataValidationModel.getRuleById(i,s,h);if(!p)return a(e);const v=(w=this._dataValidationCacheService.getValue(i,s,n,o))!=null?w:r.DataValidationStatus.VALID,c=this._dataValidatorRegistryService.getValidatorItem(p.type),D=d.getCellRaw(n,o),g=E.getCellValueOrigin(D),M=`${g!=null?g:""}`;return a({...e,markers:{...e==null?void 0:e.markers,...v===r.DataValidationStatus.INVALID?Nt:null},customRender:[...(m=e==null?void 0:e.customRender)!=null?m:[],...c!=null&&c.canvasRender?[c.canvasRender]:[]],fontRenderExtension:{...e==null?void 0:e.fontRenderExtension,isSkip:((S=e==null?void 0:e.fontRenderExtension)==null?void 0:S.isSkip)||((_=c==null?void 0:c.skipDefaultFontRender)==null?void 0:_.call(c,p,g,t))},interceptorStyle:{...e==null?void 0:e.interceptorStyle,...c==null?void 0:c.getExtraStyle(p,M,{get style(){const C=l.getStyles();return(typeof(e==null?void 0:e.s)=="string"?C.get(e==null?void 0:e.s):e==null?void 0:e.s)||{}}},n,o)},interceptorAutoHeight:()=>{var O,N,H,A,F,U;const C=(N=(O=this._renderManagerService.getRenderById(i))==null?void 0:O.with($.SheetSkeletonManagerService).getSkeletonParam(s))==null?void 0:N.skeleton;if(!C)return;const y=C.worksheet.getMergedCell(n,o),I={data:e,style:C.getStyles().getStyleByCell(e),primaryWithCoord:C.getCellWithCoordByIndex((H=y==null?void 0:y.startRow)!=null?H:n,(A=y==null?void 0:y.startColumn)!=null?A:o),unitId:i,subUnitId:s,row:n,col:o,workbook:l,worksheet:d};return(U=(F=c==null?void 0:c.canvasRender)==null?void 0:F.calcCellAutoHeight)==null?void 0:U.call(F,I)},coverable:((T=e==null?void 0:e.coverable)!=null?T:!0)&&!(p.type===r.DataValidationType.LIST||p.type===r.DataValidationType.LIST_MULTIPLE)})}}))}_initAutoHeight(){this._sheetDataValidationModel.ruleChange$.pipe(ie.filter(e=>e.source==="command"),ie.bufferTime(16)).subscribe(e=>{const t=[];if(e.forEach(a=>{var n;(n=a.rule)!=null&&n.ranges&&t.push(...a.rule.ranges)}),t.length){const a=this._autoHeightController.getUndoRedoParamsOfAutoHeight(t);r.sequenceExecute(a.redos,this._commandService)}})}};Ut=kt([Q(0,r.ICommandService),Q(1,k.IRenderManagerService),Q(2,r.Inject($.AutoHeightController)),Q(3,r.Inject(J.DataValidatorRegistryService)),Q(4,r.Inject(X.SheetInterceptorService)),Q(5,r.Inject(E.SheetDataValidationModel)),Q(6,r.Inject(E.DataValidationCacheService))],Ut);var Bn=Object.getOwnPropertyDescriptor,jn=(e,t,a,n)=>{for(var o=n>1?void 0:n?Bn(t,a):t,i=e.length-1,s;i>=0;i--)(s=e[i])&&(o=s(o)||o);return o},Bt=(e,t)=>(a,n)=>t(a,n,e);let Ye=class extends r.Disposable{constructor(e,t,a){super(),this._context=e,this._sheetDataValidationModel=t,this._sheetSkeletonManagerService=a,this._initSkeletonChange()}_initSkeletonChange(){const e=t=>{var n;if(!t.length)return;const a=new Set;t.forEach(o=>{a.add(o.subUnitId)}),a.forEach(o=>{var i;(i=this._sheetSkeletonManagerService.getSkeletonParam(o))==null||i.skeleton.makeDirty(!0)}),(n=this._context.mainComponent)==null||n.makeForceDirty()};this.disposeWithMe(this._sheetDataValidationModel.validStatusChange$.pipe(r.bufferDebounceTime(16)).subscribe(e))}};Ye=jn([Bt(1,r.Inject(E.SheetDataValidationModel)),Bt(2,r.Inject($.SheetSkeletonManagerService))],Ye);const ne={dataValidationFormula:"univer-data-validation-formula",dataValidationFormulaAnd:"univer-data-validation-formula-and",dataValidationFormulaListItem:"univer-data-validation-formula-list-item",dataValidationFormulaListItemIcon:"univer-data-validation-formula-list-item-icon",dataValidationFormulaListItemDrag:"univer-data-validation-formula-list-item-drag",dataValidationFormulaListAdd:"univer-data-validation-formula-list-add",dataValidationFormulaColorSelect:"univer-data-validation-formula-color-select",dataValidationFormulaColorSelectPanel:"univer-data-validation-formula-color-select-panel",dataValidationFormulaColorItem:"univer-data-validation-formula-color-item"},Wn=e=>{const{isTwoFormula:t=!1,value:a,onChange:n,showError:o,validResult:i}=e,s=f.useDependency(r.LocaleService),l=o?i==null?void 0:i.formula1:"",d=o?i==null?void 0:i.formula2:"";return t?u.jsxs(u.Fragment,{children:[u.jsx(L.FormLayout,{error:l,children:u.jsx(L.Input,{className:ne.dataValidationFormula,placeholder:s.t("dataValidation.panel.formulaPlaceholder"),value:a==null?void 0:a.formula1,onChange:h=>{n==null||n({...a,formula1:h})}})}),u.jsx("div",{className:ne.dataValidationFormulaAnd,children:s.t("dataValidation.panel.formulaAnd")}),u.jsx(L.FormLayout,{error:d,children:u.jsx(L.Input,{className:ne.dataValidationFormula,placeholder:s.t("dataValidation.panel.formulaPlaceholder"),value:a==null?void 0:a.formula2,onChange:h=>{n==null||n({...a,formula2:h})}})})]}):u.jsx(L.FormLayout,{error:l,children:u.jsx(L.Input,{className:ne.dataValidationFormula,placeholder:s.t("dataValidation.panel.formulaPlaceholder"),value:a==null?void 0:a.formula1,onChange:h=>{n==null||n({formula1:h})}})})};function $n(e){const{value:t,onChange:a,showError:n,validResult:o}=e,i=f.useDependency(r.LocaleService),s=n?o==null?void 0:o.formula1:"",l=n?o==null?void 0:o.formula2:"",[d,h]=V.useState(!((t==null?void 0:t.formula1)===void 0&&(t==null?void 0:t.formula2)===void 0));return u.jsxs(u.Fragment,{children:[u.jsx(L.FormLayout,{children:u.jsx(L.Checkbox,{checked:d,onChange:p=>{p?h(!0):(h(!1),a==null||a({...t,formula1:void 0,formula2:void 0}))},children:i.t("dataValidation.checkbox.tips")})}),d?u.jsx(L.FormLayout,{label:i.t("dataValidation.checkbox.checked"),error:s,children:u.jsx(L.Input,{className:ne.dataValidationFormula,placeholder:i.t("dataValidation.panel.valuePlaceholder"),value:t==null?void 0:t.formula1,onChange:p=>{a==null||a({...t,formula1:p||void 0})}})}):null,d?u.jsx(L.FormLayout,{label:i.t("dataValidation.checkbox.unchecked"),error:l,children:u.jsx(L.Input,{className:ne.dataValidationFormula,placeholder:i.t("dataValidation.panel.valuePlaceholder"),value:t==null?void 0:t.formula2,onChange:p=>{a==null||a({...t,formula2:p||void 0})}})}):null]})}function Hn(e){var v;const{unitId:t,subUnitId:a,value:n,onChange:o,showError:i,validResult:s}=e,l=i?s==null?void 0:s.formula1:void 0,d=V.useRef({}),[h,p]=V.useState(!1);return f.useSidebarClick(c=>{var g;const D=(g=d.current)==null?void 0:g.handleOutClick;D&&D(c,()=>p(!1))}),u.jsx(nt.FormulaEditor,{initValue:(v=n==null?void 0:n.formula1)!=null?v:"=",unitId:t,subUnitId:a,isFocus:h,onChange:c=>{const D=(c!=null?c:"").trim();D!==(n==null?void 0:n.formula1)&&(o==null||o({...n,formula1:D}))},errorText:l,onFocus:()=>p(!0),actions:d.current,isSupportAcrossSheet:!0})}const Yn=["#FFFFFF","#FEE7E7","#FEF0E6","#EFFBD0","#E4F4FE","#E8ECFD","#F1EAFA","#FDE8F3","#E5E5E5","#FDCECE","#FDC49B","#DEF6A2","#9FDAFF","#D0D9FB","#E3D5F6","#FBD0E8","#656565","#FE4B4B","#FF8C51","#8BBB11","#0B9EFB","#3A60F7","#9E6DE3","#F248A6"],xn=e=>{const{value:t,onChange:a,disabled:n}=e,[o,i]=V.useState(!1);return u.jsx(L.Select,{disabled:n,open:o,onDropdownVisibleChange:i,dropdownStyle:{width:112},style:{width:96,cursor:"pointer"},className:ne.dataValidationFormulaColorSelect,value:t,onChange:a,labelRender:s=>u.jsx("div",{className:ne.dataValidationFormulaColorItem,style:{background:s.value,marginTop:5}}),dropdownRender:()=>u.jsx("div",{className:ne.dataValidationFormulaColorSelectPanel,children:Yn.map(s=>u.jsx("div",{onClick:()=>{a(s),i(!1)},className:ne.dataValidationFormulaColorItem,style:{background:s}},s))})})},jt=e=>{const{item:t,commonProps:a,style:n}=e,{onItemChange:o,onItemDelete:i}=a;return u.jsxs("div",{className:ne.dataValidationFormulaListItem,style:n,children:[t.isRef?null:u.jsx("div",{className:L.clsx(ne.dataValidationFormulaListItemDrag,"draggableHandle"),children:u.jsx(Lt,{})}),u.jsx(xn,{value:t.color,onChange:s=>{o(t.id,t.label,s)}}),u.jsx(L.Input,{disabled:t.isRef,value:t.label,onChange:s=>{o(t.id,s,t.color)}}),t.isRef?null:u.jsx("div",{className:ne.dataValidationFormulaListItemIcon,children:u.jsx(at,{onClick:()=>i(t.id)})})]})};function Xn(e){const{value:t,onChange:a=()=>{},unitId:n,subUnitId:o,validResult:i,showError:s,ruleId:l}=e,{formula1:d="",formula2:h=""}=t||{},p=V.useRef(null),[v,c]=V.useState(()=>r.isFormulaString(d)?"1":"0"),[D,g]=V.useState(v==="1"?d:"="),[M,w]=V.useState(v==="1"?d:"="),m=f.useDependency(r.LocaleService),S=f.useDependency(J.DataValidatorRegistryService),_=f.useDependency(J.DataValidationModel),T=f.useDependency(E.DataValidationFormulaController),[C,y]=V.useState(()=>h.split(",")),I=S.getValidatorItem(r.DataValidationType.LIST),[O,N]=V.useState([]),[H,A]=V.useState(""),F=s?i==null?void 0:i.formula1:"",U=V.useMemo(()=>_.ruleChange$.pipe(ie.debounceTime(16)),[]),j=f.useObservable(U),W=f.useEvent(a);V.useEffect(()=>{(async()=>{await new Promise(z=>{setTimeout(()=>z(!0),100)});const b=_.getRuleById(n,o,l),B=b==null?void 0:b.formula1;if(r.isFormulaString(B)&&I&&b){const z=await I.getListAsync(b,n,o);N(z)}})()},[_,j,I,l,o,n]),V.useEffect(()=>{r.isFormulaString(d)&&d!==M&&(g(d),w(M))},[M,d]);const[Y,q]=V.useState(()=>{const b=v!=="1"?E.deserializeListOptions(d):[],B=h.split(",");return b.map((z,K)=>({label:z,color:B[K]||_e,isRef:!1,id:r.Tools.generateRandomId(4)}))}),Z=(b,B,z)=>{const K=Y.find(fe=>fe.id===b);K&&(K.label=B,K.color=z,q([...Y]))},G=b=>{const B=Y.findIndex(z=>z.id===b);B!==-1&&(Y.splice(B,1),q([...Y]))},ee=h.split(","),te=V.useMemo(()=>O.map((b,B)=>({label:b,color:ee[B]||_e,id:`${B}`,isRef:!0})),[ee,O]),ae=(b,B,z)=>{const K=[...C];K[+b]=z,y(K),W({formula1:d,formula2:K.join(",")})},oe=()=>{q([...Y,{label:"",color:_e,isRef:!1,id:r.Tools.generateRandomId(4)}])};V.useEffect(()=>{if(v==="1")return;const b=new Set,B=[];Y.map(z=>({labelList:z.label.split(","),item:z})).forEach(({item:z,labelList:K})=>{K.forEach(fe=>{b.has(fe)||(b.add(fe),B.push({label:fe,color:z.color}))})}),W({formula1:E.serializeListOptions(B.map(z=>z.label)),formula2:B.map(z=>z.color===_e?"":z.color).join(",")})},[Y,W,v,M,C]);const le=f.useEvent(async b=>{if(!r.isFormulaString(b)){W==null||W({formula1:"",formula2:h});return}T.getFormulaRefCheck(b)?(W==null||W({formula1:r.isFormulaString(b)?b:"",formula2:h}),A("")):(W==null||W({formula1:"",formula2:h}),g("="),A(m.t("dataValidation.validFail.formulaError")))}),re=V.useRef({}),[de,P]=V.useState(!1);return f.useSidebarClick(b=>{var z;const B=(z=re.current)==null?void 0:z.handleOutClick;B&&B(b,()=>P(!1))}),u.jsxs(u.Fragment,{children:[u.jsx(L.FormLayout,{label:m.t("dataValidation.list.options"),children:u.jsxs(L.RadioGroup,{value:v,onChange:b=>{c(b),g(M),b==="1"&&W({formula1:M==="="?"":M,formula2:C.join(",")})},children:[u.jsx(L.Radio,{value:"0",children:m.t("dataValidation.list.customOptions")}),u.jsx(L.Radio,{value:"1",children:m.t("dataValidation.list.refOptions")})]})}),v==="1"?u.jsxs(u.Fragment,{children:[u.jsx(nt.FormulaEditor,{initValue:D,unitId:n,subUnitId:o,isFocus:de,onChange:(b="")=>{const B=(b!=null?b:"").trim();w(B),le(B)},errorText:F||H||void 0,onFocus:()=>P(!0),actions:re.current,isSupportAcrossSheet:!0}),u.jsx("div",{ref:p,style:{marginTop:"12px"},children:te.map(b=>u.jsx(jt,{item:b,commonProps:{onItemChange:ae},style:{marginBottom:12}},b.id))})]}):u.jsx(L.FormLayout,{error:F,children:u.jsxs("div",{ref:p,style:{marginTop:"-12px"},children:[u.jsx(L.DraggableList,{list:Y,onListChange:q,rowHeight:32,margin:[0,12],draggableHandle:".draggableHandle",itemRender:b=>u.jsx(jt,{item:b,commonProps:{onItemChange:Z,onItemDelete:G}},b.id),idKey:"id"}),u.jsxs("a",{className:ne.dataValidationFormulaListAdd,onClick:oe,children:[u.jsx(Et,{}),m.t("dataValidation.list.add")]})]})})]})}const Wt="data-validation.custom-formula-input",xe="data-validation.formula-input",ut="data-validation.list-formula-input",$t="data-validation.checkbox-formula-input",zn=[[Wt,Hn],[xe,Wn],[ut,Xn],[$t,$n]],Kn="LIST_RENDER_MODE_OPTION_INPUT";function Xe(e){var o;const{value:t,onChange:a}=e,n=f.useDependency(r.LocaleService);return u.jsx(L.FormLayout,{label:n.t("dataValidation.renderMode.label"),children:u.jsxs(L.RadioGroup,{value:`${(o=t.renderMode)!=null?o:r.DataValidationRenderMode.CUSTOM}`,onChange:i=>a({...t,renderMode:+i}),children:[u.jsx(L.Radio,{value:`${r.DataValidationRenderMode.CUSTOM}`,children:n.t("dataValidation.renderMode.chip")}),u.jsx(L.Radio,{value:`${r.DataValidationRenderMode.ARROW}`,children:n.t("dataValidation.renderMode.arrow")}),u.jsx(L.Radio,{value:`${r.DataValidationRenderMode.TEXT}`,children:n.t("dataValidation.renderMode.text")})]})})}Xe.componentKey=Kn;const Gn="DATE_SHOW_TIME_OPTION";function ze(e){var o;const{value:t,onChange:a}=e,n=f.useDependency(r.LocaleService);return u.jsx(L.FormLayout,{children:u.jsx(L.Checkbox,{checked:(o=t.bizInfo)==null?void 0:o.showTime,onChange:i=>{a({...t,bizInfo:{...t.bizInfo,showTime:i}})},children:n.t("dataValidation.showTime.label")})})}ze.componentKey=Gn;var qn=Object.getOwnPropertyDescriptor,Zn=(e,t,a,n)=>{for(var o=n>1?void 0:n?qn(t,a):t,i=e.length-1,s;i>=0;i--)(s=e[i])&&(o=s(o)||o);return o},Oe=(e,t)=>(a,n)=>t(a,n,e);const Ke=6;let ht=class{constructor(e,t,a,n,o,i){this._commandService=e,this._univerInstanceService=t,this._formulaService=a,this._themeService=n,this._renderManagerService=o,this._dataValidationModel=i}_calc(e,t){var h,p,v;const{vt:a,ht:n}=t||{},o=e.endX-e.startX-Ke*2,i=e.endY-e.startY,s=((h=t==null?void 0:t.fs)!=null?h:10)*1.6;let l=0,d=0;switch(a){case r.VerticalAlign.TOP:d=0;break;case r.VerticalAlign.BOTTOM:d=0+(i-s);break;default:d=0+(i-s)/2;break}switch(n){case r.HorizontalAlign.LEFT:l=Ke;break;case r.HorizontalAlign.RIGHT:l=Ke+(o-s);break;default:l=Ke+(o-s)/2;break}return{left:e.startX+l,top:e.startY+d,width:((p=t==null?void 0:t.fs)!=null?p:10)*1.6,height:((v=t==null?void 0:t.fs)!=null?v:10)*1.6}}calcCellAutoHeight(e){var a;const{style:t}=e;return((a=t==null?void 0:t.fs)!=null?a:10)*1.6}calcCellAutoWidth(e){var a;const{style:t}=e;return((a=t==null?void 0:t.fs)!=null?a:10)*1.6}async _parseFormula(e,t,a){var h,p,v,c,D,g,M,w,m;const{formula1:n=E.CHECKBOX_FORMULA_1,formula2:o=E.CHECKBOX_FORMULA_2}=e,i=await this._formulaService.getRuleFormulaResult(t,a,e.uid),s=E.getFormulaResult((v=(p=(h=i==null?void 0:i[0])==null?void 0:h.result)==null?void 0:p[0])==null?void 0:v[0]),l=E.getFormulaResult((g=(D=(c=i==null?void 0:i[1])==null?void 0:c.result)==null?void 0:D[0])==null?void 0:g[0]),d=E.isLegalFormulaResult(String(s))&&E.isLegalFormulaResult(String(l));return{formula1:r.isFormulaString(n)?E.getFormulaResult((m=(w=(M=i==null?void 0:i[0])==null?void 0:M.result)==null?void 0:w[0])==null?void 0:m[0]):n,formula2:r.isFormulaString(o)?l:o,isFormulaValid:d}}drawWith(e,t){var F,U,j,W;const{style:a,primaryWithCoord:n,unitId:o,subUnitId:i,worksheet:s,row:l,col:d}=t,h=n.isMergedMainCell?n.mergeInfo:n,p=E.getCellValueOrigin(s.getCellRaw(l,d)),v=this._dataValidationModel.getRuleByLocation(o,i,l,d);if(!v)return;const c=this._dataValidationModel.getValidator(v.type);if(!c)return;const D=this._themeService.getCurrentTheme();if(!((F=c.skipDefaultFontRender)!=null&&F.call(c,v,p,{unitId:o,subUnitId:i,row:l,column:d})))return;const g=c.parseFormulaSync(v,o,i),{formula1:M}=g,w=this._calc(h,a),{a:m,d:S}=e.getTransform(),_=k.fixLineWidthByScale(w.left,m),T=k.fixLineWidthByScale(w.top,S),C=k.Transform.create().composeMatrix({left:_,top:T,scaleX:1,scaleY:1,angle:0,skewX:0,skewY:0,flipX:!1,flipY:!1}),y=h.endX-h.startX,I=h.endY-h.startY;e.save(),e.beginPath(),e.rect(h.startX,h.startY,y,I),e.clip();const O=C.getMatrix();e.transform(O[0],O[1],O[2],O[3],O[4],O[5]);const N=((U=a==null?void 0:a.fs)!=null?U:10)*1.6,H=String(p)===String(M),A=D.hyacinth500;k.CheckboxShape.drawWith(e,{checked:H,width:N,height:N,fill:(W=(j=a==null?void 0:a.cl)==null?void 0:j.rgb)!=null?W:A}),e.restore()}isHit(e,t){const a=t.primaryWithCoord.isMergedMainCell?t.primaryWithCoord.mergeInfo:t.primaryWithCoord,n=this._calc(a,t.style),o=n.top,i=n.top+n.height,s=n.left,l=n.left+n.width,{x:d,y:h}=e;return d<=l&&d>=s&&h<=i&&h>=o}async onPointerDown(e,t){var g;if(t.button===2)return;const{primaryWithCoord:a,unitId:n,subUnitId:o,worksheet:i,row:s,col:l}=e,d=E.getCellValueOrigin(i.getCellRaw(s,l)),h=this._dataValidationModel.getRuleByLocation(n,o,s,l);if(!h)return;const p=this._dataValidationModel.getValidator(h.type);if(!p||!((g=p.skipDefaultFontRender)!=null&&g.call(p,h,d,{unitId:n,subUnitId:o,row:s,column:l})))return;const{formula1:v,formula2:c}=await this._parseFormula(h,n,o),D={range:{startColumn:a.actualColumn,endColumn:a.actualColumn,startRow:a.actualRow,endRow:a.actualRow},value:{v:String(d)===E.transformCheckboxValue(String(v))?c:v,p:null}};this._commandService.executeCommand(X.SetRangeValuesCommand.id,D)}onPointerEnter(e,t){var a,n;(n=(a=k.getCurrentTypeOfRenderer(r.UniverInstanceType.UNIVER_SHEET,this._univerInstanceService,this._renderManagerService))==null?void 0:a.mainComponent)==null||n.setCursor(k.CURSOR_TYPE.POINTER)}onPointerLeave(e,t){var a,n;(n=(a=k.getCurrentTypeOfRenderer(r.UniverInstanceType.UNIVER_SHEET,this._univerInstanceService,this._renderManagerService))==null?void 0:a.mainComponent)==null||n.setCursor(k.CURSOR_TYPE.DEFAULT)}};ht=Zn([Oe(0,r.ICommandService),Oe(1,r.IUniverInstanceService),Oe(2,r.Inject(E.DataValidationFormulaService)),Oe(3,r.Inject(r.ThemeService)),Oe(4,r.Inject(k.IRenderManagerService)),Oe(5,r.Inject(E.SheetDataValidationModel))],ht);var Jn=Object.getOwnPropertyDescriptor,Qn=(e,t,a,n)=>{for(var o=n>1?void 0:n?Jn(t,a):t,i=e.length-1,s;i>=0;i--)(s=e[i])&&(o=s(o)||o);return o},ea=(e,t)=>(a,n)=>t(a,n,e);let he=class{constructor(e){R(this,"canvasRender",null);R(this,"dropdown");R(this,"optionsInput");R(this,"formulaInput",ut);this.injector=e}};he=Qn([ea(0,r.Inject(r.Injector))],he);class ta extends he{constructor(){super(...arguments);R(this,"id",r.DataValidationType.CHECKBOX);R(this,"canvasRender",this.injector.createInstance(ht));R(this,"formulaInput",$t)}}class na extends he{constructor(){super(...arguments);R(this,"id",r.DataValidationType.CUSTOM);R(this,"formulaInput",Wt)}}const aa="data-validation.formula-input";class oa extends he{constructor(){super(...arguments);R(this,"id",r.DataValidationType.DATE);R(this,"formulaInput",aa);R(this,"optionsInput",ze.componentKey);R(this,"dropdown",st)}}class ia extends he{constructor(){super(...arguments);R(this,"id",r.DataValidationType.DECIMAL);R(this,"formulaInput",xe)}}const Ht=4,ra=0,pt=4,Yt=4,vt=6,Ge=6,De=14;function sa(e,t){const a=k.FontCache.getTextSize(e,t),n=a.width+Ht*2,{ba:o,bd:i}=a,s=o+i;return{width:n,height:s+ra*2,ba:o}}function gt(e,t,a,n){const o=De+vt*2,i=a-o,s=n-Ge*2,l=e.map(c=>({layout:sa(c,t),text:c}));let d;const h=[];l.forEach(c=>{const{layout:D}=c,{width:g,height:M}=D;!d||d.width+g+pt>i?(d={width:g,height:M,items:[{...c,left:0}]},h.push(d)):(d.items.push({...c,left:d.width+pt}),d.width=d.width+g+pt)});let p=0,v=0;return h.forEach((c,D)=>{v=Math.max(v,c.width),D===h.length-1?p+=c.height:p+=c.height+Yt}),{lines:h,totalHeight:p,contentWidth:i,contentHeight:s,cellAutoHeight:p+Ge*2,calcAutoWidth:v+o}}const la=8;class da extends k.Shape{static drawWith(t,a){const{fontString:n,info:o,fill:i,color:s}=a,{layout:l,text:d}=o;t.save(),k.Rect.drawWith(t,{width:l.width,height:l.height,radius:la,fill:i||_e}),t.translateWithPrecision(Ht,l.ba),t.font=n,t.fillStyle=s,t.fillText(d,0,0),t.restore()}}var ca=Object.getOwnPropertyDescriptor,ua=(e,t,a,n)=>{for(var o=n>1?void 0:n?ca(t,a):t,i=e.length-1,s;i>=0;i--)(s=e[i])&&(o=s(o)||o);return o},qe=(e,t)=>(a,n)=>t(a,n,e);const ha=new Path2D("M3.32201 4.84556C3.14417 5.05148 2.85583 5.05148 2.67799 4.84556L0.134292 1.90016C-0.152586 1.56798 0.0505937 1 0.456301 1L5.5437 1C5.94941 1 6.15259 1.56798 5.86571 1.90016L3.32201 4.84556Z");let mt=class{constructor(e,t,a,n){R(this,"zIndex");R(this,"_dropdownInfoMap",new Map);this._commandService=e,this._univerInstanceService=t,this._renderManagerService=a,this._dataValidationModel=n}_ensureMap(e){let t=this._dropdownInfoMap.get(e);return t||(t=new Map,this._dropdownInfoMap.set(e,t)),t}_generateKey(e,t){return`${e}.${t}`}_drawDownIcon(e,t,a,n,o){const i=a-De+4;let s=4;switch(o){case r.VerticalAlign.MIDDLE:s=(n-De)/2+4;break;case r.VerticalAlign.BOTTOM:s=n-De+4;break}e.save(),e.translateWithPrecision(t.startX+i,t.startY+s),e.fillStyle="#565656",e.fill(ha),e.restore()}drawWith(e,t,a,n){var Z,G;const{primaryWithCoord:o,row:i,col:s,style:l,data:d,subUnitId:h}=t,p=o.isMergedMainCell?o.mergeInfo:o,v=d==null?void 0:d.fontRenderExtension,{leftOffset:c=0,rightOffset:D=0,topOffset:g=0,downOffset:M=0}=v||{},w=this._ensureMap(h),m=this._generateKey(i,s),S=this._dataValidationModel.getRuleByLocation(t.unitId,t.subUnitId,i,s);if(!S)return;const _=this._dataValidationModel.getValidator(S.type);if(!_)return;const T={startX:p.startX+c,endX:p.endX-D,startY:p.startY+g,endY:p.endY-M},C=T.endX-T.startX,y=T.endY-T.startY,{cl:I}=l||{},O=(Z=typeof I=="object"?I==null?void 0:I.rgb:I)!=null?Z:"#000",N=k.getFontStyleString(l!=null?l:void 0),{vt:H,ht:A}=l||{},F=H!=null?H:r.VerticalAlign.MIDDLE,U=(G=E.getCellValueOrigin(d))!=null?G:"",j=_.parseCellValue(U),W=_.getListWithColorMap(S),Y=gt(j,N,C,y);this._drawDownIcon(e,T,C,y,F),e.save(),e.translateWithPrecision(T.startX,T.startY),e.beginPath(),e.rect(0,0,C-De,y),e.clip(),e.translateWithPrecision(vt,Ge);let q=0;switch(F){case r.VerticalAlign.MIDDLE:q=(Y.contentHeight-Y.totalHeight)/2;break;case r.VerticalAlign.BOTTOM:q=Y.contentHeight-Y.totalHeight;break}e.translateWithPrecision(0,q),Y.lines.forEach((ee,te)=>{e.save();const{width:ae,height:oe,items:le}=ee;let re=0;switch(A){case r.HorizontalAlign.RIGHT:re=Y.contentWidth-ae;break;case r.HorizontalAlign.CENTER:re=(Y.contentWidth-ae)/2;break}e.translate(re,te*(oe+Yt)),le.forEach(de=>{e.save(),e.translateWithPrecision(de.left,0),da.drawWith(e,{...N,info:de,color:O,fill:W[de.text]}),e.restore()}),e.restore()}),e.restore(),w.set(m,{left:T.startX,top:T.startY,width:Y.contentWidth+vt+De,height:Y.contentHeight+Ge*2})}calcCellAutoHeight(e){var C;const{primaryWithCoord:t,style:a,data:n,row:o,col:i}=e,s=n==null?void 0:n.fontRenderExtension,{leftOffset:l=0,rightOffset:d=0,topOffset:h=0,downOffset:p=0}=s||{},v=t.isMergedMainCell?t.mergeInfo:t,c={startX:v.startX+l,endX:v.endX-d,startY:v.startY+h,endY:v.endY-p},D=this._dataValidationModel.getRuleByLocation(e.unitId,e.subUnitId,o,i);if(!D)return;const g=this._dataValidationModel.getValidator(D.type);if(!g)return;const M=c.endX-c.startX,w=c.endY-c.startY,m=(C=E.getCellValueOrigin(n))!=null?C:"",S=g.parseCellValue(m),_=k.getFontStyleString(a!=null?a:void 0);return gt(S,_,M,w).cellAutoHeight}calcCellAutoWidth(e){var C;const{primaryWithCoord:t,style:a,data:n,row:o,col:i}=e,s=n==null?void 0:n.fontRenderExtension,{leftOffset:l=0,rightOffset:d=0,topOffset:h=0,downOffset:p=0}=s||{},v=t.isMergedMainCell?t.mergeInfo:t,c={startX:v.startX+l,endX:v.endX-d,startY:v.startY+h,endY:v.endY-p},D=this._dataValidationModel.getRuleByLocation(e.unitId,e.subUnitId,o,i);if(!D)return;const g=this._dataValidationModel.getValidator(D.type);if(!g)return;const M=c.endX-c.startX,w=c.endY-c.startY,m=(C=E.getCellValueOrigin(n))!=null?C:"",S=g.parseCellValue(m),_=k.getFontStyleString(a!=null?a:void 0);return gt(S,_,M,w).calcAutoWidth}isHit(e,t){const{primaryWithCoord:a}=t,n=a.isMergedMainCell?a.mergeInfo:a,{endX:o}=n,{x:i}=e;return i>=o-De&&i<=o}onPointerDown(e,t){if(t.button===2)return;const{unitId:a,subUnitId:n,row:o,col:i}=e,s={unitId:a,subUnitId:n,row:o,column:i};this._commandService.executeCommand(Ue.id,s)}onPointerEnter(e,t){var a,n;return(n=(a=k.getCurrentTypeOfRenderer(r.UniverInstanceType.UNIVER_SHEET,this._univerInstanceService,this._renderManagerService))==null?void 0:a.mainComponent)==null?void 0:n.setCursor(k.CURSOR_TYPE.POINTER)}onPointerLeave(e,t){var a,n;return(n=(a=k.getCurrentTypeOfRenderer(r.UniverInstanceType.UNIVER_SHEET,this._univerInstanceService,this._renderManagerService))==null?void 0:a.mainComponent)==null?void 0:n.setCursor(k.CURSOR_TYPE.DEFAULT)}};mt=ua([qe(0,r.ICommandService),qe(1,r.IUniverInstanceService),qe(2,r.Inject(k.IRenderManagerService)),qe(3,r.Inject(E.SheetDataValidationModel))],mt);class pa extends he{constructor(){super(...arguments);R(this,"id",r.DataValidationType.LIST_MULTIPLE);R(this,"canvasRender",this.injector.createInstance(mt));R(this,"dropdown",$e)}}var va=Object.getOwnPropertyDescriptor,ga=(e,t,a,n)=>{for(var o=n>1?void 0:n?va(t,a):t,i=e.length-1,s;i>=0;i--)(s=e[i])&&(o=s(o)||o);return o},ke=(e,t)=>(a,n)=>t(a,n,e);const ye=4,Ze=4,ce=14,pe=6,Pe=4,ft=8,ma="#565656",xt=new Path2D("M3.32201 4.84556C3.14417 5.05148 2.85583 5.05148 2.67799 4.84556L0.134292 1.90016C-0.152586 1.56798 0.0505937 1 0.456301 1L5.5437 1C5.94941 1 6.15259 1.56798 5.86571 1.90016L3.32201 4.84556Z");function fa(e,t){const a=e.length;return{id:"d",body:{dataStream:`${e}${r.DEFAULT_EMPTY_DOCUMENT_VALUE}`,textRuns:[{ts:{fs:11,ff:void 0,it:r.BooleanNumber.FALSE,bl:r.BooleanNumber.FALSE,ul:{s:r.BooleanNumber.FALSE},st:{s:r.BooleanNumber.FALSE},ol:{s:r.BooleanNumber.FALSE},cl:void 0,...t,bg:void 0,bd:void 0},st:0,ed:a}]},documentStyle:{pageSize:{width:Number.POSITIVE_INFINITY,height:Number.POSITIVE_INFINITY}}}}function Xt(e,t,a){const n=fa(e,a),o=new r.DocumentDataModel(n),i=new k.DocumentViewModel(o);return{documentSkeleton:k.DocumentSkeleton.create(i,t),docModel:o,docViewModel:i}}function Je(e,t,a){const{documentSkeleton:n,docModel:o,docViewModel:i}=Xt(e,t,a);return{documents:new k.Documents(`DOCUMENTS_${r.Tools.generateRandomId()}`,n,{pageMarginLeft:0,pageMarginTop:0}),documentSkeleton:n,docModel:o,docViewModel:i}}function zt(e,t,a,n,o,i,s=!0){let l=0;const d=s?Pe:0;switch(o){case r.VerticalAlign.BOTTOM:l=t-n-d;break;case r.VerticalAlign.MIDDLE:l=(t-n)/2;break;default:l=d;break}l=Math.max(Pe,l);let h=0;switch(i){case r.HorizontalAlign.CENTER:h=(e-a)/2;break;case r.HorizontalAlign.RIGHT:h=e-a;break}return h=Math.max(pe,h),{paddingLeft:h,paddingTop:l}}let St=class{constructor(e,t,a,n,o){R(this,"_dropdownInfoMap",new Map);R(this,"zIndex");this._univerInstanceService=e,this._localeService=t,this._commandService=a,this._renderManagerService=n,this._dataValidationModel=o}_ensureMap(e){let t=this._dropdownInfoMap.get(e);return t||(t=new Map,this._dropdownInfoMap.set(e,t)),t}_generateKey(e,t){return`${e}.${t}`}_drawDownIcon(e,t,a,n,o,i,s){const{t:l=r.DEFAULT_STYLES.pd.t,b:d=r.DEFAULT_STYLES.pd.b}=s,h=a-ce;let p;switch(i){case r.VerticalAlign.MIDDLE:p=(n-Ze)/2;break;case r.VerticalAlign.BOTTOM:p=n-d-o-Pe+(o/2-Ze/2);break;default:p=l+Pe+(o/2-Ze/2);break}e.save(),e.translateWithPrecision(t.startX+h,t.startY+p),e.fillStyle="#565656",e.fill(xt),e.restore()}drawWith(e,t,a){const{primaryWithCoord:n,row:o,col:i,style:s,data:l,subUnitId:d}=t,h=n.isMergedMainCell?n.mergeInfo:n,p=this._dataValidationModel.getRuleByLocation(t.unitId,t.subUnitId,o,i);if(!p)return;const v=this._dataValidationModel.getValidator(p.type);if(!v)return;const c=l==null?void 0:l.fontRenderExtension,{leftOffset:D=0,rightOffset:g=0,topOffset:M=0,downOffset:w=0}=c||{};if(!p||!v||!v||v.id.indexOf(r.DataValidationType.LIST)!==0||!v.skipDefaultFontRender(p))return;const m={startX:h.startX+D,endX:h.endX-g,startY:h.startY+M,endY:h.endY-w},S=m.endX-m.startX,_=m.endY-m.startY,T=this._ensureMap(d),C=this._generateKey(o,i),y=v.getListWithColor(p),I=E.getCellValueOrigin(l),O=`${I!=null?I:""}`,N=y.find(j=>j.label===O);let{tb:H,vt:A,ht:F,pd:U}=s||{};if(H=H!=null?H:r.WrapStrategy.WRAP,A=A!=null?A:r.VerticalAlign.BOTTOM,F=F!=null?F:r.DEFAULT_STYLES.ht,U=U!=null?U:r.DEFAULT_STYLES.pd,p.renderMode===r.DataValidationRenderMode.ARROW){const{l:j=r.DEFAULT_STYLES.pd.l,t:W=r.DEFAULT_STYLES.pd.t,r:Y=r.DEFAULT_STYLES.pd.r,b:q=r.DEFAULT_STYLES.pd.b}=U,Z=S-j-Y-ce-4,{documentSkeleton:G,documents:ee,docModel:te}=Je(O,this._localeService,s);H===r.WrapStrategy.WRAP&&te.updateDocumentDataPageSize(Math.max(Z,1)),G.calculate(),G.getActualSize();const ae=k.getDocsSkeletonPageSize(G),{height:oe,width:le}=ae,{paddingTop:re,paddingLeft:de}=zt(Z,_-W-q,le,oe,A,F,!0);this._drawDownIcon(e,m,S,_,oe,A,U),e.save(),e.translateWithPrecision(m.startX+j,m.startY+W),e.beginPath(),e.rect(0,0,S-j-Y,_-W-q),e.clip(),e.translateWithPrecision(0,re),e.save(),e.translateWithPrecision(ye,0),e.beginPath(),e.rect(0,0,Z,oe),e.clip(),ee.render(e),e.translateWithPrecision(de,0),e.restore(),e.restore(),T.set(C,{left:m.endX+j+a.rowHeaderWidth-ce,top:m.startY+W+a.columnHeaderHeight,width:ce,height:_-W-q})}else{e.save(),e.translateWithPrecision(m.startX,m.startY),e.beginPath(),e.rect(0,0,S,_),e.clip();const j=S-pe*2-ye-ce-4,{documentSkeleton:W,documents:Y,docModel:q}=Je(O,this._localeService,s);H===r.WrapStrategy.WRAP&&q.updateDocumentDataPageSize(Math.max(j,1)),W.calculate();const Z=k.getDocsSkeletonPageSize(W),{height:G,width:ee}=Z,{paddingTop:te,paddingLeft:ae}=zt(j,_,ee,G,A,F);e.translateWithPrecision(pe,te);const oe=Math.max(S-pe*2,1),le=G;k.Rect.drawWith(e,{width:oe,height:le,fill:(N==null?void 0:N.color)||_e,radius:ft}),e.save(),e.translateWithPrecision(ye,0),e.beginPath(),e.rect(0,0,j,G),e.clip(),e.translateWithPrecision(ae,0),Y.render(e),e.restore(),e.translateWithPrecision(j+ye+4,(G-Ze)/2),e.fillStyle=ma,e.fill(xt),e.restore(),T.set(C,{left:m.startX+pe+a.rowHeaderWidth,top:m.startY+te+a.columnHeaderHeight,width:oe,height:le})}}calcCellAutoHeight(e){const{primaryWithCoord:t,style:a,data:n,row:o,col:i}=e,s=t.isMergedMainCell?t.mergeInfo:t,l=n==null?void 0:n.fontRenderExtension,{leftOffset:d=0,rightOffset:h=0,topOffset:p=0,downOffset:v=0}=l||{},c=this._dataValidationModel.getRuleByLocation(e.unitId,e.subUnitId,o,i);if(!c||c.renderMode===r.DataValidationRenderMode.TEXT)return;const D={startX:s.startX+d,endX:s.endX-h,startY:s.startY+p,endY:s.endY-v},g=D.endX-D.startX,M=E.getCellValueOrigin(n),w=`${M!=null?M:""}`;let{tb:m,pd:S}=a||{};const{t:_=r.DEFAULT_STYLES.pd.t,b:T=r.DEFAULT_STYLES.pd.b}=S!=null?S:{};if(m=m!=null?m:r.WrapStrategy.WRAP,c.renderMode===r.DataValidationRenderMode.ARROW){const C=g-ce,{documentSkeleton:y,docModel:I}=Je(w,this._localeService,a);m===r.WrapStrategy.WRAP&&I.updateDocumentDataPageSize(Math.max(C,1)),y.calculate(),y.getActualSize();const O=k.getDocsSkeletonPageSize(y),{height:N}=O;return N+_+T+Pe*2}else{const C=g-pe*2-ye-ce,{documentSkeleton:y,docModel:I}=Xt(w,this._localeService,a);m===r.WrapStrategy.WRAP&&I.updateDocumentDataPageSize(Math.max(C,1)),y.calculate();const O=k.getDocsSkeletonPageSize(y),{height:N}=O;return N+Pe*2}}calcCellAutoWidth(e){const{primaryWithCoord:t,style:a,data:n,row:o,col:i}=e,s=t.isMergedMainCell?t.mergeInfo:t,l=n==null?void 0:n.fontRenderExtension,{leftOffset:d=0,rightOffset:h=0,topOffset:p=0,downOffset:v=0}=l||{},c=this._dataValidationModel.getRuleByLocation(e.unitId,e.subUnitId,o,i);if(!c||c.renderMode===r.DataValidationRenderMode.TEXT)return;const D={startX:s.startX+d,endX:s.endX-h,startY:s.startY+p,endY:s.endY-v},g=D.endX-D.startX,M=E.getCellValueOrigin(n),w=`${M!=null?M:""}`;let{tb:m,pd:S}=a||{};const{l:_=r.DEFAULT_STYLES.pd.l,r:T=r.DEFAULT_STYLES.pd.r}=S!=null?S:{};m=m!=null?m:r.WrapStrategy.WRAP;let C=pe*2+ce;switch(c.renderMode){case r.DataValidationRenderMode.ARROW:C=ce+pe*2+T+_;break;case r.DataValidationRenderMode.CUSTOM:C=ce+pe*2+ye*2+T+_+ft/2+1;break;default:C=ce+pe*2+ye*2+T+_+ft/2+1}const y=g-C,{documentSkeleton:I,docModel:O}=Je(w,this._localeService,a);return m===r.WrapStrategy.WRAP&&O.updateDocumentDataPageSize(Math.max(y,1)),I.calculate(),I.getActualSize(),k.getDocsSkeletonPageSize(I).width+C}isHit(e,t){const{subUnitId:a,row:n,col:o}=t,s=this._ensureMap(a).get(this._generateKey(n,o)),l=this._dataValidationModel.getRuleByLocation(t.unitId,t.subUnitId,n,o);if(!l||!s||l.renderMode===r.DataValidationRenderMode.TEXT)return!1;const{top:d,left:h,width:p,height:v}=s,{x:c,y:D}=e;return c>=h&&c<=h+p&&D>=d&&D<=d+v}onPointerDown(e,t){if(t.button===2)return;const{unitId:a,subUnitId:n,row:o,col:i}=e,s={unitId:a,subUnitId:n,row:o,column:i};this._commandService.executeCommand(Ue.id,s)}onPointerEnter(e,t){var a,n;(n=(a=k.getCurrentTypeOfRenderer(r.UniverInstanceType.UNIVER_SHEET,this._univerInstanceService,this._renderManagerService))==null?void 0:a.mainComponent)==null||n.setCursor(k.CURSOR_TYPE.POINTER)}onPointerLeave(e,t){var a,n;(n=(a=k.getCurrentTypeOfRenderer(r.UniverInstanceType.UNIVER_SHEET,this._univerInstanceService,this._renderManagerService))==null?void 0:a.mainComponent)==null||n.setCursor(k.CURSOR_TYPE.DEFAULT)}};St=ga([ke(0,r.IUniverInstanceService),ke(1,r.Inject(r.LocaleService)),ke(2,r.ICommandService),ke(3,r.Inject(k.IRenderManagerService)),ke(4,r.Inject(E.SheetDataValidationModel))],St);class Sa extends he{constructor(){super(...arguments);R(this,"id",r.DataValidationType.LIST);R(this,"canvasRender",this.injector.createInstance(St));R(this,"dropdown",$e);R(this,"optionsInput",Xe.componentKey);R(this,"formulaInput",ut)}}class Ia extends he{constructor(){super(...arguments);R(this,"id",r.DataValidationType.TEXT_LENGTH);R(this,"formulaInput",xe)}}class _a extends he{constructor(){super(...arguments);R(this,"id",r.DataValidationType.WHOLE);R(this,"formulaInput",xe)}}var Ca=Object.getOwnPropertyDescriptor,Da=(e,t,a,n)=>{for(var o=n>1?void 0:n?Ca(t,a):t,i=e.length-1,s;i>=0;i--)(s=e[i])&&(o=s(o)||o);return o},It=(e,t)=>(a,n)=>t(a,n,e);let Re=class extends r.RxDisposable{constructor(e,t,a){super(),this._injector=e,this._componentManger=t,this._dataValidatorRegistryService=a,this._initComponents(),this._registerValidatorViews()}_initComponents(){[[At,Vt],[Ne,Vn],[Ot,vn],[$e,Sn],[st,Qt],[Xe.componentKey,Xe],[ze.componentKey,ze],...zn].forEach(([e,t])=>{this.disposeWithMe(this._componentManger.register(e,t))})}_registerValidatorViews(){[ia,_a,Ia,oa,ta,Sa,pa,na].forEach(e=>{const t=this._injector.createInstance(e),a=this._dataValidatorRegistryService.getValidatorItem(t.id);a&&(a.formulaInput=t.formulaInput,a.canvasRender=t.canvasRender,a.dropdown=t.dropdown,a.optionsInput=t.optionsInput)})}};Re=Da([It(0,r.Inject(r.Injector)),It(1,r.Inject(f.ComponentManager)),It(2,r.Inject(J.DataValidatorRegistryService))],Re);var ya=Object.getOwnPropertyDescriptor,wa=(e,t,a,n)=>{for(var o=n>1?void 0:n?ya(t,a):t,i=e.length-1,s;i>=0;i--)(s=e[i])&&(o=s(o)||o);return o},_t=(e,t)=>(a,n)=>t(a,n,e);const Va="SHEET_DATA_VALIDATION_UI_PLUGIN";x.UniverSheetsDataValidationUIPlugin=(Qe=class extends r.Plugin{constructor(t=Be,a,n,o){super(),this._config=t,this._injector=a,this._commandService=n,this._configService=o;const{menu:i,...s}=r.merge({},Be,this._config);i&&this._configService.setConfig("menu",i,{merge:!0}),this._configService.setConfig(it,s)}onStarting(){[[ue],[me],[Fe],[Me],[Te],[Le],[be],[Ae],[Re]].forEach(t=>{this._injector.add(t)}),[He,Ue,Rt,ot,Ie,Pt].forEach(t=>{this._commandService.registerCommand(t)})}onReady(){this._injector.get(be),this._injector.get(Le),this._injector.get(Ae),this._injector.get(Fe),this._injector.get(k.IRenderManagerService).registerRenderModule(r.UniverInstanceType.UNIVER_SHEET,[Ye])}onRendered(){this._injector.get(Re),this._injector.get(Te)}onSteady(){this._injector.get(Me)}},R(Qe,"pluginName",Va),R(Qe,"type",r.UniverInstanceType.UNIVER_SHEET),Qe),x.UniverSheetsDataValidationUIPlugin=wa([_t(1,r.Inject(r.Injector)),_t(2,r.ICommandService),_t(3,r.IConfigService)],x.UniverSheetsDataValidationUIPlugin);var Ea=Object.getOwnPropertyDescriptor,Ma=(e,t,a,n)=>{for(var o=n>1?void 0:n?Ea(t,a):t,i=e.length-1,s;i>=0;i--)(s=e[i])&&(o=s(o)||o);return o},Ct=(e,t)=>(a,n)=>t(a,n,e);const ba="SHEET_DATA_VALIDATION_UI_PLUGIN";x.UniverSheetsDataValidationMobileUIPlugin=(et=class extends r.Plugin{constructor(t=Be,a,n,o){super(),this._config=t,this._injector=a,this._commandService=n,this._configService=o;const{menu:i,...s}=r.merge({},Be,this._config);i&&this._configService.setConfig("menu",i,{merge:!0}),this._configService.setConfig(it,s)}onStarting(){[[ue],[me],[Fe],[Me],[Te],[Le],[be],[Re]].forEach(t=>{this._injector.add(t)}),[He,Ue,Rt,ot,Ie,Pt].forEach(t=>{this._commandService.registerCommand(t)})}onReady(){this._injector.get(be),this._injector.get(Le),this._injector.get(k.IRenderManagerService).registerRenderModule(r.UniverInstanceType.UNIVER_SHEET,[Ye])}onRendered(){this._injector.get(Re),this._injector.get(Te)}onSteady(){this._injector.get(Me)}},R(et,"pluginName",ba),R(et,"type",r.UniverInstanceType.UNIVER_SHEET),et),x.UniverSheetsDataValidationMobileUIPlugin=Ma([Ct(1,r.Inject(r.Injector)),Ct(2,r.ICommandService),Ct(3,r.IConfigService)],x.UniverSheetsDataValidationMobileUIPlugin),x.DATE_DROPDOWN_KEY=st,x.LIST_DROPDOWN_KEY=$e,Object.defineProperty(x,Symbol.toStringTag,{value:"Module"})});


// index
(function(e,i){typeof exports=="object"&&typeof module<"u"?i(exports,require("@univerjs/data-validation"),require("@univerjs/sheets-data-validation"),require("@univerjs/sheets-data-validation-ui"),require("@univerjs/sheets-data-validation/facade")):typeof define=="function"&&define.amd?define(["exports","@univerjs/data-validation","@univerjs/sheets-data-validation","@univerjs/sheets-data-validation-ui","@univerjs/sheets-data-validation/facade"],i):(e=typeof globalThis<"u"?globalThis:e||self,i(e.UniverPresetSheetsDataValidation={},e.UniverDataValidation,e.UniverSheetsDataValidation,e.UniverSheetsDataValidationUi))})(this,function(e,i,a,t){"use strict";function n(){return{plugins:[i.UniverDataValidationPlugin,a.UniverSheetsDataValidationPlugin,t.UniverSheetsDataValidationUIPlugin].filter(s=>!!s)}}e.UniverSheetsDataValidationPreset=n,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})});
