(function(a,t){typeof exports=="object"&&typeof module<"u"?t(exports,require("@univerjs/core"),require("@univerjs/engine-render"),require("rxjs")):typeof define=="function"&&define.amd?define(["exports","@univerjs/core","@univerjs/engine-render","rxjs"],t):(a=typeof globalThis<"u"?globalThis:a||self,t(a.UniverWatermark={},a.UniverCore,a.UniverEngineRender,a.rxjs))})(this,(function(a,t,n,S){"use strict";var M=Object.defineProperty;var j=(a,t,n)=>t in a?M(a,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):a[t]=n;var m=(a,t,n)=>j(a,typeof t!="symbol"?t+"":t,n);var u;const W=["image/png","image/jpeg","image/jpg","image/bmp"],h={content:"",fontSize:16,color:"rgb(0,0,0)",bold:!1,italic:!1,direction:"ltr",x:60,y:36,repeat:!0,spacingX:200,spacingY:100,rotate:0,opacity:.15},v={url:"",width:100,height:100,maintainAspectRatio:!0,originRatio:1,x:60,y:36,repeat:!0,spacingX:200,spacingY:100,rotate:0,opacity:.15},p={name:!0,email:!1,phone:!1,uid:!1,fontSize:16,color:"rgb(0,0,0)",bold:!1,italic:!1,direction:"ltr",x:60,y:60,repeat:!0,spacingX:200,spacingY:100,rotate:-30,opacity:.15},E="watermark.config",I={};var d=Object.getOwnPropertyDescriptor,k=(o,e,r,i)=>{for(var s=i>1?void 0:i?d(e,r):e,c=o.length-1,_;c>=0;c--)(_=o[c])&&(s=_(s)||s);return s},A=(o,e)=>(r,i)=>e(r,i,o);a.WatermarkService=class extends t.Disposable{constructor(r){super();m(this,"_updateConfig$",new S.Subject);m(this,"updateConfig$",this._updateConfig$.asObservable());m(this,"_refresh$",new S.Subject);m(this,"refresh$",this._refresh$.asObservable());this._localStorageService=r}async getWatermarkConfig(){return await this._localStorageService.getItem(n.UNIVER_WATERMARK_STORAGE_KEY)}updateWatermarkConfig(r){this._localStorageService.setItem(n.UNIVER_WATERMARK_STORAGE_KEY,r),this._updateConfig$.next(r)}deleteWatermarkConfig(){this._localStorageService.removeItem(n.UNIVER_WATERMARK_STORAGE_KEY),this._updateConfig$.next(null)}refresh(){this._refresh$.next(Math.random())}dispose(){this._refresh$.complete(),this._updateConfig$.complete()}},a.WatermarkService=k([A(0,t.Inject(t.ILocalStorageService))],a.WatermarkService);var R=Object.getOwnPropertyDescriptor,y=(o,e,r,i)=>{for(var s=i>1?void 0:i?R(e,r):e,c=o.length-1,_;c>=0;c--)(_=o[c])&&(s=_(s)||s);return s},f=(o,e)=>(r,i)=>e(r,i,o);let l=class extends t.RxDisposable{constructor(e,r,i,s){super();m(this,"_watermarkLayer");this._context=e,this._watermarkService=r,this._localStorageService=i,this._userManagerService=s,this._watermarkLayer=new n.WatermarkLayer(e.scene,[],n.UNIVER_WATERMARK_LAYER_INDEX),this._initAddRender(),this._initWatermarkUpdate(),this._initWatermarkConfig()}_initAddRender(){const{scene:e}=this._context;e.addLayer(this._watermarkLayer)}async _initWatermarkConfig(){var r;const e=await this._localStorageService.getItem(n.UNIVER_WATERMARK_STORAGE_KEY);e&&(this._watermarkService.updateWatermarkConfig(e),(r=this._context.mainComponent)==null||r.makeDirty())}_initWatermarkUpdate(){this.disposeWithMe(this._watermarkService.updateConfig$.subscribe(e=>{var r,i;if(!e){this._watermarkLayer.updateConfig(),(r=this._context.mainComponent)==null||r.makeDirty();return}e.type===n.IWatermarkTypeEnum.UserInfo?this._watermarkLayer.updateConfig(e,this._userManagerService.getCurrentUser()):this._watermarkLayer.updateConfig(e),(i=this._context.mainComponent)==null||i.makeDirty()}))}};l=y([f(1,t.Inject(a.WatermarkService)),f(2,t.Inject(t.ILocalStorageService)),f(3,t.Inject(t.UserManagerService))],l);var T=Object.getOwnPropertyDescriptor,C=(o,e,r,i)=>{for(var s=i>1?void 0:i?T(e,r):e,c=o.length-1,_;c>=0;c--)(_=o[c])&&(s=_(s)||s);return s},g=(o,e)=>(r,i)=>e(r,i,o);const U="UNIVER_WATERMARK_PLUGIN";a.UniverWatermarkPlugin=(u=class extends t.Plugin{constructor(e=I,r,i,s,c){super(),this._config=e,this._injector=r,this._configService=i,this._renderManagerSrv=s,this._localStorageService=c;const{..._}=t.merge({},I,this._config);this._configService.setConfig(E,_),this._initWatermarkStorage(),this._initDependencies()}async _initWatermarkStorage(){const e=this._configService.getConfig(E);if(!e)return;const{userWatermarkSettings:r,textWatermarkSettings:i,imageWatermarkSettings:s}=e;if(r)this._localStorageService.setItem(n.UNIVER_WATERMARK_STORAGE_KEY,{type:n.IWatermarkTypeEnum.UserInfo,config:{userInfo:t.merge({},p,r)}});else if(i)this._localStorageService.setItem(n.UNIVER_WATERMARK_STORAGE_KEY,{type:n.IWatermarkTypeEnum.Text,config:{text:t.merge({},h,i)}});else if(s)this._localStorageService.setItem(n.UNIVER_WATERMARK_STORAGE_KEY,{type:n.IWatermarkTypeEnum.Image,config:{image:t.merge({},v,s)}});else{const c=await this._localStorageService.getItem(n.UNIVER_WATERMARK_STORAGE_KEY);(c==null?void 0:c.type)===n.IWatermarkTypeEnum.UserInfo&&this._localStorageService.removeItem(n.UNIVER_WATERMARK_STORAGE_KEY)}}_initDependencies(){[[a.WatermarkService]].forEach(e=>{this._injector.add(e)})}onRendered(){this._injector.get(a.WatermarkService),this._initRenderDependencies()}_initRenderDependencies(){[[l]].forEach(e=>{this._renderManagerSrv.registerRenderModule(t.UniverInstanceType.UNIVER_SHEET,e),this._renderManagerSrv.registerRenderModule(t.UniverInstanceType.UNIVER_DOC,e)})}},m(u,"pluginName",U),u),a.UniverWatermarkPlugin=C([g(1,t.Inject(t.Injector)),g(2,t.IConfigService),g(3,n.IRenderManagerService),g(4,t.Inject(t.ILocalStorageService))],a.UniverWatermarkPlugin),a.WATERMARK_IMAGE_ALLOW_IMAGE_LIST=W,a.WatermarkImageBaseConfig=v,a.WatermarkTextBaseConfig=h,a.WatermarkUserInfoBaseConfig=p,Object.defineProperty(a,Symbol.toStringTag,{value:"Module"})}));
