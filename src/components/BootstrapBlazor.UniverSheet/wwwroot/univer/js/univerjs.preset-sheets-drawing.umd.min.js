// @univerjs/docs-drawing/index
(function(t,i){typeof exports=="object"&&typeof module<"u"?i(exports,require("@univerjs/core"),require("@univerjs/drawing")):typeof define=="function"&&define.amd?define(["exports","@univerjs/core","@univerjs/drawing"],i):(t=typeof globalThis<"u"?globalThis:t||self,i(t.UniverDocsDrawing={},t.UniverCore,t.UniverDrawing))})(this,function(t,i,g){"use strict";var j=Object.defineProperty;var y=(t,i,g)=>i in t?j(t,i,{enumerable:!0,configurable:!0,writable:!0,value:g}):t[i]=g;var f=(t,i,g)=>y(t,typeof i!="symbol"?i+"":i,g);var d;const S="docs-drawing.config",w={};class v extends g.UnitDrawingService{}const _=i.createIdentifier("univer.doc.plugin.doc-drawing.service");var U=Object.defineProperty,p=Object.getOwnPropertyDescriptor,I=(c,r,a,e)=>{for(var n=e>1?void 0:e?p(r,a):r,s=c.length-1,o;s>=0;s--)(o=c[s])&&(n=(e?o(r,a,n):o(n))||n);return e&&n&&U(r,a,n),n},D=(c,r)=>(a,e)=>r(a,e,c);const l="DOC_DRAWING_PLUGIN";t.DocDrawingController=class extends i.Disposable{constructor(r,a,e,n){super(),this._docDrawingService=r,this._drawingManagerService=a,this._resourceManagerService=e,this._univerInstanceService=n,this._init()}_init(){this._initSnapshot()}_initSnapshot(){const r=e=>{const n=this._univerInstanceService.getUnit(e,i.UniverInstanceType.UNIVER_DOC);if(n){const s=n.getSnapshot().drawings,o=n.getSnapshot().drawingsOrder,u={data:s!=null?s:{},order:o!=null?o:[]};return JSON.stringify(u)}return""},a=e=>{if(!e)return{data:{},order:[]};try{return JSON.parse(e)}catch{return{data:{},order:[]}}};this.disposeWithMe(this._resourceManagerService.registerPluginResource({pluginName:l,businesses:[i.UniverInstanceType.UNIVER_DOC],toJson:e=>r(e),parseJson:e=>a(e),onUnLoad:e=>{this._setDrawingDataForUnit(e,{data:{},order:[]})},onLoad:(e,n)=>{var s,o;this._setDrawingDataForUnit(e,{data:(s=n.data)!=null?s:{},order:(o=n.order)!=null?o:[]})}}))}_setDrawingDataForUnit(r,a){const e=this._univerInstanceService.getUnit(r);e!=null&&(e.resetDrawing(a.data,a.order),this.loadDrawingDataForUnit(r))}loadDrawingDataForUnit(r){const a=this._univerInstanceService.getUnit(r,i.UniverInstanceType.UNIVER_DOC);if(!a)return!1;const e=r,n=a.getDrawings(),s=a.getDrawingsOrder();if(!n||!s)return!1;Object.keys(n).forEach(u=>{const N=n[u];n[u]={...N}});const o={[e]:{unitId:r,subUnitId:e,data:n,order:s}};return this._docDrawingService.registerDrawingData(r,o),this._drawingManagerService.registerDrawingData(r,o),!0}},t.DocDrawingController=I([D(0,_),D(1,g.IDrawingManagerService),D(2,i.IResourceManagerService),D(3,i.IUniverInstanceService)],t.DocDrawingController);var O=Object.defineProperty,C=Object.getOwnPropertyDescriptor,P=(c,r,a,e)=>{for(var n=e>1?void 0:e?C(r,a):r,s=c.length-1,o;s>=0;s--)(o=c[s])&&(n=(e?o(r,a,n):o(n))||n);return e&&n&&O(r,a,n),n},h=(c,r)=>(a,e)=>r(a,e,c);t.UniverDocsDrawingPlugin=(d=class extends i.Plugin{constructor(r=w,a,e){super(),this._config=r,this._injector=a,this._configService=e;const{...n}=i.merge({},w,this._config);this._configService.setConfig(S,n)}onStarting(){[[t.DocDrawingController],[v],[_,{useClass:v}]].forEach(r=>this._injector.add(r)),i.touchDependencies(this._injector,[[t.DocDrawingController]])}},f(d,"pluginName",l),f(d,"type",i.UniverInstanceType.UNIVER_DOC),d),t.UniverDocsDrawingPlugin=P([h(1,i.Inject(i.Injector)),h(2,i.IConfigService)],t.UniverDocsDrawingPlugin),t.DOCS_DRAWING_PLUGIN=l,t.DocDrawingService=v,t.IDocDrawingService=_,Object.defineProperty(t,Symbol.toStringTag,{value:"Module"})});


// @univerjs/drawing-ui/index
(function(y,d){typeof exports=="object"&&typeof module<"u"?d(exports,require("@univerjs/core"),require("@univerjs/drawing"),require("@univerjs/engine-render"),require("@univerjs/ui"),require("react"),require("@univerjs/design"),require("rxjs")):typeof define=="function"&&define.amd?define(["exports","@univerjs/core","@univerjs/drawing","@univerjs/engine-render","@univerjs/ui","react","@univerjs/design","rxjs"],d):(y=typeof globalThis<"u"?globalThis:y||self,d(y.UniverDrawingUi={},y.UniverCore,y.UniverDrawing,y.UniverEngineRender,y.UniverUi,y.React,y.UniverDesign,y.rxjs))})(this,function(y,d,j,b,Ce,S,k,xe){"use strict";var Qn=Object.defineProperty;var $n=(y,d,j)=>d in y?Qn(y,d,{enumerable:!0,configurable:!0,writable:!0,value:j}):y[d]=j;var q=(y,d,j)=>$n(y,typeof d!="symbol"?d+"":d,j);var Me;function en(a,t,n,e){const r=e.getDrawingByParam(a);if(r==null)return;const s=j.getDrawingShapeKeyByDrawingSearch(a),i=n.getObject(s);if(i&&!(i instanceof b.Group))return;if(i!=null){i.addObject(t);return}const o=new b.Group(s);n.addObject(o,b.DRAWING_OBJECT_LAYER_INDEX).attachTransformerTo(o),o.addObject(t);const{transform:c}=r;c&&o.transformByState({left:c.left,top:c.top,angle:c.angle})}function Ne(a,t){var s;const n=t?a.getUnit(t):a.getFocusedUnit();if(n==null)return;const e=n.getUnitId();let r;return n.type===d.UniverInstanceType.UNIVER_SHEET?r=(s=n.getActiveSheet())==null?void 0:s.getSheetId():(n.type===d.UniverInstanceType.UNIVER_DOC||n.type===d.UniverInstanceType.UNIVER_SLIDE)&&(r=e),{unitId:e,subUnitId:r,current:n}}const Ee="COMPONENT_IMAGE_VIEWER";var nn=Object.defineProperty,tn=Object.getOwnPropertyDescriptor,rn=(a,t,n,e)=>{for(var r=e>1?void 0:e?tn(t,n):t,s=a.length-1,i;s>=0;s--)(i=a[s])&&(r=(e?i(t,n,r):i(r))||r);return e&&r&&nn(t,n,r),r},je=(a,t)=>(n,e)=>t(n,e,a);const Te=50;y.DrawingRenderService=class{constructor(t,n,e){this._drawingManagerService=t,this._imageIoService=n,this._dialogService=e}async renderImages(t,n){const{transform:e,drawingType:r,source:s,imageSourceType:i,srcRect:o,prstGeom:c,groupId:u,unitId:m,subUnitId:h,drawingId:f,isMultiTransform:p,transforms:_}=t;if(r!==d.DrawingTypeEnum.DRAWING_IMAGE||!this._drawingManagerService.getDrawingVisible()||e==null)return;const v=p&&_?_:[e],C=[];for(const P of v){const{left:I,top:E,width:R,height:U,angle:M,flipX:D,flipY:O,skewX:T,skewY:A}=P,V=v.indexOf(P),L=j.getDrawingShapeKeyByDrawingSearch({unitId:m,subUnitId:h,drawingId:f},p?V:void 0),re=n.getObject(L);if(re!=null){re.transformByState({left:I,top:E,width:R,height:U,angle:M,flipX:D,flipY:O,skewX:T,skewY:A});continue}const K=this._drawingManagerService.getDrawingOrder(m,h),ce=K.indexOf(f),ae={...P,zIndex:ce===-1?K.length-1:ce},ie=this._imageIoService.getImageSourceCache(s,i);let le=!1;if(ie!=null)ae.image=ie;else{if(i===j.ImageSourceType.UUID)try{ae.url=await this._imageIoService.getImage(s)}catch(Oe){console.error(Oe);continue}else ae.url=s;le=!0}if(n.getObject(L))continue;ae.printable=!0;const Q=new b.Image(L,ae);le&&this._imageIoService.addImageSourceCache(s,i,Q.getNative()),this._drawingManagerService.getDrawingVisible()&&(n.addObject(Q,b.DRAWING_OBJECT_LAYER_INDEX),this._drawingManagerService.getDrawingEditable()&&n.attachTransformerTo(Q),u&&en({drawingId:u,unitId:m,subUnitId:h},Q,n,this._drawingManagerService),c!=null&&Q.setPrstGeom(c),o!=null&&Q.setSrcRect(o),C.push(Q))}return C}renderDrawing(t,n){const e=this._drawingManagerService.getDrawingByParam(t);if(e!=null)switch(e.drawingType){case d.DrawingTypeEnum.DRAWING_IMAGE:return this.renderImages(e,n)}}previewImage(t,n,e,r){const s=`${t}-viewer-dialog`,i=window.innerWidth-Te,o=window.innerHeight-Te,c=this._adjustImageSize(e,r,i,o),u=this._dialogService.open({width:Math.max(c.width,200),id:s,style:{margin:"0",top:"50%",left:"50%",transform:"translate(-50%, -50%)"},children:{label:{name:Ee,props:{src:n,width:c.width,height:c.height}}},destroyOnClose:!0,draggable:!1,onClose:()=>{this._dialogService.close(s),u.dispose()}})}_adjustImageSize(t,n,e,r){if(t<=e&&n<=r)return{width:t,height:n};const s=e/t,i=r/n,o=Math.min(s,i);return{width:Math.floor(t*o),height:Math.floor(n*o)}}},y.DrawingRenderService=rn([je(0,j.IDrawingManagerService),je(1,j.IImageIoService),je(2,Ce.IDialogService)],y.DrawingRenderService);function me(a,t){const n=[];return a.forEach(e=>{const{oKey:r,left:s,top:i,height:o,width:c,angle:u}=e,m=t.getDrawingOKey(r);if(m==null)return n.push(null),!0;const{unitId:h,subUnitId:f,drawingId:p,drawingType:_}=m,v={unitId:h,subUnitId:f,drawingId:p,drawingType:_,transform:{left:s,top:i,height:o,width:c,angle:u}};_===d.DrawingTypeEnum.DRAWING_IMAGE&&(v.srcRect=e.srcRect),n.push(v)}),n}var Re={exports:{}},ue={};/**
 * @license React
 * react-jsx-runtime.production.min.js
 *
 * Copyright (c) Facebook, Inc. and its affiliates.
 *
 * This source code is licensed under the MIT license found in the
 * LICENSE file in the root directory of this source tree.
 */var Be;function an(){if(Be)return ue;Be=1;var a=S,t=Symbol.for("react.element"),n=Symbol.for("react.fragment"),e=Object.prototype.hasOwnProperty,r=a.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED.ReactCurrentOwner,s={key:!0,ref:!0,__self:!0,__source:!0};function i(o,c,u){var m,h={},f=null,p=null;u!==void 0&&(f=""+u),c.key!==void 0&&(f=""+c.key),c.ref!==void 0&&(p=c.ref);for(m in c)e.call(c,m)&&!s.hasOwnProperty(m)&&(h[m]=c[m]);if(o&&o.defaultProps)for(m in c=o.defaultProps,c)h[m]===void 0&&(h[m]=c[m]);return{$$typeof:t,type:o,key:f,ref:p,props:h,_owner:r.current}}return ue.Fragment=n,ue.jsx=i,ue.jsxs=i,ue}var Ue;function sn(){return Ue||(Ue=1,Re.exports=an()),Re.exports}var l=sn();function Ae(a){var t,n,e="";if(typeof a=="string"||typeof a=="number")e+=a;else if(typeof a=="object")if(Array.isArray(a)){var r=a.length;for(t=0;t<r;t++)a[t]&&(n=Ae(a[t]))&&(e&&(e+=" "),e+=n)}else for(n in a)a[n]&&(e&&(e+=" "),e+=n);return e}function N(){for(var a,t,n=0,e="",r=arguments.length;n<r;n++)(a=arguments[n])&&(t=Ae(a))&&(e&&(e+=" "),e+=t);return e}var x=(a=>(a.default="0",a.left="1",a.center="2",a.right="3",a.top="4",a.middle="5",a.bottom="6",a.horizon="7",a.vertical="8",a))(x||{});const we={id:"sheet.operation.set-image-align",type:d.CommandType.OPERATION,handler:(a,t)=>!0},g={imageCommonPanel:"univer-image-common-panel",imageCommonPanelGrid:"univer-image-common-panel-grid",imageCommonPanelBorder:"univer-image-common-panel-border",imageCommonPanelTitle:"univer-image-common-panel-title",imageCommonPanelSubtitle:"univer-image-common-panel-subtitle",imageCommonPanelRow:"univer-image-common-panel-row",imageCommonPanelRowVertical:"univer-image-common-panel-row-vertical",imageCommonPanelColumn:"univer-image-common-panel-column",imageCommonPanelColumnCenter:"univer-image-common-panel-column-center",imageCommonPanelInline:"univer-image-common-panel-inline",imageCommonPanelSpan2:"univer-image-common-panel-span2",imageCommonPanelSpan3:"univer-image-common-panel-span3",imageCommonPanelInput:"univer-image-common-panel-input"},on=a=>{const t=d.useDependency(d.ICommandService),n=d.useDependency(d.LocaleService),{alignShow:e}=a,[r,s]=S.useState(x.default),i=[{label:n.t("image-panel.align.default"),value:x.default},{options:[{label:n.t("image-panel.align.left"),value:x.left},{label:n.t("image-panel.align.center"),value:x.center},{label:n.t("image-panel.align.right"),value:x.right}]},{options:[{label:n.t("image-panel.align.top"),value:x.top},{label:n.t("image-panel.align.middle"),value:x.middle},{label:n.t("image-panel.align.bottom"),value:x.bottom}]},{options:[{label:n.t("image-panel.align.horizon"),value:x.horizon},{label:n.t("image-panel.align.vertical"),value:x.vertical}]}];function o(u){s(u),t.executeCommand(we.id,{alignType:u})}const c=u=>u?"block":"none";return l.jsxs("div",{className:N(g.imageCommonPanelGrid,g.imageCommonPanelBorder),style:{display:c(e)},children:[l.jsx("div",{className:g.imageCommonPanelRow,children:l.jsx("div",{className:N(g.imageCommonPanelColumn,g.imageCommonPanelTitle),children:l.jsx("div",{children:n.t("image-panel.align.title")})})}),l.jsx("div",{className:g.imageCommonPanelRow,children:l.jsx("div",{className:N(g.imageCommonPanelColumn),children:l.jsx(k.Select,{value:r,options:i,onChange:o})})})]})};var F=function(){return F=Object.assign||function(a){for(var t,n=1,e=arguments.length;n<e;n++){t=arguments[n];for(var r in t)Object.prototype.hasOwnProperty.call(t,r)&&(a[r]=t[r])}return a},F.apply(this,arguments)},cn=function(a,t){var n={};for(var e in a)Object.prototype.hasOwnProperty.call(a,e)&&t.indexOf(e)<0&&(n[e]=a[e]);if(a!=null&&typeof Object.getOwnPropertySymbols=="function")for(var r=0,e=Object.getOwnPropertySymbols(a);r<e.length;r++)t.indexOf(e[r])<0&&Object.prototype.propertyIsEnumerable.call(a,e[r])&&(n[e[r]]=a[e[r]]);return n},X=S.forwardRef(function(a,t){var n=a.icon,e=a.id,r=a.className,s=a.extend,i=cn(a,["icon","id","className","extend"]),o="univerjs-icon univerjs-icon-".concat(e," ").concat(r||"").trim(),c=S.useRef("_".concat(un()));return Le(n,"".concat(e),{defIds:n.defIds,idSuffix:c.current},F({ref:t,className:o},i),s)});function Le(a,t,n,e,r){return S.createElement(a.tag,F(F({key:t},ln(a,n,r)),e),(mn(a,n).children||[]).map(function(s,i){return Le(s,"".concat(t,"-").concat(a.tag,"-").concat(i),n,void 0,r)}))}function ln(a,t,n){var e=F({},a.attrs);n!=null&&n.colorChannel1&&e.fill==="colorChannel1"&&(e.fill=n.colorChannel1);var r=t.defIds;return!r||r.length===0||(a.tag==="use"&&e["xlink:href"]&&(e["xlink:href"]=e["xlink:href"]+t.idSuffix),Object.entries(e).forEach(function(s){var i=s[0],o=s[1];typeof o=="string"&&(e[i]=o.replace(/url\(#(.*)\)/,"url(#$1".concat(t.idSuffix,")")))})),e}function mn(a,t){var n,e=t.defIds;return!e||e.length===0?a:a.tag==="defs"&&(!((n=a.children)===null||n===void 0)&&n.length)?F(F({},a),{children:a.children.map(function(r){return typeof r.attrs.id=="string"&&e&&e.indexOf(r.attrs.id)>-1?F(F({},r),{attrs:F(F({},r.attrs),{id:r.attrs.id+t.idSuffix})}):r})}):a}function un(){return Math.random().toString(36).substring(2,8)}X.displayName="UniverIcon";var gn={tag:"svg",attrs:{fill:"none",viewBox:"0 0 16 16",width:"1em",height:"1em"},children:[{tag:"path",attrs:{fill:"colorChannel1",d:"M11.0363 12.2367V14.0367C11.0363 14.3681 11.3049 14.6367 11.6363 14.6367C11.9676 14.6367 12.2363 14.3681 12.2363 14.0367V12.2367H14.0364C14.3677 12.2367 14.6364 11.9681 14.6364 11.6367C14.6364 11.3054 14.3677 11.0367 14.0364 11.0367H12.2363V9.23672C12.2363 8.90535 11.9676 8.63672 11.6363 8.63672C11.3049 8.63672 11.0363 8.90535 11.0363 9.23672V11.0367H9.23635C8.90498 11.0367 8.63635 11.3054 8.63635 11.6367C8.63635 11.9681 8.90498 12.2367 9.23635 12.2367H11.0363Z"}},{tag:"path",attrs:{fill:"currentColor",d:"M2.56365 1.36377C1.90091 1.36377 1.36365 1.90103 1.36365 2.56377V6.16377C1.36365 6.82651 1.90091 7.36377 2.56365 7.36377H6.16365C6.82639 7.36377 7.36365 6.82651 7.36365 6.16377V2.56377C7.36365 1.90103 6.82639 1.36377 6.16365 1.36377H2.56365zM6.16365 2.56377H2.56365L2.56365 6.16377H6.16365V2.56377zM2.56365 8.63647C1.90091 8.63647 1.36365 9.17373 1.36365 9.83647V13.4365C1.36365 14.0992 1.90091 14.6365 2.56365 14.6365H6.16365C6.82639 14.6365 7.36365 14.0992 7.36365 13.4365V9.83647C7.36365 9.17373 6.82639 8.63647 6.16365 8.63647H2.56365zM6.16365 9.83647H2.56365L2.56365 13.4365H6.16365V9.83647zM9.83635 7.36377C9.17361 7.36377 8.63635 6.82651 8.63635 6.16377V2.56377C8.63635 1.90103 9.17361 1.36377 9.83635 1.36377H13.4364C14.0991 1.36377 14.6364 1.90103 14.6364 2.56377V6.16377C14.6364 6.82651 14.0991 7.36377 13.4364 7.36377H9.83635zM9.83635 6.16377V2.56377L13.4364 2.56377V6.16377H9.83635z",fillRule:"evenodd",clipRule:"evenodd"}}]},He=S.forwardRef(function(a,t){return S.createElement(X,Object.assign({},a,{id:"autofill",ref:t,icon:gn}))});He.displayName="Autofill";var dn={tag:"svg",attrs:{fill:"none",viewBox:"0 0 17 16",width:"1em",height:"1em"},children:[{tag:"path",attrs:{fill:"currentColor",d:"M14.0045 4.4334C14.8881 4.4334 15.6045 3.71705 15.6045 2.8334 15.6045 1.94974 14.8881 1.2334 14.0045 1.2334H3.70449C2.82084 1.2334 2.10449 1.94974 2.10449 2.8334 2.10449 3.71705 2.82084 4.4334 3.70449 4.4334H14.0045zM14.4045 2.8334C14.4045 3.05431 14.2254 3.2334 14.0045 3.2334H3.70449C3.48358 3.2334 3.30449 3.05431 3.30449 2.8334 3.30449 2.61248 3.48358 2.4334 3.70449 2.4334H14.0045C14.2254 2.4334 14.4045 2.61249 14.4045 2.8334zM14.1544 8.5999C15.038 8.5999 15.7544 7.88356 15.7544 6.9999 15.7544 6.11625 15.038 5.3999 14.1544 5.3999H3.85439C2.97074 5.3999 2.25439 6.11625 2.25439 6.9999 2.25439 7.88356 2.97074 8.5999 3.85439 8.5999H14.1544zM14.5544 6.9999C14.5544 7.22082 14.3753 7.3999 14.1544 7.3999H3.85439C3.63348 7.3999 3.45439 7.22082 3.45439 6.9999 3.45439 6.77899 3.63348 6.5999 3.85439 6.5999H14.1544C14.3753 6.5999 14.5544 6.77899 14.5544 6.9999z",fillRule:"evenodd",clipRule:"evenodd"}},{tag:"path",attrs:{fill:"currentColor",d:"M8.57975 14.5902L6.58023 12.5907C6.34591 12.3564 6.34591 11.9765 6.58023 11.7421 6.81454 11.5078 7.19444 11.5078 7.42876 11.7421L8.40449 12.7179V10.1664C8.40449 9.83504 8.67312 9.56641 9.00449 9.56641 9.33586 9.56641 9.60449 9.83504 9.60449 10.1664V12.7179L10.5802 11.7421C10.8145 11.5078 11.1944 11.5078 11.4288 11.7421 11.6631 11.9765 11.6631 12.3564 11.4288 12.5907L9.42923 14.5902M8.57975 14.5902C8.58121 14.5917 8.58268 14.5931 8.58416 14.5946 8.64077 14.6502 8.70566 14.6923 8.77482 14.7209 8.84557 14.7502 8.92314 14.7664 9.00449 14.7664 9.08585 14.7664 9.16342 14.7502 9.23416 14.7209 9.30332 14.6923 9.36821 14.6502 9.42482 14.5946"}}]},Ge=S.forwardRef(function(a,t){return S.createElement(X,Object.assign({},a,{id:"bottom-single",ref:t,icon:dn}))});Ge.displayName="BottomSingle";var hn={tag:"svg",attrs:{fill:"none",viewBox:"0 0 16 16",width:"1em",height:"1em"},children:[{tag:"path",attrs:{fill:"currentColor",d:"M5.97705 7.51296C5.97705 7.18159 6.24568 6.91296 6.57705 6.91296H8.48632C8.81769 6.91296 9.08632 7.18159 9.08632 7.51296 9.08632 7.84433 8.81769 8.11296 8.48632 8.11296H6.57705C6.24568 8.11296 5.97705 7.84433 5.97705 7.51296zM6.57705 9.41028C6.24568 9.41028 5.97705 9.67891 5.97705 10.0103 5.97705 10.3416 6.24568 10.6103 6.57705 10.6103H10.8199C11.1512 10.6103 11.4199 10.3416 11.4199 10.0103 11.4199 9.67891 11.1512 9.41028 10.8199 9.41028H6.57705z"}},{tag:"path",attrs:{fill:"currentColor",d:"M3.51074 2.37063C3.51074 1.48697 4.22709 0.77063 5.11074 0.77063H9.80318L9.81294 0.770708C9.97168 0.768161 10.1311 0.82824 10.2511 0.95055L14.4317 5.21408C14.5165 5.30049 14.5697 5.406 14.5917 5.51645C14.6041 5.5644 14.6106 5.61467 14.6106 5.66648V11.6406C14.6106 12.5243 13.8943 13.2406 13.0106 13.2406H5.11074C4.22709 13.2406 3.51074 12.5243 3.51074 11.6406V2.37063ZM10.4032 4.66648V2.81964L12.6063 5.06648H10.8032C10.5823 5.06648 10.4032 4.88739 10.4032 4.66648ZM5.11074 1.97063C4.88983 1.97063 4.71074 2.14972 4.71074 2.37063V11.6406C4.71074 11.8615 4.88983 12.0406 5.11074 12.0406H13.0106C13.2316 12.0406 13.4106 11.8615 13.4106 11.6406V6.26648H10.8032C9.91953 6.26648 9.20318 5.55013 9.20318 4.66648V1.97063H5.11074Z",fillRule:"evenodd",clipRule:"evenodd"}},{tag:"path",attrs:{fill:"currentColor",d:"M2.58916 6.6741C2.58916 6.34273 2.32053 6.0741 1.98916 6.0741C1.65779 6.0741 1.38916 6.34273 1.38916 6.6741V12.6294C1.38916 14.0653 2.55322 15.2294 3.98916 15.2294H9.41408C9.74545 15.2294 10.0141 14.9607 10.0141 14.6294C10.0141 14.298 9.74545 14.0294 9.41408 14.0294H3.98916C3.21596 14.0294 2.58916 13.4026 2.58916 12.6294V6.6741Z"}}]},Ve=S.forwardRef(function(a,t){return S.createElement(X,Object.assign({},a,{id:"create-copy-single",ref:t,icon:hn}))});Ve.displayName="CreateCopySingle";var fn={tag:"svg",attrs:{fill:"none",viewBox:"0 0 17 16",width:"1em",height:"1em"},children:[{tag:"path",attrs:{fill:"currentColor",d:"M7.38125 1.16211C6.49759 1.16211 5.78125 1.87845 5.78125 2.76211V5.6377H2.87783C1.99418 5.6377 1.27783 6.35404 1.27783 7.2377V13.2377C1.27783 14.1214 1.99418 14.8377 2.87783 14.8377H8.87783C9.76149 14.8377 10.4778 14.1214 10.4778 13.2377V10.3621H13.3813C14.2649 10.3621 14.9813 9.64577 14.9813 8.76211V2.76211C14.9813 1.87845 14.2649 1.16211 13.3813 1.16211H7.38125ZM10.4778 9.16211H13.3813C13.6022 9.16211 13.7812 8.98302 13.7812 8.76211V2.76211C13.7812 2.5412 13.6022 2.36211 13.3813 2.36211H7.38125C7.16034 2.36211 6.98125 2.5412 6.98125 2.76211V5.6377H8.87783C9.76149 5.6377 10.4778 6.35404 10.4778 7.2377V9.16211ZM6.98125 6.8377H8.87783C9.09875 6.8377 9.27783 7.01678 9.27783 7.2377V9.16211H7.38125C7.16034 9.16211 6.98125 8.98302 6.98125 8.76211V6.8377ZM5.78125 6.8377V8.76211C5.78125 9.64577 6.49759 10.3621 7.38125 10.3621H9.27783V13.2377C9.27783 13.4586 9.09875 13.6377 8.87783 13.6377H2.87783C2.65692 13.6377 2.47783 13.4586 2.47783 13.2377V7.2377C2.47783 7.01678 2.65692 6.8377 2.87783 6.8377H5.78125Z",fillRule:"evenodd",clipRule:"evenodd"}}]},We=S.forwardRef(function(a,t){return S.createElement(X,Object.assign({},a,{id:"group-single",ref:t,icon:fn}))});We.displayName="GroupSingle";var pn={tag:"svg",attrs:{fill:"none",viewBox:"0 0 16 16",width:"1em",height:"1em"},children:[{tag:"path",attrs:{fill:"currentColor",d:"M11.3536 6.14645C11.5488 6.34171 11.5488 6.65829 11.3536 6.85355L8.35355 9.85355C8.15829 10.0488 7.84171 10.0488 7.64645 9.85355L4.64645 6.85355C4.45118 6.65829 4.45118 6.34171 4.64645 6.14645C4.84171 5.95118 5.15829 5.95118 5.35355 6.14645L8 8.79289L10.6464 6.14645C10.8417 5.95118 11.1583 5.95118 11.3536 6.14645Z",fillRule:"evenodd",clipRule:"evenodd"}}]},ke=S.forwardRef(function(a,t){return S.createElement(X,Object.assign({},a,{id:"more-down-single",ref:t,icon:pn}))});ke.displayName="MoreDownSingle";var Cn={tag:"svg",attrs:{fill:"none",viewBox:"0 0 16 16",width:"1em",height:"1em"},children:[{tag:"path",attrs:{fill:"currentColor",d:"M1.25 2.96401C1.25 3.84767 1.96634 4.56401 2.85 4.56401H13.15C14.0337 4.56401 14.75 3.84767 14.75 2.96401C14.75 2.08036 14.0337 1.36401 13.15 1.36401H2.85C1.96635 1.36401 1.25 2.08036 1.25 2.96401ZM2.85 3.36401C2.62909 3.36401 2.45 3.18493 2.45 2.96401C2.45 2.7431 2.62909 2.56401 2.85 2.56401H13.15C13.3709 2.56401 13.55 2.7431 13.55 2.96401C13.55 3.18493 13.3709 3.36401 13.15 3.36401H2.85Z",fillRule:"evenodd",clipRule:"evenodd"}},{tag:"path",attrs:{fill:"currentColor",d:"M5.57564 11.6118C5.80995 11.3774 6.18985 11.3774 6.42417 11.6118L7.3999 12.5875V6.36951C7.3999 6.03814 7.66853 5.76951 7.9999 5.76951C8.33127 5.76951 8.5999 6.03814 8.5999 6.36951V12.5875L9.57564 11.6118C9.80995 11.3774 10.1899 11.3774 10.4242 11.6118C10.6585 11.8461 10.6585 12.226 10.4242 12.4603L8.4324 14.452C8.32324 14.5655 8.16982 14.6362 7.9999 14.6362C7.82998 14.6362 7.67655 14.5655 7.56739 14.452L5.57564 12.4603C5.34132 12.226 5.34132 11.8461 5.57564 11.6118Z"}}]},ze=S.forwardRef(function(a,t){return S.createElement(X,Object.assign({},a,{id:"move-down-single",ref:t,icon:Cn}))});ze.displayName="MoveDownSingle";var wn={tag:"svg",attrs:{fill:"none",viewBox:"0 0 16 16",width:"1em",height:"1em"},children:[{tag:"path",attrs:{fill:"currentColor",d:"M1.25 13.036C1.25 12.1523 1.96634 11.436 2.85 11.436H13.15C14.0337 11.436 14.75 12.1523 14.75 13.036C14.75 13.9196 14.0337 14.636 13.15 14.636H2.85C1.96635 14.636 1.25 13.9196 1.25 13.036ZM2.85 12.636C2.62909 12.636 2.45 12.8151 2.45 13.036C2.45 13.2569 2.62909 13.436 2.85 13.436H13.15C13.3709 13.436 13.55 13.2569 13.55 13.036C13.55 12.8151 13.3709 12.636 13.15 12.636H2.85Z",fillRule:"evenodd",clipRule:"evenodd"}},{tag:"path",attrs:{fill:"currentColor",d:"M5.57564 4.38825C5.80995 4.62256 6.18985 4.62256 6.42417 4.38825L7.3999 3.41251V9.63049C7.3999 9.96186 7.66853 10.2305 7.9999 10.2305C8.33127 10.2305 8.5999 9.96186 8.5999 9.63049V3.41251L9.57564 4.38825C9.80995 4.62256 10.1899 4.62256 10.4242 4.38825C10.6585 4.15393 10.6585 3.77403 10.4242 3.53972L8.4324 1.54796C8.32324 1.43445 8.16982 1.36382 7.9999 1.36382C7.82998 1.36382 7.67655 1.43446 7.56739 1.54797L5.57564 3.53972C5.34132 3.77403 5.34132 4.15393 5.57564 4.38825Z"}}]},Ke=S.forwardRef(function(a,t){return S.createElement(X,Object.assign({},a,{id:"move-up-single",ref:t,icon:wn}))});Ke.displayName="MoveUpSingle";var vn={tag:"svg",attrs:{fill:"none",viewBox:"0 0 17 16",width:"1em",height:"1em"},children:[{tag:"path",attrs:{fill:"currentColor",d:"M7.82994 1.40913C7.88746 1.35161 7.95376 1.30821 8.02453 1.27893C8.09527 1.24959 8.17285 1.2334 8.2542 1.2334C8.33555 1.2334 8.41313 1.24959 8.48387 1.27893C8.55464 1.30821 8.62094 1.35161 8.67846 1.40913L10.6785 3.40913C10.9128 3.64345 10.9128 4.02335 10.6785 4.25766C10.4441 4.49198 10.0642 4.49198 9.82994 4.25766L8.8542 3.28193V5.8334C8.8542 6.16477 8.58557 6.4334 8.2542 6.4334C7.92283 6.4334 7.6542 6.16477 7.6542 5.8334V3.28193L6.67846 4.25766C6.44415 4.49198 6.06425 4.49198 5.82994 4.25766C5.59562 4.02335 5.59562 3.64345 5.82994 3.40913L7.82994 1.40913Z"}},{tag:"path",attrs:{fill:"currentColor",d:"M1.50439 9C1.50439 8.11634 2.22074 7.4 3.10439 7.4H13.4044C14.288 7.4 15.0044 8.11634 15.0044 9 15.0044 9.88366 14.2881 10.6 13.4044 10.6H3.1044C2.22074 10.6 1.50439 9.88366 1.50439 9zM3.10439 8.6C2.88348 8.6 2.70439 8.77909 2.70439 9 2.70439 9.22091 2.88348 9.4 3.1044 9.4H13.4044C13.6253 9.4 13.8044 9.22091 13.8044 9 13.8044 8.77909 13.6253 8.6 13.4044 8.6H3.10439zM1.6543 13.1665C1.6543 12.2828 2.37064 11.5665 3.2543 11.5665H13.5543C14.438 11.5665 15.1543 12.2828 15.1543 13.1665 15.1543 14.0502 14.438 14.7665 13.5543 14.7665H3.2543C2.37064 14.7665 1.6543 14.0502 1.6543 13.1665zM3.2543 12.7665C3.03338 12.7665 2.8543 12.9456 2.8543 13.1665 2.8543 13.3874 3.03338 13.5665 3.2543 13.5665H13.5543C13.7752 13.5665 13.9543 13.3874 13.9543 13.1665 13.9543 12.9456 13.7752 12.7665 13.5543 12.7665H3.2543z",fillRule:"evenodd",clipRule:"evenodd"}}]},Fe=S.forwardRef(function(a,t){return S.createElement(X,Object.assign({},a,{id:"topmost-single",ref:t,icon:vn}))});Fe.displayName="TopmostSingle";var Sn={tag:"svg",attrs:{fill:"none",viewBox:"0 0 17 16",width:"1em",height:"1em"},children:[{tag:"path",attrs:{fill:"currentColor",d:"M7.46855 2.83731C7.46855 2.61639 7.64764 2.4373 7.86855 2.4373H13.8603C14.0812 2.4373 14.2603 2.61639 14.2603 2.8373V9.5049C14.2603 9.72581 14.0812 9.90489 13.8603 9.90489H12.866C12.5346 9.90489 12.266 10.1735 12.266 10.5049C12.266 10.8363 12.5346 11.1049 12.866 11.1049H13.8603C14.7439 11.1049 15.4603 10.3886 15.4603 9.5049V2.8373C15.4603 1.95365 14.7439 1.2373 13.8603 1.2373H7.86855C6.9849 1.2373 6.26855 1.95365 6.26855 2.83731V3.48688C6.26855 3.81825 6.53718 4.08688 6.86855 4.08688C7.19993 4.08688 7.46855 3.81825 7.46855 3.48688V2.83731Z"}},{tag:"path",attrs:{fill:"currentColor",d:"M3.19888 5.56299C2.31522 5.56299 1.59888 6.27933 1.59888 7.16299V13.163C1.59888 14.0466 2.31522 14.763 3.19888 14.763H9.19888C10.0825 14.763 10.7989 14.0466 10.7989 13.163V7.16299C10.7989 6.27933 10.0825 5.56299 9.19888 5.56299H3.19888ZM2.79888 7.16299C2.79888 6.94207 2.97796 6.76299 3.19888 6.76299H9.19888C9.41979 6.76299 9.59888 6.94207 9.59888 7.16299V13.163C9.59888 13.3839 9.41979 13.563 9.19888 13.563H3.19888C2.97796 13.563 2.79888 13.3839 2.79888 13.163V7.16299Z",fillRule:"evenodd",clipRule:"evenodd"}}]},Ye=S.forwardRef(function(a,t){return S.createElement(X,Object.assign({},a,{id:"ungroup-single",ref:t,icon:Sn}))});Ye.displayName="UngroupSingle";const _n=a=>{const{arrangeShow:t,drawings:n}=a,e=d.useDependency(d.LocaleService),r=d.useDependency(j.IDrawingManagerService),s=u=>u?"block":"none",[i,o]=S.useState(n);S.useEffect(()=>{const u=r.focus$.subscribe(m=>{o(m)});return()=>{u.unsubscribe()}},[]);const c=u=>{const m=i[0].unitId,h=i[0].subUnitId,f=i.map(p=>p.drawingId);r.featurePluginOrderUpdateNotification({unitId:m,subUnitId:h,drawingIds:f,arrangeType:u})};return l.jsxs("div",{className:g.imageCommonPanelGrid,style:{display:s(t)},children:[l.jsx("div",{className:g.imageCommonPanelRow,children:l.jsx("div",{className:N(g.imageCommonPanelColumn,g.imageCommonPanelTitle),children:l.jsx("div",{children:e.t("image-panel.arrange.title")})})}),l.jsxs("div",{className:g.imageCommonPanelRow,children:[l.jsx("div",{className:N(g.imageCommonPanelColumn,g.imageCommonPanelSpan2),children:l.jsx(k.Button,{size:"small",onClick:()=>{c(d.ArrangeTypeEnum.forward)},children:l.jsxs("span",{className:g.imageCommonPanelInline,children:[l.jsx(Ke,{}),e.t("image-panel.arrange.forward")]})})}),l.jsx("div",{className:N(g.imageCommonPanelColumn,g.imageCommonPanelSpan2),children:l.jsx(k.Button,{size:"small",onClick:()=>{c(d.ArrangeTypeEnum.backward)},children:l.jsxs("span",{className:g.imageCommonPanelInline,children:[l.jsx(ze,{}),e.t("image-panel.arrange.backward")]})})})]}),l.jsxs("div",{className:g.imageCommonPanelRow,children:[l.jsx("div",{className:N(g.imageCommonPanelColumn,g.imageCommonPanelSpan2),children:l.jsx(k.Button,{size:"small",onClick:()=>{c(d.ArrangeTypeEnum.front)},children:l.jsxs("span",{className:g.imageCommonPanelInline,children:[l.jsx(Fe,{}),e.t("image-panel.arrange.front")]})})}),l.jsx("div",{className:N(g.imageCommonPanelColumn,g.imageCommonPanelSpan2),children:l.jsx(k.Button,{size:"small",onClick:()=>{c(d.ArrangeTypeEnum.back)},children:l.jsxs("span",{className:g.imageCommonPanelInline,children:[l.jsx(Ge,{}),e.t("image-panel.arrange.back")]})})})]})]})},In=a=>{const t=d.useDependency(d.LocaleService),n=d.useDependency(b.IRenderManagerService),e=d.useDependency(j.IDrawingManagerService),{hasGroup:r,drawings:s}=a,[i,o]=S.useState(!1),[c,u]=S.useState(!0),[m,h]=S.useState(!0),f=C=>C?"block":"none",p=()=>{const C=e.getFocusDrawings(),{unitId:P,subUnitId:I}=C[0],E=d.Tools.generateRandomId(10),R=b.getGroupState(0,0,C.map(D=>D.transform||{})),U={unitId:P,subUnitId:I,drawingId:E,drawingType:d.DrawingTypeEnum.DRAWING_GROUP,transform:R},M=C.map(D=>{const O=D.transform||{left:0,top:0},{unitId:T,subUnitId:A,drawingId:V}=D;return{unitId:T,subUnitId:A,drawingId:V,transform:{...O,left:O.left-R.left,top:O.top-R.top},groupId:E}});e.featurePluginGroupUpdateNotification([{parent:U,children:M}])},_=C=>{if(C.drawingType!==d.DrawingTypeEnum.DRAWING_GROUP)return;const{unitId:P,subUnitId:I,drawingId:E,transform:R={width:0,height:0}}=C;if(R==null)return;const U=e.getDrawingsByGroup({unitId:P,subUnitId:I,drawingId:E});if(U.length===0)return;const M=U.map(D=>{const{transform:O}=D,{unitId:T,subUnitId:A,drawingId:V}=D,L=b.transformObjectOutOfGroup(O||{},R,R.width||0,R.height||0);return{unitId:T,subUnitId:A,drawingId:V,transform:{...O,...L},groupId:void 0}});return{parent:C,children:M}},v=()=>{const P=e.getFocusDrawings().map(I=>_(I)).filter(I=>I!=null);P.length!==0&&e.featurePluginUngroupUpdateNotification(P)};return S.useEffect(()=>{const C=s[0];if(C==null)return;const{unitId:P}=C,I=n.getRenderById(P),E=I==null?void 0:I.scene;if(E==null)return;const R=E.getTransformerByCreate(),U=R.clearControl$.subscribe(D=>{D===!0&&o(!1)}),M=R.changeStart$.subscribe(D=>{const{objects:O}=D,T=me(O,e),A=T.filter(K=>(K==null?void 0:K.drawingType)===d.DrawingTypeEnum.DRAWING_GROUP);let V=!1,L=!1;T.length>1&&(V=!0),A.length>0&&(L=!0),o(V||L),u(V),h(L)});return()=>{M.unsubscribe(),U.unsubscribe()}},[]),l.jsxs("div",{className:N(g.imageCommonPanelGrid,g.imageCommonPanelBorder),style:{display:f(r===!0?i:!1)},children:[l.jsx("div",{className:g.imageCommonPanelRow,children:l.jsx("div",{className:N(g.imageCommonPanelColumn,g.imageCommonPanelTitle),children:l.jsx("div",{children:t.t("image-panel.group.title")})})}),l.jsxs("div",{className:g.imageCommonPanelRow,children:[l.jsx("div",{className:N(g.imageCommonPanelColumn,g.imageCommonPanelSpan2,g.imageCommonPanelColumnCenter),children:l.jsx(k.Button,{size:"small",onClick:()=>{p()},style:{display:f(c)},children:l.jsxs("span",{className:g.imageCommonPanelInline,children:[l.jsx(We,{}),t.t("image-panel.group.group")]})})}),l.jsx("div",{className:N(g.imageCommonPanelColumn,g.imageCommonPanelSpan2,g.imageCommonPanelColumnCenter),children:l.jsx(k.Button,{size:"small",onClick:()=>{v()},style:{display:f(m)},children:l.jsxs("span",{className:g.imageCommonPanelInline,children:[l.jsx(Ye,{}),t.t("image-panel.group.unGroup")]})})})]})]})},ne=20,bn=20,yn=[-3600,3600],ve=300,Pn=a=>{var qe;const t=d.useDependency(d.LocaleService),n=d.useDependency(j.IDrawingManagerService),e=d.useDependency(b.IRenderManagerService),{drawings:r,transformShow:s}=a,i=r[0];if(i==null)return;const o=i.transform;if(o==null)return;const{unitId:c,subUnitId:u,drawingId:m,drawingType:h}=i,f=e.getRenderById(c),p=f==null?void 0:f.scene;if(p==null)return;const _=(qe=p.getEngine())==null?void 0:qe.activeScene;if(_==null)return;const v=p.getTransformerByCreate(),{width:C=0,height:P=0,left:I=0,top:E=0,angle:R=0}=o,[U,M]=S.useState(C),[D,O]=S.useState(P),[T,A]=S.useState(I),[V,L]=S.useState(E),[re,K]=S.useState(R),[ce,ae]=S.useState(v.keepRatio),ie=(w,B,W,z)=>{const{width:G,height:$}=_,{ancestorLeft:Y,ancestorTop:Z}=p;let J=w,se=B,fe=W,pe=z;return w+Y<0&&(J=-Y),B+Z<0&&(se=-Z),fe=G-J-Y,fe<ne&&(fe=ne),pe=$-se-Z,pe<ne&&(pe=ne),w+fe+Y>G&&(J=G-W-Y),B+pe+Z>$&&(se=$-z-Z),{limitLeft:J,limitTop:se,limitWidth:fe,limitHeight:pe}},le=w=>{const{objects:B}=w,W=me(B,n);if(W.length!==1)return;const z=W[0];if(z==null)return;const{transform:G}=z;if(G==null)return;const{width:$,height:Y,left:Z,top:J,angle:se}=G;$!=null&&M($),Y!=null&&O(Y),Z!=null&&A(Z),J!=null&&L(J),se!=null&&K(se)};S.useEffect(()=>{const w=[v.changeStart$.subscribe(B=>{le(B)}),v.changing$.subscribe(B=>{le(B)}),v.changeEnd$.subscribe(B=>{le(B)}),n.focus$.subscribe(B=>{if(B.length!==1)return;const W=n.getDrawingByParam(B[0]);if(W==null)return;const z=W.transform;if(z==null)return;const{width:G,height:$,left:Y,top:Z,angle:J}=z;G!=null&&M(G),$!=null&&O($),Y!=null&&A(Y),Z!=null&&L(Z),J!=null&&K(J)})];return()=>{w.forEach(B=>B.unsubscribe())}},[]);const Q=d.debounce(w=>{if(w==null)return;w=Math.max(w,ne);const{limitWidth:B,limitHeight:W}=ie(T,V,w,D);w=Math.min(w,B);const z={unitId:c,subUnitId:u,drawingId:m,drawingType:h,transform:{width:w}};if(ce){let G=w/U*D;if(G=Math.max(G,bn),G>W)return;O(G),z.transform.height=G}M(w),n.featurePluginUpdateNotification([z]),v.refreshControls().changeNotification()},ve),Oe=d.debounce(w=>{if(w==null)return;w=Math.max(w,ne);const{limitHeight:B,limitWidth:W}=ie(T,V,U,w);w=Math.min(w,B);const z={unitId:c,subUnitId:u,drawingId:m,drawingType:h,transform:{height:w}};if(ce){let G=w/D*U;if(G=Math.max(G,ne),G>W)return;M(G),z.transform.width=G}O(w),n.featurePluginUpdateNotification([z]),v.refreshControls().changeNotification()},ve),Fn=d.debounce(w=>{if(w==null)return;const{limitLeft:B}=ie(w,V,U,D);w=B;const W={unitId:c,subUnitId:u,drawingId:m,drawingType:h,transform:{left:w}};A(w),n.featurePluginUpdateNotification([W]),v.refreshControls().changeNotification()},ve),Yn=d.debounce(w=>{if(w==null)return;const{limitTop:B}=ie(T,w,U,D);w=B;const W={unitId:c,subUnitId:u,drawingId:m,drawingType:h,transform:{top:w}};L(w),n.featurePluginUpdateNotification([W]),v.refreshControls().changeNotification()},ve),Zn=w=>{if(w==null)return;const[B,W]=yn;w<B&&(w=B),w>W&&(w=W);const z={unitId:c,subUnitId:u,drawingId:m,drawingType:h,transform:{angle:w}};K(w),n.featurePluginUpdateNotification([z]),v.refreshControls().changeNotification()},Xn=w=>{ae(w),v.keepRatio=w},Jn=w=>w?"block":"none";return l.jsxs("div",{className:N(g.imageCommonPanelGrid,g.imageCommonPanelBorder),style:{display:Jn(s)},children:[l.jsx("div",{className:g.imageCommonPanelRow,children:l.jsx("div",{className:N(g.imageCommonPanelColumn,g.imageCommonPanelTitle),children:l.jsx("div",{children:t.t("image-panel.transform.title")})})}),l.jsxs("div",{className:g.imageCommonPanelRow,children:[l.jsx("div",{className:N(g.imageCommonPanelColumn,g.imageCommonPanelSpan3),children:l.jsxs("label",{children:[l.jsx("div",{className:g.imageCommonPanelRow,children:l.jsx("div",{className:g.imageCommonPanelColumn,children:t.t("image-panel.transform.width")})}),l.jsx("div",{className:g.imageCommonPanelRow,children:l.jsx("div",{className:g.imageCommonPanelColumn,children:l.jsx(k.InputNumber,{precision:1,value:U,onChange:w=>{Q(w)},className:g.imageCommonPanelInput})})})]})}),l.jsx("div",{className:N(g.imageCommonPanelColumn,g.imageCommonPanelSpan3),children:l.jsxs("label",{children:[l.jsx("div",{className:g.imageCommonPanelRow,children:l.jsx("div",{className:g.imageCommonPanelColumn,children:t.t("image-panel.transform.height")})}),l.jsx("div",{className:g.imageCommonPanelRow,children:l.jsx("div",{className:g.imageCommonPanelColumn,children:l.jsx(k.InputNumber,{precision:1,value:D,onChange:w=>{Oe(w)},className:g.imageCommonPanelInput})})})]})}),l.jsx("div",{className:N(g.imageCommonPanelColumn,g.imageCommonPanelSpan3),children:l.jsxs("label",{children:[l.jsx("div",{className:g.imageCommonPanelRow,children:l.jsx("div",{className:g.imageCommonPanelColumn,children:t.t("image-panel.transform.lock")})}),l.jsx("div",{className:N(g.imageCommonPanelRow,g.imageCommonPanelRowVertical),children:l.jsx("div",{className:g.imageCommonPanelColumn,children:l.jsx(k.Checkbox,{checked:ce,onChange:Xn})})})]})})]}),l.jsxs("div",{className:g.imageCommonPanelRow,children:[l.jsx("div",{className:N(g.imageCommonPanelColumn,g.imageCommonPanelSpan3),children:l.jsxs("label",{children:[l.jsx("div",{className:g.imageCommonPanelRow,children:l.jsx("div",{className:g.imageCommonPanelColumn,children:t.t("image-panel.transform.x")})}),l.jsx("div",{className:g.imageCommonPanelRow,children:l.jsx("div",{className:g.imageCommonPanelColumn,children:l.jsx(k.InputNumber,{precision:1,value:T,onChange:w=>{Fn(w)},className:g.imageCommonPanelInput})})})]})}),l.jsx("div",{className:N(g.imageCommonPanelColumn,g.imageCommonPanelSpan3),children:l.jsxs("label",{children:[l.jsx("div",{className:g.imageCommonPanelRow,children:l.jsx("div",{className:g.imageCommonPanelColumn,children:t.t("image-panel.transform.y")})}),l.jsx("div",{className:g.imageCommonPanelRow,children:l.jsx("div",{className:g.imageCommonPanelColumn,children:l.jsx(k.InputNumber,{precision:1,value:V,onChange:w=>{Yn(w)},className:g.imageCommonPanelInput})})})]})}),l.jsx("div",{className:N(g.imageCommonPanelColumn,g.imageCommonPanelSpan3),children:l.jsxs("label",{children:[l.jsx("div",{className:g.imageCommonPanelRow,children:l.jsx("div",{className:g.imageCommonPanelColumn,children:t.t("image-panel.transform.rotate")})}),l.jsx("div",{className:g.imageCommonPanelRow,children:l.jsx("div",{className:g.imageCommonPanelColumn,children:l.jsx(k.InputNumber,{precision:1,value:re,onChange:Zn,className:g.imageCommonPanelInput})})})]})})]})]})},Se={id:"sheet.operation.open-image-crop",type:d.CommandType.OPERATION,handler:(a,t)=>!0},ee={id:"sheet.operation.close-image-crop",type:d.CommandType.OPERATION,handler:(a,t)=>!0};var H=(a=>(a.FREE="0",a.R1_1="1",a.R16_9="2",a.R9_16="3",a.R5_4="4",a.R4_5="5",a.R4_3="6",a.R3_4="7",a.R3_2="8",a.R2_3="9",a))(H||{});const ge={id:"sheet.operation.Auto-image-crop",type:d.CommandType.OPERATION,handler:(a,t)=>!0},jn=a=>{const t=d.useDependency(d.ICommandService),n=d.useDependency(d.LocaleService),{drawings:e,cropperShow:r}=a;if(e[0]==null)return;const[i,o]=S.useState(H.FREE),c=S.useRef(!1),u=[{label:n.t("image-panel.crop.mode"),value:H.FREE},{label:"1:1",value:H.R1_1},{label:"16:9",value:H.R16_9},{label:"9:16",value:H.R9_16},{label:"5:4",value:H.R5_4},{label:"4:5",value:H.R4_5},{label:"4:3",value:H.R4_3},{label:"3:4",value:H.R3_4},{label:"3:2",value:H.R3_2},{label:"2:3",value:H.R2_3}];S.useEffect(()=>{const p=t.onCommandExecuted(_=>{if(_.id===ee.id){const v=_.params;v!=null&&v.isAuto||(c.current=!1)}});return()=>{p==null||p.dispose()}},[]);function m(p){o(p),c.current&&t.executeCommand(ge.id,{cropType:p})}const h=p=>p?"block":"none",f=p=>{t.executeCommand(ge.id,{cropType:p}),c.current=!0};return l.jsxs("div",{className:N(g.imageCommonPanelGrid,g.imageCommonPanelBorder),style:{display:h(r)},children:[l.jsx("div",{className:g.imageCommonPanelRow,children:l.jsx("div",{className:N(g.imageCommonPanelColumn,g.imageCommonPanelTitle),children:l.jsx("div",{children:n.t("image-panel.crop.title")})})}),l.jsxs("div",{className:N(g.imageCommonPanelRow,g.imageCommonPanelRowVertical),children:[l.jsx("div",{className:N(g.imageCommonPanelColumn,g.imageCommonPanelSpan2),children:l.jsx(k.Button,{size:"small",onClick:()=>{f(i)},children:l.jsxs("span",{className:g.imageCommonPanelInline,children:[l.jsx(Ve,{}),n.t("image-panel.crop.start")]})})}),l.jsx("div",{className:N(g.imageCommonPanelColumn,g.imageCommonPanelSpan2),children:l.jsx(k.Select,{value:i,options:u,onChange:m})})]})]})},Rn=a=>{const t=d.useDependency(j.IDrawingManagerService),n=d.useDependency(b.IRenderManagerService),e=d.useDependency(d.LocaleService),{drawings:r,hasArrange:s=!0,hasTransform:i=!0,hasAlign:o=!0,hasCropper:c=!0,hasGroup:u=!0}=a,m=r[0];if(m==null)return;const{unitId:h}=m,f=n.getRenderById(h),p=f==null?void 0:f.scene;if(p==null)return;const _=p.getTransformerByCreate(),[v,C]=S.useState(!0),[P,I]=S.useState(!0),[E,R]=S.useState(!1),[U,M]=S.useState(!0),[D,O]=S.useState(!1);return S.useEffect(()=>{const T=_.clearControl$.subscribe(L=>{L===!0&&(C(!1),I(!1),R(!1),M(!1),O(!0))}),A=_.changeStart$.subscribe(L=>{const{objects:re}=L,K=me(re,t);K.length===0?(C(!1),I(!1),R(!1),M(!1),O(!0)):K.length===1?(C(!0),I(!0),R(!1),M(!0),O(!1)):(C(!0),I(!1),R(!0),M(!1),O(!1))}),V=t.focus$.subscribe(L=>{L.length===0?(C(!1),I(!1),R(!1),M(!1),O(!0)):L.length===1?(C(!0),I(!0),R(!1),M(!0),O(!1)):(C(!0),I(!1),R(!0),M(!1),O(!1))});return()=>{A.unsubscribe(),T.unsubscribe(),V.unsubscribe()}},[]),l.jsxs(l.Fragment,{children:[l.jsx("div",{style:{display:D===!0?"block":"none",height:"100%"},children:l.jsx("div",{style:{display:"flex",justifyContent:"center",alignItems:"center",height:"100%",top:"50%",marginTop:"-100px"},children:l.jsx("span",{children:e.t("image-panel.null")})})}),l.jsx(_n,{arrangeShow:s===!0?v:!1,drawings:r}),l.jsx(Pn,{transformShow:i===!0?P:!1,drawings:r}),l.jsx(on,{alignShow:o===!0?E:!1,drawings:r}),l.jsx(jn,{cropperShow:c===!0?U:!1,drawings:r}),l.jsx(In,{hasGroup:u,drawings:r})]})},de={imagePopupMenu:"univer-image-popup-menu",imagePopupMenuItem:"univer-image-popup-menu-item",imagePopupMenuItemIcon:"univer-image-popup-menu-item-icon",imagePopupMenuItemTitle:"univer-image-popup-menu-item-title",imagePopupMenuItemHide:"univer-image-popup-menu-item-hide",btnContainer:"univer-btn-container",btnContainerExpand:"univer-btn-container-expand"},Ze=a=>{var _,v;const t=(v=(_=a.popup)==null?void 0:_.extraProps)==null?void 0:v.menuItems;if(!t)return null;const n=d.useDependency(d.ICommandService),e=d.useDependency(d.LocaleService),[r,s]=S.useState(!1),[i,o]=S.useState(!1),c=()=>{o(!0)},u=()=>{o(!1)},m=C=>{s(C)},h=C=>{n.executeCommand(C.commandId,C.commandParams),s(!1)},f=r||i,p=t.filter(C=>!C.disable);return l.jsx("div",{onMouseEnter:c,onMouseLeave:u,children:l.jsx(k.DropdownLegacy,{placement:"bottomLeft",trigger:["click"],overlay:l.jsx("ul",{className:de.imagePopupMenu,children:p.map(C=>l.jsx("li",{onClick:()=>h(C),className:de.imagePopupMenuItem,children:l.jsx("span",{className:de.imagePopupMenuItemTitle,children:e.t(C.label)})},C.index))}),visible:r,onVisibleChange:m,children:l.jsxs("div",{className:N(de.btnContainer,{[de.btnContainerExpand]:r}),children:[l.jsx(He,{style:{color:"#35322B"},extend:{colorChannel1:"rgb(var(--green-700, #409f11))"}}),f&&l.jsx(ke,{style:{color:"#CCCCCC",fontSize:"8px",marginLeft:"8px"}})]})})})},Xe="COMPONENT_IMAGE_POPUP_MENU",Dn="drawing-ui.config",Je={},De={id:"sheet.operation.image-reset-size",type:d.CommandType.OPERATION,handler:(a,t)=>!0},Mn=a=>{const{src:t}=a;return t?l.jsx("div",{children:l.jsx("img",{src:t,alt:"Univer Image Viewer",style:{width:"100%",height:"100%",position:"relative"}})}):null};var On=Object.defineProperty,xn=Object.getOwnPropertyDescriptor,Nn=(a,t,n,e)=>{for(var r=e>1?void 0:e?xn(t,n):t,s=a.length-1,i;s>=0;s--)(i=a[s])&&(r=(e?i(t,n,r):i(r))||r);return e&&r&&On(t,n,r),r},Qe=(a,t)=>(n,e)=>t(n,e,a);let _e=class extends d.Disposable{constructor(a,t){super(),this._componentManager=a,this._commandService=t,this._init()}_initCustomComponents(){const a=this._componentManager;this.disposeWithMe(a.register(Xe,Ze)),this.disposeWithMe(a.register(Ee,Mn))}_initCommands(){[Se,ee,De,we,ge].forEach(a=>this.disposeWithMe(this._commandService.registerCommand(a)))}_init(){this._initCommands(),this._initCustomComponents()}};_e=Nn([Qe(0,d.Inject(Ce.ComponentManager)),Qe(1,d.ICommandService)],_e);var En=Object.defineProperty,Tn=Object.getOwnPropertyDescriptor,Bn=(a,t,n,e)=>{for(var r=e>1?void 0:e?Tn(t,n):t,s=a.length-1,i;s>=0;s--)(i=a[s])&&(r=(e?i(t,n,r):i(r))||r);return e&&r&&En(t,n,r),r},Ie=(a,t)=>(n,e)=>t(n,e,a);let be=class extends d.Disposable{constructor(t,n,e,r){super();q(this,"_sceneListenerOnDrawingMap",new WeakSet);this._currentUniverService=t,this._commandService=n,this._renderManagerService=e,this._drawingManagerService=r,this._initialize()}dispose(){super.dispose()}_initialize(){this._recoveryImages(),this._drawingAddListener(),this._drawingRemoveListener(),this._drawingUpdateListener(),this._commandExecutedListener(),this._drawingArrangeListener(),this._drawingGroupListener(),this._drawingRefreshListener(),this._drawingVisibleListener()}_recoveryImages(){const t=this._drawingManagerService.drawingManagerData,n=Ne(this._currentUniverService);if(n==null)return;const{unitId:e,subUnitId:r}=n;Object.keys(t).forEach(s=>{Object.keys(t[s]).forEach(i=>{const o=t[s][i].data;o==null||s!==e||i!==r||Object.keys(o).forEach(c=>{o[c]&&this._insertDrawing([{unitId:s,subUnitId:i,drawingId:c}])})})})}_commandExecutedListener(){this.disposeWithMe(this._commandService.onCommandExecuted(t=>{if(t.id===we.id){const n=t.params;if(n==null)return;this._drawingAlign(n)}}))}_drawingGroupListener(){this.disposeWithMe(this._drawingManagerService.group$.subscribe(t=>{this._groupDrawings(t)})),this.disposeWithMe(this._drawingManagerService.ungroup$.subscribe(t=>{this._ungroupDrawings(t)}))}_getSceneAndTransformerByDrawingSearch(t){if(t==null)return;const n=this._renderManagerService.getRenderById(t),e=n==null?void 0:n.scene;if(e==null)return null;const r=e.getTransformerByCreate();return{scene:e,transformer:r}}_groupDrawings(t){t.forEach(n=>{this._groupDrawing(n)})}_groupDrawing(t){const{parent:n,children:e}=t,{unitId:r,subUnitId:s,drawingId:i}=n,o=this._getSceneAndTransformerByDrawingSearch(n.unitId);if(o==null)return;const{scene:c,transformer:u}=o;this._commandService.syncExecuteCommand(ee.id);const m=[];if(e.forEach(p=>{const _=j.getDrawingShapeKeyByDrawingSearch(p),v=c.getObjectIncludeInGroup(_);if(v==null||m.includes(v))return;m.push(v);const{transform:C}=p;C!=null&&(v.classType===b.RENDER_CLASS_TYPE.GROUP?v.transformByState({left:C.left,top:C.top}):v.transformByState(C))}),m.length===0)return;const h=j.getDrawingShapeKeyByDrawingSearch({unitId:r,subUnitId:s,drawingId:i}),f=new b.Group(h);c.addObject(f,b.DRAWING_OBJECT_LAYER_INDEX).attachTransformerTo(f),f.addObjects(...m),n.transform&&f.transformByState({left:n.transform.left,top:n.transform.top}),u.clearSelectedObjects(),u.setSelectedControl(f)}_ungroupDrawings(t){t.forEach(n=>{this._ungroupDrawing(n)})}_ungroupDrawing(t){const{parent:n,children:e}=t,r=this._getSceneAndTransformerByDrawingSearch(n.unitId);if(r==null)return;const{scene:s,transformer:i}=r;e.forEach(h=>{const f=j.getDrawingShapeKeyByDrawingSearch(h),p=s.getObjectIncludeInGroup(f);if(p==null)return!0;if(p==null)return;const{transform:_}=h;_!=null&&(p.classType===b.RENDER_CLASS_TYPE.GROUP?p.transformByState({left:_.left,top:_.top}):p.transformByState(_))});const o=j.getDrawingShapeKeyByDrawingSearch(n),c=s.getObject(o),{width:u,height:m}=c;c.getObjects().forEach(h=>{c.removeSelfObjectAndTransform(h.oKey,u,m)}),c.dispose(),i.clearSelectedObjects()}_drawingAlign(t){const{alignType:n}=t,e=this._drawingManagerService.getFocusDrawings();if(n===x.default)return;const r=[];let s=Number.POSITIVE_INFINITY,i=Number.POSITIVE_INFINITY,o=Number.NEGATIVE_INFINITY,c=Number.NEGATIVE_INFINITY,u=0;e.forEach(m=>{const{unitId:h,subUnitId:f,drawingId:p,drawingType:_}=m,v=this._drawingManagerService.getDrawingByParam({unitId:h,subUnitId:f,drawingId:p});if(v==null||v.transform==null)return;r.push({unitId:h,subUnitId:f,drawingId:p,drawingType:_,transform:v.transform});const{left:C=0,top:P=0,width:I=0,height:E=0}=v.transform;s=Math.min(s,C),i=Math.min(i,P),o=Math.max(o,C+I),c=Math.max(c,P+E),u++}),u!==0&&(this._sortDrawingTransform(r,n),this._applyAlignType(r,n,s,i,o,c,u))}_applyAlignType(t,n,e,r,s,i,o){const c=Math.round((s-e)/o*10)/10,u=Math.round((i-r)/o*10)/10,m=[],h=this._getSceneAndTransformerByDrawingSearch(t[0].unitId);if(h==null)return;const{scene:f,transformer:p}=h;t.forEach((_,v)=>{const{unitId:C,subUnitId:P,drawingId:I,transform:E,drawingType:R}=_,{left:U=0,top:M=0,width:D=0,height:O=0}=E;let T=U,A=M;switch(n){case x.left:T=e;break;case x.center:T=e+(s-e)/2-D/2;break;case x.right:T=s-D;break;case x.top:A=r;break;case x.middle:A=r+(i-r)/2-O/2;break;case x.bottom:A=i-O;break;case x.horizon:T=e+c*v;break;case x.vertical:A=r+u*v;break}(T!==U||A!==M)&&m.push({unitId:C,subUnitId:P,drawingId:I,drawingType:R,transform:{left:T,top:A}})}),this._drawingManagerService.featurePluginUpdateNotification(m),p.refreshControls().changeNotification()}_sortDrawingTransform(t,n){t.sort((e,r)=>{const s=e.transform,i=r.transform,{left:o=0,top:c=0,width:u=0,height:m=0}=s,{left:h=0,top:f=0,width:p=0,height:_=0}=i;switch(n){case x.left:return o-h;case x.center:return o+u/2-(h+p/2);case x.right:return o+u-(h+p);case x.top:return c-f;case x.middle:return c+m/2-(f+_/2);case x.bottom:return c+m-(f+_);case x.horizon:return o+u/2-(h+p/2);case x.vertical:return c+m/2-(f+_/2);default:return 0}})}_drawingArrangeListener(){this.disposeWithMe(this._drawingManagerService.order$.subscribe(t=>{this._drawingArrange(t)}))}_drawingArrange(t){const{unitId:n,subUnitId:e,drawingIds:r}=t,s=this._getSceneAndTransformerByDrawingSearch(n);if(s==null)return;const{scene:i}=s;r.forEach(o=>{const c=j.getDrawingShapeKeyByDrawingSearch({unitId:n,subUnitId:e,drawingId:o}),u=i.fuzzyMathObjects(c,!0);if(u==null||u.length===0)return;const m=this._drawingManagerService.getDrawingOrder(n,e).indexOf(o);for(const h of u)h.setProps({zIndex:m}),h.makeDirty()})}_drawingAddListener(){this.disposeWithMe(this._drawingManagerService.add$.subscribe(t=>{this._insertDrawing(t)}))}_insertDrawing(t){const n=[];t.forEach(e=>{const{unitId:r}=e;if(this._drawingManagerService.getDrawingByParam(e)==null)return;const i=this._getSceneAndTransformerByDrawingSearch(r);if(i==null)return;const{scene:o}=i;n.includes(o)||n.push(o)}),n.forEach(e=>{this._sceneListenerOnDrawingMap.has(e)||(this._addListenerOnDrawing(e),this._sceneListenerOnDrawingMap.add(e))})}_drawingRemoveListener(){this.disposeWithMe(this._drawingManagerService.remove$.subscribe(t=>{t.forEach(n=>{var m;const{unitId:e,subUnitId:r,drawingId:s}=n,i=this._getSceneAndTransformerByDrawingSearch(e);if(i==null)return;const{scene:o}=i,c=j.getDrawingShapeKeyByDrawingSearch({unitId:e,subUnitId:r,drawingId:s}),u=o.fuzzyMathObjects(c,!0);if(u.length>0){for(const h of u)h.dispose();(m=o.getTransformer())==null||m.clearSelectedObjects()}})}))}_drawingUpdateListener(){this.disposeWithMe(this._drawingManagerService.update$.subscribe(t=>{t.forEach(n=>{var D;const{unitId:e,subUnitId:r,drawingId:s}=n,i=this._drawingManagerService.getDrawingByParam(n);if(i==null)return;const{transform:o,drawingType:c}=i,u=this._getSceneAndTransformerByDrawingSearch(e);if(u==null)return;const{scene:m,transformer:h}=u;if(o==null)return!0;const{left:f=0,top:p=0,width:_=0,height:v=0,angle:C=0,flipX:P=!1,flipY:I=!1,skewX:E=0,skewY:R=0}=o,U=j.getDrawingShapeKeyByDrawingSearch({unitId:e,subUnitId:r,drawingId:s}),M=m.getObject(U);if(M==null)return!0;M.transformByState({left:f,top:p,width:_,height:v,angle:C,flipX:P,flipY:I,skewX:E,skewY:R}),(D=m.getTransformer())==null||D.debounceRefreshControls()})}))}_drawingRefreshListener(){this.disposeWithMe(this._drawingManagerService.refreshTransform$.subscribe(t=>{t.forEach(n=>{const{unitId:e,subUnitId:r,drawingId:s}=n,i=this._getSceneAndTransformerByDrawingSearch(e);if(i==null)return;const o=this._drawingManagerService.getDrawingByParam(n);if(o==null)return;const{transform:c}=o,{scene:u}=i,m=j.getDrawingShapeKeyByDrawingSearch({unitId:e,subUnitId:r,drawingId:s}),h=u.getObject(m);if(h==null||c==null)return!0;const{left:f=0,top:p=0,width:_=0,height:v=0,angle:C=0,flipX:P=!1,flipY:I=!1,skewX:E=0,skewY:R=0}=c;h.transformByState({left:f,top:p,width:_,height:v,angle:C,flipX:P,flipY:I,skewX:E,skewY:R})})}))}_drawingVisibleListener(){this.disposeWithMe(this._drawingManagerService.visible$.subscribe(t=>{t.forEach(n=>{const{unitId:e,subUnitId:r,drawingId:s,visible:i}=n,o=this._getSceneAndTransformerByDrawingSearch(e);if(o==null)return;const{scene:c}=o,u=j.getDrawingShapeKeyByDrawingSearch({unitId:e,subUnitId:r,drawingId:s}),m=c.getObject(u);if(m==null)return!0;i?m.show():m.hide()})}))}_filterUpdateParams(t,n){return t.filter((e,r)=>{if(e==null)return!1;const{transform:s}=e;return d.checkIfMove(s,n==null?void 0:n[r])})}_addListenerOnDrawing(t){const n=t.getTransformerByCreate();let e=null;this.disposeWithMe(d.toDisposable(n.changeStart$.subscribe(r=>{const{objects:s}=r,i=Array.from(s.values()),o=[];e=i.map(c=>{const{left:u,top:m,height:h,width:f,angle:p,oKey:_,isInGroup:v}=c,C=this._drawingManagerService.getDrawingOKey(_);if(v||c instanceof b.Group){let P=c.ancestorGroup;if(P==null&&c instanceof b.Group&&(P=c),P==null)return null;const I=this._drawingManagerService.getDrawingOKey(P.oKey);if(I){const{unitId:E,subUnitId:R,drawingId:U}=I;o.push({unitId:E,subUnitId:R,drawingId:U});const{left:M,top:D,height:O,width:T,angle:A}=P;return{left:M,top:D,height:O,width:T,angle:A}}}else if(C!=null){const{unitId:P,subUnitId:I,drawingId:E}=C;return o.push({unitId:P,subUnitId:I,drawingId:E}),{left:u,top:m,height:h,width:f,angle:p}}return null}).filter(c=>c!=null),o.length>0?this._commandService.syncExecuteCommand(j.SetDrawingSelectedOperation.id,o):this._commandService.syncExecuteCommand(j.SetDrawingSelectedOperation.id,[])}))),this.disposeWithMe(d.toDisposable(n.changeEnd$.subscribe(r=>{const{objects:s}=r,i=this._filterUpdateParams(me(s,this._drawingManagerService),e);i.length>0&&this._drawingManagerService.featurePluginUpdateNotification(i)})))}};be=Bn([Ie(0,d.IUniverInstanceService),Ie(1,d.ICommandService),Ie(2,b.IRenderManagerService),Ie(3,j.IDrawingManagerService)],be);class he extends b.Shape{constructor(n,e){e==null&&(e={}),e.transformerConfig={keepRatio:!1,isCropper:!0,anchorFill:"rgb(0, 0, 0)",anchorStroke:"rgb(255, 255, 255)",anchorSize:24};super(n,e);q(this,"_srcRect");q(this,"_prstGeom");q(this,"_applyTransform");q(this,"_dragPadding",8);q(this,"_cacheCanvas");e!=null&&e.srcRect&&(this._srcRect=e.srcRect),e!=null&&e.prstGeom&&(this._prstGeom=e.prstGeom),e!=null&&e.applyTransform&&(this._applyTransform=e.applyTransform),e!=null&&e.dragPadding&&(this._dragPadding=e.dragPadding),this._applyProps()}refreshSrcRect(n,e){this._srcRect=n,this._applyTransform=e,this._applyProps()}get srcRect(){return this._srcRect}dispose(){var n;super.dispose(),(n=this._cacheCanvas)==null||n.dispose(),this._srcRect=null}isHit(n){const e=this.getInverseCoord(n);return e.x>=-this.strokeWidth/2&&e.x<=this.width+this.strokeWidth/2&&e.y>=-this.strokeWidth/2&&e.y<=this.height+this.strokeWidth/2&&!this._inSurround(e)}_inSurround(n){const e=this._dragPadding;return n.x>=e-this.strokeWidth/2&&n.x<=this.width+this.strokeWidth/2-e&&n.y>=e-this.strokeWidth/2&&n.y<=this.height+this.strokeWidth/2-e}render(n,e){return this.visible?(n.save(),this._draw(n),n.restore(),this.makeDirty(!1),this):(this.makeDirty(!1),this)}_draw(n){var c,u;const r=this.getScene().getEngine(),{width:s,height:i}=r;this._initialCacheCanvas(),(c=this._cacheCanvas)==null||c.clear();const o=(u=this._cacheCanvas)==null?void 0:u.getContext();o!=null&&(o.save(),b.Rect.drawWith(o,{left:0,top:0,width:s,height:i,fill:"rgba(0, 0, 0, 0.5)"}),o.setTransform(n.getTransform()),this._clipForApplyObject(o),this._applyCache(n),o.restore())}_clipForApplyObject(n){let e=0;if(this._prstGeom!=null&&(e=1),n.globalCompositeOperation="destination-out",n.beginPath(),e===0){const r=this.transform.getMatrix();n.transform(r[0],r[1],r[2],r[3],r[4],r[5]),n.rect(0,0,this.width,this.height),n.fill()}}_applyProps(){if(this._applyTransform==null)return;let n=0,e=0,r=0,s=0;const{left:i=0,top:o=0,width:c=0,height:u=0,angle:m}=this._applyTransform;if(this._srcRect!=null){const{left:p=0,top:_=0,right:v=0,bottom:C=0}=this._srcRect;n=p,e=_,r=v,s=C}const h=i+n,f=o+e;this.transformByState({left:h,top:f,width:i+c-r-h,height:o+u-s-f,angle:m})}_applyCache(n){if(!n||this._cacheCanvas==null)return;const e=this._cacheCanvas.getContext();e.save(),n.save(),n.setTransform(1,0,0,1,0,0),e.setTransform(1,0,0,1,0,0),n.drawImage(this._cacheCanvas.getCanvasEle(),0,0),n.restore(),e.restore()}_initialCacheCanvas(){if(this._cacheCanvas!=null)return;const n=this.getScene();if(n==null)return;this._cacheCanvas=new b.Canvas;const e=n.getEngine();this._cacheCanvas.setSize(e.width,e.height),e.onTransformChange$.subscribeEvent(()=>{var r;(r=this._cacheCanvas)==null||r.setSize(e.width,e.height),this.makeDirty(!0)})}}var Un=Object.defineProperty,An=Object.getOwnPropertyDescriptor,Ln=(a,t,n,e)=>{for(var r=e>1?void 0:e?An(t,n):t,s=a.length-1,i;s>=0;s--)(i=a[s])&&(r=(e?i(t,n,r):i(r))||r);return e&&r&&Un(t,n,r),r},oe=(a,t)=>(n,e)=>t(n,e,a);let ye=class extends d.Disposable{constructor(t,n,e,r,s,i){super();q(this,"_sceneListenerOnImageMap",new WeakSet);this._commandService=t,this._drawingManagerService=n,this._renderManagerService=e,this._univerInstanceService=r,this._messageService=s,this._localeService=i,this._init()}_init(){this._initOpenCrop(),this._initCloseCrop(),this._initAutoCrop()}_initAutoCrop(){this.disposeWithMe(this._commandService.onCommandExecuted(t=>{if(t.id!==ge.id)return;const n=t.params;if(n==null)return;const{cropType:e}=n,r=this._drawingManagerService.getFocusDrawings();if(r.length!==1)return;const s=r[0],{unitId:i,subUnitId:o,drawingId:c}=s,u=this._renderManagerService.getRenderById(i),m=u==null?void 0:u.scene;if(m==null)return!0;this._searchCropObject(m)!=null&&this._commandService.syncExecuteCommand(ee.id,{isAuto:!0});const f=j.getDrawingShapeKeyByDrawingSearch({unitId:i,subUnitId:o,drawingId:c}),p=m.getObject(f);if(!(p instanceof b.Image)){this._messageService.show({type:k.MessageType.Error,content:this._localeService.t("image-cropper.error")});return}p!=null&&(this._updateCropperObject(e,p),this._commandService.executeCommand(Se.id,{unitId:i,subUnitId:o,drawingId:c}))}))}_calculateSrcRectByRatio(t,n,e,r,s,i){const o=e/r,c=s/i;let u=e,m=r;o>c?u=r*c:m=e/c;const h=(e-u)/2,f=(r-m)/2;return{left:b.precisionTo(h,1),top:b.precisionTo(f,1),right:b.precisionTo(e-(h+u),1),bottom:b.precisionTo(r-(f+m),1)}}_updateCropperObject(t,n){const{left:e,top:r,width:s,height:i}=n.calculateTransformWithSrcRect();let o;switch(t){case H.R1_1:o=this._calculateSrcRectByRatio(e,r,s,i,1,1);break;case H.R16_9:o=this._calculateSrcRectByRatio(e,r,s,i,16,9);break;case H.R9_16:o=this._calculateSrcRectByRatio(e,r,s,i,9,16);break;case H.R5_4:o=this._calculateSrcRectByRatio(e,r,s,i,5,4);break;case H.R4_5:o=this._calculateSrcRectByRatio(e,r,s,i,4,5);break;case H.R4_3:o=this._calculateSrcRectByRatio(e,r,s,i,4,3);break;case H.R3_4:o=this._calculateSrcRectByRatio(e,r,s,i,3,4);break;case H.R3_2:o=this._calculateSrcRectByRatio(e,r,s,i,3,2);break;case H.R2_3:o=this._calculateSrcRectByRatio(e,r,s,i,2,3);break;case H.FREE:}if(o==null)return;n.setSrcRect(o);const{left:c=0,top:u=0,bottom:m=0,right:h=0}=o;n.transformByStateCloseCropper({left:e+c,top:r+u,width:s-h-c,height:i-m-u})}_initOpenCrop(){this.disposeWithMe(this._commandService.onCommandExecuted(t=>{if(t.id!==Se.id)return;const n=t.params;if(n==null)return;const{unitId:e,subUnitId:r,drawingId:s}=n,i=this._renderManagerService.getRenderById(e),o=i==null?void 0:i.scene;if(o==null)return!0;if(this._sceneListenerOnImageMap.has(o)||(this._addListenerOnImage(o),this._sceneListenerOnImageMap.add(o)),this._drawingManagerService.getDrawingByParam({unitId:e,subUnitId:r,drawingId:s})==null)return;const u=j.getDrawingShapeKeyByDrawingSearch({unitId:e,subUnitId:r,drawingId:s}),m=o.getObject(u);if(m==null)return;if(!(m instanceof b.Image)){this._messageService.show({type:k.MessageType.Error,content:this._localeService.t("image-cropper.error")});return}const h=o.getTransformer();h==null||h.clearControls();const f=new he(`${u}-crop`,{srcRect:m.srcRect,prstGeom:m.prstGeom,applyTransform:m.calculateTransformWithSrcRect()});o.addObject(f,m.getLayerIndex()+1).attachTransformerTo(f),h==null||h.createControlForCopper(f),this._addHoverForImageCopper(f),m.openRenderByCropper(),h==null||h.refreshControls(),f.makeDirty(!0),this._commandService.syncExecuteCommand(j.SetDrawingSelectedOperation.id,[{unitId:e,subUnitId:r,drawingId:s}])}))}_searchCropObject(t){const n=t.getAllObjectsByOrder();for(const e of n)if(e instanceof he)return e}_initCloseCrop(){this.disposeWithMe(this._commandService.onCommandExecuted(n=>{if(n.id!==ee.id)return;const e=this._univerInstanceService.getFocusedUnit();if(e==null)return;const r=e.getUnitId(),s=this._renderManagerService.getRenderById(r),i=s==null?void 0:s.scene;if(i==null)return!0;const o=this._searchCropObject(i);if(o==null)return;const c=this._getApplyObjectByCropObject(o);if(c==null)return;const u=i.getTransformerByCreate();u.detachFrom(o),u.clearCopperControl();const m=this._getSrcRectByTransformState(c,o),h=this._drawingManagerService.getDrawingOKey(c.oKey);if(h!=null){const{left:f,top:p,height:_,width:v}=o;this._drawingManagerService.featurePluginUpdateNotification([{...h,transform:{...h.transform,left:f,top:p,height:_,width:v},srcRect:m.srcRectAngle}])}c.setSrcRect({...m.srcRectAngle}),c.closeRenderByCropper(),c.makeDirty(!0),o==null||o.dispose()}));const t=this._univerInstanceService.getCurrentTypeOfUnit$(d.UniverInstanceType.UNIVER_SHEET).pipe(xe.filter(n=>!!n),xe.switchMap(n=>n.activeSheet$));this.disposeWithMe(t.subscribe(()=>{this._commandService.syncExecuteCommand(ee.id)}))}_getApplyObjectByCropObject(t){const n=t.oKey,e=n.slice(0,n.length-5),r=t.getScene();if(!r)return null;const s=r.getObject(e);return s==null?null:s}_addListenerOnImage(t){const n=t.getTransformerByCreate();let e=null;this.disposeWithMe(n.changeStart$.subscribe(r=>{const{objects:s}=r,i=s.values().next().value;if(i==null||!(i instanceof he))return;const{left:o,top:c,height:u,width:m,angle:h}=i;e={left:o,top:c,height:u,width:m,angle:h},n.clearCopperControl()})),this.disposeWithMe(n.changeEnd$.subscribe(r=>{const{objects:s}=r,i=s.values().next().value;if(i==null||!(i instanceof he))return;const{left:o,top:c,height:u,width:m,angle:h}=i;if(!d.checkIfMove({left:o,top:c,height:u,width:m,angle:h},e))return;const f=this._getApplyObjectByCropObject(i);if(f==null)return;const p=this._getSrcRectByTransformState(f,i);i.refreshSrcRect(p.srcRect,f.getState()),n.createControlForCopper(i)})),this._endCropListener(t)}_addHoverForImageCopper(t){this.disposeWithMe(t.onPointerEnter$.subscribeEvent(()=>{t.cursor=b.CURSOR_TYPE.MOVE})),this.disposeWithMe(t.onPointerLeave$.subscribeEvent(()=>{t.cursor=b.CURSOR_TYPE.DEFAULT}))}_endCropListener(t){const n=t.getTransformerByCreate();this.disposeWithMe(n.clearControl$.subscribe(e=>{e===!0&&this._commandService.syncExecuteCommand(ee.id)}))}_getSrcRectByTransformState(t,n){const{left:e,top:r,height:s,width:i,strokeWidth:o,angle:c}=n,{left:u,top:m,width:h,height:f,angle:p,strokeWidth:_}=t,v=e-u,C=r-m,P={left:v,top:C,right:h-v-i,bottom:f-C-s},I={...P};if(p!==0){const E=e+i/2,R=r+s/2,U=new b.Vector2(E,R),M=h/2+u,D=f/2+m,O=new b.Vector2(M,D),T=new b.Vector2(u,m);T.rotateByPoint(b.degToRad(p),O);const A=T.clone();A.rotateByPoint(b.degToRad(-p),U);const V=e-A.x,L=r-A.y;I.left=V,I.top=L,I.right=h-V-i,I.bottom=f-L-s}return{srcRect:P,srcRectAngle:I}}};ye=Ln([oe(0,d.ICommandService),oe(1,j.IDrawingManagerService),oe(2,b.IRenderManagerService),oe(3,d.IUniverInstanceService),oe(4,Ce.IMessageService),oe(5,d.Inject(d.LocaleService))],ye);var Hn=Object.defineProperty,Gn=Object.getOwnPropertyDescriptor,Vn=(a,t,n,e)=>{for(var r=e>1?void 0:e?Gn(t,n):t,s=a.length-1,i;s>=0;s--)(i=a[s])&&(r=(e?i(t,n,r):i(r))||r);return e&&r&&Hn(t,n,r),r},te=(a,t)=>(n,e)=>t(n,e,a);let Pe=class extends d.Disposable{constructor(a,t,n,e,r,s,i){super(),this._commandService=a,this._renderManagerService=t,this._drawingManagerService=n,this._dialogService=e,this._imageIoService=r,this._currentUniverService=s,this._drawingRenderService=i,this._initialize()}dispose(){super.dispose()}_initialize(){this._drawingAddListener(),this._commandExecutedListener(),this._imageUpdateListener()}_commandExecutedListener(){this.disposeWithMe(this._commandService.onCommandExecuted(a=>{if(a.id===De.id){const t=a.params;if(t==null)return;this._resetImageSize(t)}}))}_getSceneAndTransformerByDrawingSearch(a){if(a==null)return;const t=this._renderManagerService.getRenderById(a),n=t==null?void 0:t.scene;if(n==null)return null;const e=n.getTransformerByCreate();return{scene:n,transformer:e}}_resetImageSize(a){const t=[],n=[];a.forEach(e=>{const{unitId:r,subUnitId:s,drawingId:i}=e,o=this._getSceneAndTransformerByDrawingSearch(r);if(o==null)return;const{scene:c}=o,u=j.getDrawingShapeKeyByDrawingSearch({unitId:r,subUnitId:s,drawingId:i}),m=c.getObject(u);if(m==null)return!0;const h=this._drawingManagerService.getDrawingByParam(e);if(h==null)return!0;if(h.drawingType!==d.DrawingTypeEnum.DRAWING_IMAGE)return;m.resetSize();const{width:f,height:p}=m.getNativeSize();n.includes(c)===!1&&n.push(c),t.push({...h,transform:{...h.transform,height:p,width:f,angle:0},srcRect:null,prstGeom:null})}),this._drawingManagerService.featurePluginUpdateNotification(t),n.forEach(e=>{e.getTransformerByCreate().refreshControls().changeNotification()}),this._commandService.syncExecuteCommand(j.SetDrawingSelectedOperation.id,a)}_drawingAddListener(){this.disposeWithMe(this._drawingManagerService.add$.subscribe(a=>{this._insertImages(a)}))}_insertImages(a){a.forEach(async t=>{var u;const{unitId:n,subUnitId:e,drawingId:r}=t,s=this._getSceneAndTransformerByDrawingSearch(n),i=(u=Ne(this._currentUniverService,n))==null?void 0:u.subUnitId;if(s==null||i!==e)return;const o=this._drawingManagerService.getDrawingByParam(t);if(o==null)return;const c=await this._drawingRenderService.renderImages(o,s.scene);if(!(c==null||c.length===0))for(const m of c)this._addHoverForImage(m),this._addDialogForImage(m)})}_imageUpdateListener(){this.disposeWithMe(this._drawingManagerService.update$.subscribe(a=>{a.forEach(t=>{const{unitId:n,subUnitId:e,drawingId:r}=t,s=this._drawingManagerService.getDrawingByParam(t);if(s==null)return;const{transform:i,drawingType:o,srcRect:c,prstGeom:u,source:m,imageSourceType:h}=s;if(o!==d.DrawingTypeEnum.DRAWING_IMAGE)return;const f=this._getSceneAndTransformerByDrawingSearch(n);if(f==null)return;const{scene:p,transformer:_}=f;if(i==null)return!0;const v=j.getDrawingShapeKeyByDrawingSearch({unitId:n,subUnitId:e,drawingId:r}),C=p.getObject(v);if(C==null)return!0;C.setSrcRect(c),C.setPrstGeom(u)})}))}_addHoverForImage(a){this.disposeWithMe(d.toDisposable(a.onPointerEnter$.subscribeEvent(()=>{a.cursor=b.CURSOR_TYPE.GRAB}))),this.disposeWithMe(d.toDisposable(a.onPointerLeave$.subscribeEvent(()=>{a.cursor=b.CURSOR_TYPE.DEFAULT})))}_addDialogForImage(a){this.disposeWithMe(d.toDisposable(a.onDblclick$.subscribeEvent(()=>{const t=`${a.oKey}-viewer-dialog`;this._drawingRenderService.previewImage(t,a.getNative().src,a.getNativeSize().width,a.getNativeSize().height)})))}};Pe=Vn([te(0,d.ICommandService),te(1,b.IRenderManagerService),te(2,j.IDrawingManagerService),te(3,Ce.IDialogService),te(4,j.IImageIoService),te(5,d.IUniverInstanceService),te(6,d.Inject(y.DrawingRenderService))],Pe);var Wn=Object.defineProperty,kn=Object.getOwnPropertyDescriptor,zn=(a,t,n,e)=>{for(var r=e>1?void 0:e?kn(t,n):t,s=a.length-1,i;s>=0;s--)(i=a[s])&&(r=(e?i(t,n,r):i(r))||r);return e&&r&&Wn(t,n,r),r},$e=(a,t)=>(n,e)=>t(n,e,a);const Kn="UNIVER_DRAWING_UI_PLUGIN";y.UniverDrawingUIPlugin=(Me=class extends d.Plugin{constructor(t=Je,n,e){super(),this._config=t,this._injector=n,this._configService=e;const{menu:r,...s}=d.merge({},Je,this._config);r&&this._configService.setConfig("menu",r,{merge:!0}),this._configService.setConfig(Dn,s)}onStarting(){this._initDependencies()}onRendered(){this._injector.get(be),this._injector.get(_e),this._injector.get(ye),this._injector.get(Pe)}_initDependencies(){[[y.DrawingRenderService],[be],[_e],[ye],[Pe]].forEach(n=>this._injector.add(n))}},q(Me,"pluginName",Kn),Me),y.UniverDrawingUIPlugin=zn([$e(1,d.Inject(d.Injector)),$e(2,d.IConfigService)],y.UniverDrawingUIPlugin),y.AutoImageCropOperation=ge,y.COMPONENT_IMAGE_POPUP_MENU=Xe,y.CloseImageCropOperation=ee,y.DrawingCommonPanel=Rn,y.ImageCropperObject=he,y.ImagePopupMenu=Ze,y.ImageResetSizeOperation=De,y.OpenImageCropOperation=Se,y.SetDrawingAlignOperation=we,y.getUpdateParams=me,Object.defineProperty(y,Symbol.toStringTag,{value:"Module"})});


// @univerjs/sheets-drawing/index
(function(a,s){typeof exports=="object"&&typeof module<"u"?s(exports,require("@univerjs/core"),require("@univerjs/drawing")):typeof define=="function"&&define.amd?define(["exports","@univerjs/core","@univerjs/drawing"],s):(a=typeof globalThis<"u"?globalThis:a||self,s(a.UniverSheetsDrawing={},a.UniverCore,a.UniverDrawing))})(this,function(a,s,u){"use strict";const l="sheets-drawing.config",f={};var d=(e=>(e.Position="0",e.Both="1",e.None="2",e))(d||{});class m extends u.UnitDrawingService{}const v=s.createIdentifier("sheets-drawing.sheet-drawing.service");var U=(e=>(e[e.INSERT=0]="INSERT",e[e.REMOVE=1]="REMOVE",e[e.UPDATE=2]="UPDATE",e[e.ARRANGE=3]="ARRANGE",e[e.GROUP=4]="GROUP",e[e.UNGROUP=5]="UNGROUP",e))(U||{});const D={id:"sheet.mutation.set-drawing-apply",type:s.CommandType.MUTATION,handler:(e,n)=>{const i=e.get(u.IDrawingManagerService),r=e.get(v),{op:t,unitId:o,subUnitId:c,type:M,objects:g}=n;switch(i.applyJson1(o,c,t),r.applyJson1(o,c,t),M){case 0:i.addNotification(g),r.addNotification(g);break;case 1:i.removeNotification(g),r.removeNotification(g);break;case 2:i.updateNotification(g),r.updateNotification(g);break;case 3:i.orderNotification(g),r.orderNotification(g);break;case 4:i.groupUpdateNotification(g);break;case 5:i.ungroupUpdateNotification(g);break}return!0}};var E=Object.defineProperty,I=Object.getOwnPropertyDescriptor,O=(e,n,i,r)=>{for(var t=r>1?void 0:r?I(n,i):n,o=e.length-1,c;o>=0;o--)(c=e[o])&&(t=(r?c(n,i,t):c(t))||t);return r&&t&&E(n,i,t),t},h=(e,n)=>(i,r)=>n(i,r,e);const _="SHEET_DRAWING_PLUGIN";let S=class extends s.Disposable{constructor(e,n,i,r){super(),this._commandService=e,this._sheetDrawingService=n,this._drawingManagerService=i,this._resourceManagerService=r,this._initSnapshot(),this.disposeWithMe(this._commandService.registerCommand(D))}_initSnapshot(){const e=(i,r)=>{const t=r||this._sheetDrawingService.getDrawingDataForUnit(i);return t?JSON.stringify(t):""},n=i=>{if(!i)return{};try{return JSON.parse(i)}catch{return{}}};this.disposeWithMe(this._resourceManagerService.registerPluginResource({pluginName:_,businesses:[s.UniverInstanceType.UNIVER_SHEET],toJson:(i,r)=>e(i,r),parseJson:i=>n(i),onUnLoad:i=>{this._sheetDrawingService.removeDrawingDataForUnit(i),this._drawingManagerService.removeDrawingDataForUnit(i)},onLoad:(i,r)=>{this._sheetDrawingService.registerDrawingData(i,r),this._drawingManagerService.registerDrawingData(i,r)}}))}};S=O([h(0,s.ICommandService),h(1,v),h(2,u.IDrawingManagerService),h(3,s.IResourceManagerService)],S);var N=Object.defineProperty,R=Object.getOwnPropertyDescriptor,b=(e,n,i)=>n in e?N(e,n,{enumerable:!0,configurable:!0,writable:!0,value:i}):e[n]=i,p=(e,n,i,r)=>{for(var t=r>1?void 0:r?R(n,i):n,o=e.length-1,c;o>=0;o--)(c=e[o])&&(t=(r?c(n,i,t):c(t))||t);return r&&t&&N(n,i,t),t},P=(e,n)=>(i,r)=>n(i,r,e),w=(e,n,i)=>b(e,typeof n!="symbol"?n+"":n,i);a.UniverSheetsDrawingPlugin=class extends s.Plugin{constructor(n=f,i,r){super(),this._config=n,this._injector=i,this._configService=r;const{...t}=s.merge({},f,this._config);this._configService.setConfig(l,t)}onStarting(){[[S],[v,{useClass:m}]].forEach(n=>this._injector.add(n)),this._injector.get(S)}},w(a.UniverSheetsDrawingPlugin,"pluginName",_),w(a.UniverSheetsDrawingPlugin,"type",s.UniverInstanceType.UNIVER_SHEET),a.UniverSheetsDrawingPlugin=p([s.DependentOn(u.UniverDrawingPlugin),P(1,s.Inject(s.Injector)),P(2,s.IConfigService)],a.UniverSheetsDrawingPlugin),a.DrawingApplyType=U,a.ISheetDrawingService=v,a.SHEET_DRAWING_PLUGIN=_,a.SetDrawingApplyMutation=D,a.SheetDrawingAnchorType=d,Object.defineProperty(a,Symbol.toStringTag,{value:"Module"})});


// @univerjs/sheets-drawing-ui/index
(function(b,d){typeof exports=="object"&&typeof module<"u"?d(exports,require("@univerjs/core"),require("@univerjs/docs-drawing"),require("@univerjs/drawing"),require("@univerjs/drawing-ui"),require("@univerjs/engine-render"),require("@univerjs/sheets-drawing"),require("@univerjs/sheets-ui"),require("@univerjs/ui"),require("rxjs"),require("@univerjs/sheets"),require("react"),require("@univerjs/docs-ui"),require("@univerjs/design")):typeof define=="function"&&define.amd?define(["exports","@univerjs/core","@univerjs/docs-drawing","@univerjs/drawing","@univerjs/drawing-ui","@univerjs/engine-render","@univerjs/sheets-drawing","@univerjs/sheets-ui","@univerjs/ui","rxjs","@univerjs/sheets","react","@univerjs/docs-ui","@univerjs/design"],d):(b=typeof globalThis<"u"?globalThis:b||self,d(b.UniverSheetsDrawingUi={},b.UniverCore,b.UniverDocsDrawing,b.UniverDrawing,b.UniverDrawingUi,b.UniverEngineRender,b.UniverSheetsDrawing,b.UniverSheetsUi,b.UniverUi,b.rxjs,b.UniverSheets,b.React,b.UniverDocsUi,b.UniverDesign))})(this,function(b,d,Se,O,ue,N,f,P,Y,j,w,Q,Rt,ne){"use strict";var er=Object.defineProperty;var tr=(b,d,Se)=>d in b?er(b,d,{enumerable:!0,configurable:!0,writable:!0,value:Se}):b[d]=Se;var q=(b,d,Se)=>tr(b,typeof d!="symbol"?d+"":d,Se);const Ft="sheets-drawing-ui.config",bt={},$={id:"sheet.operation.clear-drawing-transformer",type:d.CommandType.MUTATION,handler:(i,r)=>{const n=i.get(N.IRenderManagerService);return r.forEach(e=>{var t,o;(o=(t=n.getRenderById(e))==null?void 0:t.scene.getTransformer())==null||o.debounceRefreshControls()}),!0}},Oe={id:"sheet.command.remove-sheet-image",type:d.CommandType.COMMAND,handler:(i,r)=>{var C,D,R;const n=i.get(d.ICommandService),e=i.get(d.IUndoRedoService),t=i.get(w.SheetInterceptorService),o=i.get(f.ISheetDrawingService);if(!r)return!1;const{drawings:a}=r,s=[];a.forEach(y=>{const{unitId:T}=y;s.push(T)});const l=o.getBatchRemoveOp(a),{unitId:h,subUnitId:u,undo:c,redo:g,objects:m}=l,p=t.onCommandExecute({id:Oe.id,params:r}),_={id:f.SetDrawingApplyMutation.id,params:{unitId:h,subUnitId:u,op:g,objects:m,type:f.DrawingApplyType.REMOVE}},S={id:f.SetDrawingApplyMutation.id,params:{unitId:h,subUnitId:u,op:c,objects:m,type:f.DrawingApplyType.INSERT}};return d.sequenceExecute([...(C=p.preRedos)!=null?C:[],_,...p.redos],n)?(e.pushUndoRedo({unitID:h,undoMutations:[...(D=p.preUndos)!=null?D:[],S,...p.undos,{id:$.id,params:s}],redoMutations:[...(R=p.preRedos)!=null?R:[],_,...p.redos,{id:$.id,params:s}]}),!0):!1}},Et="COMPONENT_SHEET_DRAWING_PANEL",st={id:"sidebar.operation.sheet-image",type:d.CommandType.COMMAND,handler:async(i,r)=>{const n=i.get(Y.ISidebarService),e=i.get(d.LocaleService),t=i.get(d.IUniverInstanceService),o=i.get(d.ICommandService);if(!w.getSheetCommandTarget(t))return!1;switch(r.value){case"open":n.open({header:{title:e.t("sheetImage.panel.title")},children:{label:Et},onClose:()=>{o.syncExecuteCommand(O.SetDrawingSelectedOperation.id,[])},width:360});break;case"close":default:n.close();break}return!0}},ct={id:"sheet.operation.edit-sheet-image",type:d.CommandType.OPERATION,handler:(i,r)=>{const n=i.get(d.ICommandService);return r==null?!1:(n.syncExecuteCommand(O.SetDrawingSelectedOperation.id,[r]),n.executeCommand(st.id,{value:"open"}),!0)}};var dt={exports:{}},Pe={};/**
 * @license React
 * react-jsx-runtime.production.min.js
 *
 * Copyright (c) Facebook, Inc. and its affiliates.
 *
 * This source code is licensed under the MIT license found in the
 * LICENSE file in the root directory of this source tree.
 */var Ot;function $t(){if(Ot)return Pe;Ot=1;var i=Q,r=Symbol.for("react.element"),n=Symbol.for("react.fragment"),e=Object.prototype.hasOwnProperty,t=i.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED.ReactCurrentOwner,o={key:!0,ref:!0,__self:!0,__source:!0};function a(s,l,h){var u,c={},g=null,m=null;h!==void 0&&(g=""+h),l.key!==void 0&&(g=""+l.key),l.ref!==void 0&&(m=l.ref);for(u in l)e.call(l,u)&&!o.hasOwnProperty(u)&&(c[u]=l[u]);if(s&&s.defaultProps)for(u in l=s.defaultProps,l)c[u]===void 0&&(c[u]=l[u]);return{$$typeof:r,type:s,key:g,ref:m,props:c,_owner:t.current}}return Pe.Fragment=n,Pe.jsx=a,Pe.jsxs=a,Pe}var Pt;function Ht(){return Pt||(Pt=1,dt.exports=$t()),dt.exports}var K=Ht();const He={uploadLoading:"univer-upload-loading",uploadLoadingBody:"univer-upload-loading-body",uploadLoadingBodyAnimation:"univer-upload-loading-body-animation",univerCircleAnimation:"univer-UniverCircleAnimation",uploadLoadingBodyText:"univer-upload-loading-body-text"},Yt=()=>{const i=d.useDependency(O.IImageIoService),r=d.useDependency(d.LocaleService),[n,e]=Q.useState(0);return Q.useEffect(()=>{const t=i.change$.subscribe(o=>{e(o)});return()=>{t.unsubscribe()}},[i]),K.jsx("div",{style:{display:n>0?"block":"none"},className:He.uploadLoading,children:K.jsxs("div",{className:He.uploadLoadingBody,children:[K.jsx("div",{className:He.uploadLoadingBodyAnimation}),K.jsx("div",{className:He.uploadLoadingBodyText,children:`${r.t("uploadLoading.loading")}: ${n}`})]})})};var Vt=Object.defineProperty,xt=Object.getOwnPropertyDescriptor,Xt=(i,r,n,e)=>{for(var t=e>1?void 0:e?xt(r,n):r,o=i.length-1,a;o>=0;o--)(a=i[o])&&(t=(e?a(r,n,t):a(t))||t);return e&&t&&Vt(r,n,t),t},me=(i,r)=>(n,e)=>r(n,e,i);let Ye=class extends d.RxDisposable{constructor(r,n,e,t,o,a,s,l){super();q(this,"_initImagePopupMenu",new Set);this._injector=r,this._drawingManagerService=n,this._canvasPopManagerService=e,this._renderManagerService=t,this._univerInstanceService=o,this._contextService=a,this._uiPartsService=s,this._commandService=l,this._init()}_init(){this._univerInstanceService.getCurrentTypeOfUnit$(d.UniverInstanceType.UNIVER_SHEET).pipe(j.takeUntil(this.dispose$)).subscribe(r=>this._create(r)),this._univerInstanceService.getTypeOfUnitDisposed$(d.UniverInstanceType.UNIVER_SHEET).pipe(j.takeUntil(this.dispose$)).subscribe(r=>this._dispose(r)),this._univerInstanceService.getAllUnitsForType(d.UniverInstanceType.UNIVER_SHEET).forEach(r=>this._create(r)),this._uiPartsService.registerComponent(Y.BuiltInUIPart.CONTENT,()=>d.connectInjector(Yt,this._injector))}_dispose(r){const n=r.getUnitId();this._renderManagerService.removeRender(n)}_create(r){if(!r)return;const n=r.getUnitId();this._renderManagerService.has(n)&&!this._initImagePopupMenu.has(n)&&(this._popupMenuListener(n),this._initImagePopupMenu.add(n))}_hasCropObject(r){const n=r.getAllObjectsByOrder();for(const e of n)if(e instanceof ue.ImageCropperObject)return!0;return!1}_popupMenuListener(r){var o;const n=(o=this._renderManagerService.getRenderById(r))==null?void 0:o.scene;if(!n)return;const e=n.getTransformerByCreate();if(!e)return;let t;this.disposeWithMe(d.toDisposable(e.createControl$.subscribe(()=>{if(this._contextService.setContextValue(d.FOCUSING_COMMON_DRAWINGS,!0),this._hasCropObject(n))return;const a=e.getSelectedObjectMap();if(a.size>1){t==null||t.dispose();return}const s=a.values().next().value;if(!s)return;const l=s.oKey,h=this._drawingManagerService.getDrawingOKey(l);if(!h)return;const{unitId:u,subUnitId:c,drawingId:g,drawingType:m}=h,p=h.data;if(p&&p.disablePopup)return;t==null||t.dispose();const _=this._canvasPopManagerService.getFeatureMenu(u,c,g,m);t=this.disposeWithMe(this._canvasPopManagerService.attachPopupToObject(s,{componentKey:ue.COMPONENT_IMAGE_POPUP_MENU,direction:"horizontal",offset:[2,0],extraProps:{menuItems:_||this._getImageMenuItems(u,c,g,m)}}))}))),this.disposeWithMe(e.clearControl$.subscribe(()=>{t==null||t.dispose(),this._contextService.setContextValue(d.FOCUSING_COMMON_DRAWINGS,!1),this._commandService.syncExecuteCommand(O.SetDrawingSelectedOperation.id,[])})),this.disposeWithMe(this._contextService.contextChanged$.subscribe(a=>{a[d.FOCUSING_COMMON_DRAWINGS]===!1&&(t==null||t.dispose())})),this.disposeWithMe(e.changing$.subscribe(()=>{t==null||t.dispose()}))}_getImageMenuItems(r,n,e,t){return[{label:"image-popup.edit",index:0,commandId:ct.id,commandParams:{unitId:r,subUnitId:n,drawingId:e},disable:t===d.DrawingTypeEnum.DRAWING_DOM},{label:"image-popup.delete",index:1,commandId:Oe.id,commandParams:{unitId:r,drawings:[{unitId:r,subUnitId:n,drawingId:e}]},disable:!1},{label:"image-popup.crop",index:2,commandId:ue.OpenImageCropOperation.id,commandParams:{unitId:r,subUnitId:n,drawingId:e},disable:t===d.DrawingTypeEnum.DRAWING_DOM},{label:"image-popup.reset",index:3,commandId:ue.ImageResetSizeOperation.id,commandParams:[{unitId:r,subUnitId:n,drawingId:e}],disable:t===d.DrawingTypeEnum.DRAWING_DOM}]}};Ye=Xt([me(0,d.Inject(d.Injector)),me(1,O.IDrawingManagerService),me(2,d.Inject(P.SheetCanvasPopManagerService)),me(3,N.IRenderManagerService),me(4,d.IUniverInstanceService),me(5,d.IContextService),me(6,d.Inject(Y.IUIPartsService)),me(7,d.ICommandService)],Ye);function z(i,r,n){const{from:e,to:t,flipY:o=!1,flipX:a=!1,angle:s=0,skewX:l=0,skewY:h=0}=i,u=n.getCurrent();if(u==null)return;const c=P.convertPositionSheetOverGridToAbsolute(u.unitId,u.sheetId,{from:e,to:t},n);let{left:g,top:m,width:p,height:_}=c;const S=n.getCurrentSkeleton(),v=S.rowHeaderWidth+S.columnTotalWidth,C=S.columnHeaderHeight+S.rowTotalHeight;return g+p>v&&(g=v-p),m+_>C&&(m=C-_),{flipY:o,flipX:a,angle:s,skewX:l,skewY:h,left:g,top:m,width:p,height:_}}function V(i,r){const{left:n=0,top:e=0,width:t=0,height:o=0,flipY:a=!1,flipX:s=!1,angle:l=0,skewX:h=0,skewY:u=0}=i,c=r.getCellWithCoordByOffset(n,e);if(c==null)return;const g={column:c.actualColumn,columnOffset:N.precisionTo(n-c.startX,1),row:c.actualRow,rowOffset:N.precisionTo(e-c.startY,1)},m=r.getCellWithCoordByOffset(n+t,e+o);if(m==null)return;const p={column:m.actualColumn,columnOffset:N.precisionTo(n+t-m.startX,1),row:m.actualRow,rowOffset:N.precisionTo(e+o-m.startY,1)};return{flipY:a,flipX:s,angle:l,skewX:h,skewY:u,from:g,to:p}}var Kt=Object.defineProperty,zt=Object.getOwnPropertyDescriptor,Jt=(i,r,n,e)=>{for(var t=e>1?void 0:e?zt(r,n):r,o=i.length-1,a;o>=0;o--)(a=i[o])&&(t=(e?a(r,n,t):a(t))||t);return e&&t&&Kt(r,n,t),t},Ve=(i,r)=>(n,e)=>r(n,e,i);let lt=class extends d.Disposable{constructor(i,r,n,e,t){super(),this._context=i,this._sheetDrawingService=r,this._drawingManagerService=n,this._sheetSelectionRenderService=e,this._sheetSkeletonManagerService=t,this._init()}_init(){this._drawingInitializeListener()}_drawingInitializeListener(){this._sheetDrawingService.initializeNotification(this._context.unitId);const i=this._sheetDrawingService.getDrawingDataForUnit(this._context.unitId);for(const r in i){const n=i[r];for(const e in n.data){const t=n.data[e];t.transform=z(t.sheetTransform,this._sheetSelectionRenderService,this._sheetSkeletonManagerService)}}this._drawingManagerService.registerDrawingData(this._context.unitId,this._sheetDrawingService.getDrawingDataForUnit(this._context.unitId)),this._drawingManagerService.initializeNotification(this._context.unitId)}};lt=Jt([Ve(1,f.ISheetDrawingService),Ve(2,O.IDrawingManagerService),Ve(3,d.Inject(P.ISheetSelectionRenderService)),Ve(4,d.Inject(P.SheetSkeletonManagerService))],lt);function Zt(i){const r=[];return i.forEach(n=>{const{parent:e,children:t}=n,{unitId:o,subUnitId:a,drawingId:s}=e,l=N.getGroupState(0,0,t.map(c=>c.transform||{})),h=t.map(c=>{const g=c.transform||{left:0,top:0},{unitId:m,subUnitId:p,drawingId:_}=c;return{unitId:m,subUnitId:p,drawingId:_,transform:{...g,left:g.left-l.left,top:g.top-l.top},groupId:s}}),u={unitId:o,subUnitId:a,drawingId:s,drawingType:d.DrawingTypeEnum.DRAWING_GROUP,transform:l};r.push({parent:u,children:h})}),r}function qt(i){const r=[];return i.forEach(n=>{const{parent:e,children:t}=n,{unitId:o,subUnitId:a,drawingId:s,transform:l={width:0,height:0}}=e;if(l==null)return;const h=t.map(c=>{const{transform:g}=c,{unitId:m,subUnitId:p,drawingId:_}=c,S=N.transformObjectOutOfGroup(g||{},l,l.width||0,l.height||0);return{unitId:m,subUnitId:p,drawingId:_,transform:S,groupId:void 0}}),u={unitId:o,subUnitId:a,drawingId:s,drawingType:d.DrawingTypeEnum.DRAWING_GROUP,transform:{left:0,top:0}};r.push({parent:u,children:h})}),r}const ut={id:"sheet.command.group-sheet-image",type:d.CommandType.COMMAND,handler:(i,r)=>{const n=i.get(d.ICommandService),e=i.get(d.IUndoRedoService),t=i.get(f.ISheetDrawingService);if(!r)return!1;const o=[];r.forEach(({parent:m,children:p})=>{o.push(m.unitId),p.forEach(_=>{o.push(_.unitId)})});const a=t.getGroupDrawingOp(r),{unitId:s,subUnitId:l,undo:h,redo:u,objects:c}=a;return n.syncExecuteCommand(f.SetDrawingApplyMutation.id,{op:u,unitId:s,subUnitId:l,objects:c,type:f.DrawingApplyType.GROUP})?(e.pushUndoRedo({unitID:s,undoMutations:[{id:f.SetDrawingApplyMutation.id,params:{op:h,unitId:s,subUnitId:l,objects:qt(c),type:f.DrawingApplyType.UNGROUP}},{id:$.id,params:o}],redoMutations:[{id:f.SetDrawingApplyMutation.id,params:{op:u,unitId:s,subUnitId:l,objects:c,type:f.DrawingApplyType.GROUP}},{id:$.id,params:o}]}),!0):!1}},Ae={id:"sheet.command.insert-sheet-image",type:d.CommandType.COMMAND,handler:(i,r)=>{var C,D,R;const n=i.get(d.ICommandService),e=i.get(d.IUndoRedoService),t=i.get(f.ISheetDrawingService),o=i.get(w.SheetInterceptorService);if(!r)return!1;const a=r.drawings,s=a.map(y=>y.unitId),l=t.getBatchAddOp(a),{unitId:h,subUnitId:u,undo:c,redo:g,objects:m}=l,p=o.onCommandExecute({id:Ae.id,params:r}),_={id:f.SetDrawingApplyMutation.id,params:{op:g,unitId:h,subUnitId:u,objects:m,type:f.DrawingApplyType.INSERT}},S={id:f.SetDrawingApplyMutation.id,params:{op:c,unitId:h,subUnitId:u,objects:m,type:f.DrawingApplyType.REMOVE}};return d.sequenceExecute([...(C=p.preRedos)!=null?C:[],_,...p.redos],n)?(e.pushUndoRedo({unitID:h,undoMutations:[...(D=p.preUndos)!=null?D:[],S,...p.undos,{id:$.id,params:s}],redoMutations:[...(R=p.preRedos)!=null?R:[],_,...p.redos,{id:$.id,params:s}]}),!0):!1}},mt={id:"sheet.command.set-drawing-arrange",type:d.CommandType.COMMAND,handler:(i,r)=>{const n=i.get(d.ICommandService),e=i.get(d.IUndoRedoService);if(!r)return!1;const t=i.get(f.ISheetDrawingService),{unitId:o,subUnitId:a,drawingIds:s,arrangeType:l}=r,h={unitId:o,subUnitId:a,drawingIds:s};let u;if(l===d.ArrangeTypeEnum.forward?u=t.getForwardDrawingsOp(h):l===d.ArrangeTypeEnum.backward?u=t.getBackwardDrawingOp(h):l===d.ArrangeTypeEnum.front?u=t.getFrontDrawingsOp(h):l===d.ArrangeTypeEnum.back&&(u=t.getBackDrawingsOp(h)),u==null)return!1;const{objects:c,redo:g,undo:m}=u;return n.syncExecuteCommand(f.SetDrawingApplyMutation.id,{op:g,unitId:o,subUnitId:a,objects:c,type:f.DrawingApplyType.ARRANGE})?(e.pushUndoRedo({unitID:o,undoMutations:[{id:f.SetDrawingApplyMutation.id,params:{op:m,unitId:o,subUnitId:a,objects:c,type:f.DrawingApplyType.ARRANGE}}],redoMutations:[{id:f.SetDrawingApplyMutation.id,params:{op:g,unitId:o,subUnitId:a,objects:c,type:f.DrawingApplyType.ARRANGE}}]}),!0):!1}},Ue={id:"sheet.command.set-sheet-image",type:d.CommandType.COMMAND,handler:(i,r)=>{const n=i.get(d.ICommandService),e=i.get(d.IUndoRedoService),t=i.get(f.ISheetDrawingService);if(!r)return!1;const{drawings:o}=r,a=t.getBatchUpdateOp(o),{unitId:s,subUnitId:l,undo:h,redo:u,objects:c}=a;return n.syncExecuteCommand(f.SetDrawingApplyMutation.id,{unitId:s,subUnitId:l,op:u,objects:c,type:f.DrawingApplyType.UPDATE})?(e.pushUndoRedo({unitID:s,undoMutations:[{id:f.SetDrawingApplyMutation.id,params:{unitId:s,subUnitId:l,op:h,objects:c,type:f.DrawingApplyType.UPDATE}},{id:$.id,params:[s]}],redoMutations:[{id:f.SetDrawingApplyMutation.id,params:{unitId:s,subUnitId:l,op:u,objects:c,type:f.DrawingApplyType.UPDATE}},{id:$.id,params:[s]}]}),!0):!1}},gt={id:"sheet.command.ungroup-sheet-image",type:d.CommandType.COMMAND,handler:(i,r)=>{const n=i.get(d.ICommandService),e=i.get(d.IUndoRedoService),t=i.get(f.ISheetDrawingService);if(!r)return!1;const o=[];r.forEach(({parent:m,children:p})=>{o.push(m.unitId),p.forEach(_=>{o.push(_.unitId)})});const a=t.getUngroupDrawingOp(r),{unitId:s,subUnitId:l,undo:h,redo:u,objects:c}=a;return n.syncExecuteCommand(f.SetDrawingApplyMutation.id,{op:u,unitId:s,subUnitId:l,objects:c,type:f.DrawingApplyType.UNGROUP})?(e.pushUndoRedo({unitID:s,undoMutations:[{id:f.SetDrawingApplyMutation.id,params:{op:h,unitId:s,subUnitId:l,objects:Zt(c),type:f.DrawingApplyType.GROUP}},{id:$.id,params:o}],redoMutations:[{id:f.SetDrawingApplyMutation.id,params:{op:u,unitId:s,subUnitId:l,objects:c,type:f.DrawingApplyType.UNGROUP}},{id:$.id,params:o}]}),!0):!1}};var Qt=Object.defineProperty,en=Object.getOwnPropertyDescriptor,tn=(i,r,n,e)=>{for(var t=e>1?void 0:e?en(r,n):r,o=i.length-1,a;o>=0;o--)(a=i[o])&&(t=(e?a(r,n,t):a(t))||t);return e&&t&&Qt(r,n,t),t},ee=(i,r)=>(n,e)=>r(n,e,i);function nn(i,r,n){const e=n*Math.PI/180,t=Math.abs(i*Math.cos(e))+Math.abs(r*Math.sin(e)),o=Math.abs(i*Math.sin(e))+Math.abs(r*Math.cos(e));return{rotatedWidth:t,rotatedHeight:o}}function At(i,r,n,e,t){var C;const{rotatedHeight:o,rotatedWidth:a}=nn(n,e,t),l=i.get(N.IRenderManagerService).getRenderById(r.unitId);if(!l)return!1;const u=(C=l.with(P.SheetSkeletonManagerService).getWorksheetSkeleton(r.subUnitId))==null?void 0:C.skeleton;if(u==null)return!1;const c=u.getCellByIndex(r.row,r.col),g=c.mergeInfo.endX-c.mergeInfo.startX-2,m=c.mergeInfo.endY-c.mergeInfo.startY-2,p=a/o,S=Math.ceil(Math.min(g,m*p))/a,v=!S||Number.isNaN(S)?.001:S;return{width:n*v,height:e*v}}let Ne=class extends d.Disposable{constructor(r,n,e,t,o,a,s,l,h,u,c,g,m){super();q(this,"_workbookSelections");this._context=r,this._skeletonManagerService=n,this._commandService=e,this._selectionRenderService=t,this._imageIoService=o,this._fileOpenerService=a,this._sheetDrawingService=s,this._drawingManagerService=l,this._contextService=h,this._messageService=u,this._localeService=c,this._injector=m,this._workbookSelections=g.getWorkbookSelections(this._context.unitId),this._updateImageListener(),this._updateOrderListener(),this._groupDrawingListener(),this._focusDrawingListener()}async insertFloatImage(){const r=await this._fileOpenerService.openFile({multiple:!0,accept:O.DRAWING_IMAGE_ALLOW_IMAGE_LIST.map(e=>`.${e.replace("image/","")}`).join(",")}),n=r.length;return n>O.DRAWING_IMAGE_COUNT_LIMIT?(this._messageService.show({type:ne.MessageType.Error,content:this._localeService.t("update-status.exceedMaxCount",String(O.DRAWING_IMAGE_COUNT_LIMIT))}),!1):n===0?!1:(r.forEach(async e=>await this._insertFloatImage(e)),!0)}async insertCellImage(){const n=(await this._fileOpenerService.openFile({multiple:!1,accept:O.DRAWING_IMAGE_ALLOW_IMAGE_LIST.map(e=>`.${e.replace("image/","")}`).join(",")}))[0];return n?(await this._insertCellImage(n),!0):!1}async _insertFloatImage(r){let n;try{n=await this._imageIoService.saveImage(r)}catch(C){const D=C.message;D===O.ImageUploadStatusType.ERROR_EXCEED_SIZE?this._messageService.show({type:ne.MessageType.Error,content:this._localeService.t("update-status.exceedMaxSize",String(O.DRAWING_IMAGE_ALLOW_SIZE/(1024*1024)))}):D===O.ImageUploadStatusType.ERROR_IMAGE_TYPE?this._messageService.show({type:ne.MessageType.Error,content:this._localeService.t("update-status.invalidImageType")}):D===O.ImageUploadStatusType.ERROR_IMAGE&&this._messageService.show({type:ne.MessageType.Error,content:this._localeService.t("update-status.invalidImage")})}if(n==null)return;const e=this._getUnitInfo(),{unitId:t,subUnitId:o}=e,{imageId:a,imageSourceType:s,source:l,base64Cache:h}=n,{width:u,height:c,image:g}=await O.getImageSize(h||""),{width:m,height:p}=this._context.scene;this._imageIoService.addImageSourceCache(l,s,g);let _=1;if(u>O.DRAWING_IMAGE_WIDTH_LIMIT||c>O.DRAWING_IMAGE_HEIGHT_LIMIT){const C=O.DRAWING_IMAGE_WIDTH_LIMIT/u,D=O.DRAWING_IMAGE_HEIGHT_LIMIT/c;_=Math.max(C,D)}const S=this._getImagePosition(u*_,c*_,m,p);if(S==null)return;const v={unitId:t,subUnitId:o,drawingId:a,drawingType:d.DrawingTypeEnum.DRAWING_IMAGE,imageSourceType:s,source:l,transform:z(S,this._selectionRenderService,this._skeletonManagerService),sheetTransform:S};this._commandService.executeCommand(Ae.id,{unitId:t,drawings:[v]})}async _insertCellImage(r){let n;try{n=await this._imageIoService.saveImage(r)}catch(S){const v=S.message;v===O.ImageUploadStatusType.ERROR_EXCEED_SIZE?this._messageService.show({type:ne.MessageType.Error,content:this._localeService.t("update-status.exceedMaxSize",String(O.DRAWING_IMAGE_ALLOW_SIZE/(1024*1024)))}):v===O.ImageUploadStatusType.ERROR_IMAGE_TYPE?this._messageService.show({type:ne.MessageType.Error,content:this._localeService.t("update-status.invalidImageType")}):v===O.ImageUploadStatusType.ERROR_IMAGE&&this._messageService.show({type:ne.MessageType.Error,content:this._localeService.t("update-status.invalidImage")})}if(n==null)return;const{imageId:e,imageSourceType:t,source:o,base64Cache:a}=n,{width:s,height:l,image:h}=await O.getImageSize(a||"");this._imageIoService.addImageSourceCache(o,t,h);const u=this._workbookSelections.getCurrentLastSelection();if(!u)return!1;const c=d.createDocumentModelWithStyle("",{}),g=At(this._injector,{unitId:this._context.unitId,subUnitId:this._context.unit.getActiveSheet().getSheetId(),row:u.primary.actualRow,col:u.primary.actualColumn},s,l,0);if(!g)return!1;const m={size:{width:g.width,height:g.height},positionH:{relativeFrom:d.ObjectRelativeFromH.PAGE,posOffset:0},positionV:{relativeFrom:d.ObjectRelativeFromV.PARAGRAPH,posOffset:0},angle:0},p={unitId:c.getUnitId(),subUnitId:c.getUnitId(),drawingId:e,drawingType:d.DrawingTypeEnum.DRAWING_IMAGE,imageSourceType:t,source:o,transform:Rt.docDrawingPositionToTransform(m),docTransform:m,behindDoc:d.BooleanNumber.FALSE,title:"",description:"",layoutType:d.PositionedObjectLayoutType.INLINE,wrapText:d.WrapTextType.BOTH_SIDES,distB:0,distL:0,distR:0,distT:0},_=d.BuildTextUtils.drawing.add({documentDataModel:c,drawings:[p],selection:{collapsed:!0,startOffset:0,endOffset:0}});return _?(c.apply(_),this._commandService.syncExecuteCommand(w.SetRangeValuesCommand.id,{value:{[u.primary.actualRow]:{[u.primary.actualColumn]:{p:c.getSnapshot(),t:1}}}})):!1}_getUnitInfo(){const r=this._context.unit,n=r.getActiveSheet(),e=r.getUnitId(),t=n.getSheetId();return{unitId:e,subUnitId:t}}_getImagePosition(r,n,e,t){const o=this._workbookSelections.getCurrentSelections();let a={startRow:0,endRow:0,startColumn:0,endColumn:0};o&&o.length>0&&(a=o[o.length-1].range);const s=P.attachRangeWithCoord(this._skeletonManagerService.getCurrent().skeleton,a);if(s==null)return;let{startColumn:l,startRow:h,startX:u,startY:c}=s,g=!1;if(u+r>e&&(u=e-r,u<0&&(u=0,r=e),g=!0),c+n>t&&(c=t-n,c<0&&(c=0,n=t),g=!0),g){const S=this._selectionRenderService.getCellWithCoordByOffset(u,c);if(S==null)return;u=S.startX,c=S.startY,l=S.actualColumn,h=S.actualRow}const m={column:l,columnOffset:0,row:h,rowOffset:0},p=this._selectionRenderService.getCellWithCoordByOffset(u+r,c+n);if(p==null)return;const _={column:p.actualColumn,columnOffset:u+r-p.startX,row:p.actualRow,rowOffset:c+n-p.startY};return{from:m,to:_}}_updateOrderListener(){this.disposeWithMe(this._drawingManagerService.featurePluginOrderUpdate$.subscribe(r=>{const{unitId:n,subUnitId:e,drawingIds:t,arrangeType:o}=r;this._commandService.executeCommand(mt.id,{unitId:n,subUnitId:e,drawingIds:t,arrangeType:o})}))}_updateImageListener(){this.disposeWithMe(this._drawingManagerService.featurePluginUpdate$.subscribe(r=>{const n=[];r.length!==0&&(r.forEach(e=>{const{unitId:t,subUnitId:o,drawingId:a,drawingType:s,transform:l}=e;if(l==null)return;const h=this._sheetDrawingService.getDrawingByParam({unitId:t,subUnitId:o,drawingId:a});if(h==null||h.unitId!==this._context.unitId)return;const u=V({...h.transform,...l},this._selectionRenderService);if(u==null)return;const c={...e,transform:{...h.transform,...l,...z(u,this._selectionRenderService,this._skeletonManagerService)},sheetTransform:{...u}};n.push(c)}),n.length>0&&this._commandService.executeCommand(Ue.id,{unitId:r[0].unitId,drawings:n}))}))}_groupDrawingListener(){this.disposeWithMe(this._drawingManagerService.featurePluginGroupUpdate$.subscribe(r=>{this._commandService.executeCommand(ut.id,r);const{unitId:n,subUnitId:e,drawingId:t}=r[0].parent;this._commandService.syncExecuteCommand(O.SetDrawingSelectedOperation.id,[{unitId:n,subUnitId:e,drawingId:t}])})),this.disposeWithMe(this._drawingManagerService.featurePluginUngroupUpdate$.subscribe(r=>{this._commandService.executeCommand(gt.id,r)}))}_focusDrawingListener(){this.disposeWithMe(this._drawingManagerService.focus$.subscribe(r=>{r==null||r.length===0?(this._contextService.setContextValue(d.FOCUSING_COMMON_DRAWINGS,!1),this._sheetDrawingService.focusDrawing([])):(this._contextService.setContextValue(d.FOCUSING_COMMON_DRAWINGS,!0),this._sheetDrawingService.focusDrawing(r))}))}};Ne=tn([ee(1,d.Inject(P.SheetSkeletonManagerService)),ee(2,d.ICommandService),ee(3,P.ISheetSelectionRenderService),ee(4,O.IImageIoService),ee(5,Y.ILocalFileService),ee(6,f.ISheetDrawingService),ee(7,O.IDrawingManagerService),ee(8,d.IContextService),ee(9,Y.IMessageService),ee(10,d.Inject(d.LocaleService)),ee(11,d.Inject(w.SheetsSelectionsService)),ee(12,d.Inject(d.Injector))],Ne);var rn=Object.defineProperty,on=Object.getOwnPropertyDescriptor,an=(i,r,n,e)=>{for(var t=e>1?void 0:e?on(r,n):r,o=i.length-1,a;o>=0;o--)(a=i[o])&&(t=(e?a(r,n,t):a(t))||t);return e&&t&&rn(r,n,t),t},_e=(i,r)=>(n,e)=>r(n,e,i);function ht(i,r,n){var e,t,o,a;if(((t=(e=n==null?void 0:n.p)==null?void 0:e.body)==null?void 0:t.dataStream.length)===3&&((a=(o=n.p)==null?void 0:o.drawingsOrder)==null?void 0:a.length)===1){const s=n.p.drawings[n.p.drawingsOrder[0]],l=At(i,{unitId:r.unitId,subUnitId:r.subUnitId,row:r.row,col:r.col},s.docTransform.size.width,s.docTransform.size.height,s.docTransform.angle);if(l)return s.transform.width=l.width,s.transform.height=l.height,s.docTransform.size.width=l.width,s.docTransform.size.height=l.height,s.transform.left=0,s.transform.top=0,s.docTransform.positionH.posOffset=0,s.docTransform.positionV.posOffset=0,n.p.documentStyle.pageSize.width=1/0,n.p.documentStyle.pageSize.height=1/0,!0}return!1}let xe=class extends d.Disposable{constructor(i,r,n,e,t,o,a){super(),this._commandService=i,this._sheetInterceptorService=r,this._univerInstanceService=n,this._injector=e,this._drawingManagerService=t,this._docDrawingController=o,this._editorBridgeService=a,this._initHandleResize(),this._handleInitEditor(),this._handleWriteCell(),this._initCellContentInterceptor()}_initHandleResize(){this.disposeWithMe(this._commandService.onCommandExecuted(i=>{let r,n=[];if(i.id===w.SetWorksheetRowHeightMutation.id){const e=i.params;n=e.ranges,r=w.getSheetCommandTarget(this._univerInstanceService,{unitId:e.unitId,subUnitId:e.subUnitId})}else if(i.id===w.SetWorksheetColWidthMutation.id){const e=i.params;n=e.ranges,r=w.getSheetCommandTarget(this._univerInstanceService,{unitId:e.unitId,subUnitId:e.subUnitId})}else if(i.id===w.SetWorksheetRowIsAutoHeightMutation.id){const e=i.params;n=e.ranges,r=w.getSheetCommandTarget(this._univerInstanceService,{unitId:e.unitId,subUnitId:e.subUnitId})}else if(i.id===w.SetWorksheetRowAutoHeightMutation.id){const e=i.params;r=w.getSheetCommandTarget(this._univerInstanceService,{unitId:e.unitId,subUnitId:e.subUnitId}),n=e.rowsAutoHeightInfo.map(t=>({startRow:t.row,endRow:t.row,startColumn:0,endColumn:9999}))}else if(i.id===w.AddWorksheetMergeMutation.id){const e=i.params;n=e.ranges,r=w.getSheetCommandTarget(this._univerInstanceService,{unitId:e.unitId,subUnitId:e.subUnitId})}else if(i.id===w.RemoveWorksheetMergeMutation.id){const e=i.params;n=e.ranges,r=w.getSheetCommandTarget(this._univerInstanceService,{unitId:e.unitId,subUnitId:e.subUnitId})}r&&n.length&&n.forEach(e=>{const t=d.Range.transformRange(e,r.worksheet);for(let o=t.startRow;o<=t.endRow;o++)for(let a=t.startColumn;a<=t.endColumn;a++)ht(this._injector,{unitId:r.unitId,subUnitId:r.subUnitId,row:o,col:a},r.worksheet.getCellRaw(o,a))})}))}_handleInitEditor(){this.disposeWithMe(this._editorBridgeService.visible$.subscribe(i=>{i.visible?i.visible&&(this._drawingManagerService.removeDrawingDataForUnit(d.DOCS_NORMAL_EDITOR_UNIT_ID_KEY),this._docDrawingController.loadDrawingDataForUnit(d.DOCS_NORMAL_EDITOR_UNIT_ID_KEY),this._drawingManagerService.initializeNotification(d.DOCS_NORMAL_EDITOR_UNIT_ID_KEY)):this._drawingManagerService.removeDrawingDataForUnit(d.DOCS_NORMAL_EDITOR_UNIT_ID_KEY)})),this.disposeWithMe(this._commandService.onCommandExecuted(i=>{i.id===Rt.ReplaceSnapshotCommand.id&&i.params.unitId===d.DOCS_ZEN_EDITOR_UNIT_ID_KEY&&(this._drawingManagerService.removeDrawingDataForUnit(d.DOCS_ZEN_EDITOR_UNIT_ID_KEY),this._docDrawingController.loadDrawingDataForUnit(d.DOCS_ZEN_EDITOR_UNIT_ID_KEY),this._drawingManagerService.initializeNotification(d.DOCS_ZEN_EDITOR_UNIT_ID_KEY))}))}_handleWriteCell(){this.disposeWithMe(this._sheetInterceptorService.writeCellInterceptor.intercept(w.AFTER_CELL_EDIT,{priority:9999,handler:(i,r,n)=>(ht(this._injector,{unitId:r.unitId,subUnitId:r.subUnitId,row:r.row,col:r.col},i),n(i))}))}_initCellContentInterceptor(){this.disposeWithMe(this._sheetInterceptorService.intercept(w.INTERCEPTOR_POINT.CELL_CONTENT,{effect:d.InterceptorEffectEnum.Style,priority:w.InterceptCellContentPriority.CELL_IMAGE,handler:(i,r,n)=>{var e;return i!=null&&i.p&&((e=i.p.drawingsOrder)!=null&&e.length)&&(i.interceptorStyle||(i.interceptorStyle={}),i.interceptorStyle.tr={a:0}),n(i)}}))}};xe=an([_e(0,d.ICommandService),_e(1,d.Inject(w.SheetInterceptorService)),_e(2,d.IUniverInstanceService),_e(3,d.Inject(d.Injector)),_e(4,O.IDrawingManagerService),_e(5,d.Inject(Se.DocDrawingController)),_e(6,d.Inject(P.IEditorBridgeService))],xe);var sn=Object.defineProperty,cn=Object.getOwnPropertyDescriptor,dn=(i,r,n,e)=>{for(var t=e>1?void 0:e?cn(r,n):r,o=i.length-1,a;o>=0;o--)(a=i[o])&&(t=(e?a(r,n,t):a(t))||t);return e&&t&&sn(r,n,t),t},Ut=(i,r)=>(n,e)=>r(n,e,i);let Xe=class extends d.Disposable{constructor(i,r){super(),this._autoFillService=i,this._injector=r,this._initAutoFillHooks()}_initAutoFillHooks(){this.disposeWithMe(this._autoFillService.addHook({id:"sheet-cell-image-autofill",onBeforeSubmit:(i,r,n,e)=>{new d.ObjectMatrix(e).forValue((t,o,a)=>{ht(this._injector,{unitId:i.unitId,subUnitId:i.subUnitId,row:t,col:o},a)})}}))}};Xe=dn([Ut(0,d.Inject(P.IAutoFillService)),Ut(1,d.Inject(d.Injector))],Xe);var ln=Object.defineProperty,un=Object.getOwnPropertyDescriptor,mn=(i,r,n,e)=>{for(var t=e>1?void 0:e?un(r,n):r,o=i.length-1,a;o>=0;o--)(a=i[o])&&(t=(e?a(r,n,t):a(t))||t);return e&&t&&ln(r,n,t),t},Ke=(i,r)=>(n,e)=>r(n,e,i);let ze=class extends d.Disposable{constructor(r,n,e,t){super();q(this,"_isSetCursor",!1);this._hoverManagerService=r,this._renderManagerService=n,this._selectionsService=e,this._drawingRenderService=t}_initHover(){}_initImageClick(){}};ze=mn([Ke(0,d.Inject(P.HoverManagerService)),Ke(1,d.Inject(N.IRenderManagerService)),Ke(2,d.Inject(w.SheetsSelectionsService)),Ke(3,d.Inject(ue.DrawingRenderService))],ze);var gn=Object.defineProperty,hn=Object.getOwnPropertyDescriptor,pn=(i,r,n,e)=>{for(var t=e>1?void 0:e?hn(r,n):r,o=i.length-1,a;o>=0;o--)(a=i[o])&&(t=(e?a(r,n,t):a(t))||t);return e&&t&&gn(r,n,t),t},pt=(i,r)=>(n,e)=>r(n,e,i);let Je=class extends d.Disposable{constructor(r,n,e){super();q(this,"_copyInfo");this._sheetClipboardService=r,this._renderManagerService=n,this._sheetDrawingService=e,this._initCopyPaste()}_initCopyPaste(){this._sheetClipboardService.addClipboardHook({id:"SHEET_IMAGE_UI_PLUGIN",onBeforeCopy:(r,n,e)=>this._collect(r,n,e),onPasteCells:(r,n,e,t)=>{const{copyType:o=P.COPY_TYPE.COPY,pasteType:a}=t,{range:s}=r||{},{range:l,unitId:h,subUnitId:u}=n;return this._generateMutations(l,{copyType:o,pasteType:a,copyRange:s,unitId:h,subUnitId:u})},onPastePlainText:(r,n)=>({undos:[],redos:[]})})}_collect(r,n,e){var g;const t=(g=this._renderManagerService.getRenderById(r))==null?void 0:g.with(P.SheetSkeletonManagerService);if(!t)return;const o=t.attachRangeWithCoord(e);if(!o)return;const{startX:a,endX:s,startY:l,endY:h}=o,u=this._sheetDrawingService.getDrawingData(r,n),c=[];Object.keys(u).forEach(m=>{const p=u[m],{transform:_}=p;if(p.anchorType!==f.SheetDrawingAnchorType.Both||!_)return;const{left:S=0,top:v=0,width:C=0,height:D=0}=_,{drawingStartX:R,drawingEndX:y,drawingStartY:T,drawingEndY:I}={drawingStartX:S,drawingEndX:S+C,drawingStartY:v,drawingEndY:v+D};a<=R&&y<=s&&l<=T&&I<=h&&c.push(p)}),c.length&&(this._copyInfo={drawings:c,unitId:r,subUnitId:n})}_generateMutations(r,n){var F;if(!this._copyInfo)return{redos:[],undos:[]};if([P.PREDEFINED_HOOK_NAME.SPECIAL_PASTE_COL_WIDTH,P.PREDEFINED_HOOK_NAME.SPECIAL_PASTE_VALUE,P.PREDEFINED_HOOK_NAME.SPECIAL_PASTE_FORMAT,P.PREDEFINED_HOOK_NAME.SPECIAL_PASTE_FORMULA].includes(n.pasteType))return{redos:[],undos:[]};const{copyRange:t}=n;if(!t)return{redos:[],undos:[]};const{drawings:o,unitId:a,subUnitId:s}=this._copyInfo,{ranges:[l,h],mapFunc:u}=P.virtualizeDiscreteRanges([t,r]),{row:c,col:g}=u(l.startRow,l.startColumn),{row:m,col:p}=u(h.startRow,h.startColumn),_=(F=this._renderManagerService.getRenderById(a))==null?void 0:F.with(P.SheetSkeletonManagerService);if(!_)return{redos:[],undos:[]};const S=_.attachRangeWithCoord({startRow:c,endRow:c,startColumn:g,endColumn:g}),v=_.attachRangeWithCoord({startRow:m,endRow:m,startColumn:p,endColumn:p});if(!S||!v)return{redos:[],undos:[]};const C=[],D=[],R=v.startX-S.startX,y=v.startY-S.startY,T=m-c,I=p-g,U=n.copyType===P.COPY_TYPE.CUT,{_sheetDrawingService:E}=this;return o.forEach(B=>{const{transform:A,sheetTransform:M}=B;if(!A)return;const L={...B,unitId:a,subUnitId:s,drawingId:U?B.drawingId:d.Tools.generateRandomId(),transform:{...A,left:A.left+R,top:A.top+y},sheetTransform:{to:{...M.to,row:M.to.row+T,column:M.to.column+I},from:{...M.from,row:M.from.row+T,column:M.from.column+I}}};if(U){const{undo:G,redo:x,objects:W}=E.getBatchUpdateOp([L]);C.push({id:f.SetDrawingApplyMutation.id,params:{unitId:a,subUnitId:s,type:f.DrawingApplyType.UPDATE,op:x,objects:W}}),D.push({id:f.SetDrawingApplyMutation.id,params:{unitId:a,subUnitId:s,type:f.DrawingApplyType.UPDATE,op:G,objects:W}})}else{const{undo:G,redo:x,objects:W}=E.getBatchAddOp([L]);C.push({id:f.SetDrawingApplyMutation.id,params:{op:x,unitId:a,subUnitId:s,objects:W,type:f.DrawingApplyType.INSERT}}),D.push({id:f.SetDrawingApplyMutation.id,params:{op:G,unitId:a,subUnitId:s,objects:W,type:f.DrawingApplyType.REMOVE}})}}),{redos:C,undos:D}}};Je=pn([pt(0,P.ISheetClipboardService),pt(1,N.IRenderManagerService),pt(2,f.ISheetDrawingService)],Je);var fn=Object.defineProperty,Sn=Object.getOwnPropertyDescriptor,_n=(i,r,n,e)=>{for(var t=e>1?void 0:e?Sn(r,n):r,o=i.length-1,a;o>=0;o--)(a=i[o])&&(t=(e?a(r,n,t):a(t))||t);return e&&t&&fn(r,n,t),t},je=(i,r)=>(n,e)=>r(n,e,i);let Ze=class extends d.Disposable{constructor(i,r,n,e,t){super(),this._drawingManagerService=i,this._renderManagerService=r,this._permissionService=n,this._univerInstanceService=e,this._userManagerService=t,this._initDrawingVisible(),this._initDrawingEditable(),this._initViewPermissionChange(),this._initEditPermissionChange()}_initDrawingVisible(){const i=this._univerInstanceService.getCurrentTypeOfUnit$(d.UniverInstanceType.UNIVER_SHEET);this.disposeWithMe(j.combineLatest([i,this._userManagerService.currentUser$]).subscribe(([r,n])=>{if(!r){this._drawingManagerService.setDrawingVisible(!1);return}r.activeSheet$.subscribe(e=>{if(!e){this._drawingManagerService.setDrawingVisible(!1);return}const t=r.getUnitId(),o=e.getSheetId();if(this._permissionService.composePermission([new w.WorkbookViewPermission(t).id,new w.WorksheetViewPermission(t,o).id]).every(s=>s.value))this._drawingManagerService.setDrawingVisible(!0);else{this._drawingManagerService.setDrawingVisible(!1);const s=r.getUnitId(),l=e.getSheetId(),h=this._drawingManagerService.getDrawingData(s,l),u=Object.values(h),c=this._renderManagerService.getRenderById(s),g=c==null?void 0:c.scene;if(g==null)return;g.getAllObjectsByOrder().forEach(p=>{p.classType===N.RENDER_CLASS_TYPE.IMAGE&&u.some(_=>p.oKey.includes(_.drawingId))&&g.removeObject(p)})}})}))}_initDrawingEditable(){const i=this._univerInstanceService.getCurrentTypeOfUnit$(d.UniverInstanceType.UNIVER_SHEET);this.disposeWithMe(j.combineLatest([i,this._userManagerService.currentUser$]).subscribe(([r,n])=>{if(!r){this._drawingManagerService.setDrawingEditable(!1);return}r.activeSheet$.subscribe(e=>{if(!e){this._drawingManagerService.setDrawingEditable(!1);return}const t=r.getUnitId(),o=e.getSheetId();if(this._permissionService.composePermission([new w.WorkbookEditablePermission(t).id,new w.WorksheetEditPermission(t,o).id]).every(s=>s.value))this._drawingManagerService.setDrawingEditable(!0);else{this._drawingManagerService.setDrawingEditable(!1);const s=r.getUnitId(),l=e.getSheetId(),h=this._drawingManagerService.getDrawingData(s,l),u=Object.values(h),c=this._renderManagerService.getRenderById(s),g=c==null?void 0:c.scene;if(g==null)return;g.getAllObjectsByOrder().forEach(p=>{p.classType===N.RENDER_CLASS_TYPE.IMAGE&&u.some(_=>p.oKey.includes(_.drawingId))&&g.detachTransformerFrom(p)})}})}))}_initViewPermissionChange(){const i=this._univerInstanceService.getCurrentTypeOfUnit$(d.UniverInstanceType.UNIVER_SHEET);this.disposeWithMe(j.combineLatest([i,this._userManagerService.currentUser$]).subscribe(([r,n])=>{r&&r.activeSheet$.subscribe(e=>{var c;if(!e)return;const t=r.getUnitId(),o=e.getSheetId();let a=!0;const s=this._renderManagerService.getRenderById(t),l=s==null?void 0:s.scene;if(l==null)return;const h=l.getTransformerByCreate(),u=this._permissionService.composePermission$([new w.WorkbookViewPermission(t).id,new w.WorksheetViewPermission(t,o).id]).pipe(j.map(g=>g.every(m=>m.value)));u==null||u.pipe(j.filter(g=>g!==a),j.distinctUntilChanged()).subscribe({next:g=>{a=g,this._drawingManagerService.setDrawingVisible(g);const m=l.getAllObjectsByOrder(),p=this._drawingManagerService.getDrawingData(t,o),_=Object.values(p);g?this._drawingManagerService.addNotification(_):(m.forEach(S=>{S.classType===N.RENDER_CLASS_TYPE.IMAGE&&_.some(v=>S.oKey.includes(v.drawingId))&&l.removeObject(S)}),h.clearSelectedObjects())}}),(c=this._permissionService.getPermissionPoint$(new w.WorksheetViewPermission(t,o).id))==null||c.pipe(j.filter(g=>g.value!==a),j.distinctUntilChanged()).subscribe({complete:()=>{a=!0,this._drawingManagerService.setDrawingVisible(!0);const g=this._drawingManagerService.getDrawingData(t,o),m=Object.values(g);this._drawingManagerService.addNotification(m)}})})}))}_initEditPermissionChange(){const i=this._univerInstanceService.getCurrentTypeOfUnit$(d.UniverInstanceType.UNIVER_SHEET);this.disposeWithMe(j.combineLatest([i,this._userManagerService.currentUser$]).subscribe(([r,n])=>{r&&r.activeSheet$.subscribe(e=>{var c;if(!e)return;const t=r.getUnitId(),o=e.getSheetId();let a=!0;const s=this._renderManagerService.getRenderById(t),l=s==null?void 0:s.scene;if(l==null)return;const h=l.getTransformerByCreate(),u=this._permissionService.composePermission$([new w.WorkbookEditablePermission(t).id,new w.WorksheetEditPermission(t,o).id]).pipe(j.map(g=>g.every(m=>m.value)));u==null||u.pipe(j.filter(g=>g!==a),j.distinctUntilChanged()).subscribe({next:g=>{a=g,this._drawingManagerService.setDrawingEditable(g);const m=l.getAllObjectsByOrder(),p=this._drawingManagerService.getDrawingData(t,o),_=Object.values(p);g?(m.forEach(S=>{S.classType===N.RENDER_CLASS_TYPE.IMAGE&&_.some(v=>S.oKey.includes(v.drawingId))&&l.attachTransformerTo(S)}),this._drawingManagerService.addNotification(_)):(m.forEach(S=>{S.classType===N.RENDER_CLASS_TYPE.IMAGE&&_.some(v=>S.oKey.includes(v.drawingId))&&l.detachTransformerFrom(S)}),h.clearSelectedObjects())}}),(c=this._permissionService.getPermissionPoint$(new w.WorksheetEditPermission(t,o).id))==null||c.pipe(j.filter(g=>g.value!==a),j.distinctUntilChanged()).subscribe({complete:()=>{a=!0;const g=r.getUnitId(),m=e.getSheetId(),p=this._drawingManagerService.getDrawingData(g,m),_=Object.values(p),S=this._renderManagerService.getRenderById(g),v=S==null?void 0:S.scene;if(v==null)return;this._drawingManagerService.setDrawingEditable(!0),v.getAllObjectsByOrder().forEach(D=>{D.classType===N.RENDER_CLASS_TYPE.IMAGE&&_.some(R=>D.oKey.includes(R.drawingId))&&v.detachTransformerFrom(D)})}})})}))}};Ze=_n([je(0,O.IDrawingManagerService),je(1,N.IRenderManagerService),je(2,d.IPermissionService),je(3,d.IUniverInstanceService),je(4,d.Inject(d.UserManagerService))],Ze);var vn=Object.defineProperty,wn=Object.getOwnPropertyDescriptor,In=(i,r,n,e)=>{for(var t=e>1?void 0:e?wn(r,n):r,o=i.length-1,a;o>=0;o--)(a=i[o])&&(t=(e?a(r,n,t):a(t))||t);return e&&t&&vn(r,n,t),t},qe=(i,r)=>(n,e)=>r(n,e,i);let Qe=class extends d.Disposable{constructor(i,r,n,e){super(),this._sheetPrintInterceptorService=i,this._drawingRenderService=r,this._drawingManagerService=n,this._renderManagerService=e,this._initPrinting()}_initPrinting(){this.disposeWithMe(this._sheetPrintInterceptorService.interceptor.intercept(this._sheetPrintInterceptorService.interceptor.getInterceptPoints().PRINTING_COMPONENT_COLLECT,{handler:(i,r,n)=>{const{unitId:e,scene:t,subUnitId:o}=r,a=this._drawingManagerService.getDrawingDataForUnit(e),s=a==null?void 0:a[o];return s&&s.order.forEach(l=>{this._drawingRenderService.renderDrawing(s.data[l],t)}),n()}})),this.disposeWithMe(this._sheetPrintInterceptorService.interceptor.intercept(this._sheetPrintInterceptorService.interceptor.getInterceptPoints().PRINTING_RANGE,{handler:(i,r,n)=>{const{unitId:e,subUnitId:t}=r,o=this._renderManagerService.getRenderById(e);if(!o)return n(i);const a=o.with(P.SheetSkeletonManagerService).getWorksheetSkeleton(t);if(!a)return n(i);const s=this._drawingManagerService.getDrawingDataForUnit(e),l=s==null?void 0:s[r.subUnitId];if(!l)return n(i);const{scaleX:h,scaleY:u}=o.scene,c=i?{...i}:{startColumn:0,endColumn:0,endRow:0,startRow:0},g=l.order.map(m=>l.data[m]).filter(m=>m.drawingType!==d.DrawingTypeEnum.DRAWING_DOM);return g.length?(g.forEach(m=>{if(!m.groupId&&m.transform&&d.Tools.isDefine(m.transform.left)&&d.Tools.isDefine(m.transform.top)&&d.Tools.isDefine(m.transform.width)&&d.Tools.isDefine(m.transform.height)){const p=a.skeleton.getCellIndexByOffset(m.transform.left,m.transform.top,h,u,{x:0,y:0}),_=a.skeleton.getCellIndexByOffset(m.transform.left+m.transform.width,m.transform.top+m.transform.height,h,u,{x:0,y:0});p.column<c.startColumn&&(c.startColumn=p.column),p.row<c.startRow&&(c.startRow=p.row),c.endRow<_.row&&(c.endRow=_.row),c.endColumn<_.column&&(c.endColumn=_.column)}}),n(c)):n(i)}}))}};Qe=In([qe(0,d.Inject(P.SheetPrintInterceptorService)),qe(1,d.Inject(ue.DrawingRenderService)),qe(2,O.IDrawingManagerService),qe(3,N.IRenderManagerService)],Qe);var Cn=Object.defineProperty,yn=Object.getOwnPropertyDescriptor,Dn=(i,r,n,e)=>{for(var t=e>1?void 0:e?yn(r,n):r,o=i.length-1,a;o>=0;o--)(a=i[o])&&(t=(e?a(r,n,t):a(t))||t);return e&&t&&Cn(r,n,t),t},ge=(i,r)=>(n,e)=>r(n,e,i);const Mn=[w.InsertRowCommand.id,w.InsertColCommand.id,w.RemoveRowCommand.id,w.RemoveColCommand.id,w.DeleteRangeMoveLeftCommand.id,w.DeleteRangeMoveUpCommand.id,w.InsertRangeMoveDownCommand.id,w.InsertRangeMoveRightCommand.id,w.DeltaRowHeightCommand.id,w.SetRowHeightCommand.id,w.DeltaColumnWidthCommand.id,w.SetColWidthCommand.id,w.SetRowHiddenCommand.id,w.SetSpecificRowsVisibleCommand.id,w.SetSpecificColsVisibleCommand.id,w.SetColHiddenCommand.id,w.MoveColsCommand.id,w.MoveRowsCommand.id,w.MoveRangeCommand.id],Tn=[w.SetRowVisibleMutation.id,w.SetRowHiddenMutation.id,w.SetColVisibleMutation.id,w.SetColHiddenMutation.id,w.SetWorksheetRowHeightMutation.id,w.SetWorksheetColWidthMutation.id];let ft=class extends d.Disposable{constructor(i,r,n,e,t,o,a,s,l){super(),this._context=i,this._renderManagerService=r,this._commandService=n,this._selectionRenderService=e,this._skeletonManagerService=t,this._sheetInterceptorService=o,this._sheetDrawingService=a,this._drawingManagerService=s,this._univerInstanceService=l,this._sheetInterceptorListener(),this._commandListener(),this._sheetRefreshListener()}_sheetInterceptorListener(){this.disposeWithMe(this._sheetInterceptorService.interceptCommand({getMutations:i=>{if(!Mn.includes(i.id))return{redos:[],undos:[]};if(i.params==null)return{redos:[],undos:[]};const r=i.id;if(r===w.InsertRowCommand.id)return this._moveRowInterceptor(i.params,"insert");if([w.MoveColsCommand.id,w.MoveRowsCommand.id,w.MoveRangeCommand.id].includes(r))return this._moveRangeInterceptor(i.params);if(r===w.InsertColCommand.id)return this._moveColInterceptor(i.params,"insert");if(r===w.RemoveRowCommand.id)return this._moveRowInterceptor(i.params,"remove");if(r===w.RemoveColCommand.id)return this._moveColInterceptor(i.params,"remove");if(r===w.DeleteRangeMoveLeftCommand.id){const{range:n}=i.params;return this._getRangeMoveUndo(n,0)}else if(r===w.DeleteRangeMoveUpCommand.id){const{range:n}=i.params;return this._getRangeMoveUndo(n,1)}else if(r===w.InsertRangeMoveDownCommand.id){const{range:n}=i.params;return this._getRangeMoveUndo(n,2)}else if(r===w.InsertRangeMoveRightCommand.id){const{range:n}=i.params;return this._getRangeMoveUndo(n,3)}else if(r===w.SetRowHiddenCommand.id||r===w.SetSpecificRowsVisibleCommand.id){const n=i.params,{unitId:e,subUnitId:t,ranges:o}=n;return this._getDrawingUndoForRowVisible(e,t,o)}else if(r===w.SetSpecificColsVisibleCommand.id||r===w.SetColHiddenCommand.id){const n=i.params,{unitId:e,subUnitId:t,ranges:o}=n;return this._getDrawingUndoForColVisible(e,t,o)}else if(r===w.DeltaRowHeightCommand.id||r===w.SetRowHeightCommand.id||r===w.DeltaColumnWidthCommand.id||r===w.SetColWidthCommand.id){const n=i.params,{unitId:e,subUnitId:t,ranges:o}=n,a=r===w.DeltaRowHeightCommand.id||r===w.SetRowHeightCommand.id;return this._getDrawingUndoForRowAndColSize(e,t,o,a)}return{redos:[],undos:[]}}}))}_getRangeMoveUndo(i,r){const n=w.getSheetCommandTarget(this._univerInstanceService);if(n==null)return{redos:[],undos:[]};const e=n.unitId,t=n.subUnitId,o=[],a=[],s=this._sheetDrawingService.getDrawingData(e,t),l=[],h=[];if(Object.keys(s).forEach(u=>{const c=s[u],{updateDrawings:g,deleteDrawings:m}=this._getUpdateOrDeleteDrawings(i,r,c);l.push(...g),h.push(...m)}),l.length===0&&h.length===0)return{redos:[],undos:[]};if(l.length>0){const u=this._sheetDrawingService.getBatchUpdateOp(l),{undo:c,redo:g,objects:m}=u;o.push({id:f.SetDrawingApplyMutation.id,params:{unitId:e,subUnitId:t,op:g,objects:m,type:f.DrawingApplyType.UPDATE}}),a.push({id:f.SetDrawingApplyMutation.id,params:{unitId:e,subUnitId:t,op:c,objects:m,type:f.DrawingApplyType.UPDATE}})}if(h.length>0){const u=this._sheetDrawingService.getBatchRemoveOp(h),c=u.undo,g=u.redo,m=u.objects;o.push({id:f.SetDrawingApplyMutation.id,params:{unitId:e,subUnitId:t,op:g,objects:m,type:f.DrawingApplyType.REMOVE}}),a.push({id:f.SetDrawingApplyMutation.id,params:{unitId:e,subUnitId:t,op:c,objects:m,type:f.DrawingApplyType.INSERT}})}return o.push({id:$.id,params:[e]}),a.push({id:$.id,params:[e]}),{redos:o,undos:a}}_getUpdateOrDeleteDrawings(i,r,n){const e=[],t=[],{sheetTransform:o,anchorType:a=f.SheetDrawingAnchorType.Position,transform:s,unitId:l,subUnitId:h,drawingId:u}=n,{from:c,to:g}=o,{row:m,column:p}=c,{row:_,column:S}=g;if(o==null||s==null)return{updateDrawings:e,deleteDrawings:t};const{startRow:v,endRow:C,startColumn:D,endColumn:R}=i;let y=null,T=null;if(r===0&&m>=v&&_<=C)if(p>=D&&S<=R)t.push({unitId:l,subUnitId:h,drawingId:u});else{const I=this._shrinkCol(o,s,D,R,a);y=I==null?void 0:I.newSheetTransform,T=I==null?void 0:I.newTransform}else if(r===1&&p>=D&&S<=R)if(m>=v&&_<=C)t.push({unitId:l,subUnitId:h,drawingId:u});else{const I=this._shrinkRow(o,s,v,C,a);y=I==null?void 0:I.newSheetTransform,T=I==null?void 0:I.newTransform}else if(r===2){const I=this._expandRow(o,s,v,C,a);y=I==null?void 0:I.newSheetTransform,T=I==null?void 0:I.newTransform}else if(r===3){const I=this._expandCol(o,s,D,R,a);y=I==null?void 0:I.newSheetTransform,T=I==null?void 0:I.newTransform}if(y!=null&&T!=null){const I=z(y,this._selectionRenderService,this._skeletonManagerService);e.push({...n,sheetTransform:y,transform:I})}return{updateDrawings:e,deleteDrawings:t}}_remainDrawingSize(i,r,n){const e=V({...i},this._selectionRenderService);e!=null&&r.push({...n,sheetTransform:e})}_getDrawingUndoForColVisible(i,r,n){const e=this._drawingManagerService.getDrawingData(i,r),t=[],o=[];if(Object.keys(e).forEach(u=>{const c=e[u],{sheetTransform:g,transform:m,anchorType:p=f.SheetDrawingAnchorType.Position}=c;if(p===f.SheetDrawingAnchorType.None)this._remainDrawingSize(m,t,c);else{const{from:_,to:S}=g,{row:v,column:C}=_,{row:D,column:R}=S;for(let y=0;y<n.length;y++){const T=n[y],{startRow:I,endRow:U,startColumn:E,endColumn:F}=T;if(R<E)continue;if(p===f.SheetDrawingAnchorType.Position){let M=null,L=null;if(C>=E&&C<=F){const G=this._skeletonManagerService.attachRangeWithCoord({startColumn:C,endColumn:F,startRow:_.row,endRow:S.row});if(G==null)return;L={...m,left:G.startX}}if(L!=null&&(M=V(L,this._selectionRenderService),M!=null&&L!=null)){t.push({...c,sheetTransform:M,transform:L});break}this._remainDrawingSize(m,t,c);continue}if(C>=E&&R<=F)continue;let B=null,A=null;if(C>=E&&C<=F){const M=this._skeletonManagerService.attachRangeWithCoord({startColumn:C,endColumn:F,startRow:_.row,endRow:S.row});if(M==null)return;A={...m,left:(M==null?void 0:M.startX)||0,width:((m==null?void 0:m.width)||0)-M.endX+M.startX}}else if(R>=E&&R<=F){const M=this._skeletonManagerService.attachRangeWithCoord({startColumn:E,endColumn:R,startRow:_.row,endRow:S.row});if(M==null)return;A={...m,left:M.startX-((m==null?void 0:m.width)||0)}}else{const M=this._skeletonManagerService.attachRangeWithCoord({startColumn:E,endColumn:F,startRow:_.row,endRow:S.row});if(M==null)return;if(A={...m,width:((m==null?void 0:m.width)||0)-M.endX+M.startX},B=V(A,this._selectionRenderService),B!=null&&A!=null){o.push({...c,sheetTransform:B,transform:A});break}}if(A!=null&&(B=V(A,this._selectionRenderService)),A!=null&&B!=null){t.push({...c,sheetTransform:B,transform:A});break}else this._remainDrawingSize(m,t,c)}}}),t.length===0&&o.length===0)return{redos:[],undos:[]};const{redos:a,undos:s}=this._createUndoAndRedoMutation(i,r,t),l=[],h=[];if(o.length>0){const{redos:u,undos:c}=this._createUndoAndRedoMutation(i,r,o);l.push(...u),h.push(...c)}return{redos:a,undos:s,preRedos:l,preUndos:h}}_createUndoAndRedoMutation(i,r,n){const e=this._sheetDrawingService.getBatchUpdateOp(n),{undo:t,redo:o,objects:a}=e,s=[{id:f.SetDrawingApplyMutation.id,params:{unitId:i,subUnitId:r,op:o,objects:a,type:f.DrawingApplyType.UPDATE}},{id:$.id,params:[i]}],l=[{id:f.SetDrawingApplyMutation.id,params:{unitId:i,subUnitId:r,op:t,objects:a,type:f.DrawingApplyType.UPDATE}},{id:$.id,params:[i]}];return{redos:s,undos:l}}_getDrawingUndoForRowVisible(i,r,n){const e=this._drawingManagerService.getDrawingData(i,r),t=[],o=[];if(Object.keys(e).forEach(u=>{const c=e[u],{sheetTransform:g,transform:m,anchorType:p=f.SheetDrawingAnchorType.Position}=c;if(p===f.SheetDrawingAnchorType.None)this._remainDrawingSize(m,t,c);else{const{from:_,to:S}=g,{row:v,column:C}=_,{row:D,column:R}=S;for(let y=0;y<n.length;y++){const T=n[y],{startRow:I,endRow:U,startColumn:E,endColumn:F}=T;if(D<I)continue;if(p===f.SheetDrawingAnchorType.Position){let M=null,L=null;if(v>=I&&v<=U){const G=this._skeletonManagerService.attachRangeWithCoord({startColumn:_.column,endColumn:S.column,startRow:v,endRow:U});if(G==null)return;L={...m,top:G.startY}}if(L!=null&&(M=V(L,this._selectionRenderService),M!=null&&L!=null)){t.push({...c,sheetTransform:M,transform:L});break}this._remainDrawingSize(m,t,c);continue}if(v>=I&&D<=U)continue;let B=null,A=null;if(v>=I&&v<=U){const M=this._skeletonManagerService.attachRangeWithCoord({startColumn:_.column,endColumn:S.column,startRow:v,endRow:U});if(M==null)return;A={...m,top:(M==null?void 0:M.startY)||0,height:((m==null?void 0:m.height)||0)-M.endY+M.startY}}else if(D>=I&&D<=U){const M=this._skeletonManagerService.attachRangeWithCoord({startColumn:_.column,endColumn:S.column,startRow:I,endRow:D});if(M==null)return;A={...m,top:M.startY-((m==null?void 0:m.height)||0)}}else{const M=this._skeletonManagerService.attachRangeWithCoord({startColumn:_.column,endColumn:S.column,startRow:I,endRow:U});if(M==null)return;if(A={...m,height:((m==null?void 0:m.height)||0)-M.endY+M.startY},B=V(A,this._selectionRenderService),B!=null&&A!=null){o.push({...c,sheetTransform:B,transform:A});break}}if(A!=null&&(B=V(A,this._selectionRenderService)),A!=null&&B!=null){t.push({...c,sheetTransform:B,transform:A});break}else this._remainDrawingSize(m,t,c)}}}),t.length===0&&o.length===0)return{redos:[],undos:[]};const{redos:a,undos:s}=this._createUndoAndRedoMutation(i,r,t),l=[],h=[];if(o.length>0){const{redos:u,undos:c}=this._createUndoAndRedoMutation(i,r,o);l.push(...u),h.push(...c)}return{redos:a,undos:s,preRedos:l,preUndos:h}}_getDrawingUndoForRowAndColSize(i,r,n,e){const t=this._drawingManagerService.getDrawingData(i,r),o=[];return Object.keys(t).forEach(a=>{const s=t[a],{sheetTransform:l,transform:h,anchorType:u=f.SheetDrawingAnchorType.Position}=s;if(u===f.SheetDrawingAnchorType.None)this._remainDrawingSize(h,o,s);else{const{from:c,to:g}=l,{row:m,column:p}=c,{row:_,column:S}=g;for(let v=0;v<n.length;v++){const C=n[v],{startRow:D,endRow:R,startColumn:y,endColumn:T}=C;if(_<D||S<y)continue;if(u===f.SheetDrawingAnchorType.Position&&(m<=D&&_>=R||p<=y&&S>=T)){this._remainDrawingSize(h,o,s);continue}const I=z({...l},this._selectionRenderService,this._skeletonManagerService);if(I!=null){o.push({...s,transform:I});break}}}}),o.length===0?{redos:[],undos:[]}:this._createUndoAndRedoMutation(i,r,o)}_getUnitIdAndSubUnitId(i,r){let n,e;if(r==="insert")n=i.unitId,e=i.subUnitId;else{const t=w.getSheetCommandTarget(this._univerInstanceService);if(t==null)return;n=t.unitId,e=t.subUnitId}return{unitId:n,subUnitId:e}}_moveRangeInterceptor(i){var D,R;const{toRange:r,fromRange:n}=i,e=w.getSheetCommandTarget(this._univerInstanceService);if(!e)return{redos:[],undos:[]};const{unitId:t,subUnitId:o}=e,a=(R=(D=this._renderManagerService.getRenderById(t))==null?void 0:D.with(P.SheetSkeletonManagerService))==null?void 0:R.getCurrentSkeleton();if(!a)return{redos:[],undos:[]};const s=P.attachRangeWithCoord(a,n);if(!s)return{redos:[],undos:[]};const{startX:l,endX:h,startY:u,endY:c}=s,g=this._sheetDrawingService.getDrawingData(t,o),m=[];Object.keys(g).forEach(y=>{const T=g[y];if(T.anchorType!==f.SheetDrawingAnchorType.Both)return;const{transform:I}=T;if(!I)return;const{left:U=0,top:E=0,width:F=0,height:B=0}=I,{drawingStartX:A,drawingEndX:M,drawingStartY:L,drawingEndY:G}={drawingStartX:U,drawingEndX:U+F,drawingStartY:E,drawingEndY:E+B};l<=A&&M<=h&&u<=L&&G<=c&&m.push(T)});const p=[],_=[],S=r.startRow-n.startRow,v=r.startColumn-n.startColumn,C=m.map(y=>{const T=y.sheetTransform,I={to:{...T.to,row:T.to.row+S,column:T.to.column+v},from:{...T.from,row:T.from.row+S,column:T.from.column+v}},U=z(I,this._selectionRenderService,this._skeletonManagerService);return{unitId:t,subUnitId:o,drawingId:y.drawingId,transform:U,sheetTransform:I}});if(C.length){const y=this._sheetDrawingService.getBatchUpdateOp(C),{undo:T,redo:I,objects:U}=y;p.push({id:f.SetDrawingApplyMutation.id,params:{unitId:t,subUnitId:o,op:I,objects:U,type:f.DrawingApplyType.UPDATE}}),_.push({id:f.SetDrawingApplyMutation.id,params:{unitId:t,subUnitId:o,op:T,objects:U,type:f.DrawingApplyType.UPDATE}})}return{redos:p,undos:_}}_moveRowInterceptor(i,r){const n=this._getUnitIdAndSubUnitId(i,r);if(n==null)return{redos:[],undos:[]};const{unitId:e,subUnitId:t}=n,{range:o}=i,a=o.startRow,s=o.endRow,l=[],h=[],u=this._sheetDrawingService.getDrawingData(e,t),c=[],g=[];if(Object.keys(u).forEach(m=>{const p=u[m],{sheetTransform:_,transform:S,anchorType:v=f.SheetDrawingAnchorType.Position}=p;if(_==null||S==null)return;let C,D;if(r==="insert"){const y=this._expandRow(_,S,a,s,v);C=y==null?void 0:y.newSheetTransform,D=y==null?void 0:y.newTransform}else{const{from:y,to:T}=_,{row:I}=y,{row:U}=T;if(v===f.SheetDrawingAnchorType.Both&&I>=a&&U<=s)g.push({unitId:e,subUnitId:t,drawingId:m});else{const E=this._shrinkRow(_,S,a,s,v);C=E==null?void 0:E.newSheetTransform,D=E==null?void 0:E.newTransform}}if(!C||!D)return;const R={unitId:e,subUnitId:t,drawingId:m,transform:D,sheetTransform:C};c.push(R)}),c.length===0&&g.length===0)return{redos:[],undos:[]};if(c.length>0){const m=this._sheetDrawingService.getBatchUpdateOp(c),{undo:p,redo:_,objects:S}=m;l.push({id:f.SetDrawingApplyMutation.id,params:{unitId:e,subUnitId:t,op:_,objects:S,type:f.DrawingApplyType.UPDATE}}),h.push({id:f.SetDrawingApplyMutation.id,params:{unitId:e,subUnitId:t,op:p,objects:S,type:f.DrawingApplyType.UPDATE}})}if(g.length>0){const m=this._sheetDrawingService.getBatchRemoveOp(g),p=m.undo,_=m.redo,S=m.objects;l.push({id:f.SetDrawingApplyMutation.id,params:{unitId:e,subUnitId:t,op:_,objects:S,type:f.DrawingApplyType.REMOVE}}),h.push({id:f.SetDrawingApplyMutation.id,params:{unitId:e,subUnitId:t,op:p,objects:S,type:f.DrawingApplyType.INSERT}})}return l.push({id:$.id,params:[e]}),h.push({id:$.id,params:[e]}),{redos:l,undos:h}}_moveColInterceptor(i,r){const n=this._getUnitIdAndSubUnitId(i,r);if(n==null)return{redos:[],undos:[]};const{unitId:e,subUnitId:t}=n,{range:o}=i,a=o.startColumn,s=o.endColumn,l=[],h=[],u=this._sheetDrawingService.getDrawingData(e,t),c=[],g=[];if(Object.keys(u).forEach(m=>{const p=u[m],{sheetTransform:_,transform:S,anchorType:v=f.SheetDrawingAnchorType.Position}=p;if(_==null||S==null)return;let C,D;if(r==="insert"){const y=this._expandCol(_,S,a,s,v);C=y==null?void 0:y.newSheetTransform,D=y==null?void 0:y.newTransform}else{const{from:y,to:T}=_,{column:I}=y,{column:U}=T;if(v===f.SheetDrawingAnchorType.Both&&I>=a&&U<=s)g.push({unitId:e,subUnitId:t,drawingId:m});else{const E=this._shrinkCol(_,S,a,s,v);C=E==null?void 0:E.newSheetTransform,D=E==null?void 0:E.newTransform}}if(!C||!D)return;const R={unitId:e,subUnitId:t,drawingId:m,transform:D,sheetTransform:C};c.push(R)}),c.length===0&&g.length===0)return{redos:[],undos:[]};if(c.length>0){const m=this._sheetDrawingService.getBatchUpdateOp(c),{undo:p,redo:_,objects:S}=m;l.push({id:f.SetDrawingApplyMutation.id,params:{unitId:e,subUnitId:t,op:_,objects:S,type:f.DrawingApplyType.UPDATE}}),h.push({id:f.SetDrawingApplyMutation.id,params:{unitId:e,subUnitId:t,op:p,objects:S,type:f.DrawingApplyType.UPDATE}})}if(g.length>0){const m=this._sheetDrawingService.getBatchRemoveOp(g),p=m.undo,_=m.redo,S=m.objects;l.push({id:f.SetDrawingApplyMutation.id,params:{unitId:e,subUnitId:t,op:_,objects:S,type:f.DrawingApplyType.REMOVE}}),h.push({id:f.SetDrawingApplyMutation.id,params:{unitId:e,subUnitId:t,op:p,objects:S,type:f.DrawingApplyType.INSERT}})}return l.push({id:$.id,params:[e]}),h.push({id:$.id,params:[e]}),{redos:l,undos:h}}_expandCol(i,r,n,e,t=f.SheetDrawingAnchorType.Position){const o=e-n+1,{from:a,to:s}=i,{column:l}=a,{column:h}=s;if(t===f.SheetDrawingAnchorType.None)return{newSheetTransform:V({...r},this._selectionRenderService),newTransform:r};let u=null,c=null;if(l>=n){const g=this._skeletonManagerService.attachRangeWithCoord({startColumn:n,endColumn:e,startRow:a.row,endRow:s.row});if(g==null)return;c={...r,left:(r.left||0)+g.endX-g.startX},u=V(c,this._selectionRenderService)}else if(h>=e)if(t===f.SheetDrawingAnchorType.Both)u={from:{...a},to:{...s,column:h+o}},c=z(u,this._selectionRenderService,this._skeletonManagerService);else return{newSheetTransform:V({...r},this._selectionRenderService),newTransform:r};return u!=null&&c!=null?{newSheetTransform:u,newTransform:c}:null}_shrinkCol(i,r,n,e,t=f.SheetDrawingAnchorType.Position){const o=e-n+1,{from:a,to:s}=i,{column:l}=a,{column:h}=s;if(t===f.SheetDrawingAnchorType.None)return{newSheetTransform:V({...r},this._selectionRenderService),newTransform:r};let u=null,c=null;if(l>e)u={from:{...a,column:l-o},to:{...s,column:h-o}},c=z(u,this._selectionRenderService,this._skeletonManagerService);else{if(l>=n&&h<=e)return null;if(l<n&&h>e)if(t===f.SheetDrawingAnchorType.Both)u={from:{...a},to:{...s,column:h-o}},c=z(u,this._selectionRenderService,this._skeletonManagerService);else return{newSheetTransform:V({...r},this._selectionRenderService),newTransform:r};else if(l>=n&&l<=e){if(l===n)c={...r,left:(r.left||0)-i.from.columnOffset};else{const g=this._skeletonManagerService.attachRangeWithCoord({startColumn:n,endColumn:l-1,startRow:a.row,endRow:s.row});if(g==null)return;c={...r,left:(r.left||0)-g.endX+g.startX-i.from.columnOffset}}u=V(c,this._selectionRenderService)}else if(h>=n&&h<=e&&t===f.SheetDrawingAnchorType.Both){const g=this._skeletonManagerService.attachRangeWithCoord({startColumn:n-1,endColumn:n-1,startRow:a.row,endRow:s.row});if(g==null)return;u={from:{...a},to:{...s,column:n-1,columnOffset:g.endX-g.startX}},c=z(u,this._selectionRenderService,this._skeletonManagerService)}}return u!=null&&c!=null?{newSheetTransform:u,newTransform:c}:null}_expandRow(i,r,n,e,t=f.SheetDrawingAnchorType.Position){const o=e-n+1,{from:a,to:s}=i,{row:l}=a,{row:h}=s;if(t===f.SheetDrawingAnchorType.None)return{newSheetTransform:V({...r},this._selectionRenderService),newTransform:r};let u=null,c=null;if(l>=n){const g=this._skeletonManagerService.attachRangeWithCoord({startRow:n,endRow:e,startColumn:a.column,endColumn:s.column});if(g==null)return;c={...r,top:(r.top||0)+g.endY-g.startY},u=V(c,this._selectionRenderService)}else if(h>=e)if(t===f.SheetDrawingAnchorType.Both)u={from:{...a},to:{...s,row:h+o}},c=z(u,this._selectionRenderService,this._skeletonManagerService);else return{newSheetTransform:V({...r},this._selectionRenderService),newTransform:r};return u!=null&&c!=null?{newSheetTransform:u,newTransform:c}:null}_shrinkRow(i,r,n,e,t=f.SheetDrawingAnchorType.Position){const o=e-n+1,{from:a,to:s}=i,{row:l}=a,{row:h}=s;if(t===f.SheetDrawingAnchorType.None)return{newSheetTransform:V({...r},this._selectionRenderService),newTransform:r};let u=null,c=null;if(l>e)u={from:{...a,row:l-o},to:{...s,row:h-o}},c=z(u,this._selectionRenderService,this._skeletonManagerService);else{if(l>=n&&h<=e)return null;if(l<n&&h>e)if(t===f.SheetDrawingAnchorType.Both)u={from:{...a},to:{...s,row:h-o}},c=z(u,this._selectionRenderService,this._skeletonManagerService);else return{newSheetTransform:V({...r},this._selectionRenderService),newTransform:r};else if(l>=n&&l<=e){if(l===n)c={...r,top:(r.top||0)-i.from.rowOffset};else{const g=this._skeletonManagerService.attachRangeWithCoord({startRow:n,endRow:l-1,startColumn:a.column,endColumn:s.column});if(g==null)return;c={...r,top:(r.top||0)-g.endY+g.startY-i.from.rowOffset}}u=V(c,this._selectionRenderService)}else if(h>=n&&h<=e&&t===f.SheetDrawingAnchorType.Both){const g=this._skeletonManagerService.attachRangeWithCoord({startColumn:a.column,endColumn:a.column,startRow:n-1,endRow:n-1});if(g==null)return;u={from:{...a},to:{...s,row:n-1,rowOffset:g.endY-g.startY}},c=z(u,this._selectionRenderService,this._skeletonManagerService)}}return u!=null&&c!=null?{newSheetTransform:u,newTransform:c}:null}_commandListener(){this.disposeWithMe(this._commandService.onCommandExecuted(i=>{i.id===w.SetWorksheetActiveOperation.id&&setTimeout(()=>{const r=i.params,{unitId:n,subUnitId:e}=r,t=this._drawingManagerService.drawingManagerData,o=[],a=[];Object.keys(t).forEach(s=>{const l=t[s];l!=null&&Object.keys(l).forEach(h=>{const u=l[h].data;u!=null&&Object.keys(u).forEach(c=>{if(s===n&&h===e){const g=u[c];g.transform=z(g.sheetTransform,this._selectionRenderService,this._skeletonManagerService),o.push(u[c])}else a.push(u[c])})})}),this._drawingManagerService.removeNotification(a),this._drawingManagerService.addNotification(o)},0)}))}_sheetRefreshListener(){this.disposeWithMe(this._commandService.onCommandExecuted(i=>{Tn.includes(i.id)&&requestIdleCallback(()=>{const r=i.params,{unitId:n,subUnitId:e,ranges:t}=r;this._refreshDrawingTransform(n,e,t)})}))}_refreshDrawingTransform(i,r,n){const e=this._drawingManagerService.getDrawingData(i,r),t=[];Object.keys(e).forEach(o=>{const a=e[o],{sheetTransform:s,transform:l,anchorType:h=f.SheetDrawingAnchorType.Position}=a;if(h===f.SheetDrawingAnchorType.None)return!0;const{from:u,to:c}=s,{row:g,column:m}=u,{row:p,column:_}=c;for(let S=0;S<n.length;S++){const v=n[S],{startRow:C,endRow:D,startColumn:R,endColumn:y}=v;if(d.Rectangle.intersects({startRow:C,endRow:D,startColumn:R,endColumn:y},{startRow:g,endRow:p,startColumn:m,endColumn:_})||g>D||m>y){const T=h===f.SheetDrawingAnchorType.Position,I=z(s,this._selectionRenderService,this._skeletonManagerService);t.push({...a,transform:{...I,width:T?l==null?void 0:l.width:I==null?void 0:I.width,height:T?l==null?void 0:l.height:I==null?void 0:I.height}});break}}}),t.length!==0&&(this._drawingManagerService.refreshTransform(t),this._commandService.syncExecuteCommand($.id,[i]))}};ft=Dn([ge(1,N.IRenderManagerService),ge(2,d.ICommandService),ge(3,P.ISheetSelectionRenderService),ge(4,d.Inject(P.SheetSkeletonManagerService)),ge(5,d.Inject(w.SheetInterceptorService)),ge(6,f.ISheetDrawingService),ge(7,O.IDrawingManagerService),ge(8,d.IUniverInstanceService)],ft);var te=function(){return te=Object.assign||function(i){for(var r,n=1,e=arguments.length;n<e;n++){r=arguments[n];for(var t in r)Object.prototype.hasOwnProperty.call(r,t)&&(i[t]=r[t])}return i},te.apply(this,arguments)},Rn=function(i,r){var n={};for(var e in i)Object.prototype.hasOwnProperty.call(i,e)&&r.indexOf(e)<0&&(n[e]=i[e]);if(i!=null&&typeof Object.getOwnPropertySymbols=="function")for(var t=0,e=Object.getOwnPropertySymbols(i);t<e.length;t++)r.indexOf(e[t])<0&&Object.prototype.propertyIsEnumerable.call(i,e[t])&&(n[e[t]]=i[e[t]]);return n},Nt=Q.forwardRef(function(i,r){var n=i.icon,e=i.id,t=i.className,o=i.extend,a=Rn(i,["icon","id","className","extend"]),s="univerjs-icon univerjs-icon-".concat(e," ").concat(t||"").trim(),l=Q.useRef("_".concat(On()));return jt(n,"".concat(e),{defIds:n.defIds,idSuffix:l.current},te({ref:r,className:s},a),o)});function jt(i,r,n,e,t){return Q.createElement(i.tag,te(te({key:r},bn(i,n,t)),e),(En(i,n).children||[]).map(function(o,a){return jt(o,"".concat(r,"-").concat(i.tag,"-").concat(a),n,void 0,t)}))}function bn(i,r,n){var e=te({},i.attrs);n!=null&&n.colorChannel1&&e.fill==="colorChannel1"&&(e.fill=n.colorChannel1);var t=r.defIds;return!t||t.length===0||(i.tag==="use"&&e["xlink:href"]&&(e["xlink:href"]=e["xlink:href"]+r.idSuffix),Object.entries(e).forEach(function(o){var a=o[0],s=o[1];typeof s=="string"&&(e[a]=s.replace(/url\(#(.*)\)/,"url(#$1".concat(r.idSuffix,")")))})),e}function En(i,r){var n,e=r.defIds;return!e||e.length===0?i:i.tag==="defs"&&(!((n=i.children)===null||n===void 0)&&n.length)?te(te({},i),{children:i.children.map(function(t){return typeof t.attrs.id=="string"&&e&&e.indexOf(t.attrs.id)>-1?te(te({},t),{attrs:te(te({},t.attrs),{id:t.attrs.id+r.idSuffix})}):t})}):i}function On(){return Math.random().toString(36).substring(2,8)}Nt.displayName="UniverIcon";var Pn={tag:"svg",attrs:{fill:"none",viewBox:"0 0 16 16",width:"1em",height:"1em"},children:[{tag:"path",attrs:{fill:"currentColor",d:"M2.2498 3.65005C2.2498 2.87685 2.87661 2.25005 3.64981 2.25005H7.9998C8.33118 2.25005 8.5998 1.98142 8.5998 1.65005C8.5998 1.31868 8.33118 1.05005 7.9998 1.05005H3.64981C2.21387 1.05005 1.0498 2.21411 1.0498 3.65005V12.35C1.0498 13.786 2.21386 14.95 3.6498 14.95H12.3498C13.7857 14.95 14.9498 13.786 14.9498 12.3501V8.00005C14.9498 7.66868 14.6812 7.40005 14.3498 7.40005C14.0184 7.40005 13.7498 7.66868 13.7498 8.00005V9.23974L12.2385 8.1063C11.7252 7.72129 11.0068 7.7723 10.5531 8.22605L9.00869 9.77041L6.73916 7.8251C6.24387 7.40055 5.5095 7.41278 5.02864 7.85359L2.2498 10.4009V3.65005ZM2.2498 12.0287V12.35C2.2498 13.1232 2.87661 13.75 3.6498 13.75H12.3498C13.123 13.75 13.7498 13.1232 13.7498 12.3501V10.7397L11.5186 9.06631C11.4829 9.03956 11.433 9.04314 11.4016 9.07458L9.92249 10.5537L11.1015 11.5642C11.3531 11.7799 11.3822 12.1587 11.1666 12.4103C10.9509 12.6619 10.5721 12.691 10.3205 12.4753L5.9582 8.7362C5.92384 8.70674 5.87288 8.70758 5.83952 8.73816L2.2498 12.0287Z",fillRule:"evenodd",clipRule:"evenodd"}},{tag:"path",attrs:{fill:"currentColor",d:"M11.8097 1.14783C12.1411 1.14783 12.4097 1.41646 12.4097 1.74783V3.297H14.1541C14.4855 3.297 14.7541 3.56563 14.7541 3.897C14.7541 4.22837 14.4855 4.497 14.1541 4.497H12.4097V6.24167C12.4097 6.57304 12.1411 6.84167 11.8097 6.84167C11.4783 6.84167 11.2097 6.57304 11.2097 6.24167V4.497H9.6603C9.32893 4.497 9.0603 4.22837 9.0603 3.897C9.0603 3.56563 9.32893 3.297 9.6603 3.297H11.2097V1.74783C11.2097 1.41646 11.4783 1.14783 11.8097 1.14783Z"}}]},Wt=Q.forwardRef(function(i,r){return Q.createElement(Nt,Object.assign({},i,{id:"add-image-single",ref:r,icon:Pn}))});Wt.displayName="AddImageSingle";const St={id:"sheet.command.delete-drawing",type:d.CommandType.COMMAND,handler:i=>{const r=i.get(d.ICommandService),e=i.get(f.ISheetDrawingService).getFocusDrawings();if(e.length===0)return!1;const t=e[0].unitId,o=e.map(a=>{const{unitId:s,subUnitId:l,drawingId:h,drawingType:u}=a;return{unitId:s,subUnitId:l,drawingId:h,drawingType:u}});return r.executeCommand(Oe.id,{unitId:t,drawings:o})}},et={id:"sheet.command.insert-float-image",type:d.CommandType.COMMAND,handler:i=>{var n,e;return(e=(n=i.get(N.IRenderManagerService).getCurrentTypeOfRenderer(d.UniverInstanceType.UNIVER_SHEET))==null?void 0:n.with(Ne).insertFloatImage())!=null?e:!1}},_t={id:"sheet.command.insert-cell-image",type:d.CommandType.COMMAND,handler:i=>{var n,e;return(e=(n=i.get(N.IRenderManagerService).getCurrentTypeOfRenderer(d.UniverInstanceType.UNIVER_SHEET))==null?void 0:n.with(Ne).insertCellImage())!=null?e:!1}},Re={id:"sheet.command.move-drawing",type:d.CommandType.COMMAND,handler:(i,r)=>{const n=i.get(d.ICommandService),e=i.get(f.ISheetDrawingService),t=i.get(P.ISheetSelectionRenderService),{direction:o}=r,a=e.getFocusDrawings();if(a.length===0)return!1;const s=a[0].unitId,l=a.map(u=>{const{transform:c}=u;if(c==null)return null;const g={...c},{left:m=0,top:p=0}=c;return o===d.Direction.UP?g.top=p-1:o===d.Direction.DOWN?g.top=p+1:o===d.Direction.LEFT?g.left=m-1:o===d.Direction.RIGHT&&(g.left=m+1),{...u,transform:g,sheetTransform:V(g,t)}}).filter(u=>u!=null);return n.syncExecuteCommand(Ue.id,{unitId:s,drawings:l})?(n.syncExecuteCommand($.id,[s]),!0):!1}},Bt="addition-and-subtraction-single",vt="sheet.menu.image";function An(i){return{id:vt,type:Y.MenuItemType.SUBITEMS,icon:Bt,tooltip:"sheetImage.title",hidden$:Y.getMenuHiddenObservable(i,d.UniverInstanceType.UNIVER_SHEET),disabled$:P.getCurrentRangeDisable$(i,{workbookTypes:[w.WorkbookEditablePermission],worksheetTypes:[w.WorksheetEditPermission],rangeTypes:[w.RangeProtectionPermissionEditPoint]})}}function Un(i){return{id:et.id,title:"sheetImage.upload.float",type:Y.MenuItemType.BUTTON,hidden$:Y.getMenuHiddenObservable(i,d.UniverInstanceType.UNIVER_SHEET)}}function Nn(i){return{id:_t.id,title:"sheetImage.upload.cell",type:Y.MenuItemType.BUTTON}}const he={imageCommonPanel:"univer-image-common-panel",imageCommonPanelGrid:"univer-image-common-panel-grid",imageCommonPanelBorder:"univer-image-common-panel-border",imageCommonPanelTitle:"univer-image-common-panel-title",imageCommonPanelSubtitle:"univer-image-common-panel-subtitle",imageCommonPanelRow:"univer-image-common-panel-row",imageCommonPanelRowVertical:"univer-image-common-panel-row-vertical",imageCommonPanelColumn:"univer-image-common-panel-column",imageCommonPanelColumnCenter:"univer-image-common-panel-column-center",imageCommonPanelInline:"univer-image-common-panel-inline",imageCommonPanelSpan2:"univer-image-common-panel-span2",imageCommonPanelSpan3:"univer-image-common-panel-span3",imageCommonPanelInput:"univer-image-common-panel-input",sheetImageMenu:"univer-sheet-image-menu",sheetImageMenuInput:"univer-sheet-image-menu-input"};function kt(i){var r,n,e="";if(typeof i=="string"||typeof i=="number")e+=i;else if(typeof i=="object")if(Array.isArray(i)){var t=i.length;for(r=0;r<t;r++)i[r]&&(n=kt(i[r]))&&(e&&(e+=" "),e+=n)}else for(n in i)i[n]&&(e&&(e+=" "),e+=n);return e}function tt(){for(var i,r,n=0,e="",t=arguments.length;n<t;n++)(i=arguments[n])&&(r=kt(i))&&(e&&(e+=" "),e+=r);return e}const jn=i=>{var D;const r=d.useDependency(d.ICommandService),n=d.useDependency(d.LocaleService),e=d.useDependency(O.IDrawingManagerService),t=d.useDependency(N.IRenderManagerService),{drawings:o}=i,a=o[0];if(a==null)return;const{unitId:s}=a,l=t.getRenderById(s),h=l==null?void 0:l.scene;if(h==null)return;const u=h.getTransformerByCreate(),[c,g]=Q.useState(!0),m=(D=a.anchorType)!=null?D:f.SheetDrawingAnchorType.Position,[p,_]=Q.useState(m);function S(R,y){const T=[];return R.forEach(I=>{const{oKey:U}=I,E=y.getDrawingOKey(U);if(E==null)return T.push(null),!0;const{unitId:F,subUnitId:B,drawingId:A,drawingType:M,anchorType:L,sheetTransform:G}=E;T.push({unitId:F,subUnitId:B,drawingId:A,anchorType:L,sheetTransform:G,drawingType:M})}),T}Q.useEffect(()=>{const R=u.clearControl$.subscribe(T=>{T===!0&&g(!1)}),y=u.changeStart$.subscribe(T=>{var E;const{objects:I}=T,U=S(I,e);if(U.length===0)g(!1);else if(U.length>=1){g(!0);const F=((E=U[0])==null?void 0:E.anchorType)||f.SheetDrawingAnchorType.Position;_(F)}});return()=>{y.unsubscribe(),R.unsubscribe()}},[]);function v(R){_(R);const y=e.getFocusDrawings();if(y.length===0)return;const T=y.map(I=>({unitId:I.unitId,subUnitId:I.subUnitId,drawingId:I.drawingId,anchorType:R}));r.executeCommand(Ue.id,{unitId:y[0].unitId,drawings:T})}const C=R=>R?"block":"none";return K.jsxs("div",{className:tt(he.imageCommonPanelGrid,he.imageCommonPanelBorder),style:{display:C(c)},children:[K.jsx("div",{className:he.imageCommonPanelRow,children:K.jsx("div",{className:tt(he.imageCommonPanelColumn,he.imageCommonPanelTitle),children:K.jsx("div",{children:n.t("drawing-anchor.title")})})}),K.jsx("div",{className:tt(he.imageCommonPanelRow),children:K.jsx("div",{className:tt(he.imageCommonPanelColumn),children:K.jsxs(ne.RadioGroup,{value:p,onChange:v,direction:"vertical",children:[K.jsx(ne.Radio,{value:f.SheetDrawingAnchorType.Both,children:n.t("drawing-anchor.both")}),K.jsx(ne.Radio,{value:f.SheetDrawingAnchorType.Position,children:n.t("drawing-anchor.position")}),K.jsx(ne.Radio,{value:f.SheetDrawingAnchorType.None,children:n.t("drawing-anchor.none")})]})})})]})},Wn=()=>{const i=d.useDependency(O.IDrawingManagerService),r=i.getFocusDrawings(),[n,e]=Q.useState(r);return Q.useEffect(()=>{const t=i.focus$.subscribe(o=>{e(o)});return()=>{t.unsubscribe()}},[]),!!(n!=null&&n.length)&&K.jsxs("div",{className:he.imageCommonPanel,children:[K.jsx(ue.DrawingCommonPanel,{drawings:n}),K.jsx(jn,{drawings:n})]})},Bn={[Y.RibbonStartGroup.FORMULAS_INSERT]:{[vt]:{order:3,menuItemFactory:An,[et.id]:{order:0,menuItemFactory:Un},[_t.id]:{order:1,menuItemFactory:Nn}}}};function We(i){return!i.getContextValue(d.FOCUSING_FX_BAR_EDITOR)&&!i.getContextValue(d.EDITOR_ACTIVATED)&&!i.getContextValue(d.FOCUSING_PANEL_EDITOR)&&i.getContextValue(d.FOCUSING_COMMON_DRAWINGS)}const kn={id:Re.id,description:"shortcut.sheet.drawing-move-down",group:"4_sheet-drawing-view",binding:Y.KeyCode.ARROW_DOWN,priority:100,preconditions:We,staticParameters:{direction:d.Direction.DOWN}},Ln={id:Re.id,description:"shortcut.sheet.drawing-move-up",group:"4_sheet-drawing-view",binding:Y.KeyCode.ARROW_UP,priority:100,preconditions:We,staticParameters:{direction:d.Direction.UP}},Gn={id:Re.id,description:"shortcut.sheet.drawing-move-left",group:"4_sheet-drawing-view",binding:Y.KeyCode.ARROW_LEFT,priority:100,preconditions:We,staticParameters:{direction:d.Direction.LEFT}},Fn={id:Re.id,description:"shortcut.sheet.drawing-move-right",group:"4_sheet-drawing-view",binding:Y.KeyCode.ARROW_RIGHT,priority:100,preconditions:We,staticParameters:{direction:d.Direction.RIGHT}},$n={id:St.id,description:"shortcut.sheet.drawing-delete",group:"4_sheet-drawing-view",preconditions:We,binding:Y.KeyCode.DELETE,mac:Y.KeyCode.BACKSPACE};var Hn=Object.defineProperty,Yn=Object.getOwnPropertyDescriptor,Vn=(i,r,n,e)=>{for(var t=e>1?void 0:e?Yn(r,n):r,o=i.length-1,a;o>=0;o--)(a=i[o])&&(t=(e?a(r,n,t):a(t))||t);return e&&t&&Hn(r,n,t),t},nt=(i,r)=>(n,e)=>r(n,e,i);let rt=class extends d.Disposable{constructor(i,r,n,e){super(),this._componentManager=i,this._menuManagerService=r,this._commandService=n,this._shortcutService=e,this._init()}_initCustomComponents(){const i=this._componentManager;this.disposeWithMe(i.register(Bt,Wt)),this.disposeWithMe(i.register(Et,Wn))}_initMenus(){this._menuManagerService.mergeMenu(Bn)}_initCommands(){[et,_t,Ae,Oe,Ue,st,$,ct,ut,gt,Re,St,mt].forEach(i=>this.disposeWithMe(this._commandService.registerCommand(i)))}_initShortcuts(){[kn,Ln,Gn,Fn,$n].forEach(i=>{this.disposeWithMe(this._shortcutService.registerShortcut(i))})}_init(){this._initCommands(),this._initCustomComponents(),this._initMenus(),this._initShortcuts()}};rt=Vn([nt(0,d.Inject(Y.ComponentManager)),nt(1,Y.IMenuManagerService),nt(2,d.ICommandService),nt(3,Y.IShortcutService)],rt);var xn=Object.defineProperty,Xn=Object.getOwnPropertyDescriptor,Kn=(i,r,n,e)=>{for(var t=e>1?void 0:e?Xn(r,n):r,o=i.length-1,a;o>=0;o--)(a=i[o])&&(t=(e?a(r,n,t):a(t))||t);return e&&t&&xn(r,n,t),t},ve=(i,r)=>(n,e)=>r(n,e,i);function zn(i,r,n,e,t){const{scaleX:o,scaleY:a}=r.getAncestorScale(),s=r.getViewport(N.SHEET_VIEWPORT_KEY.VIEW_MAIN),l={left:!0,top:!0};if(!s)return{...i,absolute:l};const{left:h,right:u,top:c,bottom:g}=i;let{top:m,left:p,viewportScrollX:_,viewportScrollY:S}=s;const{boundsOfViewArea:v,scrollDirectionResponse:C}=t||{};v&&(d.Tools.isDefine(v.top)&&(m=v.top),d.Tools.isDefine(v.left)&&(p=v.left)),C==="HORIZONTAL"&&(S=0),C==="VERTICAL"&&(_=0);let D,R;h<p?(l.left=!0,D=(p+(h-p))*o,R=Math.max(Math.min((p+(u-p))*o,p*o),(u-_)*o)):(l.left=!1,D=Math.max((h-_)*o,p*o),R=Math.max((u-_)*o,p*o));let y,T;return c<m?(l.top=!0,y=(m+(c-m))*a,T=Math.max(Math.min((m+(u-m))*a,m*a),(g-S)*a)):(l.top=!1,y=Math.max((c-S)*a,m*a),T=Math.max((g-S)*a,m*a)),{left:D,right:R,top:y,bottom:T,absolute:l}}const we=(i,r,n,e,t)=>{const{scene:o}=r,{left:a,top:s,width:l,height:h,angle:u}=i,c={left:a,right:a+l,top:s,bottom:s+h},g=zn(c,o,n,e,t),{scaleX:m,scaleY:p}=o.getAncestorScale();return{startX:g.left,endX:g.right,startY:g.top,endY:g.bottom,rotate:u,width:l*m,height:h*p,absolute:g.absolute}};b.SheetCanvasFloatDomManagerService=class extends d.Disposable{constructor(n,e,t,o,a,s,l){super();q(this,"_domLayerMap",new Map);q(this,"_domLayerInfoMap",new Map);q(this,"_transformChange$",new j.Subject);q(this,"transformChange$",this._transformChange$.asObservable());q(this,"_add$",new j.Subject);q(this,"add$",this._add$.asObservable());q(this,"_remove$",new j.Subject);q(this,"remove$",this._remove$.asObservable());q(this,"_hooks",[]);this._renderManagerService=n,this._univerInstanceService=e,this._commandService=t,this._drawingManagerService=o,this._canvasFloatDomService=a,this._sheetDrawingService=s,this._lifecycleService=l,this._drawingAddListener(),this._featureUpdateListener(),this._deleteListener(),this._bindScrollEvent()}_bindScrollEvent(){this._lifecycleService.lifecycle$.pipe(j.filter(n=>n===d.LifecycleStages.Rendered),j.take(1)).subscribe(()=>{this._scrollUpdateListener()})}_ensureMap(n,e){let t=this._domLayerMap.get(n);t||(t=new Map,this._domLayerMap.set(n,t));let o=t.get(e);return o||(o=new Map,t.set(e,o)),o}getFloatDomInfo(n){return this._domLayerInfoMap.get(n)}_getSceneAndTransformerByDrawingSearch(n){if(n==null)return;const e=this._renderManagerService.getRenderById(n),t=e==null?void 0:e.scene;if(e==null||t==null)return null;const o=t.getTransformerByCreate(),a=e.engine.getCanvasElement();return{scene:t,transformer:o,renderUnit:e,canvas:a}}_getFloatDomProps(n){let e;return this._hooks.forEach(t=>{e=t.onGetFloatDomProps(n)}),e}_drawingAddListener(){this.disposeWithMe(this._drawingManagerService.add$.subscribe(n=>{n.forEach(e=>{var Ie,pe,ae;const{unitId:t,subUnitId:o,drawingId:a}=e,s=w.getSheetCommandTarget(this._univerInstanceService,{unitId:t,subUnitId:o}),l=this._drawingManagerService.getDrawingByParam(e),h=this._univerInstanceService.getUnit(t,d.UniverInstanceType.UNIVER_SHEET);if(!h)return;const u=h.getActiveSheet().getSheetId();if(!l||!s)return;const c=(Ie=this._renderManagerService.getRenderById(t))==null?void 0:Ie.with(P.SheetSkeletonManagerService).getWorksheetSkeleton(o);if(!c)return;const{transform:g,drawingType:m,data:p}=l;if(m!==d.DrawingTypeEnum.DRAWING_DOM&&m!==d.DrawingTypeEnum.DRAWING_CHART)return;const _=this._getSceneAndTransformerByDrawingSearch(t);if(_==null)return;const{scene:S,canvas:v}=_;if(g==null)return!0;if(u!==o)return;const{left:C,top:D,width:R,height:y,angle:T,flipX:I,flipY:U,skewX:E,skewY:F}=g,B=O.getDrawingShapeKeyByDrawingSearch({unitId:t,subUnitId:o,drawingId:a}),A=S.getObject(B);if(A!=null){A.transformByState({left:C,top:D,width:R,height:y,angle:T,flipX:I,flipY:U,skewX:E,skewY:F});return}const M={left:C,top:D,width:R,height:y,zIndex:this._drawingManagerService.getDrawingOrder(t,o).length-1},L=m===d.DrawingTypeEnum.DRAWING_CHART;if(L){const H=p?p.backgroundColor:"white";M.fill=H,M.rotateEnabled=!1,p&&p.border&&(M.stroke=p.border),M.paintFirst="stroke",M.strokeWidth=1,M.borderEnabled=!1,M.radius=8}const G=new N.Rect(B,M);L&&G.setObjectType(N.ObjectType.CHART),S.addObject(G,N.DRAWING_OBJECT_LAYER_INDEX),l.allowTransform!==!1&&S.attachTransformerTo(G);const x=this._ensureMap(t,o),W=new d.DisposableCollection,X=we(G,_.renderUnit,c.skeleton,s.worksheet),J=new j.BehaviorSubject(X),ie={dispose:W,rect:G,position$:J,unitId:t,subUnitId:o};this._canvasFloatDomService.addFloatDom({position$:J,id:a,componentKey:l.componentKey,onPointerDown:H=>{v.dispatchEvent(new PointerEvent(H.type,H))},onPointerMove:H=>{v.dispatchEvent(new PointerEvent(H.type,H))},onPointerUp:H=>{v.dispatchEvent(new PointerEvent(H.type,H))},onWheel:H=>{v.dispatchEvent(new WheelEvent(H.type,H))},props:(ae=(pe=x.get(a))==null?void 0:pe.props)!=null?ae:this._getFloatDomProps(a),data:p,unitId:t});const oe=G.onTransformChange$.subscribeEvent(()=>{const H=we(G,_.renderUnit,c.skeleton,s.worksheet);J.next(H)});W.add(()=>{this._canvasFloatDomService.removeFloatDom(a)}),oe&&W.add(oe),this._domLayerInfoMap.set(a,ie),x.set(a,{...x.get(a)})})})),this.disposeWithMe(this._drawingManagerService.remove$.subscribe(n=>{n.forEach(e=>{const{unitId:t,subUnitId:o,drawingId:a}=e,s=O.getDrawingShapeKeyByDrawingSearch({unitId:t,subUnitId:o,drawingId:a}),l=this._getSceneAndTransformerByDrawingSearch(t);if(l==null)return;const{transformer:h,scene:u}=l,c=u.getObject(s);c!=null&&c.oKey&&h.clearControlByIds([c==null?void 0:c.oKey])})}))}_scrollUpdateListener(){const n=(e,t)=>{var u;const o=this._getSceneAndTransformerByDrawingSearch(e),a=this._ensureMap(e,t),s=Array.from(a.keys()),l=w.getSheetCommandTarget(this._univerInstanceService,{unitId:e,subUnitId:t}),h=(u=this._renderManagerService.getRenderById(e))==null?void 0:u.with(P.SheetSkeletonManagerService).getWorksheetSkeleton(t);!o||!l||!h||s.forEach(c=>{const g=this._domLayerInfoMap.get(c);if(g){const m=we(g.rect,o.renderUnit,h.skeleton,l.worksheet,g);g.position$.next(m)}})};this.disposeWithMe(this._univerInstanceService.getCurrentTypeOfUnit$(d.UniverInstanceType.UNIVER_SHEET).pipe(j.filter(e=>!!e),j.switchMap(e=>e.activeSheet$),j.filter(e=>!!e),j.map(e=>{const t=this._renderManagerService.getRenderById(e.getUnitId());return t?{render:t,unitId:e.getUnitId(),subUnitId:e.getSheetId()}:null}),j.filter(e=>!!e),j.switchMap(e=>d.fromEventSubject(e.render.scene.getViewport(N.SHEET_VIEWPORT_KEY.VIEW_MAIN).onScrollAfter$).pipe(j.map(()=>({unitId:e.unitId,subUnitId:e.subUnitId}))))).subscribe(({unitId:e,subUnitId:t})=>{n(e,t)})),this.disposeWithMe(this._commandService.onCommandExecuted(e=>{var t,o;if(e.id===P.SetZoomRatioOperation.id){const a=e.params,{unitId:s}=a;Array.from((o=(t=this._domLayerMap.get(s))==null?void 0:t.keys())!=null?o:[]).forEach(h=>{n(s,h)})}else if(e.id===w.SetFrozenMutation.id){const{unitId:a,subUnitId:s}=e.params;n(a,s)}}))}_getPosition(n,e){var m;const{startX:t,endX:o,startY:a,endY:s}=n,l=(m=this._renderManagerService.getRenderById(e))==null?void 0:m.with(P.ISheetSelectionRenderService);if(l==null)return;const h=l.getCellWithCoordByOffset(t,a);if(h==null)return;const u={column:h.actualColumn,columnOffset:t-h.startX,row:h.actualRow,rowOffset:a-h.startY},c=l.getCellWithCoordByOffset(o,s);if(c==null)return;const g={column:c.actualColumn,columnOffset:o-c.startX,row:c.actualRow,rowOffset:s-c.startY};return{from:u,to:g}}_featureUpdateListener(){this.disposeWithMe(this._drawingManagerService.update$.subscribe(n=>{n.forEach(e=>{const t=this._drawingManagerService.getDrawingByParam(e);if(!t||t.drawingType!==d.DrawingTypeEnum.DRAWING_DOM&&t.drawingType!==d.DrawingTypeEnum.DRAWING_CHART)return;const o={...t.transform};this._transformChange$.next({id:e.drawingId,value:o})})}))}_deleteListener(){this.disposeWithMe(this._drawingManagerService.remove$.subscribe(n=>{n.forEach(e=>{this._removeDom(e.drawingId)})}))}updateFloatDomProps(n,e,t,o){const a=this._domLayerInfoMap.get(t),s=this._getSceneAndTransformerByDrawingSearch(n);if(a&&s){const{scene:l}=s,h=O.getDrawingShapeKeyByDrawingSearch({unitId:n,subUnitId:e,drawingId:t}),u=l.getObject(h);u&&u instanceof N.Rect&&u.setProps(o)}}addFloatDomToPosition(n,e){const t=w.getSheetCommandTarget(this._univerInstanceService,{unitId:n.unitId,subUnitId:n.subUnitId});if(!t)throw new Error("cannot find current target!");const{unitId:o,subUnitId:a}=t,{initPosition:s,componentKey:l,data:h,allowTransform:u=!0}=n,c=e!=null?e:d.generateRandomId(),g=this._getPosition(s,o);if(g==null)return;this._ensureMap(o,a).set(c,n);const p={unitId:o,subUnitId:a,drawingId:c,drawingType:n.type||d.DrawingTypeEnum.DRAWING_DOM,componentKey:l,sheetTransform:g,transform:{left:s.startX,top:s.startY,width:s.endX-s.startX,height:s.endY-s.startY},data:h,allowTransform:u};return this._commandService.executeCommand(Ae.id,{unitId:o,drawings:[p]}),this._add$.next({unitId:o,subUnitId:a,id:c}),{id:c,dispose:()=>{this._removeDom(c,!0)}}}_removeDom(n,e=!1){const t=this._domLayerInfoMap.get(n);if(!t)return;const{unitId:o,subUnitId:a}=t;this._domLayerInfoMap.delete(n),t.dispose.dispose();const s=this._getSceneAndTransformerByDrawingSearch(o);if(s&&s.scene.removeObject(t.rect),e){this._ensureMap(o,a).delete(n);const h=this._drawingManagerService.getDrawingByParam({unitId:o,subUnitId:a,drawingId:n});if(!h)return;const u=this._sheetDrawingService.getBatchRemoveOp([h]),{redo:c,objects:g}=u;this._commandService.syncExecuteCommand(f.SetDrawingApplyMutation.id,{unitId:o,subUnitId:a,op:c,objects:g,type:f.DrawingApplyType.REMOVE})}}addHook(n){return this._hooks.push(n),{dispose:()=>{const e=this._hooks.findIndex(t=>t===n);this._hooks.splice(e,1)}}}addFloatDomToRange(n,e,t,o){var F,B,A,M,L,G;const a=w.getSheetCommandTarget(this._univerInstanceService,{unitId:e.unitId,subUnitId:e.subUnitId});if(!a)throw new Error("cannot find current target!");const{unitId:s,subUnitId:l}=a;if(!this._getSceneAndTransformerByDrawingSearch(s))return;const u=this._renderManagerService.getRenderById(s);if(!u)return;const c=(F=this._renderManagerService.getRenderById(s))==null?void 0:F.with(P.SheetSkeletonManagerService).getWorksheetSkeleton(l);if(!c)return;const{componentKey:g,data:m,allowTransform:p=!0}=e,_=o!=null?o:d.generateRandomId(),{position:S}=this._createRangePositionObserver(n,u,c.skeleton),v=this._getPosition(S,s);if(v==null)return;this._ensureMap(s,l).set(_,e);const D=S.endX-S.startX,R=S.endY-S.startY,y=(B=t.width)!=null?B:D,T=(A=t.height)!=null?A:R,I=S.startX+be(t.marginX,D),U=S.startY+be(t.marginY,R),E={unitId:s,subUnitId:l,drawingId:_,drawingType:e.type||d.DrawingTypeEnum.DRAWING_DOM,componentKey:g,sheetTransform:v,transform:{left:I,top:U,width:y,height:T},data:m,allowTransform:p};{const{unitId:x,subUnitId:W,drawingId:X}=E,J=w.getSheetCommandTarget(this._univerInstanceService,{unitId:x,subUnitId:W}),ie=E,oe=this._univerInstanceService.getUnit(x,d.UniverInstanceType.UNIVER_SHEET);if(!oe)return;const Ie=oe.getActiveSheet().getSheetId();if(!ie||!J)return;const pe=(M=this._renderManagerService.getRenderById(x))==null?void 0:M.with(P.SheetSkeletonManagerService).getWorksheetSkeleton(W);if(!pe)return;const{transform:ae,drawingType:H,data:se}=ie;if(H!==d.DrawingTypeEnum.DRAWING_DOM&&H!==d.DrawingTypeEnum.DRAWING_CHART)return;const Ee=this._getSceneAndTransformerByDrawingSearch(x);if(Ee==null)return;const{scene:ce,canvas:de}=Ee;if(ae==null||Ie!==W)return;const{left:Ce,top:ke,width:Le,height:Ge,angle:it,flipX:It,flipY:Ct,skewX:yt,skewY:Dt}=ae,ot=O.getDrawingShapeKeyByDrawingSearch({unitId:x,subUnitId:W,drawingId:X}),Fe=ce.getObject(ot);if(Fe!=null){Fe.transformByState({left:Ce,top:ke,width:Le,height:Ge,angle:it,flipX:It,flipY:Ct,skewX:yt,skewY:Dt});return}const re={left:Ce,top:ke,width:Le,height:Ge,zIndex:this._drawingManagerService.getDrawingOrder(x,W).length-1},at=H===d.DrawingTypeEnum.DRAWING_CHART;if(at){const k=se?se.backgroundColor:"white";re.fill=k,re.rotateEnabled=!1,se&&se.border&&(re.stroke=se.border),re.paintFirst="stroke",re.strokeWidth=1,re.borderEnabled=!1,re.radius=8}const Z=new N.Rect(ot,re);at&&Z.setObjectType(N.ObjectType.CHART),ce.addObject(Z,N.DRAWING_OBJECT_LAYER_INDEX),ie.allowTransform!==!1&&ce.attachTransformerTo(Z);const ye=this._ensureMap(x,W),De=new d.DisposableCollection,fe=ce.getMainViewport(),Mt={top:fe.top,left:fe.left,bottom:fe.bottom,right:fe.right},le={dispose:De,rect:Z,boundsOfViewArea:Mt,unitId:x,subUnitId:W},Tt=we(Z,Ee.renderUnit,pe.skeleton,J.worksheet,le),Me=new j.BehaviorSubject(Tt);le.position$=Me;let Te={position$:Me,id:X,componentKey:ie.componentKey,onPointerDown:()=>{},onPointerMove:()=>{},onPointerUp:()=>{},onWheel:k=>{de.dispatchEvent(new WheelEvent(k.type,k))},props:(G=(L=ye.get(X))==null?void 0:L.props)!=null?G:this._getFloatDomProps(X),data:se,unitId:x};e.eventPassThrough&&(Te={...Te,onPointerDown:k=>{de.dispatchEvent(new PointerEvent(k.type,k))},onPointerMove:k=>{de.dispatchEvent(new PointerEvent(k.type,k))},onPointerUp:k=>{de.dispatchEvent(new PointerEvent(k.type,k))}}),this._canvasFloatDomService.addFloatDom(Te);const $e=Z.onTransformChange$.subscribeEvent(()=>{const k=we(Z,Ee.renderUnit,pe.skeleton,J.worksheet,le);Me.next(k)});De.add(()=>{this._canvasFloatDomService.removeFloatDom(X)}),$e&&De.add($e),this._domLayerInfoMap.set(X,le),ye.set(X,{...ye.get(X)})}return{id:_,dispose:()=>{this._removeDom(_,!0)}}}addFloatDomToColumnHeader(n,e,t,o){var B,A,M,L,G,x;const a=w.getSheetCommandTarget(this._univerInstanceService,{unitId:e.unitId,subUnitId:e.subUnitId});if(!a)throw new Error("cannot find current target!");const{unitId:s,subUnitId:l}=a;if(!this._getSceneAndTransformerByDrawingSearch(s))return;const u=this._renderManagerService.getRenderById(s);if(!u)return;const c=(B=this._renderManagerService.getRenderById(s))==null?void 0:B.with(P.SheetSkeletonManagerService).getWorksheetSkeleton(l);if(!c)return;const{componentKey:g,data:m,allowTransform:p=!0}=e,_=o!=null?o:d.generateRandomId(),{position:S}=this._createRangePositionObserver({startRow:0,endRow:0,startColumn:n,endColumn:n},u,c.skeleton),v=S;v.startY=0;const C=this._getPosition(S,s);if(C==null)return;this._ensureMap(s,l).set(_,e);const R=S.endX-S.startX,y=S.endY-S.startY,T=(A=t.width)!=null?A:R,I=(M=t.height)!=null?M:y;let U=0,E=0;if(t.horizonOffsetAlign==="right"){const W=be(t.marginX,R);U=v.endX-W-T}else U=v.startX+be(t.marginX,R);if(t.verticalOffsetAlign==="bottom"){const W=be(t.marginY,y);E=v.endY-W-I}else E=v.startY+be(t.marginY,y);const F={unitId:s,subUnitId:l,drawingId:_,drawingType:e.type||d.DrawingTypeEnum.DRAWING_DOM,componentKey:g,sheetTransform:C,transform:{left:U,top:E,width:T,height:I},data:m,allowTransform:p};{const{unitId:W,subUnitId:X,drawingId:J}=F,ie=w.getSheetCommandTarget(this._univerInstanceService,{unitId:W,subUnitId:X}),oe=F,Ie=this._univerInstanceService.getUnit(W,d.UniverInstanceType.UNIVER_SHEET);if(!Ie)return;const pe=Ie.getActiveSheet().getSheetId();if(!oe||!ie)return;const ae=(L=this._renderManagerService.getRenderById(W))==null?void 0:L.with(P.SheetSkeletonManagerService).getWorksheetSkeleton(X);if(!ae)return;const{transform:H,drawingType:se,data:Ee}=oe;if(se!==d.DrawingTypeEnum.DRAWING_DOM&&se!==d.DrawingTypeEnum.DRAWING_CHART)return;const ce=this._getSceneAndTransformerByDrawingSearch(W);if(ce==null)return;const{scene:de,canvas:Ce}=ce;if(H==null||pe!==X)return;const{left:ke,top:Le,width:Ge,height:it,angle:It,flipX:Ct,flipY:yt,skewX:Dt,skewY:ot}=H,Fe=O.getDrawingShapeKeyByDrawingSearch({unitId:W,subUnitId:X,drawingId:J}),re=de.getObject(Fe);if(re!=null){re.transformByState({left:ke,top:Le,width:Ge,height:it,angle:It,flipX:Ct,flipY:yt,skewX:Dt,skewY:ot});return}const at={left:ke,top:Le,width:Ge,height:it,zIndex:this._drawingManagerService.getDrawingOrder(W,X).length-1},Z=new N.Rect(Fe,at);de.addObject(Z,N.DRAWING_OBJECT_LAYER_INDEX),oe.allowTransform!==!1&&de.attachTransformerTo(Z);const ye=this._ensureMap(W,X),De=new d.DisposableCollection,fe=de.getMainViewport(),Mt={top:0,left:fe.left,bottom:fe.bottom,right:fe.right},le={dispose:De,rect:Z,unitId:W,subUnitId:X,boundsOfViewArea:Mt,scrollDirectionResponse:"HORIZONTAL"},Tt=we(Z,ce.renderUnit,ae.skeleton,ie.worksheet,le),Me=new j.BehaviorSubject(Tt);le.position$=Me;let Te={position$:Me,id:J,componentKey:oe.componentKey,onPointerDown:()=>{},onPointerMove:()=>{},onPointerUp:()=>{},onWheel:k=>{Ce.dispatchEvent(new WheelEvent(k.type,k))},props:(x=(G=ye.get(J))==null?void 0:G.props)!=null?x:this._getFloatDomProps(J),data:Ee,unitId:W};e.eventPassThrough&&(Te={...Te,onPointerDown:k=>{Ce.dispatchEvent(new PointerEvent(k.type,k))},onPointerMove:k=>{Ce.dispatchEvent(new PointerEvent(k.type,k))},onPointerUp:k=>{Ce.dispatchEvent(new PointerEvent(k.type,k))}}),this._canvasFloatDomService.addFloatDom(Te);const $e=Z.onTransformChange$.subscribeEvent(()=>{const k=we(Z,ce.renderUnit,ae.skeleton,ie.worksheet,le);Me.next(k)});De.add(()=>{this._canvasFloatDomService.removeFloatDom(J)}),$e&&De.add($e),this._domLayerInfoMap.set(J,le),ye.set(J,{...ye.get(J)})}return{id:_,dispose:()=>{this._removeDom(_,!0)}}}_createRangePositionObserver(n,e,t){let{startRow:o,startColumn:a}=n;const s=Be(o,a,t),l=new j.BehaviorSubject(s),h=Be(n.endRow,n.endColumn,t),u=new j.BehaviorSubject(h),c=()=>{const v=Be(o,a,t),C=Be(n.endRow,n.endColumn,t);l.next(v),u.next(C)},g=new d.DisposableCollection;g.add(e.engine.clientRect$.subscribe(()=>c())),g.add(this._commandService.onCommandExecuted(v=>{if(v.id===w.SetWorksheetRowAutoHeightMutation.id&&v.params.rowsAutoHeightInfo.findIndex(D=>D.row===o)>-1){c();return}(w.COMMAND_LISTENER_SKELETON_CHANGE.indexOf(v.id)>-1||v.id===P.SetScrollOperation.id||v.id===P.SetZoomRatioOperation.id)&&c()}));const m=(v,C)=>{o=v,a=C,c()},p=()=>({rotate:0,width:h.right-s.left,height:h.bottom-s.top,absolute:{left:!0,top:!0},startX:s.left,startY:s.top,endX:h.right,endY:h.bottom}),_=l.pipe(j.map(v=>{const C=Be(n.endRow,n.endColumn,t);return console.log("service",v.left,v.top),{rotate:0,width:C.right-v.left,height:C.bottom-v.top,absolute:{left:!0,top:!0},startX:v.left,startY:v.top,endX:C.right,endY:C.bottom}})),S=p();return console.log("init position",S),{position$:_,position:S,updateRowCol:m,topLeftPos$:l,rightBottomPos$:u,disposable:g}}},b.SheetCanvasFloatDomManagerService=Kn([ve(0,d.Inject(N.IRenderManagerService)),ve(1,d.IUniverInstanceService),ve(2,d.Inject(d.ICommandService)),ve(3,O.IDrawingManagerService),ve(4,d.Inject(Y.CanvasFloatDomService)),ve(5,f.ISheetDrawingService),ve(6,d.Inject(d.LifecycleService))],b.SheetCanvasFloatDomManagerService);function Be(i,r,n){const e=n.getCellWithCoordByIndex(i,r),t=e.isMergedMainCell?e.mergeInfo:e;return{left:t.startX,right:t.endX,top:t.startY,bottom:t.endY}}function be(i,r){if(i===void 0)return 0;if(typeof i=="number")return i;const n=Number.parseFloat(i);return r*n/100}var Lt=Object.defineProperty,Jn=Object.getOwnPropertyDescriptor,Zn=(i,r,n)=>r in i?Lt(i,r,{enumerable:!0,configurable:!0,writable:!0,value:n}):i[r]=n,qn=(i,r,n,e)=>{for(var t=e>1?void 0:e?Jn(r,n):r,o=i.length-1,a;o>=0;o--)(a=i[o])&&(t=(e?a(r,n,t):a(t))||t);return e&&t&&Lt(r,n,t),t},wt=(i,r)=>(n,e)=>r(n,e,i),Gt=(i,r,n)=>Zn(i,typeof r!="symbol"?r+"":r,n);const Qn="SHEET_IMAGE_UI_PLUGIN";b.UniverSheetsDrawingUIPlugin=class extends d.Plugin{constructor(r=bt,n,e,t){super(),this._config=r,this._injector=n,this._renderManagerService=e,this._configService=t;const{menu:o,...a}=d.merge({},bt,this._config);o&&this._configService.setConfig("menu",o,{merge:!0}),this._configService.setConfig(Ft,a)}onStarting(){d.registerDependencies(this._injector,[[b.SheetCanvasFloatDomManagerService],[rt],[Ye],[Qe],[Ze],[Je],[xe],[ze],[Xe]]),d.touchDependencies(this._injector,[[b.SheetCanvasFloatDomManagerService]])}onReady(){d.touchDependencies(this._injector,[[Je]])}onRendered(){this._registerRenderModules(),d.touchDependencies(this._injector,[[Ze],[Qe],[rt],[xe],[ze],[Xe]])}onSteady(){this._injector.get(Ye)}_registerRenderModules(){[[Ne],[ft],[lt]].forEach(r=>{this.disposeWithMe(this._renderManagerService.registerRenderModule(d.UniverInstanceType.UNIVER_SHEET,r))})}},Gt(b.UniverSheetsDrawingUIPlugin,"type",d.UniverInstanceType.UNIVER_SHEET),Gt(b.UniverSheetsDrawingUIPlugin,"pluginName",Qn),b.UniverSheetsDrawingUIPlugin=qn([d.DependentOn(O.UniverDrawingPlugin,Se.UniverDocsDrawingPlugin,ue.UniverDrawingUIPlugin,f.UniverSheetsDrawingPlugin),wt(1,d.Inject(d.Injector)),wt(2,N.IRenderManagerService),wt(3,d.IConfigService)],b.UniverSheetsDrawingUIPlugin),b.ClearSheetDrawingTransformerOperation=$,b.DeleteDrawingsCommand=St,b.EditSheetDrawingOperation=ct,b.GroupSheetDrawingCommand=ut,b.InsertFloatImageCommand=et,b.InsertSheetDrawingCommand=Ae,b.MoveDrawingsCommand=Re,b.RemoveSheetDrawingCommand=Oe,b.SHEETS_IMAGE_MENU_ID=vt,b.SetDrawingArrangeCommand=mt,b.SetSheetDrawingCommand=Ue,b.SidebarSheetDrawingOperation=st,b.UngroupSheetDrawingCommand=gt,Object.defineProperty(b,Symbol.toStringTag,{value:"Module"})});


// @univerjs/sheets-drawing-ui/facade
(function(s,g){typeof exports=="object"&&typeof module<"u"?g(require("@univerjs/core"),require("@univerjs/drawing"),require("@univerjs/engine-render"),require("@univerjs/sheets-drawing-ui"),require("@univerjs/sheets-ui"),require("@univerjs/sheets-drawing"),require("@univerjs/sheets-ui/facade"),require("@univerjs/sheets/facade"),require("@univerjs/ui")):typeof define=="function"&&define.amd?define(["@univerjs/core","@univerjs/drawing","@univerjs/engine-render","@univerjs/sheets-drawing-ui","@univerjs/sheets-ui","@univerjs/sheets-drawing","@univerjs/sheets-ui/facade","@univerjs/sheets/facade","@univerjs/ui"],g):(s=typeof globalThis<"u"?globalThis:s||self,g(s.UniverCore,s.UniverDrawing,s.UniverEngineRender,s.UniverSheetsDrawingUi,s.UniverSheetsUi,s.UniverSheetsDrawing,s.UniverSheetsUiFacade,s.UniverSheetsFacade,s.UniverUi))})(this,function(s,g,I,d,f,l,_,y,p){"use strict";var U=Object.defineProperty;var q=(s,g,I)=>g in s?U(s,g,{enumerable:!0,configurable:!0,writable:!0,value:I}):s[g]=I;var R=(s,g,I)=>q(s,typeof g!="symbol"?g+"":g,I);var j=Object.defineProperty,T=Object.getOwnPropertyDescriptor,E=(i,t,e,r)=>{for(var n=r>1?void 0:r?T(t,e):t,a=i.length-1,o;a>=0;a--)(o=i[a])&&(n=(r?o(t,e,n):o(n))||n);return r&&n&&j(t,e,n),n},b=(i,t)=>(e,r)=>t(e,r,i);function B(i,t){const{from:e,to:r,flipY:n=!1,flipX:a=!1,angle:o=0,skewX:m=0,skewY:c=0}=i.sheetTransform,{column:v,columnOffset:h,row:S,rowOffset:C}=e,k=f.convertPositionSheetOverGridToAbsolute(i.unitId,i.subUnitId,{from:e,to:r},t),{left:D,top:G,width:O,height:W}=k;return{...i,column:v,columnOffset:h,row:S,rowOffset:C,width:O,height:W,flipY:n,flipX:a,angle:o,skewX:m,skewY:c}}function F(i,t,e){const{column:r,columnOffset:n,row:a,rowOffset:o,flipY:m=!1,flipX:c=!1,angle:v=0,skewX:h=0,skewY:S=0,width:C,height:k}=i,D=f.convertPositionCellToSheetOverGrid(i.unitId,i.subUnitId,{column:r,columnOffset:n,row:a,rowOffset:o},C,k,t,e),{sheetTransform:G,transform:O}=D;return{...i,sheetTransform:{...G,flipY:m,flipX:c,angle:v,skewX:h,skewY:S},transform:{...O,flipY:m,flipX:c,angle:v,skewX:h,skewY:S}}}let w=class{constructor(i,t,e){R(this,"_image");this._injector=e,this._image={drawingId:s.generateRandomId(6),drawingType:s.DrawingTypeEnum.DRAWING_IMAGE,imageSourceType:s.ImageSourceType.BASE64,source:"",unitId:i,subUnitId:t,column:0,columnOffset:0,row:0,rowOffset:0,width:0,height:0}}setImage(i){const e=this._injector.get(I.IRenderManagerService).getRenderById(i.unitId);if(!e)throw new Error(`Render Unit with unitId ${i.unitId} not found`);const r=e.with(f.SheetSkeletonManagerService);return i.sheetTransform==null&&(i.sheetTransform={from:{column:0,columnOffset:0,row:0,rowOffset:0},to:{column:0,columnOffset:0,row:0,rowOffset:0}}),this._image=B(i,r),this}setSource(i,t){const e=t!=null?t:s.ImageSourceType.URL;return this._image.source=i,this._image.imageSourceType=e,this}getsource(){return this._image.source}getSourceType(){return this._image.imageSourceType}setColumn(i){return this._image.column=i,this}setRow(i){return this._image.row=i,this}setColumnOffset(i){return this._image.columnOffset=i,this}setRowOffset(i){return this._image.rowOffset=i,this}setWidth(i){return this._image.width=i,this}setHeight(i){return this._image.height=i,this}setAnchorType(i){return this._image.anchorType=i,this}setCropTop(i){return this._initializeSrcRect(),this._image.srcRect.top=i,this}setCropLeft(i){return this._initializeSrcRect(),this._image.srcRect.left=i,this}setCropBottom(i){return this._initializeSrcRect(),this._image.srcRect.bottom=i,this}setCropRight(i){return this._initializeSrcRect(),this._image.srcRect.right=i,this}_initializeSrcRect(){this._image.srcRect==null&&(this._image.srcRect={top:0,left:0,bottom:0,right:0})}setRotate(i){return this._image.angle=i,this}setUnitId(i){return this._image.unitId=i,this}setSubUnitId(i){return this._image.subUnitId=i,this}async buildAsync(){const t=this._injector.get(I.IRenderManagerService).getRenderById(this._image.unitId);if(!t)throw new Error(`Render Unit with unitId ${this._image.unitId} not found`);const e=t.with(f.ISheetSelectionRenderService),r=t.with(f.SheetSkeletonManagerService);if(this._image.width===0||this._image.height===0){const n=await g.getImageSize(this._image.source),a=n.width,o=n.height;this._image.width===0&&(this._image.width=a),this._image.height===0&&(this._image.height=o)}return F(this._image,e,r)}};w=E([b(2,s.Inject(s.Injector))],w);let u=class extends s.FBase{constructor(i,t,e){super(),this._image=i,this._commandService=t,this._injector=e}getId(){return this._image.drawingId}getType(){return this._image.drawingType}remove(){return this._commandService.syncExecuteCommand(d.SetSheetDrawingCommand.id,{unitId:this._image.unitId,drawings:[this._image]})}toBuilder(){const i=this._injector.createInstance(w);return i.setImage(this._image),i}setSource(i,t){const e=t!=null?t:s.ImageSourceType.URL;return this._image.source=i,this._image.imageSourceType=e,this._commandService.syncExecuteCommand(d.SetSheetDrawingCommand.id,{unitId:this._image.unitId,drawings:[this._image]})}async setPositionAsync(i,t,e,r){const n=this.toBuilder();n.setColumn(t),n.setRow(i),e!=null&&n.setRowOffset(e),r!=null&&n.setColumnOffset(r);const a=await n.buildAsync();return this._commandService.syncExecuteCommand(d.SetSheetDrawingCommand.id,{unitId:this._image.unitId,drawings:[a]})}async setSizeAsync(i,t){const e=this.toBuilder();e.setWidth(i),e.setHeight(t);const r=await e.buildAsync();return this._commandService.syncExecuteCommand(d.SetSheetDrawingCommand.id,{unitId:this._image.unitId,drawings:[r]})}setCrop(i,t,e,r){return this._image.srcRect==null&&(this._image.srcRect={top:0,left:0,bottom:0,right:0}),i!=null&&(this._image.srcRect.top=i),t!=null&&(this._image.srcRect.left=t),e!=null&&(this._image.srcRect.bottom=e),r!=null&&(this._image.srcRect.right=r),this._commandService.syncExecuteCommand(d.SetSheetDrawingCommand.id,{unitId:this._image.unitId,drawings:[this._image]})}setRotate(i){return this._image.sheetTransform.angle=i,this._commandService.syncExecuteCommand(d.SetSheetDrawingCommand.id,{unitId:this._image.unitId,drawings:[this._image]})}setForward(){return this._commandService.syncExecuteCommand(d.SetDrawingArrangeCommand.id,{unitId:this._image.unitId,subUnitId:this._image.subUnitId,drawingIds:[this._image.drawingId],arrangeType:s.ArrangeTypeEnum.forward})}setBackward(){return this._commandService.syncExecuteCommand(d.SetDrawingArrangeCommand.id,{unitId:this._image.unitId,subUnitId:this._image.subUnitId,drawingIds:[this._image.drawingId],arrangeType:s.ArrangeTypeEnum.backward})}setBack(){return this._commandService.syncExecuteCommand(d.SetDrawingArrangeCommand.id,{unitId:this._image.unitId,subUnitId:this._image.subUnitId,drawingIds:[this._image.drawingId],arrangeType:s.ArrangeTypeEnum.back})}setFront(){return this._commandService.syncExecuteCommand(d.SetDrawingArrangeCommand.id,{unitId:this._image.unitId,subUnitId:this._image.subUnitId,drawingIds:[this._image.drawingId],arrangeType:s.ArrangeTypeEnum.front})}};u=E([b(1,s.ICommandService),b(2,s.Inject(s.Injector))],u);class A extends y.FWorksheet{addFloatDomToPosition(t,e){const r=this._workbook.getUnitId(),n=this._worksheet.getSheetId(),{key:a,disposableCollection:o}=_.transformComponentKey(t,this._injector.get(p.ComponentManager)),c=this._injector.get(d.SheetCanvasFloatDomManagerService).addFloatDomToPosition({...t,componentKey:a,unitId:r,subUnitId:n},e);return c?(o.add(c.dispose),{id:c.id,dispose:()=>{o.dispose(),c.dispose()}}):(o.dispose(),null)}addFloatDomToRange(t,e,r,n){const a=this._workbook.getUnitId(),o=this._worksheet.getSheetId(),{key:m,disposableCollection:c}=_.transformComponentKey(e,this._injector.get(p.ComponentManager)),h=this._injector.get(d.SheetCanvasFloatDomManagerService).addFloatDomToRange(t.getRange(),{...e,componentKey:m,unitId:a,subUnitId:o},r,n);return h?(c.add(h.dispose),{id:h.id,dispose:()=>{c.dispose(),h.dispose()}}):(c.dispose(),null)}addFloatDomToColumnHeader(t,e,r,n){const a=this._workbook.getUnitId(),o=this._worksheet.getSheetId(),{key:m,disposableCollection:c}=_.transformComponentKey(e,this._injector.get(p.ComponentManager)),h=this._injector.get(d.SheetCanvasFloatDomManagerService).addFloatDomToColumnHeader(t,{...e,componentKey:m,unitId:a,subUnitId:o},r,n);return h?(c.add(h.dispose),{id:h.id,dispose:()=>{c.dispose(),h.dispose()}}):(c.dispose(),null)}async insertImage(t,e,r,n,a){const o=this.newOverGridImage();if(typeof t=="string")o.setSource(t);else{const v=await t.getBlob().getDataAsString();o.setSource(v,s.ImageSourceType.BASE64)}e!==void 0?o.setColumn(e):o.setColumn(0),r!==void 0?o.setRow(r):o.setRow(0),n!==void 0?o.setColumnOffset(n):o.setColumnOffset(0),a!==void 0?o.setRowOffset(a):o.setRowOffset(0);const m=await o.buildAsync();return this._commandService.syncExecuteCommand(d.InsertSheetDrawingCommand.id,{unitId:this._fWorkbook.getId(),drawings:[m]})}insertImages(t){const e=t.map(r=>(r.unitId=this._fWorkbook.getId(),r.subUnitId=this.getSheetId(),r));return this._commandService.syncExecuteCommand(d.InsertSheetDrawingCommand.id,{unitId:this._fWorkbook.getId(),drawings:e}),this}deleteImages(t){const e=t.map(r=>({unitId:this._fWorkbook.getId(),drawingId:r.getId(),subUnitId:this.getSheetId(),drawingType:r.getType()}));return this._commandService.syncExecuteCommand(d.RemoveSheetDrawingCommand.id,{unitId:this._fWorkbook.getId(),drawings:e}),this}getImages(){const e=this._injector.get(l.ISheetDrawingService).getDrawingData(this._fWorkbook.getId(),this.getSheetId()),r=[];for(const n in e){const a=e[n];a.drawingType===s.DrawingTypeEnum.DRAWING_IMAGE&&r.push(this._injector.createInstance(u,a))}return r}getImageById(t){const r=this._injector.get(l.ISheetDrawingService).getDrawingByParam({unitId:this._fWorkbook.getId(),subUnitId:this.getSheetId(),drawingId:t});return r&&r.drawingType===s.DrawingTypeEnum.DRAWING_IMAGE?this._injector.createInstance(u,r):null}getActiveImages(){const e=this._injector.get(l.ISheetDrawingService).getFocusDrawings(),r=[];for(const n in e){const a=e[n];r.push(this._injector.createInstance(u,a))}return r}updateImages(t){return this._commandService.syncExecuteCommand(d.SetSheetDrawingCommand.id,{unitId:this._fWorkbook.getId(),drawings:t}),this}onImageInserted(t){const e=this._injector.get(l.ISheetDrawingService);return s.toDisposable(e.add$.subscribe(r=>{const n=r.map(a=>this._injector.createInstance(u,e.getDrawingByParam(a)));t(n)}))}onImageDeleted(t){const e=this._injector.get(l.ISheetDrawingService);return s.toDisposable(e.remove$.subscribe(r=>{const n=r.map(a=>this._injector.createInstance(u,e.getDrawingByParam(a)));t(n)}))}onImageChanged(t){const e=this._injector.get(l.ISheetDrawingService);return s.toDisposable(e.update$.subscribe(r=>{const n=r.map(a=>this._injector.createInstance(u,e.getDrawingByParam(a)));t(n)}))}newOverGridImage(){const t=this._fWorkbook.getId(),e=this.getSheetId();return this._injector.createInstance(w,t,e)}}y.FWorksheet.extend(A);class M extends s.FEnum{get DrawingType(){return s.DrawingTypeEnum}get ImageSourceType(){return s.ImageSourceType}get SheetDrawingAnchorType(){return l.SheetDrawingAnchorType}}s.FEnum.extend(M);class x extends s.FEventName{get BeforeOverGridImageChange(){return"BeforeOverGridImageChange"}get OverGridImageChanged(){return"OverGridImageChanged"}get BeforeOverGridImageInsert(){return"BeforeOverGridImageInsert"}get OverGridImageInserted(){return"OverGridImageInserted"}get BeforeOverGridImageRemove(){return"BeforeOverGridImageRemove"}get OverGridImageRemoved(){return"OverGridImageRemoved"}get BeforeOverGridImageSelect(){return"BeforeOverGridImageSelect"}get OverGridImageSelected(){return"OverGridImageSelected"}}s.FEventName.extend(x);class P extends s.FUniver{_initialize(t){const e=t.get(s.ICommandService);this.disposeWithMe(e.beforeCommandExecuted(r=>{switch(r.id){case d.InsertSheetDrawingCommand.id:this._beforeOverGridImageInsert(r.params);break;case d.RemoveSheetDrawingCommand.id:this._beforeOverGridImageRemove(r.params);break;case d.SetSheetDrawingCommand.id:this._beforeOverGridImageChange(r.params);break;case g.SetDrawingSelectedOperation.id:this._beforeOverGridImageSelect(r.params);break}})),this.disposeWithMe(e.onCommandExecuted(r=>{switch(r.id){case d.InsertSheetDrawingCommand.id:this._overGridImageInserted(r.params);break;case d.RemoveSheetDrawingCommand.id:this._overGridImageRemoved(r.params);break;case d.SetSheetDrawingCommand.id:this._overGridImageChanged(r.params);break;case g.SetDrawingSelectedOperation.id:this._overGridImageSelected(r.params);break}}))}_beforeOverGridImageInsert(t){if(!this.hasEventCallback(this.Event.BeforeOverGridImageInsert))return;const e=this.getActiveWorkbook();if(e==null||t==null)return;const{drawings:r}=t,n={workbook:e,insertImageParams:r};if(this.fireEvent(this.Event.BeforeOverGridImageInsert,n),n.cancel)throw new Error("Canceled by BeforeOverGridImageInsert event")}_overGridImageInserted(t){if(!this.hasEventCallback(this.Event.OverGridImageInserted))return;const e=this.getActiveWorkbook();if(e==null||t==null)return;const{drawings:r}=t;this.fireEvent(this.Event.OverGridImageInserted,{workbook:e,images:this._createFOverGridImage(r)})}_beforeOverGridImageRemove(t){if(!this.hasEventCallback(this.Event.BeforeOverGridImageRemove))return;const e=this.getActiveWorkbook();if(e==null||t==null)return;const{drawings:r}=t,n=this._injector.get(g.IDrawingManagerService),a=r.map(m=>n.getDrawingByParam(m)),o={workbook:e,images:this._createFOverGridImage(a)};if(this.fireEvent(this.Event.BeforeOverGridImageRemove,o),o.cancel)throw new Error("Canceled by BeforeOverGridImageRemove event")}_overGridImageRemoved(t){if(!this.hasEventCallback(this.Event.OverGridImageRemoved))return;const e=this.getActiveWorkbook();if(e==null||t==null)return;const{drawings:r}=t;this.fireEvent(this.Event.OverGridImageRemoved,{workbook:e,removeImageParams:r})}_beforeOverGridImageChange(t){if(!this.hasEventCallback(this.Event.BeforeOverGridImageChange))return;const e=this.getActiveWorkbook();if(e==null||t==null)return;const{drawings:r}=t,n=this._injector.get(g.IDrawingManagerService),a=[];r.forEach(m=>{const c=n.getDrawingByParam(m);c!=null&&a.push({changeParam:m,image:this._injector.createInstance(u,c)})});const o={workbook:e,images:a};if(this.fireEvent(this.Event.BeforeOverGridImageChange,o),o.cancel)throw n.updateNotification(r),new Error("Canceled by BeforeOverGridImageChange event")}_overGridImageChanged(t){if(!this.hasEventCallback(this.Event.OverGridImageChanged))return;const e=this.getActiveWorkbook();if(e==null||t==null)return;const{drawings:r}=t,n=this._injector.get(g.IDrawingManagerService),a=r.map(o=>this._injector.createInstance(u,n.getDrawingByParam(o)));this.fireEvent(this.Event.OverGridImageChanged,{workbook:e,images:a})}_beforeOverGridImageSelect(t){if(!this.hasEventCallback(this.Event.BeforeOverGridImageSelect))return;const e=this._injector.get(g.IDrawingManagerService),r=this.getActiveWorkbook();if(r==null)return;const n=e.getFocusDrawings(),a=t.map(m=>e.getDrawingByParam(m)),o={workbook:r,selectedImages:this._createFOverGridImage(a),oldSelectedImages:this._createFOverGridImage(n)};if(this.fireEvent(this.Event.BeforeOverGridImageSelect,o),o.cancel)throw new Error("Canceled by BeforeOverGridImageSelect event")}_overGridImageSelected(t){if(!this.hasEventCallback(this.Event.OverGridImageSelected))return;const e=this.getActiveWorkbook(),r=this._injector.get(g.IDrawingManagerService);if(e==null)return;const n=t.map(a=>r.getDrawingByParam(a));this.fireEvent(this.Event.OverGridImageSelected,{workbook:e,selectedImages:this._createFOverGridImage(n)})}_createFOverGridImage(t){return t.map(e=>this._injector.createInstance(u,e))}}s.FUniver.extend(P)});


// index
(function(e,i){typeof exports=="object"&&typeof module<"u"?i(exports,require("@univerjs/docs-drawing"),require("@univerjs/drawing"),require("@univerjs/drawing-ui"),require("@univerjs/sheets-drawing"),require("@univerjs/sheets-drawing-ui"),require("@univerjs/sheets-drawing-ui/facade")):typeof define=="function"&&define.amd?define(["exports","@univerjs/docs-drawing","@univerjs/drawing","@univerjs/drawing-ui","@univerjs/sheets-drawing","@univerjs/sheets-drawing-ui","@univerjs/sheets-drawing-ui/facade"],i):(e=typeof globalThis<"u"?globalThis:e||self,i(e.UniverPresetSheetsDrawing={},e.UniverDocsDrawing,e.UniverDrawing,e.UniverDrawingUi,e.UniverSheetsDrawing,e.UniverSheetsDrawingUi))})(this,function(e,i,n,r,s,u){"use strict";function t(a={}){const{collaboration:g=!1}=a;return{plugins:[[n.UniverDrawingPlugin,{override:g?[[n.IImageIoService,null]]:[]}],i.UniverDocsDrawingPlugin,r.UniverDrawingUIPlugin,s.UniverSheetsDrawingPlugin,u.UniverSheetsDrawingUIPlugin].filter(v=>!!v)}}e.UniverSheetsDrawingPreset=t,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})});
