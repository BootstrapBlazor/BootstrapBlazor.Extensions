// @univerjs/docs-drawing/index
(function(t,r){typeof exports=="object"&&typeof module<"u"?r(exports,require("@univerjs/core"),require("@univerjs/drawing")):typeof define=="function"&&define.amd?define(["exports","@univerjs/core","@univerjs/drawing"],r):(t=typeof globalThis<"u"?globalThis:t||self,r(t.UniverDocsDrawing={},t.UniverCore,t.UniverDrawing))})(this,function(t,r,g){"use strict";var P=Object.defineProperty;var N=(t,r,g)=>r in t?P(t,r,{enumerable:!0,configurable:!0,writable:!0,value:g}):t[r]=g;var w=(t,r,g)=>N(t,typeof r!="symbol"?r+"":r,g);var d;const S="docs-drawing.config",h={};class u extends g.UnitDrawingService{}const _=r.createIdentifier("univer.doc.plugin.doc-drawing.service");var U=Object.getOwnPropertyDescriptor,I=(c,i,a,e)=>{for(var n=e>1?void 0:e?U(i,a):i,s=c.length-1,o;s>=0;s--)(o=c[s])&&(n=o(n)||n);return n},D=(c,i)=>(a,e)=>i(a,e,c);const l="DOC_DRAWING_PLUGIN";t.DocDrawingController=class extends r.Disposable{constructor(i,a,e,n){super(),this._docDrawingService=i,this._drawingManagerService=a,this._resourceManagerService=e,this._univerInstanceService=n,this._init()}_init(){this._initSnapshot()}_initSnapshot(){const i=e=>{const n=this._univerInstanceService.getUnit(e,r.UniverInstanceType.UNIVER_DOC);if(n){const s=n.getSnapshot().drawings,o=n.getSnapshot().drawingsOrder,v={data:s!=null?s:{},order:o!=null?o:[]};return JSON.stringify(v)}return""},a=e=>{if(!e)return{data:{},order:[]};try{return JSON.parse(e)}catch{return{data:{},order:[]}}};this.disposeWithMe(this._resourceManagerService.registerPluginResource({pluginName:l,businesses:[r.UniverInstanceType.UNIVER_DOC],toJson:e=>i(e),parseJson:e=>a(e),onUnLoad:e=>{this._setDrawingDataForUnit(e,{data:{},order:[]})},onLoad:(e,n)=>{var s,o;this._setDrawingDataForUnit(e,{data:(s=n.data)!=null?s:{},order:(o=n.order)!=null?o:[]})}}))}_setDrawingDataForUnit(i,a){const e=this._univerInstanceService.getUnit(i);e!=null&&(e.resetDrawing(a.data,a.order),this.loadDrawingDataForUnit(i))}loadDrawingDataForUnit(i){const a=this._univerInstanceService.getUnit(i,r.UniverInstanceType.UNIVER_DOC);if(!a)return!1;const e=i,n=a.getDrawings(),s=a.getDrawingsOrder();if(!n||!s)return!1;Object.keys(n).forEach(v=>{const O=n[v];n[v]={...O}});const o={[e]:{unitId:i,subUnitId:e,data:n,order:s}};return this._docDrawingService.registerDrawingData(i,o),this._drawingManagerService.registerDrawingData(i,o),!0}},t.DocDrawingController=I([D(0,_),D(1,g.IDrawingManagerService),D(2,r.IResourceManagerService),D(3,r.IUniverInstanceService)],t.DocDrawingController);var p=Object.getOwnPropertyDescriptor,C=(c,i,a,e)=>{for(var n=e>1?void 0:e?p(i,a):i,s=c.length-1,o;s>=0;s--)(o=c[s])&&(n=o(n)||n);return n},f=(c,i)=>(a,e)=>i(a,e,c);t.UniverDocsDrawingPlugin=(d=class extends r.Plugin{constructor(i=h,a,e){super(),this._config=i,this._injector=a,this._configService=e;const{...n}=r.merge({},h,this._config);this._configService.setConfig(S,n)}onStarting(){[[t.DocDrawingController],[u],[_,{useClass:u}]].forEach(i=>this._injector.add(i)),r.touchDependencies(this._injector,[[t.DocDrawingController]])}},w(d,"pluginName",l),w(d,"type",r.UniverInstanceType.UNIVER_DOC),d),t.UniverDocsDrawingPlugin=C([f(1,r.Inject(r.Injector)),f(2,r.IConfigService)],t.UniverDocsDrawingPlugin),t.DOCS_DRAWING_PLUGIN=l,t.DocDrawingService=u,t.IDocDrawingService=_,Object.defineProperty(t,Symbol.toStringTag,{value:"Module"})});


// @univerjs/drawing-ui/index
(function(y,h){typeof exports=="object"&&typeof module<"u"?h(exports,require("@univerjs/core"),require("@univerjs/drawing"),require("@univerjs/engine-render"),require("@univerjs/ui"),require("react/jsx-runtime"),require("react"),require("@univerjs/design"),require("rxjs")):typeof define=="function"&&define.amd?define(["exports","@univerjs/core","@univerjs/drawing","@univerjs/engine-render","@univerjs/ui","react/jsx-runtime","react","@univerjs/design","rxjs"],h):(y=typeof globalThis<"u"?globalThis:y||self,h(y.UniverDrawingUi={},y.UniverCore,y.UniverDrawing,y.UniverEngineRender,y.UniverUi,y.React,y.React,y.UniverDesign,y.rxjs))})(this,function(y,h,D,b,V,c,S,$,Ne){"use strict";var Gn=Object.defineProperty;var Vn=(y,h,D)=>h in y?Gn(y,h,{enumerable:!0,configurable:!0,writable:!0,value:D}):y[h]=D;var ee=(y,h,D)=>Vn(y,typeof h!="symbol"?h+"":h,D);var Me;function Xe(a,t,n,e){const r=e.getDrawingByParam(a);if(r==null)return;const i=D.getDrawingShapeKeyByDrawingSearch(a),s=n.getObject(i);if(s&&!(s instanceof b.Group))return;if(s!=null){s.addObject(t);return}const o=new b.Group(i);n.addObject(o,b.DRAWING_OBJECT_LAYER_INDEX).attachTransformerTo(o),o.addObject(t);const{transform:l}=r;l&&o.transformByState({left:l.left,top:l.top,angle:l.angle})}function Ee(a,t){var i;const n=t?a.getUnit(t):a.getFocusedUnit();if(n==null)return;const e=n.getUnitId();let r;return n.type===h.UniverInstanceType.UNIVER_SHEET?r=(i=n.getActiveSheet())==null?void 0:i.getSheetId():(n.type===h.UniverInstanceType.UNIVER_DOC||n.type===h.UniverInstanceType.UNIVER_SLIDE)&&(r=e),{unitId:e,subUnitId:r,current:n}}const Te="COMPONENT_IMAGE_VIEWER";var qe=Object.getOwnPropertyDescriptor,Je=(a,t,n,e)=>{for(var r=e>1?void 0:e?qe(t,n):t,i=a.length-1,s;i>=0;i--)(s=a[i])&&(r=s(r)||r);return r},Pe=(a,t)=>(n,e)=>t(n,e,a);const Be=50;y.DrawingRenderService=class{constructor(t,n,e){this._drawingManagerService=t,this._imageIoService=n,this._dialogService=e}async renderImages(t,n){const{transform:e,drawingType:r,source:i,imageSourceType:s,srcRect:o,prstGeom:l,groupId:m,unitId:d,subUnitId:u,drawingId:f,isMultiTransform:p,transforms:_}=t;if(r!==h.DrawingTypeEnum.DRAWING_IMAGE||!this._drawingManagerService.getDrawingVisible()||e==null)return;const w=p&&_?_:[e],C=[];for(const P of w){const{left:I,top:U,width:M,height:L,angle:N,flipX:O,flipY:E,skewX:j,skewY:R}=P,W=w.indexOf(P),H=D.getDrawingShapeKeyByDrawingSearch({unitId:d,subUnitId:u,drawingId:f},p?W:void 0),ae=n.getObject(H);if(ae!=null){ae.transformByState({left:I,top:U,width:M,height:L,angle:N,flipX:O,flipY:E,skewX:j,skewY:R});continue}const K=this._drawingManagerService.getDrawingOrder(d,u),le=K.indexOf(f),ie={...P,zIndex:le===-1?K.length-1:le},se=this._imageIoService.getImageSourceCache(i,s);let ge=!1;if(se!=null)ie.image=se;else{if(s===D.ImageSourceType.UUID)try{ie.url=await this._imageIoService.getImage(i)}catch(Oe){console.error(Oe);continue}else ie.url=i;ge=!0}if(n.getObject(H))continue;ie.printable=!0;const J=new b.Image(H,ie);ge&&this._imageIoService.addImageSourceCache(i,s,J.getNative()),this._drawingManagerService.getDrawingVisible()&&(n.addObject(J,b.DRAWING_OBJECT_LAYER_INDEX),this._drawingManagerService.getDrawingEditable()&&n.attachTransformerTo(J),m&&Xe({drawingId:m,unitId:d,subUnitId:u},J,n,this._drawingManagerService),l!=null&&J.setPrstGeom(l),o!=null&&J.setSrcRect(o),C.push(J))}return C}renderDrawing(t,n){const e=this._drawingManagerService.getDrawingByParam(t);if(e!=null)switch(e.drawingType){case h.DrawingTypeEnum.DRAWING_IMAGE:return this.renderImages(e,n)}}previewImage(t,n,e,r){const i=`${t}-viewer-dialog`,s=window.innerWidth-Be,o=window.innerHeight-Be,l=this._adjustImageSize(e,r,s,o),m=this._dialogService.open({width:Math.max(l.width,200),id:i,style:{margin:"0",top:"50%",left:"50%",transform:"translate(-50%, -50%)"},children:{label:{name:Te,props:{src:n,width:l.width,height:l.height}}},destroyOnClose:!0,draggable:!1,onClose:()=>{this._dialogService.close(i),m.dispose()}})}_adjustImageSize(t,n,e,r){if(t<=e&&n<=r)return{width:t,height:n};const i=e/t,s=r/n,o=Math.min(i,s);return{width:Math.floor(t*o),height:Math.floor(n*o)}}},y.DrawingRenderService=Je([Pe(0,D.IDrawingManagerService),Pe(1,D.IImageIoService),Pe(2,V.IDialogService)],y.DrawingRenderService);function me(a,t){const n=[];return a.forEach(e=>{const{oKey:r,left:i,top:s,height:o,width:l,angle:m}=e,d=t.getDrawingOKey(r);if(d==null)return n.push(null),!0;const{unitId:u,subUnitId:f,drawingId:p,drawingType:_}=d,w={unitId:u,subUnitId:f,drawingId:p,drawingType:_,transform:{left:i,top:s,height:o,width:l,angle:m}};_===h.DrawingTypeEnum.DRAWING_IMAGE&&(w.srcRect=e.srcRect),n.push(w)}),n}function Ue(a){var t,n,e="";if(typeof a=="string"||typeof a=="number")e+=a;else if(typeof a=="object")if(Array.isArray(a)){var r=a.length;for(t=0;t<r;t++)a[t]&&(n=Ue(a[t]))&&(e&&(e+=" "),e+=n)}else for(n in a)a[n]&&(e&&(e+=" "),e+=n);return e}function B(){for(var a,t,n=0,e="",r=arguments.length;n<r;n++)(a=arguments[n])&&(t=Ue(a))&&(e&&(e+=" "),e+=t);return e}var T=(a=>(a.default="0",a.left="1",a.center="2",a.right="3",a.top="4",a.middle="5",a.bottom="6",a.horizon="7",a.vertical="8",a))(T||{});const Ce={id:"sheet.operation.set-image-align",type:h.CommandType.OPERATION,handler:(a,t)=>!0},g={imageCommonPanelGrid:"univer-image-common-panel-grid",imageCommonPanelBorder:"univer-image-common-panel-border",imageCommonPanelTitle:"univer-image-common-panel-title",imageCommonPanelRow:"univer-image-common-panel-row",imageCommonPanelRowVertical:"univer-image-common-panel-row-vertical",imageCommonPanelColumn:"univer-image-common-panel-column",imageCommonPanelColumnCenter:"univer-image-common-panel-column-center",imageCommonPanelInline:"univer-image-common-panel-inline",imageCommonPanelSpan2:"univer-image-common-panel-span2",imageCommonPanelSpan3:"univer-image-common-panel-span3",imageCommonPanelInput:"univer-image-common-panel-input"},Qe=a=>{const t=V.useDependency(h.ICommandService),n=V.useDependency(h.LocaleService),{alignShow:e}=a,[r,i]=S.useState(T.default),s=[{label:n.t("image-panel.align.default"),value:T.default},{options:[{label:n.t("image-panel.align.left"),value:T.left},{label:n.t("image-panel.align.center"),value:T.center},{label:n.t("image-panel.align.right"),value:T.right}]},{options:[{label:n.t("image-panel.align.top"),value:T.top},{label:n.t("image-panel.align.middle"),value:T.middle},{label:n.t("image-panel.align.bottom"),value:T.bottom}]},{options:[{label:n.t("image-panel.align.horizon"),value:T.horizon},{label:n.t("image-panel.align.vertical"),value:T.vertical}]}];function o(m){i(m),t.executeCommand(Ce.id,{alignType:m})}const l=m=>m?"block":"none";return c.jsxs("div",{className:B(g.imageCommonPanelGrid,g.imageCommonPanelBorder),style:{display:l(e)},children:[c.jsx("div",{className:g.imageCommonPanelRow,children:c.jsx("div",{className:B(g.imageCommonPanelColumn,g.imageCommonPanelTitle),children:c.jsx("div",{children:n.t("image-panel.align.title")})})}),c.jsx("div",{className:g.imageCommonPanelRow,children:c.jsx("div",{className:B(g.imageCommonPanelColumn),children:c.jsx($.Select,{value:r,options:s,onChange:o})})})]})};var F=function(){return F=Object.assign||function(a){for(var t,n=1,e=arguments.length;n<e;n++){t=arguments[n];for(var r in t)Object.prototype.hasOwnProperty.call(t,r)&&(a[r]=t[r])}return a},F.apply(this,arguments)},en=function(a,t){var n={};for(var e in a)Object.prototype.hasOwnProperty.call(a,e)&&t.indexOf(e)<0&&(n[e]=a[e]);if(a!=null&&typeof Object.getOwnPropertySymbols=="function")for(var r=0,e=Object.getOwnPropertySymbols(a);r<e.length;r++)t.indexOf(e[r])<0&&Object.prototype.propertyIsEnumerable.call(a,e[r])&&(n[e[r]]=a[e[r]]);return n},X=S.forwardRef(function(a,t){var n=a.icon,e=a.id,r=a.className,i=a.extend,s=en(a,["icon","id","className","extend"]),o="univerjs-icon univerjs-icon-".concat(e," ").concat(r||"").trim(),l=S.useRef("_".concat(rn()));return je(n,"".concat(e),{defIds:n.defIds,idSuffix:l.current},F({ref:t,className:o},s),i)});function je(a,t,n,e,r){return S.createElement(a.tag,F(F({key:t},nn(a,n,r)),e),(tn(a,n).children||[]).map(function(i,s){return je(i,"".concat(t,"-").concat(a.tag,"-").concat(s),n,void 0,r)}))}function nn(a,t,n){var e=F({},a.attrs);n!=null&&n.colorChannel1&&e.fill==="colorChannel1"&&(e.fill=n.colorChannel1),a.tag==="mask"&&e.id&&(e.id=e.id+t.idSuffix),Object.entries(e).forEach(function(i){var s=i[0],o=i[1];s==="mask"&&typeof o=="string"&&(e[s]=o.replace(/url\(#(.*)\)/,"url(#$1".concat(t.idSuffix,")")))});var r=t.defIds;return!r||r.length===0||(a.tag==="use"&&e["xlink:href"]&&(e["xlink:href"]=e["xlink:href"]+t.idSuffix),Object.entries(e).forEach(function(i){var s=i[0],o=i[1];typeof o=="string"&&(e[s]=o.replace(/url\(#(.*)\)/,"url(#$1".concat(t.idSuffix,")")))})),e}function tn(a,t){var n,e=t.defIds;return!e||e.length===0?a:a.tag==="defs"&&(!((n=a.children)===null||n===void 0)&&n.length)?F(F({},a),{children:a.children.map(function(r){return typeof r.attrs.id=="string"&&e&&e.indexOf(r.attrs.id)>-1?F(F({},r),{attrs:F(F({},r.attrs),{id:r.attrs.id+t.idSuffix})}):r})}):a}function rn(){return Math.random().toString(36).substring(2,8)}X.displayName="UniverIcon";var an={tag:"svg",attrs:{fill:"none",viewBox:"0 0 16 16",width:"1em",height:"1em"},children:[{tag:"path",attrs:{fill:"colorChannel1",d:"M11.0363 12.2367V14.0367C11.0363 14.3681 11.3049 14.6367 11.6363 14.6367C11.9676 14.6367 12.2363 14.3681 12.2363 14.0367V12.2367H14.0364C14.3677 12.2367 14.6364 11.9681 14.6364 11.6367C14.6364 11.3054 14.3677 11.0367 14.0364 11.0367H12.2363V9.23672C12.2363 8.90535 11.9676 8.63672 11.6363 8.63672C11.3049 8.63672 11.0363 8.90535 11.0363 9.23672V11.0367H9.23635C8.90498 11.0367 8.63635 11.3054 8.63635 11.6367C8.63635 11.9681 8.90498 12.2367 9.23635 12.2367H11.0363Z"}},{tag:"path",attrs:{fill:"currentColor",d:"M2.56365 1.36377C1.90091 1.36377 1.36365 1.90103 1.36365 2.56377V6.16377C1.36365 6.82651 1.90091 7.36377 2.56365 7.36377H6.16365C6.82639 7.36377 7.36365 6.82651 7.36365 6.16377V2.56377C7.36365 1.90103 6.82639 1.36377 6.16365 1.36377H2.56365zM6.16365 2.56377H2.56365L2.56365 6.16377H6.16365V2.56377zM2.56365 8.63647C1.90091 8.63647 1.36365 9.17373 1.36365 9.83647V13.4365C1.36365 14.0992 1.90091 14.6365 2.56365 14.6365H6.16365C6.82639 14.6365 7.36365 14.0992 7.36365 13.4365V9.83647C7.36365 9.17373 6.82639 8.63647 6.16365 8.63647H2.56365zM6.16365 9.83647H2.56365L2.56365 13.4365H6.16365V9.83647zM9.83635 7.36377C9.17361 7.36377 8.63635 6.82651 8.63635 6.16377V2.56377C8.63635 1.90103 9.17361 1.36377 9.83635 1.36377H13.4364C14.0991 1.36377 14.6364 1.90103 14.6364 2.56377V6.16377C14.6364 6.82651 14.0991 7.36377 13.4364 7.36377H9.83635zM9.83635 6.16377V2.56377L13.4364 2.56377V6.16377H9.83635z",fillRule:"evenodd",clipRule:"evenodd"}}]},Ae=S.forwardRef(function(a,t){return S.createElement(X,Object.assign({},a,{id:"autofill",ref:t,icon:an}))});Ae.displayName="Autofill";var sn={tag:"svg",attrs:{fill:"none",viewBox:"0 0 17 16",width:"1em",height:"1em"},children:[{tag:"path",attrs:{fill:"currentColor",d:"M14.0045 4.4334C14.8881 4.4334 15.6045 3.71705 15.6045 2.8334 15.6045 1.94974 14.8881 1.2334 14.0045 1.2334H3.70449C2.82084 1.2334 2.10449 1.94974 2.10449 2.8334 2.10449 3.71705 2.82084 4.4334 3.70449 4.4334H14.0045zM14.4045 2.8334C14.4045 3.05431 14.2254 3.2334 14.0045 3.2334H3.70449C3.48358 3.2334 3.30449 3.05431 3.30449 2.8334 3.30449 2.61248 3.48358 2.4334 3.70449 2.4334H14.0045C14.2254 2.4334 14.4045 2.61249 14.4045 2.8334zM14.1544 8.5999C15.038 8.5999 15.7544 7.88356 15.7544 6.9999 15.7544 6.11625 15.038 5.3999 14.1544 5.3999H3.85439C2.97074 5.3999 2.25439 6.11625 2.25439 6.9999 2.25439 7.88356 2.97074 8.5999 3.85439 8.5999H14.1544zM14.5544 6.9999C14.5544 7.22082 14.3753 7.3999 14.1544 7.3999H3.85439C3.63348 7.3999 3.45439 7.22082 3.45439 6.9999 3.45439 6.77899 3.63348 6.5999 3.85439 6.5999H14.1544C14.3753 6.5999 14.5544 6.77899 14.5544 6.9999z",fillRule:"evenodd",clipRule:"evenodd"}},{tag:"path",attrs:{fill:"currentColor",d:"M8.57975 14.5902L6.58023 12.5907C6.34591 12.3564 6.34591 11.9765 6.58023 11.7421 6.81454 11.5078 7.19444 11.5078 7.42876 11.7421L8.40449 12.7179V10.1664C8.40449 9.83504 8.67312 9.56641 9.00449 9.56641 9.33586 9.56641 9.60449 9.83504 9.60449 10.1664V12.7179L10.5802 11.7421C10.8145 11.5078 11.1944 11.5078 11.4288 11.7421 11.6631 11.9765 11.6631 12.3564 11.4288 12.5907L9.42923 14.5902M8.57975 14.5902C8.58121 14.5917 8.58268 14.5931 8.58416 14.5946 8.64077 14.6502 8.70566 14.6923 8.77482 14.7209 8.84557 14.7502 8.92314 14.7664 9.00449 14.7664 9.08585 14.7664 9.16342 14.7502 9.23416 14.7209 9.30332 14.6923 9.36821 14.6502 9.42482 14.5946"}}]},Le=S.forwardRef(function(a,t){return S.createElement(X,Object.assign({},a,{id:"bottom-single",ref:t,icon:sn}))});Le.displayName="BottomSingle";var on={tag:"svg",attrs:{fill:"none",viewBox:"0 0 16 16",width:"1em",height:"1em"},children:[{tag:"path",attrs:{fill:"currentColor",d:"M5.97705 7.51296C5.97705 7.18159 6.24568 6.91296 6.57705 6.91296H8.48632C8.81769 6.91296 9.08632 7.18159 9.08632 7.51296 9.08632 7.84433 8.81769 8.11296 8.48632 8.11296H6.57705C6.24568 8.11296 5.97705 7.84433 5.97705 7.51296zM6.57705 9.41028C6.24568 9.41028 5.97705 9.67891 5.97705 10.0103 5.97705 10.3416 6.24568 10.6103 6.57705 10.6103H10.8199C11.1512 10.6103 11.4199 10.3416 11.4199 10.0103 11.4199 9.67891 11.1512 9.41028 10.8199 9.41028H6.57705z"}},{tag:"path",attrs:{fill:"currentColor",d:"M3.51074 2.37063C3.51074 1.48697 4.22709 0.77063 5.11074 0.77063H9.80318L9.81294 0.770708C9.97168 0.768161 10.1311 0.82824 10.2511 0.95055L14.4317 5.21408C14.5165 5.30049 14.5697 5.406 14.5917 5.51645C14.6041 5.5644 14.6106 5.61467 14.6106 5.66648V11.6406C14.6106 12.5243 13.8943 13.2406 13.0106 13.2406H5.11074C4.22709 13.2406 3.51074 12.5243 3.51074 11.6406V2.37063ZM10.4032 4.66648V2.81964L12.6063 5.06648H10.8032C10.5823 5.06648 10.4032 4.88739 10.4032 4.66648ZM5.11074 1.97063C4.88983 1.97063 4.71074 2.14972 4.71074 2.37063V11.6406C4.71074 11.8615 4.88983 12.0406 5.11074 12.0406H13.0106C13.2316 12.0406 13.4106 11.8615 13.4106 11.6406V6.26648H10.8032C9.91953 6.26648 9.20318 5.55013 9.20318 4.66648V1.97063H5.11074Z",fillRule:"evenodd",clipRule:"evenodd"}},{tag:"path",attrs:{fill:"currentColor",d:"M2.58916 6.6741C2.58916 6.34273 2.32053 6.0741 1.98916 6.0741C1.65779 6.0741 1.38916 6.34273 1.38916 6.6741V12.6294C1.38916 14.0653 2.55322 15.2294 3.98916 15.2294H9.41408C9.74545 15.2294 10.0141 14.9607 10.0141 14.6294C10.0141 14.298 9.74545 14.0294 9.41408 14.0294H3.98916C3.21596 14.0294 2.58916 13.4026 2.58916 12.6294V6.6741Z"}}]},Re=S.forwardRef(function(a,t){return S.createElement(X,Object.assign({},a,{id:"create-copy-single",ref:t,icon:on}))});Re.displayName="CreateCopySingle";var cn={tag:"svg",attrs:{fill:"none",viewBox:"0 0 17 16",width:"1em",height:"1em"},children:[{tag:"path",attrs:{fill:"currentColor",d:"M7.38125 1.16211C6.49759 1.16211 5.78125 1.87845 5.78125 2.76211V5.6377H2.87783C1.99418 5.6377 1.27783 6.35404 1.27783 7.2377V13.2377C1.27783 14.1214 1.99418 14.8377 2.87783 14.8377H8.87783C9.76149 14.8377 10.4778 14.1214 10.4778 13.2377V10.3621H13.3813C14.2649 10.3621 14.9813 9.64577 14.9813 8.76211V2.76211C14.9813 1.87845 14.2649 1.16211 13.3813 1.16211H7.38125ZM10.4778 9.16211H13.3813C13.6022 9.16211 13.7812 8.98302 13.7812 8.76211V2.76211C13.7812 2.5412 13.6022 2.36211 13.3813 2.36211H7.38125C7.16034 2.36211 6.98125 2.5412 6.98125 2.76211V5.6377H8.87783C9.76149 5.6377 10.4778 6.35404 10.4778 7.2377V9.16211ZM6.98125 6.8377H8.87783C9.09875 6.8377 9.27783 7.01678 9.27783 7.2377V9.16211H7.38125C7.16034 9.16211 6.98125 8.98302 6.98125 8.76211V6.8377ZM5.78125 6.8377V8.76211C5.78125 9.64577 6.49759 10.3621 7.38125 10.3621H9.27783V13.2377C9.27783 13.4586 9.09875 13.6377 8.87783 13.6377H2.87783C2.65692 13.6377 2.47783 13.4586 2.47783 13.2377V7.2377C2.47783 7.01678 2.65692 6.8377 2.87783 6.8377H5.78125Z",fillRule:"evenodd",clipRule:"evenodd"}}]},He=S.forwardRef(function(a,t){return S.createElement(X,Object.assign({},a,{id:"group-single",ref:t,icon:cn}))});He.displayName="GroupSingle";var ln={tag:"svg",attrs:{fill:"none",viewBox:"0 0 16 16",width:"1em",height:"1em"},children:[{tag:"path",attrs:{fill:"currentColor",d:"M11.3536 6.14645C11.5488 6.34171 11.5488 6.65829 11.3536 6.85355L8.35355 9.85355C8.15829 10.0488 7.84171 10.0488 7.64645 9.85355L4.64645 6.85355C4.45118 6.65829 4.45118 6.34171 4.64645 6.14645C4.84171 5.95118 5.15829 5.95118 5.35355 6.14645L8 8.79289L10.6464 6.14645C10.8417 5.95118 11.1583 5.95118 11.3536 6.14645Z",fillRule:"evenodd",clipRule:"evenodd"}}]},Ge=S.forwardRef(function(a,t){return S.createElement(X,Object.assign({},a,{id:"more-down-single",ref:t,icon:ln}))});Ge.displayName="MoreDownSingle";var gn={tag:"svg",attrs:{fill:"none",viewBox:"0 0 16 16",width:"1em",height:"1em"},children:[{tag:"path",attrs:{fill:"currentColor",d:"M1.25 2.96401C1.25 3.84767 1.96634 4.56401 2.85 4.56401H13.15C14.0337 4.56401 14.75 3.84767 14.75 2.96401C14.75 2.08036 14.0337 1.36401 13.15 1.36401H2.85C1.96635 1.36401 1.25 2.08036 1.25 2.96401ZM2.85 3.36401C2.62909 3.36401 2.45 3.18493 2.45 2.96401C2.45 2.7431 2.62909 2.56401 2.85 2.56401H13.15C13.3709 2.56401 13.55 2.7431 13.55 2.96401C13.55 3.18493 13.3709 3.36401 13.15 3.36401H2.85Z",fillRule:"evenodd",clipRule:"evenodd"}},{tag:"path",attrs:{fill:"currentColor",d:"M5.57564 11.6118C5.80995 11.3774 6.18985 11.3774 6.42417 11.6118L7.3999 12.5875V6.36951C7.3999 6.03814 7.66853 5.76951 7.9999 5.76951C8.33127 5.76951 8.5999 6.03814 8.5999 6.36951V12.5875L9.57564 11.6118C9.80995 11.3774 10.1899 11.3774 10.4242 11.6118C10.6585 11.8461 10.6585 12.226 10.4242 12.4603L8.4324 14.452C8.32324 14.5655 8.16982 14.6362 7.9999 14.6362C7.82998 14.6362 7.67655 14.5655 7.56739 14.452L5.57564 12.4603C5.34132 12.226 5.34132 11.8461 5.57564 11.6118Z"}}]},Ve=S.forwardRef(function(a,t){return S.createElement(X,Object.assign({},a,{id:"move-down-single",ref:t,icon:gn}))});Ve.displayName="MoveDownSingle";var mn={tag:"svg",attrs:{fill:"none",viewBox:"0 0 16 16",width:"1em",height:"1em"},children:[{tag:"path",attrs:{fill:"currentColor",d:"M1.25 13.036C1.25 12.1523 1.96634 11.436 2.85 11.436H13.15C14.0337 11.436 14.75 12.1523 14.75 13.036C14.75 13.9196 14.0337 14.636 13.15 14.636H2.85C1.96635 14.636 1.25 13.9196 1.25 13.036ZM2.85 12.636C2.62909 12.636 2.45 12.8151 2.45 13.036C2.45 13.2569 2.62909 13.436 2.85 13.436H13.15C13.3709 13.436 13.55 13.2569 13.55 13.036C13.55 12.8151 13.3709 12.636 13.15 12.636H2.85Z",fillRule:"evenodd",clipRule:"evenodd"}},{tag:"path",attrs:{fill:"currentColor",d:"M5.57564 4.38825C5.80995 4.62256 6.18985 4.62256 6.42417 4.38825L7.3999 3.41251V9.63049C7.3999 9.96186 7.66853 10.2305 7.9999 10.2305C8.33127 10.2305 8.5999 9.96186 8.5999 9.63049V3.41251L9.57564 4.38825C9.80995 4.62256 10.1899 4.62256 10.4242 4.38825C10.6585 4.15393 10.6585 3.77403 10.4242 3.53972L8.4324 1.54796C8.32324 1.43445 8.16982 1.36382 7.9999 1.36382C7.82998 1.36382 7.67655 1.43446 7.56739 1.54797L5.57564 3.53972C5.34132 3.77403 5.34132 4.15393 5.57564 4.38825Z"}}]},ke=S.forwardRef(function(a,t){return S.createElement(X,Object.assign({},a,{id:"move-up-single",ref:t,icon:mn}))});ke.displayName="MoveUpSingle";var dn={tag:"svg",attrs:{fill:"none",viewBox:"0 0 17 16",width:"1em",height:"1em"},children:[{tag:"path",attrs:{fill:"currentColor",d:"M7.82994 1.40913C7.88746 1.35161 7.95376 1.30821 8.02453 1.27893C8.09527 1.24959 8.17285 1.2334 8.2542 1.2334C8.33555 1.2334 8.41313 1.24959 8.48387 1.27893C8.55464 1.30821 8.62094 1.35161 8.67846 1.40913L10.6785 3.40913C10.9128 3.64345 10.9128 4.02335 10.6785 4.25766C10.4441 4.49198 10.0642 4.49198 9.82994 4.25766L8.8542 3.28193V5.8334C8.8542 6.16477 8.58557 6.4334 8.2542 6.4334C7.92283 6.4334 7.6542 6.16477 7.6542 5.8334V3.28193L6.67846 4.25766C6.44415 4.49198 6.06425 4.49198 5.82994 4.25766C5.59562 4.02335 5.59562 3.64345 5.82994 3.40913L7.82994 1.40913Z"}},{tag:"path",attrs:{fill:"currentColor",d:"M1.50439 9C1.50439 8.11634 2.22074 7.4 3.10439 7.4H13.4044C14.288 7.4 15.0044 8.11634 15.0044 9 15.0044 9.88366 14.2881 10.6 13.4044 10.6H3.1044C2.22074 10.6 1.50439 9.88366 1.50439 9zM3.10439 8.6C2.88348 8.6 2.70439 8.77909 2.70439 9 2.70439 9.22091 2.88348 9.4 3.1044 9.4H13.4044C13.6253 9.4 13.8044 9.22091 13.8044 9 13.8044 8.77909 13.6253 8.6 13.4044 8.6H3.10439zM1.6543 13.1665C1.6543 12.2828 2.37064 11.5665 3.2543 11.5665H13.5543C14.438 11.5665 15.1543 12.2828 15.1543 13.1665 15.1543 14.0502 14.438 14.7665 13.5543 14.7665H3.2543C2.37064 14.7665 1.6543 14.0502 1.6543 13.1665zM3.2543 12.7665C3.03338 12.7665 2.8543 12.9456 2.8543 13.1665 2.8543 13.3874 3.03338 13.5665 3.2543 13.5665H13.5543C13.7752 13.5665 13.9543 13.3874 13.9543 13.1665 13.9543 12.9456 13.7752 12.7665 13.5543 12.7665H3.2543z",fillRule:"evenodd",clipRule:"evenodd"}}]},We=S.forwardRef(function(a,t){return S.createElement(X,Object.assign({},a,{id:"topmost-single",ref:t,icon:dn}))});We.displayName="TopmostSingle";var un={tag:"svg",attrs:{fill:"none",viewBox:"0 0 17 16",width:"1em",height:"1em"},children:[{tag:"path",attrs:{fill:"currentColor",d:"M7.46855 2.83731C7.46855 2.61639 7.64764 2.4373 7.86855 2.4373H13.8603C14.0812 2.4373 14.2603 2.61639 14.2603 2.8373V9.5049C14.2603 9.72581 14.0812 9.90489 13.8603 9.90489H12.866C12.5346 9.90489 12.266 10.1735 12.266 10.5049C12.266 10.8363 12.5346 11.1049 12.866 11.1049H13.8603C14.7439 11.1049 15.4603 10.3886 15.4603 9.5049V2.8373C15.4603 1.95365 14.7439 1.2373 13.8603 1.2373H7.86855C6.9849 1.2373 6.26855 1.95365 6.26855 2.83731V3.48688C6.26855 3.81825 6.53718 4.08688 6.86855 4.08688C7.19993 4.08688 7.46855 3.81825 7.46855 3.48688V2.83731Z"}},{tag:"path",attrs:{fill:"currentColor",d:"M3.19888 5.56299C2.31522 5.56299 1.59888 6.27933 1.59888 7.16299V13.163C1.59888 14.0466 2.31522 14.763 3.19888 14.763H9.19888C10.0825 14.763 10.7989 14.0466 10.7989 13.163V7.16299C10.7989 6.27933 10.0825 5.56299 9.19888 5.56299H3.19888ZM2.79888 7.16299C2.79888 6.94207 2.97796 6.76299 3.19888 6.76299H9.19888C9.41979 6.76299 9.59888 6.94207 9.59888 7.16299V13.163C9.59888 13.3839 9.41979 13.563 9.19888 13.563H3.19888C2.97796 13.563 2.79888 13.3839 2.79888 13.163V7.16299Z",fillRule:"evenodd",clipRule:"evenodd"}}]},xe=S.forwardRef(function(a,t){return S.createElement(X,Object.assign({},a,{id:"ungroup-single",ref:t,icon:un}))});xe.displayName="UngroupSingle";const hn=a=>{const{arrangeShow:t,drawings:n}=a,e=V.useDependency(h.LocaleService),r=V.useDependency(D.IDrawingManagerService),i=m=>m?"block":"none",[s,o]=S.useState(n);S.useEffect(()=>{const m=r.focus$.subscribe(d=>{o(d)});return()=>{m.unsubscribe()}},[]);const l=m=>{const d=s[0].unitId,u=s[0].subUnitId,f=s.map(p=>p.drawingId);r.featurePluginOrderUpdateNotification({unitId:d,subUnitId:u,drawingIds:f,arrangeType:m})};return c.jsxs("div",{className:g.imageCommonPanelGrid,style:{display:i(t)},children:[c.jsx("div",{className:g.imageCommonPanelRow,children:c.jsx("div",{className:B(g.imageCommonPanelColumn,g.imageCommonPanelTitle),children:c.jsx("div",{children:e.t("image-panel.arrange.title")})})}),c.jsxs("div",{className:g.imageCommonPanelRow,children:[c.jsx("div",{className:B(g.imageCommonPanelColumn,g.imageCommonPanelSpan2),children:c.jsx($.Button,{size:"small",onClick:()=>{l(h.ArrangeTypeEnum.forward)},children:c.jsxs("span",{className:g.imageCommonPanelInline,children:[c.jsx(ke,{}),e.t("image-panel.arrange.forward")]})})}),c.jsx("div",{className:B(g.imageCommonPanelColumn,g.imageCommonPanelSpan2),children:c.jsx($.Button,{size:"small",onClick:()=>{l(h.ArrangeTypeEnum.backward)},children:c.jsxs("span",{className:g.imageCommonPanelInline,children:[c.jsx(Ve,{}),e.t("image-panel.arrange.backward")]})})})]}),c.jsxs("div",{className:g.imageCommonPanelRow,children:[c.jsx("div",{className:B(g.imageCommonPanelColumn,g.imageCommonPanelSpan2),children:c.jsx($.Button,{size:"small",onClick:()=>{l(h.ArrangeTypeEnum.front)},children:c.jsxs("span",{className:g.imageCommonPanelInline,children:[c.jsx(We,{}),e.t("image-panel.arrange.front")]})})}),c.jsx("div",{className:B(g.imageCommonPanelColumn,g.imageCommonPanelSpan2),children:c.jsx($.Button,{size:"small",onClick:()=>{l(h.ArrangeTypeEnum.back)},children:c.jsxs("span",{className:g.imageCommonPanelInline,children:[c.jsx(Le,{}),e.t("image-panel.arrange.back")]})})})]})]})},fn=a=>{const t=V.useDependency(h.LocaleService),n=V.useDependency(b.IRenderManagerService),e=V.useDependency(D.IDrawingManagerService),{hasGroup:r,drawings:i}=a,[s,o]=S.useState(!1),[l,m]=S.useState(!0),[d,u]=S.useState(!0),f=C=>C?"block":"none",p=()=>{const C=e.getFocusDrawings(),{unitId:P,subUnitId:I}=C[0],U=h.Tools.generateRandomId(10),M=b.getGroupState(0,0,C.map(O=>O.transform||{})),L={unitId:P,subUnitId:I,drawingId:U,drawingType:h.DrawingTypeEnum.DRAWING_GROUP,transform:M},N=C.map(O=>{const E=O.transform||{left:0,top:0},{unitId:j,subUnitId:R,drawingId:W}=O;return{unitId:j,subUnitId:R,drawingId:W,transform:{...E,left:E.left-M.left,top:E.top-M.top},groupId:U}});e.featurePluginGroupUpdateNotification([{parent:L,children:N}])},_=C=>{if(C.drawingType!==h.DrawingTypeEnum.DRAWING_GROUP)return;const{unitId:P,subUnitId:I,drawingId:U,transform:M={width:0,height:0}}=C;if(M==null)return;const L=e.getDrawingsByGroup({unitId:P,subUnitId:I,drawingId:U});if(L.length===0)return;const N=L.map(O=>{const{transform:E}=O,{unitId:j,subUnitId:R,drawingId:W}=O,H=b.transformObjectOutOfGroup(E||{},M,M.width||0,M.height||0);return{unitId:j,subUnitId:R,drawingId:W,transform:{...E,...H},groupId:void 0}});return{parent:C,children:N}},w=()=>{const P=e.getFocusDrawings().map(I=>_(I)).filter(I=>I!=null);P.length!==0&&e.featurePluginUngroupUpdateNotification(P)};return S.useEffect(()=>{const C=i[0];if(C==null)return;const{unitId:P}=C,I=n.getRenderById(P),U=I==null?void 0:I.scene;if(U==null)return;const M=U.getTransformerByCreate(),L=M.clearControl$.subscribe(O=>{O===!0&&o(!1)}),N=M.changeStart$.subscribe(O=>{const{objects:E}=O,j=me(E,e),R=j.filter(K=>(K==null?void 0:K.drawingType)===h.DrawingTypeEnum.DRAWING_GROUP);let W=!1,H=!1;j.length>1&&(W=!0),R.length>0&&(H=!0),o(W||H),m(W),u(H)});return()=>{N.unsubscribe(),L.unsubscribe()}},[]),c.jsxs("div",{className:B(g.imageCommonPanelGrid,g.imageCommonPanelBorder),style:{display:f(r===!0?s:!1)},children:[c.jsx("div",{className:g.imageCommonPanelRow,children:c.jsx("div",{className:B(g.imageCommonPanelColumn,g.imageCommonPanelTitle),children:c.jsx("div",{children:t.t("image-panel.group.title")})})}),c.jsxs("div",{className:g.imageCommonPanelRow,children:[c.jsx("div",{className:B(g.imageCommonPanelColumn,g.imageCommonPanelSpan2,g.imageCommonPanelColumnCenter),children:c.jsx($.Button,{size:"small",onClick:()=>{p()},style:{display:f(l)},children:c.jsxs("span",{className:g.imageCommonPanelInline,children:[c.jsx(He,{}),t.t("image-panel.group.group")]})})}),c.jsx("div",{className:B(g.imageCommonPanelColumn,g.imageCommonPanelSpan2,g.imageCommonPanelColumnCenter),children:c.jsx($.Button,{size:"small",onClick:()=>{w()},style:{display:f(d)},children:c.jsxs("span",{className:g.imageCommonPanelInline,children:[c.jsx(xe,{}),t.t("image-panel.group.unGroup")]})})})]})]})},te=20,pn=20,Cn=[-3600,3600],ve=300,vn=a=>{var Ze;const t=V.useDependency(h.LocaleService),n=V.useDependency(D.IDrawingManagerService),e=V.useDependency(b.IRenderManagerService),{drawings:r,transformShow:i}=a,s=r[0];if(s==null)return;const o=s.transform;if(o==null)return;const{unitId:l,subUnitId:m,drawingId:d,drawingType:u}=s,f=e.getRenderById(l),p=f==null?void 0:f.scene;if(p==null)return;const _=(Ze=p.getEngine())==null?void 0:Ze.activeScene;if(_==null)return;const w=p.getTransformerByCreate(),{width:C=0,height:P=0,left:I=0,top:U=0,angle:M=0}=o,[L,N]=S.useState(C),[O,E]=S.useState(P),[j,R]=S.useState(I),[W,H]=S.useState(U),[ae,K]=S.useState(M),[le,ie]=S.useState(w.keepRatio),se=(v,A,x,z)=>{const{width:k,height:Q}=_,{ancestorLeft:Y,ancestorTop:Z}=p;let q=v,oe=A,fe=x,pe=z;return v+Y<0&&(q=-Y),A+Z<0&&(oe=-Z),fe=k-q-Y,fe<te&&(fe=te),pe=Q-oe-Z,pe<te&&(pe=te),v+fe+Y>k&&(q=k-x-Y),A+pe+Z>Q&&(oe=Q-z-Z),{limitLeft:q,limitTop:oe,limitWidth:fe,limitHeight:pe}},ge=v=>{const{objects:A}=v,x=me(A,n);if(x.length!==1)return;const z=x[0];if(z==null)return;const{transform:k}=z;if(k==null)return;const{width:Q,height:Y,left:Z,top:q,angle:oe}=k;Q!=null&&N(Q),Y!=null&&E(Y),Z!=null&&R(Z),q!=null&&H(q),oe!=null&&K(oe)};S.useEffect(()=>{const v=[w.changeStart$.subscribe(A=>{ge(A)}),w.changing$.subscribe(A=>{ge(A)}),w.changeEnd$.subscribe(A=>{ge(A)}),n.focus$.subscribe(A=>{if(A.length!==1)return;const x=n.getDrawingByParam(A[0]);if(x==null)return;const z=x.transform;if(z==null)return;const{width:k,height:Q,left:Y,top:Z,angle:q}=z;k!=null&&N(k),Q!=null&&E(Q),Y!=null&&R(Y),Z!=null&&H(Z),q!=null&&K(q)})];return()=>{v.forEach(A=>A.unsubscribe())}},[]);const J=h.debounce(v=>{if(v==null)return;v=Math.max(v,te);const{limitWidth:A,limitHeight:x}=se(j,W,v,O);v=Math.min(v,A);const z={unitId:l,subUnitId:m,drawingId:d,drawingType:u,transform:{width:v}};if(le){let k=v/L*O;if(k=Math.max(k,pn),k>x)return;E(k),z.transform.height=k}N(v),n.featurePluginUpdateNotification([z]),w.refreshControls().changeNotification()},ve),Oe=h.debounce(v=>{if(v==null)return;v=Math.max(v,te);const{limitHeight:A,limitWidth:x}=se(j,W,L,v);v=Math.min(v,A);const z={unitId:l,subUnitId:m,drawingId:d,drawingType:u,transform:{height:v}};if(le){let k=v/O*L;if(k=Math.max(k,te),k>x)return;N(k),z.transform.width=k}E(v),n.featurePluginUpdateNotification([z]),w.refreshControls().changeNotification()},ve),jn=h.debounce(v=>{if(v==null)return;const{limitLeft:A}=se(v,W,L,O);v=A;const x={unitId:l,subUnitId:m,drawingId:d,drawingType:u,transform:{left:v}};R(v),n.featurePluginUpdateNotification([x]),w.refreshControls().changeNotification()},ve),An=h.debounce(v=>{if(v==null)return;const{limitTop:A}=se(j,v,L,O);v=A;const x={unitId:l,subUnitId:m,drawingId:d,drawingType:u,transform:{top:v}};H(v),n.featurePluginUpdateNotification([x]),w.refreshControls().changeNotification()},ve),Ln=v=>{if(v==null)return;const[A,x]=Cn;v<A&&(v=A),v>x&&(v=x);const z={unitId:l,subUnitId:m,drawingId:d,drawingType:u,transform:{angle:v}};K(v),n.featurePluginUpdateNotification([z]),w.refreshControls().changeNotification()},Rn=v=>{ie(v),w.keepRatio=v},Hn=v=>v?"block":"none";return c.jsxs("div",{className:B(g.imageCommonPanelGrid,g.imageCommonPanelBorder),style:{display:Hn(i)},children:[c.jsx("div",{className:g.imageCommonPanelRow,children:c.jsx("div",{className:B(g.imageCommonPanelColumn,g.imageCommonPanelTitle),children:c.jsx("div",{children:t.t("image-panel.transform.title")})})}),c.jsxs("div",{className:g.imageCommonPanelRow,children:[c.jsx("div",{className:B(g.imageCommonPanelColumn,g.imageCommonPanelSpan3),children:c.jsxs("label",{children:[c.jsx("div",{className:g.imageCommonPanelRow,children:c.jsx("div",{className:g.imageCommonPanelColumn,children:t.t("image-panel.transform.width")})}),c.jsx("div",{className:g.imageCommonPanelRow,children:c.jsx("div",{className:g.imageCommonPanelColumn,children:c.jsx($.InputNumber,{precision:1,value:L,onChange:v=>{J(v)},className:g.imageCommonPanelInput})})})]})}),c.jsx("div",{className:B(g.imageCommonPanelColumn,g.imageCommonPanelSpan3),children:c.jsxs("label",{children:[c.jsx("div",{className:g.imageCommonPanelRow,children:c.jsx("div",{className:g.imageCommonPanelColumn,children:t.t("image-panel.transform.height")})}),c.jsx("div",{className:g.imageCommonPanelRow,children:c.jsx("div",{className:g.imageCommonPanelColumn,children:c.jsx($.InputNumber,{precision:1,value:O,onChange:v=>{Oe(v)},className:g.imageCommonPanelInput})})})]})}),c.jsx("div",{className:B(g.imageCommonPanelColumn,g.imageCommonPanelSpan3),children:c.jsxs("label",{children:[c.jsx("div",{className:g.imageCommonPanelRow,children:c.jsx("div",{className:g.imageCommonPanelColumn,children:t.t("image-panel.transform.lock")})}),c.jsx("div",{className:B(g.imageCommonPanelRow,g.imageCommonPanelRowVertical),children:c.jsx("div",{className:g.imageCommonPanelColumn,children:c.jsx($.Checkbox,{checked:le,onChange:Rn})})})]})})]}),c.jsxs("div",{className:g.imageCommonPanelRow,children:[c.jsx("div",{className:B(g.imageCommonPanelColumn,g.imageCommonPanelSpan3),children:c.jsxs("label",{children:[c.jsx("div",{className:g.imageCommonPanelRow,children:c.jsx("div",{className:g.imageCommonPanelColumn,children:t.t("image-panel.transform.x")})}),c.jsx("div",{className:g.imageCommonPanelRow,children:c.jsx("div",{className:g.imageCommonPanelColumn,children:c.jsx($.InputNumber,{precision:1,value:j,onChange:v=>{jn(v)},className:g.imageCommonPanelInput})})})]})}),c.jsx("div",{className:B(g.imageCommonPanelColumn,g.imageCommonPanelSpan3),children:c.jsxs("label",{children:[c.jsx("div",{className:g.imageCommonPanelRow,children:c.jsx("div",{className:g.imageCommonPanelColumn,children:t.t("image-panel.transform.y")})}),c.jsx("div",{className:g.imageCommonPanelRow,children:c.jsx("div",{className:g.imageCommonPanelColumn,children:c.jsx($.InputNumber,{precision:1,value:W,onChange:v=>{An(v)},className:g.imageCommonPanelInput})})})]})}),c.jsx("div",{className:B(g.imageCommonPanelColumn,g.imageCommonPanelSpan3),children:c.jsxs("label",{children:[c.jsx("div",{className:g.imageCommonPanelRow,children:c.jsx("div",{className:g.imageCommonPanelColumn,children:t.t("image-panel.transform.rotate")})}),c.jsx("div",{className:g.imageCommonPanelRow,children:c.jsx("div",{className:g.imageCommonPanelColumn,children:c.jsx($.InputNumber,{precision:1,value:ae,onChange:Ln,className:g.imageCommonPanelInput})})})]})})]})]})},we={id:"sheet.operation.open-image-crop",type:h.CommandType.OPERATION,handler:(a,t)=>!0},ne={id:"sheet.operation.close-image-crop",type:h.CommandType.OPERATION,handler:(a,t)=>!0};var G=(a=>(a.FREE="0",a.R1_1="1",a.R16_9="2",a.R9_16="3",a.R5_4="4",a.R4_5="5",a.R4_3="6",a.R3_4="7",a.R3_2="8",a.R2_3="9",a))(G||{});const de={id:"sheet.operation.Auto-image-crop",type:h.CommandType.OPERATION,handler:(a,t)=>!0},wn=a=>{const t=V.useDependency(h.ICommandService),n=V.useDependency(h.LocaleService),{drawings:e,cropperShow:r}=a;if(e[0]==null)return;const[s,o]=S.useState(G.FREE),l=S.useRef(!1),m=[{label:n.t("image-panel.crop.mode"),value:G.FREE},{label:"1:1",value:G.R1_1},{label:"16:9",value:G.R16_9},{label:"9:16",value:G.R9_16},{label:"5:4",value:G.R5_4},{label:"4:5",value:G.R4_5},{label:"4:3",value:G.R4_3},{label:"3:4",value:G.R3_4},{label:"3:2",value:G.R3_2},{label:"2:3",value:G.R2_3}];S.useEffect(()=>{const p=t.onCommandExecuted(_=>{if(_.id===ne.id){const w=_.params;w!=null&&w.isAuto||(l.current=!1)}});return()=>{p==null||p.dispose()}},[]);function d(p){o(p),l.current&&t.executeCommand(de.id,{cropType:p})}const u=p=>p?"block":"none",f=p=>{t.executeCommand(de.id,{cropType:p}),l.current=!0};return c.jsxs("div",{className:B(g.imageCommonPanelGrid,g.imageCommonPanelBorder),style:{display:u(r)},children:[c.jsx("div",{className:g.imageCommonPanelRow,children:c.jsx("div",{className:B(g.imageCommonPanelColumn,g.imageCommonPanelTitle),children:c.jsx("div",{children:n.t("image-panel.crop.title")})})}),c.jsxs("div",{className:B(g.imageCommonPanelRow,g.imageCommonPanelRowVertical),children:[c.jsx("div",{className:B(g.imageCommonPanelColumn,g.imageCommonPanelSpan2),children:c.jsx($.Button,{size:"small",onClick:()=>{f(s)},children:c.jsxs("span",{className:g.imageCommonPanelInline,children:[c.jsx(Re,{}),n.t("image-panel.crop.start")]})})}),c.jsx("div",{className:B(g.imageCommonPanelColumn,g.imageCommonPanelSpan2),children:c.jsx($.Select,{value:s,options:m,onChange:d})})]})]})},Sn=a=>{const t=V.useDependency(D.IDrawingManagerService),n=V.useDependency(b.IRenderManagerService),e=V.useDependency(h.LocaleService),{drawings:r,hasArrange:i=!0,hasTransform:s=!0,hasAlign:o=!0,hasCropper:l=!0,hasGroup:m=!0}=a,d=r[0];if(d==null)return;const{unitId:u}=d,f=n.getRenderById(u),p=f==null?void 0:f.scene;if(p==null)return;const _=p.getTransformerByCreate(),[w,C]=S.useState(!0),[P,I]=S.useState(!0),[U,M]=S.useState(!1),[L,N]=S.useState(!0),[O,E]=S.useState(!1);return S.useEffect(()=>{const j=_.clearControl$.subscribe(H=>{H===!0&&(C(!1),I(!1),M(!1),N(!1),E(!0))}),R=_.changeStart$.subscribe(H=>{const{objects:ae}=H,K=me(ae,t);K.length===0?(C(!1),I(!1),M(!1),N(!1),E(!0)):K.length===1?(C(!0),I(!0),M(!1),N(!0),E(!1)):(C(!0),I(!1),M(!0),N(!1),E(!1))}),W=t.focus$.subscribe(H=>{H.length===0?(C(!1),I(!1),M(!1),N(!1),E(!0)):H.length===1?(C(!0),I(!0),M(!1),N(!0),E(!1)):(C(!0),I(!1),M(!0),N(!1),E(!1))});return()=>{R.unsubscribe(),j.unsubscribe(),W.unsubscribe()}},[]),c.jsxs(c.Fragment,{children:[c.jsx("div",{style:{display:O===!0?"block":"none",height:"100%"},children:c.jsx("div",{style:{display:"flex",justifyContent:"center",alignItems:"center",height:"100%",top:"50%",marginTop:"-100px"},children:c.jsx("span",{children:e.t("image-panel.null")})})}),c.jsx(hn,{arrangeShow:i===!0?w:!1,drawings:r}),c.jsx(vn,{transformShow:s===!0?P:!1,drawings:r}),c.jsx(Qe,{alignShow:o===!0?U:!1,drawings:r}),c.jsx(wn,{cropperShow:l===!0?L:!1,drawings:r}),c.jsx(fn,{hasGroup:m,drawings:r})]})},ue={imagePopupMenu:"univer-image-popup-menu",imagePopupMenuItem:"univer-image-popup-menu-item",imagePopupMenuItemTitle:"univer-image-popup-menu-item-title",btnContainer:"univer-btn-container",btnContainerExpand:"univer-btn-container-expand"},$e=a=>{var _,w;const t=(w=(_=a.popup)==null?void 0:_.extraProps)==null?void 0:w.menuItems;if(!t)return null;const n=V.useDependency(h.ICommandService),e=V.useDependency(h.LocaleService),[r,i]=S.useState(!1),[s,o]=S.useState(!1),l=()=>{o(!0)},m=()=>{o(!1)},d=C=>{i(C)},u=C=>{n.executeCommand(C.commandId,C.commandParams),i(!1)},f=r||s,p=t.filter(C=>!C.disable);return c.jsx("div",{onMouseEnter:l,onMouseLeave:m,children:c.jsx($.DropdownLegacy,{placement:"bottomLeft",trigger:["click"],overlay:c.jsx("ul",{className:ue.imagePopupMenu,children:p.map(C=>c.jsx("li",{onClick:()=>u(C),className:ue.imagePopupMenuItem,children:c.jsx("span",{className:ue.imagePopupMenuItemTitle,children:e.t(C.label)})},C.index))}),visible:r,onVisibleChange:d,children:c.jsxs("div",{className:B(ue.btnContainer,{[ue.btnContainerExpand]:r}),children:[c.jsx(Ae,{style:{color:"#35322B"},extend:{colorChannel1:"rgb(var(--green-700, #409f11))"}}),f&&c.jsx(Ge,{style:{color:"#CCCCCC",fontSize:"8px",marginLeft:"8px"}})]})})})},ze="COMPONENT_IMAGE_POPUP_MENU",_n="drawing-ui.config",Ke={},De={id:"sheet.operation.image-reset-size",type:h.CommandType.OPERATION,handler:(a,t)=>!0},In=a=>{const{src:t}=a;return t?c.jsx("div",{children:c.jsx("img",{src:t,alt:"Univer Image Viewer",style:{width:"100%",height:"100%",position:"relative"}})}):null};var yn=Object.getOwnPropertyDescriptor,bn=(a,t,n,e)=>{for(var r=e>1?void 0:e?yn(t,n):t,i=a.length-1,s;i>=0;i--)(s=a[i])&&(r=s(r)||r);return r},Fe=(a,t)=>(n,e)=>t(n,e,a);let Se=class extends h.Disposable{constructor(a,t){super(),this._componentManager=a,this._commandService=t,this._init()}_initCustomComponents(){const a=this._componentManager;this.disposeWithMe(a.register(ze,$e)),this.disposeWithMe(a.register(Te,In))}_initCommands(){[we,ne,De,Ce,de].forEach(a=>this.disposeWithMe(this._commandService.registerCommand(a)))}_init(){this._initCommands(),this._initCustomComponents()}};Se=bn([Fe(0,h.Inject(V.ComponentManager)),Fe(1,h.ICommandService)],Se);var Pn=Object.getOwnPropertyDescriptor,Dn=(a,t,n,e)=>{for(var r=e>1?void 0:e?Pn(t,n):t,i=a.length-1,s;i>=0;i--)(s=a[i])&&(r=s(r)||r);return r},_e=(a,t)=>(n,e)=>t(n,e,a);let Ie=class extends h.Disposable{constructor(t,n,e,r){super();ee(this,"_sceneListenerOnDrawingMap",new WeakSet);this._currentUniverService=t,this._commandService=n,this._renderManagerService=e,this._drawingManagerService=r,this._initialize()}dispose(){super.dispose()}_initialize(){this._recoveryImages(),this._drawingAddListener(),this._drawingRemoveListener(),this._drawingUpdateListener(),this._commandExecutedListener(),this._drawingArrangeListener(),this._drawingGroupListener(),this._drawingRefreshListener(),this._drawingVisibleListener()}_recoveryImages(){const t=this._drawingManagerService.drawingManagerData,n=Ee(this._currentUniverService);if(n==null)return;const{unitId:e,subUnitId:r}=n;Object.keys(t).forEach(i=>{Object.keys(t[i]).forEach(s=>{const o=t[i][s].data;o==null||i!==e||s!==r||Object.keys(o).forEach(l=>{o[l]&&this._insertDrawing([{unitId:i,subUnitId:s,drawingId:l}])})})})}_commandExecutedListener(){this.disposeWithMe(this._commandService.onCommandExecuted(t=>{if(t.id===Ce.id){const n=t.params;if(n==null)return;this._drawingAlign(n)}}))}_drawingGroupListener(){this.disposeWithMe(this._drawingManagerService.group$.subscribe(t=>{this._groupDrawings(t)})),this.disposeWithMe(this._drawingManagerService.ungroup$.subscribe(t=>{this._ungroupDrawings(t)}))}_getSceneAndTransformerByDrawingSearch(t){if(t==null)return;const n=this._renderManagerService.getRenderById(t),e=n==null?void 0:n.scene;if(e==null)return null;const r=e.getTransformerByCreate();return{scene:e,transformer:r}}_groupDrawings(t){t.forEach(n=>{this._groupDrawing(n)})}_groupDrawing(t){const{parent:n,children:e}=t,{unitId:r,subUnitId:i,drawingId:s}=n,o=this._getSceneAndTransformerByDrawingSearch(n.unitId);if(o==null)return;const{scene:l,transformer:m}=o;this._commandService.syncExecuteCommand(ne.id);const d=[];if(e.forEach(p=>{const _=D.getDrawingShapeKeyByDrawingSearch(p),w=l.getObjectIncludeInGroup(_);if(w==null||d.includes(w))return;d.push(w);const{transform:C}=p;C!=null&&(w.classType===b.RENDER_CLASS_TYPE.GROUP?w.transformByState({left:C.left,top:C.top}):w.transformByState(C))}),d.length===0)return;const u=D.getDrawingShapeKeyByDrawingSearch({unitId:r,subUnitId:i,drawingId:s}),f=new b.Group(u);l.addObject(f,b.DRAWING_OBJECT_LAYER_INDEX).attachTransformerTo(f),f.addObjects(...d),n.transform&&f.transformByState({left:n.transform.left,top:n.transform.top}),m.clearSelectedObjects(),m.setSelectedControl(f)}_ungroupDrawings(t){t.forEach(n=>{this._ungroupDrawing(n)})}_ungroupDrawing(t){const{parent:n,children:e}=t,r=this._getSceneAndTransformerByDrawingSearch(n.unitId);if(r==null)return;const{scene:i,transformer:s}=r;e.forEach(u=>{const f=D.getDrawingShapeKeyByDrawingSearch(u),p=i.getObjectIncludeInGroup(f);if(p==null)return!0;if(p==null)return;const{transform:_}=u;_!=null&&(p.classType===b.RENDER_CLASS_TYPE.GROUP?p.transformByState({left:_.left,top:_.top}):p.transformByState(_))});const o=D.getDrawingShapeKeyByDrawingSearch(n),l=i.getObject(o),{width:m,height:d}=l;l.getObjects().forEach(u=>{l.removeSelfObjectAndTransform(u.oKey,m,d)}),l.dispose(),s.clearSelectedObjects()}_drawingAlign(t){const{alignType:n}=t,e=this._drawingManagerService.getFocusDrawings();if(n===T.default)return;const r=[];let i=Number.POSITIVE_INFINITY,s=Number.POSITIVE_INFINITY,o=Number.NEGATIVE_INFINITY,l=Number.NEGATIVE_INFINITY,m=0;e.forEach(d=>{const{unitId:u,subUnitId:f,drawingId:p,drawingType:_}=d,w=this._drawingManagerService.getDrawingByParam({unitId:u,subUnitId:f,drawingId:p});if(w==null||w.transform==null)return;r.push({unitId:u,subUnitId:f,drawingId:p,drawingType:_,transform:w.transform});const{left:C=0,top:P=0,width:I=0,height:U=0}=w.transform;i=Math.min(i,C),s=Math.min(s,P),o=Math.max(o,C+I),l=Math.max(l,P+U),m++}),m!==0&&(this._sortDrawingTransform(r,n),this._applyAlignType(r,n,i,s,o,l,m))}_applyAlignType(t,n,e,r,i,s,o){const l=Math.round((i-e)/o*10)/10,m=Math.round((s-r)/o*10)/10,d=[],u=this._getSceneAndTransformerByDrawingSearch(t[0].unitId);if(u==null)return;const{scene:f,transformer:p}=u;t.forEach((_,w)=>{const{unitId:C,subUnitId:P,drawingId:I,transform:U,drawingType:M}=_,{left:L=0,top:N=0,width:O=0,height:E=0}=U;let j=L,R=N;switch(n){case T.left:j=e;break;case T.center:j=e+(i-e)/2-O/2;break;case T.right:j=i-O;break;case T.top:R=r;break;case T.middle:R=r+(s-r)/2-E/2;break;case T.bottom:R=s-E;break;case T.horizon:j=e+l*w;break;case T.vertical:R=r+m*w;break}(j!==L||R!==N)&&d.push({unitId:C,subUnitId:P,drawingId:I,drawingType:M,transform:{left:j,top:R}})}),this._drawingManagerService.featurePluginUpdateNotification(d),p.refreshControls().changeNotification()}_sortDrawingTransform(t,n){t.sort((e,r)=>{const i=e.transform,s=r.transform,{left:o=0,top:l=0,width:m=0,height:d=0}=i,{left:u=0,top:f=0,width:p=0,height:_=0}=s;switch(n){case T.left:return o-u;case T.center:return o+m/2-(u+p/2);case T.right:return o+m-(u+p);case T.top:return l-f;case T.middle:return l+d/2-(f+_/2);case T.bottom:return l+d-(f+_);case T.horizon:return o+m/2-(u+p/2);case T.vertical:return l+d/2-(f+_/2);default:return 0}})}_drawingArrangeListener(){this.disposeWithMe(this._drawingManagerService.order$.subscribe(t=>{this._drawingArrange(t)}))}_drawingArrange(t){const{unitId:n,subUnitId:e,drawingIds:r}=t,i=this._getSceneAndTransformerByDrawingSearch(n);if(i==null)return;const{scene:s}=i;r.forEach(o=>{const l=D.getDrawingShapeKeyByDrawingSearch({unitId:n,subUnitId:e,drawingId:o}),m=s.fuzzyMathObjects(l,!0);if(m==null||m.length===0)return;const d=this._drawingManagerService.getDrawingOrder(n,e).indexOf(o);for(const u of m)u.setProps({zIndex:d}),u.makeDirty()})}_drawingAddListener(){this.disposeWithMe(this._drawingManagerService.add$.subscribe(t=>{this._insertDrawing(t)}))}_insertDrawing(t){const n=[];t.forEach(e=>{const{unitId:r}=e;if(this._drawingManagerService.getDrawingByParam(e)==null)return;const s=this._getSceneAndTransformerByDrawingSearch(r);if(s==null)return;const{scene:o}=s;n.includes(o)||n.push(o)}),n.forEach(e=>{this._sceneListenerOnDrawingMap.has(e)||(this._addListenerOnDrawing(e),this._sceneListenerOnDrawingMap.add(e))})}_drawingRemoveListener(){this.disposeWithMe(this._drawingManagerService.remove$.subscribe(t=>{t.forEach(n=>{var d;const{unitId:e,subUnitId:r,drawingId:i}=n,s=this._getSceneAndTransformerByDrawingSearch(e);if(s==null)return;const{scene:o}=s,l=D.getDrawingShapeKeyByDrawingSearch({unitId:e,subUnitId:r,drawingId:i}),m=o.fuzzyMathObjects(l,!0);if(m.length>0){for(const u of m)u.dispose();(d=o.getTransformer())==null||d.clearSelectedObjects()}})}))}_drawingUpdateListener(){this.disposeWithMe(this._drawingManagerService.update$.subscribe(t=>{t.forEach(n=>{var O;const{unitId:e,subUnitId:r,drawingId:i}=n,s=this._drawingManagerService.getDrawingByParam(n);if(s==null)return;const{transform:o,drawingType:l}=s,m=this._getSceneAndTransformerByDrawingSearch(e);if(m==null)return;const{scene:d,transformer:u}=m;if(o==null)return!0;const{left:f=0,top:p=0,width:_=0,height:w=0,angle:C=0,flipX:P=!1,flipY:I=!1,skewX:U=0,skewY:M=0}=o,L=D.getDrawingShapeKeyByDrawingSearch({unitId:e,subUnitId:r,drawingId:i}),N=d.getObject(L);if(N==null)return!0;N.transformByState({left:f,top:p,width:_,height:w,angle:C,flipX:P,flipY:I,skewX:U,skewY:M}),(O=d.getTransformer())==null||O.debounceRefreshControls()})}))}_drawingRefreshListener(){this.disposeWithMe(this._drawingManagerService.refreshTransform$.subscribe(t=>{t.forEach(n=>{const{unitId:e,subUnitId:r,drawingId:i}=n,s=this._getSceneAndTransformerByDrawingSearch(e);if(s==null)return;const o=this._drawingManagerService.getDrawingByParam(n);if(o==null)return;const{transform:l}=o,{scene:m}=s,d=D.getDrawingShapeKeyByDrawingSearch({unitId:e,subUnitId:r,drawingId:i}),u=m.getObject(d);if(u==null||l==null)return!0;const{left:f=0,top:p=0,width:_=0,height:w=0,angle:C=0,flipX:P=!1,flipY:I=!1,skewX:U=0,skewY:M=0}=l;u.transformByState({left:f,top:p,width:_,height:w,angle:C,flipX:P,flipY:I,skewX:U,skewY:M})})}))}_drawingVisibleListener(){this.disposeWithMe(this._drawingManagerService.visible$.subscribe(t=>{t.forEach(n=>{const{unitId:e,subUnitId:r,drawingId:i,visible:s}=n,o=this._getSceneAndTransformerByDrawingSearch(e);if(o==null)return;const{scene:l}=o,m=D.getDrawingShapeKeyByDrawingSearch({unitId:e,subUnitId:r,drawingId:i}),d=l.getObject(m);if(d==null)return!0;s?d.show():d.hide()})}))}_filterUpdateParams(t,n){return t.filter((e,r)=>{if(e==null)return!1;const{transform:i}=e;return h.checkIfMove(i,n==null?void 0:n[r])})}_addListenerOnDrawing(t){const n=t.getTransformerByCreate();let e=null;this.disposeWithMe(h.toDisposable(n.changeStart$.subscribe(r=>{const{objects:i}=r,s=Array.from(i.values()),o=[];e=s.map(l=>{const{left:m,top:d,height:u,width:f,angle:p,oKey:_,isInGroup:w}=l,C=this._drawingManagerService.getDrawingOKey(_);if(w||l instanceof b.Group){let P=l.ancestorGroup;if(P==null&&l instanceof b.Group&&(P=l),P==null)return null;const I=this._drawingManagerService.getDrawingOKey(P.oKey);if(I){const{unitId:U,subUnitId:M,drawingId:L}=I;o.push({unitId:U,subUnitId:M,drawingId:L});const{left:N,top:O,height:E,width:j,angle:R}=P;return{left:N,top:O,height:E,width:j,angle:R}}}else if(C!=null){const{unitId:P,subUnitId:I,drawingId:U}=C;return o.push({unitId:P,subUnitId:I,drawingId:U}),{left:m,top:d,height:u,width:f,angle:p}}return null}).filter(l=>l!=null),o.length>0?this._commandService.syncExecuteCommand(D.SetDrawingSelectedOperation.id,o):this._commandService.syncExecuteCommand(D.SetDrawingSelectedOperation.id,[])}))),this.disposeWithMe(h.toDisposable(n.changeEnd$.subscribe(r=>{const{objects:i}=r,s=this._filterUpdateParams(me(i,this._drawingManagerService),e);s.length>0&&this._drawingManagerService.featurePluginUpdateNotification(s)})))}};Ie=Dn([_e(0,h.IUniverInstanceService),_e(1,h.ICommandService),_e(2,b.IRenderManagerService),_e(3,D.IDrawingManagerService)],Ie);class he extends b.Shape{constructor(n,e){e==null&&(e={}),e.transformerConfig={keepRatio:!1,isCropper:!0,anchorFill:"rgb(0, 0, 0)",anchorStroke:"rgb(255, 255, 255)",anchorSize:24};super(n,e);ee(this,"_srcRect");ee(this,"_prstGeom");ee(this,"_applyTransform");ee(this,"_dragPadding",8);ee(this,"_cacheCanvas");e!=null&&e.srcRect&&(this._srcRect=e.srcRect),e!=null&&e.prstGeom&&(this._prstGeom=e.prstGeom),e!=null&&e.applyTransform&&(this._applyTransform=e.applyTransform),e!=null&&e.dragPadding&&(this._dragPadding=e.dragPadding),this._applyProps()}refreshSrcRect(n,e){this._srcRect=n,this._applyTransform=e,this._applyProps()}get srcRect(){return this._srcRect}dispose(){var n;super.dispose(),(n=this._cacheCanvas)==null||n.dispose(),this._srcRect=null}isHit(n){const e=this.getInverseCoord(n);return e.x>=-this.strokeWidth/2&&e.x<=this.width+this.strokeWidth/2&&e.y>=-this.strokeWidth/2&&e.y<=this.height+this.strokeWidth/2&&!this._inSurround(e)}_inSurround(n){const e=this._dragPadding;return n.x>=e-this.strokeWidth/2&&n.x<=this.width+this.strokeWidth/2-e&&n.y>=e-this.strokeWidth/2&&n.y<=this.height+this.strokeWidth/2-e}render(n,e){return this.visible?(n.save(),this._draw(n),n.restore(),this.makeDirty(!1),this):(this.makeDirty(!1),this)}_draw(n){var l,m;const r=this.getScene().getEngine(),{width:i,height:s}=r;this._initialCacheCanvas(),(l=this._cacheCanvas)==null||l.clear();const o=(m=this._cacheCanvas)==null?void 0:m.getContext();o!=null&&(o.save(),b.Rect.drawWith(o,{left:0,top:0,width:i,height:s,fill:"rgba(0, 0, 0, 0.5)"}),o.setTransform(n.getTransform()),this._clipForApplyObject(o),this._applyCache(n),o.restore())}_clipForApplyObject(n){let e=0;if(this._prstGeom!=null&&(e=1),n.globalCompositeOperation="destination-out",n.beginPath(),e===0){const r=this.transform.getMatrix();n.transform(r[0],r[1],r[2],r[3],r[4],r[5]),n.rect(0,0,this.width,this.height),n.fill()}}_applyProps(){if(this._applyTransform==null)return;let n=0,e=0,r=0,i=0;const{left:s=0,top:o=0,width:l=0,height:m=0,angle:d}=this._applyTransform;if(this._srcRect!=null){const{left:p=0,top:_=0,right:w=0,bottom:C=0}=this._srcRect;n=p,e=_,r=w,i=C}const u=s+n,f=o+e;this.transformByState({left:u,top:f,width:s+l-r-u,height:o+m-i-f,angle:d})}_applyCache(n){if(!n||this._cacheCanvas==null)return;const e=this._cacheCanvas.getContext();e.save(),n.save(),n.setTransform(1,0,0,1,0,0),e.setTransform(1,0,0,1,0,0),n.drawImage(this._cacheCanvas.getCanvasEle(),0,0),n.restore(),e.restore()}_initialCacheCanvas(){if(this._cacheCanvas!=null)return;const n=this.getScene();if(n==null)return;this._cacheCanvas=new b.Canvas;const e=n.getEngine();this._cacheCanvas.setSize(e.width,e.height),e.onTransformChange$.subscribeEvent(()=>{var r;(r=this._cacheCanvas)==null||r.setSize(e.width,e.height),this.makeDirty(!0)})}}var Mn=Object.getOwnPropertyDescriptor,On=(a,t,n,e)=>{for(var r=e>1?void 0:e?Mn(t,n):t,i=a.length-1,s;i>=0;i--)(s=a[i])&&(r=s(r)||r);return r},ce=(a,t)=>(n,e)=>t(n,e,a);let ye=class extends h.Disposable{constructor(t,n,e,r,i,s){super();ee(this,"_sceneListenerOnImageMap",new WeakSet);this._commandService=t,this._drawingManagerService=n,this._renderManagerService=e,this._univerInstanceService=r,this._messageService=i,this._localeService=s,this._init()}_init(){this._initOpenCrop(),this._initCloseCrop(),this._initAutoCrop()}_initAutoCrop(){this.disposeWithMe(this._commandService.onCommandExecuted(t=>{if(t.id!==de.id)return;const n=t.params;if(n==null)return;const{cropType:e}=n,r=this._drawingManagerService.getFocusDrawings();if(r.length!==1)return;const i=r[0],{unitId:s,subUnitId:o,drawingId:l}=i,m=this._renderManagerService.getRenderById(s),d=m==null?void 0:m.scene;if(d==null)return!0;this._searchCropObject(d)!=null&&this._commandService.syncExecuteCommand(ne.id,{isAuto:!0});const f=D.getDrawingShapeKeyByDrawingSearch({unitId:s,subUnitId:o,drawingId:l}),p=d.getObject(f);if(!(p instanceof b.Image)){this._messageService.show({type:$.MessageType.Error,content:this._localeService.t("image-cropper.error")});return}p!=null&&(this._updateCropperObject(e,p),this._commandService.executeCommand(we.id,{unitId:s,subUnitId:o,drawingId:l}))}))}_calculateSrcRectByRatio(t,n,e,r,i,s){const o=e/r,l=i/s;let m=e,d=r;o>l?m=r*l:d=e/l;const u=(e-m)/2,f=(r-d)/2;return{left:b.precisionTo(u,1),top:b.precisionTo(f,1),right:b.precisionTo(e-(u+m),1),bottom:b.precisionTo(r-(f+d),1)}}_updateCropperObject(t,n){const{left:e,top:r,width:i,height:s}=n.calculateTransformWithSrcRect();let o;switch(t){case G.R1_1:o=this._calculateSrcRectByRatio(e,r,i,s,1,1);break;case G.R16_9:o=this._calculateSrcRectByRatio(e,r,i,s,16,9);break;case G.R9_16:o=this._calculateSrcRectByRatio(e,r,i,s,9,16);break;case G.R5_4:o=this._calculateSrcRectByRatio(e,r,i,s,5,4);break;case G.R4_5:o=this._calculateSrcRectByRatio(e,r,i,s,4,5);break;case G.R4_3:o=this._calculateSrcRectByRatio(e,r,i,s,4,3);break;case G.R3_4:o=this._calculateSrcRectByRatio(e,r,i,s,3,4);break;case G.R3_2:o=this._calculateSrcRectByRatio(e,r,i,s,3,2);break;case G.R2_3:o=this._calculateSrcRectByRatio(e,r,i,s,2,3);break;case G.FREE:}if(o==null)return;n.setSrcRect(o);const{left:l=0,top:m=0,bottom:d=0,right:u=0}=o;n.transformByStateCloseCropper({left:e+l,top:r+m,width:i-u-l,height:s-d-m})}_initOpenCrop(){this.disposeWithMe(this._commandService.onCommandExecuted(t=>{if(t.id!==we.id)return;const n=t.params;if(n==null)return;const{unitId:e,subUnitId:r,drawingId:i}=n,s=this._renderManagerService.getRenderById(e),o=s==null?void 0:s.scene;if(o==null)return!0;if(this._sceneListenerOnImageMap.has(o)||(this._addListenerOnImage(o),this._sceneListenerOnImageMap.add(o)),this._drawingManagerService.getDrawingByParam({unitId:e,subUnitId:r,drawingId:i})==null)return;const m=D.getDrawingShapeKeyByDrawingSearch({unitId:e,subUnitId:r,drawingId:i}),d=o.getObject(m);if(d==null)return;if(!(d instanceof b.Image)){this._messageService.show({type:$.MessageType.Error,content:this._localeService.t("image-cropper.error")});return}const u=o.getTransformer();u==null||u.clearControls();const f=new he(`${m}-crop`,{srcRect:d.srcRect,prstGeom:d.prstGeom,applyTransform:d.calculateTransformWithSrcRect()});o.addObject(f,d.getLayerIndex()+1).attachTransformerTo(f),u==null||u.createControlForCopper(f),this._addHoverForImageCopper(f),d.openRenderByCropper(),u==null||u.refreshControls(),f.makeDirty(!0),this._commandService.syncExecuteCommand(D.SetDrawingSelectedOperation.id,[{unitId:e,subUnitId:r,drawingId:i}])}))}_searchCropObject(t){const n=t.getAllObjectsByOrder();for(const e of n)if(e instanceof he)return e}_initCloseCrop(){this.disposeWithMe(this._commandService.onCommandExecuted(n=>{if(n.id!==ne.id)return;const e=this._univerInstanceService.getFocusedUnit();if(e==null)return;const r=e.getUnitId(),i=this._renderManagerService.getRenderById(r),s=i==null?void 0:i.scene;if(s==null)return!0;const o=this._searchCropObject(s);if(o==null)return;const l=this._getApplyObjectByCropObject(o);if(l==null)return;const m=s.getTransformerByCreate();m.detachFrom(o),m.clearCopperControl();const d=this._getSrcRectByTransformState(l,o),u=this._drawingManagerService.getDrawingOKey(l.oKey);if(u!=null){const{left:f,top:p,height:_,width:w}=o;this._drawingManagerService.featurePluginUpdateNotification([{...u,transform:{...u.transform,left:f,top:p,height:_,width:w},srcRect:d.srcRectAngle}])}l.setSrcRect({...d.srcRectAngle}),l.closeRenderByCropper(),l.makeDirty(!0),o==null||o.dispose()}));const t=this._univerInstanceService.getCurrentTypeOfUnit$(h.UniverInstanceType.UNIVER_SHEET).pipe(Ne.switchMap(n=>n?n.activeSheet$:Ne.of(null)));this.disposeWithMe(t.subscribe(()=>{this._commandService.syncExecuteCommand(ne.id)}))}_getApplyObjectByCropObject(t){const n=t.oKey,e=n.slice(0,n.length-5),r=t.getScene();if(!r)return null;const i=r.getObject(e);return i==null?null:i}_addListenerOnImage(t){const n=t.getTransformerByCreate();let e=null;this.disposeWithMe(n.changeStart$.subscribe(r=>{const{objects:i}=r,s=i.values().next().value;if(s==null||!(s instanceof he))return;const{left:o,top:l,height:m,width:d,angle:u}=s;e={left:o,top:l,height:m,width:d,angle:u},n.clearCopperControl()})),this.disposeWithMe(n.changeEnd$.subscribe(r=>{const{objects:i}=r,s=i.values().next().value;if(s==null||!(s instanceof he))return;const{left:o,top:l,height:m,width:d,angle:u}=s;if(!h.checkIfMove({left:o,top:l,height:m,width:d,angle:u},e))return;const f=this._getApplyObjectByCropObject(s);if(f==null)return;const p=this._getSrcRectByTransformState(f,s);s.refreshSrcRect(p.srcRect,f.getState()),n.createControlForCopper(s)})),this._endCropListener(t)}_addHoverForImageCopper(t){this.disposeWithMe(t.onPointerEnter$.subscribeEvent(()=>{t.cursor=b.CURSOR_TYPE.MOVE})),this.disposeWithMe(t.onPointerLeave$.subscribeEvent(()=>{t.cursor=b.CURSOR_TYPE.DEFAULT}))}_endCropListener(t){const n=t.getTransformerByCreate();this.disposeWithMe(n.clearControl$.subscribe(e=>{e===!0&&this._commandService.syncExecuteCommand(ne.id)}))}_getSrcRectByTransformState(t,n){const{left:e,top:r,height:i,width:s,strokeWidth:o,angle:l}=n,{left:m,top:d,width:u,height:f,angle:p,strokeWidth:_}=t,w=e-m,C=r-d,P={left:w,top:C,right:u-w-s,bottom:f-C-i},I={...P};if(p!==0){const U=e+s/2,M=r+i/2,L=new b.Vector2(U,M),N=u/2+m,O=f/2+d,E=new b.Vector2(N,O),j=new b.Vector2(m,d);j.rotateByPoint(b.degToRad(p),E);const R=j.clone();R.rotateByPoint(b.degToRad(-p),L);const W=e-R.x,H=r-R.y;I.left=W,I.top=H,I.right=u-W-s,I.bottom=f-H-i}return{srcRect:P,srcRectAngle:I}}};ye=On([ce(0,h.ICommandService),ce(1,D.IDrawingManagerService),ce(2,b.IRenderManagerService),ce(3,h.IUniverInstanceService),ce(4,V.IMessageService),ce(5,h.Inject(h.LocaleService))],ye);var Nn=Object.getOwnPropertyDescriptor,En=(a,t,n,e)=>{for(var r=e>1?void 0:e?Nn(t,n):t,i=a.length-1,s;i>=0;i--)(s=a[i])&&(r=s(r)||r);return r},re=(a,t)=>(n,e)=>t(n,e,a);let be=class extends h.Disposable{constructor(a,t,n,e,r,i,s){super(),this._commandService=a,this._renderManagerService=t,this._drawingManagerService=n,this._dialogService=e,this._imageIoService=r,this._currentUniverService=i,this._drawingRenderService=s,this._initialize()}dispose(){super.dispose()}_initialize(){this._drawingAddListener(),this._commandExecutedListener(),this._imageUpdateListener()}_commandExecutedListener(){this.disposeWithMe(this._commandService.onCommandExecuted(a=>{if(a.id===De.id){const t=a.params;if(t==null)return;this._resetImageSize(t)}}))}_getSceneAndTransformerByDrawingSearch(a){if(a==null)return;const t=this._renderManagerService.getRenderById(a),n=t==null?void 0:t.scene;if(n==null)return null;const e=n.getTransformerByCreate();return{scene:n,transformer:e}}_resetImageSize(a){const t=[],n=[];a.forEach(e=>{const{unitId:r,subUnitId:i,drawingId:s}=e,o=this._getSceneAndTransformerByDrawingSearch(r);if(o==null)return;const{scene:l}=o,m=D.getDrawingShapeKeyByDrawingSearch({unitId:r,subUnitId:i,drawingId:s}),d=l.getObject(m);if(d==null)return!0;const u=this._drawingManagerService.getDrawingByParam(e);if(u==null)return!0;if(u.drawingType!==h.DrawingTypeEnum.DRAWING_IMAGE)return;d.resetSize();const{width:f,height:p}=d.getNativeSize();n.includes(l)===!1&&n.push(l),t.push({...u,transform:{...u.transform,height:p,width:f,angle:0},srcRect:null,prstGeom:null})}),this._drawingManagerService.featurePluginUpdateNotification(t),n.forEach(e=>{e.getTransformerByCreate().refreshControls().changeNotification()}),this._commandService.syncExecuteCommand(D.SetDrawingSelectedOperation.id,a)}_drawingAddListener(){this.disposeWithMe(this._drawingManagerService.add$.subscribe(a=>{this._insertImages(a)}))}_insertImages(a){a.forEach(async t=>{var m;const{unitId:n,subUnitId:e,drawingId:r}=t,i=this._getSceneAndTransformerByDrawingSearch(n),s=(m=Ee(this._currentUniverService,n))==null?void 0:m.subUnitId;if(i==null||s!==e)return;const o=this._drawingManagerService.getDrawingByParam(t);if(o==null)return;const l=await this._drawingRenderService.renderImages(o,i.scene);if(!(l==null||l.length===0))for(const d of l)this._addHoverForImage(d),this._addDialogForImage(d)})}_imageUpdateListener(){this.disposeWithMe(this._drawingManagerService.update$.subscribe(a=>{a.forEach(t=>{const{unitId:n,subUnitId:e,drawingId:r}=t,i=this._drawingManagerService.getDrawingByParam(t);if(i==null)return;const{transform:s,drawingType:o,srcRect:l,prstGeom:m,source:d,imageSourceType:u}=i;if(o!==h.DrawingTypeEnum.DRAWING_IMAGE)return;const f=this._getSceneAndTransformerByDrawingSearch(n);if(f==null)return;const{scene:p,transformer:_}=f;if(s==null)return!0;const w=D.getDrawingShapeKeyByDrawingSearch({unitId:n,subUnitId:e,drawingId:r}),C=p.getObject(w);if(C==null)return!0;C.setSrcRect(l),C.setPrstGeom(m),d!=null&&d.length>0&&(u===h.ImageSourceType.BASE64||u===h.ImageSourceType.URL)&&C.changeSource(d)})}))}_addHoverForImage(a){this.disposeWithMe(h.toDisposable(a.onPointerEnter$.subscribeEvent(()=>{a.cursor=b.CURSOR_TYPE.GRAB}))),this.disposeWithMe(h.toDisposable(a.onPointerLeave$.subscribeEvent(()=>{a.cursor=b.CURSOR_TYPE.DEFAULT})))}_addDialogForImage(a){this.disposeWithMe(h.toDisposable(a.onDblclick$.subscribeEvent(()=>{const t=`${a.oKey}-viewer-dialog`;this._drawingRenderService.previewImage(t,a.getNative().src,a.getNativeSize().width,a.getNativeSize().height)})))}};be=En([re(0,h.ICommandService),re(1,b.IRenderManagerService),re(2,D.IDrawingManagerService),re(3,V.IDialogService),re(4,D.IImageIoService),re(5,h.IUniverInstanceService),re(6,h.Inject(y.DrawingRenderService))],be);var Tn=Object.getOwnPropertyDescriptor,Bn=(a,t,n,e)=>{for(var r=e>1?void 0:e?Tn(t,n):t,i=a.length-1,s;i>=0;i--)(s=a[i])&&(r=s(r)||r);return r},Ye=(a,t)=>(n,e)=>t(n,e,a);const Un="UNIVER_DRAWING_UI_PLUGIN";y.UniverDrawingUIPlugin=(Me=class extends h.Plugin{constructor(t=Ke,n,e){super(),this._config=t,this._injector=n,this._configService=e;const{menu:r,...i}=h.merge({},Ke,this._config);r&&this._configService.setConfig("menu",r,{merge:!0}),this._configService.setConfig(_n,i)}onStarting(){this._initDependencies()}onRendered(){this._injector.get(Ie),this._injector.get(Se),this._injector.get(ye),this._injector.get(be)}_initDependencies(){[[y.DrawingRenderService],[Ie],[Se],[ye],[be]].forEach(n=>this._injector.add(n))}},ee(Me,"pluginName",Un),Me),y.UniverDrawingUIPlugin=Bn([Ye(1,h.Inject(h.Injector)),Ye(2,h.IConfigService)],y.UniverDrawingUIPlugin),y.AutoImageCropOperation=de,y.COMPONENT_IMAGE_POPUP_MENU=ze,y.CloseImageCropOperation=ne,y.DrawingCommonPanel=Sn,y.ImageCropperObject=he,y.ImagePopupMenu=$e,y.ImageResetSizeOperation=De,y.OpenImageCropOperation=we,y.SetDrawingAlignOperation=Ce,y.getUpdateParams=me,Object.defineProperty(y,Symbol.toStringTag,{value:"Module"})});


// @univerjs/sheets-drawing/index
(function(n,a){typeof exports=="object"&&typeof module<"u"?a(exports,require("@univerjs/core"),require("@univerjs/drawing")):typeof define=="function"&&define.amd?define(["exports","@univerjs/core","@univerjs/drawing"],a):(n=typeof globalThis<"u"?globalThis:n||self,a(n.UniverSheetsDrawing={},n.UniverCore,n.UniverDrawing))})(this,function(n,a,u){"use strict";const w="sheets-drawing.config",_={};var f=(e=>(e.Position="0",e.Both="1",e.None="2",e))(f||{});class l extends u.UnitDrawingService{}const v=a.createIdentifier("sheets-drawing.sheet-drawing.service");var U=(e=>(e[e.INSERT=0]="INSERT",e[e.REMOVE=1]="REMOVE",e[e.UPDATE=2]="UPDATE",e[e.ARRANGE=3]="ARRANGE",e[e.GROUP=4]="GROUP",e[e.UNGROUP=5]="UNGROUP",e))(U||{});const D={id:"sheet.mutation.set-drawing-apply",type:a.CommandType.MUTATION,handler:(e,r)=>{const i=e.get(u.IDrawingManagerService),t=e.get(v),{op:s,unitId:o,subUnitId:g,type:M,objects:c}=r;switch(i.applyJson1(o,g,s),t.applyJson1(o,g,s),M){case 0:i.addNotification(c),t.addNotification(c);break;case 1:i.removeNotification(c),t.removeNotification(c);break;case 2:i.updateNotification(c),t.updateNotification(c);break;case 3:i.orderNotification(c),t.orderNotification(c);break;case 4:i.groupUpdateNotification(c);break;case 5:i.ungroupUpdateNotification(c);break}return!0}};var m=Object.getOwnPropertyDescriptor,E=(e,r,i,t)=>{for(var s=t>1?void 0:t?m(r,i):r,o=e.length-1,g;o>=0;o--)(g=e[o])&&(s=g(s)||s);return s},h=(e,r)=>(i,t)=>r(i,t,e);const S="SHEET_DRAWING_PLUGIN";let d=class extends a.Disposable{constructor(e,r,i,t){super(),this._commandService=e,this._sheetDrawingService=r,this._drawingManagerService=i,this._resourceManagerService=t,this._initSnapshot(),this.disposeWithMe(this._commandService.registerCommand(D))}_initSnapshot(){const e=(i,t)=>{const s=t||this._sheetDrawingService.getDrawingDataForUnit(i);return s?JSON.stringify(s):""},r=i=>{if(!i)return{};try{return JSON.parse(i)}catch{return{}}};this.disposeWithMe(this._resourceManagerService.registerPluginResource({pluginName:S,businesses:[a.UniverInstanceType.UNIVER_SHEET],toJson:(i,t)=>e(i,t),parseJson:i=>r(i),onUnLoad:i=>{this._sheetDrawingService.removeDrawingDataForUnit(i),this._drawingManagerService.removeDrawingDataForUnit(i)},onLoad:(i,t)=>{this._sheetDrawingService.registerDrawingData(i,t),this._drawingManagerService.registerDrawingData(i,t)}}))}};d=E([h(0,a.ICommandService),h(1,v),h(2,u.IDrawingManagerService),h(3,a.IResourceManagerService)],d);var I=Object.defineProperty,R=Object.getOwnPropertyDescriptor,O=(e,r,i)=>r in e?I(e,r,{enumerable:!0,configurable:!0,writable:!0,value:i}):e[r]=i,b=(e,r,i,t)=>{for(var s=t>1?void 0:t?R(r,i):r,o=e.length-1,g;o>=0;o--)(g=e[o])&&(s=g(s)||s);return s},N=(e,r)=>(i,t)=>r(i,t,e),P=(e,r,i)=>O(e,typeof r!="symbol"?r+"":r,i);n.UniverSheetsDrawingPlugin=class extends a.Plugin{constructor(r=_,i,t){super(),this._config=r,this._injector=i,this._configService=t;const{...s}=a.merge({},_,this._config);this._configService.setConfig(w,s)}onStarting(){[[d],[v,{useClass:l}]].forEach(r=>this._injector.add(r)),this._injector.get(d)}},P(n.UniverSheetsDrawingPlugin,"pluginName",S),P(n.UniverSheetsDrawingPlugin,"type",a.UniverInstanceType.UNIVER_SHEET),n.UniverSheetsDrawingPlugin=b([a.DependentOn(u.UniverDrawingPlugin),N(1,a.Inject(a.Injector)),N(2,a.IConfigService)],n.UniverSheetsDrawingPlugin),n.DrawingApplyType=U,n.ISheetDrawingService=v,n.SHEET_DRAWING_PLUGIN=S,n.SetDrawingApplyMutation=D,n.SheetDrawingAnchorType=f,Object.defineProperty(n,Symbol.toStringTag,{value:"Module"})});


// @univerjs/sheets-drawing-ui/index
(function(P,l){typeof exports=="object"&&typeof module<"u"?l(exports,require("@univerjs/core"),require("@univerjs/docs-drawing"),require("@univerjs/drawing"),require("@univerjs/drawing-ui"),require("@univerjs/engine-render"),require("@univerjs/sheets-drawing"),require("@univerjs/sheets-ui"),require("@univerjs/ui"),require("rxjs"),require("@univerjs/sheets"),require("react/jsx-runtime"),require("react"),require("@univerjs/docs-ui"),require("@univerjs/design")):typeof define=="function"&&define.amd?define(["exports","@univerjs/core","@univerjs/docs-drawing","@univerjs/drawing","@univerjs/drawing-ui","@univerjs/engine-render","@univerjs/sheets-drawing","@univerjs/sheets-ui","@univerjs/ui","rxjs","@univerjs/sheets","react/jsx-runtime","react","@univerjs/docs-ui","@univerjs/design"],l):(P=typeof globalThis<"u"?globalThis:P||self,l(P.UniverSheetsDrawingUi={},P.UniverCore,P.UniverDocsDrawing,P.UniverDrawing,P.UniverDrawingUi,P.UniverEngineRender,P.UniverSheetsDrawing,P.UniverSheetsUi,P.UniverUi,P.rxjs,P.UniverSheets,P.React,P.React,P.UniverDocsUi,P.UniverDesign))})(this,function(P,l,we,U,pe,j,m,E,Y,N,v,x,te,Rt,oe){"use strict";var Zn=Object.defineProperty;var Jn=(P,l,we)=>l in P?Zn(P,l,{enumerable:!0,configurable:!0,writable:!0,value:we}):P[l]=we;var Q=(P,l,we)=>Jn(P,typeof l!="symbol"?l+"":l,we);const Vt="sheets-drawing-ui.config",bt={},G={id:"sheet.operation.clear-drawing-transformer",type:l.CommandType.MUTATION,handler:(i,r)=>{const t=i.get(j.IRenderManagerService);return r.forEach(e=>{var n,o;(o=(n=t.getRenderById(e))==null?void 0:n.scene.getTransformer())==null||o.debounceRefreshControls()}),!0}},Ie={id:"sheet.command.remove-sheet-image",type:l.CommandType.COMMAND,handler:(i,r)=>{var y,M,R;const t=i.get(l.ICommandService),e=i.get(l.IUndoRedoService),n=i.get(v.SheetInterceptorService),o=i.get(m.ISheetDrawingService);if(!r)return!1;const{drawings:a}=r,s=[];a.forEach(C=>{const{unitId:T}=C;s.push(T)});const d=o.getBatchRemoveOp(a),{unitId:g,subUnitId:u,undo:c,redo:p,objects:h}=d,S=n.onCommandExecute({id:Ie.id,params:r}),f={id:m.SetDrawingApplyMutation.id,params:{unitId:g,subUnitId:u,op:p,objects:h,type:m.DrawingApplyType.REMOVE}},w={id:m.SetDrawingApplyMutation.id,params:{unitId:g,subUnitId:u,op:c,objects:h,type:m.DrawingApplyType.INSERT}};return l.sequenceExecute([...(y=S.preRedos)!=null?y:[],f,...S.redos],t)?(e.pushUndoRedo({unitID:g,undoMutations:[...(M=S.preUndos)!=null?M:[],w,...S.undos,{id:G.id,params:s}],redoMutations:[...(R=S.preRedos)!=null?R:[],f,...S.redos,{id:G.id,params:s}]}),!0):!1}},Et="COMPONENT_SHEET_DRAWING_PANEL",ht={id:"sidebar.operation.sheet-image",type:l.CommandType.COMMAND,handler:async(i,r)=>{const t=i.get(Y.ISidebarService),e=i.get(l.LocaleService),n=i.get(l.IUniverInstanceService),o=i.get(l.ICommandService);if(!v.getSheetCommandTarget(n))return!1;switch(r.value){case"open":t.open({header:{title:e.t("sheetImage.panel.title")},children:{label:Et},onClose:()=>{o.syncExecuteCommand(U.SetDrawingSelectedOperation.id,[])},width:360});break;case"close":default:t.close();break}return!0}},pt={id:"sheet.operation.edit-sheet-image",type:l.CommandType.OPERATION,handler:(i,r)=>{const t=i.get(l.ICommandService);return r==null?!1:(t.syncExecuteCommand(U.SetDrawingSelectedOperation.id,[r]),t.executeCommand(ht.id,{value:"open"}),!0)}},Fe={uploadLoading:"univer-upload-loading",uploadLoadingBody:"univer-upload-loading-body",uploadLoadingBodyAnimation:"univer-upload-loading-body-animation",uploadLoadingBodyText:"univer-upload-loading-body-text"},Xt=()=>{const i=Y.useDependency(U.IImageIoService),r=Y.useDependency(l.LocaleService),[t,e]=te.useState(0);return te.useEffect(()=>{const n=i.change$.subscribe(o=>{e(o)});return()=>{n.unsubscribe()}},[i]),x.jsx("div",{style:{display:t>0?"block":"none"},className:Fe.uploadLoading,children:x.jsxs("div",{className:Fe.uploadLoadingBody,children:[x.jsx("div",{className:Fe.uploadLoadingBodyAnimation}),x.jsx("div",{className:Fe.uploadLoadingBodyText,children:`${r.t("uploadLoading.loading")}: ${t}`})]})})};var xt=Object.getOwnPropertyDescriptor,Kt=(i,r,t,e)=>{for(var n=e>1?void 0:e?xt(r,t):r,o=i.length-1,a;o>=0;o--)(a=i[o])&&(n=a(n)||n);return n},me=(i,r)=>(t,e)=>r(t,e,i);let Ge=class extends l.RxDisposable{constructor(r,t,e,n,o,a,s,d){super();Q(this,"_initImagePopupMenu",new Set);this._injector=r,this._drawingManagerService=t,this._canvasPopManagerService=e,this._renderManagerService=n,this._univerInstanceService=o,this._contextService=a,this._uiPartsService=s,this._commandService=d,this._init()}_init(){this._univerInstanceService.getCurrentTypeOfUnit$(l.UniverInstanceType.UNIVER_SHEET).pipe(N.takeUntil(this.dispose$)).subscribe(r=>this._create(r)),this._univerInstanceService.getTypeOfUnitDisposed$(l.UniverInstanceType.UNIVER_SHEET).pipe(N.takeUntil(this.dispose$)).subscribe(r=>this._dispose(r)),this._univerInstanceService.getAllUnitsForType(l.UniverInstanceType.UNIVER_SHEET).forEach(r=>this._create(r)),this._uiPartsService.registerComponent(Y.BuiltInUIPart.CONTENT,()=>Y.connectInjector(Xt,this._injector))}_dispose(r){const t=r.getUnitId();this._renderManagerService.removeRender(t)}_create(r){if(!r)return;const t=r.getUnitId();this._renderManagerService.has(t)&&!this._initImagePopupMenu.has(t)&&(this._popupMenuListener(t),this._initImagePopupMenu.add(t))}_hasCropObject(r){const t=r.getAllObjectsByOrder();for(const e of t)if(e instanceof pe.ImageCropperObject)return!0;return!1}_popupMenuListener(r){var o;const t=(o=this._renderManagerService.getRenderById(r))==null?void 0:o.scene;if(!t)return;const e=t.getTransformerByCreate();if(!e)return;let n;this.disposeWithMe(l.toDisposable(e.createControl$.subscribe(()=>{if(this._contextService.setContextValue(l.FOCUSING_COMMON_DRAWINGS,!0),this._hasCropObject(t))return;const a=e.getSelectedObjectMap();if(a.size>1){n==null||n.dispose();return}const s=a.values().next().value;if(!s)return;const d=s.oKey,g=this._drawingManagerService.getDrawingOKey(d);if(!g)return;const{unitId:u,subUnitId:c,drawingId:p,drawingType:h}=g,S=g.data;if(S&&S.disablePopup)return;n==null||n.dispose();const f=this._canvasPopManagerService.getFeatureMenu(u,c,p,h);n=this.disposeWithMe(this._canvasPopManagerService.attachPopupToObject(s,{componentKey:pe.COMPONENT_IMAGE_POPUP_MENU,direction:"horizontal",offset:[2,0],extraProps:{menuItems:f||this._getImageMenuItems(u,c,p,h)}}))}))),this.disposeWithMe(e.clearControl$.subscribe(()=>{n==null||n.dispose(),this._contextService.setContextValue(l.FOCUSING_COMMON_DRAWINGS,!1),this._commandService.syncExecuteCommand(U.SetDrawingSelectedOperation.id,[])})),this.disposeWithMe(this._contextService.contextChanged$.subscribe(a=>{a[l.FOCUSING_COMMON_DRAWINGS]===!1&&(n==null||n.dispose())})),this.disposeWithMe(e.changing$.subscribe(()=>{n==null||n.dispose()}))}_getImageMenuItems(r,t,e,n){return[{label:"image-popup.edit",index:0,commandId:pt.id,commandParams:{unitId:r,subUnitId:t,drawingId:e},disable:n===l.DrawingTypeEnum.DRAWING_DOM},{label:"image-popup.delete",index:1,commandId:Ie.id,commandParams:{unitId:r,drawings:[{unitId:r,subUnitId:t,drawingId:e}]},disable:!1},{label:"image-popup.crop",index:2,commandId:pe.OpenImageCropOperation.id,commandParams:{unitId:r,subUnitId:t,drawingId:e},disable:n===l.DrawingTypeEnum.DRAWING_DOM},{label:"image-popup.reset",index:3,commandId:pe.ImageResetSizeOperation.id,commandParams:[{unitId:r,subUnitId:t,drawingId:e}],disable:n===l.DrawingTypeEnum.DRAWING_DOM}]}};Ge=Kt([me(0,l.Inject(l.Injector)),me(1,U.IDrawingManagerService),me(2,l.Inject(E.SheetCanvasPopManagerService)),me(3,j.IRenderManagerService),me(4,l.IUniverInstanceService),me(5,l.IContextService),me(6,l.Inject(Y.IUIPartsService)),me(7,l.ICommandService)],Ge);function K(i,r,t){const{from:e,to:n,flipY:o=!1,flipX:a=!1,angle:s=0,skewX:d=0,skewY:g=0}=i,u=t.getCurrent();if(u==null)return;const c=E.convertPositionSheetOverGridToAbsolute(u.unitId,u.sheetId,{from:e,to:n},t);let{left:p,top:h,width:S,height:f}=c;const w=t.getCurrentSkeleton(),_=w.rowHeaderWidth+w.columnTotalWidth,y=w.columnHeaderHeight+w.rowTotalHeight;return p+S>_&&(p=_-S),h+f>y&&(h=y-f),{flipY:o,flipX:a,angle:s,skewX:d,skewY:g,left:p,top:h,width:S,height:f}}function H(i,r){const{left:t=0,top:e=0,width:n=0,height:o=0,flipY:a=!1,flipX:s=!1,angle:d=0,skewX:g=0,skewY:u=0}=i,c=r.getCellWithCoordByOffset(t,e);if(c==null)return;const p={column:c.actualColumn,columnOffset:j.precisionTo(t-c.startX,1),row:c.actualRow,rowOffset:j.precisionTo(e-c.startY,1)},h=r.getCellWithCoordByOffset(t+n,e+o);if(h==null)return;const S={column:h.actualColumn,columnOffset:j.precisionTo(t+n-h.startX,1),row:h.actualRow,rowOffset:j.precisionTo(e+o-h.startY,1)};return{flipY:a,flipX:s,angle:d,skewX:g,skewY:u,from:p,to:S}}var zt=Object.getOwnPropertyDescriptor,qt=(i,r,t,e)=>{for(var n=e>1?void 0:e?zt(r,t):r,o=i.length-1,a;o>=0;o--)(a=i[o])&&(n=a(n)||n);return n},He=(i,r)=>(t,e)=>r(t,e,i);let mt=class extends l.Disposable{constructor(i,r,t,e,n){super(),this._context=i,this._sheetDrawingService=r,this._drawingManagerService=t,this._sheetSelectionRenderService=e,this._sheetSkeletonManagerService=n,this._init()}_init(){this._drawingInitializeListener()}_drawingInitializeListener(){this._sheetDrawingService.initializeNotification(this._context.unitId);const i=this._sheetDrawingService.getDrawingDataForUnit(this._context.unitId);for(const r in i){const t=i[r];for(const e in t.data){const n=t.data[e];n.transform=K(n.sheetTransform,this._sheetSelectionRenderService,this._sheetSkeletonManagerService)}}this._drawingManagerService.registerDrawingData(this._context.unitId,this._sheetDrawingService.getDrawingDataForUnit(this._context.unitId)),this._drawingManagerService.initializeNotification(this._context.unitId)}};mt=qt([He(1,m.ISheetDrawingService),He(2,U.IDrawingManagerService),He(3,l.Inject(E.ISheetSelectionRenderService)),He(4,l.Inject(E.SheetSkeletonManagerService))],mt);function Zt(i){const r=[];return i.forEach(t=>{const{parent:e,children:n}=t,{unitId:o,subUnitId:a,drawingId:s}=e,d=j.getGroupState(0,0,n.map(c=>c.transform||{})),g=n.map(c=>{const p=c.transform||{left:0,top:0},{unitId:h,subUnitId:S,drawingId:f}=c;return{unitId:h,subUnitId:S,drawingId:f,transform:{...p,left:p.left-d.left,top:p.top-d.top},groupId:s}}),u={unitId:o,subUnitId:a,drawingId:s,drawingType:l.DrawingTypeEnum.DRAWING_GROUP,transform:d};r.push({parent:u,children:g})}),r}function Jt(i){const r=[];return i.forEach(t=>{const{parent:e,children:n}=t,{unitId:o,subUnitId:a,drawingId:s,transform:d={width:0,height:0}}=e;if(d==null)return;const g=n.map(c=>{const{transform:p}=c,{unitId:h,subUnitId:S,drawingId:f}=c,w=j.transformObjectOutOfGroup(p||{},d,d.width||0,d.height||0);return{unitId:h,subUnitId:S,drawingId:f,transform:w,groupId:void 0}}),u={unitId:o,subUnitId:a,drawingId:s,drawingType:l.DrawingTypeEnum.DRAWING_GROUP,transform:{left:0,top:0}};r.push({parent:u,children:g})}),r}const ft={id:"sheet.command.group-sheet-image",type:l.CommandType.COMMAND,handler:(i,r)=>{const t=i.get(l.ICommandService),e=i.get(l.IUndoRedoService),n=i.get(m.ISheetDrawingService);if(!r)return!1;const o=[];r.forEach(({parent:h,children:S})=>{o.push(h.unitId),S.forEach(f=>{o.push(f.unitId)})});const a=n.getGroupDrawingOp(r),{unitId:s,subUnitId:d,undo:g,redo:u,objects:c}=a;return t.syncExecuteCommand(m.SetDrawingApplyMutation.id,{op:u,unitId:s,subUnitId:d,objects:c,type:m.DrawingApplyType.GROUP})?(e.pushUndoRedo({unitID:s,undoMutations:[{id:m.SetDrawingApplyMutation.id,params:{op:g,unitId:s,subUnitId:d,objects:Jt(c),type:m.DrawingApplyType.UNGROUP}},{id:G.id,params:o}],redoMutations:[{id:m.SetDrawingApplyMutation.id,params:{op:u,unitId:s,subUnitId:d,objects:c,type:m.DrawingApplyType.GROUP}},{id:G.id,params:o}]}),!0):!1}},Oe={id:"sheet.command.insert-sheet-image",type:l.CommandType.COMMAND,handler:(i,r)=>{var y,M,R;const t=i.get(l.ICommandService),e=i.get(l.IUndoRedoService),n=i.get(m.ISheetDrawingService),o=i.get(v.SheetInterceptorService);if(!r)return!1;const a=r.drawings,s=a.map(C=>C.unitId),d=n.getBatchAddOp(a),{unitId:g,subUnitId:u,undo:c,redo:p,objects:h}=d,S=o.onCommandExecute({id:Oe.id,params:r}),f={id:m.SetDrawingApplyMutation.id,params:{op:p,unitId:g,subUnitId:u,objects:h,type:m.DrawingApplyType.INSERT}},w={id:m.SetDrawingApplyMutation.id,params:{op:c,unitId:g,subUnitId:u,objects:h,type:m.DrawingApplyType.REMOVE}};return l.sequenceExecute([...(y=S.preRedos)!=null?y:[],f,...S.redos],t)?(e.pushUndoRedo({unitID:g,undoMutations:[...(M=S.preUndos)!=null?M:[],w,...S.undos,{id:G.id,params:s}],redoMutations:[...(R=S.preRedos)!=null?R:[],f,...S.redos,{id:G.id,params:s}]}),!0):!1}},St={id:"sheet.command.set-drawing-arrange",type:l.CommandType.COMMAND,handler:(i,r)=>{const t=i.get(l.ICommandService),e=i.get(l.IUndoRedoService);if(!r)return!1;const n=i.get(m.ISheetDrawingService),{unitId:o,subUnitId:a,drawingIds:s,arrangeType:d}=r,g={unitId:o,subUnitId:a,drawingIds:s};let u;if(d===l.ArrangeTypeEnum.forward?u=n.getForwardDrawingsOp(g):d===l.ArrangeTypeEnum.backward?u=n.getBackwardDrawingOp(g):d===l.ArrangeTypeEnum.front?u=n.getFrontDrawingsOp(g):d===l.ArrangeTypeEnum.back&&(u=n.getBackDrawingsOp(g)),u==null)return!1;const{objects:c,redo:p,undo:h}=u;return t.syncExecuteCommand(m.SetDrawingApplyMutation.id,{op:p,unitId:o,subUnitId:a,objects:c,type:m.DrawingApplyType.ARRANGE})?(e.pushUndoRedo({unitID:o,undoMutations:[{id:m.SetDrawingApplyMutation.id,params:{op:h,unitId:o,subUnitId:a,objects:c,type:m.DrawingApplyType.ARRANGE}}],redoMutations:[{id:m.SetDrawingApplyMutation.id,params:{op:p,unitId:o,subUnitId:a,objects:c,type:m.DrawingApplyType.ARRANGE}}]}),!0):!1}},Pe={id:"sheet.command.set-sheet-image",type:l.CommandType.COMMAND,handler:(i,r)=>{const t=i.get(l.ICommandService),e=i.get(l.IUndoRedoService),n=i.get(m.ISheetDrawingService);if(!r)return!1;const{drawings:o}=r,a=n.getBatchUpdateOp(o),{unitId:s,subUnitId:d,undo:g,redo:u,objects:c}=a;return t.syncExecuteCommand(m.SetDrawingApplyMutation.id,{unitId:s,subUnitId:d,op:u,objects:c,type:m.DrawingApplyType.UPDATE})?(e.pushUndoRedo({unitID:s,undoMutations:[{id:m.SetDrawingApplyMutation.id,params:{unitId:s,subUnitId:d,op:g,objects:c,type:m.DrawingApplyType.UPDATE}},{id:G.id,params:[s]}],redoMutations:[{id:m.SetDrawingApplyMutation.id,params:{unitId:s,subUnitId:d,op:u,objects:c,type:m.DrawingApplyType.UPDATE}},{id:G.id,params:[s]}]}),!0):!1}},wt={id:"sheet.command.ungroup-sheet-image",type:l.CommandType.COMMAND,handler:(i,r)=>{const t=i.get(l.ICommandService),e=i.get(l.IUndoRedoService),n=i.get(m.ISheetDrawingService);if(!r)return!1;const o=[];r.forEach(({parent:h,children:S})=>{o.push(h.unitId),S.forEach(f=>{o.push(f.unitId)})});const a=n.getUngroupDrawingOp(r),{unitId:s,subUnitId:d,undo:g,redo:u,objects:c}=a;return t.syncExecuteCommand(m.SetDrawingApplyMutation.id,{op:u,unitId:s,subUnitId:d,objects:c,type:m.DrawingApplyType.UNGROUP})?(e.pushUndoRedo({unitID:s,undoMutations:[{id:m.SetDrawingApplyMutation.id,params:{op:g,unitId:s,subUnitId:d,objects:Zt(c),type:m.DrawingApplyType.GROUP}},{id:G.id,params:o}],redoMutations:[{id:m.SetDrawingApplyMutation.id,params:{op:u,unitId:s,subUnitId:d,objects:c,type:m.DrawingApplyType.UNGROUP}},{id:G.id,params:o}]}),!0):!1}};var Qt=Object.getOwnPropertyDescriptor,en=(i,r,t,e)=>{for(var n=e>1?void 0:e?Qt(r,t):r,o=i.length-1,a;o>=0;o--)(a=i[o])&&(n=a(n)||n);return n},ne=(i,r)=>(t,e)=>r(t,e,i);function tn(i,r,t){const e=t*Math.PI/180,n=Math.abs(i*Math.cos(e))+Math.abs(r*Math.sin(e)),o=Math.abs(i*Math.sin(e))+Math.abs(r*Math.cos(e));return{rotatedWidth:n,rotatedHeight:o}}function Ot(i,r,t,e,n){var y;const{rotatedHeight:o,rotatedWidth:a}=tn(t,e,n),d=i.get(j.IRenderManagerService).getRenderById(r.unitId);if(!d)return!1;const u=(y=d.with(E.SheetSkeletonManagerService).getSkeletonParam(r.subUnitId))==null?void 0:y.skeleton;if(u==null)return!1;const c=u.getCellByIndex(r.row,r.col),p=c.mergeInfo.endX-c.mergeInfo.startX-2,h=c.mergeInfo.endY-c.mergeInfo.startY-2,S=a/o,w=Math.ceil(Math.min(p,h*S))/a,_=!w||Number.isNaN(w)?.001:w;return{width:t*_,height:e*_}}let Ae=class extends l.Disposable{constructor(r,t,e,n,o,a,s,d,g,u,c,p,h){super();Q(this,"_workbookSelections");this._context=r,this._skeletonManagerService=t,this._commandService=e,this._selectionRenderService=n,this._imageIoService=o,this._fileOpenerService=a,this._sheetDrawingService=s,this._drawingManagerService=d,this._contextService=g,this._messageService=u,this._localeService=c,this._injector=h,this._workbookSelections=p.getWorkbookSelections(this._context.unitId),this._updateImageListener(),this._updateOrderListener(),this._groupDrawingListener(),this._focusDrawingListener()}async insertFloatImage(){const r=await this._fileOpenerService.openFile({multiple:!0,accept:U.DRAWING_IMAGE_ALLOW_IMAGE_LIST.map(e=>`.${e.replace("image/","")}`).join(",")}),t=r.length;return t>U.DRAWING_IMAGE_COUNT_LIMIT?(this._messageService.show({type:oe.MessageType.Error,content:this._localeService.t("update-status.exceedMaxCount",String(U.DRAWING_IMAGE_COUNT_LIMIT))}),!1):t===0?!1:(r.forEach(async e=>await this.insertFloatImageByFile(e)),!0)}async insertCellImage(){const t=(await this._fileOpenerService.openFile({multiple:!1,accept:U.DRAWING_IMAGE_ALLOW_IMAGE_LIST.map(e=>`.${e.replace("image/","")}`).join(",")}))[0];return t?(await this._insertCellImage(t),!0):!1}async insertFloatImageByFile(r){let t;try{t=await this._imageIoService.saveImage(r)}catch(y){const M=y.message;M===U.ImageUploadStatusType.ERROR_EXCEED_SIZE?this._messageService.show({type:oe.MessageType.Error,content:this._localeService.t("update-status.exceedMaxSize",String(U.DRAWING_IMAGE_ALLOW_SIZE/(1024*1024)))}):M===U.ImageUploadStatusType.ERROR_IMAGE_TYPE?this._messageService.show({type:oe.MessageType.Error,content:this._localeService.t("update-status.invalidImageType")}):M===U.ImageUploadStatusType.ERROR_IMAGE&&this._messageService.show({type:oe.MessageType.Error,content:this._localeService.t("update-status.invalidImage")})}if(t==null)return;const e=this._getUnitInfo(),{unitId:n,subUnitId:o}=e,{imageId:a,imageSourceType:s,source:d,base64Cache:g}=t,{width:u,height:c,image:p}=await U.getImageSize(g||""),{width:h,height:S}=this._context.scene;this._imageIoService.addImageSourceCache(d,s,p);let f=1;if(u>U.DRAWING_IMAGE_WIDTH_LIMIT||c>U.DRAWING_IMAGE_HEIGHT_LIMIT){const y=U.DRAWING_IMAGE_WIDTH_LIMIT/u,M=U.DRAWING_IMAGE_HEIGHT_LIMIT/c;f=Math.max(y,M)}const w=this._getImagePosition(u*f,c*f,h,S);if(w==null)return;const _={unitId:n,subUnitId:o,drawingId:a,drawingType:l.DrawingTypeEnum.DRAWING_IMAGE,imageSourceType:s,source:d,transform:K(w,this._selectionRenderService,this._skeletonManagerService),sheetTransform:w};return this._commandService.executeCommand(Oe.id,{unitId:n,drawings:[_]})}async _insertCellImage(r){let t;try{t=await this._imageIoService.saveImage(r)}catch(w){const _=w.message;_===U.ImageUploadStatusType.ERROR_EXCEED_SIZE?this._messageService.show({type:oe.MessageType.Error,content:this._localeService.t("update-status.exceedMaxSize",String(U.DRAWING_IMAGE_ALLOW_SIZE/(1024*1024)))}):_===U.ImageUploadStatusType.ERROR_IMAGE_TYPE?this._messageService.show({type:oe.MessageType.Error,content:this._localeService.t("update-status.invalidImageType")}):_===U.ImageUploadStatusType.ERROR_IMAGE&&this._messageService.show({type:oe.MessageType.Error,content:this._localeService.t("update-status.invalidImage")})}if(t==null)return;const{imageId:e,imageSourceType:n,source:o,base64Cache:a}=t,{width:s,height:d,image:g}=await U.getImageSize(a||"");this._imageIoService.addImageSourceCache(o,n,g);const u=this._workbookSelections.getCurrentLastSelection();if(!u)return!1;const c=l.createDocumentModelWithStyle("",{}),p=Ot(this._injector,{unitId:this._context.unitId,subUnitId:this._context.unit.getActiveSheet().getSheetId(),row:u.primary.actualRow,col:u.primary.actualColumn},s,d,0);if(!p)return!1;const h={size:{width:p.width,height:p.height},positionH:{relativeFrom:l.ObjectRelativeFromH.PAGE,posOffset:0},positionV:{relativeFrom:l.ObjectRelativeFromV.PARAGRAPH,posOffset:0},angle:0},S={unitId:c.getUnitId(),subUnitId:c.getUnitId(),drawingId:e,drawingType:l.DrawingTypeEnum.DRAWING_IMAGE,imageSourceType:n,source:o,transform:Rt.docDrawingPositionToTransform(h),docTransform:h,behindDoc:l.BooleanNumber.FALSE,title:"",description:"",layoutType:l.PositionedObjectLayoutType.INLINE,wrapText:l.WrapTextType.BOTH_SIDES,distB:0,distL:0,distR:0,distT:0},f=l.BuildTextUtils.drawing.add({documentDataModel:c,drawings:[S],selection:{collapsed:!0,startOffset:0,endOffset:0}});return f?(c.apply(f),this._commandService.syncExecuteCommand(v.SetRangeValuesCommand.id,{value:{[u.primary.actualRow]:{[u.primary.actualColumn]:{p:c.getSnapshot(),t:1}}}})):!1}_getUnitInfo(){const r=this._context.unit,t=r.getActiveSheet(),e=r.getUnitId(),n=t.getSheetId();return{unitId:e,subUnitId:n}}_getImagePosition(r,t,e,n){const o=this._workbookSelections.getCurrentSelections();let a={startRow:0,endRow:0,startColumn:0,endColumn:0};o&&o.length>0&&(a=o[o.length-1].range);const s=E.attachRangeWithCoord(this._skeletonManagerService.getCurrent().skeleton,a);if(s==null)return;let{startColumn:d,startRow:g,startX:u,startY:c}=s,p=!1;if(u+r>e&&(u=e-r,u<0&&(u=0,r=e),p=!0),c+t>n&&(c=n-t,c<0&&(c=0,t=n),p=!0),p){const w=this._selectionRenderService.getCellWithCoordByOffset(u,c);if(w==null)return;u=w.startX,c=w.startY,d=w.actualColumn,g=w.actualRow}const h={column:d,columnOffset:0,row:g,rowOffset:0},S=this._selectionRenderService.getCellWithCoordByOffset(u+r,c+t);if(S==null)return;const f={column:S.actualColumn,columnOffset:u+r-S.startX,row:S.actualRow,rowOffset:c+t-S.startY};return{from:h,to:f}}_updateOrderListener(){this.disposeWithMe(this._drawingManagerService.featurePluginOrderUpdate$.subscribe(r=>{const{unitId:t,subUnitId:e,drawingIds:n,arrangeType:o}=r;this._commandService.executeCommand(St.id,{unitId:t,subUnitId:e,drawingIds:n,arrangeType:o})}))}_updateImageListener(){this.disposeWithMe(this._drawingManagerService.featurePluginUpdate$.subscribe(r=>{const t=[];r.length!==0&&(r.forEach(e=>{const{unitId:n,subUnitId:o,drawingId:a,drawingType:s,transform:d}=e;if(d==null)return;const g=this._sheetDrawingService.getDrawingByParam({unitId:n,subUnitId:o,drawingId:a});if(g==null||g.unitId!==this._context.unitId)return;const u=H({...g.transform,...d},this._selectionRenderService);if(u==null)return;const c={...e,transform:{...g.transform,...d,...K(u,this._selectionRenderService,this._skeletonManagerService)},sheetTransform:{...u}};t.push(c)}),t.length>0&&this._commandService.executeCommand(Pe.id,{unitId:r[0].unitId,drawings:t}))}))}_groupDrawingListener(){this.disposeWithMe(this._drawingManagerService.featurePluginGroupUpdate$.subscribe(r=>{this._commandService.executeCommand(ft.id,r);const{unitId:t,subUnitId:e,drawingId:n}=r[0].parent;this._commandService.syncExecuteCommand(U.SetDrawingSelectedOperation.id,[{unitId:t,subUnitId:e,drawingId:n}])})),this.disposeWithMe(this._drawingManagerService.featurePluginUngroupUpdate$.subscribe(r=>{this._commandService.executeCommand(wt.id,r)}))}_focusDrawingListener(){this.disposeWithMe(this._drawingManagerService.focus$.subscribe(r=>{r==null||r.length===0?(this._contextService.setContextValue(l.FOCUSING_COMMON_DRAWINGS,!1),this._sheetDrawingService.focusDrawing([])):(this._contextService.setContextValue(l.FOCUSING_COMMON_DRAWINGS,!0),this._sheetDrawingService.focusDrawing(r))}))}};Ae=en([ne(1,l.Inject(E.SheetSkeletonManagerService)),ne(2,l.ICommandService),ne(3,E.ISheetSelectionRenderService),ne(4,U.IImageIoService),ne(5,Y.ILocalFileService),ne(6,m.ISheetDrawingService),ne(7,U.IDrawingManagerService),ne(8,l.IContextService),ne(9,Y.IMessageService),ne(10,l.Inject(l.LocaleService)),ne(11,l.Inject(v.SheetsSelectionsService)),ne(12,l.Inject(l.Injector))],Ae);var nn=Object.getOwnPropertyDescriptor,rn=(i,r,t,e)=>{for(var n=e>1?void 0:e?nn(r,t):r,o=i.length-1,a;o>=0;o--)(a=i[o])&&(n=a(n)||n);return n},ve=(i,r)=>(t,e)=>r(t,e,i);function vt(i,r,t){var e,n,o,a;if(((n=(e=t==null?void 0:t.p)==null?void 0:e.body)==null?void 0:n.dataStream.length)===3&&((a=(o=t.p)==null?void 0:o.drawingsOrder)==null?void 0:a.length)===1){const s=t.p.drawings[t.p.drawingsOrder[0]],d=Ot(i,{unitId:r.unitId,subUnitId:r.subUnitId,row:r.row,col:r.col},s.docTransform.size.width,s.docTransform.size.height,s.docTransform.angle);if(d)return s.transform.width=d.width,s.transform.height=d.height,s.docTransform.size.width=d.width,s.docTransform.size.height=d.height,s.transform.left=0,s.transform.top=0,s.docTransform.positionH.posOffset=0,s.docTransform.positionV.posOffset=0,t.p.documentStyle.pageSize.width=1/0,t.p.documentStyle.pageSize.height=1/0,!0}return!1}let Ve=class extends l.Disposable{constructor(i,r,t,e,n,o,a){super(),this._commandService=i,this._sheetInterceptorService=r,this._univerInstanceService=t,this._injector=e,this._drawingManagerService=n,this._docDrawingController=o,this._editorBridgeService=a,this._initHandleResize(),this._handleInitEditor(),this._handleWriteCell(),this._initCellContentInterceptor()}_initHandleResize(){this.disposeWithMe(this._commandService.onCommandExecuted(i=>{let r,t=[];if(i.id===v.SetWorksheetRowHeightMutation.id){const e=i.params;t=e.ranges,r=v.getSheetCommandTarget(this._univerInstanceService,{unitId:e.unitId,subUnitId:e.subUnitId})}else if(i.id===v.SetWorksheetColWidthMutation.id){const e=i.params;t=e.ranges,r=v.getSheetCommandTarget(this._univerInstanceService,{unitId:e.unitId,subUnitId:e.subUnitId})}else if(i.id===v.SetWorksheetRowIsAutoHeightMutation.id){const e=i.params;t=e.ranges,r=v.getSheetCommandTarget(this._univerInstanceService,{unitId:e.unitId,subUnitId:e.subUnitId})}else if(i.id===v.SetWorksheetRowAutoHeightMutation.id){const e=i.params;r=v.getSheetCommandTarget(this._univerInstanceService,{unitId:e.unitId,subUnitId:e.subUnitId}),t=e.rowsAutoHeightInfo.map(n=>({startRow:n.row,endRow:n.row,startColumn:0,endColumn:9999}))}else if(i.id===v.AddWorksheetMergeMutation.id){const e=i.params;t=e.ranges,r=v.getSheetCommandTarget(this._univerInstanceService,{unitId:e.unitId,subUnitId:e.subUnitId})}else if(i.id===v.RemoveWorksheetMergeMutation.id){const e=i.params;t=e.ranges,r=v.getSheetCommandTarget(this._univerInstanceService,{unitId:e.unitId,subUnitId:e.subUnitId})}r&&t.length&&t.forEach(e=>{const n=l.Range.transformRange(e,r.worksheet);for(let o=n.startRow;o<=n.endRow;o++)for(let a=n.startColumn;a<=n.endColumn;a++)vt(this._injector,{unitId:r.unitId,subUnitId:r.subUnitId,row:o,col:a},r.worksheet.getCellRaw(o,a))})}))}_handleInitEditor(){this.disposeWithMe(this._editorBridgeService.visible$.subscribe(i=>{i.visible?i.visible&&(this._drawingManagerService.removeDrawingDataForUnit(l.DOCS_NORMAL_EDITOR_UNIT_ID_KEY),this._docDrawingController.loadDrawingDataForUnit(l.DOCS_NORMAL_EDITOR_UNIT_ID_KEY),this._drawingManagerService.initializeNotification(l.DOCS_NORMAL_EDITOR_UNIT_ID_KEY)):this._drawingManagerService.removeDrawingDataForUnit(l.DOCS_NORMAL_EDITOR_UNIT_ID_KEY)})),this.disposeWithMe(this._commandService.onCommandExecuted(i=>{i.id===Rt.ReplaceSnapshotCommand.id&&i.params.unitId===l.DOCS_ZEN_EDITOR_UNIT_ID_KEY&&(this._drawingManagerService.removeDrawingDataForUnit(l.DOCS_ZEN_EDITOR_UNIT_ID_KEY),this._docDrawingController.loadDrawingDataForUnit(l.DOCS_ZEN_EDITOR_UNIT_ID_KEY),this._drawingManagerService.initializeNotification(l.DOCS_ZEN_EDITOR_UNIT_ID_KEY))}))}_handleWriteCell(){this.disposeWithMe(this._sheetInterceptorService.writeCellInterceptor.intercept(v.AFTER_CELL_EDIT,{priority:9999,handler:(i,r,t)=>(vt(this._injector,{unitId:r.unitId,subUnitId:r.subUnitId,row:r.row,col:r.col},i),t(i))}))}_initCellContentInterceptor(){this.disposeWithMe(this._sheetInterceptorService.intercept(v.INTERCEPTOR_POINT.CELL_CONTENT,{effect:l.InterceptorEffectEnum.Style,priority:v.InterceptCellContentPriority.CELL_IMAGE,handler:(i,r,t)=>{var e;return i!=null&&i.p&&((e=i.p.drawingsOrder)!=null&&e.length)&&(i.interceptorStyle||(i.interceptorStyle={}),i.interceptorStyle.tr={a:0}),t(i)}}))}};Ve=rn([ve(0,l.ICommandService),ve(1,l.Inject(v.SheetInterceptorService)),ve(2,l.IUniverInstanceService),ve(3,l.Inject(l.Injector)),ve(4,U.IDrawingManagerService),ve(5,l.Inject(we.DocDrawingController)),ve(6,l.Inject(E.IEditorBridgeService))],Ve);var on=Object.getOwnPropertyDescriptor,an=(i,r,t,e)=>{for(var n=e>1?void 0:e?on(r,t):r,o=i.length-1,a;o>=0;o--)(a=i[o])&&(n=a(n)||n);return n},Pt=(i,r)=>(t,e)=>r(t,e,i);let Xe=class extends l.Disposable{constructor(i,r){super(),this._autoFillService=i,this._injector=r,this._initAutoFillHooks()}_initAutoFillHooks(){this.disposeWithMe(this._autoFillService.addHook({id:"sheet-cell-image-autofill",onBeforeSubmit:(i,r,t,e)=>{new l.ObjectMatrix(e).forValue((n,o,a)=>{vt(this._injector,{unitId:i.unitId,subUnitId:i.subUnitId,row:n,col:o},a)})}}))}};Xe=an([Pt(0,l.Inject(E.IAutoFillService)),Pt(1,l.Inject(l.Injector))],Xe);var sn=Object.getOwnPropertyDescriptor,cn=(i,r,t,e)=>{for(var n=e>1?void 0:e?sn(r,t):r,o=i.length-1,a;o>=0;o--)(a=i[o])&&(n=a(n)||n);return n},xe=(i,r)=>(t,e)=>r(t,e,i);let Ke=class extends l.Disposable{constructor(r,t,e,n){super();Q(this,"_isSetCursor",!1);this._hoverManagerService=r,this._renderManagerService=t,this._selectionsService=e,this._drawingRenderService=n}_initHover(){}_initImageClick(){}};Ke=cn([xe(0,l.Inject(E.HoverManagerService)),xe(1,l.Inject(j.IRenderManagerService)),xe(2,l.Inject(v.SheetsSelectionsService)),xe(3,l.Inject(pe.DrawingRenderService))],Ke);const Ue={id:"sheet.command.insert-float-image",type:l.CommandType.COMMAND,handler:async(i,r)=>{var o,a;const e=(o=i.get(j.IRenderManagerService).getCurrentTypeOfRenderer(l.UniverInstanceType.UNIVER_SHEET))==null?void 0:o.with(Ae);if(!e)return!1;const n=r==null?void 0:r.files;if(n){const s=n.map(d=>e.insertFloatImageByFile(d));return(await Promise.all(s)).every(d=>d)}else return(a=e.insertFloatImage())!=null?a:!1}},_t={id:"sheet.command.insert-cell-image",type:l.CommandType.COMMAND,handler:i=>{var t,e;return(e=(t=i.get(j.IRenderManagerService).getCurrentTypeOfRenderer(l.UniverInstanceType.UNIVER_SHEET))==null?void 0:t.with(Ae).insertCellImage())!=null?e:!1}};var dn=Object.getOwnPropertyDescriptor,ln=(i,r,t,e)=>{for(var n=e>1?void 0:e?dn(r,t):r,o=i.length-1,a;o>=0;o--)(a=i[o])&&(n=a(n)||n);return n},Ne=(i,r)=>(t,e)=>r(t,e,i);const At="image/png";function un(i){const r=i.split(","),t=atob(r[1]),e=t.length,n=new Uint8Array(e);for(let o=0;o<e;o++)n[o]=t.charCodeAt(o);return new Blob([n],{type:At})}function gn(i){const r=new ClipboardItem({[At]:un(i)});navigator.clipboard.write([r]).catch(t=>{console.error("Could not copy image using clipboard API: ",t)})}function hn(){function i(){const e=document.createElement("input");return e.style.position="absolute",e.style.height="1px",e.style.width="1px",e.style.opacity="0",e}const r=document.activeElement,t=i();return document.body.appendChild(t),t.focus(),()=>{t.blur(),document.body.removeChild(t),r instanceof HTMLElement&&r.focus()}}const Ut=[E.PREDEFINED_HOOK_NAME.SPECIAL_PASTE_COL_WIDTH,E.PREDEFINED_HOOK_NAME.SPECIAL_PASTE_VALUE,E.PREDEFINED_HOOK_NAME.SPECIAL_PASTE_FORMAT,E.PREDEFINED_HOOK_NAME.SPECIAL_PASTE_FORMULA];let ze=class extends l.Disposable{constructor(r,t,e,n,o){super();Q(this,"_copyInfo");this._sheetClipboardService=r,this._renderManagerService=t,this._drawingService=e,this._clipboardInterfaceService=n,this._commandService=o,this._initCopyPaste()}get _focusedDrawings(){return this._drawingService.getFocusDrawings()}_initCopyPaste(){this._sheetClipboardService.addClipboardHook({id:"SHEET_IMAGE_UI_PLUGIN",onBeforeCopy:(r,t,e,n)=>{const o=this._focusedDrawings;if(o.length>0){const[a]=o;if(n===E.COPY_TYPE.CUT){const d={unitId:r,drawings:[a]};this._commandService.executeCommand(Ie.id,d)}setTimeout(()=>{const d=hn();a.drawingType===l.DrawingTypeEnum.DRAWING_IMAGE&&a.imageSourceType===U.ImageSourceType.BASE64?gn(a.source):this._clipboardInterfaceService.writeText(""),d()},200);const s={unitId:a.unitId,subUnitId:a.subUnitId,drawings:[a]};this._copyInfo=s}else{const a=this._createDrawingsCopyInfoByRange(r,t,e);this._copyInfo=a}},onPasteCells:(r,t,e,n)=>{if(!this._copyInfo)return{redos:[],undos:[]};const{copyType:o=E.COPY_TYPE.COPY,pasteType:a}=n,{range:s}=r||{},{range:d,unitId:g,subUnitId:u}=t;return this._copyInfo.copyRange?this._generateRangeDrawingsPasteMutations({pasteType:a,unitId:g,subUnitId:u,pasteRange:d},{copyRange:s,copyType:o}):this._generateSingleDrawingPasteMutations({pasteTo:t,pasteType:a},E.COPY_TYPE.COPY)},onPastePlainText:(r,t)=>({undos:[],redos:[]}),onPasteUnrecognized:r=>this._copyInfo?this._generateSingleDrawingPasteMutations({pasteTo:r,pasteType:E.PREDEFINED_HOOK_NAME.DEFAULT_PASTE},E.COPY_TYPE.COPY):{undos:[],redos:[]},onPasteFiles:(r,t)=>{if(this._copyInfo)return this._generateSingleDrawingPasteMutations({pasteTo:r,pasteType:E.PREDEFINED_HOOK_NAME.DEFAULT_PASTE},E.COPY_TYPE.COPY);{const e=t.filter(n=>n.type.includes("image"));if(e.length)return{undos:[],redos:[{id:Ue.id,params:{files:e}}]}}return{undos:[],redos:[]}}})}_createDrawingsCopyInfoByRange(r,t,e){var p;const n=(p=this._renderManagerService.getRenderById(r))==null?void 0:p.with(E.SheetSkeletonManagerService);if(!n)return;const o=n.attachRangeWithCoord(e);if(!o)return;const{startX:a,endX:s,startY:d,endY:g}=o,u=this._drawingService.getDrawingData(r,t),c=this._focusedDrawings.slice();if(Object.keys(u).forEach(h=>{const S=u[h],{transform:f}=S;if(S.anchorType!==m.SheetDrawingAnchorType.Both||!f)return;const{left:w=0,top:_=0,width:y=0,height:M=0}=f,{drawingStartX:R,drawingEndX:C,drawingStartY:T,drawingEndY:I}={drawingStartX:w,drawingEndX:w+y,drawingStartY:_,drawingEndY:_+M};a<=R&&C<=s&&d<=T&&I<=g&&c.push(S)}),c.length)return{copyRange:e,drawings:c,unitId:r,subUnitId:t}}_generateSingleDrawingPasteMutations(r,t){const{pasteType:e,pasteTo:n}=r;if(Ut.includes(e))return{redos:[],undos:[]};const{unitId:o,subUnitId:a,range:s}=n,d=this._renderManagerService.getRenderById(o),g=d==null?void 0:d.with(E.SheetSkeletonManagerService),u=d==null?void 0:d.with(E.ISheetSelectionRenderService),c=this._copyInfo;if(!g||!u)return{redos:[],undos:[]};const{drawings:p}=c,h=E.discreteRangeToRange(s);return this._generateMutations(p,{unitId:o,subUnitId:a,isCut:t===E.COPY_TYPE.CUT,getTransform:(S,f)=>{var y;const w=g.attachRangeWithCoord({startRow:h.startRow,endRow:h.endRow,startColumn:h.startColumn,endColumn:h.endColumn}),_={...S,left:w==null?void 0:w.startX,top:w==null?void 0:w.startY};return{transform:_,sheetTransform:(y=H(_,u))!=null?y:f}}})}_generateMutations(r,t){const{unitId:e,subUnitId:n,getTransform:o,isCut:a}=t,s=[],d=[],{_drawingService:g}=this;return r.forEach(u=>{const{transform:c,sheetTransform:p}=u;if(!c)return;const h=o(c,p),S={...u,unitId:e,subUnitId:n,drawingId:a?u.drawingId:l.Tools.generateRandomId(),transform:h.transform,sheetTransform:h.sheetTransform};if(a){const{undo:f,redo:w,objects:_}=g.getBatchUpdateOp([S]);s.push({id:m.SetDrawingApplyMutation.id,params:{unitId:e,subUnitId:n,type:m.DrawingApplyType.UPDATE,op:w,objects:_}}),d.push({id:m.SetDrawingApplyMutation.id,params:{unitId:e,subUnitId:n,type:m.DrawingApplyType.UPDATE,op:f,objects:_}})}else{const{undo:f,redo:w,objects:_}=g.getBatchAddOp([S]);s.push({id:m.SetDrawingApplyMutation.id,params:{op:w,unitId:e,subUnitId:n,objects:_,type:m.DrawingApplyType.INSERT}}),d.push({id:m.SetDrawingApplyMutation.id,params:{op:f,unitId:e,subUnitId:n,objects:_,type:m.DrawingApplyType.REMOVE}})}}),{redos:s,undos:d}}_generateRangeDrawingsPasteMutations(r,t){var k;const{unitId:e,subUnitId:n,pasteType:o,pasteRange:a}=r,{copyRange:s,copyType:d}=t;if(Ut.includes(o))return{redos:[],undos:[]};const g=(k=this._renderManagerService.getRenderById(e))==null?void 0:k.with(E.SheetSkeletonManagerService);if(!g||!this._copyInfo)return{redos:[],undos:[]};const{drawings:u}=this._copyInfo;if(!s)return this._generateSingleDrawingPasteMutations({pasteTo:{unitId:e,subUnitId:n,range:E.discreteRangeToRange(a)},pasteType:o},d);const{ranges:[c,p],mapFunc:h}=E.virtualizeDiscreteRanges([s,a]),{row:S,col:f}=h(c.startRow,c.startColumn),{row:w,col:_}=h(p.startRow,p.startColumn),y=g.attachRangeWithCoord({startRow:S,endRow:S,startColumn:f,endColumn:f}),M=g.attachRangeWithCoord({startRow:w,endRow:w,startColumn:_,endColumn:_});if(!y||!M||!this._copyInfo)return{redos:[],undos:[]};const R=M.startX-y.startX,C=M.startY-y.startY,T=w-S,I=_-f;return this._generateMutations(u,{unitId:e,subUnitId:n,getTransform:(b,W)=>{var A,O;return{transform:{...b,left:((A=b==null?void 0:b.left)!=null?A:0)+R,top:((O=b==null?void 0:b.top)!=null?O:0)+C},sheetTransform:{...W,to:{...W.to,row:W.to.row+T,column:W.to.column+I},from:{...W.from,row:W.from.row+T,column:W.from.column+I}}}},isCut:d===E.COPY_TYPE.CUT})}};ze=ln([Ne(0,E.ISheetClipboardService),Ne(1,j.IRenderManagerService),Ne(2,U.IDrawingManagerService),Ne(3,Y.IClipboardInterfaceService),Ne(4,l.ICommandService)],ze);var pn=Object.getOwnPropertyDescriptor,mn=(i,r,t,e)=>{for(var n=e>1?void 0:e?pn(r,t):r,o=i.length-1,a;o>=0;o--)(a=i[o])&&(n=a(n)||n);return n},ke=(i,r)=>(t,e)=>r(t,e,i);let qe=class extends l.Disposable{constructor(i,r,t,e,n){super(),this._drawingManagerService=i,this._renderManagerService=r,this._permissionService=t,this._univerInstanceService=e,this._userManagerService=n,this._initDrawingVisible(),this._initDrawingEditable(),this._initViewPermissionChange(),this._initEditPermissionChange()}_initDrawingVisible(){const i=this._univerInstanceService.getCurrentTypeOfUnit$(l.UniverInstanceType.UNIVER_SHEET),r=this._userManagerService.currentUser$,t=N.combineLatest([i,r]);this.disposeWithMe(t.pipe(N.switchMap(([e,n])=>e?e.activeSheet$.pipe(N.tap(o=>{if(!o){this._drawingManagerService.setDrawingVisible(!1);return}const a=e.getUnitId(),s=o.getSheetId();this._permissionService.composePermission([new v.WorkbookViewPermission(a).id,new v.WorksheetViewPermission(a,s).id]).every(g=>g.value)?this._drawingManagerService.setDrawingVisible(!0):this._handleDrawingVisibilityFalse(e,o)})):(this._drawingManagerService.setDrawingVisible(!1),N.EMPTY))).subscribe())}_handleDrawingVisibilityFalse(i,r){this._drawingManagerService.setDrawingVisible(!1);const t=i.getUnitId(),e=r.getSheetId(),n=this._drawingManagerService.getDrawingData(t,e),o=Object.values(n),a=this._renderManagerService.getRenderById(t),s=a==null?void 0:a.scene;if(!s)return;s.getAllObjectsByOrder().forEach(g=>{g.classType===j.RENDER_CLASS_TYPE.IMAGE&&o.some(u=>g.oKey.includes(u.drawingId))&&s.removeObject(g)})}_initDrawingEditable(){const i=this._univerInstanceService.getCurrentTypeOfUnit$(l.UniverInstanceType.UNIVER_SHEET),r=this._userManagerService.currentUser$,t=N.combineLatest([i,r]);this.disposeWithMe(t.pipe(N.switchMap(([e,n])=>e?e.activeSheet$.pipe(N.tap(o=>{if(!o){this._drawingManagerService.setDrawingEditable(!1);return}const a=e.getUnitId(),s=o.getSheetId();this._permissionService.composePermission([new v.WorkbookEditablePermission(a).id,new v.WorksheetEditPermission(a,s).id]).every(g=>g.value)?this._drawingManagerService.setDrawingEditable(!0):this._handleDrawingEditableFalse(e,o)})):(this._drawingManagerService.setDrawingEditable(!1),N.EMPTY))).subscribe())}_handleDrawingEditableFalse(i,r){this._drawingManagerService.setDrawingEditable(!1);const t=i.getUnitId(),e=r.getSheetId(),n=this._drawingManagerService.getDrawingData(t,e),o=Object.values(n),a=this._renderManagerService.getRenderById(t),s=a==null?void 0:a.scene;if(!s)return;s.getAllObjectsByOrder().forEach(g=>{g.classType===j.RENDER_CLASS_TYPE.IMAGE&&o.some(u=>g.oKey.includes(u.drawingId))&&s.detachTransformerFrom(g)})}_initViewPermissionChange(){const i=this._univerInstanceService.getCurrentTypeOfUnit$(l.UniverInstanceType.UNIVER_SHEET),r=this._userManagerService.currentUser$;this.disposeWithMe(N.combineLatest([i,r]).pipe(N.switchMap(([t,e])=>t?t.activeSheet$.pipe(N.switchMap(n=>{if(!n)return N.EMPTY;const o=t.getUnitId(),a=n.getSheetId(),s=this._renderManagerService.getRenderById(o),d=s==null?void 0:s.scene;if(!d)return N.EMPTY;const g=d.getTransformerByCreate();return this._permissionService.composePermission$([new v.WorkbookViewPermission(o).id,new v.WorksheetViewPermission(o,a).id]).pipe(N.map(c=>c.every(p=>p.value)),N.distinctUntilChanged()).pipe(N.map(c=>({permission:c,scene:d,transformer:g,unitId:o,subUnitId:a})))})):N.EMPTY)).subscribe({next:({permission:t,scene:e,transformer:n,unitId:o,subUnitId:a})=>{this._drawingManagerService.setDrawingVisible(t);const s=e.getAllObjectsByOrder(),d=this._drawingManagerService.getDrawingData(o,a),g=Object.values(d);t?this._drawingManagerService.addNotification(g):(s.forEach(u=>{u.classType===j.RENDER_CLASS_TYPE.IMAGE&&g.some(c=>u.oKey.includes(c.drawingId))&&e.removeObject(u)}),n.clearSelectedObjects())},complete:()=>{this._drawingManagerService.setDrawingVisible(!0);const t=this._univerInstanceService.getCurrentUnitForType(l.UniverInstanceType.UNIVER_SHEET),e=t==null?void 0:t.getActiveSheet(),n=t==null?void 0:t.getUnitId(),o=e==null?void 0:e.getSheetId();if(!n||!o)return;const a=this._drawingManagerService.getDrawingData(n,o),s=Object.values(a);this._drawingManagerService.addNotification(s)}}))}_initEditPermissionChange(){const i=this._univerInstanceService.getCurrentTypeOfUnit$(l.UniverInstanceType.UNIVER_SHEET),r=this._userManagerService.currentUser$;this.disposeWithMe(N.combineLatest([i,r]).pipe(N.switchMap(([t,e])=>t?t.activeSheet$.pipe(N.switchMap(n=>{if(!n)return N.EMPTY;const o=t.getUnitId(),a=n.getSheetId(),s=this._renderManagerService.getRenderById(o),d=s==null?void 0:s.scene;if(!d)return N.EMPTY;const g=d.getTransformerByCreate();return this._permissionService.composePermission$([new v.WorkbookEditablePermission(o).id,new v.WorksheetEditPermission(o,a).id]).pipe(N.map(c=>c.every(p=>p.value)),N.distinctUntilChanged()).pipe(N.map(c=>({permission:c,scene:d,transformer:g,unitId:o,subUnitId:a})))})):N.EMPTY)).subscribe({next:({permission:t,scene:e,transformer:n,unitId:o,subUnitId:a})=>{this._drawingManagerService.setDrawingEditable(t);const s=e.getAllObjectsByOrder(),d=this._drawingManagerService.getDrawingData(o,a),g=Object.values(d);t?(s.forEach(u=>{u.classType===j.RENDER_CLASS_TYPE.IMAGE&&g.some(c=>u.oKey.includes(c.drawingId))&&e.attachTransformerTo(u)}),this._drawingManagerService.addNotification(g)):(s.forEach(u=>{u.classType===j.RENDER_CLASS_TYPE.IMAGE&&g.some(c=>u.oKey.includes(c.drawingId))&&e.detachTransformerFrom(u)}),n.clearSelectedObjects())},complete:()=>{const t=this._univerInstanceService.getCurrentUnitForType(l.UniverInstanceType.UNIVER_SHEET);if(!t)return;const e=t.getUnitId(),n=t.getActiveSheet();if(!n)return;const o=n.getSheetId(),a=this._renderManagerService.getRenderById(e),s=a==null?void 0:a.scene;if(!s)return;const d=this._drawingManagerService.getDrawingData(e,o),g=Object.values(d);this._drawingManagerService.setDrawingEditable(!0),s.getAllObjectsByOrder().forEach(c=>{c.classType===j.RENDER_CLASS_TYPE.IMAGE&&g.some(p=>c.oKey.includes(p.drawingId))&&s.detachTransformerFrom(c)})}}))}};qe=mn([ke(0,U.IDrawingManagerService),ke(1,j.IRenderManagerService),ke(2,l.IPermissionService),ke(3,l.IUniverInstanceService),ke(4,l.Inject(l.UserManagerService))],qe);var fn=Object.getOwnPropertyDescriptor,Sn=(i,r,t,e)=>{for(var n=e>1?void 0:e?fn(r,t):r,o=i.length-1,a;o>=0;o--)(a=i[o])&&(n=a(n)||n);return n},Ze=(i,r)=>(t,e)=>r(t,e,i);let Je=class extends l.Disposable{constructor(i,r,t,e){super(),this._sheetPrintInterceptorService=i,this._drawingRenderService=r,this._drawingManagerService=t,this._renderManagerService=e,this._initPrinting()}_initPrinting(){this.disposeWithMe(this._sheetPrintInterceptorService.interceptor.intercept(this._sheetPrintInterceptorService.interceptor.getInterceptPoints().PRINTING_COMPONENT_COLLECT,{handler:(i,r,t)=>{const{unitId:e,scene:n,subUnitId:o}=r,a=this._drawingManagerService.getDrawingDataForUnit(e),s=a==null?void 0:a[o];return s&&s.order.forEach(d=>{this._drawingRenderService.renderDrawing(s.data[d],n)}),t()}})),this.disposeWithMe(this._sheetPrintInterceptorService.interceptor.intercept(this._sheetPrintInterceptorService.interceptor.getInterceptPoints().PRINTING_RANGE,{handler:(i,r,t)=>{const{unitId:e,subUnitId:n}=r,o=this._renderManagerService.getRenderById(e);if(!o)return t(i);const a=o.with(E.SheetSkeletonManagerService).getSkeletonParam(n);if(!a)return t(i);const s=this._drawingManagerService.getDrawingDataForUnit(e),d=s==null?void 0:s[r.subUnitId];if(!d)return t(i);const{scaleX:g,scaleY:u}=o.scene,c=i?{...i}:{startColumn:0,endColumn:0,endRow:0,startRow:0},p=d.order.map(h=>d.data[h]).filter(h=>h.drawingType!==l.DrawingTypeEnum.DRAWING_DOM);return p.length?(p.forEach(h=>{if(!h.groupId&&h.transform&&l.Tools.isDefine(h.transform.left)&&l.Tools.isDefine(h.transform.top)&&l.Tools.isDefine(h.transform.width)&&l.Tools.isDefine(h.transform.height)){const S=a.skeleton.getCellIndexByOffset(h.transform.left,h.transform.top,g,u,{x:0,y:0}),f=a.skeleton.getCellIndexByOffset(h.transform.left+h.transform.width,h.transform.top+h.transform.height,g,u,{x:0,y:0});S.column<c.startColumn&&(c.startColumn=S.column),S.row<c.startRow&&(c.startRow=S.row),c.endRow<f.row&&(c.endRow=f.row),c.endColumn<f.column&&(c.endColumn=f.column)}}),t(c)):t(i)}}))}};Je=Sn([Ze(0,l.Inject(E.SheetPrintInterceptorService)),Ze(1,l.Inject(pe.DrawingRenderService)),Ze(2,U.IDrawingManagerService),Ze(3,j.IRenderManagerService)],Je);var wn=Object.getOwnPropertyDescriptor,vn=(i,r,t,e)=>{for(var n=e>1?void 0:e?wn(r,t):r,o=i.length-1,a;o>=0;o--)(a=i[o])&&(n=a(n)||n);return n},fe=(i,r)=>(t,e)=>r(t,e,i);const _n=[v.InsertRowCommand.id,v.InsertColCommand.id,v.RemoveRowCommand.id,v.RemoveColCommand.id,v.DeleteRangeMoveLeftCommand.id,v.DeleteRangeMoveUpCommand.id,v.InsertRangeMoveDownCommand.id,v.InsertRangeMoveRightCommand.id,v.DeltaRowHeightCommand.id,v.SetRowHeightCommand.id,v.DeltaColumnWidthCommand.id,v.SetColWidthCommand.id,v.SetRowHiddenCommand.id,v.SetSpecificRowsVisibleCommand.id,v.SetSpecificColsVisibleCommand.id,v.SetColHiddenCommand.id,v.MoveColsCommand.id,v.MoveRowsCommand.id,v.MoveRangeCommand.id],In=[v.SetRowVisibleMutation.id,v.SetRowHiddenMutation.id,v.SetColVisibleMutation.id,v.SetColHiddenMutation.id,v.SetWorksheetRowHeightMutation.id,v.SetWorksheetColWidthMutation.id];let It=class extends l.Disposable{constructor(i,r,t,e,n,o,a,s,d){super(),this._context=i,this._renderManagerService=r,this._commandService=t,this._selectionRenderService=e,this._skeletonManagerService=n,this._sheetInterceptorService=o,this._sheetDrawingService=a,this._drawingManagerService=s,this._univerInstanceService=d,this._sheetInterceptorListener(),this._commandListener(),this._sheetRefreshListener()}_sheetInterceptorListener(){this.disposeWithMe(this._sheetInterceptorService.interceptCommand({getMutations:i=>{if(!_n.includes(i.id))return{redos:[],undos:[]};if(i.params==null)return{redos:[],undos:[]};const r=i.id;if(r===v.InsertRowCommand.id)return this._moveRowInterceptor(i.params,"insert");if([v.MoveColsCommand.id,v.MoveRowsCommand.id,v.MoveRangeCommand.id].includes(r))return this._moveRangeInterceptor(i.params);if(r===v.InsertColCommand.id)return this._moveColInterceptor(i.params,"insert");if(r===v.RemoveRowCommand.id)return this._moveRowInterceptor(i.params,"remove");if(r===v.RemoveColCommand.id)return this._moveColInterceptor(i.params,"remove");if(r===v.DeleteRangeMoveLeftCommand.id){const{range:t}=i.params;return this._getRangeMoveUndo(t,0)}else if(r===v.DeleteRangeMoveUpCommand.id){const{range:t}=i.params;return this._getRangeMoveUndo(t,1)}else if(r===v.InsertRangeMoveDownCommand.id){const{range:t}=i.params;return this._getRangeMoveUndo(t,2)}else if(r===v.InsertRangeMoveRightCommand.id){const{range:t}=i.params;return this._getRangeMoveUndo(t,3)}else if(r===v.SetRowHiddenCommand.id||r===v.SetSpecificRowsVisibleCommand.id){const t=i.params,{unitId:e,subUnitId:n,ranges:o}=t;return this._getDrawingUndoForRowVisible(e,n,o)}else if(r===v.SetSpecificColsVisibleCommand.id||r===v.SetColHiddenCommand.id){const t=i.params,{unitId:e,subUnitId:n,ranges:o}=t;return this._getDrawingUndoForColVisible(e,n,o)}else if(r===v.DeltaRowHeightCommand.id||r===v.SetRowHeightCommand.id||r===v.DeltaColumnWidthCommand.id||r===v.SetColWidthCommand.id){const t=i.params,{unitId:e,subUnitId:n,ranges:o}=t,a=r===v.DeltaRowHeightCommand.id||r===v.SetRowHeightCommand.id;return this._getDrawingUndoForRowAndColSize(e,n,o,a)}return{redos:[],undos:[]}}}))}_getRangeMoveUndo(i,r){const t=v.getSheetCommandTarget(this._univerInstanceService);if(t==null)return{redos:[],undos:[]};const e=t.unitId,n=t.subUnitId,o=[],a=[],s=this._sheetDrawingService.getDrawingData(e,n),d=[],g=[];if(Object.keys(s).forEach(u=>{const c=s[u],{updateDrawings:p,deleteDrawings:h}=this._getUpdateOrDeleteDrawings(i,r,c);d.push(...p),g.push(...h)}),d.length===0&&g.length===0)return{redos:[],undos:[]};if(d.length>0){const u=this._sheetDrawingService.getBatchUpdateOp(d),{undo:c,redo:p,objects:h}=u;o.push({id:m.SetDrawingApplyMutation.id,params:{unitId:e,subUnitId:n,op:p,objects:h,type:m.DrawingApplyType.UPDATE}}),a.push({id:m.SetDrawingApplyMutation.id,params:{unitId:e,subUnitId:n,op:c,objects:h,type:m.DrawingApplyType.UPDATE}})}if(g.length>0){const u=this._sheetDrawingService.getBatchRemoveOp(g),c=u.undo,p=u.redo,h=u.objects;o.push({id:m.SetDrawingApplyMutation.id,params:{unitId:e,subUnitId:n,op:p,objects:h,type:m.DrawingApplyType.REMOVE}}),a.push({id:m.SetDrawingApplyMutation.id,params:{unitId:e,subUnitId:n,op:c,objects:h,type:m.DrawingApplyType.INSERT}})}return o.push({id:G.id,params:[e]}),a.push({id:G.id,params:[e]}),{redos:o,undos:a}}_getUpdateOrDeleteDrawings(i,r,t){const e=[],n=[],{sheetTransform:o,anchorType:a=m.SheetDrawingAnchorType.Position,transform:s,unitId:d,subUnitId:g,drawingId:u}=t,{from:c,to:p}=o,{row:h,column:S}=c,{row:f,column:w}=p;if(o==null||s==null)return{updateDrawings:e,deleteDrawings:n};const{startRow:_,endRow:y,startColumn:M,endColumn:R}=i;let C=null,T=null;if(r===0&&h>=_&&f<=y)if(S>=M&&w<=R)n.push({unitId:d,subUnitId:g,drawingId:u});else{const I=this._shrinkCol(o,s,M,R,a);C=I==null?void 0:I.newSheetTransform,T=I==null?void 0:I.newTransform}else if(r===1&&S>=M&&w<=R)if(h>=_&&f<=y)n.push({unitId:d,subUnitId:g,drawingId:u});else{const I=this._shrinkRow(o,s,_,y,a);C=I==null?void 0:I.newSheetTransform,T=I==null?void 0:I.newTransform}else if(r===2){const I=this._expandRow(o,s,_,y,a);C=I==null?void 0:I.newSheetTransform,T=I==null?void 0:I.newTransform}else if(r===3){const I=this._expandCol(o,s,M,R,a);C=I==null?void 0:I.newSheetTransform,T=I==null?void 0:I.newTransform}if(C!=null&&T!=null){const I=K(C,this._selectionRenderService,this._skeletonManagerService);e.push({...t,sheetTransform:C,transform:I})}return{updateDrawings:e,deleteDrawings:n}}_remainDrawingSize(i,r,t){const e=H({...i},this._selectionRenderService);e!=null&&r.push({...t,sheetTransform:e})}_getDrawingUndoForColVisible(i,r,t){const e=this._drawingManagerService.getDrawingData(i,r),n=[],o=[];if(Object.keys(e).forEach(u=>{const c=e[u],{sheetTransform:p,transform:h,anchorType:S=m.SheetDrawingAnchorType.Position}=c;if(S===m.SheetDrawingAnchorType.None)this._remainDrawingSize(h,n,c);else{const{from:f,to:w}=p,{row:_,column:y}=f,{row:M,column:R}=w;for(let C=0;C<t.length;C++){const T=t[C],{startRow:I,endRow:k,startColumn:b,endColumn:W}=T;if(R<b)continue;if(S===m.SheetDrawingAnchorType.Position){let D=null,L=null;if(y>=b&&y<=W){const B=this._skeletonManagerService.attachRangeWithCoord({startColumn:y,endColumn:W,startRow:f.row,endRow:w.row});if(B==null)return;L={...h,left:B.startX}}if(L!=null&&(D=H(L,this._selectionRenderService),D!=null&&L!=null)){n.push({...c,sheetTransform:D,transform:L});break}this._remainDrawingSize(h,n,c);continue}if(y>=b&&R<=W)continue;let A=null,O=null;if(y>=b&&y<=W){const D=this._skeletonManagerService.attachRangeWithCoord({startColumn:y,endColumn:W,startRow:f.row,endRow:w.row});if(D==null)return;O={...h,left:(D==null?void 0:D.startX)||0,width:((h==null?void 0:h.width)||0)-D.endX+D.startX}}else if(R>=b&&R<=W){const D=this._skeletonManagerService.attachRangeWithCoord({startColumn:b,endColumn:R,startRow:f.row,endRow:w.row});if(D==null)return;O={...h,left:D.startX-((h==null?void 0:h.width)||0)}}else{const D=this._skeletonManagerService.attachRangeWithCoord({startColumn:b,endColumn:W,startRow:f.row,endRow:w.row});if(D==null)return;if(O={...h,width:((h==null?void 0:h.width)||0)-D.endX+D.startX},A=H(O,this._selectionRenderService),A!=null&&O!=null){o.push({...c,sheetTransform:A,transform:O});break}}if(O!=null&&(A=H(O,this._selectionRenderService)),O!=null&&A!=null){n.push({...c,sheetTransform:A,transform:O});break}else this._remainDrawingSize(h,n,c)}}}),n.length===0&&o.length===0)return{redos:[],undos:[]};const{redos:a,undos:s}=this._createUndoAndRedoMutation(i,r,n),d=[],g=[];if(o.length>0){const{redos:u,undos:c}=this._createUndoAndRedoMutation(i,r,o);d.push(...u),g.push(...c)}return{redos:a,undos:s,preRedos:d,preUndos:g}}_createUndoAndRedoMutation(i,r,t){const e=this._sheetDrawingService.getBatchUpdateOp(t),{undo:n,redo:o,objects:a}=e,s=[{id:m.SetDrawingApplyMutation.id,params:{unitId:i,subUnitId:r,op:o,objects:a,type:m.DrawingApplyType.UPDATE}},{id:G.id,params:[i]}],d=[{id:m.SetDrawingApplyMutation.id,params:{unitId:i,subUnitId:r,op:n,objects:a,type:m.DrawingApplyType.UPDATE}},{id:G.id,params:[i]}];return{redos:s,undos:d}}_getDrawingUndoForRowVisible(i,r,t){const e=this._drawingManagerService.getDrawingData(i,r),n=[],o=[];if(Object.keys(e).forEach(u=>{const c=e[u],{sheetTransform:p,transform:h,anchorType:S=m.SheetDrawingAnchorType.Position}=c;if(S===m.SheetDrawingAnchorType.None)this._remainDrawingSize(h,n,c);else{const{from:f,to:w}=p,{row:_,column:y}=f,{row:M,column:R}=w;for(let C=0;C<t.length;C++){const T=t[C],{startRow:I,endRow:k,startColumn:b,endColumn:W}=T;if(M<I)continue;if(S===m.SheetDrawingAnchorType.Position){let D=null,L=null;if(_>=I&&_<=k){const B=this._skeletonManagerService.attachRangeWithCoord({startColumn:f.column,endColumn:w.column,startRow:_,endRow:k});if(B==null)return;L={...h,top:B.startY}}if(L!=null&&(D=H(L,this._selectionRenderService),D!=null&&L!=null)){n.push({...c,sheetTransform:D,transform:L});break}this._remainDrawingSize(h,n,c);continue}if(_>=I&&M<=k)continue;let A=null,O=null;if(_>=I&&_<=k){const D=this._skeletonManagerService.attachRangeWithCoord({startColumn:f.column,endColumn:w.column,startRow:_,endRow:k});if(D==null)return;O={...h,top:(D==null?void 0:D.startY)||0,height:((h==null?void 0:h.height)||0)-D.endY+D.startY}}else if(M>=I&&M<=k){const D=this._skeletonManagerService.attachRangeWithCoord({startColumn:f.column,endColumn:w.column,startRow:I,endRow:M});if(D==null)return;O={...h,top:D.startY-((h==null?void 0:h.height)||0)}}else{const D=this._skeletonManagerService.attachRangeWithCoord({startColumn:f.column,endColumn:w.column,startRow:I,endRow:k});if(D==null)return;if(O={...h,height:((h==null?void 0:h.height)||0)-D.endY+D.startY},A=H(O,this._selectionRenderService),A!=null&&O!=null){o.push({...c,sheetTransform:A,transform:O});break}}if(O!=null&&(A=H(O,this._selectionRenderService)),O!=null&&A!=null){n.push({...c,sheetTransform:A,transform:O});break}else this._remainDrawingSize(h,n,c)}}}),n.length===0&&o.length===0)return{redos:[],undos:[]};const{redos:a,undos:s}=this._createUndoAndRedoMutation(i,r,n),d=[],g=[];if(o.length>0){const{redos:u,undos:c}=this._createUndoAndRedoMutation(i,r,o);d.push(...u),g.push(...c)}return{redos:a,undos:s,preRedos:d,preUndos:g}}_getDrawingUndoForRowAndColSize(i,r,t,e){const n=this._drawingManagerService.getDrawingData(i,r),o=[];return Object.keys(n).forEach(a=>{const s=n[a],{sheetTransform:d,transform:g,anchorType:u=m.SheetDrawingAnchorType.Position}=s;if(u===m.SheetDrawingAnchorType.None)this._remainDrawingSize(g,o,s);else{const{from:c,to:p}=d,{row:h,column:S}=c,{row:f,column:w}=p;for(let _=0;_<t.length;_++){const y=t[_],{startRow:M,endRow:R,startColumn:C,endColumn:T}=y;if(f<M||w<C)continue;if(u===m.SheetDrawingAnchorType.Position&&(h<=M&&f>=R||S<=C&&w>=T)){this._remainDrawingSize(g,o,s);continue}const I=K({...d},this._selectionRenderService,this._skeletonManagerService);if(I!=null){o.push({...s,transform:I});break}}}}),o.length===0?{redos:[],undos:[]}:this._createUndoAndRedoMutation(i,r,o)}_getUnitIdAndSubUnitId(i,r){let t,e;if(r==="insert")t=i.unitId,e=i.subUnitId;else{const n=v.getSheetCommandTarget(this._univerInstanceService);if(n==null)return;t=n.unitId,e=n.subUnitId}return{unitId:t,subUnitId:e}}_moveRangeInterceptor(i){var M,R;const{toRange:r,fromRange:t}=i,e=v.getSheetCommandTarget(this._univerInstanceService);if(!e)return{redos:[],undos:[]};const{unitId:n,subUnitId:o}=e,a=(R=(M=this._renderManagerService.getRenderById(n))==null?void 0:M.with(E.SheetSkeletonManagerService))==null?void 0:R.getCurrentSkeleton();if(!a)return{redos:[],undos:[]};const s=E.attachRangeWithCoord(a,t);if(!s)return{redos:[],undos:[]};const{startX:d,endX:g,startY:u,endY:c}=s,p=this._sheetDrawingService.getDrawingData(n,o),h=[];Object.keys(p).forEach(C=>{const T=p[C];if(T.anchorType!==m.SheetDrawingAnchorType.Both)return;const{transform:I}=T;if(!I)return;const{left:k=0,top:b=0,width:W=0,height:A=0}=I,{drawingStartX:O,drawingEndX:D,drawingStartY:L,drawingEndY:B}={drawingStartX:k,drawingEndX:k+W,drawingStartY:b,drawingEndY:b+A};d<=O&&D<=g&&u<=L&&B<=c&&h.push(T)});const S=[],f=[],w=r.startRow-t.startRow,_=r.startColumn-t.startColumn,y=h.map(C=>{const T=C.sheetTransform,I={to:{...T.to,row:T.to.row+w,column:T.to.column+_},from:{...T.from,row:T.from.row+w,column:T.from.column+_}},k=K(I,this._selectionRenderService,this._skeletonManagerService);return{unitId:n,subUnitId:o,drawingId:C.drawingId,transform:k,sheetTransform:I}});if(y.length){const C=this._sheetDrawingService.getBatchUpdateOp(y),{undo:T,redo:I,objects:k}=C;S.push({id:m.SetDrawingApplyMutation.id,params:{unitId:n,subUnitId:o,op:I,objects:k,type:m.DrawingApplyType.UPDATE}}),f.push({id:m.SetDrawingApplyMutation.id,params:{unitId:n,subUnitId:o,op:T,objects:k,type:m.DrawingApplyType.UPDATE}})}return{redos:S,undos:f}}_moveRowInterceptor(i,r){const t=this._getUnitIdAndSubUnitId(i,r);if(t==null)return{redos:[],undos:[]};const{unitId:e,subUnitId:n}=t,{range:o}=i,a=o.startRow,s=o.endRow,d=[],g=[],u=this._sheetDrawingService.getDrawingData(e,n),c=[],p=[];if(Object.keys(u).forEach(h=>{const S=u[h],{sheetTransform:f,transform:w,anchorType:_=m.SheetDrawingAnchorType.Position}=S;if(f==null||w==null)return;let y,M;if(r==="insert"){const C=this._expandRow(f,w,a,s,_);y=C==null?void 0:C.newSheetTransform,M=C==null?void 0:C.newTransform}else{const{from:C,to:T}=f,{row:I}=C,{row:k}=T;if(_===m.SheetDrawingAnchorType.Both&&I>=a&&k<=s)p.push({unitId:e,subUnitId:n,drawingId:h});else{const b=this._shrinkRow(f,w,a,s,_);y=b==null?void 0:b.newSheetTransform,M=b==null?void 0:b.newTransform}}if(!y||!M)return;const R={unitId:e,subUnitId:n,drawingId:h,transform:M,sheetTransform:y};c.push(R)}),c.length===0&&p.length===0)return{redos:[],undos:[]};if(c.length>0){const h=this._sheetDrawingService.getBatchUpdateOp(c),{undo:S,redo:f,objects:w}=h;d.push({id:m.SetDrawingApplyMutation.id,params:{unitId:e,subUnitId:n,op:f,objects:w,type:m.DrawingApplyType.UPDATE}}),g.push({id:m.SetDrawingApplyMutation.id,params:{unitId:e,subUnitId:n,op:S,objects:w,type:m.DrawingApplyType.UPDATE}})}if(p.length>0){const h=this._sheetDrawingService.getBatchRemoveOp(p),S=h.undo,f=h.redo,w=h.objects;d.push({id:m.SetDrawingApplyMutation.id,params:{unitId:e,subUnitId:n,op:f,objects:w,type:m.DrawingApplyType.REMOVE}}),g.push({id:m.SetDrawingApplyMutation.id,params:{unitId:e,subUnitId:n,op:S,objects:w,type:m.DrawingApplyType.INSERT}})}return d.push({id:G.id,params:[e]}),g.push({id:G.id,params:[e]}),{redos:d,undos:g}}_moveColInterceptor(i,r){const t=this._getUnitIdAndSubUnitId(i,r);if(t==null)return{redos:[],undos:[]};const{unitId:e,subUnitId:n}=t,{range:o}=i,a=o.startColumn,s=o.endColumn,d=[],g=[],u=this._sheetDrawingService.getDrawingData(e,n),c=[],p=[];if(Object.keys(u).forEach(h=>{const S=u[h],{sheetTransform:f,transform:w,anchorType:_=m.SheetDrawingAnchorType.Position}=S;if(f==null||w==null)return;let y,M;if(r==="insert"){const C=this._expandCol(f,w,a,s,_);y=C==null?void 0:C.newSheetTransform,M=C==null?void 0:C.newTransform}else{const{from:C,to:T}=f,{column:I}=C,{column:k}=T;if(_===m.SheetDrawingAnchorType.Both&&I>=a&&k<=s)p.push({unitId:e,subUnitId:n,drawingId:h});else{const b=this._shrinkCol(f,w,a,s,_);y=b==null?void 0:b.newSheetTransform,M=b==null?void 0:b.newTransform}}if(!y||!M)return;const R={unitId:e,subUnitId:n,drawingId:h,transform:M,sheetTransform:y};c.push(R)}),c.length===0&&p.length===0)return{redos:[],undos:[]};if(c.length>0){const h=this._sheetDrawingService.getBatchUpdateOp(c),{undo:S,redo:f,objects:w}=h;d.push({id:m.SetDrawingApplyMutation.id,params:{unitId:e,subUnitId:n,op:f,objects:w,type:m.DrawingApplyType.UPDATE}}),g.push({id:m.SetDrawingApplyMutation.id,params:{unitId:e,subUnitId:n,op:S,objects:w,type:m.DrawingApplyType.UPDATE}})}if(p.length>0){const h=this._sheetDrawingService.getBatchRemoveOp(p),S=h.undo,f=h.redo,w=h.objects;d.push({id:m.SetDrawingApplyMutation.id,params:{unitId:e,subUnitId:n,op:f,objects:w,type:m.DrawingApplyType.REMOVE}}),g.push({id:m.SetDrawingApplyMutation.id,params:{unitId:e,subUnitId:n,op:S,objects:w,type:m.DrawingApplyType.INSERT}})}return d.push({id:G.id,params:[e]}),g.push({id:G.id,params:[e]}),{redos:d,undos:g}}_expandCol(i,r,t,e,n=m.SheetDrawingAnchorType.Position){const o=e-t+1,{from:a,to:s}=i,{column:d}=a,{column:g}=s;if(n===m.SheetDrawingAnchorType.None)return{newSheetTransform:H({...r},this._selectionRenderService),newTransform:r};let u=null,c=null;if(d>=t){const p=this._skeletonManagerService.attachRangeWithCoord({startColumn:t,endColumn:e,startRow:a.row,endRow:s.row});if(p==null)return;c={...r,left:(r.left||0)+p.endX-p.startX},u=H(c,this._selectionRenderService)}else if(g>=e)if(n===m.SheetDrawingAnchorType.Both)u={from:{...a},to:{...s,column:g+o}},c=K(u,this._selectionRenderService,this._skeletonManagerService);else return{newSheetTransform:H({...r},this._selectionRenderService),newTransform:r};return u!=null&&c!=null?{newSheetTransform:u,newTransform:c}:null}_shrinkCol(i,r,t,e,n=m.SheetDrawingAnchorType.Position){const o=e-t+1,{from:a,to:s}=i,{column:d}=a,{column:g}=s;if(n===m.SheetDrawingAnchorType.None)return{newSheetTransform:H({...r},this._selectionRenderService),newTransform:r};let u=null,c=null;if(d>e)u={from:{...a,column:d-o},to:{...s,column:g-o}},c=K(u,this._selectionRenderService,this._skeletonManagerService);else{if(d>=t&&g<=e)return null;if(d<t&&g>e)if(n===m.SheetDrawingAnchorType.Both)u={from:{...a},to:{...s,column:g-o}},c=K(u,this._selectionRenderService,this._skeletonManagerService);else return{newSheetTransform:H({...r},this._selectionRenderService),newTransform:r};else if(d>=t&&d<=e){if(d===t)c={...r,left:(r.left||0)-i.from.columnOffset};else{const p=this._skeletonManagerService.attachRangeWithCoord({startColumn:t,endColumn:d-1,startRow:a.row,endRow:s.row});if(p==null)return;c={...r,left:(r.left||0)-p.endX+p.startX-i.from.columnOffset}}u=H(c,this._selectionRenderService)}else if(g>=t&&g<=e&&n===m.SheetDrawingAnchorType.Both){const p=this._skeletonManagerService.attachRangeWithCoord({startColumn:t-1,endColumn:t-1,startRow:a.row,endRow:s.row});if(p==null)return;u={from:{...a},to:{...s,column:t-1,columnOffset:p.endX-p.startX}},c=K(u,this._selectionRenderService,this._skeletonManagerService)}}return u!=null&&c!=null?{newSheetTransform:u,newTransform:c}:null}_expandRow(i,r,t,e,n=m.SheetDrawingAnchorType.Position){const o=e-t+1,{from:a,to:s}=i,{row:d}=a,{row:g}=s;if(n===m.SheetDrawingAnchorType.None)return{newSheetTransform:H({...r},this._selectionRenderService),newTransform:r};let u=null,c=null;if(d>=t){const p=this._skeletonManagerService.attachRangeWithCoord({startRow:t,endRow:e,startColumn:a.column,endColumn:s.column});if(p==null)return;c={...r,top:(r.top||0)+p.endY-p.startY},u=H(c,this._selectionRenderService)}else if(g>=e)if(n===m.SheetDrawingAnchorType.Both)u={from:{...a},to:{...s,row:g+o}},c=K(u,this._selectionRenderService,this._skeletonManagerService);else return{newSheetTransform:H({...r},this._selectionRenderService),newTransform:r};return u!=null&&c!=null?{newSheetTransform:u,newTransform:c}:null}_shrinkRow(i,r,t,e,n=m.SheetDrawingAnchorType.Position){const o=e-t+1,{from:a,to:s}=i,{row:d}=a,{row:g}=s;if(n===m.SheetDrawingAnchorType.None)return{newSheetTransform:H({...r},this._selectionRenderService),newTransform:r};let u=null,c=null;if(d>e)u={from:{...a,row:d-o},to:{...s,row:g-o}},c=K(u,this._selectionRenderService,this._skeletonManagerService);else{if(d>=t&&g<=e)return null;if(d<t&&g>e)if(n===m.SheetDrawingAnchorType.Both)u={from:{...a},to:{...s,row:g-o}},c=K(u,this._selectionRenderService,this._skeletonManagerService);else return{newSheetTransform:H({...r},this._selectionRenderService),newTransform:r};else if(d>=t&&d<=e){if(d===t)c={...r,top:(r.top||0)-i.from.rowOffset};else{const p=this._skeletonManagerService.attachRangeWithCoord({startRow:t,endRow:d-1,startColumn:a.column,endColumn:s.column});if(p==null)return;c={...r,top:(r.top||0)-p.endY+p.startY-i.from.rowOffset}}u=H(c,this._selectionRenderService)}else if(g>=t&&g<=e&&n===m.SheetDrawingAnchorType.Both){const p=this._skeletonManagerService.attachRangeWithCoord({startColumn:a.column,endColumn:a.column,startRow:t-1,endRow:t-1});if(p==null)return;u={from:{...a},to:{...s,row:t-1,rowOffset:p.endY-p.startY}},c=K(u,this._selectionRenderService,this._skeletonManagerService)}}return u!=null&&c!=null?{newSheetTransform:u,newTransform:c}:null}_commandListener(){this.disposeWithMe(this._commandService.onCommandExecuted(i=>{if(i.id===v.SetWorksheetActiveOperation.id){const{unitId:r,subUnitId:t}=i.params;this._updateDrawings(r,t)}})),this.disposeWithMe(this._context.activated$.subscribe(i=>{const{unit:r,unitId:t}=this._context;if(i){const e=r.getActiveSheet().getSheetId();this._updateDrawings(t,e)}else this._clearDrawings(t)}))}_clearDrawings(i){setTimeout(()=>{const r=this._drawingManagerService.drawingManagerData,t=[];Object.keys(r).forEach(e=>{const n=r[e];n!=null&&Object.keys(n).forEach(o=>{const a=n[o].data;a!=null&&Object.keys(a).forEach(s=>{e===i&&t.push(a[s])})})}),this._drawingManagerService.removeNotification(t)})}_updateDrawings(i,r){setTimeout(()=>{const t=this._drawingManagerService.drawingManagerData,e=[],n=[];Object.keys(t).forEach(o=>{const a=t[o];a!=null&&Object.keys(a).forEach(s=>{const d=a[s].data;d!=null&&Object.keys(d).forEach(g=>{if(o===i&&s===r){const u=d[g];u.transform=K(u.sheetTransform,this._selectionRenderService,this._skeletonManagerService),e.push(d[g])}else n.push(d[g])})})}),this._drawingManagerService.removeNotification(n),this._drawingManagerService.addNotification(e)},0)}_sheetRefreshListener(){this.disposeWithMe(this._commandService.onCommandExecuted(i=>{In.includes(i.id)&&requestIdleCallback(()=>{const r=i.params,{unitId:t,subUnitId:e,ranges:n}=r;this._refreshDrawingTransform(t,e,n)})}))}_refreshDrawingTransform(i,r,t){const e=this._drawingManagerService.getDrawingData(i,r),n=[];Object.keys(e).forEach(o=>{const a=e[o],{sheetTransform:s,transform:d,anchorType:g=m.SheetDrawingAnchorType.Position}=a;if(g===m.SheetDrawingAnchorType.None)return!0;const{from:u,to:c}=s,{row:p,column:h}=u,{row:S,column:f}=c;for(let w=0;w<t.length;w++){const _=t[w],{startRow:y,endRow:M,startColumn:R,endColumn:C}=_;if(l.Rectangle.intersects({startRow:y,endRow:M,startColumn:R,endColumn:C},{startRow:p,endRow:S,startColumn:h,endColumn:f})||p>M||h>C){const T=g===m.SheetDrawingAnchorType.Position,I=K(s,this._selectionRenderService,this._skeletonManagerService);n.push({...a,transform:{...I,width:T?d==null?void 0:d.width:I==null?void 0:I.width,height:T?d==null?void 0:d.height:I==null?void 0:I.height}});break}}}),n.length!==0&&(this._drawingManagerService.refreshTransform(n),this._commandService.syncExecuteCommand(G.id,[i]))}};It=vn([fe(1,j.IRenderManagerService),fe(2,l.ICommandService),fe(3,E.ISheetSelectionRenderService),fe(4,l.Inject(E.SheetSkeletonManagerService)),fe(5,l.Inject(v.SheetInterceptorService)),fe(6,m.ISheetDrawingService),fe(7,U.IDrawingManagerService),fe(8,l.IUniverInstanceService)],It);var re=function(){return re=Object.assign||function(i){for(var r,t=1,e=arguments.length;t<e;t++){r=arguments[t];for(var n in r)Object.prototype.hasOwnProperty.call(r,n)&&(i[n]=r[n])}return i},re.apply(this,arguments)},yn=function(i,r){var t={};for(var e in i)Object.prototype.hasOwnProperty.call(i,e)&&r.indexOf(e)<0&&(t[e]=i[e]);if(i!=null&&typeof Object.getOwnPropertySymbols=="function")for(var n=0,e=Object.getOwnPropertySymbols(i);n<e.length;n++)r.indexOf(e[n])<0&&Object.prototype.propertyIsEnumerable.call(i,e[n])&&(t[e[n]]=i[e[n]]);return t},Nt=te.forwardRef(function(i,r){var t=i.icon,e=i.id,n=i.className,o=i.extend,a=yn(i,["icon","id","className","extend"]),s="univerjs-icon univerjs-icon-".concat(e," ").concat(n||"").trim(),d=te.useRef("_".concat(Mn()));return kt(t,"".concat(e),{defIds:t.defIds,idSuffix:d.current},re({ref:r,className:s},a),o)});function kt(i,r,t,e,n){return te.createElement(i.tag,re(re({key:r},Cn(i,t,n)),e),(Dn(i,t).children||[]).map(function(o,a){return kt(o,"".concat(r,"-").concat(i.tag,"-").concat(a),t,void 0,n)}))}function Cn(i,r,t){var e=re({},i.attrs);t!=null&&t.colorChannel1&&e.fill==="colorChannel1"&&(e.fill=t.colorChannel1),i.tag==="mask"&&e.id&&(e.id=e.id+r.idSuffix),Object.entries(e).forEach(function(o){var a=o[0],s=o[1];a==="mask"&&typeof s=="string"&&(e[a]=s.replace(/url\(#(.*)\)/,"url(#$1".concat(r.idSuffix,")")))});var n=r.defIds;return!n||n.length===0||(i.tag==="use"&&e["xlink:href"]&&(e["xlink:href"]=e["xlink:href"]+r.idSuffix),Object.entries(e).forEach(function(o){var a=o[0],s=o[1];typeof s=="string"&&(e[a]=s.replace(/url\(#(.*)\)/,"url(#$1".concat(r.idSuffix,")")))})),e}function Dn(i,r){var t,e=r.defIds;return!e||e.length===0?i:i.tag==="defs"&&(!((t=i.children)===null||t===void 0)&&t.length)?re(re({},i),{children:i.children.map(function(n){return typeof n.attrs.id=="string"&&e&&e.indexOf(n.attrs.id)>-1?re(re({},n),{attrs:re(re({},n.attrs),{id:n.attrs.id+r.idSuffix})}):n})}):i}function Mn(){return Math.random().toString(36).substring(2,8)}Nt.displayName="UniverIcon";var Tn={tag:"svg",attrs:{fill:"none",viewBox:"0 0 16 16",width:"1em",height:"1em"},children:[{tag:"path",attrs:{fill:"currentColor",d:"M2.2498 3.65005C2.2498 2.87685 2.87661 2.25005 3.64981 2.25005H7.9998C8.33118 2.25005 8.5998 1.98142 8.5998 1.65005C8.5998 1.31868 8.33118 1.05005 7.9998 1.05005H3.64981C2.21387 1.05005 1.0498 2.21411 1.0498 3.65005V12.35C1.0498 13.786 2.21386 14.95 3.6498 14.95H12.3498C13.7857 14.95 14.9498 13.786 14.9498 12.3501V8.00005C14.9498 7.66868 14.6812 7.40005 14.3498 7.40005C14.0184 7.40005 13.7498 7.66868 13.7498 8.00005V9.23974L12.2385 8.1063C11.7252 7.72129 11.0068 7.7723 10.5531 8.22605L9.00869 9.77041L6.73916 7.8251C6.24387 7.40055 5.5095 7.41278 5.02864 7.85359L2.2498 10.4009V3.65005ZM2.2498 12.0287V12.35C2.2498 13.1232 2.87661 13.75 3.6498 13.75H12.3498C13.123 13.75 13.7498 13.1232 13.7498 12.3501V10.7397L11.5186 9.06631C11.4829 9.03956 11.433 9.04314 11.4016 9.07458L9.92249 10.5537L11.1015 11.5642C11.3531 11.7799 11.3822 12.1587 11.1666 12.4103C10.9509 12.6619 10.5721 12.691 10.3205 12.4753L5.9582 8.7362C5.92384 8.70674 5.87288 8.70758 5.83952 8.73816L2.2498 12.0287Z",fillRule:"evenodd",clipRule:"evenodd"}},{tag:"path",attrs:{fill:"currentColor",d:"M11.8097 1.14783C12.1411 1.14783 12.4097 1.41646 12.4097 1.74783V3.297H14.1541C14.4855 3.297 14.7541 3.56563 14.7541 3.897C14.7541 4.22837 14.4855 4.497 14.1541 4.497H12.4097V6.24167C12.4097 6.57304 12.1411 6.84167 11.8097 6.84167C11.4783 6.84167 11.2097 6.57304 11.2097 6.24167V4.497H9.6603C9.32893 4.497 9.0603 4.22837 9.0603 3.897C9.0603 3.56563 9.32893 3.297 9.6603 3.297H11.2097V1.74783C11.2097 1.41646 11.4783 1.14783 11.8097 1.14783Z"}}]},Wt=te.forwardRef(function(i,r){return te.createElement(Nt,Object.assign({},i,{id:"add-image-single",ref:r,icon:Tn}))});Wt.displayName="AddImageSingle";const yt={id:"sheet.command.delete-drawing",type:l.CommandType.COMMAND,handler:i=>{const r=i.get(l.ICommandService),e=i.get(m.ISheetDrawingService).getFocusDrawings();if(e.length===0)return!1;const n=e[0].unitId,o=e.map(a=>{const{unitId:s,subUnitId:d,drawingId:g,drawingType:u}=a;return{unitId:s,subUnitId:d,drawingId:g,drawingType:u}});return r.executeCommand(Ie.id,{unitId:n,drawings:o})}},ye={id:"sheet.command.move-drawing",type:l.CommandType.COMMAND,handler:(i,r)=>{const t=i.get(l.ICommandService),e=i.get(m.ISheetDrawingService),n=i.get(E.ISheetSelectionRenderService),{direction:o}=r,a=e.getFocusDrawings();if(a.length===0)return!1;const s=a[0].unitId,d=a.map(u=>{const{transform:c}=u;if(c==null)return null;const p={...c},{left:h=0,top:S=0}=c;return o===l.Direction.UP?p.top=S-1:o===l.Direction.DOWN?p.top=S+1:o===l.Direction.LEFT?p.left=h-1:o===l.Direction.RIGHT&&(p.left=h+1),{...u,transform:p,sheetTransform:H(p,n)}}).filter(u=>u!=null);return t.syncExecuteCommand(Pe.id,{unitId:s,drawings:d})?(t.syncExecuteCommand(G.id,[s]),!0):!1}},jt="addition-and-subtraction-single",Ct="sheet.menu.image";function Rn(i){return{id:Ct,type:Y.MenuItemType.SUBITEMS,icon:jt,tooltip:"sheetImage.title",hidden$:Y.getMenuHiddenObservable(i,l.UniverInstanceType.UNIVER_SHEET),disabled$:E.getCurrentRangeDisable$(i,{workbookTypes:[v.WorkbookEditablePermission],worksheetTypes:[v.WorksheetEditPermission],rangeTypes:[v.RangeProtectionPermissionEditPoint]})}}function bn(i){return{id:Ue.id,title:"sheetImage.upload.float",type:Y.MenuItemType.BUTTON,hidden$:Y.getMenuHiddenObservable(i,l.UniverInstanceType.UNIVER_SHEET)}}function En(i){return{id:_t.id,title:"sheetImage.upload.cell",type:Y.MenuItemType.BUTTON}}const Se={imageCommonPanel:"univer-image-common-panel",imageCommonPanelGrid:"univer-image-common-panel-grid",imageCommonPanelBorder:"univer-image-common-panel-border",imageCommonPanelTitle:"univer-image-common-panel-title",imageCommonPanelRow:"univer-image-common-panel-row",imageCommonPanelColumn:"univer-image-common-panel-column"};function Bt(i){var r,t,e="";if(typeof i=="string"||typeof i=="number")e+=i;else if(typeof i=="object")if(Array.isArray(i)){var n=i.length;for(r=0;r<n;r++)i[r]&&(t=Bt(i[r]))&&(e&&(e+=" "),e+=t)}else for(t in i)i[t]&&(e&&(e+=" "),e+=t);return e}function Qe(){for(var i,r,t=0,e="",n=arguments.length;t<n;t++)(i=arguments[t])&&(r=Bt(i))&&(e&&(e+=" "),e+=r);return e}const On=i=>{var M;const r=Y.useDependency(l.ICommandService),t=Y.useDependency(l.LocaleService),e=Y.useDependency(U.IDrawingManagerService),n=Y.useDependency(j.IRenderManagerService),{drawings:o}=i,a=o[0];if(a==null)return;const{unitId:s}=a,d=n.getRenderById(s),g=d==null?void 0:d.scene;if(g==null)return;const u=g.getTransformerByCreate(),[c,p]=te.useState(!0),h=(M=a.anchorType)!=null?M:m.SheetDrawingAnchorType.Position,[S,f]=te.useState(h);function w(R,C){const T=[];return R.forEach(I=>{const{oKey:k}=I,b=C.getDrawingOKey(k);if(b==null)return T.push(null),!0;const{unitId:W,subUnitId:A,drawingId:O,drawingType:D,anchorType:L,sheetTransform:B}=b;T.push({unitId:W,subUnitId:A,drawingId:O,anchorType:L,sheetTransform:B,drawingType:D})}),T}te.useEffect(()=>{const R=u.clearControl$.subscribe(T=>{T===!0&&p(!1)}),C=u.changeStart$.subscribe(T=>{var b;const{objects:I}=T,k=w(I,e);if(k.length===0)p(!1);else if(k.length>=1){p(!0);const W=((b=k[0])==null?void 0:b.anchorType)||m.SheetDrawingAnchorType.Position;f(W)}});return()=>{C.unsubscribe(),R.unsubscribe()}},[]);function _(R){f(R);const C=e.getFocusDrawings();if(C.length===0)return;const T=C.map(I=>({unitId:I.unitId,subUnitId:I.subUnitId,drawingId:I.drawingId,anchorType:R}));r.executeCommand(Pe.id,{unitId:C[0].unitId,drawings:T})}const y=R=>R?"block":"none";return x.jsxs("div",{className:Qe(Se.imageCommonPanelGrid,Se.imageCommonPanelBorder),style:{display:y(c)},children:[x.jsx("div",{className:Se.imageCommonPanelRow,children:x.jsx("div",{className:Qe(Se.imageCommonPanelColumn,Se.imageCommonPanelTitle),children:x.jsx("div",{children:t.t("drawing-anchor.title")})})}),x.jsx("div",{className:Qe(Se.imageCommonPanelRow),children:x.jsx("div",{className:Qe(Se.imageCommonPanelColumn),children:x.jsxs(oe.RadioGroup,{value:S,onChange:_,direction:"vertical",children:[x.jsx(oe.Radio,{value:m.SheetDrawingAnchorType.Both,children:t.t("drawing-anchor.both")}),x.jsx(oe.Radio,{value:m.SheetDrawingAnchorType.Position,children:t.t("drawing-anchor.position")}),x.jsx(oe.Radio,{value:m.SheetDrawingAnchorType.None,children:t.t("drawing-anchor.none")})]})})})]})},Pn=()=>{const i=Y.useDependency(U.IDrawingManagerService),r=i.getFocusDrawings(),[t,e]=te.useState(r);return te.useEffect(()=>{const n=i.focus$.subscribe(o=>{e(o)});return()=>{n.unsubscribe()}},[]),!!(t!=null&&t.length)&&x.jsxs("div",{className:Se.imageCommonPanel,children:[x.jsx(pe.DrawingCommonPanel,{drawings:t}),x.jsx(On,{drawings:t})]})},An={[Y.RibbonStartGroup.FORMULAS_INSERT]:{[Ct]:{order:3,menuItemFactory:Rn,[Ue.id]:{order:0,menuItemFactory:bn},[_t.id]:{order:1,menuItemFactory:En}}}};function We(i){return!i.getContextValue(l.FOCUSING_FX_BAR_EDITOR)&&!i.getContextValue(l.EDITOR_ACTIVATED)&&!i.getContextValue(l.FOCUSING_PANEL_EDITOR)&&i.getContextValue(l.FOCUSING_COMMON_DRAWINGS)}const Un={id:ye.id,description:"shortcut.sheet.drawing-move-down",group:"4_sheet-drawing-view",binding:Y.KeyCode.ARROW_DOWN,priority:100,preconditions:We,staticParameters:{direction:l.Direction.DOWN}},Nn={id:ye.id,description:"shortcut.sheet.drawing-move-up",group:"4_sheet-drawing-view",binding:Y.KeyCode.ARROW_UP,priority:100,preconditions:We,staticParameters:{direction:l.Direction.UP}},kn={id:ye.id,description:"shortcut.sheet.drawing-move-left",group:"4_sheet-drawing-view",binding:Y.KeyCode.ARROW_LEFT,priority:100,preconditions:We,staticParameters:{direction:l.Direction.LEFT}},Wn={id:ye.id,description:"shortcut.sheet.drawing-move-right",group:"4_sheet-drawing-view",binding:Y.KeyCode.ARROW_RIGHT,priority:100,preconditions:We,staticParameters:{direction:l.Direction.RIGHT}},jn={id:yt.id,description:"shortcut.sheet.drawing-delete",group:"4_sheet-drawing-view",preconditions:We,binding:Y.KeyCode.DELETE,mac:Y.KeyCode.BACKSPACE};var Bn=Object.getOwnPropertyDescriptor,Ln=(i,r,t,e)=>{for(var n=e>1?void 0:e?Bn(r,t):r,o=i.length-1,a;o>=0;o--)(a=i[o])&&(n=a(n)||n);return n},Ce=(i,r)=>(t,e)=>r(t,e,i);let et=class extends l.Disposable{constructor(i,r,t,e,n,o){super(),this._componentManager=i,this._menuManagerService=r,this._commandService=t,this._shortcutService=e,this._drawingManagerService=n,this._sheetsSelectionsService=o,this._init()}_initCustomComponents(){const i=this._componentManager;this.disposeWithMe(i.register(jt,Wt)),this.disposeWithMe(i.register(Et,Pn))}_initMenus(){this._menuManagerService.mergeMenu(An)}_initCommands(){[Ue,_t,Oe,Ie,Pe,ht,G,pt,ft,wt,ye,yt,St].forEach(i=>this.disposeWithMe(this._commandService.registerCommand(i)))}_initShortcuts(){[Un,Nn,kn,Wn,jn].forEach(i=>{this.disposeWithMe(this._shortcutService.registerShortcut(i))})}_init(){this._initCommands(),this._initCustomComponents(),this._initMenus(),this._initShortcuts()}};et=Ln([Ce(0,l.Inject(Y.ComponentManager)),Ce(1,Y.IMenuManagerService),Ce(2,l.ICommandService),Ce(3,Y.IShortcutService),Ce(4,U.IDrawingManagerService),Ce(5,l.Inject(v.SheetsSelectionsService))],et);var Yn=Object.getOwnPropertyDescriptor,$n=(i,r,t,e)=>{for(var n=e>1?void 0:e?Yn(r,t):r,o=i.length-1,a;o>=0;o--)(a=i[o])&&(n=a(n)||n);return n},_e=(i,r)=>(t,e)=>r(t,e,i);function Fn(i,r,t,e,n){const{scaleX:o,scaleY:a}=r.getAncestorScale(),s=r.getViewport(j.SHEET_VIEWPORT_KEY.VIEW_MAIN),d=e.getFreeze(),{startColumn:g,startRow:u,xSplit:c,ySplit:p}=d,h={left:!0,top:!0};if(!s)return{...i,absolute:h};const{left:S,right:f,top:w,bottom:_}=i;let{top:y,left:M,viewportScrollX:R,viewportScrollY:C}=s;const{boundsOfViewArea:T,scrollDirectionResponse:I}=n||{},{rowHeaderWidth:k,columnHeaderHeight:b}=t,W={top:b,left:k};T&&(l.Tools.isDefine(W.top)&&(W.top=T.top),l.Tools.isDefine(W.left)&&(W.left=T.left)),I==="HORIZONTAL"&&(C=0),I==="VERTICAL"&&(R=0);let A=0,O=0;const D=t.rowStartY(u-p)+b,L=t.colStartX(g-c)+k,B=t.rowStartY(u)+b,z=t.colStartX(g)+k;if(c===0)h.left=!1,A=(S-R)*o,O=(f-R)*o;else{const ee=S-(L-k),Z=f-(L-k);f<z?(A=ee*o,O=Z*o):S<=z&&f>=z?(A=ee*o,O=Math.max(M,(f-R)*o)):S>z&&(h.left=!1,A=Math.max((S-R)*o,M),O=Math.max((f-R)*o,M))}let X=0,q=0;if(p===0)h.top=!1,X=(w-C)*a,q=(_-C)*a;else{const ee=w-(D-b),Z=_-(D-b);_<B?(X=ee*a,q=Z*a):w<=B&&_>=B?(X=ee*a,q=Math.max(y,(_-C)*a)):w>B&&(h.top=!1,X=Math.max((w-C)*a,y),q=Math.max((_-C)*a,y))}return A=Math.max(A,W.left),X=Math.max(X,W.top),O=Math.max(O,W.left),q=Math.max(q,W.top),{left:A,right:O,top:X,bottom:q,absolute:h}}const le=(i,r,t,e,n)=>{const{scene:o}=r,{left:a,top:s,width:d,height:g,angle:u}=i,c={left:a,right:a+d,top:s,bottom:s+g},p=Fn(c,o,t,e,n),{scaleX:h,scaleY:S}=o.getAncestorScale();return{startX:p.left,endX:p.right,startY:p.top,endY:p.bottom,rotate:u,width:d*h,height:g*S,absolute:p.absolute}};P.SheetCanvasFloatDomManagerService=class extends l.Disposable{constructor(t,e,n,o,a,s,d){super();Q(this,"_domLayerMap",new Map);Q(this,"_domLayerInfoMap",new Map);Q(this,"_transformChange$",new N.Subject);Q(this,"transformChange$",this._transformChange$.asObservable());Q(this,"_add$",new N.Subject);Q(this,"add$",this._add$.asObservable());Q(this,"_remove$",new N.Subject);Q(this,"remove$",this._remove$.asObservable());Q(this,"_hooks",[]);this._renderManagerService=t,this._univerInstanceService=e,this._commandService=n,this._drawingManagerService=o,this._canvasFloatDomService=a,this._sheetDrawingService=s,this._lifecycleService=d,this._drawingAddListener(),this._featureUpdateListener(),this._deleteListener(),this._bindScrollEvent()}_bindScrollEvent(){this._lifecycleService.lifecycle$.pipe(N.filter(t=>t===l.LifecycleStages.Rendered),N.take(1)).subscribe(()=>{this._scrollUpdateListener()})}_ensureMap(t,e){let n=this._domLayerMap.get(t);n||(n=new Map,this._domLayerMap.set(t,n));let o=n.get(e);return o||(o=new Map,n.set(e,o)),o}getFloatDomInfo(t){return this._domLayerInfoMap.get(t)}_getSceneAndTransformerByDrawingSearch(t){if(t==null)return;const e=this._renderManagerService.getRenderById(t),n=e==null?void 0:e.scene;if(e==null||n==null)return null;const o=n.getTransformerByCreate(),a=e.engine.getCanvasElement();return{scene:n,transformer:o,renderUnit:e,canvas:a}}_getFloatDomProps(t){let e;return this._hooks.forEach(n=>{e=n.onGetFloatDomProps(t)}),e}_drawingAddListener(){this.disposeWithMe(this._drawingManagerService.add$.subscribe(t=>{t.forEach(e=>{var se,ce,J;const{unitId:n,subUnitId:o,drawingId:a}=e,s=v.getSheetCommandTarget(this._univerInstanceService,{unitId:n,subUnitId:o}),d=this._drawingManagerService.getDrawingByParam(e),g=this._univerInstanceService.getUnit(n,l.UniverInstanceType.UNIVER_SHEET);if(!g)return;const u=g.getActiveSheet().getSheetId();if(!d||!s)return;const c=(se=this._renderManagerService.getRenderById(n))==null?void 0:se.with(E.SheetSkeletonManagerService).getSkeletonParam(o);if(!c)return;const{transform:p,drawingType:h,data:S}=d;if(h!==l.DrawingTypeEnum.DRAWING_DOM&&h!==l.DrawingTypeEnum.DRAWING_CHART)return;const f=this._getSceneAndTransformerByDrawingSearch(n);if(f==null)return;const{scene:w,canvas:_}=f;if(p==null)return!0;if(u!==o)return;const{left:y,top:M,width:R,height:C,angle:T,flipX:I,flipY:k,skewX:b,skewY:W}=p,A=U.getDrawingShapeKeyByDrawingSearch({unitId:n,subUnitId:o,drawingId:a}),O=w.getObject(A);if(O!=null){O.transformByState({left:y,top:M,width:R,height:C,angle:T,flipX:I,flipY:k,skewX:b,skewY:W});return}const D={left:y,top:M,width:R,height:C,zIndex:this._drawingManagerService.getDrawingOrder(n,o).length-1},L=h===l.DrawingTypeEnum.DRAWING_CHART;if(L){const F=S?S.backgroundColor:"white";D.fill=F,D.rotateEnabled=!1,S&&S.border&&(D.stroke=S.border),D.paintFirst="stroke",D.strokeWidth=1,D.borderEnabled=!1,D.radius=8}const B=new j.Rect(A,D);L&&B.setObjectType(j.ObjectType.CHART),w.addObject(B,j.DRAWING_OBJECT_LAYER_INDEX),d.allowTransform!==!1&&w.attachTransformerTo(B);const z=this._ensureMap(n,o),X=new l.DisposableCollection,q=le(B,f.renderUnit,c.skeleton,s.worksheet),ae=new N.BehaviorSubject(q),ee={dispose:X,rect:B,position$:ae,unitId:n,subUnitId:o};this._canvasFloatDomService.addFloatDom({position$:ae,id:a,componentKey:d.componentKey,onPointerDown:F=>{_.dispatchEvent(new PointerEvent(F.type,F))},onPointerMove:F=>{_.dispatchEvent(new PointerEvent(F.type,F))},onPointerUp:F=>{_.dispatchEvent(new PointerEvent(F.type,F))},onWheel:F=>{_.dispatchEvent(new WheelEvent(F.type,F))},props:(J=(ce=z.get(a))==null?void 0:ce.props)!=null?J:this._getFloatDomProps(a),data:S,unitId:n});const Z=B.onTransformChange$.subscribeEvent(()=>{const F=le(B,f.renderUnit,c.skeleton,s.worksheet);ae.next(F)});X.add(()=>{this._canvasFloatDomService.removeFloatDom(a)}),Z&&X.add(Z),this._domLayerInfoMap.set(a,ee),z.set(a,{...z.get(a)})})})),this.disposeWithMe(this._drawingManagerService.remove$.subscribe(t=>{t.forEach(e=>{const{unitId:n,subUnitId:o,drawingId:a}=e,s=U.getDrawingShapeKeyByDrawingSearch({unitId:n,subUnitId:o,drawingId:a}),d=this._getSceneAndTransformerByDrawingSearch(n);if(d==null)return;const{transformer:g,scene:u}=d,c=u.getObject(s);c!=null&&c.oKey&&g.clearControlByIds([c==null?void 0:c.oKey])})}))}_scrollUpdateListener(){const t=(e,n)=>{var u;const o=this._getSceneAndTransformerByDrawingSearch(e),a=this._ensureMap(e,n),s=Array.from(a.keys()),d=v.getSheetCommandTarget(this._univerInstanceService,{unitId:e,subUnitId:n}),g=(u=this._renderManagerService.getRenderById(e))==null?void 0:u.with(E.SheetSkeletonManagerService).getSkeletonParam(n);!o||!d||!g||s.forEach(c=>{const p=this._domLayerInfoMap.get(c);if(p){const h=le(p.rect,o.renderUnit,g.skeleton,d.worksheet,p);p.position$.next(h)}})};this.disposeWithMe(this._univerInstanceService.getCurrentTypeOfUnit$(l.UniverInstanceType.UNIVER_SHEET).pipe(N.switchMap(e=>e?e.activeSheet$:N.of(null)),N.map(e=>{if(!e)return null;const n=e.getUnitId(),o=this._renderManagerService.getRenderById(n);return o?{render:o,unitId:n,subUnitId:e.getSheetId()}:null}),N.switchMap(e=>e?l.fromEventSubject(e.render.scene.getViewport(j.SHEET_VIEWPORT_KEY.VIEW_MAIN).onScrollAfter$).pipe(N.map(()=>({unitId:e.unitId,subUnitId:e.subUnitId}))):N.of(null))).subscribe(e=>{if(!e)return;const{unitId:n,subUnitId:o}=e;t(n,o)})),this.disposeWithMe(this._commandService.onCommandExecuted(e=>{var n,o;if(e.id===E.SetZoomRatioOperation.id){const a=e.params,{unitId:s}=a;Array.from((o=(n=this._domLayerMap.get(s))==null?void 0:n.keys())!=null?o:[]).forEach(g=>{t(s,g)})}else if(e.id===v.SetFrozenMutation.id){const{unitId:a,subUnitId:s}=e.params;t(a,s)}}))}_getPosition(t,e){var h;const{startX:n,endX:o,startY:a,endY:s}=t,d=(h=this._renderManagerService.getRenderById(e))==null?void 0:h.with(E.ISheetSelectionRenderService);if(d==null)return;const g=d.getCellWithCoordByOffset(n,a);if(g==null)return;const u={column:g.actualColumn,columnOffset:n-g.startX,row:g.actualRow,rowOffset:a-g.startY},c=d.getCellWithCoordByOffset(o,s);if(c==null)return;const p={column:c.actualColumn,columnOffset:o-c.startX,row:c.actualRow,rowOffset:s-c.startY};return{from:u,to:p}}_featureUpdateListener(){this.disposeWithMe(this._drawingManagerService.update$.subscribe(t=>{t.forEach(e=>{const n=this._drawingManagerService.getDrawingByParam(e);if(!n||n.drawingType!==l.DrawingTypeEnum.DRAWING_DOM&&n.drawingType!==l.DrawingTypeEnum.DRAWING_CHART)return;const o={...n.transform};this._transformChange$.next({id:e.drawingId,value:o})})}))}_deleteListener(){this.disposeWithMe(this._drawingManagerService.remove$.subscribe(t=>{t.forEach(e=>{this._removeDom(e.drawingId)})}))}updateFloatDomProps(t,e,n,o){const a=this._domLayerInfoMap.get(n),s=this._getSceneAndTransformerByDrawingSearch(t);if(a&&s){const{scene:d}=s,g=U.getDrawingShapeKeyByDrawingSearch({unitId:t,subUnitId:e,drawingId:n}),u=d.getObject(g);u&&u instanceof j.Rect&&u.setProps(o)}}addFloatDomToPosition(t,e){const n=v.getSheetCommandTarget(this._univerInstanceService,{unitId:t.unitId,subUnitId:t.subUnitId});if(!n)throw new Error("cannot find current target!");const{unitId:o,subUnitId:a}=n,{initPosition:s,componentKey:d,data:g,allowTransform:u=!0}=t,c=e!=null?e:l.generateRandomId(),p=this._getPosition(s,o);if(p==null)return;this._ensureMap(o,a).set(c,t);const S={unitId:o,subUnitId:a,drawingId:c,drawingType:t.type||l.DrawingTypeEnum.DRAWING_DOM,componentKey:d,sheetTransform:p,transform:{left:s.startX,top:s.startY,width:s.endX-s.startX,height:s.endY-s.startY},data:g,allowTransform:u};return this._commandService.executeCommand(Oe.id,{unitId:o,drawings:[S]}),this._add$.next({unitId:o,subUnitId:a,id:c}),{id:c,dispose:()=>{this._removeDom(c,!0)}}}_removeDom(t,e=!1){const n=this._domLayerInfoMap.get(t);if(!n)return;const{unitId:o,subUnitId:a}=n;this._domLayerInfoMap.delete(t),n.dispose.dispose();const s=this._getSceneAndTransformerByDrawingSearch(o);if(s&&s.scene.removeObject(n.rect),e){this._ensureMap(o,a).delete(t);const g=this._drawingManagerService.getDrawingByParam({unitId:o,subUnitId:a,drawingId:t});if(!g)return;const u=this._sheetDrawingService.getBatchRemoveOp([g]),{redo:c,objects:p}=u;this._commandService.syncExecuteCommand(m.SetDrawingApplyMutation.id,{unitId:o,subUnitId:a,op:c,objects:p,type:m.DrawingApplyType.REMOVE})}}addHook(t){return this._hooks.push(t),{dispose:()=>{const e=this._hooks.findIndex(n=>n===t);this._hooks.splice(e,1)}}}addFloatDomToRange(t,e,n,o){var k,b,W,A,O;const a=v.getSheetCommandTarget(this._univerInstanceService,{unitId:e.unitId,subUnitId:e.subUnitId});if(!a)throw new Error("cannot find current target!");const{unitId:s,subUnitId:d}=a,g=this._getSceneAndTransformerByDrawingSearch(s);if(!g)return;const u=this._renderManagerService.getRenderById(s);if(!u)return;const c=(k=this._renderManagerService.getRenderById(s))==null?void 0:k.with(E.SheetSkeletonManagerService).getWorksheetSkeleton(d);if(!c)return;const{componentKey:p,data:h,allowTransform:S=!0}=e,f=o!=null?o:l.generateRandomId(),{position:w,position$:_}=this._createRangePositionObserver(t,u,c.skeleton);if(this._getPosition(w,s)==null)return;this._ensureMap(s,d).set(f,e);const R=g.scene,{scaleX:C}=R.getAncestorScale(),T=tt(w,n,C),I={unitId:s,subUnitId:d,drawingId:f,drawingType:e.type||l.DrawingTypeEnum.DRAWING_DOM,componentKey:p,transform:{left:T.startX,top:T.startY,width:T.width,height:T.height},data:h,allowTransform:S};{const{unitId:D,subUnitId:L,drawingId:B}=I,z=v.getSheetCommandTarget(this._univerInstanceService,{unitId:D,subUnitId:L}),X=I,q=this._univerInstanceService.getUnit(D,l.UniverInstanceType.UNIVER_SHEET);if(!q)return;const ae=q.getActiveSheet().getSheetId();if(!X||!z)return;const ee=(b=this._renderManagerService.getRenderById(D))==null?void 0:b.with(E.SheetSkeletonManagerService);if(!ee)return;const Z=ee.getWorksheetSkeleton(L);if(!Z)return;const{transform:se,drawingType:ce,data:J}=X;if(ce!==l.DrawingTypeEnum.DRAWING_DOM&&ce!==l.DrawingTypeEnum.DRAWING_CHART)return;const F=this._getSceneAndTransformerByDrawingSearch(D);if(F==null)return;const{scene:De,canvas:Me}=F;if(se==null||ae!==L)return;const{left:rt,top:it,width:ot,height:at,angle:Mt,flipX:Tt,flipY:st,skewX:ct,skewY:Te}=se,dt=U.getDrawingShapeKeyByDrawingSearch({unitId:D,subUnitId:L,drawingId:B}),ue=De.getObject(dt);if(ue!=null){ue.transformByState({left:rt,top:it,width:ot,height:at,angle:Mt,flipX:Tt,flipY:st,skewX:ct,skewY:Te});return}const ie={left:rt,top:it,width:ot,height:at,zIndex:this._drawingManagerService.getDrawingOrder(D,L).length-1},Re=ce===l.DrawingTypeEnum.DRAWING_CHART;if(Re){const $=J?J.backgroundColor:"white";ie.fill=$,ie.rotateEnabled=!1,J&&J.border&&(ie.stroke=J.border),ie.paintFirst="stroke",ie.strokeWidth=1,ie.borderEnabled=!1,ie.radius=8}const de=new j.Rect(dt,ie);Re&&de.setObjectType(j.ObjectType.CHART),De.addObject(de,j.DRAWING_OBJECT_LAYER_INDEX),X.allowTransform!==!1&&De.attachTransformerTo(de);const Be=this._ensureMap(D,L),ge=new l.DisposableCollection,lt=De.getMainViewport(),{rowHeaderWidth:be,columnHeaderHeight:Le}=Z.skeleton,ut={top:Le,left:be,bottom:lt.bottom,right:lt.right},he={dispose:ge,rect:de,boundsOfViewArea:ut,domAnchor:n,unitId:D,subUnitId:L},V=le(de,F.renderUnit,Z.skeleton,z.worksheet,he),Ee=new N.BehaviorSubject(V);he.position$=Ee;let Ye={position$:Ee,id:B,componentKey:X.componentKey,onPointerDown:()=>{},onPointerMove:()=>{},onPointerUp:()=>{},onWheel:$=>{Me.dispatchEvent(new WheelEvent($.type,$))},props:(A=(W=Be.get(B))==null?void 0:W.props)!=null?A:this._getFloatDomProps(B),data:J,unitId:D};e.eventPassThrough&&(Ye={...Ye,onPointerDown:$=>{Me.dispatchEvent(new PointerEvent($.type,$))},onPointerMove:$=>{Me.dispatchEvent(new PointerEvent($.type,$))},onPointerUp:$=>{Me.dispatchEvent(new PointerEvent($.type,$))}}),this._canvasFloatDomService.addFloatDom(Ye),this.disposeWithMe(_.subscribe($=>{var $t,Ft,Gt,Ht;const Yt=tt({startX:$.startX,startY:$.startY,endX:$.endX,endY:$.endY,width:($t=n.width)!=null?$t:$.width,height:(Ft=n.height)!=null?Ft:$.height,absolute:{left:w.absolute.left,top:w.absolute.top}},n),Kn=U.getDrawingShapeKeyByDrawingSearch({unitId:D,subUnitId:L,drawingId:B}),zn=new j.Rect(Kn,{left:Yt.startX,top:Yt.startY,width:(Gt=n.width)!=null?Gt:$.width,height:(Ht=n.height)!=null?Ht:$.height,zIndex:this._drawingManagerService.getDrawingOrder(D,L).length-1}),qn=le(zn,F.renderUnit,Z.skeleton,z.worksheet,he);Ee.next(qn)}));const $e=(O=this._renderManagerService.getRenderById(D))==null?void 0:O.with(E.SheetSkeletonManagerService);$e==null||$e.currentSkeleton$.subscribe($=>{$&&Z.sheetId!==$.sheetId&&this._removeDom(f,!0)});const gt=de.onTransformChange$.subscribeEvent(()=>{const $=le(de,F.renderUnit,Z.skeleton,z.worksheet,he);Ee.next($)});ge.add(()=>{this._canvasFloatDomService.removeFloatDom(B)}),gt&&ge.add(gt),this._domLayerInfoMap.set(B,he),Be.set(B,{...Be.get(B)})}return{id:f,dispose:()=>{this._removeDom(f,!0)}}}addFloatDomToColumnHeader(t,e,n,o){var T,I,k,b,W;const a=v.getSheetCommandTarget(this._univerInstanceService,{unitId:e.unitId,subUnitId:e.subUnitId});if(!a)throw new Error("cannot find current target!");const{unitId:s,subUnitId:d}=a;if(!this._getSceneAndTransformerByDrawingSearch(s))return;const u=this._renderManagerService.getRenderById(s);if(!u)return;const c=(T=this._renderManagerService.getRenderById(s))==null?void 0:T.with(E.SheetSkeletonManagerService).getWorksheetSkeleton(d);if(!c)return;const{componentKey:p,data:h,allowTransform:S=!0}=e,f=o!=null?o:l.generateRandomId(),{position:w,position$:_}=this._createRangePositionObserver({startRow:0,endRow:0,startColumn:t,endColumn:t},u,c.skeleton),y=w;if(y.startY=0,this._getPosition(w,s)==null)return;this._ensureMap(s,d).set(f,e);const C={unitId:s,subUnitId:d,drawingId:f,drawingType:e.type||l.DrawingTypeEnum.DRAWING_DOM,componentKey:p,transform:{left:y.startX,top:y.startY,width:y.width,height:y.height},data:h,allowTransform:S};{const{unitId:A,subUnitId:O,drawingId:D}=C,L=v.getSheetCommandTarget(this._univerInstanceService,{unitId:A,subUnitId:O}),B=C,z=this._univerInstanceService.getUnit(A,l.UniverInstanceType.UNIVER_SHEET);if(!z)return;const X=z.getActiveSheet().getSheetId();if(!B||!L)return;const q=(I=this._renderManagerService.getRenderById(A))==null?void 0:I.with(E.SheetSkeletonManagerService);if(!q)return;const ae=q.getWorksheetSkeleton(O);if(!ae)return;const{transform:ee,data:Z}=B,se=this._getSceneAndTransformerByDrawingSearch(A);if(se==null)return;const{scene:ce,canvas:J}=se;if(ee==null||X!==O)return;const{left:F,top:De,width:Me,height:rt,angle:it,flipX:ot,flipY:at,skewX:Mt,skewY:Tt}=ee,st=U.getDrawingShapeKeyByDrawingSearch({unitId:A,subUnitId:O,drawingId:D}),ct=ce.getObject(st);if(ct!=null){ct.transformByState({left:F,top:De,width:Me,height:rt,angle:it,flipX:ot,flipY:at,skewX:Mt,skewY:Tt});return}const Te=tt({startX:y.startX,startY:0,endX:w.endX,endY:w.endY,width:n.width,height:n.height,absolute:{left:w.absolute.left,top:w.absolute.top}},n),dt={left:Te.startX,top:Te.startY,width:Te.width,height:Te.height,zIndex:this._drawingManagerService.getDrawingOrder(A,O).length-1},ue=new j.Rect(st,dt);ce.addObject(ue,j.DRAWING_OBJECT_LAYER_INDEX),B.allowTransform!==!1&&ce.attachTransformerTo(ue);const ie=this._ensureMap(A,O),Re=new l.DisposableCollection,de=ce.getMainViewport(),Be={top:0,left:de.left,bottom:de.bottom,right:de.right},ge={dispose:Re,rect:ue,unitId:A,subUnitId:O,boundsOfViewArea:Be,domAnchor:n,scrollDirectionResponse:"HORIZONTAL"},lt=le(ue,se.renderUnit,ae.skeleton,L.worksheet,ge),be=new N.BehaviorSubject(lt);ge.position$=be;let Le={position$:be,id:D,componentKey:B.componentKey,onPointerDown:()=>{},onPointerMove:()=>{},onPointerUp:()=>{},onWheel:V=>{J.dispatchEvent(new WheelEvent(V.type,V))},props:(b=(k=ie.get(D))==null?void 0:k.props)!=null?b:this._getFloatDomProps(D),data:Z,unitId:A};e.eventPassThrough&&(Le={...Le,onPointerDown:V=>{J.dispatchEvent(new PointerEvent(V.type,V))},onPointerMove:V=>{J.dispatchEvent(new PointerEvent(V.type,V))},onPointerUp:V=>{J.dispatchEvent(new PointerEvent(V.type,V))}}),this._canvasFloatDomService.addFloatDom(Le);const ut=ue.onTransformChange$.subscribeEvent(()=>{const V=le(ue,se.renderUnit,ae.skeleton,L.worksheet,ge);be.next(V)});this.disposeWithMe(_.subscribe(V=>{const Ee=tt({startX:V.startX,startY:0,endX:V.endX,endY:V.endY,width:n.width,height:n.height,absolute:{left:w.absolute.left,top:w.absolute.top}},n),Ye=U.getDrawingShapeKeyByDrawingSearch({unitId:A,subUnitId:O,drawingId:D}),$e=new j.Rect(Ye,{left:Ee.startX,top:0,width:n.width,height:n.height,zIndex:this._drawingManagerService.getDrawingOrder(A,O).length-1}),gt=le($e,se.renderUnit,ae.skeleton,L.worksheet,ge);be.next(gt)}));const he=(W=this._renderManagerService.getRenderById(A))==null?void 0:W.with(E.SheetSkeletonManagerService);he==null||he.currentSkeleton$.subscribe(V=>{V&&c.sheetId!==V.sheetId&&this._removeDom(f,!0)}),Re.add(()=>{this._canvasFloatDomService.removeFloatDom(D)}),ut&&Re.add(ut),this._domLayerInfoMap.set(D,ge),ie.set(D,{...ie.get(D)})}return{id:f,dispose:()=>{this._removeDom(f,!0)}}}_createRangePositionObserver(t,e,n){let{startRow:o,startColumn:a}=t;const s=je(o,a,n),d=new N.BehaviorSubject(s),g=je(t.endRow,t.endColumn,n),u=new N.BehaviorSubject(g),c=()=>{const _=je(o,a,n),y=je(t.endRow,t.endColumn,n);d.next(_),u.next(y)},p=new l.DisposableCollection;p.add(e.engine.clientRect$.subscribe(()=>c())),p.add(this._commandService.onCommandExecuted(_=>{if(_.id===v.SetWorksheetRowAutoHeightMutation.id&&_.params.rowsAutoHeightInfo.findIndex(M=>M.row===o)>-1){c();return}(v.COMMAND_LISTENER_SKELETON_CHANGE.indexOf(_.id)>-1||_.id===E.SetScrollOperation.id||_.id===E.SetZoomRatioOperation.id)&&c()}));const h=(_,y)=>{o=_,a=y,c()},S=()=>({rotate:0,width:g.right-s.left,height:g.bottom-s.top,absolute:{left:!0,top:!0},startX:s.left,startY:s.top,endX:g.right,endY:g.bottom}),f=d.pipe(N.map(_=>{const y=je(t.endRow,t.endColumn,n);return{rotate:0,width:y.right-_.left,height:y.bottom-_.top,absolute:{left:!0,top:!0},startX:_.left,startY:_.top,endX:y.right,endY:y.bottom}})),w=S();return{position$:f,position:w,updateRowCol:h,topLeftPos$:d,rightBottomPos$:u,disposable:p}}},P.SheetCanvasFloatDomManagerService=$n([_e(0,l.Inject(j.IRenderManagerService)),_e(1,l.IUniverInstanceService),_e(2,l.Inject(l.ICommandService)),_e(3,U.IDrawingManagerService),_e(4,l.Inject(Y.CanvasFloatDomService)),_e(5,m.ISheetDrawingService),_e(6,l.Inject(l.LifecycleService))],P.SheetCanvasFloatDomManagerService);function je(i,r,t){const e=t.getCellWithCoordByIndex(i,r),n=e.isMergedMainCell?e.mergeInfo:e;return{left:n.startX,right:n.endX,top:n.startY,bottom:n.endY}}function tt(i,r,t){var g,u;t=t!=null?t:1;const e=i.endX-i.startX,n=i.endY-i.startY,o=(g=r==null?void 0:r.width)!=null?g:e,a=(u=r==null?void 0:r.height)!=null?u:n;let s=0,d=0;if(r){if(r.horizonOffsetAlign==="right"){const c=nt(r.marginX,e*t);s=i.endX-c-o}else s=i.startX+nt(r.marginX,e);if(r.verticalOffsetAlign==="bottom"){const c=nt(r.marginY,n*t);d=i.endY-c-a}else d=i.startY+nt(r.marginY,n)}return{rotate:0,startX:s,startY:d,endX:i.endX,endY:i.endY,width:o,height:a,absolute:{left:i.absolute.left,top:i.absolute.top}}}function nt(i,r){if(i===void 0)return 0;if(typeof i=="number")return i;const t=Number.parseFloat(i);return r*t/100}var Gn=Object.defineProperty,Hn=Object.getOwnPropertyDescriptor,Vn=(i,r,t)=>r in i?Gn(i,r,{enumerable:!0,configurable:!0,writable:!0,value:t}):i[r]=t,Xn=(i,r,t,e)=>{for(var n=e>1?void 0:e?Hn(r,t):r,o=i.length-1,a;o>=0;o--)(a=i[o])&&(n=a(n)||n);return n},Dt=(i,r)=>(t,e)=>r(t,e,i),Lt=(i,r,t)=>Vn(i,typeof r!="symbol"?r+"":r,t);const xn="SHEET_IMAGE_UI_PLUGIN";P.UniverSheetsDrawingUIPlugin=class extends l.Plugin{constructor(r=bt,t,e,n){super(),this._config=r,this._injector=t,this._renderManagerService=e,this._configService=n;const{menu:o,...a}=l.merge({},bt,this._config);o&&this._configService.setConfig("menu",o,{merge:!0}),this._configService.setConfig(Vt,a)}onStarting(){l.registerDependencies(this._injector,[[P.SheetCanvasFloatDomManagerService],[et],[Ge],[Je],[qe],[ze],[Ve],[Ke],[Xe]]),l.touchDependencies(this._injector,[[P.SheetCanvasFloatDomManagerService]])}onReady(){l.touchDependencies(this._injector,[[ze]])}onRendered(){this._registerRenderModules(),l.touchDependencies(this._injector,[[qe],[Je],[et],[Ve],[Ke],[Xe]])}onSteady(){this._injector.get(Ge)}_registerRenderModules(){[[Ae],[It],[mt]].forEach(r=>{this.disposeWithMe(this._renderManagerService.registerRenderModule(l.UniverInstanceType.UNIVER_SHEET,r))})}},Lt(P.UniverSheetsDrawingUIPlugin,"type",l.UniverInstanceType.UNIVER_SHEET),Lt(P.UniverSheetsDrawingUIPlugin,"pluginName",xn),P.UniverSheetsDrawingUIPlugin=Xn([l.DependentOn(U.UniverDrawingPlugin,we.UniverDocsDrawingPlugin,pe.UniverDrawingUIPlugin,m.UniverSheetsDrawingPlugin),Dt(1,l.Inject(l.Injector)),Dt(2,j.IRenderManagerService),Dt(3,l.IConfigService)],P.UniverSheetsDrawingUIPlugin),P.ClearSheetDrawingTransformerOperation=G,P.DeleteDrawingsCommand=yt,P.EditSheetDrawingOperation=pt,P.GroupSheetDrawingCommand=ft,P.InsertFloatImageCommand=Ue,P.InsertSheetDrawingCommand=Oe,P.MoveDrawingsCommand=ye,P.RemoveSheetDrawingCommand=Ie,P.SHEETS_IMAGE_MENU_ID=Ct,P.SetDrawingArrangeCommand=St,P.SetSheetDrawingCommand=Pe,P.SidebarSheetDrawingOperation=ht,P.UngroupSheetDrawingCommand=wt,Object.defineProperty(P,Symbol.toStringTag,{value:"Module"})});


// @univerjs/sheets-drawing-ui/facade
(function(o,u){typeof exports=="object"&&typeof module<"u"?u(require("@univerjs/core"),require("@univerjs/core/facade"),require("@univerjs/drawing"),require("@univerjs/engine-render"),require("@univerjs/sheets-drawing-ui"),require("@univerjs/sheets-ui"),require("@univerjs/sheets-drawing"),require("@univerjs/sheets-ui/facade"),require("@univerjs/sheets/facade"),require("@univerjs/ui")):typeof define=="function"&&define.amd?define(["@univerjs/core","@univerjs/core/facade","@univerjs/drawing","@univerjs/engine-render","@univerjs/sheets-drawing-ui","@univerjs/sheets-ui","@univerjs/sheets-drawing","@univerjs/sheets-ui/facade","@univerjs/sheets/facade","@univerjs/ui"],u):(o=typeof globalThis<"u"?globalThis:o||self,u(o.UniverCore,o.UniverCoreFacade,o.UniverDrawing,o.UniverEngineRender,o.UniverSheetsDrawingUi,o.UniverSheetsUi,o.UniverSheetsDrawing,o.UniverSheetsUiFacade,o.UniverSheetsFacade,o.UniverUi))})(this,function(o,u,v,k,m,w,l,_,D,p){"use strict";var W=Object.defineProperty;var U=(o,u,v)=>u in o?W(o,u,{enumerable:!0,configurable:!0,writable:!0,value:v}):o[u]=v;var G=(o,u,v)=>U(o,typeof u!="symbol"?u+"":u,v);var j=Object.getOwnPropertyDescriptor,R=(r,i,t,e)=>{for(var n=e>1?void 0:e?j(i,t):i,s=r.length-1,a;s>=0;s--)(a=r[s])&&(n=a(n)||n);return n},C=(r,i)=>(t,e)=>i(t,e,r);function T(r,i){const{from:t,to:e,flipY:n=!1,flipX:s=!1,angle:a=0,skewX:c=0,skewY:d=0}=r.sheetTransform,{column:h,columnOffset:g,row:f,rowOffset:b}=t,E=w.convertPositionSheetOverGridToAbsolute(r.unitId,r.subUnitId,{from:t,to:e},i),{width:y,height:O}=E;return{...r,column:h,columnOffset:g,row:f,rowOffset:b,width:y,height:O,flipY:n,flipX:s,angle:a,skewX:c,skewY:d}}function B(r,i,t){const{column:e,columnOffset:n,row:s,rowOffset:a,flipY:c=!1,flipX:d=!1,angle:h=0,skewX:g=0,skewY:f=0,width:b,height:E}=r,y=w.convertPositionCellToSheetOverGrid(r.unitId,r.subUnitId,{column:e,columnOffset:n,row:s,rowOffset:a},b,E,i,t),{sheetTransform:O,transform:P}=y;return{...r,sheetTransform:{...O,flipY:c,flipX:d,angle:h,skewX:g,skewY:f},transform:{...P,flipY:c,flipX:d,angle:h,skewX:g,skewY:f}}}let S=class{constructor(r,i,t){G(this,"_image");this._injector=t,this._image={drawingId:o.generateRandomId(6),drawingType:o.DrawingTypeEnum.DRAWING_IMAGE,imageSourceType:o.ImageSourceType.BASE64,source:"",unitId:r,subUnitId:i,column:0,columnOffset:0,row:0,rowOffset:0,width:0,height:0}}setImage(r){const t=this._injector.get(k.IRenderManagerService).getRenderById(r.unitId);if(!t)throw new Error(`Render Unit with unitId ${r.unitId} not found`);const e=t.with(w.SheetSkeletonManagerService);return r.sheetTransform==null&&(r.sheetTransform={from:{column:0,columnOffset:0,row:0,rowOffset:0},to:{column:0,columnOffset:0,row:0,rowOffset:0}}),this._image=T(r,e),this}setSource(r,i){const t=i!=null?i:o.ImageSourceType.URL;return this._image.source=r,this._image.imageSourceType=t,this}getSource(){return this._image.source}getSourceType(){return this._image.imageSourceType}setColumn(r){return this._image.column=r,this}setRow(r){return this._image.row=r,this}setColumnOffset(r){return this._image.columnOffset=r,this}setRowOffset(r){return this._image.rowOffset=r,this}setWidth(r){return this._image.width=r,this}setHeight(r){return this._image.height=r,this}setAnchorType(r){return this._image.anchorType=r,this}setCropTop(r){return this._initializeSrcRect(),this._image.srcRect.top=r,this}setCropLeft(r){return this._initializeSrcRect(),this._image.srcRect.left=r,this}setCropBottom(r){return this._initializeSrcRect(),this._image.srcRect.bottom=r,this}setCropRight(r){return this._initializeSrcRect(),this._image.srcRect.right=r,this}_initializeSrcRect(){this._image.srcRect==null&&(this._image.srcRect={top:0,left:0,bottom:0,right:0})}setRotate(r){return this._image.angle=r,this}setUnitId(r){return this._image.unitId=r,this}setSubUnitId(r){return this._image.subUnitId=r,this}async buildAsync(){const i=this._injector.get(k.IRenderManagerService).getRenderById(this._image.unitId);if(!i)throw new Error(`Render Unit with unitId ${this._image.unitId} not found`);const t=i.with(w.ISheetSelectionRenderService),e=i.with(w.SheetSkeletonManagerService);if(this._image.width===0||this._image.height===0){const n=await v.getImageSize(this._image.source),s=n.width,a=n.height;this._image.width===0&&(this._image.width=s),this._image.height===0&&(this._image.height=a)}return B(this._image,t,e)}};S=R([C(2,o.Inject(o.Injector))],S);let I=class extends u.FBase{constructor(r,i,t){super(),this._image=r,this._commandService=i,this._injector=t}getId(){return this._image.drawingId}getType(){return this._image.drawingType}remove(){return this._commandService.syncExecuteCommand(m.RemoveSheetDrawingCommand.id,{unitId:this._image.unitId,drawings:[this._image]})}toBuilder(){const r=this._injector.createInstance(S);return r.setImage(this._image),r}setSource(r,i){const t=i!=null?i:o.ImageSourceType.URL;return this._image.source=r,this._image.imageSourceType=t,this._commandService.syncExecuteCommand(m.SetSheetDrawingCommand.id,{unitId:this._image.unitId,drawings:[this._image]})}async setPositionAsync(r,i,t,e){const n=this.toBuilder();n.setColumn(i),n.setRow(r),t!=null&&n.setRowOffset(t),e!=null&&n.setColumnOffset(e);const s=await n.buildAsync();return this._commandService.syncExecuteCommand(m.SetSheetDrawingCommand.id,{unitId:this._image.unitId,drawings:[s]})}async setSizeAsync(r,i){const t=this.toBuilder();t.setWidth(r),t.setHeight(i);const e=await t.buildAsync();return this._commandService.syncExecuteCommand(m.SetSheetDrawingCommand.id,{unitId:this._image.unitId,drawings:[e]})}setCrop(r,i,t,e){return this._image.srcRect==null&&(this._image.srcRect={top:0,left:0,bottom:0,right:0}),r!=null&&(this._image.srcRect.top=r),i!=null&&(this._image.srcRect.left=i),t!=null&&(this._image.srcRect.bottom=t),e!=null&&(this._image.srcRect.right=e),this._commandService.syncExecuteCommand(m.SetSheetDrawingCommand.id,{unitId:this._image.unitId,drawings:[this._image]})}setRotate(r){return this._image.sheetTransform.angle=r,this._image.transform&&(this._image.transform.angle=r),this._commandService.syncExecuteCommand(m.SetSheetDrawingCommand.id,{unitId:this._image.unitId,drawings:[this._image]})}setForward(){return this._commandService.syncExecuteCommand(m.SetDrawingArrangeCommand.id,{unitId:this._image.unitId,subUnitId:this._image.subUnitId,drawingIds:[this._image.drawingId],arrangeType:o.ArrangeTypeEnum.forward})}setBackward(){return this._commandService.syncExecuteCommand(m.SetDrawingArrangeCommand.id,{unitId:this._image.unitId,subUnitId:this._image.subUnitId,drawingIds:[this._image.drawingId],arrangeType:o.ArrangeTypeEnum.backward})}setBack(){return this._commandService.syncExecuteCommand(m.SetDrawingArrangeCommand.id,{unitId:this._image.unitId,subUnitId:this._image.subUnitId,drawingIds:[this._image.drawingId],arrangeType:o.ArrangeTypeEnum.back})}setFront(){return this._commandService.syncExecuteCommand(m.SetDrawingArrangeCommand.id,{unitId:this._image.unitId,subUnitId:this._image.subUnitId,drawingIds:[this._image.drawingId],arrangeType:o.ArrangeTypeEnum.front})}};I=R([C(1,o.ICommandService),C(2,o.Inject(o.Injector))],I);class F extends D.FWorksheet{addFloatDomToPosition(i,t){const e=this._workbook.getUnitId(),n=this._worksheet.getSheetId(),{key:s,disposableCollection:a}=_.transformComponentKey(i,this._injector.get(p.ComponentManager)),d=this._injector.get(m.SheetCanvasFloatDomManagerService).addFloatDomToPosition({...i,componentKey:s,unitId:e,subUnitId:n},t);return d?(a.add(d.dispose),{id:d.id,dispose:()=>{a.dispose(),d.dispose()}}):(a.dispose(),null)}addFloatDomToRange(i,t,e,n){const s=this._workbook.getUnitId(),a=this._worksheet.getSheetId(),{key:c,disposableCollection:d}=_.transformComponentKey(t,this._injector.get(p.ComponentManager)),g=this._injector.get(m.SheetCanvasFloatDomManagerService).addFloatDomToRange(i.getRange(),{...t,componentKey:c,unitId:s,subUnitId:a},e,n);return g?(d.add(g.dispose),{id:g.id,dispose:()=>{d.dispose(),g.dispose()}}):(d.dispose(),null)}addFloatDomToColumnHeader(i,t,e,n){const s=this._workbook.getUnitId(),a=this._worksheet.getSheetId(),{key:c,disposableCollection:d}=_.transformComponentKey(t,this._injector.get(p.ComponentManager)),g=this._injector.get(m.SheetCanvasFloatDomManagerService).addFloatDomToColumnHeader(i,{...t,componentKey:c,unitId:s,subUnitId:a},e,n);return g?(d.add(g.dispose),{id:g.id,dispose:()=>{d.dispose(),g.dispose()}}):(d.dispose(),null)}async insertImage(i,t,e,n,s){const a=this.newOverGridImage();if(typeof i=="string")a.setSource(i);else{const h=await i.getBlob().getDataAsString();a.setSource(h,o.ImageSourceType.BASE64)}t!==void 0?a.setColumn(t):a.setColumn(0),e!==void 0?a.setRow(e):a.setRow(0),n!==void 0?a.setColumnOffset(n):a.setColumnOffset(0),s!==void 0?a.setRowOffset(s):a.setRowOffset(0);const c=await a.buildAsync();return this._commandService.syncExecuteCommand(m.InsertSheetDrawingCommand.id,{unitId:this._fWorkbook.getId(),drawings:[c]})}insertImages(i){const t=i.map(e=>(e.unitId=this._fWorkbook.getId(),e.subUnitId=this.getSheetId(),e));return this._commandService.syncExecuteCommand(m.InsertSheetDrawingCommand.id,{unitId:this._fWorkbook.getId(),drawings:t}),this}deleteImages(i){const t=i.map(e=>({unitId:this._fWorkbook.getId(),drawingId:e.getId(),subUnitId:this.getSheetId(),drawingType:e.getType()}));return this._commandService.syncExecuteCommand(m.RemoveSheetDrawingCommand.id,{unitId:this._fWorkbook.getId(),drawings:t}),this}getImages(){const t=this._injector.get(l.ISheetDrawingService).getDrawingData(this._fWorkbook.getId(),this.getSheetId()),e=[];for(const n in t){const s=t[n];s.drawingType===o.DrawingTypeEnum.DRAWING_IMAGE&&e.push(this._injector.createInstance(I,s))}return e}getImageById(i){const e=this._injector.get(l.ISheetDrawingService).getDrawingByParam({unitId:this._fWorkbook.getId(),subUnitId:this.getSheetId(),drawingId:i});return e&&e.drawingType===o.DrawingTypeEnum.DRAWING_IMAGE?this._injector.createInstance(I,e):null}getActiveImages(){const t=this._injector.get(l.ISheetDrawingService).getFocusDrawings(),e=[];for(const n in t){const s=t[n];e.push(this._injector.createInstance(I,s))}return e}updateImages(i){return this._commandService.syncExecuteCommand(m.SetSheetDrawingCommand.id,{unitId:this._fWorkbook.getId(),drawings:i}),this}onImageInserted(i){const t=this._injector.get(l.ISheetDrawingService);return o.toDisposable(t.add$.subscribe(e=>{const n=e.map(s=>this._injector.createInstance(I,t.getDrawingByParam(s)));i(n)}))}onImageDeleted(i){const t=this._injector.get(l.ISheetDrawingService);return o.toDisposable(t.remove$.subscribe(e=>{const n=e.map(s=>this._injector.createInstance(I,t.getDrawingByParam(s)));i(n)}))}onImageChanged(i){const t=this._injector.get(l.ISheetDrawingService);return o.toDisposable(t.update$.subscribe(e=>{const n=e.map(s=>this._injector.createInstance(I,t.getDrawingByParam(s)));i(n)}))}newOverGridImage(){const i=this._fWorkbook.getId(),t=this.getSheetId();return this._injector.createInstance(S,i,t)}}D.FWorksheet.extend(F);class A extends u.FEnum{get DrawingType(){return o.DrawingTypeEnum}get ImageSourceType(){return o.ImageSourceType}get SheetDrawingAnchorType(){return l.SheetDrawingAnchorType}}u.FEnum.extend(A);class x extends u.FEventName{get BeforeOverGridImageChange(){return"BeforeOverGridImageChange"}get OverGridImageChanged(){return"OverGridImageChanged"}get BeforeOverGridImageInsert(){return"BeforeOverGridImageInsert"}get OverGridImageInserted(){return"OverGridImageInserted"}get BeforeOverGridImageRemove(){return"BeforeOverGridImageRemove"}get OverGridImageRemoved(){return"OverGridImageRemoved"}get BeforeOverGridImageSelect(){return"BeforeOverGridImageSelect"}get OverGridImageSelected(){return"OverGridImageSelected"}}u.FEventName.extend(x);class M extends u.FUniver{_initialize(i){const t=i.get(o.ICommandService);this.registerEventHandler(this.Event.BeforeOverGridImageInsert,()=>t.beforeCommandExecuted(e=>{if(e.id!==m.InsertSheetDrawingCommand.id)return;const n=e.params,s=this.getActiveWorkbook();if(s==null||n==null)return;const{drawings:a}=n,c={workbook:s,insertImageParams:a};if(this.fireEvent(this.Event.BeforeOverGridImageInsert,c),c.cancel)throw new Error("Canceled by BeforeOverGridImageInsert event")})),this.registerEventHandler(this.Event.BeforeOverGridImageRemove,()=>t.beforeCommandExecuted(e=>{if(e.id!==m.RemoveSheetDrawingCommand.id)return;const n=e.params,s=this.getActiveWorkbook();if(s==null||n==null)return;const a=i.get(v.IDrawingManagerService),{drawings:c}=n,d=c.map(g=>a.getDrawingByParam(g)),h={workbook:s,images:this._createFOverGridImage(d)};if(this.fireEvent(this.Event.BeforeOverGridImageRemove,h),h.cancel)throw new Error("Canceled by BeforeOverGridImageRemove event")})),this.registerEventHandler(this.Event.BeforeOverGridImageChange,()=>t.beforeCommandExecuted(e=>{if(e.id!==m.SetSheetDrawingCommand.id)return;const n=e.params,s=this.getActiveWorkbook();if(s==null||n==null)return;const{drawings:a}=n,c=i.get(v.IDrawingManagerService),d=[];a.forEach(g=>{const f=c.getDrawingByParam(g);f!=null&&d.push({changeParam:g,image:this._injector.createInstance(I,f)})});const h={workbook:s,images:d};if(this.fireEvent(this.Event.BeforeOverGridImageChange,h),h.cancel)throw c.updateNotification(a),new Error("Canceled by BeforeOverGridImageChange event")})),this.registerEventHandler(this.Event.BeforeOverGridImageSelect,()=>t.beforeCommandExecuted(e=>{if(e.id!==v.SetDrawingSelectedOperation.id)return;const n=e.params,s=this.getActiveWorkbook();if(s==null)return;const a=i.get(v.IDrawingManagerService),c=a.getFocusDrawings(),d=n.map(g=>a.getDrawingByParam(g)),h={workbook:s,selectedImages:this._createFOverGridImage(d),oldSelectedImages:this._createFOverGridImage(c)};if(this.fireEvent(this.Event.BeforeOverGridImageSelect,h),h.cancel)throw new Error("Canceled by BeforeOverGridImageSelect event")})),this.registerEventHandler(this.Event.OverGridImageInserted,()=>t.onCommandExecuted(e=>{if(e.id!==m.InsertSheetDrawingCommand.id)return;const n=e.params,s=this.getActiveWorkbook();if(s==null||n==null)return;const{drawings:a}=n;this.fireEvent(this.Event.OverGridImageInserted,{workbook:s,images:this._createFOverGridImage(a)})})),this.registerEventHandler(this.Event.OverGridImageRemoved,()=>t.onCommandExecuted(e=>{if(e.id!==m.RemoveSheetDrawingCommand.id)return;const n=e.params,s=this.getActiveWorkbook();if(s==null||n==null)return;const{drawings:a}=n;this.fireEvent(this.Event.OverGridImageRemoved,{workbook:s,removeImageParams:a})})),this.registerEventHandler(this.Event.OverGridImageChanged,()=>t.onCommandExecuted(e=>{if(e.id!==m.SetSheetDrawingCommand.id)return;const n=e.params,s=this.getActiveWorkbook();if(s==null||n==null)return;const{drawings:a}=n,c=i.get(v.IDrawingManagerService),d=a.map(h=>this._injector.createInstance(I,c.getDrawingByParam(h)));this.fireEvent(this.Event.OverGridImageChanged,{workbook:s,images:d})})),this.registerEventHandler(this.Event.OverGridImageSelected,()=>t.onCommandExecuted(e=>{if(e.id!==v.SetDrawingSelectedOperation.id)return;const n=e.params,s=this.getActiveWorkbook();if(s==null)return;const a=i.get(v.IDrawingManagerService),c=n.map(d=>a.getDrawingByParam(d));this.fireEvent(this.Event.OverGridImageSelected,{workbook:s,selectedImages:this._createFOverGridImage(c)})}))}_createFOverGridImage(i){return i.map(t=>this._injector.createInstance(I,t))}}u.FUniver.extend(M)});


// index
(function(e,i){typeof exports=="object"&&typeof module<"u"?i(exports,require("@univerjs/docs-drawing"),require("@univerjs/drawing"),require("@univerjs/drawing-ui"),require("@univerjs/sheets-drawing"),require("@univerjs/sheets-drawing-ui"),require("@univerjs/sheets-drawing-ui/facade")):typeof define=="function"&&define.amd?define(["exports","@univerjs/docs-drawing","@univerjs/drawing","@univerjs/drawing-ui","@univerjs/sheets-drawing","@univerjs/sheets-drawing-ui","@univerjs/sheets-drawing-ui/facade"],i):(e=typeof globalThis<"u"?globalThis:e||self,i(e.UniverPresetSheetsDrawing={},e.UniverDocsDrawing,e.UniverDrawing,e.UniverDrawingUi,e.UniverSheetsDrawing,e.UniverSheetsDrawingUi))})(this,function(e,i,n,r,s,u){"use strict";function t(a={}){const{collaboration:g=!1}=a;return{plugins:[[n.UniverDrawingPlugin,{override:g?[[n.IImageIoService,null]]:[]}],i.UniverDocsDrawingPlugin,r.UniverDrawingUIPlugin,s.UniverSheetsDrawingPlugin,u.UniverSheetsDrawingUIPlugin].filter(v=>!!v)}}e.UniverSheetsDrawingPreset=t,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})});
