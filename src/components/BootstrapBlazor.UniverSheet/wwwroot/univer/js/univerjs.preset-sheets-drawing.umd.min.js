// @univerjs/docs-drawing/index
(function(t,r){typeof exports=="object"&&typeof module<"u"?r(exports,require("@univerjs/core"),require("@univerjs/drawing")):typeof define=="function"&&define.amd?define(["exports","@univerjs/core","@univerjs/drawing"],r):(t=typeof globalThis<"u"?globalThis:t||self,r(t.UniverDocsDrawing={},t.UniverCore,t.UniverDrawing))})(this,function(t,r,g){"use strict";var P=Object.defineProperty;var N=(t,r,g)=>r in t?P(t,r,{enumerable:!0,configurable:!0,writable:!0,value:g}):t[r]=g;var w=(t,r,g)=>N(t,typeof r!="symbol"?r+"":r,g);var d;const S="docs-drawing.config",h={};class u extends g.UnitDrawingService{}const _=r.createIdentifier("univer.doc.plugin.doc-drawing.service");var U=Object.getOwnPropertyDescriptor,I=(c,i,a,e)=>{for(var n=e>1?void 0:e?U(i,a):i,s=c.length-1,o;s>=0;s--)(o=c[s])&&(n=o(n)||n);return n},D=(c,i)=>(a,e)=>i(a,e,c);const l="DOC_DRAWING_PLUGIN";t.DocDrawingController=class extends r.Disposable{constructor(i,a,e,n){super(),this._docDrawingService=i,this._drawingManagerService=a,this._resourceManagerService=e,this._univerInstanceService=n,this._init()}_init(){this._initSnapshot()}_initSnapshot(){const i=e=>{const n=this._univerInstanceService.getUnit(e,r.UniverInstanceType.UNIVER_DOC);if(n){const s=n.getSnapshot().drawings,o=n.getSnapshot().drawingsOrder,v={data:s!=null?s:{},order:o!=null?o:[]};return JSON.stringify(v)}return""},a=e=>{if(!e)return{data:{},order:[]};try{return JSON.parse(e)}catch{return{data:{},order:[]}}};this.disposeWithMe(this._resourceManagerService.registerPluginResource({pluginName:l,businesses:[r.UniverInstanceType.UNIVER_DOC],toJson:e=>i(e),parseJson:e=>a(e),onUnLoad:e=>{this._setDrawingDataForUnit(e,{data:{},order:[]})},onLoad:(e,n)=>{var s,o;this._setDrawingDataForUnit(e,{data:(s=n.data)!=null?s:{},order:(o=n.order)!=null?o:[]})}}))}_setDrawingDataForUnit(i,a){const e=this._univerInstanceService.getUnit(i);e!=null&&(e.resetDrawing(a.data,a.order),this.loadDrawingDataForUnit(i))}loadDrawingDataForUnit(i){const a=this._univerInstanceService.getUnit(i,r.UniverInstanceType.UNIVER_DOC);if(!a)return!1;const e=i,n=a.getDrawings(),s=a.getDrawingsOrder();if(!n||!s)return!1;Object.keys(n).forEach(v=>{const O=n[v];n[v]={...O}});const o={[e]:{unitId:i,subUnitId:e,data:n,order:s}};return this._docDrawingService.registerDrawingData(i,o),this._drawingManagerService.registerDrawingData(i,o),!0}},t.DocDrawingController=I([D(0,_),D(1,g.IDrawingManagerService),D(2,r.IResourceManagerService),D(3,r.IUniverInstanceService)],t.DocDrawingController);var p=Object.getOwnPropertyDescriptor,C=(c,i,a,e)=>{for(var n=e>1?void 0:e?p(i,a):i,s=c.length-1,o;s>=0;s--)(o=c[s])&&(n=o(n)||n);return n},f=(c,i)=>(a,e)=>i(a,e,c);t.UniverDocsDrawingPlugin=(d=class extends r.Plugin{constructor(i=h,a,e){super(),this._config=i,this._injector=a,this._configService=e;const{...n}=r.merge({},h,this._config);this._configService.setConfig(S,n)}onStarting(){[[t.DocDrawingController],[u],[_,{useClass:u}]].forEach(i=>this._injector.add(i)),r.touchDependencies(this._injector,[[t.DocDrawingController]])}},w(d,"pluginName",l),w(d,"type",r.UniverInstanceType.UNIVER_DOC),d),t.UniverDocsDrawingPlugin=C([f(1,r.Inject(r.Injector)),f(2,r.IConfigService)],t.UniverDocsDrawingPlugin),t.DOCS_DRAWING_PLUGIN=l,t.DocDrawingService=u,t.IDocDrawingService=_,Object.defineProperty(t,Symbol.toStringTag,{value:"Module"})});


// @univerjs/drawing-ui/index
(function(D,h){typeof exports=="object"&&typeof module<"u"?h(exports,require("@univerjs/core"),require("@univerjs/drawing"),require("@univerjs/engine-render"),require("@univerjs/ui"),require("react/jsx-runtime"),require("react"),require("@univerjs/design"),require("rxjs")):typeof define=="function"&&define.amd?define(["exports","@univerjs/core","@univerjs/drawing","@univerjs/engine-render","@univerjs/ui","react/jsx-runtime","react","@univerjs/design","rxjs"],h):(D=typeof globalThis<"u"?globalThis:D||self,h(D.UniverDrawingUi={},D.UniverCore,D.UniverDrawing,D.UniverEngineRender,D.UniverUi,D.React,D.React,D.UniverDesign,D.rxjs))})(this,function(D,h,M,b,V,l,_,I,Me){"use strict";var Rn=Object.defineProperty;var Ln=(D,h,M)=>h in D?Rn(D,h,{enumerable:!0,configurable:!0,writable:!0,value:M}):D[h]=M;var ee=(D,h,M)=>Ln(D,typeof h!="symbol"?h+"":h,M);var Pe;function Oe(a,t,n,e){const r=e.getDrawingByParam(a);if(r==null)return;const s=M.getDrawingShapeKeyByDrawingSearch(a),i=n.getObject(s);if(i&&!(i instanceof b.Group))return;if(i!=null){i.addObject(t);return}const o=new b.Group(s);n.addObject(o,b.DRAWING_OBJECT_LAYER_INDEX).attachTransformerTo(o),o.addObject(t);const{transform:c}=r;c&&o.transformByState({left:c.left,top:c.top,angle:c.angle})}function Ne(a,t){var s;const n=t?a.getUnit(t):a.getFocusedUnit();if(n==null)return;const e=n.getUnitId();let r;return n.type===h.UniverInstanceType.UNIVER_SHEET?r=(s=n.getActiveSheet())==null?void 0:s.getSheetId():(n.type===h.UniverInstanceType.UNIVER_DOC||n.type===h.UniverInstanceType.UNIVER_SLIDE)&&(r=e),{unitId:e,subUnitId:r,current:n}}const Ee="COMPONENT_IMAGE_VIEWER";var Ye=Object.getOwnPropertyDescriptor,Ze=(a,t,n,e)=>{for(var r=e>1?void 0:e?Ye(t,n):t,s=a.length-1,i;s>=0;s--)(i=a[s])&&(r=i(r)||r);return r},ye=(a,t)=>(n,e)=>t(n,e,a);const Te=50;D.DrawingRenderService=class{constructor(t,n,e){this._drawingManagerService=t,this._imageIoService=n,this._dialogService=e}async renderImages(t,n){const{transform:e,drawingType:r,source:s,imageSourceType:i,srcRect:o,prstGeom:c,groupId:g,unitId:d,subUnitId:u,drawingId:f,isMultiTransform:p,transforms:S}=t;if(r!==h.DrawingTypeEnum.DRAWING_IMAGE||!this._drawingManagerService.getDrawingVisible()||e==null)return;const v=p&&S?S:[e],C=[];for(const P of v){const{left:y,top:U,width:O,height:R,angle:T,flipX:N,flipY:E,skewX:B,skewY:j}=P,G=v.indexOf(P),x=M.getDrawingShapeKeyByDrawingSearch({unitId:d,subUnitId:u,drawingId:f},p?G:void 0),F=n.getObject(x);if(F!=null){F.transformByState({left:y,top:U,width:O,height:R,angle:T,flipX:N,flipY:E,skewX:B,skewY:j});continue}const z=this._drawingManagerService.getDrawingOrder(d,u),ce=z.indexOf(f),ae={...P,zIndex:ce===-1?z.length-1:ce},ie=this._imageIoService.getImageSourceCache(s,i);let le=!1;if(ie!=null)ae.image=ie;else{if(i===M.ImageSourceType.UUID)try{ae.url=await this._imageIoService.getImage(s)}catch(De){console.error(De);continue}else ae.url=s;le=!0}if(n.getObject(x))continue;ae.printable=!0;const J=new b.Image(x,ae);le&&this._imageIoService.addImageSourceCache(s,i,J.getNative()),this._drawingManagerService.getDrawingVisible()&&(n.addObject(J,b.DRAWING_OBJECT_LAYER_INDEX),this._drawingManagerService.getDrawingEditable()&&n.attachTransformerTo(J),g&&Oe({drawingId:g,unitId:d,subUnitId:u},J,n,this._drawingManagerService),c!=null&&J.setPrstGeom(c),o!=null&&J.setSrcRect(o),C.push(J))}return C}renderFloatDom(t,n){const{transform:e,drawingType:r,groupId:s,unitId:i,subUnitId:o,drawingId:c,isMultiTransform:g,transforms:d}=t;if(r!==h.DrawingTypeEnum.DRAWING_DOM||!this._drawingManagerService.getDrawingVisible()||e==null)return;const u=g&&d?d:[e],f=[];for(const p of u){const{left:S,top:v,width:C,height:P,angle:y,flipX:U,flipY:O,skewX:R,skewY:T}=p,N=u.indexOf(p),E=M.getDrawingShapeKeyByDrawingSearch({unitId:i,subUnitId:o,drawingId:c},g?N:void 0),B=n.getObject(E);if(B!=null){B.transformByState({left:S,top:v,width:C,height:P,angle:y,flipX:U,flipY:O,skewX:R,skewY:T});continue}const j=this._drawingManagerService.getDrawingOrder(i,o),G=j.indexOf(c),x={...p,zIndex:G===-1?j.length-1:G};if(n.getObject(E))continue;x.printable=!1;const F=new b.Rect(E,x);this._drawingManagerService.getDrawingVisible()&&(n.addObject(F,b.DRAWING_OBJECT_LAYER_INDEX),this._drawingManagerService.getDrawingEditable()&&t.allowTransform!==!1&&n.attachTransformerTo(F),s&&Oe({drawingId:s,unitId:i,subUnitId:o},F,n,this._drawingManagerService),f.push(F))}return f}renderDrawing(t,n){const e=this._drawingManagerService.getDrawingByParam(t);if(e!=null)switch(e.drawingType){case h.DrawingTypeEnum.DRAWING_IMAGE:return this.renderImages(e,n)}}previewImage(t,n,e,r){const s=`${t}-viewer-dialog`,i=window.innerWidth-Te,o=window.innerHeight-Te,c=this._adjustImageSize(e,r,i,o),g=this._dialogService.open({width:Math.max(c.width,200),id:s,style:{margin:"0",top:"50%",left:"50%",transform:"translate(-50%, -50%)"},children:{label:{name:Ee,props:{src:n,width:c.width,height:c.height}}},destroyOnClose:!0,draggable:!1,onClose:()=>{this._dialogService.close(s),g.dispose()}})}_adjustImageSize(t,n,e,r){if(t<=e&&n<=r)return{width:t,height:n};const s=e/t,i=r/n,o=Math.min(s,i);return{width:Math.floor(t*o),height:Math.floor(n*o)}}},D.DrawingRenderService=Ze([ye(0,M.IDrawingManagerService),ye(1,M.IImageIoService),ye(2,V.IDialogService)],D.DrawingRenderService);function ge(a,t){const n=[];return a.forEach(e=>{const{oKey:r,left:s,top:i,height:o,width:c,angle:g}=e,d=t.getDrawingOKey(r);if(d==null)return n.push(null),!0;const{unitId:u,subUnitId:f,drawingId:p,drawingType:S}=d,v={unitId:u,subUnitId:f,drawingId:p,drawingType:S,transform:{left:s,top:i,height:o,width:c,angle:g}};S===h.DrawingTypeEnum.DRAWING_IMAGE&&(v.srcRect=e.srcRect),n.push(v)}),n}var A=(a=>(a.default="0",a.left="1",a.center="2",a.right="3",a.top="4",a.middle="5",a.bottom="6",a.horizon="7",a.vertical="8",a))(A||{});const fe={id:"sheet.operation.set-image-align",type:h.CommandType.OPERATION,handler:(a,t)=>!0},m={imageCommonPanelGrid:"univer-image-common-panel-grid",imageCommonPanelBorder:"univer-image-common-panel-border",imageCommonPanelTitle:"univer-image-common-panel-title",imageCommonPanelRow:"univer-image-common-panel-row",imageCommonPanelRowVertical:"univer-image-common-panel-row-vertical",imageCommonPanelColumn:"univer-image-common-panel-column",imageCommonPanelColumnCenter:"univer-image-common-panel-column-center",imageCommonPanelInline:"univer-image-common-panel-inline",imageCommonPanelSpan2:"univer-image-common-panel-span2",imageCommonPanelSpan3:"univer-image-common-panel-span3",imageCommonPanelInput:"univer-image-common-panel-input"},Xe=a=>{const t=V.useDependency(h.ICommandService),n=V.useDependency(h.LocaleService),{alignShow:e}=a,[r,s]=_.useState(A.default),i=[{label:n.t("image-panel.align.default"),value:A.default},{options:[{label:n.t("image-panel.align.left"),value:A.left},{label:n.t("image-panel.align.center"),value:A.center},{label:n.t("image-panel.align.right"),value:A.right}]},{options:[{label:n.t("image-panel.align.top"),value:A.top},{label:n.t("image-panel.align.middle"),value:A.middle},{label:n.t("image-panel.align.bottom"),value:A.bottom}]},{options:[{label:n.t("image-panel.align.horizon"),value:A.horizon},{label:n.t("image-panel.align.vertical"),value:A.vertical}]}];function o(g){s(g),t.executeCommand(fe.id,{alignType:g})}const c=g=>g?"block":"none";return l.jsxs("div",{className:I.clsx(m.imageCommonPanelGrid,m.imageCommonPanelBorder),style:{display:c(e)},children:[l.jsx("div",{className:m.imageCommonPanelRow,children:l.jsx("div",{className:I.clsx(m.imageCommonPanelColumn,m.imageCommonPanelTitle),children:l.jsx("div",{children:n.t("image-panel.align.title")})})}),l.jsx("div",{className:m.imageCommonPanelRow,children:l.jsx("div",{className:I.clsx(m.imageCommonPanelColumn),children:l.jsx(I.Select,{value:r,options:i,onChange:o})})})]})};var K=function(){return K=Object.assign||function(a){for(var t,n=1,e=arguments.length;n<e;n++){t=arguments[n];for(var r in t)Object.prototype.hasOwnProperty.call(t,r)&&(a[r]=t[r])}return a},K.apply(this,arguments)},qe=function(a,t){var n={};for(var e in a)Object.prototype.hasOwnProperty.call(a,e)&&t.indexOf(e)<0&&(n[e]=a[e]);if(a!=null&&typeof Object.getOwnPropertySymbols=="function")for(var r=0,e=Object.getOwnPropertySymbols(a);r<e.length;r++)t.indexOf(e[r])<0&&Object.prototype.propertyIsEnumerable.call(a,e[r])&&(n[e[r]]=a[e[r]]);return n},X=_.forwardRef(function(a,t){var n=a.icon,e=a.id,r=a.className,s=a.extend,i=qe(a,["icon","id","className","extend"]),o="univerjs-icon univerjs-icon-".concat(e," ").concat(r||"").trim(),c=_.useRef("_".concat(en()));return Be(n,"".concat(e),{defIds:n.defIds,idSuffix:c.current},K({ref:t,className:o},i),s)});function Be(a,t,n,e,r){return _.createElement(a.tag,K(K({key:t},Je(a,n,r)),e),(Qe(a,n).children||[]).map(function(s,i){return Be(s,"".concat(t,"-").concat(a.tag,"-").concat(i),n,void 0,r)}))}function Je(a,t,n){var e=K({},a.attrs);n!=null&&n.colorChannel1&&e.fill==="colorChannel1"&&(e.fill=n.colorChannel1),a.tag==="mask"&&e.id&&(e.id=e.id+t.idSuffix),Object.entries(e).forEach(function(s){var i=s[0],o=s[1];i==="mask"&&typeof o=="string"&&(e[i]=o.replace(/url\(#(.*)\)/,"url(#$1".concat(t.idSuffix,")")))});var r=t.defIds;return!r||r.length===0||(a.tag==="use"&&e["xlink:href"]&&(e["xlink:href"]=e["xlink:href"]+t.idSuffix),Object.entries(e).forEach(function(s){var i=s[0],o=s[1];typeof o=="string"&&(e[i]=o.replace(/url\(#(.*)\)/,"url(#$1".concat(t.idSuffix,")")))})),e}function Qe(a,t){var n,e=t.defIds;return!e||e.length===0?a:a.tag==="defs"&&(!((n=a.children)===null||n===void 0)&&n.length)?K(K({},a),{children:a.children.map(function(r){return typeof r.attrs.id=="string"&&e&&e.indexOf(r.attrs.id)>-1?K(K({},r),{attrs:K(K({},r.attrs),{id:r.attrs.id+t.idSuffix})}):r})}):a}function en(){return Math.random().toString(36).substring(2,8)}X.displayName="UniverIcon";var nn={tag:"svg",attrs:{fill:"none",viewBox:"0 0 16 16",width:"1em",height:"1em"},children:[{tag:"path",attrs:{fill:"colorChannel1",d:"M11.0363 12.2367V14.0367C11.0363 14.3681 11.3049 14.6367 11.6363 14.6367C11.9676 14.6367 12.2363 14.3681 12.2363 14.0367V12.2367H14.0364C14.3677 12.2367 14.6364 11.9681 14.6364 11.6367C14.6364 11.3054 14.3677 11.0367 14.0364 11.0367H12.2363V9.23672C12.2363 8.90535 11.9676 8.63672 11.6363 8.63672C11.3049 8.63672 11.0363 8.90535 11.0363 9.23672V11.0367H9.23635C8.90498 11.0367 8.63635 11.3054 8.63635 11.6367C8.63635 11.9681 8.90498 12.2367 9.23635 12.2367H11.0363Z"}},{tag:"path",attrs:{fill:"currentColor",d:"M2.56365 1.36377C1.90091 1.36377 1.36365 1.90103 1.36365 2.56377V6.16377C1.36365 6.82651 1.90091 7.36377 2.56365 7.36377H6.16365C6.82639 7.36377 7.36365 6.82651 7.36365 6.16377V2.56377C7.36365 1.90103 6.82639 1.36377 6.16365 1.36377H2.56365zM6.16365 2.56377H2.56365L2.56365 6.16377H6.16365V2.56377zM2.56365 8.63647C1.90091 8.63647 1.36365 9.17373 1.36365 9.83647V13.4365C1.36365 14.0992 1.90091 14.6365 2.56365 14.6365H6.16365C6.82639 14.6365 7.36365 14.0992 7.36365 13.4365V9.83647C7.36365 9.17373 6.82639 8.63647 6.16365 8.63647H2.56365zM6.16365 9.83647H2.56365L2.56365 13.4365H6.16365V9.83647zM9.83635 7.36377C9.17361 7.36377 8.63635 6.82651 8.63635 6.16377V2.56377C8.63635 1.90103 9.17361 1.36377 9.83635 1.36377H13.4364C14.0991 1.36377 14.6364 1.90103 14.6364 2.56377V6.16377C14.6364 6.82651 14.0991 7.36377 13.4364 7.36377H9.83635zM9.83635 6.16377V2.56377L13.4364 2.56377V6.16377H9.83635z",fillRule:"evenodd",clipRule:"evenodd"}}]},Ue=_.forwardRef(function(a,t){return _.createElement(X,Object.assign({},a,{id:"autofill",ref:t,icon:nn}))});Ue.displayName="Autofill";var tn={tag:"svg",attrs:{fill:"none",viewBox:"0 0 17 16",width:"1em",height:"1em"},children:[{tag:"path",attrs:{fill:"currentColor",d:"M14.0045 4.4334C14.8881 4.4334 15.6045 3.71705 15.6045 2.8334 15.6045 1.94974 14.8881 1.2334 14.0045 1.2334H3.70449C2.82084 1.2334 2.10449 1.94974 2.10449 2.8334 2.10449 3.71705 2.82084 4.4334 3.70449 4.4334H14.0045zM14.4045 2.8334C14.4045 3.05431 14.2254 3.2334 14.0045 3.2334H3.70449C3.48358 3.2334 3.30449 3.05431 3.30449 2.8334 3.30449 2.61248 3.48358 2.4334 3.70449 2.4334H14.0045C14.2254 2.4334 14.4045 2.61249 14.4045 2.8334zM14.1544 8.5999C15.038 8.5999 15.7544 7.88356 15.7544 6.9999 15.7544 6.11625 15.038 5.3999 14.1544 5.3999H3.85439C2.97074 5.3999 2.25439 6.11625 2.25439 6.9999 2.25439 7.88356 2.97074 8.5999 3.85439 8.5999H14.1544zM14.5544 6.9999C14.5544 7.22082 14.3753 7.3999 14.1544 7.3999H3.85439C3.63348 7.3999 3.45439 7.22082 3.45439 6.9999 3.45439 6.77899 3.63348 6.5999 3.85439 6.5999H14.1544C14.3753 6.5999 14.5544 6.77899 14.5544 6.9999z",fillRule:"evenodd",clipRule:"evenodd"}},{tag:"path",attrs:{fill:"currentColor",d:"M8.57975 14.5902L6.58023 12.5907C6.34591 12.3564 6.34591 11.9765 6.58023 11.7421 6.81454 11.5078 7.19444 11.5078 7.42876 11.7421L8.40449 12.7179V10.1664C8.40449 9.83504 8.67312 9.56641 9.00449 9.56641 9.33586 9.56641 9.60449 9.83504 9.60449 10.1664V12.7179L10.5802 11.7421C10.8145 11.5078 11.1944 11.5078 11.4288 11.7421 11.6631 11.9765 11.6631 12.3564 11.4288 12.5907L9.42923 14.5902M8.57975 14.5902C8.58121 14.5917 8.58268 14.5931 8.58416 14.5946 8.64077 14.6502 8.70566 14.6923 8.77482 14.7209 8.84557 14.7502 8.92314 14.7664 9.00449 14.7664 9.08585 14.7664 9.16342 14.7502 9.23416 14.7209 9.30332 14.6923 9.36821 14.6502 9.42482 14.5946"}}]},je=_.forwardRef(function(a,t){return _.createElement(X,Object.assign({},a,{id:"bottom-single",ref:t,icon:tn}))});je.displayName="BottomSingle";var rn={tag:"svg",attrs:{fill:"none",viewBox:"0 0 16 16",width:"1em",height:"1em"},children:[{tag:"path",attrs:{fill:"currentColor",d:"M5.97705 7.51296C5.97705 7.18159 6.24568 6.91296 6.57705 6.91296H8.48632C8.81769 6.91296 9.08632 7.18159 9.08632 7.51296 9.08632 7.84433 8.81769 8.11296 8.48632 8.11296H6.57705C6.24568 8.11296 5.97705 7.84433 5.97705 7.51296zM6.57705 9.41028C6.24568 9.41028 5.97705 9.67891 5.97705 10.0103 5.97705 10.3416 6.24568 10.6103 6.57705 10.6103H10.8199C11.1512 10.6103 11.4199 10.3416 11.4199 10.0103 11.4199 9.67891 11.1512 9.41028 10.8199 9.41028H6.57705z"}},{tag:"path",attrs:{fill:"currentColor",d:"M3.51074 2.37063C3.51074 1.48697 4.22709 0.77063 5.11074 0.77063H9.80318L9.81294 0.770708C9.97168 0.768161 10.1311 0.82824 10.2511 0.95055L14.4317 5.21408C14.5165 5.30049 14.5697 5.406 14.5917 5.51645C14.6041 5.5644 14.6106 5.61467 14.6106 5.66648V11.6406C14.6106 12.5243 13.8943 13.2406 13.0106 13.2406H5.11074C4.22709 13.2406 3.51074 12.5243 3.51074 11.6406V2.37063ZM10.4032 4.66648V2.81964L12.6063 5.06648H10.8032C10.5823 5.06648 10.4032 4.88739 10.4032 4.66648ZM5.11074 1.97063C4.88983 1.97063 4.71074 2.14972 4.71074 2.37063V11.6406C4.71074 11.8615 4.88983 12.0406 5.11074 12.0406H13.0106C13.2316 12.0406 13.4106 11.8615 13.4106 11.6406V6.26648H10.8032C9.91953 6.26648 9.20318 5.55013 9.20318 4.66648V1.97063H5.11074Z",fillRule:"evenodd",clipRule:"evenodd"}},{tag:"path",attrs:{fill:"currentColor",d:"M2.58916 6.6741C2.58916 6.34273 2.32053 6.0741 1.98916 6.0741C1.65779 6.0741 1.38916 6.34273 1.38916 6.6741V12.6294C1.38916 14.0653 2.55322 15.2294 3.98916 15.2294H9.41408C9.74545 15.2294 10.0141 14.9607 10.0141 14.6294C10.0141 14.298 9.74545 14.0294 9.41408 14.0294H3.98916C3.21596 14.0294 2.58916 13.4026 2.58916 12.6294V6.6741Z"}}]},Ae=_.forwardRef(function(a,t){return _.createElement(X,Object.assign({},a,{id:"create-copy-single",ref:t,icon:rn}))});Ae.displayName="CreateCopySingle";var an={tag:"svg",attrs:{fill:"none",viewBox:"0 0 17 16",width:"1em",height:"1em"},children:[{tag:"path",attrs:{fill:"currentColor",d:"M7.38125 1.16211C6.49759 1.16211 5.78125 1.87845 5.78125 2.76211V5.6377H2.87783C1.99418 5.6377 1.27783 6.35404 1.27783 7.2377V13.2377C1.27783 14.1214 1.99418 14.8377 2.87783 14.8377H8.87783C9.76149 14.8377 10.4778 14.1214 10.4778 13.2377V10.3621H13.3813C14.2649 10.3621 14.9813 9.64577 14.9813 8.76211V2.76211C14.9813 1.87845 14.2649 1.16211 13.3813 1.16211H7.38125ZM10.4778 9.16211H13.3813C13.6022 9.16211 13.7812 8.98302 13.7812 8.76211V2.76211C13.7812 2.5412 13.6022 2.36211 13.3813 2.36211H7.38125C7.16034 2.36211 6.98125 2.5412 6.98125 2.76211V5.6377H8.87783C9.76149 5.6377 10.4778 6.35404 10.4778 7.2377V9.16211ZM6.98125 6.8377H8.87783C9.09875 6.8377 9.27783 7.01678 9.27783 7.2377V9.16211H7.38125C7.16034 9.16211 6.98125 8.98302 6.98125 8.76211V6.8377ZM5.78125 6.8377V8.76211C5.78125 9.64577 6.49759 10.3621 7.38125 10.3621H9.27783V13.2377C9.27783 13.4586 9.09875 13.6377 8.87783 13.6377H2.87783C2.65692 13.6377 2.47783 13.4586 2.47783 13.2377V7.2377C2.47783 7.01678 2.65692 6.8377 2.87783 6.8377H5.78125Z",fillRule:"evenodd",clipRule:"evenodd"}}]},Re=_.forwardRef(function(a,t){return _.createElement(X,Object.assign({},a,{id:"group-single",ref:t,icon:an}))});Re.displayName="GroupSingle";var sn={tag:"svg",attrs:{fill:"none",viewBox:"0 0 16 16",width:"1em",height:"1em"},children:[{tag:"path",attrs:{fill:"currentColor",d:"M11.3536 6.14645C11.5488 6.34171 11.5488 6.65829 11.3536 6.85355L8.35355 9.85355C8.15829 10.0488 7.84171 10.0488 7.64645 9.85355L4.64645 6.85355C4.45118 6.65829 4.45118 6.34171 4.64645 6.14645C4.84171 5.95118 5.15829 5.95118 5.35355 6.14645L8 8.79289L10.6464 6.14645C10.8417 5.95118 11.1583 5.95118 11.3536 6.14645Z",fillRule:"evenodd",clipRule:"evenodd"}}]},Le=_.forwardRef(function(a,t){return _.createElement(X,Object.assign({},a,{id:"more-down-single",ref:t,icon:sn}))});Le.displayName="MoreDownSingle";var on={tag:"svg",attrs:{fill:"none",viewBox:"0 0 16 16",width:"1em",height:"1em"},children:[{tag:"path",attrs:{fill:"currentColor",d:"M1.25 2.96401C1.25 3.84767 1.96634 4.56401 2.85 4.56401H13.15C14.0337 4.56401 14.75 3.84767 14.75 2.96401C14.75 2.08036 14.0337 1.36401 13.15 1.36401H2.85C1.96635 1.36401 1.25 2.08036 1.25 2.96401ZM2.85 3.36401C2.62909 3.36401 2.45 3.18493 2.45 2.96401C2.45 2.7431 2.62909 2.56401 2.85 2.56401H13.15C13.3709 2.56401 13.55 2.7431 13.55 2.96401C13.55 3.18493 13.3709 3.36401 13.15 3.36401H2.85Z",fillRule:"evenodd",clipRule:"evenodd"}},{tag:"path",attrs:{fill:"currentColor",d:"M5.57564 11.6118C5.80995 11.3774 6.18985 11.3774 6.42417 11.6118L7.3999 12.5875V6.36951C7.3999 6.03814 7.66853 5.76951 7.9999 5.76951C8.33127 5.76951 8.5999 6.03814 8.5999 6.36951V12.5875L9.57564 11.6118C9.80995 11.3774 10.1899 11.3774 10.4242 11.6118C10.6585 11.8461 10.6585 12.226 10.4242 12.4603L8.4324 14.452C8.32324 14.5655 8.16982 14.6362 7.9999 14.6362C7.82998 14.6362 7.67655 14.5655 7.56739 14.452L5.57564 12.4603C5.34132 12.226 5.34132 11.8461 5.57564 11.6118Z"}}]},xe=_.forwardRef(function(a,t){return _.createElement(X,Object.assign({},a,{id:"move-down-single",ref:t,icon:on}))});xe.displayName="MoveDownSingle";var cn={tag:"svg",attrs:{fill:"none",viewBox:"0 0 16 16",width:"1em",height:"1em"},children:[{tag:"path",attrs:{fill:"currentColor",d:"M1.25 13.036C1.25 12.1523 1.96634 11.436 2.85 11.436H13.15C14.0337 11.436 14.75 12.1523 14.75 13.036C14.75 13.9196 14.0337 14.636 13.15 14.636H2.85C1.96635 14.636 1.25 13.9196 1.25 13.036ZM2.85 12.636C2.62909 12.636 2.45 12.8151 2.45 13.036C2.45 13.2569 2.62909 13.436 2.85 13.436H13.15C13.3709 13.436 13.55 13.2569 13.55 13.036C13.55 12.8151 13.3709 12.636 13.15 12.636H2.85Z",fillRule:"evenodd",clipRule:"evenodd"}},{tag:"path",attrs:{fill:"currentColor",d:"M5.57564 4.38825C5.80995 4.62256 6.18985 4.62256 6.42417 4.38825L7.3999 3.41251V9.63049C7.3999 9.96186 7.66853 10.2305 7.9999 10.2305C8.33127 10.2305 8.5999 9.96186 8.5999 9.63049V3.41251L9.57564 4.38825C9.80995 4.62256 10.1899 4.62256 10.4242 4.38825C10.6585 4.15393 10.6585 3.77403 10.4242 3.53972L8.4324 1.54796C8.32324 1.43445 8.16982 1.36382 7.9999 1.36382C7.82998 1.36382 7.67655 1.43446 7.56739 1.54797L5.57564 3.53972C5.34132 3.77403 5.34132 4.15393 5.57564 4.38825Z"}}]},He=_.forwardRef(function(a,t){return _.createElement(X,Object.assign({},a,{id:"move-up-single",ref:t,icon:cn}))});He.displayName="MoveUpSingle";var ln={tag:"svg",attrs:{fill:"none",viewBox:"0 0 17 16",width:"1em",height:"1em"},children:[{tag:"path",attrs:{fill:"currentColor",d:"M7.82994 1.40913C7.88746 1.35161 7.95376 1.30821 8.02453 1.27893C8.09527 1.24959 8.17285 1.2334 8.2542 1.2334C8.33555 1.2334 8.41313 1.24959 8.48387 1.27893C8.55464 1.30821 8.62094 1.35161 8.67846 1.40913L10.6785 3.40913C10.9128 3.64345 10.9128 4.02335 10.6785 4.25766C10.4441 4.49198 10.0642 4.49198 9.82994 4.25766L8.8542 3.28193V5.8334C8.8542 6.16477 8.58557 6.4334 8.2542 6.4334C7.92283 6.4334 7.6542 6.16477 7.6542 5.8334V3.28193L6.67846 4.25766C6.44415 4.49198 6.06425 4.49198 5.82994 4.25766C5.59562 4.02335 5.59562 3.64345 5.82994 3.40913L7.82994 1.40913Z"}},{tag:"path",attrs:{fill:"currentColor",d:"M1.50439 9C1.50439 8.11634 2.22074 7.4 3.10439 7.4H13.4044C14.288 7.4 15.0044 8.11634 15.0044 9 15.0044 9.88366 14.2881 10.6 13.4044 10.6H3.1044C2.22074 10.6 1.50439 9.88366 1.50439 9zM3.10439 8.6C2.88348 8.6 2.70439 8.77909 2.70439 9 2.70439 9.22091 2.88348 9.4 3.1044 9.4H13.4044C13.6253 9.4 13.8044 9.22091 13.8044 9 13.8044 8.77909 13.6253 8.6 13.4044 8.6H3.10439zM1.6543 13.1665C1.6543 12.2828 2.37064 11.5665 3.2543 11.5665H13.5543C14.438 11.5665 15.1543 12.2828 15.1543 13.1665 15.1543 14.0502 14.438 14.7665 13.5543 14.7665H3.2543C2.37064 14.7665 1.6543 14.0502 1.6543 13.1665zM3.2543 12.7665C3.03338 12.7665 2.8543 12.9456 2.8543 13.1665 2.8543 13.3874 3.03338 13.5665 3.2543 13.5665H13.5543C13.7752 13.5665 13.9543 13.3874 13.9543 13.1665 13.9543 12.9456 13.7752 12.7665 13.5543 12.7665H3.2543z",fillRule:"evenodd",clipRule:"evenodd"}}]},Ge=_.forwardRef(function(a,t){return _.createElement(X,Object.assign({},a,{id:"topmost-single",ref:t,icon:ln}))});Ge.displayName="TopmostSingle";var gn={tag:"svg",attrs:{fill:"none",viewBox:"0 0 17 16",width:"1em",height:"1em"},children:[{tag:"path",attrs:{fill:"currentColor",d:"M7.46855 2.83731C7.46855 2.61639 7.64764 2.4373 7.86855 2.4373H13.8603C14.0812 2.4373 14.2603 2.61639 14.2603 2.8373V9.5049C14.2603 9.72581 14.0812 9.90489 13.8603 9.90489H12.866C12.5346 9.90489 12.266 10.1735 12.266 10.5049C12.266 10.8363 12.5346 11.1049 12.866 11.1049H13.8603C14.7439 11.1049 15.4603 10.3886 15.4603 9.5049V2.8373C15.4603 1.95365 14.7439 1.2373 13.8603 1.2373H7.86855C6.9849 1.2373 6.26855 1.95365 6.26855 2.83731V3.48688C6.26855 3.81825 6.53718 4.08688 6.86855 4.08688C7.19993 4.08688 7.46855 3.81825 7.46855 3.48688V2.83731Z"}},{tag:"path",attrs:{fill:"currentColor",d:"M3.19888 5.56299C2.31522 5.56299 1.59888 6.27933 1.59888 7.16299V13.163C1.59888 14.0466 2.31522 14.763 3.19888 14.763H9.19888C10.0825 14.763 10.7989 14.0466 10.7989 13.163V7.16299C10.7989 6.27933 10.0825 5.56299 9.19888 5.56299H3.19888ZM2.79888 7.16299C2.79888 6.94207 2.97796 6.76299 3.19888 6.76299H9.19888C9.41979 6.76299 9.59888 6.94207 9.59888 7.16299V13.163C9.59888 13.3839 9.41979 13.563 9.19888 13.563H3.19888C2.97796 13.563 2.79888 13.3839 2.79888 13.163V7.16299Z",fillRule:"evenodd",clipRule:"evenodd"}}]},Ve=_.forwardRef(function(a,t){return _.createElement(X,Object.assign({},a,{id:"ungroup-single",ref:t,icon:gn}))});Ve.displayName="UngroupSingle";const mn=a=>{const{arrangeShow:t,drawings:n}=a,e=V.useDependency(h.LocaleService),r=V.useDependency(M.IDrawingManagerService),s=g=>g?"block":"none",[i,o]=_.useState(n);_.useEffect(()=>{const g=r.focus$.subscribe(d=>{o(d)});return()=>{g.unsubscribe()}},[]);const c=g=>{const d=i[0].unitId,u=i[0].subUnitId,f=i.map(p=>p.drawingId);r.featurePluginOrderUpdateNotification({unitId:d,subUnitId:u,drawingIds:f,arrangeType:g})};return l.jsxs("div",{className:m.imageCommonPanelGrid,style:{display:s(t)},children:[l.jsx("div",{className:m.imageCommonPanelRow,children:l.jsx("div",{className:I.clsx(m.imageCommonPanelColumn,m.imageCommonPanelTitle),children:l.jsx("div",{children:e.t("image-panel.arrange.title")})})}),l.jsxs("div",{className:m.imageCommonPanelRow,children:[l.jsx("div",{className:I.clsx(m.imageCommonPanelColumn,m.imageCommonPanelSpan2),children:l.jsx(I.Button,{size:"small",onClick:()=>{c(h.ArrangeTypeEnum.forward)},children:l.jsxs("span",{className:m.imageCommonPanelInline,children:[l.jsx(He,{}),e.t("image-panel.arrange.forward")]})})}),l.jsx("div",{className:I.clsx(m.imageCommonPanelColumn,m.imageCommonPanelSpan2),children:l.jsx(I.Button,{size:"small",onClick:()=>{c(h.ArrangeTypeEnum.backward)},children:l.jsxs("span",{className:m.imageCommonPanelInline,children:[l.jsx(xe,{}),e.t("image-panel.arrange.backward")]})})})]}),l.jsxs("div",{className:m.imageCommonPanelRow,children:[l.jsx("div",{className:I.clsx(m.imageCommonPanelColumn,m.imageCommonPanelSpan2),children:l.jsx(I.Button,{size:"small",onClick:()=>{c(h.ArrangeTypeEnum.front)},children:l.jsxs("span",{className:m.imageCommonPanelInline,children:[l.jsx(Ge,{}),e.t("image-panel.arrange.front")]})})}),l.jsx("div",{className:I.clsx(m.imageCommonPanelColumn,m.imageCommonPanelSpan2),children:l.jsx(I.Button,{size:"small",onClick:()=>{c(h.ArrangeTypeEnum.back)},children:l.jsxs("span",{className:m.imageCommonPanelInline,children:[l.jsx(je,{}),e.t("image-panel.arrange.back")]})})})]})]})},dn=a=>{const t=V.useDependency(h.LocaleService),n=V.useDependency(b.IRenderManagerService),e=V.useDependency(M.IDrawingManagerService),{hasGroup:r,drawings:s}=a,[i,o]=_.useState(!1),[c,g]=_.useState(!0),[d,u]=_.useState(!0),f=C=>C?"block":"none",p=()=>{const C=e.getFocusDrawings(),{unitId:P,subUnitId:y}=C[0],U=h.Tools.generateRandomId(10),O=b.getGroupState(0,0,C.map(N=>N.transform||{})),R={unitId:P,subUnitId:y,drawingId:U,drawingType:h.DrawingTypeEnum.DRAWING_GROUP,transform:O},T=C.map(N=>{const E=N.transform||{left:0,top:0},{unitId:B,subUnitId:j,drawingId:G}=N;return{unitId:B,subUnitId:j,drawingId:G,transform:{...E,left:E.left-O.left,top:E.top-O.top},groupId:U}});e.featurePluginGroupUpdateNotification([{parent:R,children:T}])},S=C=>{if(C.drawingType!==h.DrawingTypeEnum.DRAWING_GROUP)return;const{unitId:P,subUnitId:y,drawingId:U,transform:O={width:0,height:0}}=C;if(O==null)return;const R=e.getDrawingsByGroup({unitId:P,subUnitId:y,drawingId:U});if(R.length===0)return;const T=R.map(N=>{const{transform:E}=N,{unitId:B,subUnitId:j,drawingId:G}=N,x=b.transformObjectOutOfGroup(E||{},O,O.width||0,O.height||0);return{unitId:B,subUnitId:j,drawingId:G,transform:{...E,...x},groupId:void 0}});return{parent:C,children:T}},v=()=>{const P=e.getFocusDrawings().map(y=>S(y)).filter(y=>y!=null);P.length!==0&&e.featurePluginUngroupUpdateNotification(P)};return _.useEffect(()=>{const C=s[0];if(C==null)return;const{unitId:P}=C,y=n.getRenderById(P),U=y==null?void 0:y.scene;if(U==null)return;const O=U.getTransformerByCreate(),R=O.clearControl$.subscribe(N=>{N===!0&&o(!1)}),T=O.changeStart$.subscribe(N=>{const{objects:E}=N,B=ge(E,e),j=B.filter(z=>(z==null?void 0:z.drawingType)===h.DrawingTypeEnum.DRAWING_GROUP);let G=!1,x=!1;B.length>1&&(G=!0),j.length>0&&(x=!0),o(G||x),g(G),u(x)});return()=>{T.unsubscribe(),R.unsubscribe()}},[]),l.jsxs("div",{className:I.clsx(m.imageCommonPanelGrid,m.imageCommonPanelBorder),style:{display:f(r===!0?i:!1)},children:[l.jsx("div",{className:m.imageCommonPanelRow,children:l.jsx("div",{className:I.clsx(m.imageCommonPanelColumn,m.imageCommonPanelTitle),children:l.jsx("div",{children:t.t("image-panel.group.title")})})}),l.jsxs("div",{className:m.imageCommonPanelRow,children:[l.jsx("div",{className:I.clsx(m.imageCommonPanelColumn,m.imageCommonPanelSpan2,m.imageCommonPanelColumnCenter),children:l.jsx(I.Button,{size:"small",onClick:()=>{p()},style:{display:f(c)},children:l.jsxs("span",{className:m.imageCommonPanelInline,children:[l.jsx(Re,{}),t.t("image-panel.group.group")]})})}),l.jsx("div",{className:I.clsx(m.imageCommonPanelColumn,m.imageCommonPanelSpan2,m.imageCommonPanelColumnCenter),children:l.jsx(I.Button,{size:"small",onClick:()=>{v()},style:{display:f(d)},children:l.jsxs("span",{className:m.imageCommonPanelInline,children:[l.jsx(Ve,{}),t.t("image-panel.group.unGroup")]})})})]})]})},te=20,un=20,hn=[-3600,3600],pe=300,fn=a=>{var Fe;const t=V.useDependency(h.LocaleService),n=V.useDependency(M.IDrawingManagerService),e=V.useDependency(b.IRenderManagerService),{drawings:r,transformShow:s}=a,i=r[0];if(i==null)return;const o=i.transform;if(o==null)return;const{unitId:c,subUnitId:g,drawingId:d,drawingType:u}=i,f=e.getRenderById(c),p=f==null?void 0:f.scene;if(p==null)return;const S=(Fe=p.getEngine())==null?void 0:Fe.activeScene;if(S==null)return;const v=p.getTransformerByCreate(),{width:C=0,height:P=0,left:y=0,top:U=0,angle:O=0}=o,[R,T]=_.useState(C),[N,E]=_.useState(P),[B,j]=_.useState(y),[G,x]=_.useState(U),[F,z]=_.useState(O),[ce,ae]=_.useState(v.keepRatio),ie=(w,L,W,$)=>{const{width:k,height:Q}=S,{ancestorLeft:Y,ancestorTop:Z}=p;let q=w,se=L,ue=W,he=$;return w+Y<0&&(q=-Y),L+Z<0&&(se=-Z),ue=k-q-Y,ue<te&&(ue=te),he=Q-se-Z,he<te&&(he=te),w+ue+Y>k&&(q=k-W-Y),L+he+Z>Q&&(se=Q-$-Z),{limitLeft:q,limitTop:se,limitWidth:ue,limitHeight:he}},le=w=>{const{objects:L}=w,W=ge(L,n);if(W.length!==1)return;const $=W[0];if($==null)return;const{transform:k}=$;if(k==null)return;const{width:Q,height:Y,left:Z,top:q,angle:se}=k;Q!=null&&T(Q),Y!=null&&E(Y),Z!=null&&j(Z),q!=null&&x(q),se!=null&&z(se)};_.useEffect(()=>{const w=[v.changeStart$.subscribe(L=>{le(L)}),v.changing$.subscribe(L=>{le(L)}),v.changeEnd$.subscribe(L=>{le(L)}),n.focus$.subscribe(L=>{if(L.length!==1)return;const W=n.getDrawingByParam(L[0]);if(W==null)return;const $=W.transform;if($==null)return;const{width:k,height:Q,left:Y,top:Z,angle:q}=$;k!=null&&T(k),Q!=null&&E(Q),Y!=null&&j(Y),Z!=null&&x(Z),q!=null&&z(q)})];return()=>{w.forEach(L=>L.unsubscribe())}},[]);const J=h.debounce(w=>{if(w==null)return;w=Math.max(w,te);const{limitWidth:L,limitHeight:W}=ie(B,G,w,N);w=Math.min(w,L);const $={unitId:c,subUnitId:g,drawingId:d,drawingType:u,transform:{width:w}};if(ce){let k=w/R*N;if(k=Math.max(k,un),k>W)return;E(k),$.transform.height=k}T(w),n.featurePluginUpdateNotification([$]),v.refreshControls().changeNotification()},pe),De=h.debounce(w=>{if(w==null)return;w=Math.max(w,te);const{limitHeight:L,limitWidth:W}=ie(B,G,R,w);w=Math.min(w,L);const $={unitId:c,subUnitId:g,drawingId:d,drawingType:u,transform:{height:w}};if(ce){let k=w/N*R;if(k=Math.max(k,te),k>W)return;T(k),$.transform.width=k}E(w),n.featurePluginUpdateNotification([$]),v.refreshControls().changeNotification()},pe),Tn=h.debounce(w=>{if(w==null)return;const{limitLeft:L}=ie(w,G,R,N);w=L;const W={unitId:c,subUnitId:g,drawingId:d,drawingType:u,transform:{left:w}};j(w),n.featurePluginUpdateNotification([W]),v.refreshControls().changeNotification()},pe),Bn=h.debounce(w=>{if(w==null)return;const{limitTop:L}=ie(B,w,R,N);w=L;const W={unitId:c,subUnitId:g,drawingId:d,drawingType:u,transform:{top:w}};x(w),n.featurePluginUpdateNotification([W]),v.refreshControls().changeNotification()},pe),Un=w=>{if(w==null)return;const[L,W]=hn;w<L&&(w=L),w>W&&(w=W);const $={unitId:c,subUnitId:g,drawingId:d,drawingType:u,transform:{angle:w}};z(w),n.featurePluginUpdateNotification([$]),v.refreshControls().changeNotification()},jn=w=>{ae(w),v.keepRatio=w},An=w=>w?"block":"none";return l.jsxs("div",{className:I.clsx(m.imageCommonPanelGrid,m.imageCommonPanelBorder),style:{display:An(s)},children:[l.jsx("div",{className:m.imageCommonPanelRow,children:l.jsx("div",{className:I.clsx(m.imageCommonPanelColumn,m.imageCommonPanelTitle),children:l.jsx("div",{children:t.t("image-panel.transform.title")})})}),l.jsxs("div",{className:m.imageCommonPanelRow,children:[l.jsx("div",{className:I.clsx(m.imageCommonPanelColumn,m.imageCommonPanelSpan3),children:l.jsxs("label",{children:[l.jsx("div",{className:m.imageCommonPanelRow,children:l.jsx("div",{className:m.imageCommonPanelColumn,children:t.t("image-panel.transform.width")})}),l.jsx("div",{className:m.imageCommonPanelRow,children:l.jsx("div",{className:m.imageCommonPanelColumn,children:l.jsx(I.InputNumber,{precision:1,value:R,onChange:w=>{J(w)},className:m.imageCommonPanelInput})})})]})}),l.jsx("div",{className:I.clsx(m.imageCommonPanelColumn,m.imageCommonPanelSpan3),children:l.jsxs("label",{children:[l.jsx("div",{className:m.imageCommonPanelRow,children:l.jsx("div",{className:m.imageCommonPanelColumn,children:t.t("image-panel.transform.height")})}),l.jsx("div",{className:m.imageCommonPanelRow,children:l.jsx("div",{className:m.imageCommonPanelColumn,children:l.jsx(I.InputNumber,{precision:1,value:N,onChange:w=>{De(w)},className:m.imageCommonPanelInput})})})]})}),l.jsx("div",{className:I.clsx(m.imageCommonPanelColumn,m.imageCommonPanelSpan3),children:l.jsxs("label",{children:[l.jsx("div",{className:m.imageCommonPanelRow,children:l.jsx("div",{className:m.imageCommonPanelColumn,children:t.t("image-panel.transform.lock")})}),l.jsx("div",{className:I.clsx(m.imageCommonPanelRow,m.imageCommonPanelRowVertical),children:l.jsx("div",{className:m.imageCommonPanelColumn,children:l.jsx(I.Checkbox,{checked:ce,onChange:jn})})})]})})]}),l.jsxs("div",{className:m.imageCommonPanelRow,children:[l.jsx("div",{className:I.clsx(m.imageCommonPanelColumn,m.imageCommonPanelSpan3),children:l.jsxs("label",{children:[l.jsx("div",{className:m.imageCommonPanelRow,children:l.jsx("div",{className:m.imageCommonPanelColumn,children:t.t("image-panel.transform.x")})}),l.jsx("div",{className:m.imageCommonPanelRow,children:l.jsx("div",{className:m.imageCommonPanelColumn,children:l.jsx(I.InputNumber,{precision:1,value:B,onChange:w=>{Tn(w)},className:m.imageCommonPanelInput})})})]})}),l.jsx("div",{className:I.clsx(m.imageCommonPanelColumn,m.imageCommonPanelSpan3),children:l.jsxs("label",{children:[l.jsx("div",{className:m.imageCommonPanelRow,children:l.jsx("div",{className:m.imageCommonPanelColumn,children:t.t("image-panel.transform.y")})}),l.jsx("div",{className:m.imageCommonPanelRow,children:l.jsx("div",{className:m.imageCommonPanelColumn,children:l.jsx(I.InputNumber,{precision:1,value:G,onChange:w=>{Bn(w)},className:m.imageCommonPanelInput})})})]})}),l.jsx("div",{className:I.clsx(m.imageCommonPanelColumn,m.imageCommonPanelSpan3),children:l.jsxs("label",{children:[l.jsx("div",{className:m.imageCommonPanelRow,children:l.jsx("div",{className:m.imageCommonPanelColumn,children:t.t("image-panel.transform.rotate")})}),l.jsx("div",{className:m.imageCommonPanelRow,children:l.jsx("div",{className:m.imageCommonPanelColumn,children:l.jsx(I.InputNumber,{precision:1,value:F,onChange:Un,className:m.imageCommonPanelInput})})})]})})]})]})},Ce={id:"sheet.operation.open-image-crop",type:h.CommandType.OPERATION,handler:(a,t)=>!0},ne={id:"sheet.operation.close-image-crop",type:h.CommandType.OPERATION,handler:(a,t)=>!0};var H=(a=>(a.FREE="0",a.R1_1="1",a.R16_9="2",a.R9_16="3",a.R5_4="4",a.R4_5="5",a.R4_3="6",a.R3_4="7",a.R3_2="8",a.R2_3="9",a))(H||{});const me={id:"sheet.operation.Auto-image-crop",type:h.CommandType.OPERATION,handler:(a,t)=>!0},pn=a=>{const t=V.useDependency(h.ICommandService),n=V.useDependency(h.LocaleService),{drawings:e,cropperShow:r}=a;if(e[0]==null)return;const[i,o]=_.useState(H.FREE),c=_.useRef(!1),g=[{label:n.t("image-panel.crop.mode"),value:H.FREE},{label:"1:1",value:H.R1_1},{label:"16:9",value:H.R16_9},{label:"9:16",value:H.R9_16},{label:"5:4",value:H.R5_4},{label:"4:5",value:H.R4_5},{label:"4:3",value:H.R4_3},{label:"3:4",value:H.R3_4},{label:"3:2",value:H.R3_2},{label:"2:3",value:H.R2_3}];_.useEffect(()=>{const p=t.onCommandExecuted(S=>{if(S.id===ne.id){const v=S.params;v!=null&&v.isAuto||(c.current=!1)}});return()=>{p==null||p.dispose()}},[]);function d(p){o(p),c.current&&t.executeCommand(me.id,{cropType:p})}const u=p=>p?"block":"none",f=p=>{t.executeCommand(me.id,{cropType:p}),c.current=!0};return l.jsxs("div",{className:I.clsx(m.imageCommonPanelGrid,m.imageCommonPanelBorder),style:{display:u(r)},children:[l.jsx("div",{className:m.imageCommonPanelRow,children:l.jsx("div",{className:I.clsx(m.imageCommonPanelColumn,m.imageCommonPanelTitle),children:l.jsx("div",{children:n.t("image-panel.crop.title")})})}),l.jsxs("div",{className:I.clsx(m.imageCommonPanelRow,m.imageCommonPanelRowVertical),children:[l.jsx("div",{className:I.clsx(m.imageCommonPanelColumn,m.imageCommonPanelSpan2),children:l.jsx(I.Button,{size:"small",onClick:()=>{f(i)},children:l.jsxs("span",{className:m.imageCommonPanelInline,children:[l.jsx(Ae,{}),n.t("image-panel.crop.start")]})})}),l.jsx("div",{className:I.clsx(m.imageCommonPanelColumn,m.imageCommonPanelSpan2),children:l.jsx(I.Select,{value:i,options:g,onChange:d})})]})]})},Cn=a=>{const t=V.useDependency(M.IDrawingManagerService),n=V.useDependency(b.IRenderManagerService),e=V.useDependency(h.LocaleService),{drawings:r,hasArrange:s=!0,hasTransform:i=!0,hasAlign:o=!0,hasCropper:c=!0,hasGroup:g=!0}=a,d=r[0];if(d==null)return;const{unitId:u}=d,f=n.getRenderById(u),p=f==null?void 0:f.scene;if(p==null)return;const S=p.getTransformerByCreate(),[v,C]=_.useState(!0),[P,y]=_.useState(!0),[U,O]=_.useState(!1),[R,T]=_.useState(!0),[N,E]=_.useState(!1);return _.useEffect(()=>{const B=S.clearControl$.subscribe(x=>{x===!0&&(C(!1),y(!1),O(!1),T(!1),E(!0))}),j=S.changeStart$.subscribe(x=>{const{objects:F}=x,z=ge(F,t);z.length===0?(C(!1),y(!1),O(!1),T(!1),E(!0)):z.length===1?(C(!0),y(!0),O(!1),T(!0),E(!1)):(C(!0),y(!1),O(!0),T(!1),E(!1))}),G=t.focus$.subscribe(x=>{x.length===0?(C(!1),y(!1),O(!1),T(!1),E(!0)):x.length===1?(C(!0),y(!0),O(!1),T(!0),E(!1)):(C(!0),y(!1),O(!0),T(!1),E(!1))});return()=>{j.unsubscribe(),B.unsubscribe(),G.unsubscribe()}},[]),l.jsxs(l.Fragment,{children:[l.jsx("div",{style:{display:N===!0?"block":"none",height:"100%"},children:l.jsx("div",{style:{display:"flex",justifyContent:"center",alignItems:"center",height:"100%",top:"50%",marginTop:"-100px"},children:l.jsx("span",{children:e.t("image-panel.null")})})}),l.jsx(mn,{arrangeShow:s===!0?v:!1,drawings:r}),l.jsx(fn,{transformShow:i===!0?P:!1,drawings:r}),l.jsx(Xe,{alignShow:o===!0?U:!1,drawings:r}),l.jsx(pn,{cropperShow:c===!0?R:!1,drawings:r}),l.jsx(dn,{hasGroup:g,drawings:r})]})},ke=a=>{var v;const{popup:t}=a,n=(v=t==null?void 0:t.extraProps)==null?void 0:v.menuItems;if(!n)return null;const e=V.useDependency(h.ICommandService),r=V.useDependency(h.LocaleService),[s,i]=_.useState(!1),[o,c]=_.useState(!1),g=()=>{c(!0)},d=()=>{c(!1)},u=C=>{i(C)},f=C=>{e.executeCommand(C.commandId,C.commandParams),i(!1)},p=s||o,S=n.filter(C=>!C.disable);return l.jsx("div",{onMouseEnter:g,onMouseLeave:d,children:l.jsx(I.DropdownMenu,{align:"start",items:S.map(C=>({type:"item",children:r.t(C.label),onSelect:()=>f(C)})),open:s,onOpenChange:u,children:l.jsxs("div",{className:I.clsx(`
                      univer-flex univer-items-center univer-gap-2 univer-rounded univer-border univer-border-solid
                      univer-border-gray-200 univer-p-1
                      hover:univer-bg-gray-100
                    `,{"univer-bg-gray-100":s,"univer-bg-white":!s}),children:[l.jsx(Ue,{style:{color:"#35322B"},extend:{colorChannel1:"rgb(var(--green-700, #409f11))"}}),p&&l.jsx(Le,{className:"univer-text-[10px] univer-text-gray-400"})]})})})},We="COMPONENT_IMAGE_POPUP_MENU",wn="drawing-ui.config",$e={},be={id:"sheet.operation.image-reset-size",type:h.CommandType.OPERATION,handler:(a,t)=>!0},vn=a=>{const{src:t}=a;return t?l.jsx("div",{children:l.jsx("img",{src:t,alt:"Univer Image Viewer",style:{width:"100%",height:"100%",position:"relative"}})}):null};var Sn=Object.getOwnPropertyDescriptor,_n=(a,t,n,e)=>{for(var r=e>1?void 0:e?Sn(t,n):t,s=a.length-1,i;s>=0;s--)(i=a[s])&&(r=i(r)||r);return r},ze=(a,t)=>(n,e)=>t(n,e,a);let we=class extends h.Disposable{constructor(a,t){super(),this._componentManager=a,this._commandService=t,this._init()}_initCustomComponents(){const a=this._componentManager;this.disposeWithMe(a.register(We,ke)),this.disposeWithMe(a.register(Ee,vn))}_initCommands(){[Ce,ne,be,fe,me].forEach(a=>this.disposeWithMe(this._commandService.registerCommand(a)))}_init(){this._initCommands(),this._initCustomComponents()}};we=_n([ze(0,h.Inject(V.ComponentManager)),ze(1,h.ICommandService)],we);var In=Object.getOwnPropertyDescriptor,yn=(a,t,n,e)=>{for(var r=e>1?void 0:e?In(t,n):t,s=a.length-1,i;s>=0;s--)(i=a[s])&&(r=i(r)||r);return r},ve=(a,t)=>(n,e)=>t(n,e,a);let Se=class extends h.Disposable{constructor(t,n,e,r){super();ee(this,"_sceneListenerOnDrawingMap",new WeakSet);this._currentUniverService=t,this._commandService=n,this._renderManagerService=e,this._drawingManagerService=r,this._initialize()}dispose(){super.dispose()}_initialize(){this._recoveryImages(),this._drawingAddListener(),this._drawingRemoveListener(),this._drawingUpdateListener(),this._commandExecutedListener(),this._drawingArrangeListener(),this._drawingGroupListener(),this._drawingRefreshListener(),this._drawingVisibleListener()}_recoveryImages(){const t=this._drawingManagerService.drawingManagerData,n=Ne(this._currentUniverService);if(n==null)return;const{unitId:e,subUnitId:r}=n;Object.keys(t).forEach(s=>{Object.keys(t[s]).forEach(i=>{const o=t[s][i].data;o==null||s!==e||i!==r||Object.keys(o).forEach(c=>{o[c]&&this._insertDrawing([{unitId:s,subUnitId:i,drawingId:c}])})})})}_commandExecutedListener(){this.disposeWithMe(this._commandService.onCommandExecuted(t=>{if(t.id===fe.id){const n=t.params;if(n==null)return;this._drawingAlign(n)}}))}_drawingGroupListener(){this.disposeWithMe(this._drawingManagerService.group$.subscribe(t=>{this._groupDrawings(t)})),this.disposeWithMe(this._drawingManagerService.ungroup$.subscribe(t=>{this._ungroupDrawings(t)}))}_getSceneAndTransformerByDrawingSearch(t){if(t==null)return;const n=this._renderManagerService.getRenderById(t),e=n==null?void 0:n.scene;if(e==null)return null;const r=e.getTransformerByCreate();return{scene:e,transformer:r}}_groupDrawings(t){t.forEach(n=>{this._groupDrawing(n)})}_groupDrawing(t){const{parent:n,children:e}=t,{unitId:r,subUnitId:s,drawingId:i}=n,o=this._getSceneAndTransformerByDrawingSearch(n.unitId);if(o==null)return;const{scene:c,transformer:g}=o;this._commandService.syncExecuteCommand(ne.id);const d=[];if(e.forEach(p=>{const S=M.getDrawingShapeKeyByDrawingSearch(p),v=c.getObjectIncludeInGroup(S);if(v==null||d.includes(v))return;d.push(v);const{transform:C}=p;C!=null&&(v.classType===b.RENDER_CLASS_TYPE.GROUP?v.transformByState({left:C.left,top:C.top}):v.transformByState(C))}),d.length===0)return;const u=M.getDrawingShapeKeyByDrawingSearch({unitId:r,subUnitId:s,drawingId:i}),f=new b.Group(u);c.addObject(f,b.DRAWING_OBJECT_LAYER_INDEX).attachTransformerTo(f),f.addObjects(...d),n.transform&&f.transformByState({left:n.transform.left,top:n.transform.top}),g.clearSelectedObjects(),g.setSelectedControl(f)}_ungroupDrawings(t){t.forEach(n=>{this._ungroupDrawing(n)})}_ungroupDrawing(t){const{parent:n,children:e}=t,r=this._getSceneAndTransformerByDrawingSearch(n.unitId);if(r==null)return;const{scene:s,transformer:i}=r;e.forEach(u=>{const f=M.getDrawingShapeKeyByDrawingSearch(u),p=s.getObjectIncludeInGroup(f);if(p==null)return!0;if(p==null)return;const{transform:S}=u;S!=null&&(p.classType===b.RENDER_CLASS_TYPE.GROUP?p.transformByState({left:S.left,top:S.top}):p.transformByState(S))});const o=M.getDrawingShapeKeyByDrawingSearch(n),c=s.getObject(o),{width:g,height:d}=c;c.getObjects().forEach(u=>{c.removeSelfObjectAndTransform(u.oKey,g,d)}),c.dispose(),i.clearSelectedObjects()}_drawingAlign(t){const{alignType:n}=t,e=this._drawingManagerService.getFocusDrawings();if(n===A.default)return;const r=[];let s=Number.POSITIVE_INFINITY,i=Number.POSITIVE_INFINITY,o=Number.NEGATIVE_INFINITY,c=Number.NEGATIVE_INFINITY,g=0;e.forEach(d=>{const{unitId:u,subUnitId:f,drawingId:p,drawingType:S}=d,v=this._drawingManagerService.getDrawingByParam({unitId:u,subUnitId:f,drawingId:p});if(v==null||v.transform==null)return;r.push({unitId:u,subUnitId:f,drawingId:p,drawingType:S,transform:v.transform});const{left:C=0,top:P=0,width:y=0,height:U=0}=v.transform;s=Math.min(s,C),i=Math.min(i,P),o=Math.max(o,C+y),c=Math.max(c,P+U),g++}),g!==0&&(this._sortDrawingTransform(r,n),this._applyAlignType(r,n,s,i,o,c,g))}_applyAlignType(t,n,e,r,s,i,o){const c=Math.round((s-e)/o*10)/10,g=Math.round((i-r)/o*10)/10,d=[],u=this._getSceneAndTransformerByDrawingSearch(t[0].unitId);if(u==null)return;const{scene:f,transformer:p}=u;t.forEach((S,v)=>{const{unitId:C,subUnitId:P,drawingId:y,transform:U,drawingType:O}=S,{left:R=0,top:T=0,width:N=0,height:E=0}=U;let B=R,j=T;switch(n){case A.left:B=e;break;case A.center:B=e+(s-e)/2-N/2;break;case A.right:B=s-N;break;case A.top:j=r;break;case A.middle:j=r+(i-r)/2-E/2;break;case A.bottom:j=i-E;break;case A.horizon:B=e+c*v;break;case A.vertical:j=r+g*v;break}(B!==R||j!==T)&&d.push({unitId:C,subUnitId:P,drawingId:y,drawingType:O,transform:{left:B,top:j}})}),this._drawingManagerService.featurePluginUpdateNotification(d),p.refreshControls().changeNotification()}_sortDrawingTransform(t,n){t.sort((e,r)=>{const s=e.transform,i=r.transform,{left:o=0,top:c=0,width:g=0,height:d=0}=s,{left:u=0,top:f=0,width:p=0,height:S=0}=i;switch(n){case A.left:return o-u;case A.center:return o+g/2-(u+p/2);case A.right:return o+g-(u+p);case A.top:return c-f;case A.middle:return c+d/2-(f+S/2);case A.bottom:return c+d-(f+S);case A.horizon:return o+g/2-(u+p/2);case A.vertical:return c+d/2-(f+S/2);default:return 0}})}_drawingArrangeListener(){this.disposeWithMe(this._drawingManagerService.order$.subscribe(t=>{this._drawingArrange(t)}))}_drawingArrange(t){const{unitId:n,subUnitId:e,drawingIds:r}=t,s=this._getSceneAndTransformerByDrawingSearch(n);if(s==null)return;const{scene:i}=s;r.forEach(o=>{const c=M.getDrawingShapeKeyByDrawingSearch({unitId:n,subUnitId:e,drawingId:o}),g=i.fuzzyMathObjects(c,!0);if(g==null||g.length===0)return;const d=this._drawingManagerService.getDrawingOrder(n,e).indexOf(o);for(const u of g)u.setProps({zIndex:d}),u.makeDirty()})}_drawingAddListener(){this.disposeWithMe(this._drawingManagerService.add$.subscribe(t=>{this._insertDrawing(t)}))}_insertDrawing(t){const n=[];t.forEach(e=>{const{unitId:r}=e;if(this._drawingManagerService.getDrawingByParam(e)==null)return;const i=this._getSceneAndTransformerByDrawingSearch(r);if(i==null)return;const{scene:o}=i;n.includes(o)||n.push(o)}),n.forEach(e=>{this._sceneListenerOnDrawingMap.has(e)||(this._addListenerOnDrawing(e),this._sceneListenerOnDrawingMap.add(e))})}_drawingRemoveListener(){this.disposeWithMe(this._drawingManagerService.remove$.subscribe(t=>{t.forEach(n=>{var d;const{unitId:e,subUnitId:r,drawingId:s}=n,i=this._getSceneAndTransformerByDrawingSearch(e);if(i==null)return;const{scene:o}=i,c=M.getDrawingShapeKeyByDrawingSearch({unitId:e,subUnitId:r,drawingId:s}),g=o.fuzzyMathObjects(c,!0);if(g.length>0){for(const u of g)u.dispose();(d=o.getTransformer())==null||d.clearSelectedObjects()}})}))}_drawingUpdateListener(){this.disposeWithMe(this._drawingManagerService.update$.subscribe(t=>{t.forEach(n=>{var N;const{unitId:e,subUnitId:r,drawingId:s}=n,i=this._drawingManagerService.getDrawingByParam(n);if(i==null)return;const{transform:o,drawingType:c}=i,g=this._getSceneAndTransformerByDrawingSearch(e);if(g==null)return;const{scene:d,transformer:u}=g;if(o==null)return!0;const{left:f=0,top:p=0,width:S=0,height:v=0,angle:C=0,flipX:P=!1,flipY:y=!1,skewX:U=0,skewY:O=0}=o,R=M.getDrawingShapeKeyByDrawingSearch({unitId:e,subUnitId:r,drawingId:s}),T=d.getObject(R);if(T==null)return!0;T.transformByState({left:f,top:p,width:S,height:v,angle:C,flipX:P,flipY:y,skewX:U,skewY:O}),(N=d.getTransformer())==null||N.debounceRefreshControls()})}))}_drawingRefreshListener(){this.disposeWithMe(this._drawingManagerService.refreshTransform$.subscribe(t=>{t.forEach(n=>{const{unitId:e,subUnitId:r,drawingId:s}=n,i=this._getSceneAndTransformerByDrawingSearch(e);if(i==null)return;const o=this._drawingManagerService.getDrawingByParam(n);if(o==null)return;const{transform:c}=o,{scene:g}=i,d=M.getDrawingShapeKeyByDrawingSearch({unitId:e,subUnitId:r,drawingId:s}),u=g.getObject(d);if(u==null||c==null)return!0;const{left:f=0,top:p=0,width:S=0,height:v=0,angle:C=0,flipX:P=!1,flipY:y=!1,skewX:U=0,skewY:O=0}=c;u.transformByState({left:f,top:p,width:S,height:v,angle:C,flipX:P,flipY:y,skewX:U,skewY:O})})}))}_drawingVisibleListener(){this.disposeWithMe(this._drawingManagerService.visible$.subscribe(t=>{t.forEach(n=>{const{unitId:e,subUnitId:r,drawingId:s,visible:i}=n,o=this._getSceneAndTransformerByDrawingSearch(e);if(o==null)return;const{scene:c}=o,g=M.getDrawingShapeKeyByDrawingSearch({unitId:e,subUnitId:r,drawingId:s}),d=c.getObject(g);if(d==null)return!0;i?d.show():d.hide()})}))}_filterUpdateParams(t,n){return t.filter((e,r)=>{if(e==null)return!1;const{transform:s}=e;return h.checkIfMove(s,n==null?void 0:n[r])})}_addListenerOnDrawing(t){const n=t.getTransformerByCreate();let e=null;this.disposeWithMe(h.toDisposable(n.changeStart$.subscribe(r=>{const{objects:s}=r,i=Array.from(s.values()),o=[];e=i.map(c=>{const{left:g,top:d,height:u,width:f,angle:p,oKey:S,isInGroup:v}=c,C=this._drawingManagerService.getDrawingOKey(S);if(v||c instanceof b.Group){let P=c.ancestorGroup;if(P==null&&c instanceof b.Group&&(P=c),P==null)return null;const y=this._drawingManagerService.getDrawingOKey(P.oKey);if(y){const{unitId:U,subUnitId:O,drawingId:R}=y;o.push({unitId:U,subUnitId:O,drawingId:R});const{left:T,top:N,height:E,width:B,angle:j}=P;return{left:T,top:N,height:E,width:B,angle:j}}}else if(C!=null){const{unitId:P,subUnitId:y,drawingId:U}=C;return o.push({unitId:P,subUnitId:y,drawingId:U}),{left:g,top:d,height:u,width:f,angle:p}}return null}).filter(c=>c!=null),o.length>0?this._commandService.syncExecuteCommand(M.SetDrawingSelectedOperation.id,o):this._commandService.syncExecuteCommand(M.SetDrawingSelectedOperation.id,[])}))),this.disposeWithMe(h.toDisposable(n.changeEnd$.subscribe(r=>{const{objects:s}=r,i=this._filterUpdateParams(ge(s,this._drawingManagerService),e);i.length>0&&this._drawingManagerService.featurePluginUpdateNotification(i)})))}};Se=yn([ve(0,h.IUniverInstanceService),ve(1,h.ICommandService),ve(2,b.IRenderManagerService),ve(3,M.IDrawingManagerService)],Se);class de extends b.Shape{constructor(n,e){e==null&&(e={}),e.transformerConfig={keepRatio:!1,isCropper:!0,anchorFill:"rgb(0, 0, 0)",anchorStroke:"rgb(255, 255, 255)",anchorSize:24};super(n,e);ee(this,"_srcRect");ee(this,"_prstGeom");ee(this,"_applyTransform");ee(this,"_dragPadding",8);ee(this,"_cacheCanvas");e!=null&&e.srcRect&&(this._srcRect=e.srcRect),e!=null&&e.prstGeom&&(this._prstGeom=e.prstGeom),e!=null&&e.applyTransform&&(this._applyTransform=e.applyTransform),e!=null&&e.dragPadding&&(this._dragPadding=e.dragPadding),this._applyProps()}refreshSrcRect(n,e){this._srcRect=n,this._applyTransform=e,this._applyProps()}get srcRect(){return this._srcRect}dispose(){var n;super.dispose(),(n=this._cacheCanvas)==null||n.dispose(),this._srcRect=null}isHit(n){const e=this.getInverseCoord(n);return e.x>=-this.strokeWidth/2&&e.x<=this.width+this.strokeWidth/2&&e.y>=-this.strokeWidth/2&&e.y<=this.height+this.strokeWidth/2&&!this._inSurround(e)}_inSurround(n){const e=this._dragPadding;return n.x>=e-this.strokeWidth/2&&n.x<=this.width+this.strokeWidth/2-e&&n.y>=e-this.strokeWidth/2&&n.y<=this.height+this.strokeWidth/2-e}render(n,e){return this.visible?(n.save(),this._draw(n),n.restore(),this.makeDirty(!1),this):(this.makeDirty(!1),this)}_draw(n){var c,g;const r=this.getScene().getEngine(),{width:s,height:i}=r;this._initialCacheCanvas(),(c=this._cacheCanvas)==null||c.clear();const o=(g=this._cacheCanvas)==null?void 0:g.getContext();o!=null&&(o.save(),b.Rect.drawWith(o,{left:0,top:0,width:s,height:i,fill:"rgba(0, 0, 0, 0.5)"}),o.setTransform(n.getTransform()),this._clipForApplyObject(o),this._applyCache(n),o.restore())}_clipForApplyObject(n){let e=0;if(this._prstGeom!=null&&(e=1),n.globalCompositeOperation="destination-out",n.beginPath(),e===0){const r=this.transform.getMatrix();n.transform(r[0],r[1],r[2],r[3],r[4],r[5]),n.rect(0,0,this.width,this.height),n.fill()}}_applyProps(){if(this._applyTransform==null)return;let n=0,e=0,r=0,s=0;const{left:i=0,top:o=0,width:c=0,height:g=0,angle:d}=this._applyTransform;if(this._srcRect!=null){const{left:p=0,top:S=0,right:v=0,bottom:C=0}=this._srcRect;n=p,e=S,r=v,s=C}const u=i+n,f=o+e;this.transformByState({left:u,top:f,width:i+c-r-u,height:o+g-s-f,angle:d})}_applyCache(n){if(!n||this._cacheCanvas==null)return;const e=this._cacheCanvas.getContext();e.save(),n.save(),n.setTransform(1,0,0,1,0,0),e.setTransform(1,0,0,1,0,0),n.drawImage(this._cacheCanvas.getCanvasEle(),0,0),n.restore(),e.restore()}_initialCacheCanvas(){if(this._cacheCanvas!=null)return;const n=this.getScene();if(n==null)return;this._cacheCanvas=new b.Canvas;const e=n.getEngine();this._cacheCanvas.setSize(e.width,e.height),e.onTransformChange$.subscribeEvent(()=>{var r;(r=this._cacheCanvas)==null||r.setSize(e.width,e.height),this.makeDirty(!0)})}}var bn=Object.getOwnPropertyDescriptor,Pn=(a,t,n,e)=>{for(var r=e>1?void 0:e?bn(t,n):t,s=a.length-1,i;s>=0;s--)(i=a[s])&&(r=i(r)||r);return r},oe=(a,t)=>(n,e)=>t(n,e,a);let _e=class extends h.Disposable{constructor(t,n,e,r,s,i){super();ee(this,"_sceneListenerOnImageMap",new WeakSet);this._commandService=t,this._drawingManagerService=n,this._renderManagerService=e,this._univerInstanceService=r,this._messageService=s,this._localeService=i,this._init()}_init(){this._initOpenCrop(),this._initCloseCrop(),this._initAutoCrop()}_initAutoCrop(){this.disposeWithMe(this._commandService.onCommandExecuted(t=>{if(t.id!==me.id)return;const n=t.params;if(n==null)return;const{cropType:e}=n,r=this._drawingManagerService.getFocusDrawings();if(r.length!==1)return;const s=r[0],{unitId:i,subUnitId:o,drawingId:c}=s,g=this._renderManagerService.getRenderById(i),d=g==null?void 0:g.scene;if(d==null)return!0;this._searchCropObject(d)!=null&&this._commandService.syncExecuteCommand(ne.id,{isAuto:!0});const f=M.getDrawingShapeKeyByDrawingSearch({unitId:i,subUnitId:o,drawingId:c}),p=d.getObject(f);if(!(p instanceof b.Image)){this._messageService.show({type:I.MessageType.Error,content:this._localeService.t("image-cropper.error")});return}p!=null&&(this._updateCropperObject(e,p),this._commandService.executeCommand(Ce.id,{unitId:i,subUnitId:o,drawingId:c}))}))}_calculateSrcRectByRatio(t,n,e,r,s,i){const o=e/r,c=s/i;let g=e,d=r;o>c?g=r*c:d=e/c;const u=(e-g)/2,f=(r-d)/2;return{left:b.precisionTo(u,1),top:b.precisionTo(f,1),right:b.precisionTo(e-(u+g),1),bottom:b.precisionTo(r-(f+d),1)}}_updateCropperObject(t,n){const{left:e,top:r,width:s,height:i}=n.calculateTransformWithSrcRect();let o;switch(t){case H.R1_1:o=this._calculateSrcRectByRatio(e,r,s,i,1,1);break;case H.R16_9:o=this._calculateSrcRectByRatio(e,r,s,i,16,9);break;case H.R9_16:o=this._calculateSrcRectByRatio(e,r,s,i,9,16);break;case H.R5_4:o=this._calculateSrcRectByRatio(e,r,s,i,5,4);break;case H.R4_5:o=this._calculateSrcRectByRatio(e,r,s,i,4,5);break;case H.R4_3:o=this._calculateSrcRectByRatio(e,r,s,i,4,3);break;case H.R3_4:o=this._calculateSrcRectByRatio(e,r,s,i,3,4);break;case H.R3_2:o=this._calculateSrcRectByRatio(e,r,s,i,3,2);break;case H.R2_3:o=this._calculateSrcRectByRatio(e,r,s,i,2,3);break;case H.FREE:}if(o==null)return;n.setSrcRect(o);const{left:c=0,top:g=0,bottom:d=0,right:u=0}=o;n.transformByStateCloseCropper({left:e+c,top:r+g,width:s-u-c,height:i-d-g})}_initOpenCrop(){this.disposeWithMe(this._commandService.onCommandExecuted(t=>{if(t.id!==Ce.id)return;const n=t.params;if(n==null)return;const{unitId:e,subUnitId:r,drawingId:s}=n,i=this._renderManagerService.getRenderById(e),o=i==null?void 0:i.scene;if(o==null)return!0;if(this._sceneListenerOnImageMap.has(o)||(this._addListenerOnImage(o),this._sceneListenerOnImageMap.add(o)),this._drawingManagerService.getDrawingByParam({unitId:e,subUnitId:r,drawingId:s})==null)return;const g=M.getDrawingShapeKeyByDrawingSearch({unitId:e,subUnitId:r,drawingId:s}),d=o.getObject(g);if(d==null)return;if(!(d instanceof b.Image)){this._messageService.show({type:I.MessageType.Error,content:this._localeService.t("image-cropper.error")});return}const u=o.getTransformer();u==null||u.clearControls();const f=new de(`${g}-crop`,{srcRect:d.srcRect,prstGeom:d.prstGeom,applyTransform:d.calculateTransformWithSrcRect()});o.addObject(f,d.getLayerIndex()+1).attachTransformerTo(f),u==null||u.createControlForCopper(f),this._addHoverForImageCopper(f),d.openRenderByCropper(),u==null||u.refreshControls(),f.makeDirty(!0),this._commandService.syncExecuteCommand(M.SetDrawingSelectedOperation.id,[{unitId:e,subUnitId:r,drawingId:s}])}))}_searchCropObject(t){const n=t.getAllObjectsByOrder();for(const e of n)if(e instanceof de)return e}_initCloseCrop(){this.disposeWithMe(this._commandService.onCommandExecuted(n=>{if(n.id!==ne.id)return;const e=this._univerInstanceService.getFocusedUnit();if(e==null)return;const r=e.getUnitId(),s=this._renderManagerService.getRenderById(r),i=s==null?void 0:s.scene;if(i==null)return!0;const o=this._searchCropObject(i);if(o==null)return;const c=this._getApplyObjectByCropObject(o);if(c==null)return;const g=i.getTransformerByCreate();g.detachFrom(o),g.clearCopperControl();const d=this._getSrcRectByTransformState(c,o),u=this._drawingManagerService.getDrawingOKey(c.oKey);if(u!=null){const{left:f,top:p,height:S,width:v}=o;this._drawingManagerService.featurePluginUpdateNotification([{...u,transform:{...u.transform,left:f,top:p,height:S,width:v},srcRect:d.srcRectAngle}])}c.setSrcRect({...d.srcRectAngle}),c.closeRenderByCropper(),c.makeDirty(!0),o==null||o.dispose()}));const t=this._univerInstanceService.getCurrentTypeOfUnit$(h.UniverInstanceType.UNIVER_SHEET).pipe(Me.switchMap(n=>n?n.activeSheet$:Me.of(null)));this.disposeWithMe(t.subscribe(()=>{this._commandService.syncExecuteCommand(ne.id)}))}_getApplyObjectByCropObject(t){const n=t.oKey,e=n.slice(0,n.length-5),r=t.getScene();if(!r)return null;const s=r.getObject(e);return s==null?null:s}_addListenerOnImage(t){const n=t.getTransformerByCreate();let e=null;this.disposeWithMe(n.changeStart$.subscribe(r=>{const{objects:s}=r,i=s.values().next().value;if(i==null||!(i instanceof de))return;const{left:o,top:c,height:g,width:d,angle:u}=i;e={left:o,top:c,height:g,width:d,angle:u},n.clearCopperControl()})),this.disposeWithMe(n.changeEnd$.subscribe(r=>{const{objects:s}=r,i=s.values().next().value;if(i==null||!(i instanceof de))return;const{left:o,top:c,height:g,width:d,angle:u}=i;if(!h.checkIfMove({left:o,top:c,height:g,width:d,angle:u},e))return;const f=this._getApplyObjectByCropObject(i);if(f==null)return;const p=this._getSrcRectByTransformState(f,i);i.refreshSrcRect(p.srcRect,f.getState()),n.createControlForCopper(i)})),this._endCropListener(t)}_addHoverForImageCopper(t){this.disposeWithMe(t.onPointerEnter$.subscribeEvent(()=>{t.cursor=b.CURSOR_TYPE.MOVE})),this.disposeWithMe(t.onPointerLeave$.subscribeEvent(()=>{t.cursor=b.CURSOR_TYPE.DEFAULT}))}_endCropListener(t){const n=t.getTransformerByCreate();this.disposeWithMe(n.clearControl$.subscribe(e=>{e===!0&&this._commandService.syncExecuteCommand(ne.id)}))}_getSrcRectByTransformState(t,n){const{left:e,top:r,height:s,width:i,strokeWidth:o,angle:c}=n,{left:g,top:d,width:u,height:f,angle:p,strokeWidth:S}=t,v=e-g,C=r-d,P={left:v,top:C,right:u-v-i,bottom:f-C-s},y={...P};if(p!==0){const U=e+i/2,O=r+s/2,R=new b.Vector2(U,O),T=u/2+g,N=f/2+d,E=new b.Vector2(T,N),B=new b.Vector2(g,d);B.rotateByPoint(b.degToRad(p),E);const j=B.clone();j.rotateByPoint(b.degToRad(-p),R);const G=e-j.x,x=r-j.y;y.left=G,y.top=x,y.right=u-G-i,y.bottom=f-x-s}return{srcRect:P,srcRectAngle:y}}};_e=Pn([oe(0,h.ICommandService),oe(1,M.IDrawingManagerService),oe(2,b.IRenderManagerService),oe(3,h.IUniverInstanceService),oe(4,V.IMessageService),oe(5,h.Inject(h.LocaleService))],_e);var Dn=Object.getOwnPropertyDescriptor,Mn=(a,t,n,e)=>{for(var r=e>1?void 0:e?Dn(t,n):t,s=a.length-1,i;s>=0;s--)(i=a[s])&&(r=i(r)||r);return r},re=(a,t)=>(n,e)=>t(n,e,a);let Ie=class extends h.Disposable{constructor(a,t,n,e,r,s,i){super(),this._commandService=a,this._renderManagerService=t,this._drawingManagerService=n,this._dialogService=e,this._imageIoService=r,this._currentUniverService=s,this._drawingRenderService=i,this._initialize()}dispose(){super.dispose()}_initialize(){this._drawingAddListener(),this._commandExecutedListener(),this._imageUpdateListener()}_commandExecutedListener(){this.disposeWithMe(this._commandService.onCommandExecuted(a=>{if(a.id===be.id){const t=a.params;if(t==null)return;this._resetImageSize(t)}}))}_getSceneAndTransformerByDrawingSearch(a){if(a==null)return;const t=this._renderManagerService.getRenderById(a),n=t==null?void 0:t.scene;if(n==null)return null;const e=n.getTransformerByCreate();return{scene:n,transformer:e}}_resetImageSize(a){const t=[],n=[];a.forEach(e=>{const{unitId:r,subUnitId:s,drawingId:i}=e,o=this._getSceneAndTransformerByDrawingSearch(r);if(o==null)return;const{scene:c}=o,g=M.getDrawingShapeKeyByDrawingSearch({unitId:r,subUnitId:s,drawingId:i}),d=c.getObject(g);if(d==null)return!0;const u=this._drawingManagerService.getDrawingByParam(e);if(u==null)return!0;if(u.drawingType!==h.DrawingTypeEnum.DRAWING_IMAGE)return;d.resetSize();const{width:f,height:p}=d.getNativeSize();n.includes(c)===!1&&n.push(c),t.push({...u,transform:{...u.transform,height:p,width:f,angle:0},srcRect:null,prstGeom:null})}),this._drawingManagerService.featurePluginUpdateNotification(t),n.forEach(e=>{e.getTransformerByCreate().refreshControls().changeNotification()}),this._commandService.syncExecuteCommand(M.SetDrawingSelectedOperation.id,a)}_drawingAddListener(){this.disposeWithMe(this._drawingManagerService.add$.subscribe(a=>{this._insertImages(a)}))}_insertImages(a){a.forEach(async t=>{var c;const{unitId:n,subUnitId:e}=t,r=this._getSceneAndTransformerByDrawingSearch(n),s=(c=Ne(this._currentUniverService,n))==null?void 0:c.subUnitId;if(r==null||s!==e)return;const i=this._drawingManagerService.getDrawingByParam(t);if(i==null)return;const o=await this._drawingRenderService.renderImages(i,r.scene);if(!(o==null||o.length===0))for(const g of o)this._addHoverForImage(g),this._addDialogForImage(g)})}_imageUpdateListener(){this.disposeWithMe(this._drawingManagerService.update$.subscribe(a=>{a.forEach(t=>{const{unitId:n,subUnitId:e,drawingId:r}=t,s=this._drawingManagerService.getDrawingByParam(t);if(s==null)return;const{transform:i,drawingType:o,srcRect:c,prstGeom:g,source:d,imageSourceType:u}=s;if(o!==h.DrawingTypeEnum.DRAWING_IMAGE)return;const f=this._getSceneAndTransformerByDrawingSearch(n);if(f==null)return;const{scene:p,transformer:S}=f;if(i==null)return!0;const v=M.getDrawingShapeKeyByDrawingSearch({unitId:n,subUnitId:e,drawingId:r}),C=p.getObject(v);if(C==null)return!0;C.setSrcRect(c),C.setPrstGeom(g),d!=null&&d.length>0&&(u===h.ImageSourceType.BASE64||u===h.ImageSourceType.URL)&&C.changeSource(d)})}))}_addHoverForImage(a){this.disposeWithMe(h.toDisposable(a.onPointerEnter$.subscribeEvent(()=>{a.cursor=b.CURSOR_TYPE.GRAB}))),this.disposeWithMe(h.toDisposable(a.onPointerLeave$.subscribeEvent(()=>{a.cursor=b.CURSOR_TYPE.DEFAULT})))}_addDialogForImage(a){this.disposeWithMe(h.toDisposable(a.onDblclick$.subscribeEvent(()=>{const t=`${a.oKey}-viewer-dialog`;this._drawingRenderService.previewImage(t,a.getNative().src,a.getNativeSize().width,a.getNativeSize().height)})))}};Ie=Mn([re(0,h.ICommandService),re(1,b.IRenderManagerService),re(2,M.IDrawingManagerService),re(3,V.IDialogService),re(4,M.IImageIoService),re(5,h.IUniverInstanceService),re(6,h.Inject(D.DrawingRenderService))],Ie);var On=Object.getOwnPropertyDescriptor,Nn=(a,t,n,e)=>{for(var r=e>1?void 0:e?On(t,n):t,s=a.length-1,i;s>=0;s--)(i=a[s])&&(r=i(r)||r);return r},Ke=(a,t)=>(n,e)=>t(n,e,a);const En="UNIVER_DRAWING_UI_PLUGIN";D.UniverDrawingUIPlugin=(Pe=class extends h.Plugin{constructor(t=$e,n,e){super(),this._config=t,this._injector=n,this._configService=e;const{menu:r,...s}=h.merge({},$e,this._config);r&&this._configService.setConfig("menu",r,{merge:!0}),this._configService.setConfig(wn,s)}onStarting(){this._initDependencies()}onRendered(){this._injector.get(Se),this._injector.get(we),this._injector.get(_e),this._injector.get(Ie)}_initDependencies(){[[D.DrawingRenderService],[Se],[we],[_e],[Ie]].forEach(n=>this._injector.add(n))}},ee(Pe,"pluginName",En),Pe),D.UniverDrawingUIPlugin=Nn([Ke(1,h.Inject(h.Injector)),Ke(2,h.IConfigService)],D.UniverDrawingUIPlugin),D.AutoImageCropOperation=me,D.COMPONENT_IMAGE_POPUP_MENU=We,D.CloseImageCropOperation=ne,D.DrawingCommonPanel=Cn,D.ImageCropperObject=de,D.ImagePopupMenu=ke,D.ImageResetSizeOperation=be,D.OpenImageCropOperation=Ce,D.SetDrawingAlignOperation=fe,D.getUpdateParams=ge,Object.defineProperty(D,Symbol.toStringTag,{value:"Module"})});


// @univerjs/sheets-drawing/index
(function(n,a){typeof exports=="object"&&typeof module<"u"?a(exports,require("@univerjs/core"),require("@univerjs/drawing")):typeof define=="function"&&define.amd?define(["exports","@univerjs/core","@univerjs/drawing"],a):(n=typeof globalThis<"u"?globalThis:n||self,a(n.UniverSheetsDrawing={},n.UniverCore,n.UniverDrawing))})(this,function(n,a,u){"use strict";const w="sheets-drawing.config",_={};var f=(e=>(e.Position="0",e.Both="1",e.None="2",e))(f||{});class l extends u.UnitDrawingService{}const v=a.createIdentifier("sheets-drawing.sheet-drawing.service");var U=(e=>(e[e.INSERT=0]="INSERT",e[e.REMOVE=1]="REMOVE",e[e.UPDATE=2]="UPDATE",e[e.ARRANGE=3]="ARRANGE",e[e.GROUP=4]="GROUP",e[e.UNGROUP=5]="UNGROUP",e))(U||{});const D={id:"sheet.mutation.set-drawing-apply",type:a.CommandType.MUTATION,handler:(e,t)=>{const i=e.get(u.IDrawingManagerService),r=e.get(v),{op:s,unitId:o,subUnitId:g,type:M,objects:c}=t;switch(i.applyJson1(o,g,s),r.applyJson1(o,g,s),M){case 0:i.addNotification(c),r.addNotification(c);break;case 1:i.removeNotification(c),r.removeNotification(c);break;case 2:i.updateNotification(c),r.updateNotification(c);break;case 3:i.orderNotification(c),r.orderNotification(c);break;case 4:i.groupUpdateNotification(c);break;case 5:i.ungroupUpdateNotification(c);break}return!0}};var m=Object.getOwnPropertyDescriptor,E=(e,t,i,r)=>{for(var s=r>1?void 0:r?m(t,i):t,o=e.length-1,g;o>=0;o--)(g=e[o])&&(s=g(s)||s);return s},h=(e,t)=>(i,r)=>t(i,r,e);const S="SHEET_DRAWING_PLUGIN";let d=class extends a.Disposable{constructor(e,t,i,r){super(),this._commandService=e,this._sheetDrawingService=t,this._drawingManagerService=i,this._resourceManagerService=r,this._initSnapshot(),this.disposeWithMe(this._commandService.registerCommand(D))}_initSnapshot(){const e=(i,r)=>{const s=r||this._sheetDrawingService.getDrawingDataForUnit(i);return s?JSON.stringify(s):""},t=i=>{if(!i)return{};try{return JSON.parse(i)}catch{return{}}};this.disposeWithMe(this._resourceManagerService.registerPluginResource({pluginName:S,businesses:[a.UniverInstanceType.UNIVER_SHEET],toJson:(i,r)=>e(i,r),parseJson:i=>t(i),onUnLoad:i=>{this._sheetDrawingService.removeDrawingDataForUnit(i),this._drawingManagerService.removeDrawingDataForUnit(i)},onLoad:(i,r)=>{this._sheetDrawingService.registerDrawingData(i,r),this._drawingManagerService.registerDrawingData(i,r)}}))}};d=E([h(0,a.ICommandService),h(1,v),h(2,u.IDrawingManagerService),h(3,a.IResourceManagerService)],d);var I=Object.defineProperty,R=Object.getOwnPropertyDescriptor,O=(e,t,i)=>t in e?I(e,t,{enumerable:!0,configurable:!0,writable:!0,value:i}):e[t]=i,b=(e,t,i,r)=>{for(var s=r>1?void 0:r?R(t,i):t,o=e.length-1,g;o>=0;o--)(g=e[o])&&(s=g(s)||s);return s},N=(e,t)=>(i,r)=>t(i,r,e),P=(e,t,i)=>O(e,typeof t!="symbol"?t+"":t,i);n.UniverSheetsDrawingPlugin=class extends a.Plugin{constructor(t=_,i,r){super(),this._config=t,this._injector=i,this._configService=r;const{...s}=a.merge({},_,this._config);this._configService.setConfig(w,s)}onStarting(){[[d],[v,{useClass:l}]].forEach(t=>this._injector.add(t)),this._injector.get(d)}},P(n.UniverSheetsDrawingPlugin,"pluginName",S),P(n.UniverSheetsDrawingPlugin,"type",a.UniverInstanceType.UNIVER_SHEET),n.UniverSheetsDrawingPlugin=b([a.DependentOn(u.UniverDrawingPlugin),N(1,a.Inject(a.Injector)),N(2,a.IConfigService)],n.UniverSheetsDrawingPlugin),n.DrawingApplyType=U,n.ISheetDrawingService=v,n.SHEET_DRAWING_PLUGIN=S,n.SetDrawingApplyMutation=D,n.SheetDrawingAnchorType=f,Object.defineProperty(n,Symbol.toStringTag,{value:"Module"})});


// @univerjs/sheets-drawing-ui/index
(function(R,l){typeof exports=="object"&&typeof module<"u"?l(exports,require("@univerjs/core"),require("@univerjs/docs-drawing"),require("@univerjs/drawing"),require("@univerjs/drawing-ui"),require("@univerjs/engine-render"),require("@univerjs/sheets-drawing"),require("@univerjs/sheets-ui"),require("@univerjs/ui"),require("rxjs"),require("@univerjs/sheets"),require("react/jsx-runtime"),require("react"),require("@univerjs/docs-ui"),require("@univerjs/design")):typeof define=="function"&&define.amd?define(["exports","@univerjs/core","@univerjs/docs-drawing","@univerjs/drawing","@univerjs/drawing-ui","@univerjs/engine-render","@univerjs/sheets-drawing","@univerjs/sheets-ui","@univerjs/ui","rxjs","@univerjs/sheets","react/jsx-runtime","react","@univerjs/docs-ui","@univerjs/design"],l):(R=typeof globalThis<"u"?globalThis:R||self,l(R.UniverSheetsDrawingUi={},R.UniverCore,R.UniverDocsDrawing,R.UniverDrawing,R.UniverDrawingUi,R.UniverEngineRender,R.UniverSheetsDrawing,R.UniverSheetsUi,R.UniverUi,R.rxjs,R.UniverSheets,R.React,R.React,R.UniverDocsUi,R.UniverDesign))})(this,function(R,l,we,U,pe,B,m,O,Y,N,I,x,ne,ut,q){"use strict";var Kn=Object.defineProperty;var zn=(R,l,we)=>l in R?Kn(R,l,{enumerable:!0,configurable:!0,writable:!0,value:we}):R[l]=we;var ee=(R,l,we)=>zn(R,typeof l!="symbol"?l+"":l,we);const $t="sheets-drawing-ui.config",Tt={},G={id:"sheet.operation.clear-drawing-transformer",type:l.CommandType.MUTATION,handler:(i,r)=>{const t=i.get(B.IRenderManagerService);return r.forEach(e=>{var n,o;(o=(n=t.getRenderById(e))==null?void 0:n.scene.getTransformer())==null||o.debounceRefreshControls()}),!0}},_e={id:"sheet.command.remove-sheet-image",type:l.CommandType.COMMAND,handler:(i,r)=>{var y,M,T;const t=i.get(l.ICommandService),e=i.get(l.IUndoRedoService),n=i.get(I.SheetInterceptorService),o=i.get(m.ISheetDrawingService);if(!r)return!1;const{drawings:a}=r,s=[];a.forEach(C=>{const{unitId:b}=C;s.push(b)});const d=o.getBatchRemoveOp(a),{unitId:g,subUnitId:u,undo:c,redo:p,objects:h}=d,f=n.onCommandExecute({id:_e.id,params:r}),S={id:m.SetDrawingApplyMutation.id,params:{unitId:g,subUnitId:u,op:p,objects:h,type:m.DrawingApplyType.REMOVE}},w={id:m.SetDrawingApplyMutation.id,params:{unitId:g,subUnitId:u,op:c,objects:h,type:m.DrawingApplyType.INSERT}};return l.sequenceExecute([...(y=f.preRedos)!=null?y:[],S,...f.redos],t)?(e.pushUndoRedo({unitID:g,undoMutations:[...(M=f.preUndos)!=null?M:[],w,...f.undos,{id:G.id,params:s}],redoMutations:[...(T=f.preRedos)!=null?T:[],S,...f.redos,{id:G.id,params:s}]}),!0):!1}},bt="COMPONENT_SHEET_DRAWING_PANEL",gt={id:"sidebar.operation.sheet-image",type:l.CommandType.COMMAND,handler:async(i,r)=>{const t=i.get(Y.ISidebarService),e=i.get(l.LocaleService),n=i.get(l.IUniverInstanceService),o=i.get(l.ICommandService);if(!I.getSheetCommandTarget(n))return!1;switch(r.value){case"open":t.open({header:{title:e.t("sheetImage.panel.title")},children:{label:bt},onClose:()=>{o.syncExecuteCommand(U.SetDrawingSelectedOperation.id,[])},width:360});break;case"close":default:t.close();break}return!0}},ht={id:"sheet.operation.edit-sheet-image",type:l.CommandType.OPERATION,handler:(i,r)=>{const t=i.get(l.ICommandService);return r==null?!1:(t.syncExecuteCommand(U.SetDrawingSelectedOperation.id,[r]),t.executeCommand(gt.id,{value:"open"}),!0)}},Fe={uploadLoading:"univer-upload-loading",uploadLoadingBody:"univer-upload-loading-body",uploadLoadingBodyAnimation:"univer-upload-loading-body-animation",uploadLoadingBodyText:"univer-upload-loading-body-text"},Gt=()=>{const i=Y.useDependency(U.IImageIoService),r=Y.useDependency(l.LocaleService),[t,e]=ne.useState(0);return ne.useEffect(()=>{const n=i.change$.subscribe(o=>{e(o)});return()=>{n.unsubscribe()}},[i]),x.jsx("div",{style:{display:t>0?"block":"none"},className:Fe.uploadLoading,children:x.jsxs("div",{className:Fe.uploadLoadingBody,children:[x.jsx("div",{className:Fe.uploadLoadingBodyAnimation}),x.jsx("div",{className:Fe.uploadLoadingBodyText,children:`${r.t("uploadLoading.loading")}: ${t}`})]})})};var Ht=Object.getOwnPropertyDescriptor,Vt=(i,r,t,e)=>{for(var n=e>1?void 0:e?Ht(r,t):r,o=i.length-1,a;o>=0;o--)(a=i[o])&&(n=a(n)||n);return n},me=(i,r)=>(t,e)=>r(t,e,i);let $e=class extends l.RxDisposable{constructor(r,t,e,n,o,a,s,d){super();ee(this,"_initImagePopupMenu",new Set);this._injector=r,this._drawingManagerService=t,this._canvasPopManagerService=e,this._renderManagerService=n,this._univerInstanceService=o,this._contextService=a,this._uiPartsService=s,this._commandService=d,this._init()}_init(){this._univerInstanceService.getCurrentTypeOfUnit$(l.UniverInstanceType.UNIVER_SHEET).pipe(N.takeUntil(this.dispose$)).subscribe(r=>this._create(r)),this._univerInstanceService.getTypeOfUnitDisposed$(l.UniverInstanceType.UNIVER_SHEET).pipe(N.takeUntil(this.dispose$)).subscribe(r=>this._dispose(r)),this._univerInstanceService.getAllUnitsForType(l.UniverInstanceType.UNIVER_SHEET).forEach(r=>this._create(r)),this._uiPartsService.registerComponent(Y.BuiltInUIPart.CONTENT,()=>Y.connectInjector(Gt,this._injector))}_dispose(r){const t=r.getUnitId();this._renderManagerService.removeRender(t)}_create(r){if(!r)return;const t=r.getUnitId();this._renderManagerService.has(t)&&!this._initImagePopupMenu.has(t)&&(this._popupMenuListener(t),this._initImagePopupMenu.add(t))}_hasCropObject(r){const t=r.getAllObjectsByOrder();for(const e of t)if(e instanceof pe.ImageCropperObject)return!0;return!1}_popupMenuListener(r){var o;const t=(o=this._renderManagerService.getRenderById(r))==null?void 0:o.scene;if(!t)return;const e=t.getTransformerByCreate();if(!e)return;let n;this.disposeWithMe(l.toDisposable(e.createControl$.subscribe(()=>{if(this._contextService.setContextValue(l.FOCUSING_COMMON_DRAWINGS,!0),this._hasCropObject(t))return;const a=e.getSelectedObjectMap();if(a.size>1){n==null||n.dispose();return}const s=a.values().next().value;if(!s)return;const d=s.oKey,g=this._drawingManagerService.getDrawingOKey(d);if(!g)return;const{unitId:u,subUnitId:c,drawingId:p,drawingType:h}=g,f=g.data;if(f&&f.disablePopup)return;n==null||n.dispose();const S=this._canvasPopManagerService.getFeatureMenu(u,c,p,h);n=this.disposeWithMe(this._canvasPopManagerService.attachPopupToObject(s,{componentKey:pe.COMPONENT_IMAGE_POPUP_MENU,direction:"horizontal",offset:[2,0],extraProps:{menuItems:S||this._getImageMenuItems(u,c,p,h)}}))}))),this.disposeWithMe(e.clearControl$.subscribe(()=>{n==null||n.dispose(),this._contextService.setContextValue(l.FOCUSING_COMMON_DRAWINGS,!1),this._commandService.syncExecuteCommand(U.SetDrawingSelectedOperation.id,[])})),this.disposeWithMe(this._contextService.contextChanged$.subscribe(a=>{a[l.FOCUSING_COMMON_DRAWINGS]===!1&&(n==null||n.dispose())})),this.disposeWithMe(e.changing$.subscribe(()=>{n==null||n.dispose()}))}_getImageMenuItems(r,t,e,n){return[{label:"image-popup.edit",index:0,commandId:ht.id,commandParams:{unitId:r,subUnitId:t,drawingId:e},disable:n===l.DrawingTypeEnum.DRAWING_DOM},{label:"image-popup.delete",index:1,commandId:_e.id,commandParams:{unitId:r,drawings:[{unitId:r,subUnitId:t,drawingId:e}]},disable:!1},{label:"image-popup.crop",index:2,commandId:pe.OpenImageCropOperation.id,commandParams:{unitId:r,subUnitId:t,drawingId:e},disable:n===l.DrawingTypeEnum.DRAWING_DOM},{label:"image-popup.reset",index:3,commandId:pe.ImageResetSizeOperation.id,commandParams:[{unitId:r,subUnitId:t,drawingId:e}],disable:n===l.DrawingTypeEnum.DRAWING_DOM}]}};$e=Vt([me(0,l.Inject(l.Injector)),me(1,U.IDrawingManagerService),me(2,l.Inject(O.SheetCanvasPopManagerService)),me(3,B.IRenderManagerService),me(4,l.IUniverInstanceService),me(5,l.IContextService),me(6,l.Inject(Y.IUIPartsService)),me(7,l.ICommandService)],$e);function K(i,r,t){const{from:e,to:n,flipY:o=!1,flipX:a=!1,angle:s=0,skewX:d=0,skewY:g=0}=i,u=t.getCurrent();if(u==null)return;const c=O.convertPositionSheetOverGridToAbsolute(u.unitId,u.sheetId,{from:e,to:n},t);let{left:p,top:h,width:f,height:S}=c;const w=t.getCurrentSkeleton(),v=w.rowHeaderWidth+w.columnTotalWidth,y=w.columnHeaderHeight+w.rowTotalHeight;return p+f>v&&(p=v-f),h+S>y&&(h=y-S),{flipY:o,flipX:a,angle:s,skewX:d,skewY:g,left:p,top:h,width:f,height:S}}function H(i,r){const{left:t=0,top:e=0,width:n=0,height:o=0,flipY:a=!1,flipX:s=!1,angle:d=0,skewX:g=0,skewY:u=0}=i,c=r.getCellWithCoordByOffset(t,e);if(c==null)return;const p={column:c.actualColumn,columnOffset:B.precisionTo(t-c.startX,1),row:c.actualRow,rowOffset:B.precisionTo(e-c.startY,1)},h=r.getCellWithCoordByOffset(t+n,e+o);if(h==null)return;const f={column:h.actualColumn,columnOffset:B.precisionTo(t+n-h.startX,1),row:h.actualRow,rowOffset:B.precisionTo(e+o-h.startY,1)};return{flipY:a,flipX:s,angle:d,skewX:g,skewY:u,from:p,to:f}}var Xt=Object.getOwnPropertyDescriptor,xt=(i,r,t,e)=>{for(var n=e>1?void 0:e?Xt(r,t):r,o=i.length-1,a;o>=0;o--)(a=i[o])&&(n=a(n)||n);return n},Ge=(i,r)=>(t,e)=>r(t,e,i);let pt=class extends l.Disposable{constructor(i,r,t,e,n){super(),this._context=i,this._sheetDrawingService=r,this._drawingManagerService=t,this._sheetSelectionRenderService=e,this._sheetSkeletonManagerService=n,this._init()}_init(){this._drawingInitializeListener()}_drawingInitializeListener(){this._sheetDrawingService.initializeNotification(this._context.unitId);const i=this._sheetDrawingService.getDrawingDataForUnit(this._context.unitId);for(const r in i){const t=i[r];for(const e in t.data){const n=t.data[e];n.transform=K(n.sheetTransform,this._sheetSelectionRenderService,this._sheetSkeletonManagerService)}}this._drawingManagerService.registerDrawingData(this._context.unitId,this._sheetDrawingService.getDrawingDataForUnit(this._context.unitId)),this._drawingManagerService.initializeNotification(this._context.unitId)}};pt=xt([Ge(1,m.ISheetDrawingService),Ge(2,U.IDrawingManagerService),Ge(3,l.Inject(O.ISheetSelectionRenderService)),Ge(4,l.Inject(O.SheetSkeletonManagerService))],pt);function Kt(i){const r=[];return i.forEach(t=>{const{parent:e,children:n}=t,{unitId:o,subUnitId:a,drawingId:s}=e,d=B.getGroupState(0,0,n.map(c=>c.transform||{})),g=n.map(c=>{const p=c.transform||{left:0,top:0},{unitId:h,subUnitId:f,drawingId:S}=c;return{unitId:h,subUnitId:f,drawingId:S,transform:{...p,left:p.left-d.left,top:p.top-d.top},groupId:s}}),u={unitId:o,subUnitId:a,drawingId:s,drawingType:l.DrawingTypeEnum.DRAWING_GROUP,transform:d};r.push({parent:u,children:g})}),r}function zt(i){const r=[];return i.forEach(t=>{const{parent:e,children:n}=t,{unitId:o,subUnitId:a,drawingId:s,transform:d={width:0,height:0}}=e;if(d==null)return;const g=n.map(c=>{const{transform:p}=c,{unitId:h,subUnitId:f,drawingId:S}=c,w=B.transformObjectOutOfGroup(p||{},d,d.width||0,d.height||0);return{unitId:h,subUnitId:f,drawingId:S,transform:w,groupId:void 0}}),u={unitId:o,subUnitId:a,drawingId:s,drawingType:l.DrawingTypeEnum.DRAWING_GROUP,transform:{left:0,top:0}};r.push({parent:u,children:g})}),r}const mt={id:"sheet.command.group-sheet-image",type:l.CommandType.COMMAND,handler:(i,r)=>{const t=i.get(l.ICommandService),e=i.get(l.IUndoRedoService),n=i.get(m.ISheetDrawingService);if(!r)return!1;const o=[];r.forEach(({parent:h,children:f})=>{o.push(h.unitId),f.forEach(S=>{o.push(S.unitId)})});const a=n.getGroupDrawingOp(r),{unitId:s,subUnitId:d,undo:g,redo:u,objects:c}=a;return t.syncExecuteCommand(m.SetDrawingApplyMutation.id,{op:u,unitId:s,subUnitId:d,objects:c,type:m.DrawingApplyType.GROUP})?(e.pushUndoRedo({unitID:s,undoMutations:[{id:m.SetDrawingApplyMutation.id,params:{op:g,unitId:s,subUnitId:d,objects:zt(c),type:m.DrawingApplyType.UNGROUP}},{id:G.id,params:o}],redoMutations:[{id:m.SetDrawingApplyMutation.id,params:{op:u,unitId:s,subUnitId:d,objects:c,type:m.DrawingApplyType.GROUP}},{id:G.id,params:o}]}),!0):!1}},Oe={id:"sheet.command.insert-sheet-image",type:l.CommandType.COMMAND,handler:(i,r)=>{var y,M,T;const t=i.get(l.ICommandService),e=i.get(l.IUndoRedoService),n=i.get(m.ISheetDrawingService),o=i.get(I.SheetInterceptorService);if(!r)return!1;const a=r.drawings,s=a.map(C=>C.unitId),d=n.getBatchAddOp(a),{unitId:g,subUnitId:u,undo:c,redo:p,objects:h}=d,f=o.onCommandExecute({id:Oe.id,params:r}),S={id:m.SetDrawingApplyMutation.id,params:{op:p,unitId:g,subUnitId:u,objects:h,type:m.DrawingApplyType.INSERT}},w={id:m.SetDrawingApplyMutation.id,params:{op:c,unitId:g,subUnitId:u,objects:h,type:m.DrawingApplyType.REMOVE}};return l.sequenceExecute([...(y=f.preRedos)!=null?y:[],S,...f.redos],t)?(e.pushUndoRedo({unitID:g,undoMutations:[...(M=f.preUndos)!=null?M:[],w,...f.undos,{id:G.id,params:s}],redoMutations:[...(T=f.preRedos)!=null?T:[],S,...f.redos,{id:G.id,params:s}]}),!0):!1}},ft={id:"sheet.command.set-drawing-arrange",type:l.CommandType.COMMAND,handler:(i,r)=>{const t=i.get(l.ICommandService),e=i.get(l.IUndoRedoService);if(!r)return!1;const n=i.get(m.ISheetDrawingService),{unitId:o,subUnitId:a,drawingIds:s,arrangeType:d}=r,g={unitId:o,subUnitId:a,drawingIds:s};let u;if(d===l.ArrangeTypeEnum.forward?u=n.getForwardDrawingsOp(g):d===l.ArrangeTypeEnum.backward?u=n.getBackwardDrawingOp(g):d===l.ArrangeTypeEnum.front?u=n.getFrontDrawingsOp(g):d===l.ArrangeTypeEnum.back&&(u=n.getBackDrawingsOp(g)),u==null)return!1;const{objects:c,redo:p,undo:h}=u;return t.syncExecuteCommand(m.SetDrawingApplyMutation.id,{op:p,unitId:o,subUnitId:a,objects:c,type:m.DrawingApplyType.ARRANGE})?(e.pushUndoRedo({unitID:o,undoMutations:[{id:m.SetDrawingApplyMutation.id,params:{op:h,unitId:o,subUnitId:a,objects:c,type:m.DrawingApplyType.ARRANGE}}],redoMutations:[{id:m.SetDrawingApplyMutation.id,params:{op:p,unitId:o,subUnitId:a,objects:c,type:m.DrawingApplyType.ARRANGE}}]}),!0):!1}},Pe={id:"sheet.command.set-sheet-image",type:l.CommandType.COMMAND,handler:(i,r)=>{const t=i.get(l.ICommandService),e=i.get(l.IUndoRedoService),n=i.get(m.ISheetDrawingService);if(!r)return!1;const{drawings:o}=r,a=n.getBatchUpdateOp(o),{unitId:s,subUnitId:d,undo:g,redo:u,objects:c}=a;return t.syncExecuteCommand(m.SetDrawingApplyMutation.id,{unitId:s,subUnitId:d,op:u,objects:c,type:m.DrawingApplyType.UPDATE})?(e.pushUndoRedo({unitID:s,undoMutations:[{id:m.SetDrawingApplyMutation.id,params:{unitId:s,subUnitId:d,op:g,objects:c,type:m.DrawingApplyType.UPDATE}},{id:G.id,params:[s]}],redoMutations:[{id:m.SetDrawingApplyMutation.id,params:{unitId:s,subUnitId:d,op:u,objects:c,type:m.DrawingApplyType.UPDATE}},{id:G.id,params:[s]}]}),!0):!1}},St={id:"sheet.command.ungroup-sheet-image",type:l.CommandType.COMMAND,handler:(i,r)=>{const t=i.get(l.ICommandService),e=i.get(l.IUndoRedoService),n=i.get(m.ISheetDrawingService);if(!r)return!1;const o=[];r.forEach(({parent:h,children:f})=>{o.push(h.unitId),f.forEach(S=>{o.push(S.unitId)})});const a=n.getUngroupDrawingOp(r),{unitId:s,subUnitId:d,undo:g,redo:u,objects:c}=a;return t.syncExecuteCommand(m.SetDrawingApplyMutation.id,{op:u,unitId:s,subUnitId:d,objects:c,type:m.DrawingApplyType.UNGROUP})?(e.pushUndoRedo({unitID:s,undoMutations:[{id:m.SetDrawingApplyMutation.id,params:{op:g,unitId:s,subUnitId:d,objects:Kt(c),type:m.DrawingApplyType.GROUP}},{id:G.id,params:o}],redoMutations:[{id:m.SetDrawingApplyMutation.id,params:{op:u,unitId:s,subUnitId:d,objects:c,type:m.DrawingApplyType.UNGROUP}},{id:G.id,params:o}]}),!0):!1}};var qt=Object.getOwnPropertyDescriptor,Zt=(i,r,t,e)=>{for(var n=e>1?void 0:e?qt(r,t):r,o=i.length-1,a;o>=0;o--)(a=i[o])&&(n=a(n)||n);return n},re=(i,r)=>(t,e)=>r(t,e,i);function Jt(i,r,t){const e=t*Math.PI/180,n=Math.abs(i*Math.cos(e))+Math.abs(r*Math.sin(e)),o=Math.abs(i*Math.sin(e))+Math.abs(r*Math.cos(e));return{rotatedWidth:n,rotatedHeight:o}}function wt(i,r,t,e,n){var y;const{rotatedHeight:o,rotatedWidth:a}=Jt(t,e,n),d=i.get(B.IRenderManagerService).getRenderById(r.unitId);if(!d)return!1;const u=(y=d.with(O.SheetSkeletonManagerService).getSkeletonParam(r.subUnitId))==null?void 0:y.skeleton;if(u==null)return!1;const c=u.getCellByIndex(r.row,r.col),p=c.mergeInfo.endX-c.mergeInfo.startX-2,h=c.mergeInfo.endY-c.mergeInfo.startY-2,f=a/o,w=Math.ceil(Math.min(p,h*f))/a,v=!w||Number.isNaN(w)?.001:w;return{width:t*v,height:e*v}}R.SheetDrawingUpdateController=class extends l.Disposable{constructor(t,e,n,o,a,s,d,g,u,c,p,h,f){super();ee(this,"_workbookSelections");this._context=t,this._skeletonManagerService=e,this._commandService=n,this._selectionRenderService=o,this._imageIoService=a,this._fileOpenerService=s,this._sheetDrawingService=d,this._drawingManagerService=g,this._contextService=u,this._messageService=c,this._localeService=p,this._injector=f,this._workbookSelections=h.getWorkbookSelections(this._context.unitId),this._updateImageListener(),this._updateOrderListener(),this._groupDrawingListener(),this._focusDrawingListener()}async insertFloatImage(){const t=await this._fileOpenerService.openFile({multiple:!0,accept:U.DRAWING_IMAGE_ALLOW_IMAGE_LIST.map(n=>`.${n.replace("image/","")}`).join(",")}),e=t.length;return e>U.DRAWING_IMAGE_COUNT_LIMIT?(this._messageService.show({type:q.MessageType.Error,content:this._localeService.t("update-status.exceedMaxCount",String(U.DRAWING_IMAGE_COUNT_LIMIT))}),!1):e===0?!1:(t.forEach(async n=>await this.insertFloatImageByFile(n)),!0)}async insertCellImage(){const e=(await this._fileOpenerService.openFile({multiple:!1,accept:U.DRAWING_IMAGE_ALLOW_IMAGE_LIST.map(n=>`.${n.replace("image/","")}`).join(",")}))[0];return e?(await this._insertCellImage(e),!0):!1}insertCellImageByFile(t,e){return this._insertCellImage(t,e)}async insertFloatImageByFile(t){let e;try{e=await this._imageIoService.saveImage(t)}catch(M){const T=M.message;T===U.ImageUploadStatusType.ERROR_EXCEED_SIZE?this._messageService.show({type:q.MessageType.Error,content:this._localeService.t("update-status.exceedMaxSize",String(U.DRAWING_IMAGE_ALLOW_SIZE/(1024*1024)))}):T===U.ImageUploadStatusType.ERROR_IMAGE_TYPE?this._messageService.show({type:q.MessageType.Error,content:this._localeService.t("update-status.invalidImageType")}):T===U.ImageUploadStatusType.ERROR_IMAGE&&this._messageService.show({type:q.MessageType.Error,content:this._localeService.t("update-status.invalidImage")})}if(e==null)return;const n=this._getUnitInfo(),{unitId:o,subUnitId:a}=n,{imageId:s,imageSourceType:d,source:g,base64Cache:u}=e,{width:c,height:p,image:h}=await U.getImageSize(u||""),{width:f,height:S}=this._context.scene;this._imageIoService.addImageSourceCache(g,d,h);let w=1;if(c>U.DRAWING_IMAGE_WIDTH_LIMIT||p>U.DRAWING_IMAGE_HEIGHT_LIMIT){const M=U.DRAWING_IMAGE_WIDTH_LIMIT/c,T=U.DRAWING_IMAGE_HEIGHT_LIMIT/p;w=Math.max(M,T)}const v=this._getImagePosition(c*w,p*w,f,S);if(v==null)return;const y={unitId:o,subUnitId:a,drawingId:s,drawingType:l.DrawingTypeEnum.DRAWING_IMAGE,imageSourceType:d,source:g,transform:K(v,this._selectionRenderService,this._skeletonManagerService),sheetTransform:v};return this._commandService.executeCommand(Oe.id,{unitId:o,drawings:[y]})}async _insertCellImage(t,e){var y,M;let n;try{n=await this._imageIoService.saveImage(t)}catch(T){const C=T.message;C===U.ImageUploadStatusType.ERROR_EXCEED_SIZE?this._messageService.show({type:q.MessageType.Error,content:this._localeService.t("update-status.exceedMaxSize",String(U.DRAWING_IMAGE_ALLOW_SIZE/(1024*1024)))}):C===U.ImageUploadStatusType.ERROR_IMAGE_TYPE?this._messageService.show({type:q.MessageType.Error,content:this._localeService.t("update-status.invalidImageType")}):C===U.ImageUploadStatusType.ERROR_IMAGE&&this._messageService.show({type:q.MessageType.Error,content:this._localeService.t("update-status.invalidImage")})}if(n==null)return!1;const{imageId:o,imageSourceType:a,source:s,base64Cache:d}=n,{width:g,height:u,image:c}=await U.getImageSize(d||"");this._imageIoService.addImageSourceCache(s,a,c);const p=this._workbookSelections.getCurrentLastSelection();if(!p)return!1;const h=l.createDocumentModelWithStyle("",{}),f=wt(this._injector,{unitId:this._context.unitId,subUnitId:this._context.unit.getActiveSheet().getSheetId(),row:p.primary.actualRow,col:p.primary.actualColumn},g,u,0);if(!f)return!1;const S={size:{width:f.width,height:f.height},positionH:{relativeFrom:l.ObjectRelativeFromH.PAGE,posOffset:0},positionV:{relativeFrom:l.ObjectRelativeFromV.PARAGRAPH,posOffset:0},angle:0},w={unitId:h.getUnitId(),subUnitId:h.getUnitId(),drawingId:o,drawingType:l.DrawingTypeEnum.DRAWING_IMAGE,imageSourceType:a,source:s,transform:ut.docDrawingPositionToTransform(S),docTransform:S,behindDoc:l.BooleanNumber.FALSE,title:"",description:"",layoutType:l.PositionedObjectLayoutType.INLINE,wrapText:l.WrapTextType.BOTH_SIDES,distB:0,distL:0,distR:0,distT:0},v=l.BuildTextUtils.drawing.add({documentDataModel:h,drawings:[w],selection:{collapsed:!0,startOffset:0,endOffset:0}});return v?(h.apply(v),this._commandService.syncExecuteCommand(I.SetRangeValuesCommand.id,{value:{[(y=e==null?void 0:e.row)!=null?y:p.primary.actualRow]:{[(M=e==null?void 0:e.col)!=null?M:p.primary.actualColumn]:{p:h.getSnapshot(),t:1}}},unitId:e==null?void 0:e.unitId,subUnitId:e==null?void 0:e.subUnitId})):!1}async insertCellImageByUrl(t,e){var h,f;const{width:n,height:o,image:a}=await U.getImageSize(t||"");this._imageIoService.addImageSourceCache(t,l.ImageSourceType.URL,a);const s=this._workbookSelections.getCurrentLastSelection();if(!s)return!1;const d=l.createDocumentModelWithStyle("",{}),g=wt(this._injector,{unitId:this._context.unitId,subUnitId:this._context.unit.getActiveSheet().getSheetId(),row:s.primary.actualRow,col:s.primary.actualColumn},n,o,0);if(!g)return!1;const u={size:{width:g.width,height:g.height},positionH:{relativeFrom:l.ObjectRelativeFromH.PAGE,posOffset:0},positionV:{relativeFrom:l.ObjectRelativeFromV.PARAGRAPH,posOffset:0},angle:0},c={unitId:d.getUnitId(),subUnitId:d.getUnitId(),drawingId:l.generateRandomId(),drawingType:l.DrawingTypeEnum.DRAWING_IMAGE,imageSourceType:l.ImageSourceType.URL,source:t,transform:ut.docDrawingPositionToTransform(u),docTransform:u,behindDoc:l.BooleanNumber.FALSE,title:"",description:"",layoutType:l.PositionedObjectLayoutType.INLINE,wrapText:l.WrapTextType.BOTH_SIDES,distB:0,distL:0,distR:0,distT:0},p=l.BuildTextUtils.drawing.add({documentDataModel:d,drawings:[c],selection:{collapsed:!0,startOffset:0,endOffset:0}});return p?(d.apply(p),this._commandService.syncExecuteCommand(I.SetRangeValuesCommand.id,{value:{[(h=e==null?void 0:e.row)!=null?h:s.primary.actualRow]:{[(f=e==null?void 0:e.col)!=null?f:s.primary.actualColumn]:{p:d.getSnapshot(),t:1}}},unitId:e==null?void 0:e.unitId,subUnitId:e==null?void 0:e.subUnitId})):!1}_getUnitInfo(){const t=this._context.unit,e=t.getActiveSheet(),n=t.getUnitId(),o=e.getSheetId();return{unitId:n,subUnitId:o}}_getImagePosition(t,e,n,o){const a=this._workbookSelections.getCurrentSelections();let s={startRow:0,endRow:0,startColumn:0,endColumn:0};a&&a.length>0&&(s=a[a.length-1].range);const d=O.attachRangeWithCoord(this._skeletonManagerService.getCurrent().skeleton,s);if(d==null)return;let{startColumn:g,startRow:u,startX:c,startY:p}=d,h=!1;if(c+t>n&&(c=n-t,c<0&&(c=0,t=n),h=!0),p+e>o&&(p=o-e,p<0&&(p=0,e=o),h=!0),h){const v=this._selectionRenderService.getCellWithCoordByOffset(c,p);if(v==null)return;c=v.startX,p=v.startY,g=v.actualColumn,u=v.actualRow}const f={column:g,columnOffset:0,row:u,rowOffset:0},S=this._selectionRenderService.getCellWithCoordByOffset(c+t,p+e);if(S==null)return;const w={column:S.actualColumn,columnOffset:c+t-S.startX,row:S.actualRow,rowOffset:p+e-S.startY};return{from:f,to:w}}_updateOrderListener(){this.disposeWithMe(this._drawingManagerService.featurePluginOrderUpdate$.subscribe(t=>{const{unitId:e,subUnitId:n,drawingIds:o,arrangeType:a}=t;this._commandService.executeCommand(ft.id,{unitId:e,subUnitId:n,drawingIds:o,arrangeType:a})}))}_updateImageListener(){this.disposeWithMe(this._drawingManagerService.featurePluginUpdate$.subscribe(t=>{const e=[];t.length!==0&&(t.forEach(n=>{const{unitId:o,subUnitId:a,drawingId:s,drawingType:d,transform:g}=n;if(g==null)return;const u=this._sheetDrawingService.getDrawingByParam({unitId:o,subUnitId:a,drawingId:s});if(u==null||u.unitId!==this._context.unitId)return;const c=H({...u.transform,...g},this._selectionRenderService);if(c==null)return;const p={...n,transform:{...u.transform,...g,...K(c,this._selectionRenderService,this._skeletonManagerService)},sheetTransform:{...c}};e.push(p)}),e.length>0&&this._commandService.executeCommand(Pe.id,{unitId:t[0].unitId,drawings:e}))}))}_groupDrawingListener(){this.disposeWithMe(this._drawingManagerService.featurePluginGroupUpdate$.subscribe(t=>{this._commandService.executeCommand(mt.id,t);const{unitId:e,subUnitId:n,drawingId:o}=t[0].parent;this._commandService.syncExecuteCommand(U.SetDrawingSelectedOperation.id,[{unitId:e,subUnitId:n,drawingId:o}])})),this.disposeWithMe(this._drawingManagerService.featurePluginUngroupUpdate$.subscribe(t=>{this._commandService.executeCommand(St.id,t)}))}_focusDrawingListener(){this.disposeWithMe(this._drawingManagerService.focus$.subscribe(t=>{t==null||t.length===0?(this._contextService.setContextValue(l.FOCUSING_COMMON_DRAWINGS,!1),this._sheetDrawingService.focusDrawing([])):(this._contextService.setContextValue(l.FOCUSING_COMMON_DRAWINGS,!0),this._sheetDrawingService.focusDrawing(t))}))}},R.SheetDrawingUpdateController=Zt([re(1,l.Inject(O.SheetSkeletonManagerService)),re(2,l.ICommandService),re(3,O.ISheetSelectionRenderService),re(4,U.IImageIoService),re(5,Y.ILocalFileService),re(6,m.ISheetDrawingService),re(7,U.IDrawingManagerService),re(8,l.IContextService),re(9,Y.IMessageService),re(10,l.Inject(l.LocaleService)),re(11,l.Inject(I.SheetsSelectionsService)),re(12,l.Inject(l.Injector))],R.SheetDrawingUpdateController);var Qt=Object.getOwnPropertyDescriptor,en=(i,r,t,e)=>{for(var n=e>1?void 0:e?Qt(r,t):r,o=i.length-1,a;o>=0;o--)(a=i[o])&&(n=a(n)||n);return n},Ie=(i,r)=>(t,e)=>r(t,e,i);function Rt(i,r,t){var e,n,o,a;if(((n=(e=t==null?void 0:t.p)==null?void 0:e.body)==null?void 0:n.dataStream.length)===3&&((a=(o=t.p)==null?void 0:o.drawingsOrder)==null?void 0:a.length)===1){const s=t.p.drawings[t.p.drawingsOrder[0]],d=wt(i,{unitId:r.unitId,subUnitId:r.subUnitId,row:r.row,col:r.col},s.docTransform.size.width,s.docTransform.size.height,s.docTransform.angle);if(d)return s.transform.width=d.width,s.transform.height=d.height,s.docTransform.size.width=d.width,s.docTransform.size.height=d.height,s.transform.left=0,s.transform.top=0,s.docTransform.positionH.posOffset=0,s.docTransform.positionV.posOffset=0,t.p.documentStyle.pageSize.width=1/0,t.p.documentStyle.pageSize.height=1/0,!0}return!1}let He=class extends l.Disposable{constructor(i,r,t,e,n,o){super(),this._commandService=i,this._sheetInterceptorService=r,this._injector=t,this._drawingManagerService=e,this._docDrawingController=n,this._editorBridgeService=o,this._handleInitEditor(),this._initCellContentInterceptor(),this._initDisableEdit()}_initDisableEdit(){this.disposeWithMe(this._commandService.beforeCommandExecuted(i=>{var r,t,e;if(i.id===O.SetCellEditVisibleOperation.id){const n=i.params,{visible:o,eventType:a}=n;if(o&&a===B.DeviceInputEventType.Dblclick){const s=this._editorBridgeService.getEditCellState();if(((e=(t=(r=s==null?void 0:s.documentLayoutObject.documentModel)==null?void 0:r.getDrawingsOrder())==null?void 0:t.length)!=null?e:0)>0)throw new Error("Can not edit when there are drawings.")}}}))}_handleInitEditor(){this.disposeWithMe(this._editorBridgeService.visible$.subscribe(i=>{i.visible?i.visible&&(this._drawingManagerService.removeDrawingDataForUnit(l.DOCS_NORMAL_EDITOR_UNIT_ID_KEY),this._docDrawingController.loadDrawingDataForUnit(l.DOCS_NORMAL_EDITOR_UNIT_ID_KEY),this._drawingManagerService.initializeNotification(l.DOCS_NORMAL_EDITOR_UNIT_ID_KEY)):this._drawingManagerService.removeDrawingDataForUnit(l.DOCS_NORMAL_EDITOR_UNIT_ID_KEY)})),this.disposeWithMe(this._commandService.onCommandExecuted(i=>{i.id===ut.ReplaceSnapshotCommand.id&&i.params.unitId===l.DOCS_ZEN_EDITOR_UNIT_ID_KEY&&(this._drawingManagerService.removeDrawingDataForUnit(l.DOCS_ZEN_EDITOR_UNIT_ID_KEY),this._docDrawingController.loadDrawingDataForUnit(l.DOCS_ZEN_EDITOR_UNIT_ID_KEY),this._drawingManagerService.initializeNotification(l.DOCS_ZEN_EDITOR_UNIT_ID_KEY))}))}_initCellContentInterceptor(){this.disposeWithMe(this._sheetInterceptorService.intercept(I.INTERCEPTOR_POINT.CELL_CONTENT,{effect:l.InterceptorEffectEnum.Style,priority:I.InterceptCellContentPriority.CELL_IMAGE,handler:(i,r,t)=>{var e;return i!=null&&i.p&&((e=i.p.drawingsOrder)!=null&&e.length)&&(i.interceptorStyle||(i.interceptorStyle={}),i.interceptorStyle.tr={a:0},Rt(this._injector,{unitId:r.unitId,subUnitId:r.subUnitId,row:r.row,col:r.col},i)),t(i)}}))}};He=en([Ie(0,l.ICommandService),Ie(1,l.Inject(I.SheetInterceptorService)),Ie(2,l.Inject(l.Injector)),Ie(3,U.IDrawingManagerService),Ie(4,l.Inject(we.DocDrawingController)),Ie(5,l.Inject(O.IEditorBridgeService))],He);var tn=Object.getOwnPropertyDescriptor,nn=(i,r,t,e)=>{for(var n=e>1?void 0:e?tn(r,t):r,o=i.length-1,a;o>=0;o--)(a=i[o])&&(n=a(n)||n);return n},Et=(i,r)=>(t,e)=>r(t,e,i);let Ve=class extends l.Disposable{constructor(i,r){super(),this._autoFillService=i,this._injector=r,this._initAutoFillHooks()}_initAutoFillHooks(){this.disposeWithMe(this._autoFillService.addHook({id:"sheet-cell-image-autofill",onBeforeSubmit:(i,r,t,e)=>{new l.ObjectMatrix(e).forValue((n,o,a)=>{Rt(this._injector,{unitId:i.unitId,subUnitId:i.subUnitId,row:n,col:o},a)})}}))}};Ve=nn([Et(0,l.Inject(O.IAutoFillService)),Et(1,l.Inject(l.Injector))],Ve);var rn=Object.getOwnPropertyDescriptor,on=(i,r,t,e)=>{for(var n=e>1?void 0:e?rn(r,t):r,o=i.length-1,a;o>=0;o--)(a=i[o])&&(n=a(n)||n);return n},Xe=(i,r)=>(t,e)=>r(t,e,i);let xe=class extends l.Disposable{constructor(r,t,e,n){super();ee(this,"_isSetCursor",!1);this._hoverManagerService=r,this._renderManagerService=t,this._selectionsService=e,this._drawingRenderService=n}_initHover(){}_initImageClick(){}};xe=on([Xe(0,l.Inject(O.HoverManagerService)),Xe(1,l.Inject(B.IRenderManagerService)),Xe(2,l.Inject(I.SheetsSelectionsService)),Xe(3,l.Inject(pe.DrawingRenderService))],xe);const Ae={id:"sheet.command.insert-float-image",type:l.CommandType.COMMAND,handler:async(i,r)=>{var a,s;const t=i.get(l.IUniverInstanceService),e=i.get(B.IRenderManagerService),n=(a=B.getCurrentTypeOfRenderer(l.UniverInstanceType.UNIVER_SHEET,t,e))==null?void 0:a.with(R.SheetDrawingUpdateController);if(!n)return!1;const o=r==null?void 0:r.files;if(o){const d=o.map(g=>n.insertFloatImageByFile(g));return(await Promise.all(d)).every(g=>g)}else return(s=n.insertFloatImage())!=null?s:!1}},vt={id:"sheet.command.insert-cell-image",type:l.CommandType.COMMAND,handler:i=>{var e,n;const r=i.get(l.IUniverInstanceService),t=i.get(B.IRenderManagerService);return(n=(e=B.getCurrentTypeOfRenderer(l.UniverInstanceType.UNIVER_SHEET,r,t))==null?void 0:e.with(R.SheetDrawingUpdateController).insertCellImage())!=null?n:!1}};var an=Object.getOwnPropertyDescriptor,sn=(i,r,t,e)=>{for(var n=e>1?void 0:e?an(r,t):r,o=i.length-1,a;o>=0;o--)(a=i[o])&&(n=a(n)||n);return n},Ue=(i,r)=>(t,e)=>r(t,e,i);const Ot="image/png";function cn(i){const r=i.split(","),t=atob(r[1]),e=t.length,n=new Uint8Array(e);for(let o=0;o<e;o++)n[o]=t.charCodeAt(o);return new Blob([n],{type:Ot})}function dn(i){const r=new ClipboardItem({[Ot]:cn(i)});navigator.clipboard.write([r]).catch(t=>{console.error("Could not copy image using clipboard API: ",t)})}function ln(){function i(){const e=document.createElement("input");return e.style.position="absolute",e.style.height="1px",e.style.width="1px",e.style.opacity="0",e}const r=document.activeElement,t=i();return document.body.appendChild(t),t.focus(),()=>{t.blur(),document.body.removeChild(t),r instanceof HTMLElement&&r.focus()}}const Pt=[O.PREDEFINED_HOOK_NAME.SPECIAL_PASTE_COL_WIDTH,O.PREDEFINED_HOOK_NAME.SPECIAL_PASTE_VALUE,O.PREDEFINED_HOOK_NAME.SPECIAL_PASTE_FORMAT,O.PREDEFINED_HOOK_NAME.SPECIAL_PASTE_FORMULA];let Ke=class extends l.Disposable{constructor(r,t,e,n,o){super();ee(this,"_copyInfo");this._sheetClipboardService=r,this._renderManagerService=t,this._drawingService=e,this._clipboardInterfaceService=n,this._commandService=o,this._initCopyPaste()}get _focusedDrawings(){return this._drawingService.getFocusDrawings()}_initCopyPaste(){this._sheetClipboardService.addClipboardHook({id:"SHEET_IMAGE_UI_PLUGIN",onBeforeCopy:(r,t,e,n)=>{const o=this._focusedDrawings;if(o.length>0){const[a]=o;if(n===O.COPY_TYPE.CUT){const d={unitId:r,drawings:[a]};this._commandService.executeCommand(_e.id,d)}setTimeout(()=>{const d=ln();a.drawingType===l.DrawingTypeEnum.DRAWING_IMAGE&&a.imageSourceType===U.ImageSourceType.BASE64?dn(a.source):this._clipboardInterfaceService.writeText(""),d()},200);const s={unitId:a.unitId,subUnitId:a.subUnitId,drawings:[a]};this._copyInfo=s}else{const a=this._createDrawingsCopyInfoByRange(r,t,e);this._copyInfo=a}},onPasteCells:(r,t,e,n)=>{if(!this._copyInfo)return{redos:[],undos:[]};const{copyType:o=O.COPY_TYPE.COPY,pasteType:a}=n,{range:s}=r||{},{range:d,unitId:g,subUnitId:u}=t;return this._copyInfo.copyRange?this._generateRangeDrawingsPasteMutations({pasteType:a,unitId:g,subUnitId:u,pasteRange:d},{copyRange:s,copyType:o}):this._generateSingleDrawingPasteMutations({pasteTo:t,pasteType:a},O.COPY_TYPE.COPY)},onPastePlainText:(r,t)=>({undos:[],redos:[]}),onPasteUnrecognized:r=>this._copyInfo?this._generateSingleDrawingPasteMutations({pasteTo:r,pasteType:O.PREDEFINED_HOOK_NAME.DEFAULT_PASTE},O.COPY_TYPE.COPY):{undos:[],redos:[]},onPasteFiles:(r,t)=>{if(this._copyInfo)return this._generateSingleDrawingPasteMutations({pasteTo:r,pasteType:O.PREDEFINED_HOOK_NAME.DEFAULT_PASTE},O.COPY_TYPE.COPY);{const e=t.filter(n=>n.type.includes("image"));if(e.length)return{undos:[],redos:[{id:Ae.id,params:{files:e}}]}}return{undos:[],redos:[]}}})}_createDrawingsCopyInfoByRange(r,t,e){var p;const n=(p=this._renderManagerService.getRenderById(r))==null?void 0:p.with(O.SheetSkeletonManagerService);if(!n)return;const o=n.attachRangeWithCoord(e);if(!o)return;const{startX:a,endX:s,startY:d,endY:g}=o,u=this._drawingService.getDrawingData(r,t),c=this._focusedDrawings.slice();if(Object.keys(u).forEach(h=>{const f=u[h],{transform:S}=f;if(f.anchorType!==m.SheetDrawingAnchorType.Both||!S)return;const{left:w=0,top:v=0,width:y=0,height:M=0}=S,{drawingStartX:T,drawingEndX:C,drawingStartY:b,drawingEndY:_}={drawingStartX:w,drawingEndX:w+y,drawingStartY:v,drawingEndY:v+M};a<=T&&C<=s&&d<=b&&_<=g&&c.push(f)}),c.length)return{copyRange:e,drawings:c,unitId:r,subUnitId:t}}_generateSingleDrawingPasteMutations(r,t){const{pasteType:e,pasteTo:n}=r;if(Pt.includes(e))return{redos:[],undos:[]};const{unitId:o,subUnitId:a,range:s}=n,d=this._renderManagerService.getRenderById(o),g=d==null?void 0:d.with(O.SheetSkeletonManagerService),u=d==null?void 0:d.with(O.ISheetSelectionRenderService),c=this._copyInfo;if(!g||!u)return{redos:[],undos:[]};const{drawings:p}=c,h=O.discreteRangeToRange(s);return this._generateMutations(p,{unitId:o,subUnitId:a,isCut:t===O.COPY_TYPE.CUT,getTransform:(f,S)=>{var y;const w=g.attachRangeWithCoord({startRow:h.startRow,endRow:h.endRow,startColumn:h.startColumn,endColumn:h.endColumn}),v={...f,left:w==null?void 0:w.startX,top:w==null?void 0:w.startY};return{transform:v,sheetTransform:(y=H(v,u))!=null?y:S}}})}_generateMutations(r,t){const{unitId:e,subUnitId:n,getTransform:o,isCut:a}=t,s=[],d=[],{_drawingService:g}=this;return r.forEach(u=>{const{transform:c,sheetTransform:p}=u;if(!c)return;const h=o(c,p),f={...u,unitId:e,subUnitId:n,drawingId:a?u.drawingId:l.Tools.generateRandomId(),transform:h.transform,sheetTransform:h.sheetTransform};if(a){const{undo:S,redo:w,objects:v}=g.getBatchUpdateOp([f]);s.push({id:m.SetDrawingApplyMutation.id,params:{unitId:e,subUnitId:n,type:m.DrawingApplyType.UPDATE,op:w,objects:v}}),d.push({id:m.SetDrawingApplyMutation.id,params:{unitId:e,subUnitId:n,type:m.DrawingApplyType.UPDATE,op:S,objects:v}})}else{const{undo:S,redo:w,objects:v}=g.getBatchAddOp([f]);s.push({id:m.SetDrawingApplyMutation.id,params:{op:w,unitId:e,subUnitId:n,objects:v,type:m.DrawingApplyType.INSERT}}),d.push({id:m.SetDrawingApplyMutation.id,params:{op:S,unitId:e,subUnitId:n,objects:v,type:m.DrawingApplyType.REMOVE}})}}),{redos:s,undos:d}}_generateRangeDrawingsPasteMutations(r,t){var k;const{unitId:e,subUnitId:n,pasteType:o,pasteRange:a}=r,{copyRange:s,copyType:d}=t;if(Pt.includes(o))return{redos:[],undos:[]};const g=(k=this._renderManagerService.getRenderById(e))==null?void 0:k.with(O.SheetSkeletonManagerService);if(!g||!this._copyInfo)return{redos:[],undos:[]};const{drawings:u}=this._copyInfo;if(!s)return this._generateSingleDrawingPasteMutations({pasteTo:{unitId:e,subUnitId:n,range:O.discreteRangeToRange(a)},pasteType:o},d);const{ranges:[c,p],mapFunc:h}=O.virtualizeDiscreteRanges([s,a]),{row:f,col:S}=h(c.startRow,c.startColumn),{row:w,col:v}=h(p.startRow,p.startColumn),y=g.attachRangeWithCoord({startRow:f,endRow:f,startColumn:S,endColumn:S}),M=g.attachRangeWithCoord({startRow:w,endRow:w,startColumn:v,endColumn:v});if(!y||!M||!this._copyInfo)return{redos:[],undos:[]};const T=M.startX-y.startX,C=M.startY-y.startY,b=w-f,_=v-S;return this._generateMutations(u,{unitId:e,subUnitId:n,getTransform:(E,W)=>{var A,P;return{transform:{...E,left:((A=E==null?void 0:E.left)!=null?A:0)+T,top:((P=E==null?void 0:E.top)!=null?P:0)+C},sheetTransform:{...W,to:{...W.to,row:W.to.row+b,column:W.to.column+_},from:{...W.from,row:W.from.row+b,column:W.from.column+_}}}},isCut:d===O.COPY_TYPE.CUT})}};Ke=sn([Ue(0,O.ISheetClipboardService),Ue(1,B.IRenderManagerService),Ue(2,U.IDrawingManagerService),Ue(3,Y.IClipboardInterfaceService),Ue(4,l.ICommandService)],Ke);var un=Object.getOwnPropertyDescriptor,gn=(i,r,t,e)=>{for(var n=e>1?void 0:e?un(r,t):r,o=i.length-1,a;o>=0;o--)(a=i[o])&&(n=a(n)||n);return n},Ne=(i,r)=>(t,e)=>r(t,e,i);let ze=class extends l.Disposable{constructor(i,r,t,e,n){super(),this._drawingManagerService=i,this._renderManagerService=r,this._permissionService=t,this._univerInstanceService=e,this._userManagerService=n,this._initDrawingVisible(),this._initDrawingEditable(),this._initViewPermissionChange(),this._initEditPermissionChange()}_initDrawingVisible(){const i=this._univerInstanceService.getCurrentTypeOfUnit$(l.UniverInstanceType.UNIVER_SHEET),r=this._userManagerService.currentUser$,t=N.combineLatest([i,r]);this.disposeWithMe(t.pipe(N.switchMap(([e,n])=>e?e.activeSheet$.pipe(N.tap(o=>{if(!o){this._drawingManagerService.setDrawingVisible(!1);return}const a=e.getUnitId(),s=o.getSheetId();this._permissionService.composePermission([new I.WorkbookViewPermission(a).id,new I.WorksheetViewPermission(a,s).id]).every(g=>g.value)?this._drawingManagerService.setDrawingVisible(!0):this._handleDrawingVisibilityFalse(e,o)})):(this._drawingManagerService.setDrawingVisible(!1),N.EMPTY))).subscribe())}_handleDrawingVisibilityFalse(i,r){this._drawingManagerService.setDrawingVisible(!1);const t=i.getUnitId(),e=r.getSheetId(),n=this._drawingManagerService.getDrawingData(t,e),o=Object.values(n),a=this._renderManagerService.getRenderById(t),s=a==null?void 0:a.scene;if(!s)return;s.getAllObjectsByOrder().forEach(g=>{g.classType===B.RENDER_CLASS_TYPE.IMAGE&&o.some(u=>g.oKey.includes(u.drawingId))&&s.removeObject(g)})}_initDrawingEditable(){const i=this._univerInstanceService.getCurrentTypeOfUnit$(l.UniverInstanceType.UNIVER_SHEET),r=this._userManagerService.currentUser$,t=N.combineLatest([i,r]);this.disposeWithMe(t.pipe(N.switchMap(([e,n])=>e?e.activeSheet$.pipe(N.tap(o=>{if(!o){this._drawingManagerService.setDrawingEditable(!1);return}const a=e.getUnitId(),s=o.getSheetId();this._permissionService.composePermission([new I.WorkbookEditablePermission(a).id,new I.WorksheetEditPermission(a,s).id]).every(g=>g.value)?this._drawingManagerService.setDrawingEditable(!0):this._handleDrawingEditableFalse(e,o)})):(this._drawingManagerService.setDrawingEditable(!1),N.EMPTY))).subscribe())}_handleDrawingEditableFalse(i,r){this._drawingManagerService.setDrawingEditable(!1);const t=i.getUnitId(),e=r.getSheetId(),n=this._drawingManagerService.getDrawingData(t,e),o=Object.values(n),a=this._renderManagerService.getRenderById(t),s=a==null?void 0:a.scene;if(!s)return;s.getAllObjectsByOrder().forEach(g=>{g.classType===B.RENDER_CLASS_TYPE.IMAGE&&o.some(u=>g.oKey.includes(u.drawingId))&&s.detachTransformerFrom(g)})}_initViewPermissionChange(){const i=this._univerInstanceService.getCurrentTypeOfUnit$(l.UniverInstanceType.UNIVER_SHEET),r=this._userManagerService.currentUser$;this.disposeWithMe(N.combineLatest([i,r]).pipe(N.switchMap(([t,e])=>t?t.activeSheet$.pipe(N.switchMap(n=>{if(!n)return N.EMPTY;const o=t.getUnitId(),a=n.getSheetId(),s=this._renderManagerService.getRenderById(o),d=s==null?void 0:s.scene;if(!d)return N.EMPTY;const g=d.getTransformerByCreate();return this._permissionService.composePermission$([new I.WorkbookViewPermission(o).id,new I.WorksheetViewPermission(o,a).id]).pipe(N.map(c=>c.every(p=>p.value)),N.distinctUntilChanged()).pipe(N.map(c=>({permission:c,scene:d,transformer:g,unitId:o,subUnitId:a})))})):N.EMPTY)).subscribe({next:({permission:t,scene:e,transformer:n,unitId:o,subUnitId:a})=>{this._drawingManagerService.setDrawingVisible(t);const s=e.getAllObjectsByOrder(),d=this._drawingManagerService.getDrawingData(o,a),g=Object.values(d);t?this._drawingManagerService.addNotification(g):(s.forEach(u=>{u.classType===B.RENDER_CLASS_TYPE.IMAGE&&g.some(c=>u.oKey.includes(c.drawingId))&&e.removeObject(u)}),n.clearSelectedObjects())},complete:()=>{this._drawingManagerService.setDrawingVisible(!0);const t=this._univerInstanceService.getCurrentUnitForType(l.UniverInstanceType.UNIVER_SHEET),e=t==null?void 0:t.getActiveSheet(),n=t==null?void 0:t.getUnitId(),o=e==null?void 0:e.getSheetId();if(!n||!o)return;const a=this._drawingManagerService.getDrawingData(n,o),s=Object.values(a);this._drawingManagerService.addNotification(s)}}))}_initEditPermissionChange(){const i=this._univerInstanceService.getCurrentTypeOfUnit$(l.UniverInstanceType.UNIVER_SHEET),r=this._userManagerService.currentUser$;this.disposeWithMe(N.combineLatest([i,r]).pipe(N.switchMap(([t,e])=>t?t.activeSheet$.pipe(N.switchMap(n=>{if(!n)return N.EMPTY;const o=t.getUnitId(),a=n.getSheetId(),s=this._renderManagerService.getRenderById(o),d=s==null?void 0:s.scene;if(!d)return N.EMPTY;const g=d.getTransformerByCreate();return this._permissionService.composePermission$([new I.WorkbookEditablePermission(o).id,new I.WorksheetEditPermission(o,a).id]).pipe(N.map(c=>c.every(p=>p.value)),N.distinctUntilChanged()).pipe(N.map(c=>({permission:c,scene:d,transformer:g,unitId:o,subUnitId:a})))})):N.EMPTY)).subscribe({next:({permission:t,scene:e,transformer:n,unitId:o,subUnitId:a})=>{this._drawingManagerService.setDrawingEditable(t);const s=e.getAllObjectsByOrder(),d=this._drawingManagerService.getDrawingData(o,a),g=Object.values(d);t?(s.forEach(u=>{u.classType===B.RENDER_CLASS_TYPE.IMAGE&&g.some(c=>u.oKey.includes(c.drawingId))&&e.attachTransformerTo(u)}),this._drawingManagerService.addNotification(g)):(s.forEach(u=>{u.classType===B.RENDER_CLASS_TYPE.IMAGE&&g.some(c=>u.oKey.includes(c.drawingId))&&e.detachTransformerFrom(u)}),n.clearSelectedObjects())},complete:()=>{const t=this._univerInstanceService.getCurrentUnitForType(l.UniverInstanceType.UNIVER_SHEET);if(!t)return;const e=t.getUnitId(),n=t.getActiveSheet();if(!n)return;const o=n.getSheetId(),a=this._renderManagerService.getRenderById(e),s=a==null?void 0:a.scene;if(!s)return;const d=this._drawingManagerService.getDrawingData(e,o),g=Object.values(d);this._drawingManagerService.setDrawingEditable(!0),s.getAllObjectsByOrder().forEach(c=>{c.classType===B.RENDER_CLASS_TYPE.IMAGE&&g.some(p=>c.oKey.includes(p.drawingId))&&s.detachTransformerFrom(c)})}}))}};ze=gn([Ne(0,U.IDrawingManagerService),Ne(1,B.IRenderManagerService),Ne(2,l.IPermissionService),Ne(3,l.IUniverInstanceService),Ne(4,l.Inject(l.UserManagerService))],ze);var hn=Object.getOwnPropertyDescriptor,pn=(i,r,t,e)=>{for(var n=e>1?void 0:e?hn(r,t):r,o=i.length-1,a;o>=0;o--)(a=i[o])&&(n=a(n)||n);return n},qe=(i,r)=>(t,e)=>r(t,e,i);let Ze=class extends l.Disposable{constructor(i,r,t,e){super(),this._sheetPrintInterceptorService=i,this._drawingRenderService=r,this._drawingManagerService=t,this._renderManagerService=e,this._initPrinting()}_initPrinting(){this.disposeWithMe(this._sheetPrintInterceptorService.interceptor.intercept(this._sheetPrintInterceptorService.interceptor.getInterceptPoints().PRINTING_COMPONENT_COLLECT,{handler:(i,r,t)=>{const{unitId:e,scene:n,subUnitId:o}=r,a=this._drawingManagerService.getDrawingDataForUnit(e),s=a==null?void 0:a[o];return s&&s.order.forEach(d=>{this._drawingRenderService.renderDrawing(s.data[d],n)}),t()}})),this.disposeWithMe(this._sheetPrintInterceptorService.interceptor.intercept(this._sheetPrintInterceptorService.interceptor.getInterceptPoints().PRINTING_RANGE,{handler:(i,r,t)=>{const{unitId:e,subUnitId:n}=r,o=this._renderManagerService.getRenderById(e);if(!o)return t(i);const a=o.with(O.SheetSkeletonManagerService).getSkeletonParam(n);if(!a)return t(i);const s=this._drawingManagerService.getDrawingDataForUnit(e),d=s==null?void 0:s[r.subUnitId];if(!d)return t(i);const{scaleX:g,scaleY:u}=o.scene,c=i?{...i}:{startColumn:0,endColumn:0,endRow:0,startRow:0},p=d.order.map(h=>d.data[h]).filter(h=>h.drawingType!==l.DrawingTypeEnum.DRAWING_DOM);return p.length?(p.forEach(h=>{if(!h.groupId&&h.transform&&l.Tools.isDefine(h.transform.left)&&l.Tools.isDefine(h.transform.top)&&l.Tools.isDefine(h.transform.width)&&l.Tools.isDefine(h.transform.height)){const f=a.skeleton.getCellIndexByOffset(h.transform.left,h.transform.top,g,u,{x:0,y:0}),S=a.skeleton.getCellIndexByOffset(h.transform.left+h.transform.width,h.transform.top+h.transform.height,g,u,{x:0,y:0});f.column<c.startColumn&&(c.startColumn=f.column),f.row<c.startRow&&(c.startRow=f.row),c.endRow<S.row&&(c.endRow=S.row),c.endColumn<S.column&&(c.endColumn=S.column)}}),t(c)):t(i)}}))}};Ze=pn([qe(0,l.Inject(O.SheetPrintInterceptorService)),qe(1,l.Inject(pe.DrawingRenderService)),qe(2,U.IDrawingManagerService),qe(3,B.IRenderManagerService)],Ze);var mn=Object.getOwnPropertyDescriptor,fn=(i,r,t,e)=>{for(var n=e>1?void 0:e?mn(r,t):r,o=i.length-1,a;o>=0;o--)(a=i[o])&&(n=a(n)||n);return n},fe=(i,r)=>(t,e)=>r(t,e,i);const Sn=[I.InsertRowCommand.id,I.InsertColCommand.id,I.RemoveRowCommand.id,I.RemoveColCommand.id,I.DeleteRangeMoveLeftCommand.id,I.DeleteRangeMoveUpCommand.id,I.InsertRangeMoveDownCommand.id,I.InsertRangeMoveRightCommand.id,I.DeltaRowHeightCommand.id,I.SetRowHeightCommand.id,I.DeltaColumnWidthCommand.id,I.SetColWidthCommand.id,I.SetRowHiddenCommand.id,I.SetSpecificRowsVisibleCommand.id,I.SetSpecificColsVisibleCommand.id,I.SetColHiddenCommand.id,I.MoveColsCommand.id,I.MoveRowsCommand.id,I.MoveRangeCommand.id],wn=[I.SetRowVisibleMutation.id,I.SetRowHiddenMutation.id,I.SetColVisibleMutation.id,I.SetColHiddenMutation.id,I.SetWorksheetRowHeightMutation.id,I.SetWorksheetColWidthMutation.id];let _t=class extends l.Disposable{constructor(i,r,t,e,n,o,a,s,d){super(),this._context=i,this._renderManagerService=r,this._commandService=t,this._selectionRenderService=e,this._skeletonManagerService=n,this._sheetInterceptorService=o,this._sheetDrawingService=a,this._drawingManagerService=s,this._univerInstanceService=d,this._sheetInterceptorListener(),this._commandListener(),this._sheetRefreshListener()}_sheetInterceptorListener(){this.disposeWithMe(this._sheetInterceptorService.interceptCommand({getMutations:i=>{if(!Sn.includes(i.id))return{redos:[],undos:[]};if(i.params==null)return{redos:[],undos:[]};const r=i.id;if(r===I.InsertRowCommand.id)return this._moveRowInterceptor(i.params,"insert");if([I.MoveColsCommand.id,I.MoveRowsCommand.id,I.MoveRangeCommand.id].includes(r))return this._moveRangeInterceptor(i.params);if(r===I.InsertColCommand.id)return this._moveColInterceptor(i.params,"insert");if(r===I.RemoveRowCommand.id)return this._moveRowInterceptor(i.params,"remove");if(r===I.RemoveColCommand.id)return this._moveColInterceptor(i.params,"remove");if(r===I.DeleteRangeMoveLeftCommand.id){const{range:t}=i.params;return this._getRangeMoveUndo(t,0)}else if(r===I.DeleteRangeMoveUpCommand.id){const{range:t}=i.params;return this._getRangeMoveUndo(t,1)}else if(r===I.InsertRangeMoveDownCommand.id){const{range:t}=i.params;return this._getRangeMoveUndo(t,2)}else if(r===I.InsertRangeMoveRightCommand.id){const{range:t}=i.params;return this._getRangeMoveUndo(t,3)}else if(r===I.SetRowHiddenCommand.id||r===I.SetSpecificRowsVisibleCommand.id){const t=i.params,{unitId:e,subUnitId:n,ranges:o}=t;return this._getDrawingUndoForRowVisible(e,n,o)}else if(r===I.SetSpecificColsVisibleCommand.id||r===I.SetColHiddenCommand.id){const t=i.params,{unitId:e,subUnitId:n,ranges:o}=t;return this._getDrawingUndoForColVisible(e,n,o)}else if(r===I.DeltaRowHeightCommand.id||r===I.SetRowHeightCommand.id||r===I.DeltaColumnWidthCommand.id||r===I.SetColWidthCommand.id){const t=i.params,{unitId:e,subUnitId:n,ranges:o}=t,a=r===I.DeltaRowHeightCommand.id||r===I.SetRowHeightCommand.id;return this._getDrawingUndoForRowAndColSize(e,n,o,a)}return{redos:[],undos:[]}}}))}_getRangeMoveUndo(i,r){const t=I.getSheetCommandTarget(this._univerInstanceService);if(t==null)return{redos:[],undos:[]};const e=t.unitId,n=t.subUnitId,o=[],a=[],s=this._sheetDrawingService.getDrawingData(e,n),d=[],g=[];if(Object.keys(s).forEach(u=>{const c=s[u],{updateDrawings:p,deleteDrawings:h}=this._getUpdateOrDeleteDrawings(i,r,c);d.push(...p),g.push(...h)}),d.length===0&&g.length===0)return{redos:[],undos:[]};if(d.length>0){const u=this._sheetDrawingService.getBatchUpdateOp(d),{undo:c,redo:p,objects:h}=u;o.push({id:m.SetDrawingApplyMutation.id,params:{unitId:e,subUnitId:n,op:p,objects:h,type:m.DrawingApplyType.UPDATE}}),a.push({id:m.SetDrawingApplyMutation.id,params:{unitId:e,subUnitId:n,op:c,objects:h,type:m.DrawingApplyType.UPDATE}})}if(g.length>0){const u=this._sheetDrawingService.getBatchRemoveOp(g),c=u.undo,p=u.redo,h=u.objects;o.push({id:m.SetDrawingApplyMutation.id,params:{unitId:e,subUnitId:n,op:p,objects:h,type:m.DrawingApplyType.REMOVE}}),a.push({id:m.SetDrawingApplyMutation.id,params:{unitId:e,subUnitId:n,op:c,objects:h,type:m.DrawingApplyType.INSERT}})}return o.push({id:G.id,params:[e]}),a.push({id:G.id,params:[e]}),{redos:o,undos:a}}_getUpdateOrDeleteDrawings(i,r,t){const e=[],n=[],{sheetTransform:o,anchorType:a=m.SheetDrawingAnchorType.Position,transform:s,unitId:d,subUnitId:g,drawingId:u}=t,{from:c,to:p}=o,{row:h,column:f}=c,{row:S,column:w}=p;if(o==null||s==null)return{updateDrawings:e,deleteDrawings:n};const{startRow:v,endRow:y,startColumn:M,endColumn:T}=i;let C=null,b=null;if(r===0&&h>=v&&S<=y)if(f>=M&&w<=T)n.push({unitId:d,subUnitId:g,drawingId:u});else{const _=this._shrinkCol(o,s,M,T,a);C=_==null?void 0:_.newSheetTransform,b=_==null?void 0:_.newTransform}else if(r===1&&f>=M&&w<=T)if(h>=v&&S<=y)n.push({unitId:d,subUnitId:g,drawingId:u});else{const _=this._shrinkRow(o,s,v,y,a);C=_==null?void 0:_.newSheetTransform,b=_==null?void 0:_.newTransform}else if(r===2){const _=this._expandRow(o,s,v,y,a);C=_==null?void 0:_.newSheetTransform,b=_==null?void 0:_.newTransform}else if(r===3){const _=this._expandCol(o,s,M,T,a);C=_==null?void 0:_.newSheetTransform,b=_==null?void 0:_.newTransform}if(C!=null&&b!=null){const _=K(C,this._selectionRenderService,this._skeletonManagerService);e.push({...t,sheetTransform:C,transform:_})}return{updateDrawings:e,deleteDrawings:n}}_remainDrawingSize(i,r,t){const e=H({...i},this._selectionRenderService);e!=null&&r.push({...t,sheetTransform:e})}_getDrawingUndoForColVisible(i,r,t){const e=this._drawingManagerService.getDrawingData(i,r),n=[],o=[];if(Object.keys(e).forEach(u=>{const c=e[u],{sheetTransform:p,transform:h,anchorType:f=m.SheetDrawingAnchorType.Position}=c;if(f===m.SheetDrawingAnchorType.None)this._remainDrawingSize(h,n,c);else{const{from:S,to:w}=p,{row:v,column:y}=S,{row:M,column:T}=w;for(let C=0;C<t.length;C++){const b=t[C],{startRow:_,endRow:k,startColumn:E,endColumn:W}=b;if(T<E)continue;if(f===m.SheetDrawingAnchorType.Position){let D=null,L=null;if(y>=E&&y<=W){const j=this._skeletonManagerService.attachRangeWithCoord({startColumn:y,endColumn:W,startRow:S.row,endRow:w.row});if(j==null)return;L={...h,left:j.startX}}if(L!=null&&(D=H(L,this._selectionRenderService),D!=null&&L!=null)){n.push({...c,sheetTransform:D,transform:L});break}this._remainDrawingSize(h,n,c);continue}if(y>=E&&T<=W)continue;let A=null,P=null;if(y>=E&&y<=W){const D=this._skeletonManagerService.attachRangeWithCoord({startColumn:y,endColumn:W,startRow:S.row,endRow:w.row});if(D==null)return;P={...h,left:(D==null?void 0:D.startX)||0,width:((h==null?void 0:h.width)||0)-D.endX+D.startX}}else if(T>=E&&T<=W){const D=this._skeletonManagerService.attachRangeWithCoord({startColumn:E,endColumn:T,startRow:S.row,endRow:w.row});if(D==null)return;P={...h,left:D.startX-((h==null?void 0:h.width)||0)}}else{const D=this._skeletonManagerService.attachRangeWithCoord({startColumn:E,endColumn:W,startRow:S.row,endRow:w.row});if(D==null)return;if(P={...h,width:((h==null?void 0:h.width)||0)-D.endX+D.startX},A=H(P,this._selectionRenderService),A!=null&&P!=null){o.push({...c,sheetTransform:A,transform:P});break}}if(P!=null&&(A=H(P,this._selectionRenderService)),P!=null&&A!=null){n.push({...c,sheetTransform:A,transform:P});break}else this._remainDrawingSize(h,n,c)}}}),n.length===0&&o.length===0)return{redos:[],undos:[]};const{redos:a,undos:s}=this._createUndoAndRedoMutation(i,r,n),d=[],g=[];if(o.length>0){const{redos:u,undos:c}=this._createUndoAndRedoMutation(i,r,o);d.push(...u),g.push(...c)}return{redos:a,undos:s,preRedos:d,preUndos:g}}_createUndoAndRedoMutation(i,r,t){const e=this._sheetDrawingService.getBatchUpdateOp(t),{undo:n,redo:o,objects:a}=e,s=[{id:m.SetDrawingApplyMutation.id,params:{unitId:i,subUnitId:r,op:o,objects:a,type:m.DrawingApplyType.UPDATE}},{id:G.id,params:[i]}],d=[{id:m.SetDrawingApplyMutation.id,params:{unitId:i,subUnitId:r,op:n,objects:a,type:m.DrawingApplyType.UPDATE}},{id:G.id,params:[i]}];return{redos:s,undos:d}}_getDrawingUndoForRowVisible(i,r,t){const e=this._drawingManagerService.getDrawingData(i,r),n=[],o=[];if(Object.keys(e).forEach(u=>{const c=e[u],{sheetTransform:p,transform:h,anchorType:f=m.SheetDrawingAnchorType.Position}=c;if(f===m.SheetDrawingAnchorType.None)this._remainDrawingSize(h,n,c);else{const{from:S,to:w}=p,{row:v,column:y}=S,{row:M,column:T}=w;for(let C=0;C<t.length;C++){const b=t[C],{startRow:_,endRow:k,startColumn:E,endColumn:W}=b;if(M<_)continue;if(f===m.SheetDrawingAnchorType.Position){let D=null,L=null;if(v>=_&&v<=k){const j=this._skeletonManagerService.attachRangeWithCoord({startColumn:S.column,endColumn:w.column,startRow:v,endRow:k});if(j==null)return;L={...h,top:j.startY}}if(L!=null&&(D=H(L,this._selectionRenderService),D!=null&&L!=null)){n.push({...c,sheetTransform:D,transform:L});break}this._remainDrawingSize(h,n,c);continue}if(v>=_&&M<=k)continue;let A=null,P=null;if(v>=_&&v<=k){const D=this._skeletonManagerService.attachRangeWithCoord({startColumn:S.column,endColumn:w.column,startRow:v,endRow:k});if(D==null)return;P={...h,top:(D==null?void 0:D.startY)||0,height:((h==null?void 0:h.height)||0)-D.endY+D.startY}}else if(M>=_&&M<=k){const D=this._skeletonManagerService.attachRangeWithCoord({startColumn:S.column,endColumn:w.column,startRow:_,endRow:M});if(D==null)return;P={...h,top:D.startY-((h==null?void 0:h.height)||0)}}else{const D=this._skeletonManagerService.attachRangeWithCoord({startColumn:S.column,endColumn:w.column,startRow:_,endRow:k});if(D==null)return;if(P={...h,height:((h==null?void 0:h.height)||0)-D.endY+D.startY},A=H(P,this._selectionRenderService),A!=null&&P!=null){o.push({...c,sheetTransform:A,transform:P});break}}if(P!=null&&(A=H(P,this._selectionRenderService)),P!=null&&A!=null){n.push({...c,sheetTransform:A,transform:P});break}else this._remainDrawingSize(h,n,c)}}}),n.length===0&&o.length===0)return{redos:[],undos:[]};const{redos:a,undos:s}=this._createUndoAndRedoMutation(i,r,n),d=[],g=[];if(o.length>0){const{redos:u,undos:c}=this._createUndoAndRedoMutation(i,r,o);d.push(...u),g.push(...c)}return{redos:a,undos:s,preRedos:d,preUndos:g}}_getDrawingUndoForRowAndColSize(i,r,t,e){const n=this._drawingManagerService.getDrawingData(i,r),o=[];return Object.keys(n).forEach(a=>{const s=n[a],{sheetTransform:d,transform:g,anchorType:u=m.SheetDrawingAnchorType.Position}=s;if(u===m.SheetDrawingAnchorType.None)this._remainDrawingSize(g,o,s);else{const{from:c,to:p}=d,{row:h,column:f}=c,{row:S,column:w}=p;for(let v=0;v<t.length;v++){const y=t[v],{startRow:M,endRow:T,startColumn:C,endColumn:b}=y;if(S<M||w<C)continue;if(u===m.SheetDrawingAnchorType.Position&&(h<=M&&S>=T||f<=C&&w>=b)){this._remainDrawingSize(g,o,s);continue}const _=K({...d},this._selectionRenderService,this._skeletonManagerService);if(_!=null){o.push({...s,transform:_});break}}}}),o.length===0?{redos:[],undos:[]}:this._createUndoAndRedoMutation(i,r,o)}_getUnitIdAndSubUnitId(i,r){let t,e;if(r==="insert")t=i.unitId,e=i.subUnitId;else{const n=I.getSheetCommandTarget(this._univerInstanceService);if(n==null)return;t=n.unitId,e=n.subUnitId}return{unitId:t,subUnitId:e}}_moveRangeInterceptor(i){var M,T;const{toRange:r,fromRange:t}=i,e=I.getSheetCommandTarget(this._univerInstanceService);if(!e)return{redos:[],undos:[]};const{unitId:n,subUnitId:o}=e,a=(T=(M=this._renderManagerService.getRenderById(n))==null?void 0:M.with(O.SheetSkeletonManagerService))==null?void 0:T.getCurrentSkeleton();if(!a)return{redos:[],undos:[]};const s=O.attachRangeWithCoord(a,t);if(!s)return{redos:[],undos:[]};const{startX:d,endX:g,startY:u,endY:c}=s,p=this._sheetDrawingService.getDrawingData(n,o),h=[];Object.keys(p).forEach(C=>{const b=p[C];if(b.anchorType!==m.SheetDrawingAnchorType.Both)return;const{transform:_}=b;if(!_)return;const{left:k=0,top:E=0,width:W=0,height:A=0}=_,{drawingStartX:P,drawingEndX:D,drawingStartY:L,drawingEndY:j}={drawingStartX:k,drawingEndX:k+W,drawingStartY:E,drawingEndY:E+A};d<=P&&D<=g&&u<=L&&j<=c&&h.push(b)});const f=[],S=[],w=r.startRow-t.startRow,v=r.startColumn-t.startColumn,y=h.map(C=>{const b=C.sheetTransform,_={to:{...b.to,row:b.to.row+w,column:b.to.column+v},from:{...b.from,row:b.from.row+w,column:b.from.column+v}},k=K(_,this._selectionRenderService,this._skeletonManagerService);return{unitId:n,subUnitId:o,drawingId:C.drawingId,transform:k,sheetTransform:_}});if(y.length){const C=this._sheetDrawingService.getBatchUpdateOp(y),{undo:b,redo:_,objects:k}=C;f.push({id:m.SetDrawingApplyMutation.id,params:{unitId:n,subUnitId:o,op:_,objects:k,type:m.DrawingApplyType.UPDATE}}),S.push({id:m.SetDrawingApplyMutation.id,params:{unitId:n,subUnitId:o,op:b,objects:k,type:m.DrawingApplyType.UPDATE}})}return{redos:f,undos:S}}_moveRowInterceptor(i,r){const t=this._getUnitIdAndSubUnitId(i,r);if(t==null)return{redos:[],undos:[]};const{unitId:e,subUnitId:n}=t,{range:o}=i,a=o.startRow,s=o.endRow,d=[],g=[],u=this._sheetDrawingService.getDrawingData(e,n),c=[],p=[];if(Object.keys(u).forEach(h=>{const f=u[h],{sheetTransform:S,transform:w,anchorType:v=m.SheetDrawingAnchorType.Position}=f;if(S==null||w==null)return;let y,M;if(r==="insert"){const C=this._expandRow(S,w,a,s,v);y=C==null?void 0:C.newSheetTransform,M=C==null?void 0:C.newTransform}else{const{from:C,to:b}=S,{row:_}=C,{row:k}=b;if(v===m.SheetDrawingAnchorType.Both&&_>=a&&k<=s)p.push({unitId:e,subUnitId:n,drawingId:h});else{const E=this._shrinkRow(S,w,a,s,v);y=E==null?void 0:E.newSheetTransform,M=E==null?void 0:E.newTransform}}if(!y||!M)return;const T={unitId:e,subUnitId:n,drawingId:h,transform:M,sheetTransform:y};c.push(T)}),c.length===0&&p.length===0)return{redos:[],undos:[]};if(c.length>0){const h=this._sheetDrawingService.getBatchUpdateOp(c),{undo:f,redo:S,objects:w}=h;d.push({id:m.SetDrawingApplyMutation.id,params:{unitId:e,subUnitId:n,op:S,objects:w,type:m.DrawingApplyType.UPDATE}}),g.push({id:m.SetDrawingApplyMutation.id,params:{unitId:e,subUnitId:n,op:f,objects:w,type:m.DrawingApplyType.UPDATE}})}if(p.length>0){const h=this._sheetDrawingService.getBatchRemoveOp(p),f=h.undo,S=h.redo,w=h.objects;d.push({id:m.SetDrawingApplyMutation.id,params:{unitId:e,subUnitId:n,op:S,objects:w,type:m.DrawingApplyType.REMOVE}}),g.push({id:m.SetDrawingApplyMutation.id,params:{unitId:e,subUnitId:n,op:f,objects:w,type:m.DrawingApplyType.INSERT}})}return d.push({id:G.id,params:[e]}),g.push({id:G.id,params:[e]}),{redos:d,undos:g}}_moveColInterceptor(i,r){const t=this._getUnitIdAndSubUnitId(i,r);if(t==null)return{redos:[],undos:[]};const{unitId:e,subUnitId:n}=t,{range:o}=i,a=o.startColumn,s=o.endColumn,d=[],g=[],u=this._sheetDrawingService.getDrawingData(e,n),c=[],p=[];if(Object.keys(u).forEach(h=>{const f=u[h],{sheetTransform:S,transform:w,anchorType:v=m.SheetDrawingAnchorType.Position}=f;if(S==null||w==null)return;let y,M;if(r==="insert"){const C=this._expandCol(S,w,a,s,v);y=C==null?void 0:C.newSheetTransform,M=C==null?void 0:C.newTransform}else{const{from:C,to:b}=S,{column:_}=C,{column:k}=b;if(v===m.SheetDrawingAnchorType.Both&&_>=a&&k<=s)p.push({unitId:e,subUnitId:n,drawingId:h});else{const E=this._shrinkCol(S,w,a,s,v);y=E==null?void 0:E.newSheetTransform,M=E==null?void 0:E.newTransform}}if(!y||!M)return;const T={unitId:e,subUnitId:n,drawingId:h,transform:M,sheetTransform:y};c.push(T)}),c.length===0&&p.length===0)return{redos:[],undos:[]};if(c.length>0){const h=this._sheetDrawingService.getBatchUpdateOp(c),{undo:f,redo:S,objects:w}=h;d.push({id:m.SetDrawingApplyMutation.id,params:{unitId:e,subUnitId:n,op:S,objects:w,type:m.DrawingApplyType.UPDATE}}),g.push({id:m.SetDrawingApplyMutation.id,params:{unitId:e,subUnitId:n,op:f,objects:w,type:m.DrawingApplyType.UPDATE}})}if(p.length>0){const h=this._sheetDrawingService.getBatchRemoveOp(p),f=h.undo,S=h.redo,w=h.objects;d.push({id:m.SetDrawingApplyMutation.id,params:{unitId:e,subUnitId:n,op:S,objects:w,type:m.DrawingApplyType.REMOVE}}),g.push({id:m.SetDrawingApplyMutation.id,params:{unitId:e,subUnitId:n,op:f,objects:w,type:m.DrawingApplyType.INSERT}})}return d.push({id:G.id,params:[e]}),g.push({id:G.id,params:[e]}),{redos:d,undos:g}}_expandCol(i,r,t,e,n=m.SheetDrawingAnchorType.Position){const o=e-t+1,{from:a,to:s}=i,{column:d}=a,{column:g}=s;if(n===m.SheetDrawingAnchorType.None)return{newSheetTransform:H({...r},this._selectionRenderService),newTransform:r};let u=null,c=null;if(d>=t){const p=this._skeletonManagerService.attachRangeWithCoord({startColumn:t,endColumn:e,startRow:a.row,endRow:s.row});if(p==null)return;c={...r,left:(r.left||0)+p.endX-p.startX},u=H(c,this._selectionRenderService)}else if(g>=e)if(n===m.SheetDrawingAnchorType.Both)u={from:{...a},to:{...s,column:g+o}},c=K(u,this._selectionRenderService,this._skeletonManagerService);else return{newSheetTransform:H({...r},this._selectionRenderService),newTransform:r};return u!=null&&c!=null?{newSheetTransform:u,newTransform:c}:null}_shrinkCol(i,r,t,e,n=m.SheetDrawingAnchorType.Position){const o=e-t+1,{from:a,to:s}=i,{column:d}=a,{column:g}=s;if(n===m.SheetDrawingAnchorType.None)return{newSheetTransform:H({...r},this._selectionRenderService),newTransform:r};let u=null,c=null;if(d>e)u={from:{...a,column:d-o},to:{...s,column:g-o}},c=K(u,this._selectionRenderService,this._skeletonManagerService);else{if(d>=t&&g<=e)return null;if(d<t&&g>e)if(n===m.SheetDrawingAnchorType.Both)u={from:{...a},to:{...s,column:g-o}},c=K(u,this._selectionRenderService,this._skeletonManagerService);else return{newSheetTransform:H({...r},this._selectionRenderService),newTransform:r};else if(d>=t&&d<=e){if(d===t)c={...r,left:(r.left||0)-i.from.columnOffset};else{const p=this._skeletonManagerService.attachRangeWithCoord({startColumn:t,endColumn:d-1,startRow:a.row,endRow:s.row});if(p==null)return;c={...r,left:(r.left||0)-p.endX+p.startX-i.from.columnOffset}}u=H(c,this._selectionRenderService)}else if(g>=t&&g<=e&&n===m.SheetDrawingAnchorType.Both){const p=this._skeletonManagerService.attachRangeWithCoord({startColumn:t-1,endColumn:t-1,startRow:a.row,endRow:s.row});if(p==null)return;u={from:{...a},to:{...s,column:t-1,columnOffset:p.endX-p.startX}},c=K(u,this._selectionRenderService,this._skeletonManagerService)}}return u!=null&&c!=null?{newSheetTransform:u,newTransform:c}:null}_expandRow(i,r,t,e,n=m.SheetDrawingAnchorType.Position){const o=e-t+1,{from:a,to:s}=i,{row:d}=a,{row:g}=s;if(n===m.SheetDrawingAnchorType.None)return{newSheetTransform:H({...r},this._selectionRenderService),newTransform:r};let u=null,c=null;if(d>=t){const p=this._skeletonManagerService.attachRangeWithCoord({startRow:t,endRow:e,startColumn:a.column,endColumn:s.column});if(p==null)return;c={...r,top:(r.top||0)+p.endY-p.startY},u=H(c,this._selectionRenderService)}else if(g>=e)if(n===m.SheetDrawingAnchorType.Both)u={from:{...a},to:{...s,row:g+o}},c=K(u,this._selectionRenderService,this._skeletonManagerService);else return{newSheetTransform:H({...r},this._selectionRenderService),newTransform:r};return u!=null&&c!=null?{newSheetTransform:u,newTransform:c}:null}_shrinkRow(i,r,t,e,n=m.SheetDrawingAnchorType.Position){const o=e-t+1,{from:a,to:s}=i,{row:d}=a,{row:g}=s;if(n===m.SheetDrawingAnchorType.None)return{newSheetTransform:H({...r},this._selectionRenderService),newTransform:r};let u=null,c=null;if(d>e)u={from:{...a,row:d-o},to:{...s,row:g-o}},c=K(u,this._selectionRenderService,this._skeletonManagerService);else{if(d>=t&&g<=e)return null;if(d<t&&g>e)if(n===m.SheetDrawingAnchorType.Both)u={from:{...a},to:{...s,row:g-o}},c=K(u,this._selectionRenderService,this._skeletonManagerService);else return{newSheetTransform:H({...r},this._selectionRenderService),newTransform:r};else if(d>=t&&d<=e){if(d===t)c={...r,top:(r.top||0)-i.from.rowOffset};else{const p=this._skeletonManagerService.attachRangeWithCoord({startRow:t,endRow:d-1,startColumn:a.column,endColumn:s.column});if(p==null)return;c={...r,top:(r.top||0)-p.endY+p.startY-i.from.rowOffset}}u=H(c,this._selectionRenderService)}else if(g>=t&&g<=e&&n===m.SheetDrawingAnchorType.Both){const p=this._skeletonManagerService.attachRangeWithCoord({startColumn:a.column,endColumn:a.column,startRow:t-1,endRow:t-1});if(p==null)return;u={from:{...a},to:{...s,row:t-1,rowOffset:p.endY-p.startY}},c=K(u,this._selectionRenderService,this._skeletonManagerService)}}return u!=null&&c!=null?{newSheetTransform:u,newTransform:c}:null}_commandListener(){this.disposeWithMe(this._commandService.onCommandExecuted(i=>{if(i.id===I.SetWorksheetActiveOperation.id){const{unitId:r,subUnitId:t}=i.params;this._updateDrawings(r,t)}})),this.disposeWithMe(this._context.activated$.subscribe(i=>{const{unit:r,unitId:t}=this._context;if(i){const e=r.getActiveSheet().getSheetId();this._updateDrawings(t,e)}else this._clearDrawings(t)}))}_clearDrawings(i){setTimeout(()=>{const r=this._drawingManagerService.drawingManagerData,t=[];Object.keys(r).forEach(e=>{const n=r[e];n!=null&&Object.keys(n).forEach(o=>{const a=n[o].data;a!=null&&Object.keys(a).forEach(s=>{e===i&&t.push(a[s])})})}),this._drawingManagerService.removeNotification(t)})}_updateDrawings(i,r){setTimeout(()=>{const t=this._drawingManagerService.drawingManagerData,e=[],n=[];Object.keys(t).forEach(o=>{const a=t[o];a!=null&&Object.keys(a).forEach(s=>{const d=a[s].data;d!=null&&Object.keys(d).forEach(g=>{if(o===i&&s===r){const u=d[g];u.transform=K(u.sheetTransform,this._selectionRenderService,this._skeletonManagerService),e.push(d[g])}else n.push(d[g])})})}),this._drawingManagerService.removeNotification(n),this._drawingManagerService.addNotification(e)},0)}_sheetRefreshListener(){this.disposeWithMe(this._commandService.onCommandExecuted(i=>{wn.includes(i.id)&&requestIdleCallback(()=>{const r=i.params,{unitId:t,subUnitId:e,ranges:n}=r;this._refreshDrawingTransform(t,e,n)})}))}_refreshDrawingTransform(i,r,t){const e=this._drawingManagerService.getDrawingData(i,r),n=[];Object.keys(e).forEach(o=>{const a=e[o],{sheetTransform:s,transform:d,anchorType:g=m.SheetDrawingAnchorType.Position}=a;if(g===m.SheetDrawingAnchorType.None)return!0;const{from:u,to:c}=s,{row:p,column:h}=u,{row:f,column:S}=c;for(let w=0;w<t.length;w++){const v=t[w],{startRow:y,endRow:M,startColumn:T,endColumn:C}=v;if(l.Rectangle.intersects({startRow:y,endRow:M,startColumn:T,endColumn:C},{startRow:p,endRow:f,startColumn:h,endColumn:S})||p>M||h>C){const b=g===m.SheetDrawingAnchorType.Position,_=K(s,this._selectionRenderService,this._skeletonManagerService);n.push({...a,transform:{..._,width:b?d==null?void 0:d.width:_==null?void 0:_.width,height:b?d==null?void 0:d.height:_==null?void 0:_.height}});break}}}),n.length!==0&&(this._drawingManagerService.refreshTransform(n),this._commandService.syncExecuteCommand(G.id,[i]))}};_t=fn([fe(1,B.IRenderManagerService),fe(2,l.ICommandService),fe(3,O.ISheetSelectionRenderService),fe(4,l.Inject(O.SheetSkeletonManagerService)),fe(5,l.Inject(I.SheetInterceptorService)),fe(6,m.ISheetDrawingService),fe(7,U.IDrawingManagerService),fe(8,l.IUniverInstanceService)],_t);var ie=function(){return ie=Object.assign||function(i){for(var r,t=1,e=arguments.length;t<e;t++){r=arguments[t];for(var n in r)Object.prototype.hasOwnProperty.call(r,n)&&(i[n]=r[n])}return i},ie.apply(this,arguments)},vn=function(i,r){var t={};for(var e in i)Object.prototype.hasOwnProperty.call(i,e)&&r.indexOf(e)<0&&(t[e]=i[e]);if(i!=null&&typeof Object.getOwnPropertySymbols=="function")for(var n=0,e=Object.getOwnPropertySymbols(i);n<e.length;n++)r.indexOf(e[n])<0&&Object.prototype.propertyIsEnumerable.call(i,e[n])&&(t[e[n]]=i[e[n]]);return t},At=ne.forwardRef(function(i,r){var t=i.icon,e=i.id,n=i.className,o=i.extend,a=vn(i,["icon","id","className","extend"]),s="univerjs-icon univerjs-icon-".concat(e," ").concat(n||"").trim(),d=ne.useRef("_".concat(yn()));return Ut(t,"".concat(e),{defIds:t.defIds,idSuffix:d.current},ie({ref:r,className:s},a),o)});function Ut(i,r,t,e,n){return ne.createElement(i.tag,ie(ie({key:r},_n(i,t,n)),e),(In(i,t).children||[]).map(function(o,a){return Ut(o,"".concat(r,"-").concat(i.tag,"-").concat(a),t,void 0,n)}))}function _n(i,r,t){var e=ie({},i.attrs);t!=null&&t.colorChannel1&&e.fill==="colorChannel1"&&(e.fill=t.colorChannel1),i.tag==="mask"&&e.id&&(e.id=e.id+r.idSuffix),Object.entries(e).forEach(function(o){var a=o[0],s=o[1];a==="mask"&&typeof s=="string"&&(e[a]=s.replace(/url\(#(.*)\)/,"url(#$1".concat(r.idSuffix,")")))});var n=r.defIds;return!n||n.length===0||(i.tag==="use"&&e["xlink:href"]&&(e["xlink:href"]=e["xlink:href"]+r.idSuffix),Object.entries(e).forEach(function(o){var a=o[0],s=o[1];typeof s=="string"&&(e[a]=s.replace(/url\(#(.*)\)/,"url(#$1".concat(r.idSuffix,")")))})),e}function In(i,r){var t,e=r.defIds;return!e||e.length===0?i:i.tag==="defs"&&(!((t=i.children)===null||t===void 0)&&t.length)?ie(ie({},i),{children:i.children.map(function(n){return typeof n.attrs.id=="string"&&e&&e.indexOf(n.attrs.id)>-1?ie(ie({},n),{attrs:ie(ie({},n.attrs),{id:n.attrs.id+r.idSuffix})}):n})}):i}function yn(){return Math.random().toString(36).substring(2,8)}At.displayName="UniverIcon";var Cn={tag:"svg",attrs:{fill:"none",viewBox:"0 0 16 16",width:"1em",height:"1em"},children:[{tag:"path",attrs:{fill:"currentColor",d:"M2.2498 3.65005C2.2498 2.87685 2.87661 2.25005 3.64981 2.25005H7.9998C8.33118 2.25005 8.5998 1.98142 8.5998 1.65005C8.5998 1.31868 8.33118 1.05005 7.9998 1.05005H3.64981C2.21387 1.05005 1.0498 2.21411 1.0498 3.65005V12.35C1.0498 13.786 2.21386 14.95 3.6498 14.95H12.3498C13.7857 14.95 14.9498 13.786 14.9498 12.3501V8.00005C14.9498 7.66868 14.6812 7.40005 14.3498 7.40005C14.0184 7.40005 13.7498 7.66868 13.7498 8.00005V9.23974L12.2385 8.1063C11.7252 7.72129 11.0068 7.7723 10.5531 8.22605L9.00869 9.77041L6.73916 7.8251C6.24387 7.40055 5.5095 7.41278 5.02864 7.85359L2.2498 10.4009V3.65005ZM2.2498 12.0287V12.35C2.2498 13.1232 2.87661 13.75 3.6498 13.75H12.3498C13.123 13.75 13.7498 13.1232 13.7498 12.3501V10.7397L11.5186 9.06631C11.4829 9.03956 11.433 9.04314 11.4016 9.07458L9.92249 10.5537L11.1015 11.5642C11.3531 11.7799 11.3822 12.1587 11.1666 12.4103C10.9509 12.6619 10.5721 12.691 10.3205 12.4753L5.9582 8.7362C5.92384 8.70674 5.87288 8.70758 5.83952 8.73816L2.2498 12.0287Z",fillRule:"evenodd",clipRule:"evenodd"}},{tag:"path",attrs:{fill:"currentColor",d:"M11.8097 1.14783C12.1411 1.14783 12.4097 1.41646 12.4097 1.74783V3.297H14.1541C14.4855 3.297 14.7541 3.56563 14.7541 3.897C14.7541 4.22837 14.4855 4.497 14.1541 4.497H12.4097V6.24167C12.4097 6.57304 12.1411 6.84167 11.8097 6.84167C11.4783 6.84167 11.2097 6.57304 11.2097 6.24167V4.497H9.6603C9.32893 4.497 9.0603 4.22837 9.0603 3.897C9.0603 3.56563 9.32893 3.297 9.6603 3.297H11.2097V1.74783C11.2097 1.41646 11.4783 1.14783 11.8097 1.14783Z"}}]},Nt=ne.forwardRef(function(i,r){return ne.createElement(At,Object.assign({},i,{id:"add-image-single",ref:r,icon:Cn}))});Nt.displayName="AddImageSingle";const It={id:"sheet.command.delete-drawing",type:l.CommandType.COMMAND,handler:i=>{const r=i.get(l.ICommandService),e=i.get(m.ISheetDrawingService).getFocusDrawings();if(e.length===0)return!1;const n=e[0].unitId,o=e.map(a=>{const{unitId:s,subUnitId:d,drawingId:g,drawingType:u}=a;return{unitId:s,subUnitId:d,drawingId:g,drawingType:u}});return r.executeCommand(_e.id,{unitId:n,drawings:o})}},ye={id:"sheet.command.move-drawing",type:l.CommandType.COMMAND,handler:(i,r)=>{const t=i.get(l.ICommandService),e=i.get(m.ISheetDrawingService),n=i.get(O.ISheetSelectionRenderService),{direction:o}=r,a=e.getFocusDrawings();if(a.length===0)return!1;const s=a[0].unitId,d=a.map(u=>{const{transform:c}=u;if(c==null)return null;const p={...c},{left:h=0,top:f=0}=c;return o===l.Direction.UP?p.top=f-1:o===l.Direction.DOWN?p.top=f+1:o===l.Direction.LEFT?p.left=h-1:o===l.Direction.RIGHT&&(p.left=h+1),{...u,transform:p,sheetTransform:H(p,n)}}).filter(u=>u!=null);return t.syncExecuteCommand(Pe.id,{unitId:s,drawings:d})?(t.syncExecuteCommand(G.id,[s]),!0):!1}},kt="addition-and-subtraction-single",yt="sheet.menu.image";function Dn(i){return{id:yt,type:Y.MenuItemType.SUBITEMS,icon:kt,tooltip:"sheetImage.title",hidden$:Y.getMenuHiddenObservable(i,l.UniverInstanceType.UNIVER_SHEET),disabled$:O.getCurrentRangeDisable$(i,{workbookTypes:[I.WorkbookEditablePermission],worksheetTypes:[I.WorksheetEditPermission],rangeTypes:[I.RangeProtectionPermissionEditPoint]})}}function Mn(i){return{id:Ae.id,title:"sheetImage.upload.float",type:Y.MenuItemType.BUTTON,hidden$:Y.getMenuHiddenObservable(i,l.UniverInstanceType.UNIVER_SHEET)}}function Tn(i){return{id:vt.id,title:"sheetImage.upload.cell",type:Y.MenuItemType.BUTTON,hidden$:Y.getMenuHiddenObservable(i,l.UniverInstanceType.UNIVER_SHEET)}}const Se={imageCommonPanel:"univer-image-common-panel",imageCommonPanelGrid:"univer-image-common-panel-grid",imageCommonPanelBorder:"univer-image-common-panel-border",imageCommonPanelTitle:"univer-image-common-panel-title",imageCommonPanelRow:"univer-image-common-panel-row",imageCommonPanelColumn:"univer-image-common-panel-column"},bn=i=>{var M;const r=Y.useDependency(l.ICommandService),t=Y.useDependency(l.LocaleService),e=Y.useDependency(U.IDrawingManagerService),n=Y.useDependency(B.IRenderManagerService),{drawings:o}=i,a=o[0];if(a==null)return;const{unitId:s}=a,d=n.getRenderById(s),g=d==null?void 0:d.scene;if(g==null)return;const u=g.getTransformerByCreate(),[c,p]=ne.useState(!0),h=(M=a.anchorType)!=null?M:m.SheetDrawingAnchorType.Position,[f,S]=ne.useState(h);function w(T,C){const b=[];return T.forEach(_=>{const{oKey:k}=_,E=C.getDrawingOKey(k);if(E==null)return b.push(null),!0;const{unitId:W,subUnitId:A,drawingId:P,drawingType:D,anchorType:L,sheetTransform:j}=E;b.push({unitId:W,subUnitId:A,drawingId:P,anchorType:L,sheetTransform:j,drawingType:D})}),b}ne.useEffect(()=>{const T=u.clearControl$.subscribe(b=>{b===!0&&p(!1)}),C=u.changeStart$.subscribe(b=>{var E;const{objects:_}=b,k=w(_,e);if(k.length===0)p(!1);else if(k.length>=1){p(!0);const W=((E=k[0])==null?void 0:E.anchorType)||m.SheetDrawingAnchorType.Position;S(W)}});return()=>{C.unsubscribe(),T.unsubscribe()}},[]);function v(T){S(T);const C=e.getFocusDrawings();if(C.length===0)return;const b=C.map(_=>({unitId:_.unitId,subUnitId:_.subUnitId,drawingId:_.drawingId,anchorType:T}));r.executeCommand(Pe.id,{unitId:C[0].unitId,drawings:b})}const y=T=>T?"block":"none";return x.jsxs("div",{className:q.clsx(Se.imageCommonPanelGrid,Se.imageCommonPanelBorder),style:{display:y(c)},children:[x.jsx("div",{className:Se.imageCommonPanelRow,children:x.jsx("div",{className:q.clsx(Se.imageCommonPanelColumn,Se.imageCommonPanelTitle),children:x.jsx("div",{children:t.t("drawing-anchor.title")})})}),x.jsx("div",{className:q.clsx(Se.imageCommonPanelRow),children:x.jsx("div",{className:q.clsx(Se.imageCommonPanelColumn),children:x.jsxs(q.RadioGroup,{value:f,onChange:v,direction:"vertical",children:[x.jsx(q.Radio,{value:m.SheetDrawingAnchorType.Both,children:t.t("drawing-anchor.both")}),x.jsx(q.Radio,{value:m.SheetDrawingAnchorType.Position,children:t.t("drawing-anchor.position")}),x.jsx(q.Radio,{value:m.SheetDrawingAnchorType.None,children:t.t("drawing-anchor.none")})]})})})]})},Rn=()=>{const i=Y.useDependency(U.IDrawingManagerService),r=i.getFocusDrawings(),[t,e]=ne.useState(r);return ne.useEffect(()=>{const n=i.focus$.subscribe(o=>{e(o)});return()=>{n.unsubscribe()}},[]),!!(t!=null&&t.length)&&x.jsxs("div",{className:Se.imageCommonPanel,children:[x.jsx(pe.DrawingCommonPanel,{drawings:t}),x.jsx(bn,{drawings:t})]})},En={[Y.RibbonStartGroup.FORMULAS_INSERT]:{[yt]:{order:3,menuItemFactory:Dn,[Ae.id]:{order:0,menuItemFactory:Mn},[vt.id]:{order:1,menuItemFactory:Tn}}}};function ke(i){return!i.getContextValue(l.FOCUSING_FX_BAR_EDITOR)&&!i.getContextValue(l.EDITOR_ACTIVATED)&&!i.getContextValue(l.FOCUSING_PANEL_EDITOR)&&i.getContextValue(l.FOCUSING_COMMON_DRAWINGS)}const On={id:ye.id,description:"shortcut.sheet.drawing-move-down",group:"4_sheet-drawing-view",binding:Y.KeyCode.ARROW_DOWN,priority:100,preconditions:ke,staticParameters:{direction:l.Direction.DOWN}},Pn={id:ye.id,description:"shortcut.sheet.drawing-move-up",group:"4_sheet-drawing-view",binding:Y.KeyCode.ARROW_UP,priority:100,preconditions:ke,staticParameters:{direction:l.Direction.UP}},An={id:ye.id,description:"shortcut.sheet.drawing-move-left",group:"4_sheet-drawing-view",binding:Y.KeyCode.ARROW_LEFT,priority:100,preconditions:ke,staticParameters:{direction:l.Direction.LEFT}},Un={id:ye.id,description:"shortcut.sheet.drawing-move-right",group:"4_sheet-drawing-view",binding:Y.KeyCode.ARROW_RIGHT,priority:100,preconditions:ke,staticParameters:{direction:l.Direction.RIGHT}},Nn={id:It.id,description:"shortcut.sheet.drawing-delete",group:"4_sheet-drawing-view",preconditions:ke,binding:Y.KeyCode.DELETE,mac:Y.KeyCode.BACKSPACE};var kn=Object.getOwnPropertyDescriptor,Bn=(i,r,t,e)=>{for(var n=e>1?void 0:e?kn(r,t):r,o=i.length-1,a;o>=0;o--)(a=i[o])&&(n=a(n)||n);return n},Ce=(i,r)=>(t,e)=>r(t,e,i);let Je=class extends l.Disposable{constructor(i,r,t,e,n,o){super(),this._componentManager=i,this._menuManagerService=r,this._commandService=t,this._shortcutService=e,this._drawingManagerService=n,this._sheetsSelectionsService=o,this._init()}_initCustomComponents(){const i=this._componentManager;this.disposeWithMe(i.register(kt,Nt)),this.disposeWithMe(i.register(bt,Rn))}_initMenus(){this._menuManagerService.mergeMenu(En)}_initCommands(){[Ae,vt,Oe,_e,Pe,gt,G,ht,mt,St,ye,It,ft].forEach(i=>this.disposeWithMe(this._commandService.registerCommand(i)))}_initShortcuts(){[On,Pn,An,Un,Nn].forEach(i=>{this.disposeWithMe(this._shortcutService.registerShortcut(i))})}_init(){this._initCommands(),this._initCustomComponents(),this._initMenus(),this._initShortcuts()}};Je=Bn([Ce(0,l.Inject(Y.ComponentManager)),Ce(1,Y.IMenuManagerService),Ce(2,l.ICommandService),Ce(3,Y.IShortcutService),Ce(4,U.IDrawingManagerService),Ce(5,l.Inject(I.SheetsSelectionsService))],Je);var Wn=Object.getOwnPropertyDescriptor,jn=(i,r,t,e)=>{for(var n=e>1?void 0:e?Wn(r,t):r,o=i.length-1,a;o>=0;o--)(a=i[o])&&(n=a(n)||n);return n},ve=(i,r)=>(t,e)=>r(t,e,i);function Ln(i,r,t,e,n){const{scaleX:o,scaleY:a}=r.getAncestorScale(),s=r.getViewport(B.SHEET_VIEWPORT_KEY.VIEW_MAIN),d=e.getFreeze(),{startColumn:g,startRow:u,xSplit:c,ySplit:p}=d,h={left:!0,top:!0};if(!s)return{...i,absolute:h};const{left:f,right:S,top:w,bottom:v}=i;let{top:y,left:M,viewportScrollX:T,viewportScrollY:C}=s;const{boundsOfViewArea:b,scrollDirectionResponse:_}=n||{},{rowHeaderWidth:k,columnHeaderHeight:E}=t,W={top:E,left:k};b&&(l.Tools.isDefine(W.top)&&(W.top=b.top),l.Tools.isDefine(W.left)&&(W.left=b.left)),_==="HORIZONTAL"&&(C=0),_==="VERTICAL"&&(T=0);let A=0,P=0;const D=t.rowStartY(u-p)+E,L=t.colStartX(g-c)+k,j=t.rowStartY(u)+E,z=t.colStartX(g)+k;if(c===0)h.left=!1,A=(f-T)*o,P=(S-T)*o;else{const te=f-(L-k),J=S-(L-k);S<z?(A=te*o,P=J*o):f<=z&&S>=z?(A=te*o,P=Math.max(M,(S-T)*o)):f>z&&(h.left=!1,A=Math.max((f-T)*o,M),P=Math.max((S-T)*o,M))}let X=0,Z=0;if(p===0)h.top=!1,X=(w-C)*a,Z=(v-C)*a;else{const te=w-(D-E),J=v-(D-E);v<j?(X=te*a,Z=J*a):w<=j&&v>=j?(X=te*a,Z=Math.max(y,(v-C)*a)):w>j&&(h.top=!1,X=Math.max((w-C)*a,y),Z=Math.max((v-C)*a,y))}return A=Math.max(A,W.left),X=Math.max(X,W.top),P=Math.max(P,W.left),Z=Math.max(Z,W.top),{left:A,right:P,top:X,bottom:Z,absolute:h}}const le=(i,r,t,e,n)=>{const{scene:o}=r,{left:a,top:s,width:d,height:g,angle:u}=i,c={left:a,right:a+d,top:s,bottom:s+g},p=Ln(c,o,t,e,n),{scaleX:h,scaleY:f}=o.getAncestorScale();return{startX:p.left,endX:p.right,startY:p.top,endY:p.bottom,rotate:u,width:d*h,height:g*f,absolute:p.absolute}};R.SheetCanvasFloatDomManagerService=class extends l.Disposable{constructor(t,e,n,o,a,s,d){super();ee(this,"_domLayerMap",new Map);ee(this,"_domLayerInfoMap",new Map);ee(this,"_transformChange$",new N.Subject);ee(this,"transformChange$",this._transformChange$.asObservable());ee(this,"_add$",new N.Subject);ee(this,"add$",this._add$.asObservable());ee(this,"_remove$",new N.Subject);ee(this,"remove$",this._remove$.asObservable());ee(this,"_hooks",[]);this._renderManagerService=t,this._univerInstanceService=e,this._commandService=n,this._drawingManagerService=o,this._canvasFloatDomService=a,this._sheetDrawingService=s,this._lifecycleService=d,this._drawingAddListener(),this._featureUpdateListener(),this._deleteListener(),this._bindScrollEvent()}_bindScrollEvent(){this._lifecycleService.lifecycle$.pipe(N.filter(t=>t===l.LifecycleStages.Rendered),N.take(1)).subscribe(()=>{this._scrollUpdateListener()})}_ensureMap(t,e){let n=this._domLayerMap.get(t);n||(n=new Map,this._domLayerMap.set(t,n));let o=n.get(e);return o||(o=new Map,n.set(e,o)),o}getFloatDomInfo(t){return this._domLayerInfoMap.get(t)}_getSceneAndTransformerByDrawingSearch(t){if(t==null)return;const e=this._renderManagerService.getRenderById(t),n=e==null?void 0:e.scene;if(e==null||n==null)return null;const o=n.getTransformerByCreate(),a=e.engine.getCanvasElement();return{scene:n,transformer:o,renderUnit:e,canvas:a}}_getFloatDomProps(t){let e;return this._hooks.forEach(n=>{e=n.onGetFloatDomProps(t)}),e}_drawingAddListener(){this.disposeWithMe(this._drawingManagerService.add$.subscribe(t=>{t.forEach(e=>{var se,ce,Q;const{unitId:n,subUnitId:o,drawingId:a}=e,s=I.getSheetCommandTarget(this._univerInstanceService,{unitId:n,subUnitId:o}),d=this._drawingManagerService.getDrawingByParam(e),g=this._univerInstanceService.getUnit(n,l.UniverInstanceType.UNIVER_SHEET);if(!g)return;const u=g.getActiveSheet().getSheetId();if(!d||!s)return;const c=(se=this._renderManagerService.getRenderById(n))==null?void 0:se.with(O.SheetSkeletonManagerService).getSkeletonParam(o);if(!c)return;const{transform:p,drawingType:h,data:f}=d;if(h!==l.DrawingTypeEnum.DRAWING_DOM&&h!==l.DrawingTypeEnum.DRAWING_CHART)return;const S=this._getSceneAndTransformerByDrawingSearch(n);if(S==null)return;const{scene:w,canvas:v}=S;if(p==null)return!0;if(u!==o)return;const{left:y,top:M,width:T,height:C,angle:b,flipX:_,flipY:k,skewX:E,skewY:W}=p,A=U.getDrawingShapeKeyByDrawingSearch({unitId:n,subUnitId:o,drawingId:a}),P=w.getObject(A);if(P!=null){P.transformByState({left:y,top:M,width:T,height:C,angle:b,flipX:_,flipY:k,skewX:E,skewY:W});return}const D={left:y,top:M,width:T,height:C,zIndex:this._drawingManagerService.getDrawingOrder(n,o).length-1},L=h===l.DrawingTypeEnum.DRAWING_CHART;if(L){const $=f?f.backgroundColor:"white";D.fill=$,D.rotateEnabled=!1,f&&f.border&&(D.stroke=f.border),D.paintFirst="stroke",D.strokeWidth=1,D.borderEnabled=!1,D.radius=8}const j=new B.Rect(A,D);L&&j.setObjectType(B.ObjectType.CHART),w.addObject(j,B.DRAWING_OBJECT_LAYER_INDEX),d.allowTransform!==!1&&w.attachTransformerTo(j);const z=this._ensureMap(n,o),X=new l.DisposableCollection,Z=le(j,S.renderUnit,c.skeleton,s.worksheet),ae=new N.BehaviorSubject(Z),te={dispose:X,rect:j,position$:ae,unitId:n,subUnitId:o};this._canvasFloatDomService.addFloatDom({position$:ae,id:a,componentKey:d.componentKey,onPointerDown:$=>{v.dispatchEvent(new PointerEvent($.type,$))},onPointerMove:$=>{v.dispatchEvent(new PointerEvent($.type,$))},onPointerUp:$=>{v.dispatchEvent(new PointerEvent($.type,$))},onWheel:$=>{v.dispatchEvent(new WheelEvent($.type,$))},props:(Q=(ce=z.get(a))==null?void 0:ce.props)!=null?Q:this._getFloatDomProps(a),data:f,unitId:n});const J=j.onTransformChange$.subscribeEvent(()=>{const $=le(j,S.renderUnit,c.skeleton,s.worksheet);ae.next($)});X.add(()=>{this._canvasFloatDomService.removeFloatDom(a)}),J&&X.add(J),this._domLayerInfoMap.set(a,te),z.set(a,{...z.get(a)})})})),this.disposeWithMe(this._drawingManagerService.remove$.subscribe(t=>{t.forEach(e=>{const{unitId:n,subUnitId:o,drawingId:a}=e,s=U.getDrawingShapeKeyByDrawingSearch({unitId:n,subUnitId:o,drawingId:a}),d=this._getSceneAndTransformerByDrawingSearch(n);if(d==null)return;const{transformer:g,scene:u}=d,c=u.getObject(s);c!=null&&c.oKey&&g.clearControlByIds([c==null?void 0:c.oKey])})}))}_scrollUpdateListener(){const t=(e,n)=>{var u;const o=this._getSceneAndTransformerByDrawingSearch(e),a=this._ensureMap(e,n),s=Array.from(a.keys()),d=I.getSheetCommandTarget(this._univerInstanceService,{unitId:e,subUnitId:n}),g=(u=this._renderManagerService.getRenderById(e))==null?void 0:u.with(O.SheetSkeletonManagerService).getSkeletonParam(n);!o||!d||!g||s.forEach(c=>{const p=this._domLayerInfoMap.get(c);if(p){const h=le(p.rect,o.renderUnit,g.skeleton,d.worksheet,p);p.position$.next(h)}})};this.disposeWithMe(this._univerInstanceService.getCurrentTypeOfUnit$(l.UniverInstanceType.UNIVER_SHEET).pipe(N.switchMap(e=>e?e.activeSheet$:N.of(null)),N.map(e=>{if(!e)return null;const n=e.getUnitId(),o=this._renderManagerService.getRenderById(n);return o?{render:o,unitId:n,subUnitId:e.getSheetId()}:null}),N.switchMap(e=>e?l.fromEventSubject(e.render.scene.getViewport(B.SHEET_VIEWPORT_KEY.VIEW_MAIN).onScrollAfter$).pipe(N.map(()=>({unitId:e.unitId,subUnitId:e.subUnitId}))):N.of(null))).subscribe(e=>{if(!e)return;const{unitId:n,subUnitId:o}=e;t(n,o)})),this.disposeWithMe(this._commandService.onCommandExecuted(e=>{var n,o;if(e.id===O.SetZoomRatioOperation.id){const a=e.params,{unitId:s}=a;Array.from((o=(n=this._domLayerMap.get(s))==null?void 0:n.keys())!=null?o:[]).forEach(g=>{t(s,g)})}else if(e.id===I.SetFrozenMutation.id){const{unitId:a,subUnitId:s}=e.params;t(a,s)}}))}_getPosition(t,e){var h;const{startX:n,endX:o,startY:a,endY:s}=t,d=(h=this._renderManagerService.getRenderById(e))==null?void 0:h.with(O.ISheetSelectionRenderService);if(d==null)return;const g=d.getCellWithCoordByOffset(n,a);if(g==null)return;const u={column:g.actualColumn,columnOffset:n-g.startX,row:g.actualRow,rowOffset:a-g.startY},c=d.getCellWithCoordByOffset(o,s);if(c==null)return;const p={column:c.actualColumn,columnOffset:o-c.startX,row:c.actualRow,rowOffset:s-c.startY};return{from:u,to:p}}_featureUpdateListener(){this.disposeWithMe(this._drawingManagerService.update$.subscribe(t=>{t.forEach(e=>{const n=this._drawingManagerService.getDrawingByParam(e);if(!n||n.drawingType!==l.DrawingTypeEnum.DRAWING_DOM&&n.drawingType!==l.DrawingTypeEnum.DRAWING_CHART)return;const o={...n.transform};this._transformChange$.next({id:e.drawingId,value:o})})}))}_deleteListener(){this.disposeWithMe(this._drawingManagerService.remove$.subscribe(t=>{t.forEach(e=>{this._removeDom(e.drawingId)})}))}updateFloatDomProps(t,e,n,o){const a=this._domLayerInfoMap.get(n),s=this._getSceneAndTransformerByDrawingSearch(t);if(a&&s){const{scene:d}=s,g=U.getDrawingShapeKeyByDrawingSearch({unitId:t,subUnitId:e,drawingId:n}),u=d.getObject(g);u&&u instanceof B.Rect&&u.setProps(o)}}addFloatDomToPosition(t,e){const n=I.getSheetCommandTarget(this._univerInstanceService,{unitId:t.unitId,subUnitId:t.subUnitId});if(!n)throw new Error("cannot find current target!");const{unitId:o,subUnitId:a}=n,{initPosition:s,componentKey:d,data:g,allowTransform:u=!0}=t,c=e!=null?e:l.generateRandomId(),p=this._getPosition(s,o);if(p==null)return;this._ensureMap(o,a).set(c,t);const f={unitId:o,subUnitId:a,drawingId:c,drawingType:t.type||l.DrawingTypeEnum.DRAWING_DOM,componentKey:d,sheetTransform:p,transform:{left:s.startX,top:s.startY,width:s.endX-s.startX,height:s.endY-s.startY},data:g,allowTransform:u};return this._commandService.executeCommand(Oe.id,{unitId:o,drawings:[f]}),this._add$.next({unitId:o,subUnitId:a,id:c}),{id:c,dispose:()=>{this._removeDom(c,!0)}}}_removeDom(t,e=!1){const n=this._domLayerInfoMap.get(t);if(!n)return;const{unitId:o,subUnitId:a}=n;this._domLayerInfoMap.delete(t),n.dispose.dispose();const s=this._getSceneAndTransformerByDrawingSearch(o);if(s&&s.scene.removeObject(n.rect),e){this._ensureMap(o,a).delete(t);const g=this._drawingManagerService.getDrawingByParam({unitId:o,subUnitId:a,drawingId:t});if(!g)return;const u=this._sheetDrawingService.getBatchRemoveOp([g]),{redo:c,objects:p}=u;this._commandService.syncExecuteCommand(m.SetDrawingApplyMutation.id,{unitId:o,subUnitId:a,op:c,objects:p,type:m.DrawingApplyType.REMOVE})}}addHook(t){return this._hooks.push(t),{dispose:()=>{const e=this._hooks.findIndex(n=>n===t);this._hooks.splice(e,1)}}}addFloatDomToRange(t,e,n,o){var k,E,W,A,P;const a=I.getSheetCommandTarget(this._univerInstanceService,{unitId:e.unitId,subUnitId:e.subUnitId});if(!a)throw new Error("cannot find current target!");const{unitId:s,subUnitId:d}=a,g=this._getSceneAndTransformerByDrawingSearch(s);if(!g)return;const u=this._renderManagerService.getRenderById(s);if(!u)return;const c=(k=this._renderManagerService.getRenderById(s))==null?void 0:k.with(O.SheetSkeletonManagerService).getWorksheetSkeleton(d);if(!c)return;const{componentKey:p,data:h,allowTransform:f=!0}=e,S=o!=null?o:l.generateRandomId(),{position:w,position$:v}=this._createRangePositionObserver(t,u,c.skeleton);if(this._getPosition(w,s)==null)return;this._ensureMap(s,d).set(S,e);const T=g.scene,{scaleX:C}=T.getAncestorScale(),b=Qe(w,n,C),_={unitId:s,subUnitId:d,drawingId:S,drawingType:e.type||l.DrawingTypeEnum.DRAWING_DOM,componentKey:p,transform:{left:b.startX,top:b.startY,width:b.width,height:b.height},data:h,allowTransform:f};{const{unitId:D,subUnitId:L,drawingId:j}=_,z=I.getSheetCommandTarget(this._univerInstanceService,{unitId:D,subUnitId:L}),X=_,Z=this._univerInstanceService.getUnit(D,l.UniverInstanceType.UNIVER_SHEET);if(!Z)return;const ae=Z.getActiveSheet().getSheetId();if(!X||!z)return;const te=(E=this._renderManagerService.getRenderById(D))==null?void 0:E.with(O.SheetSkeletonManagerService);if(!te)return;const J=te.getWorksheetSkeleton(L);if(!J)return;const{transform:se,drawingType:ce,data:Q}=X;if(ce!==l.DrawingTypeEnum.DRAWING_DOM&&ce!==l.DrawingTypeEnum.DRAWING_CHART)return;const $=this._getSceneAndTransformerByDrawingSearch(D);if($==null)return;const{scene:De,canvas:Me}=$;if(se==null||ae!==L)return;const{left:tt,top:nt,width:rt,height:it,angle:Dt,flipX:Mt,flipY:ot,skewX:at,skewY:Te}=se,st=U.getDrawingShapeKeyByDrawingSearch({unitId:D,subUnitId:L,drawingId:j}),ue=De.getObject(st);if(ue!=null){ue.transformByState({left:tt,top:nt,width:rt,height:it,angle:Dt,flipX:Mt,flipY:ot,skewX:at,skewY:Te});return}const oe={left:tt,top:nt,width:rt,height:it,zIndex:this._drawingManagerService.getDrawingOrder(D,L).length-1},be=ce===l.DrawingTypeEnum.DRAWING_CHART;if(be){const F=Q?Q.backgroundColor:"white";oe.fill=F,oe.rotateEnabled=!1,Q&&Q.border&&(oe.stroke=Q.border),oe.paintFirst="stroke",oe.strokeWidth=1,oe.borderEnabled=!1,oe.radius=8}const de=new B.Rect(st,oe);be&&de.setObjectType(B.ObjectType.CHART),De.addObject(de,B.DRAWING_OBJECT_LAYER_INDEX),X.allowTransform!==!1&&De.attachTransformerTo(de);const We=this._ensureMap(D,L),ge=new l.DisposableCollection,ct=De.getMainViewport(),{rowHeaderWidth:Re,columnHeaderHeight:je}=J.skeleton,dt={top:je,left:Re,bottom:ct.bottom,right:ct.right},he={dispose:ge,rect:de,boundsOfViewArea:dt,domAnchor:n,unitId:D,subUnitId:L},V=le(de,$.renderUnit,J.skeleton,z.worksheet,he),Ee=new N.BehaviorSubject(V);he.position$=Ee;let Le={position$:Ee,id:j,componentKey:X.componentKey,onPointerDown:()=>{},onPointerMove:()=>{},onPointerUp:()=>{},onWheel:F=>{Me.dispatchEvent(new WheelEvent(F.type,F))},props:(A=(W=We.get(j))==null?void 0:W.props)!=null?A:this._getFloatDomProps(j),data:Q,unitId:D};e.eventPassThrough&&(Le={...Le,onPointerDown:F=>{Me.dispatchEvent(new PointerEvent(F.type,F))},onPointerMove:F=>{Me.dispatchEvent(new PointerEvent(F.type,F))},onPointerUp:F=>{Me.dispatchEvent(new PointerEvent(F.type,F))}}),this._canvasFloatDomService.addFloatDom(Le),this.disposeWithMe(v.subscribe(F=>{var jt,Lt,Yt,Ft;const Wt=Qe({startX:F.startX,startY:F.startY,endX:F.endX,endY:F.endY,width:(jt=n.width)!=null?jt:F.width,height:(Lt=n.height)!=null?Lt:F.height,absolute:{left:w.absolute.left,top:w.absolute.top}},n),Vn=U.getDrawingShapeKeyByDrawingSearch({unitId:D,subUnitId:L,drawingId:j}),Xn=new B.Rect(Vn,{left:Wt.startX,top:Wt.startY,width:(Yt=n.width)!=null?Yt:F.width,height:(Ft=n.height)!=null?Ft:F.height,zIndex:this._drawingManagerService.getDrawingOrder(D,L).length-1}),xn=le(Xn,$.renderUnit,J.skeleton,z.worksheet,he);Ee.next(xn)}));const Ye=(P=this._renderManagerService.getRenderById(D))==null?void 0:P.with(O.SheetSkeletonManagerService);Ye==null||Ye.currentSkeleton$.subscribe(F=>{F&&J.sheetId!==F.sheetId&&this._removeDom(S,!0)});const lt=de.onTransformChange$.subscribeEvent(()=>{const F=le(de,$.renderUnit,J.skeleton,z.worksheet,he);Ee.next(F)});ge.add(()=>{this._canvasFloatDomService.removeFloatDom(j)}),lt&&ge.add(lt),this._domLayerInfoMap.set(j,he),We.set(j,{...We.get(j)})}return{id:S,dispose:()=>{this._removeDom(S,!0)}}}addFloatDomToColumnHeader(t,e,n,o){var b,_,k,E,W;const a=I.getSheetCommandTarget(this._univerInstanceService,{unitId:e.unitId,subUnitId:e.subUnitId});if(!a)throw new Error("cannot find current target!");const{unitId:s,subUnitId:d}=a;if(!this._getSceneAndTransformerByDrawingSearch(s))return;const u=this._renderManagerService.getRenderById(s);if(!u)return;const c=(b=this._renderManagerService.getRenderById(s))==null?void 0:b.with(O.SheetSkeletonManagerService).getWorksheetSkeleton(d);if(!c)return;const{componentKey:p,data:h,allowTransform:f=!0}=e,S=o!=null?o:l.generateRandomId(),{position:w,position$:v}=this._createRangePositionObserver({startRow:0,endRow:0,startColumn:t,endColumn:t},u,c.skeleton),y=w;if(y.startY=0,this._getPosition(w,s)==null)return;this._ensureMap(s,d).set(S,e);const C={unitId:s,subUnitId:d,drawingId:S,drawingType:e.type||l.DrawingTypeEnum.DRAWING_DOM,componentKey:p,transform:{left:y.startX,top:y.startY,width:y.width,height:y.height},data:h,allowTransform:f};{const{unitId:A,subUnitId:P,drawingId:D}=C,L=I.getSheetCommandTarget(this._univerInstanceService,{unitId:A,subUnitId:P}),j=C,z=this._univerInstanceService.getUnit(A,l.UniverInstanceType.UNIVER_SHEET);if(!z)return;const X=z.getActiveSheet().getSheetId();if(!j||!L)return;const Z=(_=this._renderManagerService.getRenderById(A))==null?void 0:_.with(O.SheetSkeletonManagerService);if(!Z)return;const ae=Z.getWorksheetSkeleton(P);if(!ae)return;const{transform:te,data:J}=j,se=this._getSceneAndTransformerByDrawingSearch(A);if(se==null)return;const{scene:ce,canvas:Q}=se;if(te==null||X!==P)return;const{left:$,top:De,width:Me,height:tt,angle:nt,flipX:rt,flipY:it,skewX:Dt,skewY:Mt}=te,ot=U.getDrawingShapeKeyByDrawingSearch({unitId:A,subUnitId:P,drawingId:D}),at=ce.getObject(ot);if(at!=null){at.transformByState({left:$,top:De,width:Me,height:tt,angle:nt,flipX:rt,flipY:it,skewX:Dt,skewY:Mt});return}const Te=Qe({startX:y.startX,startY:0,endX:w.endX,endY:w.endY,width:n.width,height:n.height,absolute:{left:w.absolute.left,top:w.absolute.top}},n),st={left:Te.startX,top:Te.startY,width:Te.width,height:Te.height,zIndex:this._drawingManagerService.getDrawingOrder(A,P).length-1},ue=new B.Rect(ot,st);ce.addObject(ue,B.DRAWING_OBJECT_LAYER_INDEX),j.allowTransform!==!1&&ce.attachTransformerTo(ue);const oe=this._ensureMap(A,P),be=new l.DisposableCollection,de=ce.getMainViewport(),We={top:0,left:de.left,bottom:de.bottom,right:de.right},ge={dispose:be,rect:ue,unitId:A,subUnitId:P,boundsOfViewArea:We,domAnchor:n,scrollDirectionResponse:"HORIZONTAL"},ct=le(ue,se.renderUnit,ae.skeleton,L.worksheet,ge),Re=new N.BehaviorSubject(ct);ge.position$=Re;let je={position$:Re,id:D,componentKey:j.componentKey,onPointerDown:()=>{},onPointerMove:()=>{},onPointerUp:()=>{},onWheel:V=>{Q.dispatchEvent(new WheelEvent(V.type,V))},props:(E=(k=oe.get(D))==null?void 0:k.props)!=null?E:this._getFloatDomProps(D),data:J,unitId:A};e.eventPassThrough&&(je={...je,onPointerDown:V=>{Q.dispatchEvent(new PointerEvent(V.type,V))},onPointerMove:V=>{Q.dispatchEvent(new PointerEvent(V.type,V))},onPointerUp:V=>{Q.dispatchEvent(new PointerEvent(V.type,V))}}),this._canvasFloatDomService.addFloatDom(je);const dt=ue.onTransformChange$.subscribeEvent(()=>{const V=le(ue,se.renderUnit,ae.skeleton,L.worksheet,ge);Re.next(V)});this.disposeWithMe(v.subscribe(V=>{const Ee=Qe({startX:V.startX,startY:0,endX:V.endX,endY:V.endY,width:n.width,height:n.height,absolute:{left:w.absolute.left,top:w.absolute.top}},n),Le=U.getDrawingShapeKeyByDrawingSearch({unitId:A,subUnitId:P,drawingId:D}),Ye=new B.Rect(Le,{left:Ee.startX,top:0,width:n.width,height:n.height,zIndex:this._drawingManagerService.getDrawingOrder(A,P).length-1}),lt=le(Ye,se.renderUnit,ae.skeleton,L.worksheet,ge);Re.next(lt)}));const he=(W=this._renderManagerService.getRenderById(A))==null?void 0:W.with(O.SheetSkeletonManagerService);he==null||he.currentSkeleton$.subscribe(V=>{V&&c.sheetId!==V.sheetId&&this._removeDom(S,!0)}),be.add(()=>{this._canvasFloatDomService.removeFloatDom(D)}),dt&&be.add(dt),this._domLayerInfoMap.set(D,ge),oe.set(D,{...oe.get(D)})}return{id:S,dispose:()=>{this._removeDom(S,!0)}}}_createRangePositionObserver(t,e,n){let{startRow:o,startColumn:a}=t;const s=Be(o,a,n),d=new N.BehaviorSubject(s),g=Be(t.endRow,t.endColumn,n),u=new N.BehaviorSubject(g),c=()=>{const v=Be(o,a,n),y=Be(t.endRow,t.endColumn,n);d.next(v),u.next(y)},p=new l.DisposableCollection;p.add(e.engine.clientRect$.subscribe(()=>c())),p.add(this._commandService.onCommandExecuted(v=>{if(v.id===I.SetWorksheetRowAutoHeightMutation.id&&v.params.rowsAutoHeightInfo.findIndex(M=>M.row===o)>-1){c();return}(I.COMMAND_LISTENER_SKELETON_CHANGE.indexOf(v.id)>-1||v.id===O.SetScrollOperation.id||v.id===O.SetZoomRatioOperation.id)&&c()}));const h=(v,y)=>{o=v,a=y,c()},f=()=>({rotate:0,width:g.right-s.left,height:g.bottom-s.top,absolute:{left:!0,top:!0},startX:s.left,startY:s.top,endX:g.right,endY:g.bottom}),S=d.pipe(N.map(v=>{const y=Be(t.endRow,t.endColumn,n);return{rotate:0,width:y.right-v.left,height:y.bottom-v.top,absolute:{left:!0,top:!0},startX:v.left,startY:v.top,endX:y.right,endY:y.bottom}})),w=f();return{position$:S,position:w,updateRowCol:h,topLeftPos$:d,rightBottomPos$:u,disposable:p}}},R.SheetCanvasFloatDomManagerService=jn([ve(0,l.Inject(B.IRenderManagerService)),ve(1,l.IUniverInstanceService),ve(2,l.Inject(l.ICommandService)),ve(3,U.IDrawingManagerService),ve(4,l.Inject(Y.CanvasFloatDomService)),ve(5,m.ISheetDrawingService),ve(6,l.Inject(l.LifecycleService))],R.SheetCanvasFloatDomManagerService);function Be(i,r,t){const e=t.getCellWithCoordByIndex(i,r),n=e.isMergedMainCell?e.mergeInfo:e;return{left:n.startX,right:n.endX,top:n.startY,bottom:n.endY}}function Qe(i,r,t){var g,u;t=t!=null?t:1;const e=i.endX-i.startX,n=i.endY-i.startY,o=(g=r==null?void 0:r.width)!=null?g:e,a=(u=r==null?void 0:r.height)!=null?u:n;let s=0,d=0;if(r){if(r.horizonOffsetAlign==="right"){const c=et(r.marginX,e*t);s=i.endX-c-o}else s=i.startX+et(r.marginX,e);if(r.verticalOffsetAlign==="bottom"){const c=et(r.marginY,n*t);d=i.endY-c-a}else d=i.startY+et(r.marginY,n)}return{rotate:0,startX:s,startY:d,endX:i.endX,endY:i.endY,width:o,height:a,absolute:{left:i.absolute.left,top:i.absolute.top}}}function et(i,r){if(i===void 0)return 0;if(typeof i=="number")return i;const t=Number.parseFloat(i);return r*t/100}var Yn=Object.defineProperty,Fn=Object.getOwnPropertyDescriptor,$n=(i,r,t)=>r in i?Yn(i,r,{enumerable:!0,configurable:!0,writable:!0,value:t}):i[r]=t,Gn=(i,r,t,e)=>{for(var n=e>1?void 0:e?Fn(r,t):r,o=i.length-1,a;o>=0;o--)(a=i[o])&&(n=a(n)||n);return n},Ct=(i,r)=>(t,e)=>r(t,e,i),Bt=(i,r,t)=>$n(i,typeof r!="symbol"?r+"":r,t);const Hn="SHEET_IMAGE_UI_PLUGIN";R.UniverSheetsDrawingUIPlugin=class extends l.Plugin{constructor(r=Tt,t,e,n){super(),this._config=r,this._injector=t,this._renderManagerService=e,this._configService=n;const{menu:o,...a}=l.merge({},Tt,this._config);o&&this._configService.setConfig("menu",o,{merge:!0}),this._configService.setConfig($t,a)}onStarting(){l.registerDependencies(this._injector,[[R.SheetCanvasFloatDomManagerService],[Je],[$e],[Ze],[ze],[Ke],[He],[xe],[Ve]]),l.touchDependencies(this._injector,[[R.SheetCanvasFloatDomManagerService]])}onReady(){l.touchDependencies(this._injector,[[Ke]])}onRendered(){this._registerRenderModules(),l.touchDependencies(this._injector,[[ze],[Ze],[Je],[He],[xe],[Ve]])}onSteady(){this._injector.get($e)}_registerRenderModules(){[[R.SheetDrawingUpdateController],[_t],[pt]].forEach(r=>{this.disposeWithMe(this._renderManagerService.registerRenderModule(l.UniverInstanceType.UNIVER_SHEET,r))})}},Bt(R.UniverSheetsDrawingUIPlugin,"type",l.UniverInstanceType.UNIVER_SHEET),Bt(R.UniverSheetsDrawingUIPlugin,"pluginName",Hn),R.UniverSheetsDrawingUIPlugin=Gn([l.DependentOn(U.UniverDrawingPlugin,we.UniverDocsDrawingPlugin,pe.UniverDrawingUIPlugin,m.UniverSheetsDrawingPlugin),Ct(1,l.Inject(l.Injector)),Ct(2,B.IRenderManagerService),Ct(3,l.IConfigService)],R.UniverSheetsDrawingUIPlugin),R.ClearSheetDrawingTransformerOperation=G,R.DeleteDrawingsCommand=It,R.EditSheetDrawingOperation=ht,R.GroupSheetDrawingCommand=mt,R.InsertFloatImageCommand=Ae,R.InsertSheetDrawingCommand=Oe,R.MoveDrawingsCommand=ye,R.RemoveSheetDrawingCommand=_e,R.SHEETS_IMAGE_MENU_ID=yt,R.SetDrawingArrangeCommand=ft,R.SetSheetDrawingCommand=Pe,R.SidebarSheetDrawingOperation=gt,R.UngroupSheetDrawingCommand=St,Object.defineProperty(R,Symbol.toStringTag,{value:"Module"})});


// @univerjs/sheets-drawing-ui/facade
(function(o,u){typeof exports=="object"&&typeof module<"u"?u(require("@univerjs/core"),require("@univerjs/core/facade"),require("@univerjs/drawing"),require("@univerjs/engine-render"),require("@univerjs/sheets-drawing-ui"),require("@univerjs/sheets-ui"),require("@univerjs/sheets-drawing"),require("@univerjs/sheets-ui/facade"),require("@univerjs/sheets/facade"),require("@univerjs/ui")):typeof define=="function"&&define.amd?define(["@univerjs/core","@univerjs/core/facade","@univerjs/drawing","@univerjs/engine-render","@univerjs/sheets-drawing-ui","@univerjs/sheets-ui","@univerjs/sheets-drawing","@univerjs/sheets-ui/facade","@univerjs/sheets/facade","@univerjs/ui"],u):(o=typeof globalThis<"u"?globalThis:o||self,u(o.UniverCore,o.UniverCoreFacade,o.UniverDrawing,o.UniverEngineRender,o.UniverSheetsDrawingUi,o.UniverSheetsUi,o.UniverSheetsDrawing,o.UniverSheetsUiFacade,o.UniverSheetsFacade,o.UniverUi))})(this,function(o,u,v,S,g,w,l,C,_,y){"use strict";var W=Object.defineProperty;var H=(o,u,v)=>u in o?W(o,u,{enumerable:!0,configurable:!0,writable:!0,value:v}):o[u]=v;var G=(o,u,v)=>H(o,typeof u!="symbol"?u+"":u,v);var T=Object.getOwnPropertyDescriptor,R=(r,i,t,e)=>{for(var n=e>1?void 0:e?T(i,t):i,s=r.length-1,a;s>=0;s--)(a=r[s])&&(n=a(n)||n);return n},E=(r,i)=>(t,e)=>i(t,e,r);function j(r,i){const{from:t,to:e,flipY:n=!1,flipX:s=!1,angle:a=0,skewX:c=0,skewY:d=0}=r.sheetTransform,{column:h,columnOffset:m,row:f,rowOffset:b}=t,k=w.convertPositionSheetOverGridToAbsolute(r.unitId,r.subUnitId,{from:t,to:e},i),{width:O,height:D}=k;return{...r,column:h,columnOffset:m,row:f,rowOffset:b,width:O,height:D,flipY:n,flipX:s,angle:a,skewX:c,skewY:d}}function B(r,i,t){const{column:e,columnOffset:n,row:s,rowOffset:a,flipY:c=!1,flipX:d=!1,angle:h=0,skewX:m=0,skewY:f=0,width:b,height:k}=r,O=w.convertPositionCellToSheetOverGrid(r.unitId,r.subUnitId,{column:e,columnOffset:n,row:s,rowOffset:a},b,k,i,t),{sheetTransform:D,transform:U}=O;return{...r,sheetTransform:{...D,flipY:c,flipX:d,angle:h,skewX:m,skewY:f},transform:{...U,flipY:c,flipX:d,angle:h,skewX:m,skewY:f}}}let p=class{constructor(r,i,t){G(this,"_image");this._injector=t,this._image={drawingId:o.generateRandomId(6),drawingType:o.DrawingTypeEnum.DRAWING_IMAGE,imageSourceType:o.ImageSourceType.BASE64,source:"",unitId:r,subUnitId:i,column:0,columnOffset:0,row:0,rowOffset:0,width:0,height:0}}setImage(r){const t=this._injector.get(S.IRenderManagerService).getRenderById(r.unitId);if(!t)throw new Error(`Render Unit with unitId ${r.unitId} not found`);const e=t.with(w.SheetSkeletonManagerService);return r.sheetTransform==null&&(r.sheetTransform={from:{column:0,columnOffset:0,row:0,rowOffset:0},to:{column:0,columnOffset:0,row:0,rowOffset:0}}),this._image=j(r,e),this}setSource(r,i){const t=i!=null?i:o.ImageSourceType.URL;return this._image.source=r,this._image.imageSourceType=t,this}getSource(){return this._image.source}getSourceType(){return this._image.imageSourceType}setColumn(r){return this._image.column=r,this}setRow(r){return this._image.row=r,this}setColumnOffset(r){return this._image.columnOffset=r,this}setRowOffset(r){return this._image.rowOffset=r,this}setWidth(r){return this._image.width=r,this}setHeight(r){return this._image.height=r,this}setAnchorType(r){return this._image.anchorType=r,this}setCropTop(r){return this._initializeSrcRect(),this._image.srcRect.top=r,this}setCropLeft(r){return this._initializeSrcRect(),this._image.srcRect.left=r,this}setCropBottom(r){return this._initializeSrcRect(),this._image.srcRect.bottom=r,this}setCropRight(r){return this._initializeSrcRect(),this._image.srcRect.right=r,this}_initializeSrcRect(){this._image.srcRect==null&&(this._image.srcRect={top:0,left:0,bottom:0,right:0})}setRotate(r){return this._image.angle=r,this}setUnitId(r){return this._image.unitId=r,this}setSubUnitId(r){return this._image.subUnitId=r,this}async buildAsync(){const i=this._injector.get(S.IRenderManagerService).getRenderById(this._image.unitId);if(!i)throw new Error(`Render Unit with unitId ${this._image.unitId} not found`);const t=i.with(w.ISheetSelectionRenderService),e=i.with(w.SheetSkeletonManagerService);if(this._image.width===0||this._image.height===0){const n=await v.getImageSize(this._image.source),s=n.width,a=n.height;this._image.width===0&&(this._image.width=s),this._image.height===0&&(this._image.height=a)}return B(this._image,t,e)}};p=R([E(2,o.Inject(o.Injector))],p);let I=class extends u.FBase{constructor(r,i,t){super(),this._image=r,this._commandService=i,this._injector=t}getId(){return this._image.drawingId}getType(){return this._image.drawingType}remove(){return this._commandService.syncExecuteCommand(g.RemoveSheetDrawingCommand.id,{unitId:this._image.unitId,drawings:[this._image]})}toBuilder(){const r=this._injector.createInstance(p);return r.setImage(this._image),r}setSource(r,i){const t=i!=null?i:o.ImageSourceType.URL;return this._image.source=r,this._image.imageSourceType=t,this._commandService.syncExecuteCommand(g.SetSheetDrawingCommand.id,{unitId:this._image.unitId,drawings:[this._image]})}async setPositionAsync(r,i,t,e){const n=this.toBuilder();n.setColumn(i),n.setRow(r),t!=null&&n.setRowOffset(t),e!=null&&n.setColumnOffset(e);const s=await n.buildAsync();return this._commandService.syncExecuteCommand(g.SetSheetDrawingCommand.id,{unitId:this._image.unitId,drawings:[s]})}async setSizeAsync(r,i){const t=this.toBuilder();t.setWidth(r),t.setHeight(i);const e=await t.buildAsync();return this._commandService.syncExecuteCommand(g.SetSheetDrawingCommand.id,{unitId:this._image.unitId,drawings:[e]})}setCrop(r,i,t,e){return this._image.srcRect==null&&(this._image.srcRect={top:0,left:0,bottom:0,right:0}),r!=null&&(this._image.srcRect.top=r),i!=null&&(this._image.srcRect.left=i),t!=null&&(this._image.srcRect.bottom=t),e!=null&&(this._image.srcRect.right=e),this._commandService.syncExecuteCommand(g.SetSheetDrawingCommand.id,{unitId:this._image.unitId,drawings:[this._image]})}setRotate(r){return this._image.sheetTransform.angle=r,this._image.transform&&(this._image.transform.angle=r),this._commandService.syncExecuteCommand(g.SetSheetDrawingCommand.id,{unitId:this._image.unitId,drawings:[this._image]})}setForward(){return this._commandService.syncExecuteCommand(g.SetDrawingArrangeCommand.id,{unitId:this._image.unitId,subUnitId:this._image.subUnitId,drawingIds:[this._image.drawingId],arrangeType:o.ArrangeTypeEnum.forward})}setBackward(){return this._commandService.syncExecuteCommand(g.SetDrawingArrangeCommand.id,{unitId:this._image.unitId,subUnitId:this._image.subUnitId,drawingIds:[this._image.drawingId],arrangeType:o.ArrangeTypeEnum.backward})}setBack(){return this._commandService.syncExecuteCommand(g.SetDrawingArrangeCommand.id,{unitId:this._image.unitId,subUnitId:this._image.subUnitId,drawingIds:[this._image.drawingId],arrangeType:o.ArrangeTypeEnum.back})}setFront(){return this._commandService.syncExecuteCommand(g.SetDrawingArrangeCommand.id,{unitId:this._image.unitId,subUnitId:this._image.subUnitId,drawingIds:[this._image.drawingId],arrangeType:o.ArrangeTypeEnum.front})}};I=R([E(1,o.ICommandService),E(2,o.Inject(o.Injector))],I);class F extends _.FWorksheet{addFloatDomToPosition(i,t){const e=this._workbook.getUnitId(),n=this._worksheet.getSheetId(),{key:s,disposableCollection:a}=C.transformComponentKey(i,this._injector.get(y.ComponentManager)),d=this._injector.get(g.SheetCanvasFloatDomManagerService).addFloatDomToPosition({...i,componentKey:s,unitId:e,subUnitId:n},t);return d?(a.add(d.dispose),{id:d.id,dispose:()=>{a.dispose(),d.dispose()}}):(a.dispose(),null)}addFloatDomToRange(i,t,e,n){const s=this._workbook.getUnitId(),a=this._worksheet.getSheetId(),{key:c,disposableCollection:d}=C.transformComponentKey(t,this._injector.get(y.ComponentManager)),m=this._injector.get(g.SheetCanvasFloatDomManagerService).addFloatDomToRange(i.getRange(),{...t,componentKey:c,unitId:s,subUnitId:a},e,n);return m?(d.add(m.dispose),{id:m.id,dispose:()=>{d.dispose(),m.dispose()}}):(d.dispose(),null)}addFloatDomToColumnHeader(i,t,e,n){const s=this._workbook.getUnitId(),a=this._worksheet.getSheetId(),{key:c,disposableCollection:d}=C.transformComponentKey(t,this._injector.get(y.ComponentManager)),m=this._injector.get(g.SheetCanvasFloatDomManagerService).addFloatDomToColumnHeader(i,{...t,componentKey:c,unitId:s,subUnitId:a},e,n);return m?(d.add(m.dispose),{id:m.id,dispose:()=>{d.dispose(),m.dispose()}}):(d.dispose(),null)}async insertImage(i,t,e,n,s){const a=this.newOverGridImage();if(typeof i=="string")a.setSource(i);else{const h=await i.getBlob().getDataAsString();a.setSource(h,o.ImageSourceType.BASE64)}t!==void 0?a.setColumn(t):a.setColumn(0),e!==void 0?a.setRow(e):a.setRow(0),n!==void 0?a.setColumnOffset(n):a.setColumnOffset(0),s!==void 0?a.setRowOffset(s):a.setRowOffset(0);const c=await a.buildAsync();return this._commandService.syncExecuteCommand(g.InsertSheetDrawingCommand.id,{unitId:this._fWorkbook.getId(),drawings:[c]})}insertImages(i){const t=i.map(e=>(e.unitId=this._fWorkbook.getId(),e.subUnitId=this.getSheetId(),e));return this._commandService.syncExecuteCommand(g.InsertSheetDrawingCommand.id,{unitId:this._fWorkbook.getId(),drawings:t}),this}deleteImages(i){const t=i.map(e=>({unitId:this._fWorkbook.getId(),drawingId:e.getId(),subUnitId:this.getSheetId(),drawingType:e.getType()}));return this._commandService.syncExecuteCommand(g.RemoveSheetDrawingCommand.id,{unitId:this._fWorkbook.getId(),drawings:t}),this}getImages(){const t=this._injector.get(l.ISheetDrawingService).getDrawingData(this._fWorkbook.getId(),this.getSheetId()),e=[];for(const n in t){const s=t[n];s.drawingType===o.DrawingTypeEnum.DRAWING_IMAGE&&e.push(this._injector.createInstance(I,s))}return e}getImageById(i){const e=this._injector.get(l.ISheetDrawingService).getDrawingByParam({unitId:this._fWorkbook.getId(),subUnitId:this.getSheetId(),drawingId:i});return e&&e.drawingType===o.DrawingTypeEnum.DRAWING_IMAGE?this._injector.createInstance(I,e):null}getActiveImages(){const t=this._injector.get(l.ISheetDrawingService).getFocusDrawings(),e=[];for(const n in t){const s=t[n];e.push(this._injector.createInstance(I,s))}return e}updateImages(i){return this._commandService.syncExecuteCommand(g.SetSheetDrawingCommand.id,{unitId:this._fWorkbook.getId(),drawings:i}),this}onImageInserted(i){const t=this._injector.get(l.ISheetDrawingService);return o.toDisposable(t.add$.subscribe(e=>{const n=e.map(s=>this._injector.createInstance(I,t.getDrawingByParam(s)));i(n)}))}onImageDeleted(i){const t=this._injector.get(l.ISheetDrawingService);return o.toDisposable(t.remove$.subscribe(e=>{const n=e.map(s=>this._injector.createInstance(I,t.getDrawingByParam(s)));i(n)}))}onImageChanged(i){const t=this._injector.get(l.ISheetDrawingService);return o.toDisposable(t.update$.subscribe(e=>{const n=e.map(s=>this._injector.createInstance(I,t.getDrawingByParam(s)));i(n)}))}newOverGridImage(){const i=this._fWorkbook.getId(),t=this.getSheetId();return this._injector.createInstance(p,i,t)}}_.FWorksheet.extend(F);class x extends u.FEnum{get DrawingType(){return o.DrawingTypeEnum}get ImageSourceType(){return o.ImageSourceType}get SheetDrawingAnchorType(){return l.SheetDrawingAnchorType}}u.FEnum.extend(x);class A extends u.FEventName{get BeforeOverGridImageChange(){return"BeforeOverGridImageChange"}get OverGridImageChanged(){return"OverGridImageChanged"}get BeforeOverGridImageInsert(){return"BeforeOverGridImageInsert"}get OverGridImageInserted(){return"OverGridImageInserted"}get BeforeOverGridImageRemove(){return"BeforeOverGridImageRemove"}get OverGridImageRemoved(){return"OverGridImageRemoved"}get BeforeOverGridImageSelect(){return"BeforeOverGridImageSelect"}get OverGridImageSelected(){return"OverGridImageSelected"}}u.FEventName.extend(A);class M extends u.FUniver{_initialize(i){const t=i.get(o.ICommandService);this.registerEventHandler(this.Event.BeforeOverGridImageInsert,()=>t.beforeCommandExecuted(e=>{if(e.id!==g.InsertSheetDrawingCommand.id)return;const n=e.params,s=this.getActiveWorkbook();if(s==null||n==null)return;const{drawings:a}=n,c={workbook:s,insertImageParams:a};if(this.fireEvent(this.Event.BeforeOverGridImageInsert,c),c.cancel)throw new Error("Canceled by BeforeOverGridImageInsert event")})),this.registerEventHandler(this.Event.BeforeOverGridImageRemove,()=>t.beforeCommandExecuted(e=>{if(e.id!==g.RemoveSheetDrawingCommand.id)return;const n=e.params,s=this.getActiveWorkbook();if(s==null||n==null)return;const a=i.get(v.IDrawingManagerService),{drawings:c}=n,d=c.map(m=>a.getDrawingByParam(m)),h={workbook:s,images:this._createFOverGridImage(d)};if(this.fireEvent(this.Event.BeforeOverGridImageRemove,h),h.cancel)throw new Error("Canceled by BeforeOverGridImageRemove event")})),this.registerEventHandler(this.Event.BeforeOverGridImageChange,()=>t.beforeCommandExecuted(e=>{if(e.id!==g.SetSheetDrawingCommand.id)return;const n=e.params,s=this.getActiveWorkbook();if(s==null||n==null)return;const{drawings:a}=n,c=i.get(v.IDrawingManagerService),d=[];a.forEach(m=>{const f=c.getDrawingByParam(m);f!=null&&d.push({changeParam:m,image:this._injector.createInstance(I,f)})});const h={workbook:s,images:d};if(this.fireEvent(this.Event.BeforeOverGridImageChange,h),h.cancel)throw c.updateNotification(a),new Error("Canceled by BeforeOverGridImageChange event")})),this.registerEventHandler(this.Event.BeforeOverGridImageSelect,()=>t.beforeCommandExecuted(e=>{if(e.id!==v.SetDrawingSelectedOperation.id)return;const n=e.params,s=this.getActiveWorkbook();if(s==null)return;const a=i.get(v.IDrawingManagerService),c=a.getFocusDrawings(),d=n.map(m=>a.getDrawingByParam(m)),h={workbook:s,selectedImages:this._createFOverGridImage(d),oldSelectedImages:this._createFOverGridImage(c)};if(this.fireEvent(this.Event.BeforeOverGridImageSelect,h),h.cancel)throw new Error("Canceled by BeforeOverGridImageSelect event")})),this.registerEventHandler(this.Event.OverGridImageInserted,()=>t.onCommandExecuted(e=>{if(e.id!==g.InsertSheetDrawingCommand.id)return;const n=e.params,s=this.getActiveWorkbook();if(s==null||n==null)return;const{drawings:a}=n;this.fireEvent(this.Event.OverGridImageInserted,{workbook:s,images:this._createFOverGridImage(a)})})),this.registerEventHandler(this.Event.OverGridImageRemoved,()=>t.onCommandExecuted(e=>{if(e.id!==g.RemoveSheetDrawingCommand.id)return;const n=e.params,s=this.getActiveWorkbook();if(s==null||n==null)return;const{drawings:a}=n;this.fireEvent(this.Event.OverGridImageRemoved,{workbook:s,removeImageParams:a})})),this.registerEventHandler(this.Event.OverGridImageChanged,()=>t.onCommandExecuted(e=>{if(e.id!==g.SetSheetDrawingCommand.id)return;const n=e.params,s=this.getActiveWorkbook();if(s==null||n==null)return;const{drawings:a}=n,c=i.get(v.IDrawingManagerService),d=a.map(h=>this._injector.createInstance(I,c.getDrawingByParam(h)));this.fireEvent(this.Event.OverGridImageChanged,{workbook:s,images:d})})),this.registerEventHandler(this.Event.OverGridImageSelected,()=>t.onCommandExecuted(e=>{if(e.id!==v.SetDrawingSelectedOperation.id)return;const n=e.params,s=this.getActiveWorkbook();if(s==null)return;const a=i.get(v.IDrawingManagerService),c=n.map(d=>a.getDrawingByParam(d));this.fireEvent(this.Event.OverGridImageSelected,{workbook:s,selectedImages:this._createFOverGridImage(c)})}))}_createFOverGridImage(i){return i.map(t=>this._injector.createInstance(I,t))}}u.FUniver.extend(M);class P extends _.FRange{async insertCellImageAsync(i){var s;const t=this._injector.get(S.IRenderManagerService),e=(s=S.getCurrentTypeOfRenderer(o.UniverInstanceType.UNIVER_SHEET,this._injector.get(o.IUniverInstanceService),t))==null?void 0:s.with(g.SheetDrawingUpdateController);if(!e)return!1;const n={unitId:this._workbook.getUnitId(),subUnitId:this._worksheet.getSheetId(),row:this.getRow(),col:this.getColumn()};return typeof i=="string"?e.insertCellImageByUrl(i,n):e.insertCellImageByFile(i,n)}}_.FRange.extend(P)});


// index
(function(e,i){typeof exports=="object"&&typeof module<"u"?i(exports,require("@univerjs/docs-drawing"),require("@univerjs/drawing"),require("@univerjs/drawing-ui"),require("@univerjs/sheets-drawing"),require("@univerjs/sheets-drawing-ui"),require("@univerjs/sheets-drawing-ui/facade")):typeof define=="function"&&define.amd?define(["exports","@univerjs/docs-drawing","@univerjs/drawing","@univerjs/drawing-ui","@univerjs/sheets-drawing","@univerjs/sheets-drawing-ui","@univerjs/sheets-drawing-ui/facade"],i):(e=typeof globalThis<"u"?globalThis:e||self,i(e.UniverPresetSheetsDrawing={},e.UniverDocsDrawing,e.UniverDrawing,e.UniverDrawingUi,e.UniverSheetsDrawing,e.UniverSheetsDrawingUi))})(this,function(e,i,n,r,s,u){"use strict";function t(a={}){const{collaboration:g=!1}=a;return{plugins:[[n.UniverDrawingPlugin,{override:g?[[n.IImageIoService,null]]:[]}],i.UniverDocsDrawingPlugin,r.UniverDrawingUIPlugin,s.UniverSheetsDrawingPlugin,u.UniverSheetsDrawingUIPlugin].filter(v=>!!v)}}e.UniverSheetsDrawingPreset=t,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})});
